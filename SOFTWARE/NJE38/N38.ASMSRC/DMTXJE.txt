*
*
*-- NJE38 - NJE Line Driver carried over from VM/370 RSCS
*
*
*   This program is the RSCS line driver DMTSML that was modified to
*   perform NJE functionality in VM/370 RSCS and was called DMTYJE.
*   It was modified again for MVS invocations and renamed to DMTXJE.
*   It is used by NJE38 to provide NJE service to MVS 3.8J.
*
*   This program is called by NJEDRV.
*
*
*   NOTE!  This program is 100% reenterable but despite that statement
*   it cannot be assembled with the RENT option.
*
*
*
*
*
*---------------------------------------------------------------------
*
* MVS use modifications other than entry and exit linkages
*
*- Module made re-enterable and multi-csect to provide base reg relief
*- Task r9 commented out after label SETNOBUF
*- WAITREQ call commented out in MSG (wait done by MVS)
*- WAITREQ call commented out after cmd received (after WGET1A)
*- Several DIAG instructions commented out
*- TLINKS -> 1st LINKTABL. (used to -> LINKTABL-8). TLINKS original
*-  purpose no longer needed or used.
*- Remove LACTIVE flag from link that becomes connected.
*- Comment out branch to PNOTLOCL for store&forward.
*- Use new LINKTABL field LTCBA to identify task, label WGOTLINK
*- Changed name of ROUTE dsect to RTE
*- Several COPY statements no longer used or required
*- Pass via R0 # of pages requested to GPAGEREQ calls
*- Pass max buffer size as a parameter
*- Set negotiated buffer size in LINKTABL  (MC7SGNON)
*- Dont issue Command Forward msg 530 (label CMD12)
*- Support for alternate routes (after label WTRYROUT)
*
*---svectors calls redirected
* TLINKS
* ASYNREQ
* POSTREQ
* TCOM
* IOREQ
* WAITREQ
* ALERTREQ
* GIVEREQ
*
*--comdsect calls redirected
* PMSGREQ
* GPAGEREQ
* GLINKREQ
* GROUTREQ
* GMSGREQ
* GTODEBCD
*
*
* GENERALLY and in MOST cases:
*
*   Code lines marked '*XJE' represent modifications for NJE38 use.
*   Code lines marked 'SML2NJE4' represent the NJE modifications to
*    the original DMTSML line driver.
*   Code lines marked 'HRCxxxDT' represent the NJE modifications to
*    the original DMTSML line driver.
*   All other lines are original DMTSML code.
*
*
*
*
*
*
*
XJE      TITLE 'DMTXJE     (RSCS)      VM/370 - RELEASE 6'     HRC000DT DMT00250
*********ISEQ  73,80               VALIDATE INPUT FILE SEQUENCEING      DMT00260
*.                                                                      DMT00270
* MODULE NAME -                                                         DMT00280
*                                                                       DMT00290
*        DMTXJE                                                HRC000DT DMT00300
*                                                                       DMT00310
* FUNCTION -                                                            DMT00320
*                                                                       DMT00330
*        Attempt at an NJE Bisync line driver for              HRC000DT DMT00340
*        VM/370 Release 6 RSCS.  Hacked from DMTSML.           HRC000DT DMT00350
*                                                                       DMT00360
* ATTRIBUTES -                                                          DMT00370
*                                                                       DMT00380
*        NON-REUSABLE                                                   DMT00390
*                                                                       DMT00400
* ENTRY POINTS -                                                        DMT00410
*                                                                       DMT00420
*        XJEINIT                                               HRC000DT DMT00430
*                                                                       DMT00440
*                                                                       DMT00450
* ENTRY CONDITIONS -                                                    DMT00460
*                                                                       DMT00470
*        GPR 0 CONTAINS THE LENGTH OF THE PARM FIELD IN BYTES           DMT00480
*        GPR 1 CONTAINS THE ADDRESS OF THE PARM FIELD ON THE START CMD  DMT00490
*        GPR 2 CONTAINS THE ADDRESS OF THE LINK TABLE ENTRY FOR THIS    DMT00500
*                 TASK                                                  DMT00510
*                                                                       DMT00520
* EXIT CONDITIONS -                                                     DMT00530
*                                                                       DMT00540
*        NORMAL/ERROR -                                                 DMT00550
*                                                                       DMT00560
*              RETURN TO SUPVISOR VIA GIVE TERMINATE REQUEST TO DMTREX  DMT00570
         EJECT                                                          DMT00580
*                                                                       DMT00590
* CALLS TO OTHER ROUTINES -                                             DMT00600
*                                                                       DMT00610
*              SEE BEGINNING OF EACH SECTION                            DMT00620
*                                                                       DMT00630
* EXTERNAL REFERENCES -                                                 DMT00640
*                                                                       DMT00650
*              LINK TABLE ENTRY FOR THIS LINKID                         DMT00660
*              MAIN STORAGE MAP                                         DMT00670
*                                                                       DMT00680
* TABLES / WORKAREAS -                                                  DMT00690
*                                                                       DMT00700
*              TASK CONTROL TABLE FOR EACH PROCESSOR                    DMT00710
*                                                                       DMT00720
*                                                                       DMT00730
* REGISTER USAGE -                                                      DMT00740
*                                                                       DMT00750
*        ALL SUBROUTINES IN THE MODULE CONFORM GENERALLY TO THIS USAGE; DMT00760
*        ANY INDIVIDUAL  DEVIATIONS OR EXTENSIONS ARE LISTED WITH THE   DMT00770
*        COMMAND DESCRIPTION                                            DMT00780
*                                                                       DMT00790
*        GPR0   = ALTERNATE PARAMETER REGISTER                          DMT00800
*        GPR1   = PARAMETER REGISTER                                    DMT00810
*        GPR2   = WORK                                                  DMT00820
*        GPR3   = WORK                                                  DMT00830
*        GPR4   = WORK                                                  DMT00840
*        GPR5   = WORK                                                  DMT00850
*        GPR6   = WORK                                                  DMT00860
*        GPR7   = TCT ADDRESSABILITY                                    DMT00870
*        GPR8   = WORK                                                  DMT00880
*        GPR9   = Base register for variables csect DMTXJEA             DMT00890
*        GPR10  = BASE REGISTER                                         DMT00900
*        GPR11  = BASE REGISTER                                         DMT00910
*        GPR12  = BASE REGISTER                                         DMT00920
*        GPR13  = BUFFER POINTER                                        DMT00930
*        GPR14  = LINK REGISTER                                         DMT00940
*        GPR15  = LINK REGISTER                                         DMT00950
*                                                                       DMT00960
* NOTES -                                                               DMT00970
*                                                                       DMT00980
*        NONE                                                           DMT00990
*                                                                       DMT01000
* OPERATION -                                                           DMT01010
*                                                                       DMT01020
*                                                                       DMT01030
*              SEE OPERATION IN EACH SECTION OF PROGRAM                 DMT01040
*                                                                       DMT01050
* HISTORY -                                                             DMT01060
*                                                                       DMT01070
*                                                                       DMT01080
*         -    Pre-2019: first created from the DMTSML RJE line         DMT01090
*              driver plus many NJE related modifications and           DMT01100
*              was named DMTYJN and then DMTYJB.                        DMT01110
*                                                                       DMT01120
*         -    December 2019: renamed to DMTXJE and split into          DMT01130
*              multiple csects to provide base register relief.         DMT01140
*.                                                                      DMT01150
         EJECT                                                          DMT01160
*                                                                       DMT01170
********************                                                    DMT01180
*                  *   Main entry.  Performs general initialization.    DMT01190
* CSECT DMTXJE     *   This program is called by NJEDRV when a          DMT01200
*                  *   link is started by NJE38 Start command.          DMT01210
********************                                                    DMT01220
*                                                                       DMT01230
DMTXJE   CSECT                                                 HRC000DT DMT01240
*
*-- On entry to DMTXJE:                                           *XJE
*                                                                 *XJE
*    R0  = length of input parameters or 0                        *XJE
*    R1 -> input parameters or 0                                  *XJE
*    R2 -> LINKTABL entry for the node being started              *XJE
*    R7 -> SVECTORS list that replaces RSCS functions             *XJE
*    R8 -> list of addrs that DMTXJE fills for use by NJEDRV      *XJE
*    R9 -> two pages of storage for DMTXJE working storage        *XJE
*    R10-> working storage area of caller NJEDRV                  *XJE
*    R13-> OS save area and working storage for the main csect    *XJE
*                                                                 *XJE  DMT01860
*                                                                 *XJE  DMT01870
         B     12(,R15)                                           *XJE
         DC    CL8'DMTXJE'                                        *XJE
         USING DMTXJE,R12                                         *XJE
         USING LINKTABL,R6         GET LINKTABL ADDRESSABILTIY    *XJE
         USING DMTXJEA,R9          Global addressability          *XJE
TCTR     EQU   7                   TCT BASE REGISTER              *XJE
*                                                                 *XJE
         STM   R14,R12,12(R13)     Save caller's regs             *XJE
         LR    R12,R15                                            *XJE
*                                                                 *XJE
         LR    R4,R0               Save entry R0                  *XJE
         LR    R5,R1               Save entry R1                  *XJE
*                                                                 *XJE
         LR    R1,R9               -> storage page to be XJEMAIN  *XJE
         LR    R0,R1               Copy stg address               *XJE
         LA    R1,4095             Get size of storage area - 1   *XJE
         LA    R1,1(,R1)           Full size of storage area      *XJE
         L     R14,=A(DMTXJEA)     -> Constants and variables area*XJE
         LA    R15,DMTXJEAZ        Size of area; pad char = 0     *XJE
         MVCL  R0,R14              Init reenterable cpy of DMTXJEA*XJE
*                                                                 *XJE
         LA    R1,4095             Get size of storage area - 1   *XJE
         LA    R1,1(,R1)           Full size of storage area      *XJE
         L     R14,=A(DMTXJEB)     -> Constants and variables area*XJE
         LA    R15,DMTXJEBZ        Size of area; pad char = 0     *XJE
         MVCL  R0,R14              Init reenterable cpy of DMTXJEB*XJE
*                                                                 *XJE
         ST    R10,XJESAVE         Save caller wk'g stg in SA+0   *XJE
         ST    R13,XJESAVE+4       Save callers SA ptr            *XJE
         ST    R9,8(,R13)          Set fwd SA ptr                 *XJE
*  No SA in R13 as used in DMTXJE                                 *XJE
         MVC   TLINKS(SVLEN),0(R7) Set up input svectors          *XJE
         LA    R1,MSGECB           -> this ECB                    *XJE
         ST    R1,0(,R8)           Pass its addr back to NJEDRV   *XJE
         LA    R1,CMDECB           -> this ECB                    *XJE
         ST    R1,4(,R8)           Pass its addr back to NJEDRV   *XJE
         LA    R1,CMDRESP          -> this area                   *XJE
         ST    R1,8(,R8)           Pass its addr back to NJEDRV   *XJE
         LA    R1,ADAECB           -> this area                   *XJE
         ST    R1,12(,R8)          Pass its addr back to NJEDRV   *XJE
         LA    R1,RDEVSYNC         -> this area                   *XJE
         ST    R1,16(,R8)          Pass its addr back to NJEDRV   *XJE
*                                                                 *XJE
         L     R1,TLINKS           offset to ALINKS word NJEDRV   *XJE
         AR    R1,R10              Compute actual addr            *XJE
         L     R1,0(,R1)           Get ptr to LINKS anchor word   *XJE
         L     R1,0(,R1)           Get ptr to first LINKTABL entry*XJE
         ST    R1,TLINKS           Store addr of 1st LINKTABL entr*XJE
*
*-- Set the buffer sizes for this link
*
         LH    R1,LBUFF-LINKTABL(R2)    Get configured buff size  *XJE
         ST    R1,TPBUFSIZ              Set buffer size           *XJE
         ST    R1,MAXBUF                Set maximum size          *XJE
*
*                                                                 *XJE
*-- Relocate the adcons from DMTXJEA into the new page            *XJE
*                                                                 *XJE
RELOC000 EQU   *                                                  *XJE
         LA    R0,RELOCNUM         Number of entries to relocate  *XJE
         L     R7,=A(DMTXJEA)      -> constants and adcons csect  *XJE
         LA    R14,RELOC           -> first relocation description*XJE
*                                                                 *XJE
RELOC020 EQU   *                                                  *XJE
         SR    R15,R15             Clear for IC                   *XJE
         IC    R15,0(,R14)         Get offset to adcon            *XJE
         SR    R6,R6                                              *XJE
         ICM   R6,3,2(R14)         Get base/displacement of adcon *XJE
         N     R6,=X'00000FFF'     Keep only the displacement     *XJE
         AR    R6,R15              offset of the actual adcon     *XJE
         LA    R1,0(R6,R7)         -> original location of adcon  *XJE
         LA    R3,0(R6,R9)         -> new location of adcon       *XJE
         CLI   1(R14),4            4-byte adcon length?           *XJE
         BE    RELOC040            Yes                            *XJE
*                                                                 *XJE
RELOC030 EQU   *                ** Handle 3-byte adcons           *XJE
         ICM   R15,7,0(R1)         Load original adcon value      *XJE
         SR    R15,R7              Compute relative offset        *XJE
         AR    R15,R9              Compute new adcon value        *XJE
         STCM  R15,7,0(R3)         Str new adcon value in new loc *XJE
         B     RELOC050                                           *XJE
*                                                                 *XJE
RELOC040 EQU   *                ** Handle 4-byte adcons           *XJE
         ICM   R15,15,0(R1)        Load original adcon value      *XJE
         SR    R15,R7              Compute relative offset        *XJE
         AR    R15,R9              Compute new adcon value        *XJE
         STCM  R15,15,0(R3)        Str new adcon value in new loc *XJE
*                                                                 *XJE
RELOC050 EQU   *                                                  *XJE
         LA    R14,4(,R14)         Next reloc descriptor          *XJE
         BCT   R0,RELOC020         Continue through the adcons    *XJE
*                                                                 *XJE
         LR    R0,R4               Restore entry R0               *XJE
         LR    R1,R5               Restore entry R1               *XJE
*                                                                 *XJE
*-- begin original DMT code                                       *XJE
*        SAVE LINK TABLE ADDRESS                                        DMT02920
XJEINIT  EQU   *                                               HRC000DT
         ST    R2,XJELINK         Save the link table address  HRC000DT DMT02930
         LR    R6,R2               GET LINKTABL ADDR FOR DSECT          DMT02940
         MVC   ADACUU(2),LACTLINE  MOVE THE LINE ADDRESS TO IOBLOCK     DMT02950
         MVC   AXSLINK(8),LINKID   AND THE LINK ID FOR AXS              DMT02960
         UNPK  XJELINE(5),ADACUU(3) Unpk the device address    HRC000DT DMT02970
         MVC   XJELINE(3),XJELINE+1 Move to fld first 3 bytes  HRC000DT DMT02980
         MVI   XJELINE+3,C' '      Blank the next byte         HRC000DT DMT02990
         MVC   XJELINE+4(4),XJELINE+3 And the rest of the fld  HRC000DT DMT03000
         TR    XJELINE(3),AXSTRTAB-240 Translate to EBCDIC     HRC000DT DMT03010
         LH    R4,LACTLINE         GET ACTIVE LINE ADDRESS              DMT03020
*        DIAG  R4,R5,X'24'         FIND DEVICE TYPE                     DMT03030
         STCM  R5,B'0100',ADACUU+3 AND SAVE IN DEVICE BLOCK             DMT03040
         L     R15,TLINKS          GET START OF LINK CHAIN              DMT03050
         LR    R6,R15              THE FIRST ENTRY ADDR (LOCAL)   *XJE  DMT03060
         MVC   LOCATION(8),LINKID  AND SAVE FOR MSGS                    DMT03070
         MVC   NCCINODE,LINKID     Link name -> signon record  SML2NJE4 DMT03080
         DROP  R6                  Finished with link table    SML2NJE3 DMT03090
         SPACE 1                                                        DMT03100
         LTR   R0,R0               WAS A PARAMETER SPECIFIED?           DMT03110
         BZ    SETTAG              Nope - use all defaults     SML2NJE4 DMT03120
         SPACE 2                                                        DMT03130
*        SET UP REMOTE SYSTEM TYPE                                      DMT03140
         LA    R3,0(,R1)           GET START OF PARM FIELD IN R1        DMT03150
         LR    R5,R3               AND ALSO IN R4                       DMT03160
         ALR   R5,R0               ADD IN CNT TO PNT R4 AT END          DMT03170
         BAL   R14,PARMGET         GO GET IT                            DMT03180
         CLR   R3,R5               WAS IT SPECIFIED?                    DMT03190
         BNL   SETNOPAS            NO CONTINUE                          DMT03200
         SLR   R4,R3               R4 CONTAINS PARM LENGTH              DMT03210
         CL    R4,BUFMAXCT         TOO LONG?                            DMT03220
         BH    XJEIERR2            Yes - error exit            HRC000DT DMT03230
         STH   R4,BUFFCNT          SAVE FOR LATER                       DMT03240
         BCTR  R4,0                REDUCE BY ONE                        DMT03250
         EX    R4,ICTMOV2          AND MOVE FOR LATER                   DMT03260
         LA    R3,2(R4,R3)         POINT TO START OF NEXT PARM          DMT03270
         BAL   R14,PARMGET         FRAME IT                             DMT03280
         CLR   R3,R5               WAS IT SPECIFIED?                    DMT03290
         BNL   SETNOPAS            NO - EXIT                            DMT03300
         SLR   R4,R3               CALCULATE LENGTH                     DMT03310
         CL    R4,PASSMAX          WAS THE PASSWORD TOO LONG?  @VM01162 DMT03320
         BH    XJEIERR1            Yes..error exit             HRC000DT DMT03330
         BCTR  R4,0                DOWN BY ONE FOR CHAR OP              DMT03340
         EX    R4,ICTMOV3          AND MOVE IN THE PASSWORD             DMT03350
         EJECT                                                          DMT03360
SETNOPAS EQU   *                                                        DMT03370
         MVC   NCCILPAS,PASSWORD   Line passwd -> signon card  SML2NJE4 DMT03380
         EJECT                                                          DMT03390
*        INITIALIZE THE TASK NAME                                       DMT03400
         SPACE 1                                                        DMT03410
SETTAG   EQU   *                                                        DMT03420
         USING TAG,R8              GET TAG ADDRESSABILITY               DMT03430
*        INITIALIZE PRINT, JOB AND PUNCH TAGS                           DMT03440
         L     R8,APDEVTAG         Get SYSOUT tag address      SML2NJE4 DMT03450
         MVI   TAGINDEV,0          Could be PRT or PUN         SML2NJE4 DMT03460
         MVC   TAGINLOC(8),AXSLINK SET LOCATION ID                      DMT03470
         MVC   TAGDIST(8),AXSLINK  SET LOCATION ID                      DMT03480
         MVC   TAGLINK(8),AXSLINK SET DEFAULT LINK             @VA03300 DMT03490
         MVC   TAGTOLOC(8),LOCATION SET DEFAULT TOLOC          @VA03300 DMT03500
         MVI   PDEVSOPT,MULTOPEN   INDICATE MULTOPEN FOR PRT            DMT03510
         MVC   PDEVLINK(8),AXSLINK SET LOCATION ID                      DMT03520
         SPACE 1                                                        DMT03530
         L     R8,AJDEVTAG         GET JOB (SYSIN) TAG ADDRESS SML2NJE4 DMT03540
         MVI   TAGINDEV,TYPPUN     SET JOB DEVICE TYPE                  DMT03550
         MVC   TAGINLOC(8),AXSLINK SET LOCATION ID                      DMT03560
         MVC   TAGDIST(8),AXSLINK  SET LOCATION ID                      DMT03570
         MVC   TAGLINK(8),AXSLINK SET DEFAULT LINK             @VA03300 DMT03580
         MVC   TAGTOLOC(8),LOCATION SET DEFAULT TOLOC          @VA03300 DMT03590
         MVI   JDEVSOPT,MULTOPEN   INDICATE MULTOPEN FOR PRT            DMT03600
         MVC   JDEVLINK(8),AXSLINK SET LOCATION ID                      DMT03610
         SPACE 1                                                        DMT03620
         L     R8,ALDEVTAG         GET LOG TAG ADDRESS         SML2NJE4 DMT03630
         MVI   TAGINDEV,TYPPRT SET PRINTER DEVICE TYPE                  DMT03640
         MVC   TAGINLOC(8),AXSLINK SET LOCATION ID                      DMT03650
         MVC   TAGDIST(8),AXSLINK  SET LOCATION ID                      DMT03660
         MVC   TAGLINK(8),AXSLINK SET DEFAULT LINK             @VA03300 DMT03670
         MVC   TAGTOLOC(8),LOCATION SET DEFAULT TOLOC          @VA03300 DMT03680
         MVC   LOGGREQ+12(R8),AXSLINK SET LOCATION ID                   DMT03690
         MVI   LOGGREQ+3,MULTOPEN  SET MULTOPEN FOR PRT                 DMT03700
         DROP  R8                  DROP ADDRESSABILITY                  DMT03710
         EJECT                                                          DMT03720
*                                                                       DMT03730
*        SPECIFY TP BUFFER SIZE                                         DMT03740
*                                                                       DMT03750
         CLI   BUFFER,C' '         WAS THE BUFFER PARAMETER SPECIFIED?  DMT03760
         BE    SETNOBUF            NO - USE DEFAULT                     DMT03770
         CLI   BUFFER,C'B'         DOES IT START RIGHT?                 DMT03780
         BNE   XJEIERR2            No - error                  HRC000DT DMT03790
         LA    R1,BUFFER           GET START OF FIELD                   DMT03800
         AH    R1,BUFFCNT          AND POINT TO THE END OF IT           DMT03810
         OI    0(R1),X'C0'         SET ZONE                             DMT03820
         LH    R1,BUFFCNT          GET THE COUNT                        DMT03830
         BCTR  R1,0                DOWN BY ONE TO SHIP B                DMT03840
         BCTR  R1,0                AND AGAIN FOR CHAR OP                DMT03850
         EX    R1,PACKBUF          AND PACK THE FIELD                   DMT03860
         CVB   R1,AXSCVD           CONVERT IT TO BINARY                 DMT03870
         SRL   R1,1                SHIFT TO EVEN               @VM01162 DMT03880
         SLL   R1,1                TPBUFSIZ                    @VM01162 DMT03890
         CL    R1,MAXBUF           TOO BIG?                             DMT03900
         BH    XJEIERR2            Yes - error exit            HRC000DT DMT03910
         CL    R1,MINBUF           Too small?                  SML2NJE4 DMT03920
         BL    XJEIERR2            Yes - error exit            SML2NJE4 DMT03930
         ST    R1,TPBUFSIZ         AND SAVE                             DMT03940
SETNOBUF EQU   *                                                        DMT03950
         L     R1,TPBUFSIZ         GET SIZE OF BUFFER OR DEFAULT        DMT03960
         STH   R1,CCWC+6           AND STORE IN READ CCW                DMT03970
         STH   R1,NCCIBFSZ         And in signon card          SML2NJE4 DMT03980
         STH   R1,RDCOUNT     SET READ COUNT FIELD             @VA07451 DMT03990
         LA    R1,BUFDATA-BUFDSECT+3(R1) Size of TPB DSECT + 3 HRC001DT DMT04000
         SRL   R1,2                Round DOWN to word boundary HRC001DT DMT04010
         SLL   R1,2                Realign bits correctly      HRC001DT DMT04020
         ST    R1,BUFLN1           SAVE TO BUFFER CONSTRUCT ROUTINE     DMT04030
         SLL   R1,1                ALSO NEED 2*BUFFER SIZE              DMT04040
         ST    R1,BUFLN2           THAT GOES HERE FOR LATER             DMT04050
         SPACE 2                                                        DMT04060
*                                                                       DMT04070
*        SPECIFY ALERT ASYN EXIT                                        DMT04080
*                                                                       DMT04090
***???   ST    R9,XJEREG9          Set task r9                    *XJE  DMT04100
         LA    R1,ASYNEXIT                                              DMT04110
         SR    R0,R0               INDICATE INITIATING REQUEST          DMT04120
         L     R15,ASYNREQ         GET THE ROUTINE ADDR                 DMT04130
         BALR  R14,R15             AND SET THE EXIT                     DMT04140
*                                                                       DMT04150
         LA    R0,XJE1ISIO         Entry code 0 init successful   *XJE  DMT04160
         L     R15,=A(DMTXJE1)     -> main NJE processing rtn     *XJE  DMT04170
         BR    R15                 Go there; no return            *XJE  DMT04180
*                                                                       DMT04190
ICTMOV2  MVC   BUFFER(0),0(R3)     TO BE EXECUTED BY ABOVE CODE         DMT04200
ICTMOV3  MVC   PASSWORD(0),0(R3)   TO BE EXECUTED BY ABOVE CODE         DMT04210
PACKBUF  PACK  AXSCVD(8),BUFFER+1(0) TO BE EXECUTED FROM ABOVE          DMT04220
*                                                                       DMT04230
* Address constants from csect DMTXJEA that must be relocated     *XJE  DMT04240
* after dynamic memory is allocated and this csect is moved into  *XJE  DMT04250
* it. This is performed by routine RELOC000 above.                *XJE  DMT04260
*                                                                 *XJE  DMT04270
*                                                                 *XJE  DMT04280
*              O = offset from FIELD NAME of adcon value          *XJE  DMT04290
*              L = length of adcon                                *XJE  DMT04300
*                                                                 *XJE  DMT04310
*              ----O-L--FIELD NAME-----Sample from DMTXJEA csect--*XJE  DMT04320
*                                                                 *XJE  DMT04330
RELOC    DC    AL1(0,4),S(CCTNEXT)     DC    A($TCT2)             *XJE  DMT04340
         DC    AL1(0,4),S(CCTCOM)      DC    A($CCOMM1)           *XJE  DMT04350
         DC    AL1(0,4),S(CDEVREQ)     DC    A(*+8)               *XJE  DMT04360
         DC    AL1(1,3),S(CDEVRESP)    DC    AL1(19),AL3(*+3)     *XJE  DMT04370
         DC    AL1(0,4),S(WCTNEXT)     DC    A($TCT3)             *XJE  DMT04380
         DC    AL1(0,4),S(WCTCOM)      DC    A($WCOMM1)           *XJE  DMT04390
         DC    AL1(0,4),S(WDEVREQ)     DC    A(*+8)               *XJE  DMT04400
         DC    AL1(1,3),S(WDEVRESP)    DC    AL1(19),AL3(*+3)     *XJE  DMT04410
         DC    AL1(0,4),S(PCTNEXT)     DC    A($TCT4)             *XJE  DMT04420
         DC    AL1(0,4),S(PCTCOM)      DC    A($PCOMM1)           *XJE  DMT04430
         DC    AL1(0,4),S(PDEVREQ)     DC    A(*+8)               *XJE  DMT04440
         DC    AL1(1,3),S(PDEVRESP)    DC    AL1(19),AL3(*+3)     *XJE  DMT04450
         DC    AL1(0,4),S(APDEVTAG)    DC    A(PDEVTAG)           *XJE  DMT04460
         DC    AL1(0,4),S(APNJEHDR)    DC    A(PNJEHEAD)          *XJE  DMT04470
         DC    AL1(0,4),S(APNJEHND)    DC    A(PNJEHEND)          *XJE  DMT04480
         DC    AL1(0,4),S(RCTNEXT)     DC    A($TCT6)             *XJE  DMT04490
         DC    AL1(0,4),S(RCTCOM)      DC    A($RCOMM1)           *XJE  DMT04500
         DC    AL1(0,4),S(RDEVREQ)     DC    A(*+8)               *XJE  DMT04510
         DC    AL1(1,3),S(RDEVRESP)    DC    AL1(19),AL3(*+3)     *XJE  DMT04520
         DC    AL1(0,4),S(ARNJEHDR)    DC    A(RNJEHEAD)          *XJE  DMT04530
         DC    AL1(0,4),S(ARNJEHND)    DC    A(RNJEHEND)          *XJE  DMT04540
         DC    AL1(0,4),S(JCTCOM)      DC    A($JCOMM1)           *XJE  DMT04550
         DC    AL1(0,4),S(JDEVREQ)     DC    A(*+8)               *XJE  DMT04560
         DC    AL1(1,3),S(JDEVRESP)    DC    AL1(19),AL3(*+3)     *XJE  DMT04570
         DC    AL1(0,4),S(AJDEVTAG)    DC    A(JDEVTAG)           *XJE  DMT04580
         DC    AL1(0,4),S(AJNJEHDR)    DC    A(JNJEHEAD)          *XJE  DMT04590
         DC    AL1(0,4),S(AJNJEHND)    DC    A(JNJEHEND)          *XJE  DMT04600
         DC    AL1(0,4),S(INTFAKE)     DC    AL4($START)          *XJE  DMT04610
         DC    AL1(0,4),S(INITWAIT)    DC    A(ADAECB)            *XJE  DMT04620
         DC    AL1(1,3),S(CECBA)       DC    X'80',AL3(CMDECB)    *XJE  DMT04630
         DC    AL1(1,3),S(INITCCW)     CCW   X'2F',INITCCW+5,CC+SILI,1  DMT04640
         DC    AL1(1,3),S(INITCCWS)    CCW   X'23',ISETMODE,CC+SILI,1   DMT04650
         DC    AL1(1,3),S(INITCCWR)    CCW   1,INITSEQ,CC+SILI,2  *XJE  DMT04660
         DC    AL1(1,3),S(INITCCRD)    CCW   2,IREADRES,SILI,2    *XJE  DMT04670
         DC    AL1(0,4),S(ECBLIST)     DC    A(RDEVSYNC)          *XJE  DMT04680
         DC    AL1(0,4),S(LOKCMDA)     DC    A(CMDECB)            *XJE  DMT04690
         DC    AL1(0,4),S(LOKMSGA)     DC    A(MSGECB)            *XJE  DMT04700
         DC    AL1(0,3),S(LOKADAA)     DC    AL3(ADAECB)          *XJE  DMT04710
         DC    AL1(8,4),S(TODEBCON)    DC    F'-1',A(0+4,TIMEZON+4*XJE  DMT04720
         DC    AL1(0,4),S(WCMDA)       DC    A(WTOMBUF)           *XJE  DMT04730
         DC    AL1(0,4),S(MREQA)       DC    A(MSGBLK)            *XJE  DMT04740
         DC    AL1(0,4),S(TANKCON)     DC    A(TTANK)             *XJE  DMT04750
         DC    AL1(0,4),S(LOGREQA)     DC    A(LOGGREQ)           *XJE  DMT04760
         DC    AL1(1,3),S(LOGREQG)     DC    AL1(19),AL3(LOGGREQ) *XJE  DMT04770
         DC    AL1(0,4),S(ALDEVTAG)    DC    A(LDEVTAG)           *XJE  DMT04780
         DC    AL1(1,3),S(LOGCCW)      CCW   X'09',IOLINE,SILI,120*XJE  DMT04790
         DC    AL1(1,3),S(LOGHDCCW)    CCW   X'19',LOGHDLNE,SILI,LOG..  DMT04800
         DC    AL1(8,4),S(TERMBLK)     DC    F'0',CL4'REX ',A(TERMRE..  DMT04810
         DC    AL1(0,4),S($COMEXIT)    DC    A($START)            *XJE  DMT04820
         DC    AL1(0,4),S(ADCCWA)      DC    A(CCTCCW)            *XJE  DMT04830
         DC    AL1(1,3),S(CCWS)        CCW   1,XSYNSEQ,CD+SILI,4  *XJE  DMT04840
         DC    AL1(1,3),S(CCWB)        CCW   1,XETBSEQ,CC+SILI,2  *XJE  DMT04850
         DC    AL1(1,3),S(SGNOFCCW)    CCW   1,SGNOFDTA,CC+SILI,SG*XJE  DMT04860
         DC    AL1(1,3),S(SGNCCWA)     CCW   1,SGNOFEND,SILI,2    *XJE  DMT04870
RELOCNUM EQU   (*-RELOC)/4             Number of ADCONS           *XJE  DMT04880
*.                                                                *XJE  DMT04890
*                                                                 *XJE  DMT04900
* ENTRY NAME -                                                          DMT04910
*                                                                       DMT04920
*        PARMGET                                                        DMT04930
*                                                                       DMT04940
* FUNCTION -                                                            DMT04950
*                                                                       DMT04960
*        LINE SCANNING SUBROUTINE                                       DMT04970
*                                                                       DMT04980
* CALLS TO OTHER ROUTINES -                                             DMT04990
*                                                                       DMT05000
*        NONE                                                           DMT05010
*                                                                       DMT05020
* OPERATION -                                                           DMT05030
*                                                                       DMT05040
*        1. TEST FOR DELIMETER CHARACTER                                DMT05050
*                                                                       DMT05060
*        2. WHEN FOUND OR END OF STRING FOUND UPDATE R4                 DMT05070
*                                                                       DMT05080
*        3. AND RETURN                                                  DMT05090
*                                                                       DMT05100
* ENTRY -                                                               DMT05110
*                   REG.3 = ADDRESS OF START OF STRING                  DMT05120
*                   REG.5 = ADDRESS OF END OF STRING                    DMT05130
*                                                                       DMT05140
* EXIT -                                                                DMT05150
*                   REG.3 = FIRST NONDELIMETER CHARACTER SCANNED;       DMT05160
*                           IF NONE FOUND, END OF STRING                DMT05170
*                   REG.4 = UNMODIFIED IF NO NONDELIMETER CHAR SCANNED; DMT05180
*                           OTHERWISE, ADDRESS OF FIRST DELIMETER CHAR  DMT05190
*                           AFTER FIRST NONDELIMETER CHAR SCANNED;      DMT05200
*                           IF NONE, END OF STRING.                     DMT05210
*                   REG.5 = UNMODIFIED                                  DMT05220
*                                                                       DMT05230
*        A DELIMETER CHAR IS ANY CHARACTER OF THE FORM B'XX000000'      DMT05240
*                                                                       DMT05250
* RESPONSES -                                                           DMT05260
*                                                                       DMT05270
*        NONE                                                           DMT05280
*                                                                       DMT05290
* ERROR MESSAGES -                                                      DMT05300
*                                                                       DMT05310
*        NONE                                                           DMT05320
*                                                                       DMT05330
*.                                                                      DMT05340
         EJECT                                                          DMT05350
PARMGET  DC    0H'0'                                                    DMT05360
         LA    R5,0(R5)            CLEAR HIGH ORDER BYTE JUST IN CASE   DMT05370
         BCTR  R3,0                BUMP START OF STRING PTR BACK FOR C  DMT05380
PARMFIND EQU   *                                                        DMT05390
         LA    R3,1(R3)            LOOK AT THE NEXT CHARACTER           DMT05400
         CLR   R3,R5               HAVE WE HIT THE END OF THE STRING?   DMT05410
         BCR   11,R14              (BNL) YEP - LOOK NO MORE             DMT05420
         TM    0(R3),X'3F'         IS THIS CHARACTER A DELIMETER?       DMT05430
         BZ    PARMFIND            YEP- KEEP LOOKING FOR A NONDELIMETER DMT05440
         LR    R4,R3               SET UP FOR NEXT PHASE OF SCAN        DMT05450
PARMSCAN EQU   *                                                        DMT05460
         LA    R4,1(R4)            LOOK AT THE NEXT CHARACTER           DMT05470
         CLR   R4,R5               ARE WE AT THE END OF THE STRING YET? DMT05480
         BCR   11,R14              (BNL) RETURN IMMEDIATELY IF SO       DMT05490
         TM    0(R4),X'3F'         IS THIS CHARACTER A DELIMETER?       DMT05500
         BNZ   PARMSCAN            KEEP SCANNING FOR A DELIMETER IF NOT DMT05510
         BR    R14                 OTHERWISE ALL DONE - RETURN          DMT05520
         EJECT                                                          DMT05530
*---------------------------------------------------------------------* DMT05540
*                                                                     * DMT05550
*                 INITIALIZATION ERROR PROCESSOR                      * DMT05560
*                                                                     * DMT05570
*---------------------------------------------------------------------* DMT05580
         SPACE 1                                                        DMT05590
         DS    0H                                                       DMT05600
XJEIERR1 EQU   *                                               HRC000DT DMT05610
         LA    R0,XJE1ERR1         Display init error msg 901     *XJE  DMT05620
         L     R15,=A(DMTXJE1)     -> main NJE processing rtn     *XJE  DMT05630
         BR    R15                 Go there to handle this error  *XJE  DMT05640
*                                                                       DMT05650
XJEIERR2 EQU   *                                               HRC000DT DMT05660
         LA    R0,XJE1ERR2         Display init error msg 906     *XJE  DMT05670
         L     R15,=A(DMTXJE1)     -> main NJE processing rtn     *XJE  DMT05680
         BR    R15                 Go there to handle this error  *XJE  DMT05690
*                                                                       DMT05700
         LTORG                                                          DMT05710
         EJECT                                                          DMT05720
*.                                                                      DMT05730
*                                                                       DMT05740
* ENTRY NAME -                                                          DMT05750
*                                                                       DMT05760
*        ASYNEXIT                                                       DMT05770
*                                                                       DMT05780
* FUNCTION -                                                            DMT05790
*                                                                       DMT05800
*        THIS IS THE ALERT EXIT ENTERED BY DMTSIG.  TWO TASKS MAY       DMT05810
*        ALERT THIS LINE DRIVER: DMTREX WHEN A COMMAND HAS BEEN         DMT05820
*        ENTERED FOR THE DMTXJE LINE DRIVER TO PROCESS OR DMTAXS  000DT DMT05830
*        TO ASYNCHRONOUSLY NOTIFY DMTXJE A FILE HAS ARRIVED FOR   000DT DMT05840
*        TRANSMISSION.                                                  DMT05850
*                                                                       DMT05860
* CALLS TO OTHER ROUTINES -                                             DMT05870
*                                                                       DMT05880
*        DMTPST - TO POST AN EVENT COMPLETION                           DMT05890
*                                                                       DMT05900
* OPERATION -                                                           DMT05910
*                                                                       DMT05920
*        1. TEST IF THE ALERTING TASK IS DMTAXS OR DMTREX.              DMT05930
*                                                                       DMT05940
*        2. IF DMTAXS POST READER SYNCH LOCK COMPLETE.                  DMT05950
*                                                                       DMT05960
*        3. IF DMTREX AND MSG, QUEUE THE MSG FOR LATER                  DMT05970
*           PROCESSING BY A CALL TO PMSGREQ.                            DMT05980
*                                                                       DMT05990
*        4. IF A COMMAND MOVE THE COMMAND TO XJE STORAGE AND POST 000DT DMT06000
*           THE COMMAND SYNCH LOCK COMPLETE.                            DMT06010
*                                                                       DMT06020
* RESPONSES -                                                           DMT06030
*                                                                       DMT06040
*        NONE                                                           DMT06050
*                                                                       DMT06060
* ERROR MESSAGES -                                                      DMT06070
*                                                                       DMT06080
*        NONE                                                           DMT06090
*                                                                       DMT06100
*.                                                                      DMT06110
         SPACE 2                                                        DMT06120
ASYNEXIT EQU   *                                                        DMT06130
***      L     R12,TASKSAVE-TASKE(R13) GET THE FIRST BASE REGISTER*XJE  DMT06140
***      L     R9,XJEREG9          -> DMTXJEA stg area            *XJE  DMT06150
         CLI   1(R1),NMR           Is it an NMR?               SML2NJE4 DMT06160
         BE    ASYNENQ             Go and stack NMR            SML2NJE4 DMT06170
         CL    R0,REXNAME          IS IT THE CONTROLLING TASK CALLING   DMT06180
         BNE   ASYN1               NO                                   DMT06190
         CLI   1(R1),MSGCMD        IS IT A MSG ELEMENT?                 DMT06200
         BE    ASYNENQ             Yes. Stack message          SML2NJE4 DMT06210
         EJECT                                                          DMT06220
ASYNCONT EQU   *                                                        DMT06230
         CLI   CMDINPGS,X'FF'      IS A COMMAND ALREADY IN PROCESS      DMT06240
         BE    ASYNCMD             YES TIME TO EXIT                     DMT06250
         MVI   2(R1),X'00'         INDICATE ACCEPTING COMMAND           DMT06260
         OI    CMDINPGS,X'FF'      SHOW COMMAND ACTIVE                  DMT06270
         SR    R15,R15             ZERO FO IC                           DMT06280
         IC    R15,0(R1)           GET COMMAND ELEMENT LENGTH           DMT06290
         EX    R15,CMDMVC          AND MOVE TO MY BUFFER                DMT06300
         LA    R1,CMDECB           MUST NEED CMD                        DMT06310
         B     ASYNRET             GO TO COMMON EXIT                    DMT06320
         SPACE 1                                                        DMT06330
ASYN1    EQU   *                                                        DMT06340
         CL    R0,AXSNAME          IS IT FILE ACCESS                    DMT06350
         BNER  R14                 NOPE..RETURN                         DMT06360
         TM    RCTECB,TCTBUSY    IS READER BUSY???            @VA10416  DMT06370
         BOR   R14               BR, IF YES                   @VA10416  DMT06380
         LA    R1,RDEVSYNC         READER TO BE POSTED                  DMT06390
ASYNRET  EQU   *                                                        DMT06400
         LA    R0,0                POST CODE                            DMT06410
         L     R15,POSTREQ         SYSTEM POST PROCESSOR                DMT06420
         BR    R15                 AND CONTINUE                         DMT06430
         SPACE 1                                                        DMT06440
ASYNCMD  EQU   *                                                        DMT06450
         MVI   2(R1),X'10'         SHOW COMMAND REFUSAL                 DMT06460
         BR    R14                 AND RETURN TO REX                    DMT06470
         SPACE 1                                                        DMT06480
ASYNENQ  EQU   *                                                        DMT06490
         L     R2,XJELINK          Get link table address      HRC000DT DMT06500
         LA    R13,ASYNSAVE        Get save area for ASYNEXIT  SML2NJE4 DMT06510
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE  DMT06520
         L     R15,PMSGREQ         AND THE MSG STACK ROUTINE ADDR       DMT06530
         LR    R3,R14              SAVE RETURN REGISTER                 DMT06540
         BALR  R14,R15             AND STACK THE MSG                    DMT06550
         LR    R14,R3              RESTORE RETURN REGISTER              DMT06560
         LTR   R15,R15             DID MSG STACK?                       DMT06570
         BNZ   ASYNCMD             NO                                   DMT06580
         MVI   2(R1),X'00'         INDICATE ACCEPTANCE                  DMT06590
         LA    R1,MSGECB           INDICATE THE CORRECT ECB FOR POST    DMT06600
         B     ASYNRET             AND CONTINUE                         DMT06610
         SPACE 1                                                        DMT06620
CMDMVC   MVC   CMDRESP(0),0(R1)    TO BE EXECUTED BY ABOVE CODE         DMT06630
         LTORG                                                          DMT06640
         EJECT                                                          DMT06650
*                                                                       DMT06660
********************                                                    DMT06670
*                  *   Core line driver functions.                      DMT06680
* CSECT DMTXJE1    *                                                    DMT06690
*                  *                                                    DMT06700
********************                                                    DMT06710
*                                                                       DMT06720
DMTXJE1  CSECT                                                    *XJE  DMT06730
         LR    R12,R15             Set entry addr                 *XJE  DMT06740
         LA    R11,2048                                           *XJE  DMT06750
         LA    R11,2048(R11,R12)   Get 2nd base                   *XJE  DMT06760
         LA    R10,2048                                           *XJE  DMT06770
         LA    R10,2048(R10,R11)   Get 3rd base                   *XJE  DMT06780
         USING DMTXJE1,R12,R11,R10                                *XJE  DMT06790
*                                                                       DMT06800
         LR    R14,R0              Get entry code                 *XJE  DMT06810
         B     XJE1FUNC(R14)       Branch into table of functions *XJE  DMT06820
*                                                                       DMT06830
XJE1FUNC B     ISIO                Code 00 Initialization complete*XJE  DMT06840
         B     XJELERR1            Code 04 Initialization error 1 *XJE  DMT06850
         B     XJELERR2            Code 08 Initialization error 2 *XJE  DMT06860
*                                                                       DMT06870
*.                                                                      DMT06880
*                                                                       DMT06890
* ENTRY NAME -                                                          DMT06900
*                                                                       DMT06910
*        ISIO                                                           DMT06920
*                                                                       DMT06930
* FUNCTION -                                                            DMT06940
*                                                                       DMT06950
*        THIS ROUTINE PERFORMS THE ENABLE SEQUENCE ON THE               DMT06960
*        COMMUNICATIONS LINE, ANALYZES THE RESPONSE RECEIVED, AND       DMT06970
*        WHEN CORRECT WRITES THE LINE CONNECTED MSG.                    DMT06980
*                                                                       DMT06990
* CALLS TO OTHER ROUTINES -                                             DMT07000
*                                                                       DMT07010
*        DMTIOMRQ - TO INITIATE AN I/O OPERATION                        DMT07020
*        DMTWAT - TO WAIT FOR AN EVENT COMPLETION                       DMT07030
*                                                                       DMT07040
* OPERATION -                                                           DMT07050
*                                                                       DMT07060
*        1. ISSUE INITIAL MESSAGE 141.                                  DMT07070
*                                                                       DMT07080
*        2. ENABLE TP LINE AND WAIT FOR ENABLE TO COMPLETE.             DMT07090
*                                                                       DMT07100
*        3. EXAMINE RESPONSE FROM INITIAL READ AND VALIDATE             DMT07110
*           DEPENDENT ON SML MODE.                                      DMT07120
*                                                                       DMT07130
*        4. WHEN CORRECT REPLY HAS BEEN RECEIVED ISSUE MSG 142          DMT07140
*           AND EXIT TO IBLDBUFS.                                       DMT07150
*                                                                       DMT07160
* RESPONSES -                                                           DMT07170
*                                                                       DMT07180
*        DMTXJE141I  LINK 'VADDR' READY FOR CONNECTION TO ...  HRC000DT DMT07190
*        DMTXJE142I  LINK 'LINKID' LINE 'VADDR' CONNECTED      HRC000DT DMT07200
*                                                                       DMT07210
* ERROR MESSAGES -                                                      DMT07220
*                                                                       DMT07230
*        NONE                                                           DMT07240
*                                                                       DMT07250
*.                                                                      DMT07260
ISIO     DS    0H                                                       DMT07270
         L     R6,XJELINK          Get linktable address for.. HRC031DT DMT07280
         USING LINKTABL,R6         Link table addressability   HRC031DT DMT07290
         OI    LFLAG,LACTIVE       Mark link as active            *XJE  DMT07300
         NI    LFLAG,255-LCONNECT  Mark link as not connected  HRC031DT DMT07300
         DROP  R6                  Finished with link table    HRC031DT DMT07310
         MVC   INITSEQ(2),IPRISEQ  Reset greeting sequence     SML2NJE4 DMT07320
         MVI   INITCCW,DISABLE     Replace DISABLE             SML2NJE4 DMT07330
         MVI   INITCCWS,SETMODE    Replace SETMODE             SML2NJE4 DMT07340
         MVI   INITCCWR,WRITE      Replace WRITE if changed    SML2NJE4 DMT07350
         MVI   INITCCRD,READ       Replace READ if changed     SML2NJE4 DMT07360
         NI    XJESYS,PRIMONLY     Clear signon etc status     SML2NJE4 DMT07370
         MVI   CBCBCNTO,X'80'      Reset outgoing BCB value    SML2NJE4 DMT07380
         MVI   CBCBCNTI,X'80'      Reset incoming BCB value    SML2NJE4 DMT07390
         MVC   $FCSOUT(2),=X'8FCF' Reset outgoing FCS to open  SML2NJE4 DMT07400
         MSGX  141,(XJELINE,AXSLINK) Write msg                 HRC000DT DMT07410
         EJECT                                                          DMT07420
         TM    XJESYS,PRIMONLY     Are we defined as secondary?SML2NJE4 DMT07430
         BNO   ISIO1               NOPE CONTINUE                        DMT07440
         MVI   INITCCWR,NOP     IN HOST NOP WRITE ENQUE       @VA09842  DMT07450
ISIO1    EQU   *                                                        DMT07460
         LA    R7,15               SET RETRY COUNTER                    DMT07470
RISIO    EQU   *                   Establish comms with remote SML2NJE4 DMT07480
         LA    R6,INITCCW          INITIALIZATION CCW STRING            DMT07490
I27XXIO  EQU   *                   ENTRY                                DMT07500
         ST    R6,ADCCWA           STORE IN CAW                         DMT07510
         XC    ADAECB(4),ADAECB    CLEAR OUT SYNCH LOCK                 DMT07520
         MVI   ADASENSE,X'00'      ZERO SENSE BYTE                      DMT07530
         LA    R1,ADAECB           GET ADAPTER IO BLOCK                 DMT07540
         L     R15,IOREQ           SYSTEM I/O PROCESSOR                 DMT07550
         BALR  R14,R15             GO EXECUTE THE I/O                   DMT07560
         CLI   ADASIOCC,X'03'      DOES THE ADAPTER EXIST?              DMT07570
         BNE   RISIO1              OKAY CONTINUE                        DMT07580
         LA    R1,INITCCW          GET FAILING CCW ADDR                 DMT07590
         BAL   R14,IOERRPRT        GO WRITE ERR MSG                     DMT07600
         B     XJECRASH                Exit w/o disable        HRC000DT DMT07610
         EJECT                                                          DMT07620
RISIO1   EQU   *                                                        DMT07630
         LA    R1,INITWAIT         GET WAIT LIST                        DMT07640
         L     R15,WAITREQ         SYSTEM WAIT PROCESSOR                DMT07650
         BALR  R14,R15             WAIT FOR I/O TO COMPLETE             DMT07660
         TM    CMDECB,X'40'        WAS IT A COMMAND?              *XJE  DMT07670
         BO    INITCMD             YES                                  DMT07680
RISIO2   EQU   *                                                        DMT07690
         MVI   INITCCW,SENSE       CHANGE DISABLE TO SENSE              DMT07700
         MVI   INITCCWS,NOP        NOP SET MODE                         DMT07710
         TM    ADACSW+4,UE         Did we get unit exception?  SML2NJE4 DMT07720
         BZ    RISIO3              No data lost condition then SML2NJE4 DMT07730
         MVC   INITCCWS(8),IREADSKP Replace SET MODE / NOP CCW SML2NJE4 DMT07740
         B     RISIO               Go do I/O to clear data lostSML2NJE4 DMT07750
RISIO3   EQU   *                                               SML2NJE4 DMT07760
         CLC   ADACSW+4(2),=X'0C00' DID IT END OKAY                     DMT07770
         BNZ   SLOOP               RETRY IF PREVIOUS I/O BAD            DMT07780
         TM    XJESYS,RESPEND      Secondary response sent?    SML2NJE4 DMT07790
         BO    SIGNOK              Yes.  Go wait for signon.   SML2NJE4 DMT07800
         CLC   ISECRES(2),IREADRES Secondary response arrived? SML2NJE4 DMT07810
         BE    GOTSECRS            Other end is secondary      SML2NJE4 DMT07820
         CLC   IPRISEQ(2),IREADRES Primary sequence arrived?   SML2NJE4 DMT07830
         BE    GOTPRISQ            Other end is primary        SML2NJE4 DMT07840
         CLC   IALTSEQ(2),IREADRES Alternate sequence arrived? SML2NJE4 DMT07850
         BE    RISIO               Other end can't decide.     SML2NJE4 DMT07860
         SPACE 1                                                        DMT07870
SLOOP    EQU   *                                                        DMT07880
         TM    ADASENSE,B'00000001' TIMEOUT?                            DMT07890
         BO    RISIO               YES..DONT COUNT                      DMT07900
         BCT   R7,RISIO            RETRY 15 TIMES                       DMT07910
         XR    R1,R1          Clear top byte of R1             HRC004DT DMT07920
         ICM   R1,B'0111',ADACSW Get CCW address and set CC    HRC004DT DMT07930
         BZ    RISIOCSW       Avoid PROG 0005 in IOERRPRT      HRC004DT DMT07940
         SH    R1,=H'8'            Back up 8                   HRC001DT DMT07950
RISIOCSW EQU   *                                               HRC004DT DMT07960
         BAL   R14,IOERRPRT        WRITE THE ERR MSG                    DMT07970
         B     EOJ                 TERMINATE THE TASK                   DMT07980
         SPACE 1                                                        DMT07990
INITCMD  EQU   *                                                        DMT08000
         XC    CMDECB(4),CMDECB    CLEAR SYNCH LOCK                     DMT08010
         LM    R3,R5,CMDSETUP      PREPARE FOR COMMAND SCAN             DMT08020
INITCDSN EQU   *                                                        DMT08030
         CLC   0(1,R3),CMDRESP+1   IS IT THIS ONE                       DMT08040
         BE    INTCALL             YES                                  DMT08050
         BXLE  R3,R4,INITCDSN      PREPARE FOR NEXT COMPARE             DMT08060
INTCALL  EQU   *                                                        DMT08070
         L     R6,XJELINK          Get link table address      HRC000DT DMT08080
         MVC   MSGLINK(8),CMDRESP+4 MOVE IN RESPONSE LINKID             DMT08090
         L     R15,0(R3)           GET ROUTINE TO CALL                  DMT08100
         BALR  R14,R15             GO EXECUTE THE COMMAND               DMT08110
         MVI   CMDINPGS,X'00'      RESET COMMAND IN PROGRESS SWITCH     DMT08120
         TM    ADAECB,X'40'        WAS THE ADAPTER ALSO POSTED?   *XJE  DMT08130
         BO    RISIO2              YES                                  DMT08140
         B     RISIO1              NO..WAIT AGAIN                       DMT08150
         EJECT                                                          DMT08160
GOTPRISQ EQU   *                                               SML2NJE4 DMT08170
         OI    XJESYS,PRIMARY+RESPEND Mark other end primary   SML2NJE4 DMT08180
         MVC   INITSEQ(2),ISECRES  Set up secondary response   SML2NJE4 DMT08190
         MVI   INITCCWR,WRITE      Put back in write CCW       SML2NJE4 DMT08200
         MVI   INITCCRD,NOP        Do not do read after write  SML2NJE4 DMT08210
         B     RISIO               Go do I/O to send response  SML2NJE4 DMT08220
GOTSECRS EQU   *                                               SML2NJE4 DMT08230
         OI    XJESYS,SECONDRY     Mark other end as secondary SML2NJE4 DMT08240
         B     SIGNOK              Go send signon record       SML2NJE4 DMT08250
SIGNOK   EQU   *                                                        DMT08260
         MVC   $COMEXIT(4),INTFAKE SET FAKE INTERRUPT                   DMT08270
         MSGX  142,(AXSLINK,XJELINE) Write message             HRC000DT DMT08280
         XC    ADAECB(4),ADAECB    Clear adapter synch lock    HRC002DT DMT08290
         LA    R8,CCTCCW           GET RIGHT CCW ADDR                   DMT08300
         ST    R8,ADCCWA           AND SET CAW                          DMT08310
         B     IBLDBUFS            GO CONSTRUCT BUFFER POOL             DMT08320
         SPACE 1                                                        DMT08330
IBLDBUFS DS    0H                                                       DMT08340
         ICM   R1,B'1111',BUFSPAGE Get address of buffer page  SML2NJE4 DMT08350
         BNZ   SKIPBUFS            Buffers allocated already?  SML2NJE4 DMT08360
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE  DMT08370
         SR    R0,R0               Init                           *XJE
         L     R1,MAXBUF           Get line's buffer size         *XJE
         LA    R1,12(,R1)          Add in overhead                *XJE
         M     R0,BNUMBUFS         Times number of buffers        *XJE
         SLDL  R0,20               # of pages to R0               *XJE
         LTR   R1,R1               Even page size?                *XJE
         BZ    *+8                 Yes, R0 is perfect             *XJE
         A     R0,BONE             Else add 1 additional page     *XJE
         L     R15,GPAGEREQ        Get # pages specified by R0          DMT08380
         LA    R13,COMSAVE         USE THIS SAVE AREA                   DMT08390
         BALR  R14,R15             AND GET A PAGE                       DMT08400
         LTR   R1,R1               Did request succeed?        SML2NJE4 DMT08410
         BZ    MSG495              Issue error message and exitSML2NJE4 DMT08420
         ST    R1,BUFSPAGE         Set address of buffer page     *XJE  DMT08350
SKIPBUFS EQU   *                   Buffers already allocated   SML2NJE4 DMT08430
         LR    R4,R1               LOAD ADDR OF 1ST BUFFER              DMT08440
         LR    R5,R1               LOAD ADDR OF 1ST BUFFER              DMT08450
         ST    R1,$BUFPOOL         STORE START OF FREE BUFFER POOL      DMT08460
         L     R6,BNUMBUFS         NUMBER OF BUFFERS TO BE BUILT        DMT08470
BULDMORE DS    0H                                                       DMT08480
         A     R5,BUFLN2           CALCULATE IFLAST BUFFER ADDR         DMT08490
         S     R6,BONE             DOWN BY ONE                          DMT08500
         BZ    BUFSDONE            BR IF LAST BUFFER                    DMT08510
         S     R5,BUFLN1           AND THE NEXT ONE                     DMT08520
         ST    R5,0(0,R4)          STORE POINTER IN PREV BUF            DMT08530
         MVC   L'BUFCHAIN((BUFSTART-BUFCOUNT),R4),BUFZEROS MOVE IN      DMT08540
*                                  INITIAL VALUES                       DMT08550
         L     R4,0(0,R4)          CHAIN                                DMT08560
         B     BULDMORE            BR TO BUILD ANOTHER BUFF             DMT08570
         SPACE 1                                                        DMT08580
BUFSDONE DS    0H                                                       DMT08590
         L     R5,BUFZEROS         LOAD CHAIN TERMINATOR                DMT08600
         ST    R5,0(0,R4)          STORE IT IN THE LAST BUFFER          DMT08610
         MVC   L'BUFCHAIN((BUFSTART-BUFCOUNT),R4),BUFZEROS MOVE IN      DMT08620
*                                  INITIAL VALUES                       DMT08630
         EJECT                                                          DMT08640
*        NOW BUILD THE TANK QUEUE                                       DMT08650
         ICM   R1,B'1111',TANKPAGE Get address of tanks page   SML2NJE4 DMT08660
         BNZ   SKIPTANK            Tanks allocated already?    SML2NJE4 DMT08670
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE  DMT08680
         LA    R0,1                # of pages requested           *XJE
         L     R15,GPAGEREQ        GET THE RIGHT ROUTINE                DMT08690
         LA    R13,COMSAVE         USE THIS SAVE AREA                   DMT08700
         BALR  R14,R15             AND GET A PAGE                       DMT08710
         LTR   R1,R1               Did request succeed?        SML2NJE4 DMT08720
         BZ    MSG495              Issue error message and exitSML2NJE4 DMT08730
         ST    R1,TANKPAGE         Set address of tanks page      *XJE  DMT08350
SKIPTANK EQU   *                   Tanks already allocated     SML2NJE4 DMT08740
         LR    R4,R1               LOAD ADDR OF 1ST TANK                DMT08750
         LR    R5,R1               LOAD ADDR OF 1ST TANK                DMT08760
         ST    R1,$TANKPOL         STORE START OF FREE TANK POOL        DMT08770
         L     R6,TNUMBUFS         NUMBER OF TANKS TO BE BUILT          DMT08780
TBLDMORE DS    0H                                                       DMT08790
         A     R5,TNKLN2           GET THE LAST ONE                     DMT08800
         S     R6,BONE             DOWN BY ONE                          DMT08810
         BZ    TNKSDONE            BR IF LAST TANK                      DMT08820
         S     R5,TNKLN1           AND THE NEXT ONE                     DMT08830
         ST    R5,0(0,R4)          STORE POINTER IN PREV BUF            DMT08840
         MVC   L'TANKCHN((TANKDATA-TANKRCB),R4),BUFZEROS MOVE IN        DMT08850
*                                  INITIAL VALUES                       DMT08860
         L     R4,0(0,R4)          CHAIN                                DMT08870
         B     TBLDMORE            BR TO BUILD ANOTHER TANK             DMT08880
         SPACE 1                                                        DMT08890
TNKSDONE DS    0H                                                       DMT08900
         L     R5,BUFZEROS         LOAD CHAIN TERMINATOR                DMT08910
         ST    R5,0(0,R4)          STORE IT IN THE LAST BUFFER          DMT08920
         MVC   L'TANKCHN((TANKDATA-TANKRCB),R4),BUFZEROS MOVE IN        DMT08930
*                                  INITIAL VALUES                       DMT08940
         EJECT                                                          DMT08950
*        Send the initial signon record if we are primary               DMT08960
         USING BUFDSECT,R13        *                                    DMT08970
         TM    XJESYS,PRIMARY      Is remote end the primary?  SML2NJE4 DMT08980
         BO    NSGNCRD             YES DO NOT NEED SIGNON CARD          DMT08990
*        Set parts of initial signon record which might change SML2NJE4 DMT09000
         MVI   NCCSRCB,C'I'        SRCB for initial signon rec SML2NJE4 DMT09010
         XC    NCCIEVNT,NCCIEVNT   Connection event sequence   SML2NJE4 DMT09020
         CLC   $BUFPOOL,=F'0'      ARE WE EMPTY                         DMT09030
         BE    IBUF1               YES                                  DMT09040
         L     R13,$BUFPOOL        GET FIRST BUFFER ADDR                DMT09050
         MVC   $BUFPOOL(4),0(R13)  REMOVE THIS ONE FROM CHAIN           DMT09060
IBUF1    EQU   *                                                        DMT09070
         MVC   BUFCOUNT(ICTLE-ICTLS),ICTLS SETUP CONTROL REPLY          DMT09080
         LA    R8,$OUTBUF          GET NEXT PTR                   *XJE  DMT09090
IBUF2    EQU   *                                                        DMT09100
         CLC   0(4,R8),=F'0'       IS IT THE LAST                       DMT09110
         BE    IBUF3               YES                                  DMT09120
         L     R8,0(0,R8)          GET THE NEXT ONE                     DMT09130
         B     IBUF2               AND COMPARE                          DMT09140
         SPACE 1                                                        DMT09150
IBUF3    EQU   *                                                        DMT09160
         ST    R13,0(0,R8)         CHAIN THIS ONE TO IT                 DMT09170
         MVC   0(4,R13),=F'0'      SET NEW FORWARD ZERO                 DMT09180
NSGNCRD  EQU   *                                                        DMT09190
         CLC   $BUFPOOL,=F'0'      ARE WE EMPTY                         DMT09200
         BE    IBUF4               YES                                  DMT09210
         L     R13,$BUFPOOL        GET FIRST BUFFER ADDR                DMT09220
         MVC   $BUFPOOL(4),0(R13)  REMOVE THIS ONE FROM CHAIN           DMT09230
IBUF4    EQU   *                                                        DMT09240
         ST    R13,CBUFFER         SET FOR I/O ROUTINES                 DMT09250
         MVC   BUFSTART,XACKSEQ    FAKE AN ACK                          DMT09260
         B     $ENDREAD            FAKE AN INTERRUPT                    DMT09270
         DROP  R13                                                      DMT09280
MSG495   EQU   *                                               SML2NJE4 DMT09290
         MSGX  495                 Virtual storage size insuff SML2NJE4 DMT09300
         B     EOJ                 Exit task                   SML2NJE4 DMT09310
         EJECT                                                          DMT09320
*.                                                                      DMT09330
*                                                                       DMT09340
* ENTRY NAME -                                                          DMT09350
*                                                                       DMT09360
*        $START                                                         DMT09370
*                                                                       DMT09380
* FUNCTION -                                                            DMT09390
*                                                                       DMT09400
*        THIS IS THE SUPERVISOR ROUTINE FOR DMTXJE.  THE       HRC000DT DMT09410
*        COMMUTATOR WILL CYCLE LOOKING FOR A ROUTINE TO ENTER           DMT09420
*        UNTIL ALL COMMUTATOR ENTRIES ARE CLOSED, THEN IT WILL          DMT09430
*        WAIT ON A SYNCH LOCK LIST TO BE POSTED.                        DMT09440
*                                                                       DMT09450
* CALLS TO OTHER ROUTINES -                                             DMT09460
*                                                                       DMT09470
*        DMTWAT - TO WAIT FOR AN EVENT COMPLETION                       DMT09480
*                                                                       DMT09490
* OPERATION -                                                           DMT09500
*                                                                       DMT09510
*        1. EXIT TO ANY ROUTINE WHOSE COMMUTATOR GATE IS OPEN.          DMT09520
*                                                                       DMT09530
*        2. CHECK THE STATUS OF THE SYNCH LOCK FOR EACH PROCESSOR, IF   DMT09540
*           THE SYNCH LOCK IS POSTED, OPEN THE PROCESSORS COMMUTATOR    DMT09550
*           GATE.                                                       DMT09560
*                                                                       DMT09570
*        3. CHECK THE PROGRESS OF A DRAIN OR HOLD. IF COMPLETE ISSUE    DMT09580
*           APPROPRIATE MESSAGE.                                        DMT09590
*                                                                       DMT09600
*        4. CHECK TO SEE IF ANY COMMUTATOR GATES ARE OPEN, IF NONE      DMT09610
*           ARE OPEN WAIT ON THE LIST OF PROCESSOR SYNCH LOCKS.         DMT09620
*                                                                       DMT09630
* RESPONSES -                                                           DMT09640
*                                                                       DMT09650
*        DMTXJE611I  LINK 'LINKID' FILE TRANSMISSION SUSPENDED HRC000DT DMT09660
*                                                                       DMT09670
* ERROR MESSAGES -                                                      DMT09680
*                                                                       DMT09690
*        NONE                                                           DMT09700
*                                                                       DMT09710
*.                                                                      DMT09720
         SPACE 1                                                        DMT09730
         USING IOTABLE,R8          GET IOTABLE ADDRESSABILITY           DMT09740
CMDECK   EQU   *                                                        DMT09750
         TM    CMDECB,X'40'        IS CMD NEEDED                  *XJE  DMT09760
         BZ    MSGECK              NO                                   DMT09770
         XC    CMDECB(4),CMDECB    CLEAR OUT SYNCH LOCK                 DMT09780
         MVI   $CMDCOM+1,OPEN      OPEN CMD GATE                        DMT09790
MSGECK   EQU   *                                                        DMT09800
         TM    MSGECB,X'40'        IS MSG NEEDED                  *XJE  DMT09810
         BZ    RDRECBCK            NO                                   DMT09820
         XC    MSGECB(4),MSGECB    CLEAR OUT SYNCH LOCK                 DMT09830
         MVI   $MSGCOM+1,OPEN      OPEN MSG GATE                        DMT09840
         SPACE                                                          DMT09850
RDRECBCK EQU   *                                                        DMT09860
         TM    RDEVSYNC,X'40'      IS THE READER POSTED?          *XJE  DMT09870
         BNO   JOBECBCK            No                          SML2NJE4 DMT09880
         XC    RDEVSYNC(4),RDEVSYNC CLEAR OUT SYNCH LOCK                DMT09890
         MVI   $RCOMM1+1,OPEN      OPEN READER GATE                     DMT09900
         SPACE 1                                                        DMT09910
JOBECBCK EQU   *                                                        DMT09920
         TM    MASTERSW,JOB        IS THE DEVICE OPEN                   DMT09930
         BNO   PRTECBCK            NO                                   DMT09940
         L     R8,JDEVFIOA         GET IOTABLE ADDRESS                  DMT09950
         TM    IOSYNCH,X'40'       SEE IF DONE                    *XJE  DMT09960
         BNO   PRTECBCK            NOT DONE YET                         DMT09970
         OI    $JCOMM1+1,OPEN      OPEN GATE                            DMT09980
         OC    JCTECB,ENDCSW+4     OR IN CSW STATUS                     DMT09990
         NI    JCTECB,X'EF'        TURN OFF BUSY                        DMT10000
         XC    IOSYNCH(4),IOSYNCH  CLEAR ECB                            DMT10010
         SPACE 1                                                        DMT10020
PRTECBCK EQU   *                                                        DMT10030
         TM    MASTERSW,SYSOUT     Is UR output device open?   SML2NJE4 DMT10040
         BNO   ADAECBCK            NOPE                                 DMT10050
         L     R8,PDEVFIOA         GET IOBABLE ADDRESS                  DMT10060
         TM    IOSYNCH,X'40'       SEE IF COMPLETE                *XJE  DMT10070
         BNO   ADAECBCK            NOT DONE YET                         DMT10080
         OI    $PCOMM1+1,OPEN      OPEN GATE                            DMT10090
         OC    PCTECB(1),ENDCSW+4  SET ECB WITH CSW STATUS              DMT10100
         NI    PCTECB,X'EF'        TURN OFF INUSE                       DMT10110
         XC    IOSYNCH(4),IOSYNCH  CLEAR OUT SYNCH LOCK                 DMT10120
         SPACE 1                                                        DMT10130
ADAECBCK EQU   *                                                        DMT10140
         TM    ADAECB,X'40'        IS THE ADAPTER POSTED          *XJE  DMT10150
         BNO   ALLCHK              NO                                   DMT10160
         OI    $COMCOM+5,OPEN      OPEN GATE                            DMT10170
         B     GOLOGIT             GO LOG THE RECEIVED BUFFER           DMT10180
         SPACE                                                          DMT10190
LOGITBK  EQU   *                                                        DMT10200
         XC    ADAECB(4),ADAECB    CLEAR ECB                            DMT10210
         USING LINKTABL,R6         Link table addressability   SML2NJE3 DMT10220
         L     R6,XJELINK          Get link table address      HRC000DT DMT10230
         TM    LFLAG,LDRAIN        IS A DRAIN IN PROGRESS?              DMT10240
         BNO   ALLHLD              NO CONTINUE                          DMT10250
         CLI   MASTERSW,X'00'      ALL FUNCTIONS COMPLETED?             DMT10260
         BNE   ALLHLD         NO..CONTINUE                     @VA03276 DMT10270
         CLC   $OUTBUF(4),=F'0' ALL BUFFERS SENT               @VA03276 DMT10280
         BE    SIGNOFF             Go send signoff record      SML2NJE4 DMT10290
ALLHLD   EQU   *                                                        DMT10300
         TM    RDRCMD,RHLDIPGS     IS A HOLD PENDING?                   DMT10310
         BNO   ALLCHK              NO CONTINUE                          DMT10320
         CLI   MASTERSW,X'00'      NOTHING ACTIVE?                      DMT10330
         BNE   ALLCHK              YES..ACTIVE PROCESSOR                DMT10340
         CLC   $OUTBUF(4),=F'0' ALL BUFFERS SENT?              @VA03276 DMT10350
         BNE   ALLCHK         NO..CONTINUE ON                  @VA03276 DMT10360
         OI    LFLAG,LHOLD         INDICATE WE ARE HELD                 DMT10370
         DROP  R6                  Finished with link table    SML2NJE3 DMT10380
         MVC   MSGLINK(8),HLDCMDLK SET RESPONSE LINKID                  DMT10390
         MSGX  611,AXSLINK         WRITE HELD MSG                       DMT10400
         NI    RDRCMD,255-RHLDIPGS TURN OFF COMMAND                     DMT10410
ALLCHK   EQU   *                                                        DMT10420
         CLC   $START($COMEND-$START),$ALLOFF ARE ALL BRANCHES NO-OPD   DMT10430
         BNE   $START              IF NO GO AROUND AGAIN                DMT10440
         L     R15,WAITREQ         SYSTEM WAIT PROCESSOR                DMT10450
         LA    R1,ECBLIST          GET ECBLIST ADDR                     DMT10460
         BALR  R14,R15             GO WAIT FOR POSTING                  DMT10470
         B     CMDECK              GO FIND WHO WOKE US UP               DMT10480
         DROP  R8                                                       DMT10490
         EJECT                                                          DMT10500
         SPACE 1                                                        DMT10510
$ALLOFF  NOP   $CONTROL            DUMMY COMMUTATOR                     DMT10520
         NOP   $TPGET              TO COMPARE FOR ALL NO-OPS            DMT10530
         NOP   $PCOM1              -                                    DMT10540
         NOP   $RCOM1              -                                    DMT10550
         NOP   $JCOM1              -                                    DMT10560
         NOP   $WCOM1              -                                    DMT10570
         NOP   CMDPROC             -                                    DMT10580
         NOP   MSGPROC             -                                    DMT10590
         NOP   $COMSUP             -                                    DMT10600
         NOP   $INTRUPT            -                                    DMT10610
         SPACE 1                   -                                    DMT10620
GOLOGIT  EQU   *                                                        DMT10630
         STM   R14,R1,KRSAV        SAVE REGISTERS                       DMT10640
         L     R14,CBUFFER         GET LAST TP BUFFER ADDR              DMT10650
         LA    R14,7(R14)          START OF DATA                        DMT10660
         LA    R1,R                INDICATE READ                        DMT10670
         BAL   R15,KLOGIT          GO LOG IT                            DMT10680
         LM    R14,R1,KRSAV        RESTORE REGISTERS                    DMT10690
         B     LOGITBK             AND CONTINUE                         DMT10700
         SPACE 3                                                        DMT10710
OPEN     EQU   X'F0'               GATE OPEN                            DMT10720
CLOSE    EQU   X'00'               GATE CLOSED                          DMT10730
         EJECT                                                          DMT10740
*.                                                                      DMT10750
*                                                                       DMT10760
* ENTRY NAME -                                                          DMT10770
*                                                                       DMT10780
*        $CRTN1                                                         DMT10790
*                                                                       DMT10800
* FUNCTION -                                                            DMT10810
*                                                                       DMT10820
*        THIS ROUTINE DEQUEUES TANKS FROM ITS TANK QUEUE AND            DMT10830
*        PERFORMS THE ACTION REQUESTED IN BY THE CONTROL RECORD         DMT10840
*        IN THE DEQUEUED TANK.                                          DMT10850
*                                                                       DMT10860
* CALLS TO OTHER ROUTINES -                                             DMT10870
*                                                                       DMT10880
*        NONE                                                           DMT10890
*                                                                       DMT10900
* OPERATION -                                                           DMT10910
*                                                                       DMT10920
*        1. TRY TO GET ANOTHER CONTROL TANK.                            DMT10930
*                                                                       DMT10940
*        2. IF ONE IS OBTAINED, EXAMINE THE SRCB TO DETERMINE ITS TYPE. DMT10950
*                                                                       DMT10960
*        3. BRANCH TO THE APPROPRIATE ROUTINE TO PROCESS                DMT10970
*           EACH TYPE OF CONTROL RECORD.                                DMT10980
*                                                                       DMT10990
*        4. FREE THE TANK AND EXIT THROUGH THE COMMUTATOR.              DMT11000
*                                                                       DMT11010
* RESPONSES -                                                           DMT11020
*                                                                       DMT11030
*        NONE                                                           DMT11040
*                                                                       DMT11050
* ERROR MESSAGES -                                                      DMT11060
*                                                                       DMT11070
*        DMTXJE902E  NON-SIGNON CARD READ ON LINK (LINKID)     HRC000DT DMT11080
*        DMTXJE903E  PASSWORD=(PASSWORD) ON LINK (LINKID) IS INVALID    DMT11090
*                                                                       DMT11100
*.                                                                      DMT11110
         EJECT                                                          DMT11120
*                                                                       DMT11130
*                                                                       DMT11140
$CRTN1   DS    0H                                                       DMT11150
*                                                                       DMT11160
$CONTROL DS    0H                  ENTRY POINT                          DMT11170
         LA    R13,$CTLTCT         GET CONTROL TCT                      DMT11180
         USING TCTDSECT,R13        *                                    DMT11190
         SPACE 1                                                        DMT11200
         CLC   TCTTANK,=F'0'       ARE WE EMPTY                         DMT11210
         BE    MNONE               YES                                  DMT11220
         L     R8,TCTTANK          GET FIRST BUFFER ADDRESS             DMT11230
         MVC   TCTTANK(4),0(R8)    REMOVE THIS ONE FROM CHAIN           DMT11240
         B     MPROCESS            BR IF GOTTEN                         DMT11250
         SPACE 1                                                        DMT11260
MNONE    EQU   *                                                        DMT11270
         MVI   $CCOMM1+1,CLOSE     NONE... CLOSE ENTRY                  DMT11280
         B     CCTRTN              AND EXIT                             DMT11290
         EJECT                                                          DMT11300
*---------------------------------------------------------------------* DMT11310
*                                                                     * DMT11320
*              PROCESS A CONTROL RECORD                               * DMT11330
*                                                                     * DMT11340
*---------------------------------------------------------------------* DMT11350
         SPACE 3                                                        DMT11360
MPROCESS DS    0H                  *                                    DMT11370
         LH    R5,TCTTNKLM         REDUCES COUNT IN TNKCT               DMT11380
         BCTR  R5,0                DOWN BY ONE                          DMT11390
         STH   R5,TCTTNKLM         AND REPLACE COUNT                    DMT11400
         OI    TCTSTAT,TCTACT      SIGNAL WE HAVE RECEIVED TANK         DMT11410
         MVI   $TPGETCM+1,OPEN     OPEN THE GATE TO TPGET ROUTINE       DMT11420
         DROP  R13                 DONE FOR NOW                         DMT11430
         USING TANKDSEC,R8         *                                    DMT11440
         IC    R6,TANKRCB          Get RCB                     HRC001DT DMT11450
         N     R6,=X'00000070'     Select relevant bits        HRC001DT DMT11460
         SRL   R6,4-2              Move to bottom, * by 4      HRC001DT DMT11470
         L     R6,MCONTTAB(R6)     Get routine address in tableHRC001DT DMT11480
         BR    R6                  ENTER ROUTINE                        DMT11490
         EJECT                                                          DMT11500
*---------------------------------------------------------------------* DMT11510
*                                                                     * DMT11520
*              SUBROUTINE TO FIND TCT CORRESPONDING TO SRCB FUNCTION  * DMT11530
*                R14=RETURN , CC NE 0 -R13 CONTAINS TCT,CC=0-NOT FOUND* DMT11540
*---------------------------------------------------------------------* DMT11550
         SPACE 3                                                        DMT11560
MTCTFIND DS    0H                  ENTRY POINT                          DMT11570
         LA    R13,$TCT1           FIRST TCT                            DMT11580
         USING TCTDSECT,R13        ADDRESSABILITY                       DMT11590
MNEXTTCT DS    0H                  *                                    DMT11600
         CLC   TCTRCBR,TANKSRCB    IS THIS CORRECT TCT                  DMT11610
         BE    MTCTOK              BR IF YES                            DMT11620
         ICM   R13,B'1111',TCTNEXT NO..TO NEXT AND CHECK FOR LAST       DMT11630
         BNZ   MNEXTTCT            BR IF MORE                           DMT11640
         BR    R14                 RETURN WITH COND. CODE = 0           DMT11650
         SPACE 1                                                        DMT11660
MTCTFNDT DS    0H                  ENTRY POINT                          DMT11670
         LA    R13,$TCT1           FIRST TCT                            DMT11680
         USING TCTDSECT,R13        ADDRESSABILITY                       DMT11690
MNXTTCTT DS    0H                  *                                    DMT11700
         CLC   TCTRCBT,TANKSRCB    IS THIS CORRECT TCT                  DMT11710
         BE    MTCTOK              BR IF YES                            DMT11720
         ICM   R13,B'1111',TCTNEXT NO..TO NEXT AND CHECK FOR LAST       DMT11730
         BNZ   MNXTTCTT            BR IF MORE                           DMT11740
         BR    R14                 RETURN WITH COND. CODE = 0           DMT11750
         SPACE 1                                                        DMT11760
MTCTOK   EQU   *                                                        DMT11770
         LTR   R14,R14             SET COND. CODE NON-ZERO              DMT11780
         BR    R14                 AND RETURN                           DMT11790
         EJECT                                                          DMT11800
         SPACE 5                                                        DMT11810
*---------------------------------------------------------------------* DMT11820
*                                                                     * DMT11830
*              SUBROUTINE TO $TPPUT AN ANSWERING CTL RECORD           * DMT11840
*                   R8 = TANKADDR                                     * DMT11850
*                                                                     * DMT11860
*---------------------------------------------------------------------* DMT11870
         SPACE 3                                                        DMT11880
MPUT     DS    0H                  ENTRY POINT                          DMT11890
         BAL   R14,$TPPUT          GO PUT RECORD                        DMT11900
         BNZ   MEXIT               EXIT IF ACCEPTED                     DMT11910
         MVC   $CCOMM1+2(2),MREPUTA SET COMUTATOR RE-ENTRY              DMT11920
         ST    R8,MTANK            SAVE TANK ADDR                       DMT11930
         B     CCTRTN              EXIT TO COMUTATOR                    DMT11940
         SPACE 1                                                        DMT11950
MREPUT   DS    0H                  RETRY PUTTING RECORD                 DMT11960
         L     R8,MTANK            RESTORE TANK ADDR                    DMT11970
         BAL   R14,$TPREPUT        TRY IT                               DMT11980
         BZ    $CCOMM1+4           CYCLE IF STILL NOT ACCEPTED          DMT11990
         SPACE 1                                                        DMT12000
MEXIT    DS    0H                  ENTRY AT END OF PROCESSING           DMT12010
         MVC   0(4,R8),$TANKPOL    GET FIRST FREE OFF QUEUE             DMT12020
         ST    R8,$TANKPOL         MAKE THIS ONE THE FIRST              DMT12030
         MVI   $TPGETCM+1,OPEN     OPEN TPGET GATE                      DMT12040
         MVC   $CCOMM1+2(2),MCONTROL RESET COMUTATOR                    DMT12050
         B     $CONTROL            AND TRY NEXT TANK                    DMT12060
MREPUTA  DC    S(MREPUT)           COMMUTATOR ADJUSTMENT ADDR           DMT12070
MCONTROL DC    S($CONTROL)         COMMUTATOR ADJUSTMENT ADDR           DMT12080
MCONTTAB DS    0F                  CONTROL TYPE BRANCH TABLE            DMT12090
         DC    A(MC0)              000  Reserved               SML2NJE4 DMT12100
         DC    A(MC1)              001  START FUNCTION REQUEST          DMT12110
         DC    A(MC2)              010  START FUNCTION PERMISSION       DMT12120
         DC    A(MC3)              011  RESERVED                        DMT12130
         DC    A(MC4)              100  RESERVED                        DMT12140
         DC    A(MC5)              101  RESERVED                        DMT12150
         DC    A(MC6)              110  RESERVED                        DMT12160
         DC    A(MC7)              111  GENERAL CONTROL TYPE            DMT12170
         EJECT                                                          DMT12180
         SPACE 3                                                        DMT12190
*                                                                       DMT12200
* MC0          CONTROL RECORD , TYPE = 000 (RESERVED)                   DMT12210
*                                                                       DMT12220
         SPACE 3                                                        DMT12230
*                                                                       DMT12240
*              RESERVED FOR FUTURE USE                                  DMT12250
*                                                                       DMT12260
MC0      EQU   MEXIT               TO DEFINE SYMBOL                     DMT12270
         SPACE 3                                                        DMT12280
*                                                                       DMT12290
* MC1          CONTROL RECORD , TYPE = 001(REQUEST TO START FUNCTION)   DMT12300
*                                                                       DMT12310
         SPACE 3                                                        DMT12320
MC1      DS    0H                  *                                    DMT12330
*                                                                       DMT12340
         BAL   R14,MTCTFIND        GO FIND TCT                          DMT12350
         BZ    MEXIT               IGNORE REQUEST IF NOT FOUND          DMT12360
         TM    XJESYS,SGNONREC     Has link signed on?         HRC000DT DMT12370
         BNO   MEXIT               NO...NOTHING TILL THEN               DMT12380
         SPACE 1                                                        DMT12390
MTCTSET  DS    0H                  CORRECT TCT FOUND                    DMT12400
         TM    TCTSTAT,TCTOPEN     CAN DEVICE BE STARTED                DMT12410
         NI    TCTSTAT,255-TCTOPEN SHOW USE                             DMT12420
         OC    $FCSOUT,TCTFCS      ALLOW BUFFERS                        DMT12430
*        Initialise variables to process expected incoming job SML2NJE4 DMT12440
*        This both to avoid revealing leftovers from previous  SML2NJE4 DMT12450
*        files and also to avoid ending up with random garbage SML2NJE4 DMT12460
*        if relevant fields are not supplied in NJE headers.   SML2NJE4 DMT12470
         MVI   PNSEGTYP,X'C0'      Expect job header next      SML2NJE4 DMT12480
         MVI   PNSEGNUM,0          Expect segment zero next    SML2NJE4 DMT12490
         MVC   PNJEBPTR,APNJEHDR   Point to start of NJE bufferSML2NJE4 DMT12500
         L     R3,APDEVTAG         Get address of SYSOUT tag   SML2NJE4 DMT12510
         LA    R0,XJE3JEHD         Code for routine DEFNJEHD      *XJE  DMT12520
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT12530
         BALR  R14,R15             Fill in default NJE headers SML2NJE4 DMT12540
         USING TAG,R3                                          SML2NJE4 DMT12550
         MVC   PNRECLEN,TAGRECLN   Assume punch record length  SML2NJE4 DMT12560
         DROP  R3                  Finished with TAG for now   SML2NJE4 DMT12570
         MVI   TANKRCB,X'A0'       Change request to permissionHRC001DT DMT12580
         B     MPUT                AND SEND IT                          DMT12590
         SPACE 3                                                        DMT12600
*                                                                       DMT12610
* MC2          CONTROL RECORD , TYPE = 010(PERMISSION TO START FCN)     DMT12620
*                                                                       DMT12630
         SPACE 3                                                        DMT12640
MC2      DS    0H                  ENTRY POINT                          DMT12650
         BAL   R14,MTCTFNDT        GO LOOK-UP TCT                       DMT12660
         BZ    MEXIT               IGNORE IF NOT FOUND                  DMT12670
         L     R14,TCTCOM          GET COMUTATOR ENTRY                  DMT12680
         MVI   1(R14),OPEN         OPEN IT                              DMT12690
         NI    TCTSTAT,255-TCTOPEN SHOW OPEN                            DMT12700
         B     MEXIT               AND EXIT                             DMT12710
         EJECT                                                          DMT12720
*                                                                       DMT12730
* MC3          CONTROL RECORD , TYPE = 011 (RESERVED)                   DMT12740
         SPACE 3                                                        DMT12750
MC3      EQU   MEXIT               NOT YET DEFINED                      DMT12760
         SPACE 3                                                        DMT12770
*                                                                       DMT12780
* MC4          Control record , typ = 100 (ACK file received)  SML2NJE4 DMT12790
*                                                              SML2NJE4 DMT12800
MC4      DS    0H                  Entry point                 SML2NJE4 DMT12810
         BAL   R14,MTCTFNDT        Go look up TCT              SML2NJE4 DMT12820
         BZ    MEXIT               Ignore if not found         SML2NJE4 DMT12830
         TM    RSW1,RWAITACK       Are we waiting for an ACK?  SML2NJE4 DMT12840
         BZ    MEXIT               No. Ignore it.              SML2NJE4 DMT12850
         NI    RSW1,255-RWAITACK   Reset waiting for ACK flag  SML2NJE4 DMT12860
         OI    $RCOMM1+1,OPEN      Open RDR commutator gate    SML2NJE4 DMT12870
         B     MEXIT               And exit                    SML2NJE4 DMT12880
         SPACE 3                                                        DMT12890
*                                                                       DMT12900
* MC5          CONTROL RECORD , TYPE = 101 (RESERVED)                   DMT12910
*                                                                       DMT12920
         SPACE 3                                                        DMT12930
MC5      EQU   MEXIT               TO DEFINE SYMBOL                     DMT12940
*                                  FUNCTION IS NOT YET SUPPORTED        DMT12950
         SPACE 3                                                        DMT12960
*                                                                       DMT12970
* MC6          CONTROL RECORD , TYPE = 110(RESERVED)                    DMT12980
*                                                                       DMT12990
         SPACE 3                                                        DMT13000
*                                                                       DMT13010
*              THIS CONTROL TYPE IS CURRENTLY UNDEFINED BUT IS          DMT13020
*              RESERVED FOR FUTURE USE.                                 DMT13030
*                                                                       DMT13040
MC6      EQU   MEXIT               TO DEFINE SYMBOL                     DMT13050
         EJECT                                                          DMT13060
*                                                                       DMT13070
* MC7          CONTROL RECORD , TYPE = 111 (GENERALIZED CONTROL)        DMT13080
*                                          (TYPE INDICATED IN SRCB)     DMT13090
*                                                                       DMT13100
         SPACE 3                                                        DMT13110
MC7      EQU   *                   ENTRY POINT                          DMT13120
         CLI   TANKSRCB,C'I'       Initial signon record?      SML2NJE4 DMT13130
         BE    MC7INIT                                         SML2NJE4 DMT13140
         CLI   TANKSRCB,C'J'       Response signon record?     SML2NJE4 DMT13150
         BNE   MEXIT               No. Ignore it.              SML2NJE4 DMT13160
         SPACE 1                                               SML2NJE4 DMT13170
MC7RESP  EQU   *                                               SML2NJE4 DMT13180
         TM    XJESYS,SECONDRY     Is remote end secondary?    SML2NJE4 DMT13190
         BNO   MC7ERR1             Response must be from sec   SML2NJE4 DMT13200
         BAL   R14,MC7VER          Verify signon parameters    SML2NJE4 DMT13210
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT13220
         ICM   R1,B'0011',TANKDATA+16 Get secondarys buf size  SML2NJE4 DMT13230
         CL    R1,TPBUFSIZ         Compare with our buffr size SML2NJE4 DMT13240
         BNL   MC7SGNON            Not smaller - do nothing    SML2NJE4 DMT13250
         ST    R1,TPBUFSIZ         Smaller - use theirs        SML2NJE4 DMT13260
         STH   R1,CCWC+6           Also store in read CCW      SML2NJE4 DMT13270
         STH   R1,RDCOUNT          And in read count           SML2NJE4 DMT13280
MC7SGNON EQU   *                                               SML2NJE4 DMT13290
         L     R1,TPBUFSIZ         Get negotiated buffer size  SML2NJE4 DMT13300
         USING LINKTABL,R6         Link table addressability   HRC031DT DMT13310
         L     R6,XJELINK          Get linktable address for.. HRC031DT DMT13320
         STH   R1,LNEGO            Set negotiated buffer size     *XJE
         NI    LFLAG,255-LACTIVE   Link no longer active          *XJE  DMT13330
         OI    LFLAG,LCONNECT      Mark link as connected      HRC031DT DMT13330
         DROP  R6                  Finished with link table    HRC031DT DMT13340
         CVD   R1,AXSCVD           Convert buffer size to BCD  SML2NJE4 DMT13350
         MVC   AXSRECS,=X'0020202020202020' Specify edit word  SML2NJE4 DMT13360
         ED    AXSRECS,AXSCVD+4    Convert to character        SML2NJE4 DMT13370
         LM    R2,R3,AXSRECS       Load result into double reg SML2NJE4 DMT13380
MC7BUFLP EQU   *                                               SML2NJE4 DMT13390
         SLDA  R2,8                Shift out one character     SML2NJE4 DMT13400
         BNO   MC7BUFLP            Stop when we hit a digit    SML2NJE4 DMT13410
         STM   R2,R3,AXSRECS       Store left justified result SML2NJE4 DMT13420
         OI    AXSRECS,X'80'       Restore lost sign bit       SML2NJE4 DMT13430
         MSGX  905,(AXSLINK,AXSRECS) Indicate signon complete  SML2NJE4 DMT13440
         OI    XJESYS,SGNONREC     Indicate signon accepted    SML2NJE4 DMT13450
         OI    $RCOMM1+1,OPEN      Open RDR commutator gate    SML2NJE4 DMT13460
         B     MEXIT               Return and free TP buffer   SML2NJE4 DMT13470
         SPACE 1                                               SML2NJE4 DMT13480
MC7INIT  EQU   *                                               SML2NJE4 DMT13490
         TM    XJESYS,PRIMARY      Is the remote end primary?  SML2NJE4 DMT13500
         BNO   MC7ERR1             Init signon not from primarySML2NJE4 DMT13510
         BAL   R14,MC7VER          Verify signon parameters    SML2NJE4 DMT13520
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT13530
         ICM   R1,B'0011',TANKDATA+16 Get primarys buffer size SML2NJE4 DMT13540
         CL    R1,TPBUFSIZ         Compare with our buffr size SML2NJE4 DMT13550
         BNL   MC7I1               Not smaller - leave alone   SML2NJE4 DMT13560
         ST    R1,TPBUFSIZ         Smaller - use theirs        SML2NJE4 DMT13570
         STH   R1,CCWC+6           Also store in read CCW      SML2NJE4 DMT13580
         STH   R1,RDCOUNT          And in read count           SML2NJE4 DMT13590
         STH   R1,NCCIBFSZ         And in signon resp record   SML2NJE4 DMT13600
MC7I1    EQU   *                                               SML2NJE4 DMT13610
* Set response signon fields that differ from initial signon   SML2NJE4 DMT13620
SIGNONJ  EQU   *                                                  *XJE
         MVI   NCCSRCB,C'J'        Signon response record      SML2NJE4 DMT13630
         MVC   NCCIEVNT,=X'FFFFFFFF' Connection event sequence SML2NJE4 DMT13640
* Now send the response signon record. I copied this from the  SML2NJE4 DMT13650
* code that sends the initial signon record. I don't really    SML2NJE4 DMT13660
* follow what is supposed to happen if there are no TP buffers SML2NJE4 DMT13670
* available ...                                                SML2NJE4 DMT13680
         SPACE 1                                               SML2NJE4 DMT13690
         USING BUFDSECT,R13        *                           SML2NJE4 DMT13700
         CLC   $BUFPOOL,=F'0'      Is free TPbuff queue empty? SML2NJE4 DMT13710
         BE    JBUF1               Yes                         SML2NJE4 DMT13720
         L     R13,$BUFPOOL        Get first buffer address    SML2NJE4 DMT13730
         MVC   $BUFPOOL(4),0(R13)  Make second buffer first    SML2NJE4 DMT13740
JBUF1    EQU   *                                               SML2NJE4 DMT13750
         MVC   BUFCOUNT(ICTLE-ICTLS),ICTLS Setup control reply SML2NJE4 DMT13760
         LA    R6,$OUTBUF          Get start of outgoing queue    *XJE  DMT13770
JBUF2    EQU   *                                               SML2NJE4 DMT13780
         CLC   0(4,R6),=F'0'       Is it the last in chain?    SML2NJE4 DMT13790
         BE    JBUF3               Yes.  Add ours on here.     SML2NJE4 DMT13800
         L     R6,0(0,R6)          Get the next buffer         SML2NJE4 DMT13810
         B     JBUF2               Try again                   SML2NJE4 DMT13820
         SPACE 1                                               SML2NJE4 DMT13830
JBUF3    EQU   *                                               SML2NJE4 DMT13840
         ST    R13,0(0,R6)         Chain our buffer to it      SML2NJE4 DMT13850
         MVC   0(4,R13),=F'0'      Mark it as last buffer      SML2NJE4 DMT13860
*                                                              SML2NJE4 DMT13870
         B     MC7SGNON            Go complete signon          SML2NJE4 DMT13880
         SPACE 1                                               SML2NJE4 DMT13890
*                                                              SML2NJE4 DMT13900
*        Verify initial/response signon parameters are correct SML2NJE4 DMT13910
*                                                              SML2NJE4 DMT13920
MC7VER   EQU   *                                               SML2NJE4 DMT13930
         CLC   TANKDATA+NCCINODE-NCCIDL(8),AXSLINK Right link? SML2NJE4 DMT13940
         BNE   MC7ERR1             Wrong link                  SML2NJE4 DMT13950
         CLI   PASSWORD,C' '       Was a password specified?   SML2NJE4 DMT13960
         BE    MC7VRET             No. No need to check it so. SML2NJE4 DMT13970
         CLC   TANKDATA+NCCILPAS-NCCIDL(8),PASSWORD Line pw    SML2NJE4 DMT13980
         BNE   MC7ERR2             Incorrect password          SML2NJE4 DMT13990
MC7VRET  BR    R14                                             SML2NJE4 DMT14000
         SPACE 1                                               SML2NJE4 DMT14010
MC7ERR1  MSGX  902,AXSLINK         Not ideal - will do for now SML2NJE4 DMT14020
         B     EOJ                                             SML2NJE4 DMT14030
         SPACE 1                                               SML2NJE4 DMT14040
MC7ERR2  MSGX  903,AXSLINK         Password invalid            SML2NJE4 DMT14050
         B     EOJ                                             SML2NJE4 DMT14060
         SPACE 1                                               SML2NJE4 DMT14070
*                                                                       DMT14080
*              CURRENTLY NO OTHER FUNCTIONS ARE IMPLEMENTED FOR THIS    DMT14090
*              CONTROL FUNCTION. THE TYPE OF CONTROL RECORD, SUCH       DMT14100
*              AS ACCOUNTING,SIGN-ON,INITIALIZATION,ETC, IS             DMT14110
*              INDICATED IN THE SRCB.                                   DMT14120
*              THE SRCB IDENTIFICATION CHARACTERS 'A' THRU 'R'          DMT14130
*              AND '0' THRU '9' ARE RESERVED FOR FUTURE RSCS            DMT14140
*              DEVELOPMENT. ALL OTHER EBCDIC CHARACTERS , WHICH         DMT14150
*              ARE TRANSMISSION COMPATIBLE ARE AVAILABLE TO THE         DMT14160
*              USER TO ADD ADDITIONAL CONTROL FUNCTIONS.                DMT14170
*                                                                       DMT14180
         SPACE 3                                                        DMT14190
         DROP  R8,R13                                                   DMT14200
         EJECT                                                          DMT14210
*.                                                                      DMT14220
*                                                                       DMT14230
* ENTRY NAME -                                                          DMT14240
*                                                                       DMT14250
*        $PRTN1                                                         DMT14260
*                                                                       DMT14270
* FUNCTION -                                                            DMT14280
*                                                                       DMT14290
*        THIS ROUTINE DEQUEUES TANKS FROM ITS TANK QUEUE, OBTAINS       DMT14300
*        A NEW OUTPUT SPOOL DEVICE IF NEEDED FROM DMTAXS, AND           DMT14310
*        OUTPUTS THE TANK TO A VIRTUAL PRINTER OR PUNCH.       SML2NJE4 DMT14320
*                                                                       DMT14330
* CALLS TO OTHER ROUTINES -                                             DMT14340
*                                                                       DMT14350
*        DMTIOMRQ - TO INITIATE AN I/O OPERATION                        DMT14360
*                                                                       DMT14370
* OPERATION -                                                           DMT14380
*                                                                       DMT14390
*        1. OBTAIN A TANK FROM $GETTNK                                  DMT14400
*                                                                       DMT14410
*        2. IF OBTAINED CHECK TO SEE IF OUTPUT FILE IS OPENED,          DMT14420
*           IF NOT OBTAIN A OUTPUT DEVICE BY A CALL TO AXS.             DMT14430
*                                                                       DMT14440
*        3. CONTRUCT THE CARRIAGE CONTROL FROM THE INFORMATION          DMT14450
*           CONTAINED IN THE SRCB.                                      DMT14460
*                                                                       DMT14470
*        4. WRITE THE RECORD TO THE VM/370 SPOOL FILE SYSTEM.           DMT14480
*                                                                       DMT14490
*        5. WHEN EOF IS OBTAINED CLOSE THE FILE VIA ANOTHER CALL        DMT14500
*           TO AXS.                                                     DMT14510
*                                                                       DMT14520
*        6. EXIT TO COMMUTATOR                                          DMT14530
*                                                                       DMT14540
* RESPONSES -                                                           DMT14550
*                                                                       DMT14560
*        DMTXJE144I  RECEIVING: FILE FROM 'LOCID1' ('USERID1') HRC000DT DMT14570
*                    FOR 'LOCID2' ('USERID2')                  HRC000DT DMT14580
*        DMTXJE145I  RECEIVED: FILE FROM 'LOCID1' ('USERID1')  HRC000DT DMT14590
*                    FOR 'LOCID2' ('USERID2')                  HRC000DT DMT14600
*                                                                       DMT14610
* ERROR MESSAGES -                                                      DMT14620
*                                                                       DMT14630
*        NONE                                                           DMT14640
*                                                                       DMT14650
*.                                                                      DMT14660
         SPACE 1                                                        DMT14670
         USING TANKDSEC,R8         GET TANK ADDRESSABILITY              DMT14680
$PRTN1   DS    0H                                                       DMT14690
PNEXT    EQU   *                   BASIC LOOP                           DMT14700
         BAL   R14,$GETTNK         WAIT FOR THE NEXT TANK               DMT14710
         TM    XJESYS,SGNONREC     Is link signed on?          SML2NJE4 DMT14720
         BZ    PFREE               No. Ignore until signed on. SML2NJE4 DMT14730
         TM    PSW1,DISCARD        Is job being discarded?     SML2NJE4 DMT14740
         BO    PNDISCRD            Discard tanks until job end SML2NJE4 DMT14750
         L     R3,APDEVTAG         Get address of RSCS "TAG"   SML2NJE4 DMT14760
         LA    R0,1                Error code                  SML2NJE4 DMT14770
         TM    TANKSRCB,B'10000000' Is SRCB plausable looking? SML2NJE4 DMT14780
         BZ    MSG939              Declare protocol error      SML2NJE4 DMT14790
         TM    TANKSRCB,B'01000011' Is this a data record?     SML2NJE4 DMT14800
         BZ    PDATAREC            Looks like a data record    SML2NJE4 DMT14810
         CLC   TANKSRCB,PNSEGTYP   Is this the expected header SML2NJE4 DMT14820
         BE    PNEXPECT            This is the expected header SML2NJE4 DMT14830
         LA    R0,2                Error code                  SML2NJE4 DMT14840
         CLI   TANKSRCB,X'D0'      Is it a trailer record...   SML2NJE4 DMT14850
         BNE   MSG939              (Not a trailer record)      SML2NJE4 DMT14860
         LA    R0,3                Error code                  SML2NJE4 DMT14870
         CLI   PNSEGTYP,X'02'      ... after some data?        SML2NJE4 DMT14880
         BNE   MSG939              Trailer not expected here   SML2NJE4 DMT14890
PNEXPECT EQU   *                                               SML2NJE4 DMT14900
         LA    R0,4                Error code                  SML2NJE4 DMT14910
         CLC   TANKCNT,=H'4'       Can tank contain a segment? SML2NJE4 DMT14920
         BNH   MSG939              Declare protocol error      SML2NJE4 DMT14930
         IC    R1,TANKDATA+NJEPSEQ-NJEPDSEC Get segment number SML2NJE4 DMT14940
         N     R1,=X'0000007F'     Select segment number only  SML2NJE4 DMT14950
         XR    R2,R2               Clear R2 for IC             SML2NJE4 DMT14960
         IC    R2,PNSEGNUM         Get expected segment number SML2NJE4 DMT14970
         LA    R0,5                Error code                  SML2NJE4 DMT14980
         CR    R1,R2               Is this the right segment?  SML2NJE4 DMT14990
         BNE   MSG939              Declare protocol error      SML2NJE4 DMT15000
         LA    R2,1(,R2)           Increment segment number    SML2NJE4 DMT15010
         STC   R2,PNSEGNUM         Expect this segment next    SML2NJE4 DMT15020
         ICM   R1,B'0011',TANKDATA+NJEPLEN-NJEPDSEC Segment ln SML2NJE4 DMT15030
         LA    R0,6                Error code                  SML2NJE4 DMT15040
         CH    R1,TANKCNT          Segment len == tank count?  SML2NJE4 DMT15050
         BNE   MSG939              Declare protocol error      SML2NJE4 DMT15060
         SH    R1,=AL2(NJEPSIZE)   Reduce by seg. prefix len.  SML2NJE4 DMT15070
         L     R2,PNJEBPTR         Get buffer pointer          SML2NJE4 DMT15080
         LR    R0,R2               Make temporary copy         SML2NJE4 DMT15090
         AR    R0,R1               Add length of segment       SML2NJE4 DMT15100
         CL    R0,APNJEHND         Compare to end of buffer    SML2NJE4 DMT15110
         BNL   MSG938              Segment won't fit in buffer SML2NJE4 DMT15120
         BCTR  R1,0                Reduce by one for EX        SML2NJE4 DMT15130
         EX    R1,COPYSEGM         Copy segment to NJEH buffer SML2NJE4 DMT15140
         LA    R2,1(R1,R2)         +1. Update buffer pointer.  SML2NJE4 DMT15150
         ST    R2,PNJEBPTR         Save buffer pointer         SML2NJE4 DMT15160
         TM    TANKDATA+NJEPSEQ-NJEPDSEC,X'80' Last segment?   SML2NJE4 DMT15170
         BO    PFREE               Not last.  Get next segment SML2NJE4 DMT15180
*                                                              SML2NJE4 DMT15190
         MVI   PNSEGNUM,X'00'      Expect segment zero next    SML2NJE4 DMT15200
         LA    R4,NJEPSIZE(,R2)    Leave room for segment hdr  SML2NJE4 DMT15210
         ST    R4,PNJEBPTR         Save buffer ptr for nxt hdr SML2NJE4 DMT15220
         USING TAG,R3              Use R3 to address RSCS tag  SML2NJE4 DMT15230
*                                                              SML2NJE4 DMT15240
         CLI   TANKSRCB,X'C0'      Is this a job header?       SML2NJE4 DMT15250
         BNE   PNOTJHDR            Not a job header            SML2NJE4 DMT15260
*                                                              SML2NJE4 DMT15270
         MVI   PNSEGTYP,X'E0'      Expect dataset header next  SML2NJE4 DMT15280
         ST    R4,APNJEDTA         Save address of data set hdrSML2NJE4 DMT15290
         L     R4,APNJEHDR         Get addr. of job hdr prefix SML2NJE4 DMT15300
         USING NJEPDSEC,R4         Use R4 for NJEP* locations  SML2NJE4 DMT15310
         SR    R2,R4               Get length of job header    SML2NJE4 DMT15320
         STH   R2,NJEPLEN          Save job hdr len in prefix  SML2NJE4 DMT15330
         DROP  R4                  Finished with seg. prefix   SML2NJE4 DMT15340
         LA    R4,NJEPSIZE(,R4)    Get address of 1st section  SML2NJE4 DMT15350
         USING NJHGDSEC,R4         Assume general section      SML2NJE4 DMT15360
PHLOOP   EQU   *                                               SML2NJE4 DMT15370
         LTR   R2,R2               Reached end of job header?  SML2NJE4 DMT15380
         BE    PFREE               Finished with job header    SML2NJE4 DMT15390
         LA    R0,7                Error code                  SML2NJE4 DMT15400
         CH    R2,=H'4'            Ensure 4 bytes or more left SML2NJE4 DMT15410
         BNH   MSG939              Declare protocol error      SML2NJE4 DMT15420
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT15430
         ICM   R1,B'0011',NJHGLEN  Get section length          SML2NJE4 DMT15440
         LA    R0,8                Error code                  SML2NJE4 DMT15450
         CH    R1,=H'4'            Minimum section length is 5 SML2NJE4 DMT15460
         BNH   MSG939              Declare protocol error      SML2NJE4 DMT15470
         LA    R0,9                Error code                  SML2NJE4 DMT15480
         SR    R2,R1               Subtract from header len    SML2NJE4 DMT15490
         BM    MSG939              Gone past end of job header SML2NJE4 DMT15500
         XR    R0,R0               Clear R0 for ICM            SML2NJE4 DMT15510
         ICM   R0,B'0011',NJHGTYPE Get section type & modifier SML2NJE4 DMT15520
         BNZ   PHNOTGEN            Not the hdr general section SML2NJE4 DMT15530
         CH    R1,=AL2(NJHGFORM-NJHGDSEC) Is header too short? SML2NJE4 DMT15540
         BL    PHGENFIN            Not much use - skip it.     SML2NJE4 DMT15550
*        Copy any relevant details present in general section  SML2NJE4 DMT15560
         MVC   TAGID,NJHGJID       Job id / spool file number  SML2NJE4 DMT15570
         MVC   TAGINTOD,NJHGETS    Get file date / time        SML2NJE4 DMT15580
         MVC   TAGINLOC,NJHGORGN   Get origin node             SML2NJE4 DMT15590
         MVC   TAGINVM,NJHGORGR    Get origin userid           SML2NJE4 DMT15600
         MVC   TAGTOLOC,NJHGPUNN   Get PUN destination node    SML2NJE4 DMT15610
         MVC   PCTTOVM,NJHGPUNR    Get PUN destination userid  SML2NJE4 DMT15620
         DROP  R4                  Finished with general sect. SML2NJE4 DMT15630
PHGENFIN EQU   *                                               SML2NJE4 DMT15640
PHNOTGEN EQU   *                                               SML2NJE4 DMT15650
         AR    R4,R1               Move on to next hdr section SML2NJE4 DMT15660
         B     PHLOOP              Go around again             SML2NJE4 DMT15670
*                                                              SML2NJE4 DMT15680
PNOTJHDR EQU   *                                               SML2NJE4 DMT15690
         CLI   TANKSRCB,X'E0'      Is this a dataset header?   SML2NJE4 DMT15700
         BNE   PNOTDHDR            Not a dataset header        SML2NJE4 DMT15710
*                                                              SML2NJE4 DMT15720
         MVI   PNSEGTYP,X'01'      Expect actual data next     SML2NJE4 DMT15730
         ST    R4,APNJETRL         Save address of job trailer SML2NJE4 DMT15740
         L     R4,APNJEDTA         Get addr. of ds hdr prefix  SML2NJE4 DMT15750
         USING NJEPDSEC,R4         Use R4 for NJEP* locations  SML2NJE4 DMT15760
         SR    R2,R4               Get length of ds header     SML2NJE4 DMT15770
         STH   R2,NJEPLEN          Save ds hdr len in prefix   SML2NJE4 DMT15780
         DROP  R4                  Finished with ds hdr prefix SML2NJE4 DMT15790
         LA    R4,NJEPSIZE(,R4)    Get address of 1st section  SML2NJE4 DMT15800
         USING NDHGDSEC,R4         Assume general section      SML2NJE4 DMT15810
PDLOOP   EQU   *                                               SML2NJE4 DMT15820
         LTR   R2,R2               Reached end of ds header?   SML2NJE4 DMT15830
         BZ    PFREE               Finished with ds header     SML2NJE4 DMT15840
         LA    R0,10               Error code                  SML2NJE4 DMT15850
         CH    R2,=H'4'            Ensure 4 bytes or more left SML2NJE4 DMT15860
         BNH   MSG939              Declare protocol error      SML2NJE4 DMT15870
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT15880
         ICM   R1,B'0011',NDHGLEN  Get section length          SML2NJE4 DMT15890
         LA    R0,11               Error code                  SML2NJE4 DMT15900
         CH    R1,=H'4'            Minimum section length is 4 SML2NJE4 DMT15910
         BNH   MSG939              Declare protocol error      SML2NJE4 DMT15920
         LA    R0,12               Error code                  SML2NJE4 DMT15930
         SR    R2,R1               Subtract from header len    SML2NJE4 DMT15940
         BM    MSG939              Gone past end of ds header  SML2NJE4 DMT15950
         XR    R0,R0               Clear R0 for ICM            SML2NJE4 DMT15960
         ICM   R0,B'0011',NDHGTYPE Get section type & modifier SML2NJE4 DMT15970
         BNZ   PDNOTGEN            Not the ds general section  SML2NJE4 DMT15980
         CH    R1,=AL2(NDHGFCBI-NDHGDSEC) Is header too short? SML2NJE4 DMT15990
         BL    PDGENFIN            Not much use - ignore it.   SML2NJE4 DMT16000
*        Copy any relevant details present in general section  SML2NJE4 DMT16010
         MVC   TAGNAME(8),NDHGPROC 1st 8 characters of filenameSML2NJE4 DMT16020
         MVC   TAGNAME+8(4),BLANK  Blank last four characters  SML2NJE4 DMT16030
         MVC   TAGTYPE(8),NDHGSTEP 1st 8 characters of filetypeSML2NJE4 DMT16040
         MVC   TAGTYPE+8(4),BLANK  Blank last four characters  SML2NJE4 DMT16050
         MVC   TAGTOLOC,NDHGNODE   Destination node            SML2NJE4 DMT16060
         MVC   PCTTOVM,NDHGRMT     Destination userid          SML2NJE4 DMT16070
         MVC   TAGCLASS,NDHGCLAS   Spool file class            SML2NJE4 DMT16080
         MVC   TAGRECLN,NDHGLREC   Record length               SML2NJE4 DMT16090
         MVI   TAGCOPY,X'00'       Top byte of copy count      SML2NJE4 DMT16100
         MVC   TAGCOPY+1,NDHGDSCT  Dataset count (copy count)  SML2NJE4 DMT16110
PDGENFIN EQU   *                                               SML2NJE4 DMT16120
         DROP  R4                  Finished with general sect. SML2NJE4 DMT16130
         AR    R4,R1               Move on to next ds section  SML2NJE4 DMT16140
         B     PDLOOP              Go around again             SML2NJE4 DMT16150
*                                                                       DMT16160
PDNOTGEN EQU   *                                               SML2NJE4 DMT16170
         C     R0,=X'00008700'     Is this an RSCS section?    SML2NJE4 DMT16180
         BNE   PDNOTRSC            Not RSCS section            SML2NJE4 DMT16190
*                                                              SML2NJE4 DMT16200
         USING NDHVDSEC,R4         Use to address RSCS section SML2NJE4 DMT16210
         CH    R1,=AL2(NDHVVRSN-NDHVLEN) Is header too short?  SML2NJE4 DMT16220
         BL    PDRSCFIN            Not much use - skip over it SML2NJE4 DMT16230
*        Copy any relevant details present in RSCS section     SML2NJE4 DMT16240
*        Override anything already copied from general section SML2NJE4 DMT16250
         MVC   TAGCLASS,NDHVCLAS   Spool file class            SML2NJE4 DMT16260
         MVC   TAGINDEV,NDHVIDEV   CP device type code         SML2NJE4 DMT16270
         MVC   TAGDIST,NDHVDIST    Distribution code           SML2NJE4 DMT16280
         MVC   TAGNAME,NDHVFNAM    Spool filename              SML2NJE4 DMT16290
         MVC   TAGTYPE,NDHVFTYP    Spool filetype              SML2NJE4 DMT16300
         MVC   TAGPRIOR,NDHVPRIO   Priority                    SML2NJE4 DMT16310
         DROP  R4                  Finished with RSCS section  SML2NJE4 DMT16320
PDRSCFIN EQU   *                                               SML2NJE4 DMT16330
PDNOTRSC EQU   *                                               SML2NJE4 DMT16340
         AR    R4,R1               Move on to next section     SML2NJE4 DMT16350
         B     PDLOOP              Go around again             SML2NJE4 DMT16360
*                                                              SML2NJE4 DMT16370
PNOTDHDR EQU   *                                               SML2NJE4 DMT16380
         LA    R0,13               Error code                  SML2NJE4 DMT16390
         CLI   TANKSRCB,X'D0'      Is this a job trailer?      SML2NJE4 DMT16400
         BNE   MSG939              Declare protocol error      SML2NJE4 DMT16410
*                                                              SML2NJE4 DMT16420
         MVI   PNSEGTYP,X'00'      Expect EOF next             SML2NJE4 DMT16430
         L     R4,APNJETRL         Get addr. of job trl prefix SML2NJE4 DMT16440
         USING NJEPDSEC,R4         Use R4 for NJEP* locations  SML2NJE4 DMT16450
         SR    R2,R4               Get length of job trailer   SML2NJE4 DMT16460
         STH   R2,NJEPLEN          Save job trlr len in prefix SML2NJE4 DMT16470
*        Nothing of interest in job trailer.  Just keep going. SML2NJE4 DMT16480
         B     PFREE               Free tank.  Get next tank.  SML2NJE4 DMT16490
*                                                              SML2NJE4 DMT16500
COPYSEGM MVC   NJEPSIZE(*-*,R2),TANKDATA+NJEPSIZE Executed abv SML2NJE4 DMT16510
*                                                              SML2NJE4 DMT16520
PNDISCRD EQU   *                                               SML2NJE4 DMT16530
         ICM   R1,B'0011',TANKCNT  Check for end of job        SML2NJE4 DMT16540
         BNZ   PFREE               Discard tank. Get next one. SML2NJE4 DMT16550
         B     PCLOSEF             Skip EOF hdrs. Just close.  SML2NJE4 DMT16560
PCLOSE   EQU   *                                                        DMT16570
EOFREC   EQU   X'40'               Received EOF from network   SML2NJE4 DMT16580
         OI    PSW1,EOFREC         Flag EOF received           SML2NJE4 DMT16590
         LA    R0,14               Error code                  SML2NJE4 DMT16600
         CLI   PNSEGTYP,X'00'      Are we expecting EOF?       SML2NJE4 DMT16610
         BNE   MSG939              Declare protocol error      SML2NJE4 DMT16620
         MVI   PNSEGTYP,X'70'      Not expecting anything now  SML2NJE4 DMT16630
         LA    R0,15               Error code                  SML2NJE4 DMT16640
         CLI   PNSEGNUM,X'00'      Are all segments received?  SML2NJE4 DMT16650
         BNE   MSG939              Declare protocol error      SML2NJE4 DMT16660
         MVI   PNSEGNUM,X'FF'      Not expecting segments now  SML2NJE4 DMT16670
         L     R4,APNJETRL         Get address of job trailer  SML2NJE4 DMT16680
         LA    R5,X'D0'            Specify NJE job trailer     SML2NJE4 DMT16690
         BAL   R14,WRITNJEH        Write NJE header to ur dev  SML2NJE4 DMT16700
PCLOSEF  EQU   *                                               SML2NJE4 DMT16710
         TM    MASTERSW,SYSOUT     Was device actually opened? SML2NJE4 DMT16720
         BZ    PFREE               Didn't happen. Give up.     SML2NJE4 DMT16730
         L     R1,PDEVFIOA         Get IOTABLE address         SML2NJE4 DMT16740
         USING IOTABLE,R1          Get IOTABLE addressability  SML2NJE4 DMT16750
         UNPK  TAGCMD+7(5),DEVCUU(3) Unpack the device address SML2NJE4 DMT16760
         DROP  R1                  Finished with IOTABLE now   SML2NJE4 DMT16770
         MVI   TAGCMD+7,C' '       Restore the clobbered blank SML2NJE4 DMT16780
         MVI   TAGCMD+11,C' '      Restore the clobbered blank SML2NJE4 DMT16790
         TR    TAGCMD+8(3),AXSTRTAB-240 Make into legal EBCDIC SML2NJE4 DMT16800
         LA    R1,TAGCMD           Get the TAG command address SML2NJE4 DMT16810
         LA    R2,TAGCMDL          Get the TAG command length  SML2NJE4 DMT16820
*********DIAG  R1,R2,X'08'         Issue the TAG DEV command   SML2NJE4 DMT16830
         MVI   TAGDATA,C' '        Clear first byte of field   SML2NJE4 DMT16840
         MVC   TAGDATA+1(69),TAGDATA Clear rest of field       SML2NJE4 DMT16850
         LA    R1,PDEVSYNC         Get PRT / PUN device block  SML2NJE4 DMT16860
         LA    R0,X'12'            INDICATE CLOSE FUNCTION              DMT16870
         BAL   R14,AXS             GO CLOSE THE FILE                    DMT16880
         NI    MASTERSW,255-SYSOUT Clear UR device open flag   SML2NJE4 DMT16890
         OI    PACON,ECBSKIP       INDICATE SKIP ECB                    DMT16900
         TM    PSW1,DISCARD        Is job being discarded?     SML2NJE4 DMT16910
         BO    PFREE               No ACK and no MSG 145       SML2NJE4 DMT16920
RETRYACK EQU   *                                               SML2NJE4 DMT16930
         BAL   R14,$TPACKTC        Ack transmission complete   SML2NJE4 DMT16940
         BNZ   TPACKOK             No problems sending ACK     SML2NJE4 DMT16950
         MVI   PCTWFB,X'FF'        Show waiting for buffer     SML2NJE4 DMT16960
         MVC   PCTENTY(2),PACN1    Set up to retry send of ACK SML2NJE4 DMT16970
         L     R6,PCTCOM           Get commutator entry        SML2NJE4 DMT16980
         MVI   1(R6),CLOSE         Close gate                  SML2NJE4 DMT16990
         B     PCTRTN              Go wait for buffer          SML2NJE4 DMT17000
PLOC1    EQU   *                   Return here with buffer     SML2NJE4 DMT17010
         MVI   PCTWFB,X'00'        Show not waiting for buffer SML2NJE4 DMT17020
         B     RETRYACK            Retry sending file ACK      SML2NJE4 DMT17030
PACN1    DC    S(PLOC1)                                        SML2NJE4 DMT17040
TPACKOK  EQU   *                                                        DMT17050
         LH    R1,TAGID            Get file id assigned           *XJE
         CVD   R1,XJESAVE+16       Convert into work area         *XJE
         UNPK  XJESAVE+12(4),XJESAVE+16(8)  Make display          *XJE
         OI    XJESAVE+15,X'F0'    Fix sign                       *XJE
         MVI   XJESAVE+16,C' '     Ensure padded with blanks      *XJE
         MVC   XJESAVE+17(3),XJESAVE+16  out to eight bytes       *XJE
         MSGX  145,(XJESAVE+12,TAGINLOC,TAGINVM,TAGTOLOC,PCTTOVM) *XJE  DMT17060
         B     PFREE               FREE THE TANK IF END OF JOB          DMT17070
         SPACE 1                                                        DMT17080
PCONT    EQU   *                                                        DMT17090
PDATAREC EQU   *                                                        DMT17100
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT17110
         ICM   R1,B'0011',TANKCNT  Get number of bytes in tank SML2NJE4 DMT17120
         BZ    PCLOSE              Empty tank => end of file   SML2NJE4 DMT17130
         LA    R0,16               Error code                  SML2NJE4 DMT17140
         TM    PNSEGTYP,X'03'      Are we expecting data now?  SML2NJE4 DMT17150
         BNM   MSG939              Declare protocol error      SML2NJE4 DMT17160
         MVI   PNSEGTYP,X'02'      Specify data has been found SML2NJE4 DMT17170
         BCTR  R1,0                Don't count length byte     SML2NJE4 DMT17180
         MVI   PCTCCWCT,X'00'      Clear CCW count high byte   SML2NJE4 DMT17190
         MVC   PCTCCWCT+1(1),TANKDATA  Record length into CCW  SML2NJE4 DMT17200
         CH    R1,PCTCCWCT         Tank length < record length?SML2NJE4 DMT17210
         BNL   PCOUNTOK            All record within tank      SML2NJE4 DMT17220
         STH   R1,PCTCCWCT         Truncate to length of tank  SML2NJE4 DMT17230
PCOUNTOK EQU   *                                               SML2NJE4 DMT17240
         TM    MASTERSW,SYSOUT     Is UR output device open?   SML2NJE4 DMT17250
         BO    PCONT2              OPEN..OKAY CONTINUE                  DMT17260
         CLI   TAGINDEV,0          Have we got a device type?  SML2NJE4 DMT17270
         BNE   PGOTDEV             Already know what device    SML2NJE4 DMT17280
         MVI   TAGINDEV,TYPPUN     Assume PUN device suitable  SML2NJE4 DMT17290
         MVI   PNRECLEN+1,80       Punch reclen. Top byte is 0.SML2NJE4 DMT17300
         CLC   TAGRECLN,=H'81'     Is record length too large? SML2NJE4 DMT17310
         BNH   PGOTDEV             Record length ought to fit  SML2NJE4 DMT17320
         MVI   TAGINDEV,TYPPRT     Use PRT device instead      SML2NJE4 DMT17330
         MVI   PNRECLEN+1,132      Print reclen. Top byte is 0.SML2NJE4 DMT17340
PGOTDEV  EQU   *                                               SML2NJE4 DMT17350
         CLC   TAGTOLOC,LOCATION   Is the file for this node?  SML2NJE4 DMT17360
*NJE38   BNE   PNOTLOCL            No.  Not for anyone here.   SML2NJE4 DMT17370
         MVC   TAGTOVM,PCTTOVM     Spool file to local user    SML2NJE4 DMT17380
         MVC   TAGDATA(HDRSGLEN),HDRLINE Format header in tag  SML2NJE4 DMT17390
         MVC   TAGDATA+0(8),TAGINLOC Fill in originating node  SML2NJE4 DMT17400
         MVC   TAGDATA+12(8),TAGINVM Fill in originating user  SML2NJE4 DMT17410
         LA    R2,TAGDATA+22       Get address of time in tag  SML2NJE4 DMT17430
         MVC   TAGDATA+22(MASKLEN),TODMASK Get TOD edit mask   SML2NJE4 DMT17440
         LA    R0,XJE2TOD          Code 0C=TODEBCD                *XJE  DMT17450
         LA    R1,TAGINTOD         -> TOD clock data              *XJE
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT17460
         BALR  R14,R15             Convert TOD to EBCDIC          *XJE  DMT17470
         B     PISLOCAL            Skip over non-local stuff   SML2NJE4 DMT17480
*                                                              SML2NJE4 DMT17490
PNOTLOCL EQU   *                                               SML2NJE4 DMT17500
         MVC   TAGTOVM,=CL8'*'     Spool to self to requeue    SML2NJE4 DMT17510
         MVC   TAGDATA+0(8),TAGTOLOC Set tag node for next hop SML2NJE4 DMT17520
         MVC   TAGDATA+9(8),=CL8'<S&&F>' Indicate store + fwd  SML2NJE4 DMT17530
*                                                              SML2NJE4 DMT17540
PISLOCAL EQU   *                                               SML2NJE4 DMT17550
         LA    R1,PDEVSYNC         GET PRINTER DEVICE BLOCK             DMT17560
         LA    R0,X'11'            INDICATE GET SPOOL DEVICE            DMT17570
         BAL   R14,AXS             GO INTERFACE TO FILE ACCESS          DMT17580
         L     R1,PDEVFIOA         GET FILE I/O AREA ADDRESS            DMT17590
         ST    R1,PACON            AND STORE IN ECB LIST                DMT17600
         XC    0(4,R1),0(R1)       INITIALLY CLEAR SYNCH LOCK           DMT17610
         OI    MASTERSW,SYSOUT     Indicate UR output dev open SML2NJE4 DMT17620
         MSGX  144,(TAGINLOC,TAGINVM,TAGTOLOC,PCTTOVM) Rec'ing SML2NJE4 DMT17630
         L     R4,APNJEHDR         Get address of job header   SML2NJE4 DMT17640
         LA    R5,X'C0'            Specify NJE job header      SML2NJE4 DMT17650
         BAL   R14,WRITNJEH        Write NJE header to ur dev  SML2NJE4 DMT17660
         L     R4,APNJEDTA         Get address of data set hdr.SML2NJE4 DMT17670
         LA    R5,X'E0'            Specify NJE data set header SML2NJE4 DMT17680
         BAL   R14,WRITNJEH        Write NJE header to ur dev  SML2NJE4 DMT17690
PCONT2   EQU   *                                                        DMT17700
         EJECT                                                          DMT17710
*                                                                       DMT17720
*        SET UP CARRIAGE CONTROL                                        DMT17730
*                                                                       DMT17740
         LA    R6,TANKDATA+1       Skip record length byte     SML2NJE4 DMT17750
         ST    R6,PCTCCW           STORE IN CCW                         DMT17760
         LA    R0,X'41'            Default opcode for PUN      SML2NJE4 DMT17770
         CLI   TAGINDEV,TYP3210    Is this spooled cons o/p?   SML2NJE4 DMT17780
         BE    PRTCC               Treat it like a print file  SML2NJE4 DMT17790
         TM    TAGINDEV,TYPPRT     Is this a print file?       SML2NJE4 DMT17800
         BNO   PRCCDONE            Skip print carriage control SML2NJE4 DMT17810
PRTCC    EQU   *                                               SML2NJE4 DMT17820
         DROP  R3                  Finished with TAG for now   SML2NJE4 DMT17830
         LA    R0,X'09'            Assume no carriage control  SML2NJE4 DMT17840
         TM    TANKSRCB,B'00110000' Is there carriage control? SML2NJE4 DMT17850
         BZ    PRCCDONE            xx00xxxx => no carriage ctl SML2NJE4 DMT17860
         LA    R6,TANKDATA+2       Skip length and CC byte too SML2NJE4 DMT17870
         ST    R6,PCTCCW           Update CCW data location    SML2NJE4 DMT17880
         LH    R6,PCTCCWCT         Get CCW count               SML2NJE4 DMT17890
         BCTR  R6,0                Reduce by one               SML2NJE4 DMT17900
         STH   R6,PCTCCWCT         Store back CCW count        SML2NJE4 DMT17910
         TM    TANKSRCB,B'00100000' Is this machine CC?        SML2NJE4 DMT17920
         BO    PRNOTMCC            Not machine CC              SML2NJE4 DMT17930
         IC    R0,TANKDATA+1       Get opcode from data stream SML2NJE4 DMT17940
         B     PRCCDONE            Carriage control done       SML2NJE4 DMT17950
PRNOTMCC EQU   *                                               SML2NJE4 DMT17960
         TM    TANKSRCB,B'00010000' Is this ASA CC?            SML2NJE4 DMT17970
         BO    PRCCDONE            Not ASA CC, ignore it       SML2NJE4 DMT17980
         LA    R0,X'13'            Space 2 lines immediate     SML2NJE4 DMT17990
         CLI   TANKDATA+1,C'0'     Is CC character '0'?        SML2NJE4 DMT18000
         BE    PRASACC             ASA carriage control found  SML2NJE4 DMT18010
         LA    R0,X'8B'            Skip to channel 1 immediate SML2NJE4 DMT18020
         CLI   TANKDATA+1,C'1'     Is CC character '1'?        SML2NJE4 DMT18030
         BE    PRASACC             ASA carriage control found  SML2NJE4 DMT18040
         LA    R0,X'1B'            Space 3 lines immediate     SML2NJE4 DMT18050
         CLI   TANKDATA+1,C'-'     Is CC character '-'?        SML2NJE4 DMT18060
         BE    PRASACC             ASA carriage control found  SML2NJE4 DMT18070
         LA    R0,X'01'            Write, no space             SML2NJE4 DMT18080
         CLI   TANKDATA+1,C'+'     Is CC character '+'?        SML2NJE4 DMT18090
         BE    PRASACC             ASA carriage control found  SML2NJE4 DMT18100
         LA    R0,X'0B'            Default: space 1 immediate  SML2NJE4 DMT18110
PRASACC  STC   R0,PCTCCW           Store opcode in ccw         SML2NJE4 DMT18120
         DROP  R8                  Finished with TANKDSEC now  SML2NJE4 DMT18130
         BAL   R14,PWRITDEV        Write record to PRT         SML2NJE4 DMT18140
         LA    R0,X'01'            Write actual record 0 space SML2NJE4 DMT18150
PRCCDONE EQU   *                                               SML2NJE4 DMT18160
         STC   R0,PCTCCW           Store opcode in ccw         SML2NJE4 DMT18170
         BAL   R14,PWRITDEV        Write record to PRT or PUN  SML2NJE4 DMT18180
PFREE    EQU   *                                                        DMT18190
         MVC   0(4,R8),$TANKPOL    GET FIRST FREE OFF QUEUE             DMT18200
         ST    R8,$TANKPOL         MAKE THIS ONE THE FIRST              DMT18210
         MVI   $TPGETCM+1,OPEN     OPEN TPGET GATE                      DMT18220
         B     PNEXT               Process next record         SML2NJE4 DMT18230
         SPACE 1                                                        DMT18240
         EJECT                                                 SML2NJE4 DMT18250
*        Subroutine to write a record to PRT or PUN device     SML2NJE4 DMT18260
*        On entry, opcode, address of data and count in PCTCCW SML2NJE4 DMT18270
PWRITDEV DS    0H                                              SML2NJE4 DMT18280
         STM   R14,R8,COMSAVE+8    Save callers registers      SML2NJE4 DMT18290
         MVI   PCTECB,X'10'        Show PRT or PUN device busy SML2NJE4 DMT18300
         L     R1,PDEVFIOA         Get file I/O area address   SML2NJE4 DMT18310
         USING IOTABLE,R1          Get IOTABLE addressability  SML2NJE4 DMT18320
         LA    R6,PCTCCW           Get CCW address             SML2NJE4 DMT18330
         ST    R6,PROGADDR         Set CAW in device block     SML2NJE4 DMT18340
         DROP  R1                  Finished with IOTABLE       SML2NJE4 DMT18350
         L     R15,IOREQ           System I/O processor        SML2NJE4 DMT18360
         BALR  R14,R15             Go execute the I/O          SML2NJE4 DMT18370
         BAL   R14,$IOCK           Wait for ECB to be posted   SML2NJE4 DMT18380
         LM    R14,R8,COMSAVE+8    Retrieve callers registers  SML2NJE4 DMT18390
         BR    R14                 Return to caller            SML2NJE4 DMT18400
*                                                              SML2NJE4 DMT18410
*        Subroutine to write an NJE header to a unit record    SML2NJE4 DMT18420
*        device.  The header is split into segments which can  SML2NJE4 DMT18430
*        be accomodated by the device.  On entry, the address  SML2NJE4 DMT18440
*        of the header is in R4 and the header type is in R5.  SML2NJE4 DMT18450
*                                                              SML2NJE4 DMT18460
WRITNJEH EQU   *                                               SML2NJE4 DMT18470
         LH    R0,PCTCCWCT         Save data record length     SML2NJE4 DMT18480
         LR    R6,R14              Save callers address        SML2NJE4 DMT18490
         USING NJEPDSEC,R4         Use R4 for NJEP* addresses  SML2NJE4 DMT18500
         XR    R2,R2               Start at segment zero       SML2NJE4 DMT18510
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT18520
         ICM   R1,B'0011',NJEPLEN  Get total header length     SML2NJE4 DMT18530
WNJELOOP EQU   *                                               SML2NJE4 DMT18540
         LA    R1,NJEPSIZE(,R1)    Add len. of segment prefix  SML2NJE4 DMT18550
         STH   R1,NJEPLEN          Size of rest of header      SML2NJE4 DMT18560
         STC   R5,NJEPFLGS         Set header type             SML2NJE4 DMT18570
         STC   R2,NJEPSEQ          Set segment number          SML2NJE4 DMT18580
         CH    R1,PNRECLEN         More than record len left?  SML2NJE4 DMT18590
         BNH   WNJELNOK            Length is ok for device     SML2NJE4 DMT18600
         MVC   NJEPLEN,PNRECLEN    Reduce segment to 132 or 80 SML2NJE4 DMT18610
         OI    NJEPSEQ,X'80'       Flag segment as not last    SML2NJE4 DMT18620
WNJELNOK EQU   *                                               SML2NJE4 DMT18630
         MVC   PCTCCWCT,NJEPLEN    Set CCW count for write     SML2NJE4 DMT18640
         MVI   PCTCCW,X'03'        Use NOP opcode for headers  SML2NJE4 DMT18650
         STCM  R4,B'0111',PCTCCW+1 Address of buffer to write  SML2NJE4 DMT18660
         BAL   R14,PWRITDEV        Write the header segment    SML2NJE4 DMT18670
         LA    R2,1(,R2)           Increment segment number    SML2NJE4 DMT18680
         AH    R4,PCTCCWCT         Push past this segment      SML2NJE4 DMT18690
         SH    R4,=AL2(NJEPSIZE)   Leave space for seg. prefix SML2NJE4 DMT18700
         SH    R1,PCTCCWCT         Reduce total by this segmnt SML2NJE4 DMT18710
         BNZ   WNJELOOP            Go around again if any left SML2NJE4 DMT18720
         DROP  R4                  Finished with NJE headers   SML2NJE4 DMT18730
         STH   R0,PCTCCWCT         Restore data record length  SML2NJE4 DMT18740
         LR    R14,R6              Restore callers address     SML2NJE4 DMT18750
         BR    R14                 Return to caller            SML2NJE4 DMT18760
*                                                              SML2NJE4 DMT18770
         USING TAG,R3              Ensure tag addresability    SML2NJE4 DMT18780
MSG938   EQU   *                                               SML2NJE4 DMT18790
         LH    R0,TAGID            Get spool file number       SML2NJE4 DMT18800
         CVD   R0,AXSCVD           Convert spool id to BCD     SML2NJE4 DMT18810
         UNPK  AXSFILE,AXSCVD      Make number printable       SML2NJE4 DMT18820
         OI    AXSFILE+3,X'F0'     Ensure last digit is too    SML2NJE4 DMT18830
         MSGX  938,(AXSFILE,AXSLINK) Resources n/a error       SML2NJE4 DMT18840
         B     PFLGDISC            Flag job to be discarded    SML2NJE4 DMT18850
*                                                              SML2NJE4 DMT18860
MSG939   EQU   *                                               SML2NJE4 DMT18870
         MVC   AXSRECS,BLANK       Clear unused characters     SML2NJE4 DMT18880
         CVD   R0,AXSCVD           Convert error code to BCD   SML2NJE4 DMT18890
         UNPK  AXSRECS(2),AXSCVD   Make number printable       SML2NJE4 DMT18900
         OI    AXSRECS+1,X'F0'     Ensure last digit is too    SML2NJE4 DMT18910
         LH    R0,TAGID            Get spool file number       SML2NJE4 DMT18920
         CVD   R0,AXSCVD           Convert spool id to BCD     SML2NJE4 DMT18930
         UNPK  AXSFILE,AXSCVD      Make number printable       SML2NJE4 DMT18940
         OI    AXSFILE+3,X'F0'     Ensure last digit is too    SML2NJE4 DMT18950
         MSGX  939,(AXSFILE,AXSLINK,AXSRECS) Protocol error    SML2NJE4 DMT18960
         TM    PSW1,EOFREC         Already received EOF?       SML2NJE4 DMT18970
         BO    PCLOSEF             No point in waiting for it  SML2NJE4 DMT18980
*                                                              SML2NJE4 DMT18990
PFLGDISC EQU   *                                               SML2NJE4 DMT19000
DISCARD  EQU   X'80'               Flag in PSW1 to discard job SML2NJE4 DMT19010
         OI    PSW1,DISCARD        Set flag to discard job     SML2NJE4 DMT19020
         MVI   PNSEGTYP,X'70'      Not expecting valid seg typ SML2NJE4 DMT19030
         MVI   PNSEGNUM,X'FF'      Not expecting valid seg num SML2NJE4 DMT19040
         B     PFREE               Free tank. Discard rest.    SML2NJE4 DMT19050
         DROP  R3                  Finished with tag for now   SML2NJE4 DMT19060
*                                                              SML2NJE4 DMT19070
         EJECT                                                          DMT19080
*.                                                                      DMT19090
*                                                                       DMT19100
* ENTRY NAME -                                                          DMT19110
*                                                                       DMT19120
*        $JRTN1                                                         DMT19130
*                                                                       DMT19140
* FUNCTION -                                                            DMT19150
*                                                                       DMT19160
*        THIS ROUTINE DEQUEUES TANKS FROM ITS TANK QUEUE, OBTAINS       DMT19170
*        A NEW OUTPUT SPOOL DEVICE IF NEEDED FROM DMTAXS, AND           DMT19180
*        OUTPUTS THE TANK TO A VIRTUAL PUNCH.                           DMT19190
*                                                                       DMT19200
* CALLS TO OTHER ROUTINES -                                             DMT19210
*                                                                       DMT19220
*        DMTIOMRQ - TO INITIATE AN I/O OPERATION                        DMT19230
*                                                                       DMT19240
* OPERATION -                                                           DMT19250
*                                                                       DMT19260
*        1. OBTAIN A TANK FROM $GETTNK                                  DMT19270
*                                                                       DMT19280
*        2. IF OBTAINED CHECK TO SEE IF OUTPUT FILE IS OPENED,          DMT19290
*           IF NOT OBTAIN A OUTPUT DEVICE BY A CALL TO AXS.             DMT19300
*                                                                       DMT19310
*        3. VIA A CALL TO $USREXIT VALIDATE THE INFORMATION ON          DMT19320
*           THE ID CARD.                                                DMT19330
*                                                                       DMT19340
*        4. WRITE THE RECORD TO THE VM/370 SPOOL FILE SYSTEM.           DMT19350
*                                                                       DMT19360
*        5. WHEH EOF IS OBTAINED CLOSE THE FILE VIA ANOTHER CALL        DMT19370
*           TO AXS.                                                     DMT19380
*                                                                       DMT19390
*        6. EXIT TO COMMUTATOR                                          DMT19400
*                                                                       DMT19410
* RESPONSES -                                                           DMT19420
*                                                                       DMT19430
*        DMTXJE144I  RECEIVING: FILE FROM 'LOCID1' ('USERID1') HRC000DT DMT19440
*                    FOR 'LOCID2' ('USERID2')                  HRC000DT DMT19450
*        DMTXJE145I  RECEIVED: FILE FROM 'LOCID1' ('USERID1')  HRC000DT DMT19460
*                    FOR 'LOCID2' ('USERID2')                  HRC000DT DMT19470
*                                                                       DMT19480
* ERROR MESSAGES -                                                      DMT19490
*                                                                       DMT19500
*        NONE                                                           DMT19510
*                                                                       DMT19520
*.                                                                      DMT19530
         SPACE 1                                                        DMT19540
         USING TANKDSEC,R8                                              DMT19550
         USING TCTDSECT,TCTR                                            DMT19560
         USING TAG,R1              GET TAG ADDRESSABILITY               DMT19570
$JRTN1   DS    0H                  INITIAL ENTRY AT IPL TIME            DMT19580
JSTART   DS    0H                  LOOP ENTRY TO CONTINUE PUNCHING      DMT19590
         BAL   R14,$GETTNK         WAIT FOR THE NEXT TANK               DMT19600
         CLI   TANKCNT+1,0         TEST FOR END OF JOB                  DMT19610
         BNE   JOUTPUT             NO CONTINUE                          DMT19620
JCLOSE   EQU   *                                                        DMT19630
         XC    $USRCMDC(2),$USRCMDC CLEAR INPUT CMD COUNT      @VA04612 DMT19640
         TM    MASTERSW,JOB        WAS A FILE EVER OPENED?              DMT19650
         BO    JCLOSE1             YES CONTINUE                         DMT19660
         NI    JSW2,255-JNOID RESET ID CARD MISSING FLAG       @VA04612 DMT19670
         B     JFREE               AND EXIT                             DMT19680
         SPACE 1                                                        DMT19690
JCLOSE1  EQU   *                                                        DMT19700
         L     R15,JDEVFIOA        GET IOTABLE ADDRESS                  DMT19710
         UNPK  TAGCMD+7(5),DEVCUU-IOTABLE(3,R15) UNPK THE DEV ADDR      DMT19720
         MVI   TAGCMD+7,C' '       RESTORE THE CLOBBERED BLANK          DMT19730
         MVI   TAGCMD+11,C' '      RESTORE THE CLOBBERED BLANK          DMT19740
         TR    TAGCMD+8(3),AXSTRTAB-240 TRANSLATE TO LEGAL EBCDIC       DMT19750
         LA    R1,TAGCMD           GET TAG COMMAND ADDR                 DMT19760
         LA    R2,TAGCMDL          AND THE LENGTH                       DMT19770
*********DIAG  R1,R2,X'08'         AND ISSUE THE COMMAND                DMT19780
         MVI   TAGDATA,C' '        CLEAR FIRST BYTE OF FIELD            DMT19790
         MVC   TAGDATA+1(69),TAGDATA AND THE REST OF FIELD              DMT19800
         LA    R1,JDEVSYNC         GET DEVICE BLOCK ADDRESS             DMT19810
         LA    R0,X'12'            INDICATE CLOSE                       DMT19820
         BAL   R14,AXS             GO CLOSE THE FILE                    DMT19830
         BAL   R14,$TPACKTC        Ack transmission complete   SML2NJE4 DMT19840
         MSGX  145,(AXSLINK,SYSTYPE,LOCATION,JCTTOVM) WRITE CLO@VM01105 DMT19850
         NI    MASTERSW,255-JOB    TURN OFF OPEN FLAG                   DMT19860
         NI    JSW1,255-JSPOVM     RESET FLAG                           DMT19870
         OI    JACON,ECBSKIP       INDICATE ECB SKIP                    DMT19880
         L     R1,AJDEVTAG         GET ADDRESS OF JOB TAG      SML2NJE4 DMT19890
         MVC   TAGTOVM(8),BLANK    BLANK OUT TAG                        DMT19900
         MVC   JCTTOVM(8),BLANK    BLANK OUT DESTINATION                DMT19910
         B     JFREE               IF SO FREE TANK                      DMT19920
         EJECT                                                          DMT19930
JOUTPUT  DS    0H                  JOB THE CARD                         DMT19940
         TM    MASTERSW,JOB        SEE IF FILE ACTIVE                   DMT19950
         BO    JOUT1               YES CONTINUE                         DMT19960
         BAL   R14,$USREXIT        SEE CARD MUST BE MODIFIED            DMT19970
         BP    JFREE               NON 0 DONT PROCESS RECORD            DMT19980
         TM    JSW1,JSPOVM         ARE WE SPOOLING YET                  DMT19990
         BNO   JFREE               NO..SKIP IT                          DMT20000
         L     R1,AJDEVTAG         GET ADDRESS OF JOB TAG      SML2NJE4 DMT20010
         MVC   TAGTOVM(8),JCTTOVM  MOVE IN DESTINATION                  DMT20020
         LA    R1,JDEVSYNC         GET DEVICE BLOCK                     DMT20030
         LA    R0,X'11'            INDICATE OPEN                        DMT20040
         BAL   R14,AXS             GO GET A DEVICE                      DMT20050
         L     R1,JDEVFIOA         GET FIOA ADDRESS                     DMT20060
         XC    0(4,R1),0(R1)       INITIALIALLY CLEAR SYNCH LOCK        DMT20070
         ST    R1,JACON            STORE IN ECB LIST                    DMT20080
         OI    MASTERSW,JOB        INDICATE FILE OPEN                   DMT20090
         MSGX  144,(AXSLINK,SYSTYPE,LOCATION,JCTTOVM) WRITE REC@VM01105 DMT20100
         B     JFREE               FREE THE TANK                        DMT20110
         SPACE 1                                                        DMT20120
JOUT1    EQU   *                                                        DMT20130
         MVC   JCTCCWCT+1(1),TANKCNT+1 SET COUNT IN CCW                 DMT20140
         LA    R8,TANKDATA         GET DATA ADDR                        DMT20150
         ST    R8,JCTCCW           STORE IN CCW                         DMT20160
         MVI   JCTECB,X'10'        SHOW PUNCH BUSY                      DMT20170
         OC    JCTCCW(1),JCTOPCOD  SET OPCODE                           DMT20180
         L     R1,JDEVFIOA         GET DEVICE BLOCK                     DMT20190
         LA    R6,JCTCCW           GET CCW ADDR                         DMT20200
         ST    R6,PROGADDR-IOTABLE(R1) SET IN CAW                       DMT20210
         L     R15,IOREQ           SYSTEM I/O REWUEST PROCESSOR         DMT20220
         BALR  R14,R15             GO EXECUTE THE I/O                   DMT20230
         BAL   R14,$IOCK           CHECK FOR I/O COMPLETE               DMT20240
         L     R8,JCTCCW           PICK UP TANK ADDRESS                 DMT20250
         S     R8,=A(TANKDATA-TANKDSEC) RESET TO BEGINNING OF TANK      DMT20260
JFREE    EQU   *                                                        DMT20270
         MVC   0(4,R8),$TANKPOL    GET FIRST FREE OFF QUEUE             DMT20280
         ST    R8,$TANKPOL         MAKE THIS ONE THE FIRST              DMT20290
         MVI   $TPGETCM+1,OPEN     OPEN TPGET GATE                      DMT20300
         B     JSTART              GO BACK TO START OF PROCESSOR        DMT20310
         DROP  R1                  DROP ADDRESSABILITY                  DMT20320
         SPACE 1                                                        DMT20330
JSPOVM   EQU   X'40'               SPO TO VM FLAG                       DMT20340
         EJECT                                                          DMT20350
*.                                                                      DMT20360
*                                                                       DMT20370
* ENTRY NAME -                                                          DMT20380
*                                                                       DMT20390
*        $USREXIT                                                       DMT20400
*                                                                       DMT20410
* FUNCTION -                                                            DMT20420
*                                                                       DMT20430
*        TO VALIDATE THE 'ID' CARD ON THE FRONT OF DECKS INPUTTED       DMT20440
*        FROM A REMOTE CARD READER.                                     DMT20450
*                                                                       DMT20460
* CALLS TO OTHER ROUTINES -                                             DMT20470
*                                                                       DMT20480
*        NONE                                                           DMT20490
*                                                                       DMT20500
* OPERATION -                                                           DMT20510
*                                                                       DMT20520
*        1. SEE IF THE TANK CONTAINS AN ID CARD.                        DMT20530
*           IT NOT EXIT.                                                DMT20540
*                                                                       DMT20550
*        2. IF ID CARD IS FOUND VALIDATE LENGTH OF USERID AND           DMT20560
*           MOVE TO THE JCTTOVM FIELD IN THE TCT.                       DMT20570
*                                                                       DMT20580
*        3. ANY OTHER TEXT ON THE ID CARD IS SAVED FOR USE AS THE       DMT20590
*           TAG COMMAND TEXT.                                           DMT20600
*                                                                       DMT20610
*        4. SET RETURN CODE AND RETURN TO CALLER.                       DMT20620
*                                                                       DMT20630
*                                                                       DMT20640
* RESPONSES -                                                           DMT20650
*                                                                       DMT20660
*                                                                       DMT20670
* ERROR MESSAGES -                                                      DMT20680
*                                                                       DMT20690
*                                                                       DMT20700
*.                                                                      DMT20710
         SPACE 3                                                        DMT20720
         USING TANKDSEC,R8                                              DMT20730
         SPACE 1                                                        DMT20740
$USREXIT DS    0H                                                       DMT20750
         LTR   R15,R15             SET CONDITION CODE                   DMT20760
         BR    R14                 RETURN                               DMT20770
         SPACE                                                          DMT20780
JNOID    EQU   X'80'          ID CARD MISSING FLAG             @VA04612 DMT20790
         SPACE                                                          DMT20800
         SPACE 1                                                        DMT20810
         EJECT                                                          DMT20820
*---------------------------------------------------------------------* DMT20830
*                                                                     * DMT20840
*           UNIT RECORD WAIT ROUTINE                                  * DMT20850
*                                                                     * DMT20860
*---------------------------------------------------------------------* DMT20870
         SPACE 1                                                        DMT20880
         USING TANKDSEC,R8         GET TANK ADDRESSABILITY              DMT20890
         USING TCTDSECT,TCTR       GET TCT ADDRESSABILITY               DMT20900
         SPACE 3                                                        DMT20910
         DS    0H                                                       DMT20920
YOCLOSE  EQU   *                                                        DMT20930
         L     R14,TCTCOM          CLOSE COMMUTATOR                     DMT20940
         MVI   1(R14),CLOSE        CHANGE BR TO NOP                     DMT20950
*              IF DEVICE BUSY DEVICE END INTERRUPT WILL CLEAR           DMT20960
*              IF DEVICE NOT  READY DEVICE END WILL CLEAR               DMT20970
         BR    R14                 RETURN TO CALLER                     DMT20980
         SPACE 1                                                        DMT20990
*        $IOCK                     ENTRY POINT TO PASS TO USER CODES    DMT21000
*                                                                       DMT21010
$IOCK    EQU   *                                                        DMT21020
         ST    R14,TCTSAV1         SAVE USER RETURN ADDRESS             DMT21030
         MVC   TCTENTY(2),YACN1    GET READY FOR DELAY                  DMT21040
         B     YOCLOSE             AND CONTINUE                         DMT21050
         SPACE 1                                                        DMT21060
YOCKRET  EQU   *                                                        DMT21070
         TM    TCTECB,X'10'        IS THE DEVICE FREE???                DMT21080
         BO    YOCLOSE             ALL DONE                             DMT21090
         L     R14,TCTSAV1         RESTORE REG                          DMT21100
         BR    R14                 RETURN TO CALLER                     DMT21110
         SPACE 1                                                        DMT21120
YACN1    DC    S(YOCKRET)          RETURN ENTRY POINT                   DMT21130
         EJECT                                                          DMT21140
*.                                                                      DMT21150
*                                                                       DMT21160
* ENTRY NAME -                                                          DMT21170
*                                                                       DMT21180
*        $RRTN1                                                         DMT21190
*                                                                       DMT21200
* FUNCTION -                                                            DMT21210
*                                                                       DMT21220
*        THIS ROUTINE INPUTS FILES FROM THE VM/370 SPOOL FILE           DMT21230
*        SYSTEM, DEBLOKS THEM INTO 132 BYTE RECORDS AND ISSUES A        DMT21240
*        CALL TO $PUT TO BLOCK THE RECORD INTO A TRANSMISSION           DMT21250
*        BUFFER.                                                        DMT21260
*                                                                       DMT21270
* CALLS TO OTHER ROUTINES -                                             DMT21280
*                                                                       DMT21290
*        NONE                                                           DMT21300
*                                                                       DMT21310
* OPERATION -                                                           DMT21320
*                                                                       DMT21330
*        1. IF NEEDED OPEN A NEW FILE TO TRANSMIT VIA CALL TO AXSGET.   DMT21340
*                                                                       DMT21350
*        2. TEST FOR READER TYPE AND MODIFY READER RCB TO REFLECT       DMT21360
*           MODE AND FILE TYPE.                                         DMT21370
*                                                                       DMT21380
*        3. SEND AND WAIT FOR A REPLY FOR A PERMISSION TO TRANSMIT      DMT21390
*           RECORD.                                                     DMT21400
*                                                                       DMT21410
*        4. GET A RECORD TO TRANSMIT VIA CALL TO VMDEBLOK               DMT21420
*                                                                       DMT21430
*        5. TEST FOR A READER COMMAND PENDING BY CHECKING RDRCMD        DMT21440
*           BYTE.                                                       DMT21450
*                                                                       DMT21460
*        6. IF EOF PURGE THE FILE, TRANSMIT EOF RECORD AND TRY          DMT21470
*           TO OBTAIN ANOTHER FILE.                                     DMT21480
*                                                                       DMT21490
* RESPONSES -                                                           DMT21500
*                                                                       DMT21510
*        DMTXJE146I  SENDING: FILE 'SPOOLID' ON LINK 'LINKID', HRC000DT DMT21520
*                         REC NNNNNN                           HRC000DT DMT21530
*        DMTXJE147I  SENT: FILE'SPOOLID' ON LINK 'LINKID'      HRC000DT DMT21540
*        DMTXJE580I  FILE 'SPOOLID' PROCESSING TERMINATED      HRC000DT DMT21550
*        DMTXJE611I  LINK 'LINKID' FILE TRANSMISSION SUSPENDED HRC000DT DMT21560
*        DMTXJE510I  FILE 'SPOOLID' BACKSPACED                 HRC000DT DMT21570
*        DMTXJE600I  FILE 'SPOOLID' FORWARD SPACED             HRC000DT DMT21580
*                                                                       DMT21590
* ERROR MESSAGES -                                                      DMT21600
*                                                                       DMT21610
*        DMTXJE581E  FILE 'SPOOLID' NOT ACTIVE                 HRC000DT DMT21620
*                                                                       DMT21630
*.                                                                      DMT21640
         EJECT                                                          DMT21650
*                                                                       DMT21660
*        INPUT SERVICE PROCESSOR                                        DMT21670
*                                                                       DMT21680
         SPACE 1                                                        DMT21690
$RRTN1   DS    0H                  INITIAL ENTRY AT IPL TIME            DMT21700
         USING TCTDSECT,TCTR       GET TCT ADDRESSABILTIY               DMT21710
         USING TAG,R8              GET TAG ADDRESSABILTIY               DMT21720
         USING LINKTABL,R6         Link table addressability   SML2NJE3 DMT21730
READ1    EQU   *                                                        DMT21740
         L     R6,XJELINK     Get link table address           HRC000DT DMT21750
         TM    LFLAG,LHOLD    IS THE LINK HELD                 @VA03110 DMT21760
         BO    READHLD        YES..EXIT                        @VA03110 DMT21770
         DROP  R6                  Finished with link table    SML2NJE3 DMT21780
         TM    RDRCMD,RHLDIPGS     IS A HOLD IN PROGRESS?               DMT21790
         BNO   RDNOHLD             NO CONTINUE                          DMT21800
READHLD  EQU   *                                               @VA03110 DMT21810
         MVC   RCTENTY(2),RACN4    REENTER AT READ1                     DMT21820
         B     RDWAIT              Go and wait                 SML2NJE4 DMT21830
         SPACE 1                                                        DMT21840
RDNOHLD  EQU   *                                                        DMT21850
         MVI   RCTECB,X'10'        SHOW READER BUSY                     DMT21860
         LA    R0,XJE2AXSG         Code 00=AXSGET                 *XJE  DMT21870
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT21880
         BALR  R14,R15             Go try to open reader file     *XJE  DMT21890
         LTR   R15,R15             Were files available?          *XJE  DMT21900
         BNZ   RDERR1              NO FILES FOR NOW                     DMT21910
         SPACE 1                                                        DMT21920
         L     R8,RDEVTAG          GET TAG ADDRESS                      DMT21930
         LH    R1,TAGID            GET SPOOL FILE ID                    DMT21940
         CVD   R1,AXSCVD           CONVERT TO DECIMAL                   DMT21950
         UNPK  AXSFILE,AXSCVD      SPREAD THE DIGITS                    DMT21960
         OI    AXSFILE+3,X'F0'     AND MAKE SURE LAST IS PRINTABLE      DMT21970
         L     R1,TAGRECNM         GET NUMBER OF RECS IN FILE           DMT21980
         CVD   R1,AXSCVD           CONVERT TO DECIMAL                   DMT21990
         UNPK  AXSRECS,AXSCVD      SPREAD THE DIGITS                    DMT22000
         OI    AXSRECS+7,X'F0'     MAKE SURE LAST IS PRINTABLE          DMT22010
         MVC   MSGVMID(8),TAGINVM  MOVE VMID INTO MSG                   DMT22020
         CLC   TAGTOVM,=CL8'<S&&F>' Check for store and fwd    SML2NJE4 DMT22030
         BNE   NOTSANDF            Not store and forward       SML2NJE4 DMT22040
         OI    RSW1,SANDF          Indicate store and fwd      SML2NJE4 DMT22050
NOTSANDF EQU   *                                               SML2NJE4 DMT22060
         CLI   TAGINDEV,TYP3210    IS IT SPOOLED CONSOLE OUTPUT         DMT22070
         BE    READCON             YES..TREAT LIKE PRINT FILE           DMT22080
         TM    TAGINDEV,TYPPRT     IS IT A PRINT FILE                   DMT22090
         BNO   READ2               NO CONTINUE                          DMT22100
READCON  EQU   *                                                        DMT22110
         OI    RSW1,PTRANS         INDICATE TRANSMITTING PRT FILE       DMT22120
         B     ROPEN               GO INITIATE THE TRANSMISSION         DMT22130
         SPACE 1                                                        DMT22140
READ2    EQU   *                                                        DMT22150
         SPACE 1                                                        DMT22160
READ3    EQU   *                                                        DMT22170
         OI    RSW1,UTRANS         INDICATE TRANSMITTING PUNCH OUTPUT   DMT22180
         EJECT                                                          DMT22190
ROPEN    EQU   *                                                        DMT22200
         TM    MASTERSW,READER     IS THERE A READER  OPEN              DMT22210
         BO    ROPEN1              READER IS ACTIVE                     DMT22220
         LA    R8,RCTTANK1         LOCATE TANK IN PARAMETER REG         DMT22230
         BAL   R14,$TPOPEN         REQUEST OTHER END TO RECEIVE STREAM  DMT22240
         BZ    RREOPEN             IF NOT SENT WAIT                     DMT22250
         MVC   RCTENTY(2),RACN1    WAIT FOR RESPONSE                    DMT22260
         B     RDWAIT                                          SML2NJE4 DMT22270
         SPACE 1                                                        DMT22280
RLOC1    EQU   *                                                        DMT22290
         OI    MASTERSW,READER     INDICATE THAT THE READER IS OPEN     DMT22300
         MSGX  146,(AXSFILE,AXSLINK,AXSRECS) WRITE MSG                  DMT22310
*                                                              SML2NJE4 DMT22320
*        If NJE headers are already present in file, get them  SML2NJE4 DMT22330
*        and send them out before the file. Otherwise, create  SML2NJE4 DMT22340
*        a set of headers from scratch and send those.         SML2NJE4 DMT22350
*                                                              SML2NJE4 DMT22360
         TM    RSW1,SANDF          Is this a store and fwd fileSML2NJE4 DMT22370
         BO    RNONJEH             Skip creating headers       SML2NJE4 DMT22380
*                                                              SML2NJE4 DMT22390
         L     R8,RDEVTAG          Get address of file tag     SML2NJE4 DMT22400
         LA    R0,XJE3JEJH         Code for routine BLDNJEJH      *XJE  DMT22410
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT22420
         BALR  R14,R15             Build NJE job header        SML2NJE4 DMT22430
*                                                              SML2NJE4 DMT22440
         LA    R8,RCTTANK1         Get tank address            SML2NJE4 DMT22450
         BAL   R14,$PUT            Write the tank to tp buffer SML2NJE4 DMT22460
*                                                              SML2NJE4 DMT22470
*        Create NJE data set header and send it before file    SML2NJE4 DMT22480
*                                                              SML2NJE4 DMT22490
         L     R8,RDEVTAG          Get address of file tag     SML2NJE4 DMT22500
         LA    R0,XJE3JEDS         Code for routine BLDNJEDS      *XJE  DMT22510
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT22520
         BALR  R14,R15             Build NJE dataset header    SML2NJE4 DMT22530
*                                                              SML2NJE4 DMT22540
         LA    R8,RCTTANK1         Get tank address            SML2NJE4 DMT22550
         BAL   R14,$PUT            Write the tank to tp buffer SML2NJE4 DMT22560
*                                                              SML2NJE4 DMT22570
RNONJEH  EQU   *                                               SML2NJE4 DMT22580
         EJECT                                                          DMT22590
ROPEN1   EQU   *                                                        DMT22600
RDLOOP   DS    0H                  BASIC READ LOOP                      DMT22610
*        Prepare to receive NJE headers from spool file NOPs   SML2NJE4 DMT22620
         L     R2,ARNJEHDR         Get start of buffer         SML2NJE4 DMT22630
         LA    R2,TANKDATA-TANKDSEC(,R2) Add tank overhead     SML2NJE4 DMT22640
         XR    R5,R5               Running total of hdr size   SML2NJE4 DMT22650
RDLOPA   EQU   *                                               SML2NJE4 DMT22660
         LA    R0,XJE2VMDB         Code 08=VMDEBLOK               *XJE  DMT22670
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT22680
         BALR  R14,R15             Go get a line to send          *XJE  DMT22690
         LTR   R15,R15             Was it end-of-file?            *XJE  DMT22700
         BNZ   RDEOF               E-O-F                                DMT22710
RDLOPB   EQU   *                                                        DMT22720
         CLI   RCTOPCOD,X'03'      IS IT A TAG RECORD                   DMT22730
         BNE   RDNOTNOP            Not a NOP record            SML2NJE4 DMT22740
         CLI   RCTTDTA1+1,C' '     Tag etc will be printable   SML2NJE4 DMT22750
         BNL   RDLOOP              Ignore tag NOP record       SML2NJE4 DMT22760
         LA    R4,RCTTDTA1+1       PRT/PUN data from VMDEBLOK  SML2NJE4 DMT22770
         USING NJEPDSEC,R4         Use R4 for NJEP* locations  SML2NJE4 DMT22780
         LA    R8,RCTTANK1+1       For TANKDATA in COPYSEGM    SML2NJE4 DMT22790
         XR    R1,R1               Clear R1 for ICM            SML2NJE4 DMT22800
         ICM   R1,B'0011',NJEPLEN  Get segment length          SML2NJE4 DMT22810
         SH    R1,=AL2(NJEPSIZE)   Reduce by seg. prefix len.  SML2NJE4 DMT22820
         LR    R0,R2               Make temporary copy of ptr  SML2NJE4 DMT22830
         AR    R0,R1               Add length of segment       SML2NJE4 DMT22840
         CL    R0,ARNJEHND         Compare to end of buffer    SML2NJE4 DMT22850
         BNL   MSG928              Segment won't fit in buffer SML2NJE4 DMT22860
         BCTR  R1,0                Reduce by one for EX        SML2NJE4 DMT22870
         EX    R1,COPYSEGM         Copy the segment to buffer  SML2NJE4 DMT22880
         LA    R2,1(R1,R2)         +1. Update buffer pointer   SML2NJE4 DMT22890
         LA    R5,1(R1,R5)         Keep running total as well  SML2NJE4 DMT22900
         TM    NJEPSEQ,X'80'       Is this the last segment?   SML2NJE4 DMT22910
         BO    RDLOPA              No. Go get more segments.   SML2NJE4 DMT22920
         IC    R3,NJEPFLGS         Grab SRCB value to use      SML2NJE4 DMT22930
         ICM   R3,B'0010',RCTRCBT  Also grab RCB value to use  SML2NJE4 DMT22940
         L     R8,ARNJEHDR         Get address of first tank   SML2NJE4 DMT22950
         MVI   RNSEGNUM,0          Start at segment zero       SML2NJE4 DMT22960
RNJELOOP EQU   *                                               SML2NJE4 DMT22970
         LA    R4,TANKDATA-TANKDSEC(,R8) Address of seg prefix SML2NJE4 DMT22980
         LA    R5,NJEPSIZE(,R5)    Add len. of segment prefix  SML2NJE4 DMT22990
         LR    R6,R5               Get new segment size        SML2NJE4 DMT23000
         STH   R3,TANKRCB-TANKDSEC(,R8) Store Tank RCB & SRCB  SML2NJE4 DMT23010
         MVI   NJEPFLGS,0          Set segment flags           SML2NJE4 DMT23020
         MVC   NJEPSEQ,RNSEGNUM    Set segment number          SML2NJE4 DMT23030
         CH    R5,=H'256'          Is segment too long?        SML2NJE4 DMT23040
         BNH   RNJELNOK            Length is allowed           SML2NJE4 DMT23050
         LA    R6,256              Reduce segment len. to 256  SML2NJE4 DMT23060
         OI    NJEPSEQ,X'80'       Flag segment as not last    SML2NJE4 DMT23070
RNJELNOK EQU   *                                               SML2NJE4 DMT23080
         STH   R6,NJEPLEN          Put length in seg. header   SML2NJE4 DMT23090
         STH   R6,TANKCNT-TANKDSEC(,R8) Put length in tank     SML2NJE4 DMT23100
         L     R0,0(R6,R8)         Grab word after segment     SML2NJE4 DMT23110
         ST    R0,RNSAVE           Stash word across $PUT      SML2NJE4 DMT23120
         STM   R5,R6,RNSAVE+4      Stash lengths across $PUT   SML2NJE4 DMT23130
         ST    R8,RNSAVE+12        Stash segment address       SML2NJE4 DMT23140
         BAL   R14,$PUT            Write out segment           SML2NJE4 DMT23150
         L     R8,RNSAVE+12        Retrieve segment address    SML2NJE4 DMT23160
         LM    R5,R6,RNSAVE+4      Retrieve stashed lengths    SML2NJE4 DMT23170
         L     R0,RNSAVE           Retrieve stashed word       SML2NJE4 DMT23180
         ST    R0,0(R6,R8)         Restore word after segment  SML2NJE4 DMT23190
         IC    R1,RNSEGNUM         Get last segment number     SML2NJE4 DMT23200
         LA    R1,1(,R1)           Increment segment number    SML2NJE4 DMT23210
         STC   R1,RNSEGNUM         Store next segment number   SML2NJE4 DMT23220
         AR    R8,R6               Push past this segment      SML2NJE4 DMT23230
         SH    R8,=AL2(NJEPSIZE)   Leave space for next prefix SML2NJE4 DMT23240
         SR    R5,R6               Reduce total by segment len SML2NJE4 DMT23250
         BNZ   RNJELOOP            Go again if any remaining   SML2NJE4 DMT23260
         B     RDLOOP              Get next header or data     SML2NJE4 DMT23270
*                                                              SML2NJE4 DMT23280
MSG928   EQU   *                                               SML2NJE4 DMT23290
         L     R8,RDEVTAG          Get tag addressability      SML2NJE4 DMT23300
         LH    R0,TAGID            Get spool file id           SML2NJE4 DMT23310
         CVD   R0,AXSCVD           Convert spool id to BCD     SML2NJE4 DMT23320
         UNPK  AXSFILE,AXSCVD      Make number printable       SML2NJE4 DMT23330
         OI    AXSFILE+3,X'F0'     Ensure last digit is too    SML2NJE4 DMT23340
         MVC   AXSRECS,BLANK       Clear unused characters     SML2NJE4 DMT23350
         LH    R0,ARNJEHDR+NJEPSIZE+NJHGJID-NJHGDSEC Orig spid SML2NJE4 DMT23360
         CVD   R0,AXSCVD           Convert spool id to BCD     SML2NJE4 DMT23370
         UNPK  AXSRECS(4),AXSCVD   Make number printable       SML2NJE4 DMT23380
         OI    AXSRECS+3,X'F0'     Ensure last digit is too    SML2NJE4 DMT23390
         MSGX  928,(AXSFILE,AXSRECS,AXSLINK) Virtual storage   SML2NJE4 DMT23400
         OI    RDEVSOPT,HOLD+1     Specify hold/keep on close  SML2NJE4 DMT23410
         B     RDCLOSE             Go close file and give up   SML2NJE4 DMT23420
*                                                                       DMT23430
RDNOTNOP EQU   *                                               SML2NJE4 DMT23440
         TM    RSW1,UTRANS         ARE WE SENDING PUNCH OUTPUT?         DMT23450
         BNO   RDLOP0              NO CONTINUE                          DMT23460
         MVI   RCTTSRC1,X'80'      Reset punch SRCB after hdr  SML2NJE4 DMT23470
         MVC   RCTTCT1,=H'81'      Length for punch (+length)  SML2NJE4 DMT23480
         MVI   RCTTDTA1,80         Record length at beginning  SML2NJE4 DMT23490
RDLOP0   EQU   *                                                        DMT23500
         TM    RSW1,PTRANS         ARE WE SENDING PRINT?                DMT23510
         BNO   RDLOP1              NO OKAY TO PUT                       DMT23520
         LH    R8,RCTCCWCT         Get length of PRT data      SML2NJE4 DMT23530
         LA    R8,1(,R8)           Include CC byte in length   SML2NJE4 DMT23540
         STC   R8,RCTTDTA1         Record length byte to tank  SML2NJE4 DMT23550
         LA    R8,1(,R8)           Include record length byte  SML2NJE4 DMT23560
         STH   R8,RCTTCT1          Store tank length           SML2NJE4 DMT23570
         MVC   RCTTDTA1+1(1),RCTOPCOD Put opcode in tank (CC)  SML2NJE4 DMT23580
         MVI   RCTTSRC1,X'90'      SRCB for machine CC         SML2NJE4 DMT23590
         SPACE 1                                                        DMT23600
RDLOP1   EQU   *                                                        DMT23610
         LA    R8,RCTTANK1         GET THE TANK ADDRESS                 DMT23620
         BAL   R14,$PUT            AND WRITE THE TANK                   DMT23630
         CLI   RDRCMD,X'00'        ANY COMMAND PENDING?                 DMT23640
         BE    RDLOOP              NO CONTINUE                          DMT23650
         TM    RDRCMD,RBACKCNT     BACKSPAC COUNT?                      DMT23660
         BO    RBACKUP             YES PROCESS IT                       DMT23670
         TM    RDRCMD,RFWDCNT      FORWARD SPACE COUNT?                 DMT23680
         BO    RGOFWD              YES PROCESS IT                       DMT23690
         TM    RDRCMD,RBACKFIL     BACKSPAC FILE?                       DMT23700
         BO    RDBACKFL            GO DO IT                             DMT23710
         TM    RDRCMD,RFLSHALL     FLUSH ALL?                           DMT23720
         BNO   RDLOP3              NO CONTINUE                          DMT23730
         OI    RDEVSOPT,ALL        INDICATE FLUSH ALL IN RDR            DMT23740
         B     RDFLUSH        GO DO IT                         @VA04039 DMT23750
RDLOP3   EQU   *                                                        DMT23760
         TM    RDRCMD,RFLSHOLD     FLUSH AND HOLD?                      DMT23770
         BNO   RDCKFLSH       MIGHT BE FLUSH COPY              @VA03276 DMT23780
         OI    RDEVSOPT,HOLD       INDICATE FLUSH AND HOLD              DMT23790
         B     RDFLUSH        GO DO IT                         @VA04039 DMT23800
RDCKFLSH EQU   *                                               @VA03276 DMT23810
         TM    RDRCMD,RFLSHCPY FLUSH COPY?                     @VA03276 DMT23820
         BO    RDFLUSH        YES..GO DO IT                    @VA03276 DMT23830
         B     RDLOOP         CONTINUE                         @VA03276 DMT23840
         EJECT                                                          DMT23850
RDFLUSH  EQU   *                                                        DMT23860
         NI    RDRCMD,255-RFLSHALL-RFLSHOLD-RFLSHCPY RESET CMD BYTE     DMT23870
         MVC   MSGLINK(8),RDRCMDLK MOVE RESPONSE ID INTO MSG            DMT23880
         CLC   CMDFID(4),AXSFILE   RIGHT FILE?                          DMT23890
         BNE   RDFLSHER            NO..ERROR                            DMT23900
         MSGX  580,AXSFILE         WRITE THE FLUSH MSG                  DMT23910
         NI    RSW1,255-CLINE      No buffer present           SML2NJE4 DMT23920
         OI    RCTECB,TCTBUSY      Set reader busy for waiting SML2NJE4 DMT23930
         OI    RSW1,RINIT          Initial call has occurred   SML2NJE4 DMT23940
         MVC   RCTTCT1,=F'0'       Set end of file indicator   SML2NJE4 DMT23950
         MVC   RCTENTY(2),RACN6    Return if wait for buffers  SML2NJE4 DMT23960
RLOC6    EQU   *                                               SML2NJE4 DMT23970
         MVI   RCTWFB,X'00'        Reset waiting for buffer sw SML2NJE4 DMT23980
         LA    R8,RCTTANK1         Get tank address            SML2NJE4 DMT23990
         BAL   R14,$TPPUT          Put the tank                SML2NJE4 DMT24000
         BNZ   RDCLOSE             Go close RDR / purge file   SML2NJE4 DMT24010
         B     RDWAITBF            Go wait for buffer          SML2NJE4 DMT24020
         SPACE                                                          DMT24030
RDFLSHER EQU   *                                                        DMT24040
         MSGX  581,CMDFID          WRITE ERROR MSG                      DMT24050
         TM    RSW1,RWAITACK       Are we waiting for file ACK SML2NJE4 DMT24060
         BZ    RDLOOP              Not waiting. Go read more.  SML2NJE4 DMT24070
         NI    RDRCMD,255-RFLSHCPY+RFLSHALL+RFLSHOLD Clear cmd SML2NJE4 DMT24080
         B     RDWAIT              Go back to waiting for ACK  SML2NJE4 DMT24090
         EJECT                                                          DMT24100
RDEOF    EQU   *                                                        DMT24110
*                                                              SML2NJE4 DMT24120
*        Create NJE job trailer and send it after the file     SML2NJE4 DMT24130
*                                                              SML2NJE4 DMT24140
         TM    RSW1,SANDF          Is this store and fwd file? SML2NJE4 DMT24150
         BO    RNONJET             Skip sending NJE job trailerSML2NJE4 DMT24160
         L     R8,RDEVTAG          Get address of tag          SML2NJE4 DMT24170
         LA    R0,XJE3JEJT         Code for routine BLDNJEJT      *XJE  DMT24180
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT24190
         BALR  R14,R15             Build NJE job trailer       SML2NJE4 DMT24200
*                                                              SML2NJE4 DMT24210
         LA    R8,RCTTANK1         Get tank address            SML2NJE4 DMT24220
         BAL   R14,$PUT            Write the tank to tp buffer SML2NJE4 DMT24230
RNONJET  EQU   *                                               SML2NJE4 DMT24240
*                                                              SML2NJE4 DMT24250
         MVI   RCTTSRC1,X'80'      Reset SRCB for EOF record   SML2NJE4 DMT24260
RDEOF0   EQU   *                                                        DMT24270
         NI    RSW1,255-CLINE      NO BUFFER PRESENT                    DMT24280
         OI    RCTECB,TCTBUSY      SET READER BUSY FOR WAITING          DMT24290
         MVI   RCTWFB,X'00'        RESET WAITING FOR BUFFER SW          DMT24300
         OI    RSW1,RINIT          INITIAL CALL HAS OCCURED             DMT24310
         MVC   RCTTCT1,=F'0'       SET END OF FILE INDICATOR            DMT24320
         MVC   RCTENTY(2),RACN2                                         DMT24330
RLOC2    EQU   *                                                        DMT24340
         MVI   RCTWFB,X'00'   RESET WAITING FOR BUFFERS SW     @VA03306 DMT24350
         LA    R8,RCTTANK1         GET TANK ADDRESS                     DMT24360
         BAL   R14,$TPPUT          PUT THE TANK                         DMT24370
         BNZ   RDWFACK             Go wait for ACK             SML2NJE4 DMT24380
RDWAITBF MVI   RCTWFB,X'FF'        Show waiting for a buffer   SML2NJE4 DMT24390
RDWAIT   EQU   *                   Go wait in general          SML2NJE4 DMT24400
         L     R8,RCTCOM           GET COMMUTATOR ENTRY                 DMT24410
         MVI   1(R8),CLOSE         AND CLOSE THE GATE                   DMT24420
         B     RCTRTN              GO WAIT FOR A BUFFER                 DMT24430
         EJECT                                                          DMT24440
RDBACKFL EQU   *                                                        DMT24450
         USING SPLINK,R1           GET SPLINK ADDRESSABILITY            DMT24460
         L     R1,RDEVFIOA         GET FILE I/O AREA ADDRESS            DMT24470
         L     R8,RDEVTAG          GET TAG ADDRESS                      DMT24480
         LH    R2,TAGDEV           GET READER ADDRESS                   DMT24490
         LA    R3,X'14'            INDICATE BACKSPACE FILE              DMT24500
*********DIAG  R1,R2,X'14'         COMMAND SPOOL READER                 DMT24510
RDBKFIL1 EQU   *                                                        DMT24520
         NI    RSW1,255-CLINE      INDICATE BLOCK NOT PRESENT           DMT24530
RDBKFIL2 EQU   *                                                        DMT24540
         LA    R8,RDLOOP           INDICATE RETURN POINT                DMT24550
RDBKMSG  EQU   *                                                        DMT24560
         MVC   MSGLINK(8),RDRCMDLK MOVE IN RESPONSE LINKID              DMT24570
         MSGX  510,AXSFILE         WRITE BACKSPAC MSG                   DMT24580
         NI    RDRCMD,255-RBACKFIL-RBACKCNT RESET CMD FLAGS             DMT24590
         BR    R8                  AND CONTINUE                         DMT24600
         EJECT                                                          DMT24610
RBACKUP  EQU   *                                                        DMT24620
         L     R1,RDEVFIOA         GET FIOA ADDR                        DMT24630
         L     R8,RDEVTAG          GET READER TAG ADDRESS               DMT24640
         L     R3,SPRECNUM         AND NUMBER OF RECORDS                DMT24650
         S     R3,VMSPNUM          SUBSTRACT WHATS LEFT                 DMT24660
         BZ    RDBKPAGA            ALL DONE WITH THIS PAGE              DMT24670
         LA    R4,SPRECNUM+4       GET DATA ADDR                        DMT24680
         ST    R4,VMSPANCH         STORE ANCHOR FOR UNPACK              DMT24690
         ST    R4,VMSPNEXT         AND THE NEXT DATA STRING             DMT24700
         ST    R3,VMSPNUM          STORE THE NEW COUNT                  DMT24710
         OI    RSW1,CLINE         FILE ALREADY HERE           @VA10237  DMT24720
         TM    TAGINDEV,TYPPUN     IS IT A PUNCH FILE?                  DMT24730
         BNO   RBACKCN2            NO..MUST BE PRINT                    DMT24740
         L     R3,VMSPNUM          GET THE CURRENT COUNT                DMT24750
         B     RBACKCN3            AND CONTINUE                         DMT24760
         SPACE 1                                                        DMT24770
RBACKCN1 EQU   *                                                        DMT24780
         LPR   R3,R3               MAKE POSITIVE                        DMT24790
         ST    R3,RDRCMDCT         UPDATE NUMBER OF BACKS               DMT24800
RDBKPAGA EQU   *                                                        DMT24810
         BAL   R14,RDBKPAGE        GO BACKPAGE                          DMT24820
RBACKCN2 EQU   *                                                        DMT24830
         TM    TAGINDEV,TYPPRT     IS IT A PRINT FILE?                  DMT24840
         BO    RCNTSKP             YES..MUST SKIP PAGES NOT RECS        DMT24850
         L     R3,SPRECNUM         GET THE NEW NUM OF RECORDS           DMT24860
RBACKCN3 EQU   *                                                        DMT24870
         S     R3,RDRCMDCT         SUBSTRACT NEW NUM                    DMT24880
         LTR   R3,R3               ARE WE DONE?                         DMT24890
         BNP   RBACKCN1            NO CONTINUE                          DMT24900
         BAL   R14,RDBKPCON        RESET TO BEGINNING OF PAGE           DMT24910
RBACKSK  EQU   *                                                        DMT24920
         LA    R0,XJE2VMDB         Code 08=VMDEBLOK               *XJE  DMT24930
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT24940
         BALR  R14,R15             Go get a record                *XJE  DMT24950
         TM    TAGINDEV,TYPPUN     IS IT A PUNCH FILE?                  DMT24960
         BO    RBACKDWN            YES COUNT ALL                        DMT24970
         CLI   RCTOPCOD,X'89'      PRINT AND SKIP TO CHAN 1?            DMT24980
         BE    RBACKDWN            YES COUNT IT                         DMT24990
         CLI   RCTOPCOD,X'8B'      IMMED SKIP TO CHAN 1?                DMT25000
         BNE   RBACKSK             NO TRY ANOTHER                       DMT25010
RBACKDWN EQU   *                                                        DMT25020
         BCT   R3,RBACKSK          DOWN BY ONE                          DMT25030
         LA    R8,RDLOPB           INDICATE RETURN POINT                DMT25040
         CLI   RCTOPCOD,X'8B'      IS IT A SKIP IMMED?                  DMT25050
         BE    RDBKMSG             YES..CONTINUE                        DMT25060
         MVI   RCTOPCOD,X'8B'      MAKE IT A SKIP IMMED..               DMT25070
         MVI   RCTTDTA1,C' '       AND ONE CHAR OF DATA                 DMT25080
         LA    R1,1                ONE BYTE OF DATA                     DMT25090
         STH   R1,RCTCCWCT         AND STORE IN CCW                     DMT25100
         B     RDBKMSG             ALL DONE                             DMT25110
         EJECT                                                          DMT25120
RCNTSKP  EQU   *                                                        DMT25130
         SR    R3,R3               ZERO OUT ACCUMLATOR                  DMT25140
RCNTSKP1 EQU   *                                                        DMT25150
         LA    R0,XJE2VMDB         Code 08=VMDEBLOK               *XJE  DMT25160
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT25170
         BALR  R14,R15             Go get a record                *XJE  DMT25180
         CLI   RCTOPCOD,X'89'      PRINT AND SKIP TO CHANNEL 1?         DMT25190
         BE    RCNTSKPC            YES COUNT IT                         DMT25200
         CLI   RCTOPCOD,X'8B'      IMMED SKIP TO CHANNEL 1?             DMT25210
         BE    RCNTSKPC            YES COUNT IT                         DMT25220
RCNTSKPX EQU   *                                                        DMT25230
         ICM   R0,B'1111',VMSPNUM  ALL DONE WITH PAGE?                  DMT25240
         BNZ   RCNTSKP1            NO CONTINUE                          DMT25250
         B     RBACKCN3            BR BACK TO MAIN CODE                 DMT25260
         SPACE 1                                                        DMT25270
RCNTSKPC EQU   *                                                        DMT25280
         LA    R3,1(,R3)           UP SKIP COUNT BY 1                   DMT25290
         B     RCNTSKPX            AND JOIN COMMON CODE                 DMT25300
         SPACE 1                                                        DMT25310
RDBKPAGE EQU   *                   BACK UP A PAGE SUBROUTINE            DMT25320
         STM   R0,R15,VMDESAVE     MIGHT AS WELL SAVE THEM ALL          DMT25330
         L     R1,RDEVFIOA         GET FILE I/O AREA ADDRESS            DMT25340
         L     R8,RDEVTAG          GET TAG ADDRESS                      DMT25350
         LH    R2,TAGDEV           GET READER ADDRESS                   DMT25360
         LA    R3,X'18'            INDICATE BACKSPACE PAGE              DMT25370
*********DIAG  R1,R2,X'14'         COMMAND SPOOL READER                 DMT25380
         BC    4,RDBKPAG2          ALL DONE BEGINNING OF FILE           DMT25390
RDBKPAG1 EQU   *                                                        DMT25400
         L     R8,SPRECNUM         PICKUP SPRECNUM FROM NEW BLOCK       DMT25410
         ST    R8,VMSPNUM          PICKUP COUNT OF REMAINING CCWS       DMT25420
         LA    R8,SPRECNUM+4       SETP OVER POINTERS IN SPOOL BLOCK    DMT25430
         ST    R8,VMSPANCH         TO PICKUP CURRENT CCW ANCHOR         DMT25440
         ST    R8,VMSPNEXT         CCW POINTER AND NEXT                 DMT25450
         OI    RSW1,CLINE          TO INDICATE BLOCK PRESENT            DMT25460
         LM    R0,R15,VMDESAVE     RESTORE REGS                         DMT25470
         BR    R14                 AND RETURN                           DMT25480
         SPACE 1                                                        DMT25490
RDBKPAG2 EQU   *                                                        DMT25500
         LA    R14,RDBKFIL2        SET RETURN POINT                     DMT25510
         SPACE 1                                                        DMT25520
RDBKPCON EQU   *                                                        DMT25530
         STM   R0,R15,VMDESAVE     SAVE REGISTERS                       DMT25540
         B     RDBKPAG1            AND SIMULATE A PAGE BACK             DMT25550
         EJECT                                                          DMT25560
RGOFWD   EQU   *                                                        DMT25570
         L     R1,RDRCMDCT         GET FWD COUNT                        DMT25580
         L     R8,RDEVTAG          AND THE TAG ADDR                     DMT25590
RGOFWDLP EQU   *                                                        DMT25600
         LA    R0,XJE2VMDB         Code 08=VMDEBLOK               *XJE  DMT25610
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT25620
         BALR  R14,R15             Go get a record                *XJE  DMT25630
         LTR   R15,R15             Was it end-of-file?            *XJE  DMT25640
         BNZ   RDGODNE             ALL DONE EOF                         DMT25650
         TM    TAGINDEV,TYPPUN     IS IT A PUNCH FILE?                  DMT25660
         BO    RGOCNT              COUNT ALL RECORDS                    DMT25670
         CLI   RCTOPCOD,X'89'      PRINT AND SKIP TO CHANNEL 1?         DMT25680
         BE    RGOCNT              YES COUNT IT                         DMT25690
         CLI   RCTOPCOD,X'8B'      IMMED SKIP TO CHANNEL 1?             DMT25700
         BNE   RGOFWDLP            NO..CONTINUE                         DMT25710
RGOCNT   EQU   *                                                        DMT25720
         BCT   R1,RGOFWDLP         REDUCE REC CNT BY 1 AND CONT         DMT25730
RDGODNE  EQU   *                                                        DMT25740
         CLI   RCTOPCOD,X'8B'      IS IT A SKIP IMMED?                  DMT25750
         BE    RDFWMSG             YES..CONTINUE                        DMT25760
         MVI   RCTOPCOD,X'8B'      MAKE IT A SKIP IMMED..               DMT25770
         MVI   RCTTDTA1,C' '       AND ONE CHAR OF DATA                 DMT25780
         LA    R1,1                ONE BYTE OF DATA                     DMT25790
         STH   R1,RCTCCWCT         AND STORE IN CCW                     DMT25800
RDFWMSG  EQU   *                                                        DMT25810
         MVC   MSGLINK(8),RDRCMDLK MOVE IN RESPONSE LINKID              DMT25820
         MSGX  600,AXSFILE         WRITE FWD SPAC MSG                   DMT25830
         NI    RDRCMD,255-RFWDCNT  RESET CMD BYTE                       DMT25840
         CLI   RCTOPCOD,X'8B'      IS IT A SKIP IMMED?                  DMT25850
         BE    RDLOPB              YES..CONTINUE                        DMT25860
         MVI   RCTOPCOD,X'8B'      MAKE IT A SKIP IMMED..               DMT25870
         MVI   RCTTDTA1,C' '       AND ONE CHAR OF DATA                 DMT25880
         LA    R1,1                ONE BYTE OF DATA                     DMT25890
         STH   R1,RCTCCWCT         AND STORE IN CCW                     DMT25900
         B     RDLOPB              AND CONTINUE                         DMT25910
         DROP  R1                                                       DMT25920
         EJECT                                                          DMT25930
RDERR1   EQU   *                                                        DMT25940
         NI    RCTECB,X'FF'-TCTBUSY  TURN OFF RDR ECB BUSY    @VA10416  DMT25950
         TM    RSW1,RACTIV         WAS A FILE EVER OPENED?              DMT25960
         BNO   RDERR2              NO..EXIT AGAIN                       DMT25970
         TM    RSW1,RINIT          HAS READER BEEN CALLED ONCE?         DMT25980
         BNO   RDERR2              NOPE                                 DMT25990
         MVC   RCTTCT1,=F'0'       SET END OF FILE INDICATOR            DMT26000
         MVC   RCTENTY(2),RACN3    PREPARE FOR REJECT ON SENDING        DMT26010
RLOC3    EQU   *                                                        DMT26020
         LA    R8,RCTTANK1         PUT TANK ADDR IN PARAMETER REG       DMT26030
         BAL   R14,$TPPUT          SEND EOF SIGNAL                      DMT26040
         BNZ   RDERR2              OPEN WENT OK...CONTINUE              DMT26050
         B     RDWAITBF            Go wait for buffer          SML2NJE4 DMT26060
         SPACE 1                                                        DMT26070
RDERR2   EQU   *                                                        DMT26080
         MVI   RCTWFB,X'00'   RESET WAITING FOR BUFFERS SW     @VA03306 DMT26090
         OI    RSW1,RINIT          INITIAL CALL OVER                    DMT26100
         MVC   RCTENTY(2),RACN4    SETUP FOR DELAY                      DMT26110
         NI    MASTERSW,255-READER INDICATE READER CLOSED               DMT26120
         NI    RSW1,255-RACTIV     INDICATE NO READER ACTIVE            DMT26130
         B     RDWAIT              Go wait                     SML2NJE4 DMT26140
         EJECT                                                          DMT26150
RREOPEN  EQU   *                                                        DMT26160
         MVC   RCTENTY(2),RACN5    SETUP FOR DELAY                      DMT26170
         B     RDWAITBF            Go wait for buffer          SML2NJE4 DMT26180
         SPACE 1                                                        DMT26190
RLOC5    EQU   *                                                        DMT26200
         MVI   RCTWFB,X'00'        RESET WAITING FOR BUFFER             DMT26210
         B     ROPEN               GO TRY REOPEN                        DMT26220
RDWFACK  EQU   *                                               SML2NJE4 DMT26230
         MVC   RCTENTY(2),RACN7    Set up for re-entry         SML2NJE4 DMT26240
         OI    RSW1,RWAITACK       Flag waiting for ACK        SML2NJE4 DMT26250
         B     RDWAIT              Go wait for ACK             SML2NJE4 DMT26260
RLOC7    EQU   *                                               SML2NJE4 DMT26270
         CLI   RDRCMD,RFLSHCPY+RFLSHALL+RFLSHOLD We flushing?  SML2NJE4 DMT26280
         BNE   RDNOFLSH            Not flushing                SML2NJE4 DMT26290
         MVC   MSGLINK(8),RDRCMDLK Move response dest into msg SML2NJE4 DMT26300
         CLC   CMDFID(4),AXSFILE   Right file? (wrong var!)    SML2NJE4 DMT26310
         BNE   RDFLSHER            Wrong file too.             SML2NJE4 DMT26320
         TM    RDRCMD,RFLSHALL     Flushing all files?         SML2NJE4 DMT26330
         BZ    RDNFLALL            Not flushing all files      SML2NJE4 DMT26340
         OI    RDEVSOPT,ALL        Specify flush all files     SML2NJE4 DMT26350
RDNFLALL EQU   *                                               SML2NJE4 DMT26360
         TM    RDRCMD,RFLSHOLD     Flush file and hold?        SML2NJE4 DMT26370
         BZ    RDNFLHLD            Not flush and hold          SML2NJE4 DMT26380
         OI    RDEVSOPT,HOLD       Specify flush and hold      SML2NJE4 DMT26390
RDNFLHLD EQU   *                                               SML2NJE4 DMT26400
         NI    RDRCMD,255-RFLSHALL-RFLSHOLD-RFLSHCPY Reset cmd SML2NJE4 DMT26410
         NI    RSW1,255-RWAITACK   Clear waiting for ACK flag  SML2NJE4 DMT26420
         MSGX  580,AXSFILE         File $ processing terminatedSML2NJE4 DMT26430
         B     RDCLOSE             Go close RDR / spool file   SML2NJE4 DMT26440
RDNOFLSH EQU   *                                               SML2NJE4 DMT26450
         TM    RSW1,RWAITACK       Still waiting for ACK?      SML2NJE4 DMT26460
         BO    RDWAIT              Go and wait some more       SML2NJE4 DMT26470
         MSGX  147,(AXSFILE,AXSLINK) Write sent message        SML2NJE4 DMT26480
RDCLOSE  EQU   *                                               SML2NJE4 DMT26490
         LA    R0,XJE2AXSP         Code 00=AXSPURGE               *XJE  DMT26500
         L     R15,=A(DMTXJE2)     -> external routines csect     *XJE  DMT26510
         BALR  R14,R15             Purge spool file               *XJE  DMT26520
         NI    RSW1,255-RINIT-PTRANS-UTRANS-SANDF Ditch flags  SML2NJE4 DMT26530
         NI    MASTERSW,255-READER Turn off reader active      SML2NJE4 DMT26540
         B     READ1               Go get another file         SML2NJE4 DMT26550
         SPACE 1                                                        DMT26560
CLINE    EQU   X'80'               BLOCK PRESENT IN DEBLOCK BUFFER      DMT26570
RINIT    EQU   X'40'               INITIAL CALL HAS BEEN MADE           DMT26580
RACTIV   EQU   X'20'               READER ACTIVE                        DMT26590
PTRANS   EQU   X'10'               TRANSMITTING PRINT FILE              DMT26600
UTRANS   EQU   X'08'               TRANSMITTING PUNCH FILE              DMT26610
HEADFLAG EQU   X'04'               TRANSMITTING HEADER                  DMT26620
SANDF    EQU   X'02'               Store and forward file      SML2NJE4 DMT26630
RWAITACK EQU   X'01'               Waiting for file sent ACK   SML2NJE4 DMT26640
         SPACE 1                                                        DMT26650
RACN1    DC    S(RLOC1)            RETURN ENTRY POINT                   DMT26660
RACN2    DC    S(RLOC2)            RETURN ENTRY POINT                   DMT26670
RACN3    DC    S(RLOC3)            RETURN ENTRY POINT                   DMT26680
RACN4    DC    S(READ1)            RETURN ENTRY POINT                   DMT26690
RACN5    DC    S(RLOC5)            RETURN ENTRY POINT                   DMT26700
RACN6    DC    S(RLOC6)            Return entry point          SML2NJE4 DMT26710
RACN7    DC    S(RLOC7)            Return entry point          SML2NJE4 DMT26720
         EJECT                                                          DMT26730
*.                                                                      DMT26740
*                                                                       DMT26750
* ENTRY NAME -                                                          DMT26760
*                                                                       DMT26770
*        $WRTN1                                                         DMT26780
*                                                                       DMT26790
* FUNCTION -                                                            DMT26800
*                                                                       DMT26810
*        THIS ROUTINE WILL WRITE RECEIVED MSGS TO THE RSCS              DMT26820
*        OPERATOR IF RJE MODE OR PASS COMMANDS TO DMTREX FOR            DMT26830
*        EXECUTION IF OPERATING IN HOST MODE.  THESE COMMANDS OR        DMT26840
*        MESSAGES ARE DEQUEUED FROM THE CONSOLE TCT.                    DMT26850
*                                                                       DMT26860
* CALLS TO OTHER ROUTINES -                                             DMT26870
*                                                                       DMT26880
*        DMTWAT - TO WAIT FOR AN EVENT COMPLETION                       DMT26890
*        DMTGIV - TO INITIATE A GIVE REQUEST                            DMT26900
*                                                                       DMT26910
* OPERATION -                                                           DMT26920
*                                                                       DMT26930
*        1. GET A RECEIVED TANK VIA CALL TO $GETTNK                     DMT26940
*                                                                       DMT26950
*        2. IF HOST MODE TREAT LIKE COMMAND AND PASS TO DMTREX          DMT26960
*           FOR EXECUTION.                                              DMT26970
*                                                                       DMT26980
*        3. IF RJE MODE TREAT LIKE MSG AND WRITE MSG 170.               DMT26990
*                                                                       DMT27000
*        4. FREE THE TANK AND EXIT TO COMMUTATOR.                       DMT27010
*                                                                       DMT27020
* RESPONSES -                                                           DMT27030
*                                                                       DMT27040
*        DMTXJE170I  FROM 'LINKID':  (MSG TEXT)                HRC000DT DMT27050
*                                                                       DMT27060
* ERROR MESSAGES -                                                      DMT27070
*                                                                       DMT27080
*        NONE                                                           DMT27090
*                                                                       DMT27100
*.                                                                      DMT27110
         SPACE 3                                                        DMT27120
         USING TANKDSEC,R8         GET TANK ADDRESSABILITY              DMT27130
$WRTN1   DS    0H                                                       DMT27140
WINIT    DS    0H                  CONSOLE LOOP ENTRY POINT             DMT27150
         MVI   $WCOMM1+1,CLOSE     CLOSE THE GATE                       DMT27160
WTANKTST EQU   *                                                        DMT27170
         CLI   WCTTNKCT,0          TEST FOR TANK                        DMT27180
         BNE   WGETTANK            IF WE HAVE ONE GET IT                DMT27190
         MVC   WCTENTY(2),WACN1    SET UP FOR WAIT                      DMT27200
         B     WCTRTN              AND EXIT                             DMT27210
         EJECT                                                          DMT27220
WGETTANK EQU   *                                                        DMT27230
         BAL   R14,$GETTNK         WAIT FOR THE NEXT TANK               DMT27240
         LH    R6,TANKCNT          GET DATA COUNT                       DMT27250
         CH    R6,=H'30'           Is tank big enough for NMR? SML2NJE4 DMT27260
         BL    WGETRET             No use. Free tank, return   SML2NJE4 DMT27270
         CLC   TANKDATA+4(8),LOCATION Is NMR for this node?    SML2NJE4 DMT27280
         BE    WFORHERE            Message or command for here SML2NJE4 DMT27290
         LA    R1,TANKDATA+4       Get address of destination  SML2NJE4 DMT27300
WGETLINK EQU   *                                               SML2NJE4 DMT27310
*        MSGX  302
         LA    R0,8                Get length of destination   SML2NJE4 DMT27320
         LA    R2,302              Code for link is not definedSML2NJE4 DMT27330
         LR    R3,R1               Stash destination address   SML2NJE4 DMT27340
         LA    R13,COMSAVE         Get common save area        SML2NJE4 DMT27350
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE4 DMT27360
         L     R15,GLINKREQ        Get address of routine      SML2NJE4 DMT27370
         BALR  R14,R15             Call routine to find link   SML2NJE4 DMT27380
         LTR   R15,R15             Link to destination found?  SML2NJE4 DMT27390
         BNZ   WTRYROUT            No direct link. Route maybe?SML2NJE4 DMT27400
         USING LINKTABL,R1                                     SML2NJE4 DMT27410
         TM    LFLAG,LCONNECT      Is link connected?          HRC031DT DMT27420
         BO    WGOTLINK            Link is active              SML2NJE4 DMT27430
         DROP  R1                                              SML2NJE4 DMT27440
*        MSGX  303
         LA    R2,303              Code for link is not active SML2NJE4 DMT27450
         LR    R1,R3               Restore destination address SML2NJE4 DMT27460
WTRYROUT EQU   *                                               SML2NJE4 DMT27470
         LA    R0,8                Get length of destination   SML2NJE4 DMT27480
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE4 DMT27490
         L     R15,GROUTREQ        Get address of routine      SML2NJE4 DMT27500
         BALR  R14,R15             Look up route to destinationSML2NJE4 DMT27510
         LTR   R15,R15             Was route found?            SML2NJE4 DMT27520
         BNZ   WRTERROR            Routing error encountered   SML2NJE4 DMT27530
**DEL    USING RTE,R1                                             *XJE  DMT27540
**DEL    LA    R1,ROUTNEXT         Get address of next node       *XJE  DMT27550
**DEL    DROP  R1                                                 *XJE  DMT27560
* R1 contains selected link on return from GROUTREQ               *XJE
         B     WGETLINK            Got route. Now get link.    SML2NJE4 DMT27570
WRTERROR EQU   *                                               SML2NJE4 DMT27580
         STH   R2,WERRCODE         Save error code             SML2NJE4 DMT27590
         MVC   WERRLINK,0(R1)      Copy link name to error msg SML2NJE4 DMT27600
         LA    R1,WERRCODE         Get address of error block  SML2NJE4 DMT27610
         LA    R0,4+8              Fixed + variable block size SML2NJE4 DMT27620
         BAL   R14,MSG             Issue failure message       SML2NJE4 DMT27630
         B     WGETRET             Free tank and return        SML2NJE4 DMT27640
WGOTLINK EQU   *                                               SML2NJE4 DMT27680
         USING LINKTABL,R1                                     SML2NJE4 DMT27690
         L     R0,LTCBA            Get task id                    *XJE  DMT27700
         DROP  R1                                              SML2NJE4 DMT27710
         LH    R1,TANKCNT          Get size of data in tank    SML2NJE4 DMT27720
         LA    R1,3(,R1)           Plus length, function etc   SML2NJE4 DMT27730
         STC   R1,TANKRCB          Store message element lengthSML2NJE4 DMT27740
         MVI   TANKSRCB,NMR        Code for NMR - HACK!        SML2NJE4 DMT27750
         MVI   TANKCNT+1,NMR       Code for NMR - HACK!        SML2NJE4 DMT27760
         LA    R1,TANKRCB          Get message element address SML2NJE4 DMT27770
         L     R15,ALERTREQ        Get address of routine      SML2NJE4 DMT27780
         BALR  R14,R15             Tell link driver about NMR  SML2NJE4 DMT27790
         B     WGETRET             Free tank and return        SML2NJE4 DMT27800
WFORHERE EQU   *                                               SML2NJE4 DMT27810
         TM    TANKDATA,NMRFLAGC   Is this a msg or a command? SML2NJE4 DMT27820
         BNO   WGET2               It is a message             SML2NJE4 DMT27830
WGET1    EQU   *                                                        DMT27840
         SH    R6,=H'30'           Subtract length of NMR hdr  SML2NJE4 DMT27850
         LTR   R1,R6               SAVE FOR MSG PROCESSOR               DMT27860
         BZ    WGET1A              NULL CMD                             DMT27870
         BCTR  R6,0                REDUCE BY 1 FOR EXECUTE              DMT27880
         EX    R6,WTOMOV           MOVE INTO OUTPUT BUFFER              DMT27890
WGET1A   EQU   *                                                        DMT27900
         LA    R1,4+8+8-1(,R1)     Include length of header    HRC016DT DMT27910
         STC   R1,WTOMBUF          AND STORE IN GIVE REQUEST BUF        DMT27920
         MVC   WTOMNODE,TANKDATA+21 Copy command source node   SML2NJE4 DMT27930
         MVC   WTOMUSER,TANKDATA+13 Copy command source userid SML2NJE4 DMT27940
         XC    WTOMCMD(4),WTOMCMD  CLEAR OUT SYNCH LOCK                 DMT27950
         LA    R1,WTOMCMD          GET BUFFER ADDR                      DMT27960
         L     R15,GIVEREQ         GET GIVE REQUEST PROCESSOR           DMT27970
         BALR  R14,R15             AND EXECUTE IT                       DMT27980
*********L     R15,WAITREQ         SYSTEM WAIT PROCESSOR          *XJE  DMT27990
*********BALR  R14,R15             GO WAIT                        *XJE  DMT28000
         B     WGETRET             AND RETURN                           DMT28010
         SPACE 1                                                        DMT28020
WGET2    EQU   *                                                        DMT28030
         SH    R6,=H'30'           Subtract length of NMR hdr  SML2NJE4 DMT28040
         MVI   MSGBLK+2,X'80'      Send message to console onlySML2NJE4 DMT28050
         TM    TANKDATA,NMRFLAGT   Destination userid present? SML2NJE4 DMT28060
         BZ    WGET3               Skip over copying userid    SML2NJE4 DMT28070
         MVC   MSGVMID,TANKDATA+13 Copy destination userid     SML2NJE4 DMT28080
         MVI   MSGBLK+2,X'A0'      Send to console and userid  SML2NJE4 DMT28090
WGET3    EQU   *                                               SML2NJE4 DMT28100
         MVI   WTORJMSG+1,170      Assume we are using MSG 170 SML2NJE4 DMT28110
         TM    TANKDATA+2,NMRTYPE4 Source userid present?      SML2NJE4 DMT28120
         BNO   WGET3A              Use MSG 170                 SML2NJE4 DMT28130
         MVI   WTORJMSG+1,171      Change MSG number to 171    SML2NJE4 DMT28140
WGET3A   EQU   *                                               SML2NJE4 DMT28150
         CH    R6,=H'104'     MSG LONGER THAN 104?             @VA03305 DMT28160
         BNH   *+8            NO, OK                           @VA03305 DMT28170
         LA    R6,104         MAKE LENGTH A MAX OF 104         @VA03305 DMT28180
         MVC   WTORJMSG+4(8),TANKDATA+21 Copy msg source node  SML2NJE4 DMT28190
         LTR   R1,R6               Save for later              SML2NJE4 DMT28200
         BZ    WGET4               Skip move if zero length    SML2NJE4 DMT28210
         BCTR  R6,0                REDUCE BY ONE FOR MVC                DMT28220
         EX    R6,WTOMOV1          EXECUTE THE MOVE                     DMT28230
WGET4    EQU   *                                               SML2NJE4 DMT28240
         LA    R1,7(R1)            ROUND UP TO EVEN                     DMT28250
         SRL   R1,3                8 BYTE                               DMT28260
         SLL   R1,3                BOUNDARY                             DMT28270
         LA    R1,12(,R1)          Up for header               HRC001DT DMT28280
         LR    R0,R1               MOVE INTO R1                         DMT28290
         LA    R1,WTORJMSG         GET MSG ADDR                         DMT28300
         BAL   R14,MSG             AND WRITE THE MSG                    DMT28310
         MVI   WTORJBUF,C' '       BLANK FIRST BYTE                     DMT28320
         MVC   WTORJBUF+1(119),WTORJBUF AND THE REST                    DMT28330
WGETRET  EQU   *                                                        DMT28340
         MVC   0(4,R8),$TANKPOL    GET FIRST FREE OFF QUEUE             DMT28350
         ST    R8,$TANKPOL         MAKE THIS ONE THE FIRST              DMT28360
         MVI   $TPGETCM+1,OPEN     OPEN TPGET GATE                      DMT28370
         B     WINIT               GET THE NEXT LINE FOR OUTPUT         DMT28380
         EJECT                                                          DMT28390
WTOMOV   MVC   WTOBUF(0),TANKDATA+30  To be executed by above  SML2NJE4 DMT28400
WTOMOV1  MVC   WTORJBUF(0),TANKDATA+30 To be executed by above SML2NJE4 DMT28410
         EJECT                                                          DMT28420
*.                                                                      DMT28430
*                                                                       DMT28440
* ENTRY NAME -                                                          DMT28450
*                                                                       DMT28460
*        CMDPROC                                                        DMT28470
*                                                                       DMT28480
* FUNCTION -                                                            DMT28490
*                                                                       DMT28500
*        THIS ROUTINE EXECUTES COMMANDS PASSED TO IT IN THE             DMT28510
*        CMDRESP BUFFER AFTER AN ALERT FROM DMTREX INDICATING A         DMT28520
*        CMD HAS BEEN ENTERED.                                          DMT28530
*                                                                       DMT28540
* CALLS TO OTHER ROUTINES -                                             DMT28550
*                                                                       DMT28560
*        NONE                                                           DMT28570
*                                                                       DMT28580
* OPERATION -                                                           DMT28590
*                                                                       DMT28600
*        1. SCAN COMMAND TABLE FOR MATCH.                               DMT28610
*                                                                       DMT28620
*        2. IF FOUND BRANCH TO APPROPRIATE SUBROUTINE TO PROCESS        DMT28630
*           COMMAND.                                                    DMT28640
*                                                                       DMT28650
*        3. UPON RETURN RESET COMMAND IN PROGRESS SWITCH AND RETURN.    DMT28660
*                                                                       DMT28670
* RESPONSES -                                                           DMT28680
*                                                                       DMT28690
*        SEE EACH SUBROUTINE                                            DMT28700
*                                                                       DMT28710
* ERROR MESSAGES -                                                      DMT28720
*                                                                       DMT28730
*        SEE EACH SUBROUTINE                                            DMT28740
*                                                                       DMT28750
*.                                                                      DMT28760
         SPACE 3                                                        DMT28770
         DS    0H                                                       DMT28780
CMDPROC  EQU   *                                                        DMT28790
         MVI   $CMDCOM+1,CLOSE     CLOSE GATE                           DMT28800
         LM    R3,R5,CMDSETUP      PREPARE FOR COMMAND SCAN             DMT28810
CMDSCAN  EQU   *                                                        DMT28820
         CLC   0(1,R3),CMDRESP+1   IS IT THIS ONE                       DMT28830
         BE    CMDCALL             YES                                  DMT28840
         BXLE  R3,R4,CMDSCAN       PREPARE FOR NEXT COMPARE             DMT28850
         B     CMDRET              IGNORE IF NOT FOUND                  DMT28860
         SPACE                                                          DMT28870
CMDCALL  EQU   *                                                        DMT28880
         L     R6,XJELINK          Get link table address      HRC000DT DMT28890
         USING LINKTABL,R6         Link table addressability   SML2NJE3 DMT28900
         MVC   MSGLINK(8),CMDRESP+4 MOVE IN RESPONSE LINKID             DMT28910
         MVC   MSGVMID(8),CMDRESP+12 Origin userid of command  HRC017DT DMT28920
         L     R15,0(R3)           GET ROUTINE TO CALL                  DMT28930
         BALR  R14,R15             GO EXECUTE THE COMMAND               DMT28940
CMDRET   EQU   *                                                        DMT28950
         MVI   CMDINPGS,X'00'      RESET COMMAND IN PROGRESS SWITCH     DMT28960
         B     $CMDCOM+4           AND EXIT                             DMT28970
         EJECT                                                          DMT28980
*---------------------------------------------------------------------* DMT28990
*                          START COMMAND                              * DMT29000
*---------------------------------------------------------------------* DMT29010
*.                                                                      DMT29020
* RESPONSES -                                                           DMT29030
*                                                                       DMT29040
*        DMTXJE752I  LINK 'LINKID' STILL ACTIVE -- DRAIN       HRC000DT DMT29050
*                  STATUS RESET                                HRC000DT DMT29060
*                                                                       DMT29070
* ERROR MESSAGES -                                                      DMT29080
*                                                                       DMT29090
*        DMTXJE750E  LINK 'LINKID' ALREADY ACTIVE -- NO ACTION HRC000DT DMT29100
*                                                                       DMT29110
*.                                                                      DMT29120
         SPACE 1                                                        DMT29130
SETSTART EQU   *                                                        DMT29140
         ST    R14,CMDCMDSV        SAVE RETURN REG                      DMT29150
         TM    LFLAG,LDRAIN        ARE WE DRAINING?                     DMT29160
         BNO   SETSTRT1            NO                                   DMT29170
         NI    LFLAG,255-LDRAIN    RESET DRAIN FLAG                     DMT29180
         MSGX  752,AXSLINK         AND WRITE MSG                        DMT29190
         B     SETSTRTE            AND EXIT                             DMT29200
         SPACE 1                                                        DMT29210
SETSTRT1 EQU   *                                                        DMT29220
         CLI   CMDRESP+3,STACLASS  CLASS RESET?                         DMT29230
         BE    SETSTRTE            YES..NO MSG                          DMT29240
         MSGX  750,AXSLINK         WRITE MSG                            DMT29250
SETSTRTE EQU   *                                                        DMT29260
         TM    XJESYS,SGNONREC     Is link already signed on?  SML2NJE4 DMT29270
         BZ    SETSTAE2            No. Don't start reader now  SML2NJE4 DMT29280
         TM    LFLAG,LHOLD         Are files held on link?     SML2NJE4 DMT29290
         BO    SETSTAE2            Yes. Don't start reader now SML2NJE4 DMT29300
         TM    MASTERSW,READER     READER ALREADY ACTIVE?               DMT29310
         BO    SETSTAE2            YES..CONTINUE                        DMT29320
         OI    $RCOMM1+1,OPEN      OPEN READER GATE                     DMT29330
SETSTAE2 EQU   *                                                        DMT29340
         L     R14,CMDCMDSV        RESTORE RETURN REG                   DMT29350
         BR    R14                 AND RETURN                           DMT29360
         EJECT                                                          DMT29370
*---------------------------------------------------------------------* DMT29380
*                          DRAIN COMMAND                              * DMT29390
*---------------------------------------------------------------------* DMT29400
*.                                                                      DMT29410
* RESPONSES -                                                           DMT29420
*                                                                       DMT29430
*        DMTXJE570I  LINK 'LINKID' NOW SET TO DEACTIVATE       HRC000DT DMT29440
*                                                                       DMT29450
* ERROR MESSAGES -                                                      DMT29460
*                                                                       DMT29470
*        DMTXJE571E  LINK 'LINKID' ALREADY SET TO DEACTIVATE   HRC000DT DMT29480
*                                                                       DMT29490
*.                                                                      DMT29500
         SPACE 1                                                        DMT29510
SETDRAIN EQU   *                                                        DMT29520
         ST    R14,CMDCMDSV        SAVE RETURN                          DMT29530
         TM    LFLAG,LDRAIN        ALREADY DRAINING?                    DMT29540
         BO    SETDRER1            YES ..ERROR                          DMT29550
         OI    LFLAG,LDRAIN        SHOW WE ARE DRAINING                 DMT29560
         MSGX  570,AXSLINK         WRITE MSG                            DMT29570
         CLI   MASTERSW,X'00'      COULD WE ALREADY BE DRAINED?         DMT29580
         BE    SIGNOFF             Go and send signoff record  SML2NJE4 DMT29590
         B     SETDRXIT            IF NOT EXIT                          DMT29600
         SPACE                                                          DMT29610
SETDRER1 EQU   *                                                        DMT29620
         MSGX  571,AXSLINK         WRITE ERROR MSG                      DMT29630
SETDRXIT EQU   *                                                        DMT29640
         L     R14,CMDCMDSV        RESTORE RETURN REG                   DMT29650
         BR    R14                 AND RETURN                           DMT29660
         EJECT                                                          DMT29670
*---------------------------------------------------------------------* DMT29680
*                          FREE COMMAND                               * DMT29690
*---------------------------------------------------------------------* DMT29700
*.                                                                      DMT29710
* RESPONSES -                                                           DMT29720
*                                                                       DMT29730
*        DMTXJE590I  LINK 'LINKID' RESUMING FILE TRANSFER      HRC000DT DMT29740
*                                                                       DMT29750
* ERROR MESSAGES -                                                      DMT29760
*                                                                       DMT29770
*        DMTXJE591E  LINK 'LINKID' NOT IN HOLD STATUS          HRC000DT DMT29780
*                                                                       DMT29790
*.                                                                      DMT29800
         SPACE 1                                                        DMT29810
SETFREE  EQU   *                                                        DMT29820
         ST    R14,CMDCMDSV        SAVE RETURN                          DMT29830
         TM    LFLAG,LHOLD         ARE WE HELD?                         DMT29840
         BNO   SETFRER1            NO ERROR                             DMT29850
         MSGX  590,AXSLINK         WRITE FREE MSG                       DMT29860
         NI    LFLAG,255-LHOLD     TURN OFF HOLD FLAG                   DMT29870
         TM    RDRCMD,RHLDIPGS     WAS THE HOLD IMMED?                  DMT29880
         BO    SETFRXIT            YES..ALL DONE                        DMT29890
         TM    XJESYS,SGNONREC     Only open rdr if signed on  SML2NJE4 DMT29900
         BZ    SETFRXIT       NO - EXIT                        @VA03110 DMT29910
         OI    $RCOMM1+1,OPEN      MUST TRY TO GET FILE                 DMT29920
         B     SETFRXIT            AND ENTER COMMON EXIT                DMT29930
         SPACE 1                                                        DMT29940
SETFRER1 EQU   *                                                        DMT29950
         MSGX  591,AXSLINK         NOT IN HOLD MSG                      DMT29960
SETFRXIT EQU   *                                                        DMT29970
         NI    RDRCMD,255-RHLDIPGS TURN OFF FLAG                        DMT29980
         L     R14,CMDCMDSV        RESTORE RETURN                       DMT29990
         BR    R14                 AND RETURN                           DMT30000
         EJECT                                                          DMT30010
*---------------------------------------------------------------------* DMT30020
*                          HOLD COMMAND                               * DMT30030
*---------------------------------------------------------------------* DMT30040
*.                                                                      DMT30050
* RESPONSES -                                                           DMT30060
*                                                                       DMT30070
*        DMTXJE610I  LINK 'LINKID' TO SUSPEND FILE TRANSMISSIONHRC000DT DMT30080
*        DMTXJE611I  LINK 'LINKID' FILE TRANSMISSION SUSPENDED HRC000DT DMT30090
*                                                                       DMT30100
* ERROR MESSAGES -                                                      DMT30110
*                                                                       DMT30120
*        DMTXJE612E  LINK 'LINKID' ALREADY IN HOLD STATUS      HRC000DT DMT30130
*                                                                       DMT30140
*.                                                                      DMT30150
         SPACE 1                                                        DMT30160
SETHOLD  EQU   *                                                        DMT30170
         ST    R14,CMDCMDSV        SAVE RETURN                          DMT30180
         TM    LFLAG,LHOLD         ALREADY IN HOLD?                     DMT30190
         BO    SETHLDE1            YES ERROR                            DMT30200
         TM    CMDRESP+3,HOLDIMM   HOLD IMMEDIATE?                      DMT30210
         BO    SETHLDIM            YES PROCESS IT                       DMT30220
         OI    RDRCMD,RHLDIPGS     MARK HOLD IN PROGRESS                DMT30230
         MSGX  610,AXSLINK         WRITE SET TO HOLD MSG                DMT30240
         B     SETHLDXT            AND ENTER COMMON EXIT                DMT30250
         SPACE 1                                                        DMT30260
SETHLDIM EQU   *                                                        DMT30270
         OI    LFLAG,LHOLD         HOLD IT REGARDLESS                   DMT30280
         MSGX  611,AXSLINK         WRITE HELD MSG                       DMT30290
         B     SETHLDXT            AND ENTER COMMON EXIT                DMT30300
         EJECT                                                          DMT30310
SETHLDE1 EQU   *                                                        DMT30320
         MSGX  612,AXSLINK         WRITE ALREADY HELD MSG               DMT30330
SETHLDXT EQU   *                                                        DMT30340
         MVC   HLDCMDLK(8),CMDRESP+4 SAVE RESPONSE LINK FOR LATER       DMT30350
         L     R14,CMDCMDSV        RESTORE RETURN                       DMT30360
         BR    R14                 AND RETURN                           DMT30370
         EJECT                                                          DMT30380
*---------------------------------------------------------------------* DMT30390
*                          TRACE COMMAND                              * DMT30400
*---------------------------------------------------------------------* DMT30410
*.                                                                      DMT30420
* RESPONSES -                                                           DMT30430
*                                                                       DMT30440
*        DMTXJE801I  LINK 'LINKID' ERROR TRACE STARTED         HRC000DT DMT30450
*        DMTXJE802I  LINK 'LINKID' TRACE STARTED               HRC000DT DMT30460
*        DMTXJE803I  LINK 'LINKID' TRACE ENDED                 HRC000DT DMT30470
*                                                                       DMT30480
* ERROR MESSAGES -                                                      DMT30490
*                                                                       DMT30500
*        DMTXJE810E  LINK 'LINKID' TRACE ALREADY ACTIVE        HRC000DT DMT30510
*        DMTXJE811E  LINK 'LINKID' TRACE NOT ACTIVE            HRC000DT DMT30520
*                                                                       DMT30530
*.                                                                      DMT30540
         SPACE 1                                                        DMT30550
SETTRACE EQU   *                                                        DMT30560
         ST    R14,CMDCMDSV        SAVE RETURN REGISTER                 DMT30570
         CLI   CMDRESP+3,TRACEOFF  TRACE OFF?                           DMT30580
         BNE   SETTR1              NO CONTINUE                          DMT30590
         TM    LFLAG,LTRALL+LTRERR ARE WE TRACING AT ALL?               DMT30600
         BZ    SETTRE2             NO ERROR                             DMT30610
         NI    LFLAG,255-LTRALL-LTRERR TURN OFF TR BITS                 DMT30620
         MSGX  803,AXSLINK         WRITE THE MSG                        DMT30630
         B     SETTRXIT            AND EXIT                             DMT30640
         SPACE                                                          DMT30650
SETTR1   EQU   *                                                        DMT30660
         TM    LFLAG,LTRALL+LTRERR ARE WE TRACING ALREADY?              DMT30670
         BM    SETTRE1             YES ERROR                            DMT30680
         CLI   CMDRESP+3,TRACERR   ERROR TRACING?                       DMT30690
         BNE   SETTR2              NO ERROR                             DMT30700
         OI    LFLAG,LTRERR        SET ERROR TRACE ON                   DMT30710
         MSGX  801,AXSLINK         WRITE MSG                            DMT30720
         B     SETTRXIT            AND EXIT                             DMT30730
         EJECT                                                          DMT30740
SETTR2   EQU   *                                                        DMT30750
         OI    LFLAG,LTRALL        SET TRACE ALL                        DMT30760
         MSGX  802,AXSLINK         AND WRITE MSG                        DMT30770
         B     SETTRXIT            AND EXIT                             DMT30780
         SPACE                                                          DMT30790
SETTRE1  EQU   *                                                        DMT30800
         MSGX  810,AXSLINK         AND WRITE THE MSG                    DMT30810
         B     SETTRXIT            AND EXIT                             DMT30820
         SPACE                                                          DMT30830
SETTRE2  EQU   *                                                        DMT30840
         MSGX  811,AXSLINK         AND WRITE MSG                        DMT30850
SETTRXIT EQU   *                                                        DMT30860
         L     R14,CMDCMDSV        RESTORE RETURN REG                   DMT30870
         BR    R14                 AND RETURN                           DMT30880
         EJECT                                                          DMT30890
*---------------------------------------------------------------------* DMT30900
*                  BACKSPAC AND FWDSPACE COMMANDS                     * DMT30910
*---------------------------------------------------------------------* DMT30920
*.                                                                      DMT30930
* RESPONSES -                                                           DMT30940
*                                                                       DMT30950
*        NONE                                                           DMT30960
*                                                                       DMT30970
* ERROR MESSAGES -                                                      DMT30980
*                                                                       DMT30990
*        DMTXJE511E  NO FILE ACTIVE ON LINK 'LINKID'           HRC000DT DMT31000
*                                                                       DMT31010
*.                                                                      DMT31020
         SPACE 1                                                        DMT31030
SETBACK  EQU   *                                                        DMT31040
         ST    R14,CMDCMDSV        SAVE RETURN REG                      DMT31050
         TM    MASTERSW,READER     IS THERE A READER ACTIVE?            DMT31060
         BNO   SBKFWDN             NO ERROR                             DMT31070
         CLI   CMDRESP+3,BACKFILE  BACKSPAC FILE?                       DMT31080
         BNE   SETBACK1            NO CONTINUE                          DMT31090
         OI    RDRCMD,RBACKFIL     INDICATE CMD FOR RDR PROCESSING      DMT31100
         B     SBKFWDE             AND EXIT                             DMT31110
SETSTOP  EQU   *                                               HRC007DT DMT31120
         OI    LFLAG,LDRAIN        Stop any opens from now on  HRC007DT DMT31130
         B     SIGNOFF             Signoff, Close URs & exit   HRC007DT DMT31140
*                                                              HRC007DT DMT31150
SETFORCE EQU   *                                               HRC007DT DMT31160
         OI    LFLAG,LHALT         Give a clue what happened   HRC007DT DMT31170
         BAL   R14,CLOSEURS        Attempt to close URs        HRC007DT DMT31180
         DC    X'0000'             Cause program check         HRC007DT DMT31190
         SPACE                                                          DMT31200
SETBACK1 EQU   *                                                        DMT31210
         OI    RDRCMD,RBACKCNT     MUST BE BACKSPAC COUNT               DMT31220
         MVC   RDRCMDCT(4),CMDRESP+12+16 SAVE COUNT FOR RDR    HRC016DT DMT31230
         B     SBKFWDE             AND EXIT                             DMT31240
         SPACE                                                          DMT31250
SETFWD   EQU   *                                                        DMT31260
         ST    R14,CMDCMDSV        SAVE RETURN REGISTER                 DMT31270
         TM    MASTERSW,READER     IS THERE A READER ACTIVE             DMT31280
         BNO   SBKFWDN             NO ERROR                             DMT31290
         MVC   RDRCMDCT(4),CMDRESP+12+16 SAVE COUNT FOR READER HRC016DT DMT31300
         OI    RDRCMD,RFWDCNT      INDICATE COMMAND FOR READER          DMT31310
         B     SBKFWDE             AND EXIT                             DMT31320
         SPACE                                                          DMT31330
SBKFWDN  EQU   *                                                        DMT31340
         MSGX  511,AXSLINK         WRITE NO FILE ACTIVE MSG             DMT31350
SBKFWDE  EQU   *                                                        DMT31360
         MVC   RDRCMDLK(8),CMDRESP+4 MOVE IN RESPONSE LINKID            DMT31370
         L     R14,CMDCMDSV        RESTORE RETURN REG                   DMT31380
         BR    R14                 AND RETURN                           DMT31390
         EJECT                                                          DMT31400
*---------------------------------------------------------------------* DMT31410
*                          FLUSH COMMAND                              * DMT31420
*---------------------------------------------------------------------* DMT31430
*.                                                                      DMT31440
* RESPONSES -                                                           DMT31450
*                                                                       DMT31460
*        NONE                                                           DMT31470
*                                                                       DMT31480
* ERROR MESSAGES -                                                      DMT31490
*                                                                       DMT31500
*        DMTXJE511E  NO FILE ACTIVE ON LINK 'LINKID'           HRC000DT DMT31510
*                                                                       DMT31520
*.                                                                      DMT31530
         SPACE 1                                                        DMT31540
SETFLUSH EQU   *                                                        DMT31550
         ST    R14,CMDCMDSV        SAVE RETURN REG                      DMT31560
         MVC   RDRCMDID(2),CMDRESP+12+16 SAVE FOR LATER COMPAREHRC016DT DMT31570
         LH    R1,CMDRESP+12+16     GET SPOOLID                HRC016DT DMT31580
         CVD   R1,CMDCVD           CONVERT TO DECIMAL                   DMT31590
         UNPK  CMDFID,CMDCVD       SPREAD THE DIGITS                    DMT31600
         OI    CMDFID+3,X'F0'      MAKE LAST PRINTABLE                  DMT31610
         TM    MASTERSW,READER     ARE WE SENDING A FILE?               DMT31620
         BO    SETFLSH1            YEP.. CONTINUE                       DMT31630
         MSGX  511,AXSLINK         No file active on link $    HRC003DT DMT31640
         B     SETFLSHE            AND EXIT                             DMT31650
         SPACE                                                          DMT31660
SETFLSH1 EQU   *                                                        DMT31670
         TM    RSW1,RWAITACK       Are we waiting for file ACK?SML2NJE4 DMT31680
         BZ    NOWAITAK            Not waiting right now       SML2NJE4 DMT31690
         MVI   RCTCOM+1,OPEN       Open commutator entry       SML2NJE4 DMT31700
NOWAITAK EQU   *                                               SML2NJE4 DMT31710
         CLI   CMDRESP+3,FLUSHALL  FLUSH ALL                            DMT31720
         BNE   SETFLSH2            NO CONTINUE                          DMT31730
         OI    RDRCMD,RFLSHALL     SET RDRCMD BYTE                      DMT31740
         B     SETFLSHE            AND EXIT                             DMT31750
         SPACE                                                          DMT31760
SETFLSH2 EQU   *                                                        DMT31770
         CLI   CMDRESP+3,FLUSHOLD  FLUSH AND HOLD?                      DMT31780
         BNE   SETFLSH3            NO MUST BE FLUSH COPY                DMT31790
         OI    RDRCMD,RFLSHOLD     INDICATE CMD IN RDR CMD BYTE         DMT31800
         B     SETFLSHE            AND EXIT                             DMT31810
         SPACE                                                          DMT31820
SETFLSH3 EQU   *                                                        DMT31830
         OI    RDRCMD,RFLSHCPY     INDICATE CMD IN RDR CMD BYTE         DMT31840
SETFLSHE EQU   *                                                        DMT31850
         MVC   RDRCMDLK(8),CMDRESP+4 MOVE IN RESPONSE LINKID            DMT31860
         L     R14,CMDCMDSV        RESTORE RETURN REG                   DMT31870
         BR    R14                 AND RETURN                           DMT31880
         EJECT                                                          DMT31890
*---------------------------------------------------------------------* DMT31900
*                            CMD COMMAND                              * DMT31910
*---------------------------------------------------------------------* DMT31920
*.                                                                      DMT31930
* RESPONSES -                                                           DMT31940
*                                                                       DMT31950
*        DMTXJE530I  COMMAND FORWARDED ON LINK 'LINKID'        HRC000DT DMT31960
*                                                                       DMT31970
* ERROR MESSAGES -                                                      DMT31980
*                                                                       DMT31990
*        NONE                                                           DMT32000
*                                                                       DMT32010
*.                                                                      DMT32020
         SPACE 1                                                        DMT32030
         DS    0H                                                       DMT32040
SETCMD   EQU   *                                                        DMT32050
         ST    R14,CMDCMDSV        SAVE RETURN                          DMT32060
         LA    R7,WTCT             SET TCTR                             DMT32070
         SPACE 1                                                        DMT32080
         MVC   WCTTCT1(2),=X'0050' ???                                  DMT32090
         OC    CMDRESP+12+16(8),BLANK TO UPPR CASE             HRC016DT DMT32100
         CLC   CMDRESP+12+16(3),=C'LOG' LOGING REQUESTED?      HRC016DT DMT32110
         BNE   CMD2A               NOPE                                 DMT32120
         OI    $LOGSW,LOGON        SET LOGING REQUESTED                 DMT32130
         L     R14,CMDCMDSV        RESTORE RETURN                       DMT32140
         BR    R14                 AND RETURN                           DMT32150
         SPACE 1                                                        DMT32160
CMD2A    EQU   *                                                        DMT32170
         CLC   CMDRESP+12+16(5),=C'NOLOG' TURN OFF LOGING?     HRC016DT DMT32180
         BE    LOGCLOSE            YES                                  DMT32190
         TM    LFLAG,LCONNECT      Is link connected?          HRC031DT DMT32200
         BO    CMD12               Link is connected.          HRC031DT DMT32210
         MSGX  303,AXSLINK         Link is not active message  HRC031DT DMT32220
         B     CMDNRET             Return to command processor HRC031DT DMT32230
CMD12    EQU   *                                                        DMT32240
*****    MSGX  530,AXSLINK         WRITE COMMAND FORD MSG         *XJE  DMT32250
         LH    R8,=AL2(4096+NMROTANK-DMTXJEB) NMR tank offset     *XJE  DMT32260
         AR    R8,R9               -> NMROTANK                    *XJE  DMT32270
         USING TANKDSEC,R8         Get NMR tank addressability SML2NJE4 DMT32280
         EJECT                                                          DMT32290
         SR    R1,R1               CLEAR OUT R1 OF IC                   DMT32300
         IC    R1,CMDRESP          GET LENGTH OF RESPONSE               DMT32310
         SH    R1,=H'28'           Correct for header          HRC016DT DMT32320
         LTR   R1,R1               IS THE RESULT NEGATIVE?              DMT32330
         BM    CMD2               YES, ZERO LENGTH REPLY       @VA03860 DMT32340
         EX    R1,MSGMVC           AND MOVE INTO MSG BUFFER             DMT32350
         LA    R1,1(,R1)           Length was 1 short for EX   SML2NJE4 DMT32360
         LA    R0,XJE3NMRC         Code for routine BLDNMRC       *XJE  DMT32370
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT32380
         BALR  R14,R15             Build NMR command header    SML2NJE4 DMT32390
         STH   R1,TANKCNT          Store length of command NMR SML2NJE4 DMT32400
*        LR    R0,R4               R4 gets clobbered by $PUT   SML2NJE4 DMT32410
         BAL   R14,$PUT            AND WRITE THE TANK                   DMT32420
*        LR    R4,R0               Restore R4 after $PUT       SML2NJE4 DMT32430
CMD2     EQU   *                                                        DMT32440
         MVI   TANKDATA,C' '       Prepare for buffer clear    SML2NJE4 DMT32450
         MVC   TANKDATA+1(NMRSIZE-1),TANKDATA Clear NMR buffer SML2NJE4 DMT32460
CMDNRET  EQU   *                                                        DMT32470
         L     R14,CMDCMDSV        RESTORE RETURN                       DMT32480
         BR    R14                 AND RETURN                           DMT32490
         SPACE 1                                                        DMT32500
         DROP  R6                  Finished with link table    SML2NJE3 DMT32510
MSGMVC   MVC   TANKDATA+NMRHSIZE(*-*),CMDRESP+12+16 Executed   SML2NJE4 DMT32520
         DROP  R8                  Finished with tank for now  SML2NJE4 DMT32530
         EJECT                                                          DMT32540
*---------------------------------------------------------------------* DMT32550
*                                                                     * DMT32560
*                  COMMAND DATA AREA                                  * DMT32570
*                                                                     * DMT32580
*---------------------------------------------------------------------* DMT32590
         SPACE                                                          DMT32600
STRTCMD  EQU   X'80'               START COMMAND                        DMT32610
DRCMD    EQU   X'81'               DRAIN COMMAND                        DMT32620
FREECMD  EQU   X'82'               FREE COMMAND                         DMT32630
HOLDCMD  EQU   X'83'               HOLD COMMAND                         DMT32640
TRACECMD EQU   X'84'               TRACE COMMAND                        DMT32650
STOPCMD  EQU   X'85'               Stop link immediately       HRC007DT DMT32660
FORCECMD EQU   X'86'               Cause link to program check HRC007DT DMT32670
BACKCMD  EQU   X'90'               BACKSPAC COMMAND                     DMT32680
FWDCMD   EQU   X'91'               FORWARD SPACE COMMAND                DMT32690
FLUSHCMD EQU   X'A0'               FLUSH COMMAND                        DMT32700
CMDCMD   EQU   X'B0'               COMMAND COMMAND                      DMT32710
MSGCMD   EQU   X'B1'               MESSAGE COMMAND                      DMT32720
NMR      EQU   X'B2'               NMR 'command'               SML2NJE4 DMT32730
         SPACE                                                          DMT32740
*        COMMAND MODIFIERS                                              DMT32750
TRACEOFF EQU   X'C0'               TRACE OFF                            DMT32760
TRACERR  EQU   X'80'               ERROR TRACE ON                       DMT32770
TRACEALL EQU   X'00'               TRACE ALL ON                         DMT32780
BACKCNT  EQU   X'80'               BACKSPAC COUNT                       DMT32790
BACKFILE EQU   X'00'               BACKSPAC FILE                        DMT32800
FLUSHCPY EQU   X'00'               FLUSH COPY                           DMT32810
FLUSHALL EQU   X'80'               FLUSH ALL                            DMT32820
FLUSHOLD EQU   X'40'               FLUSH HOLD                           DMT32830
HOLDIMM  EQU   X'80'               HOLD IMMEDIATE                       DMT32840
STACLASS EQU   X'80'               START RESET CLASS                    DMT32850
         SPACE                                                          DMT32860
CMDSETUP DC    A(CMDTABLE)         COMMAND TABLE ADDRESS                DMT32870
         DC    A(CMDINC)                                                DMT32880
         DC    A(CMDEND-CMDINC)    LAST ENTRY                           DMT32890
         SPACE 1                                                        DMT32900
CMDINC   EQU   4                   LENGTH OF COMMAND TABLE ENTRY        DMT32910
         SPACE                                                          DMT32920
CMDTABLE DC    0F'0'                                                    DMT32930
         DC    AL1(STRTCMD),AL3(SETSTART)                               DMT32940
         DC    AL1(DRCMD),AL3(SETDRAIN)                                 DMT32950
         DC    AL1(FREECMD),AL3(SETFREE)                                DMT32960
         DC    AL1(HOLDCMD),AL3(SETHOLD)                                DMT32970
         DC    AL1(TRACECMD),AL3(SETTRACE)                              DMT32980
         DC    AL1(STOPCMD),AL3(SETSTOP)                       HRC007DT DMT32990
         DC    AL1(FORCECMD),AL3(SETFORCE)                     HRC007DT DMT33000
         DC    AL1(BACKCMD),AL3(SETBACK)                                DMT33010
         DC    AL1(FWDCMD),AL3(SETFWD)                                  DMT33020
         DC    AL1(FLUSHCMD),AL3(SETFLUSH)                              DMT33030
         DC    AL1(CMDCMD),AL3(SETCMD)                                  DMT33040
CMDEND   EQU   *                                                        DMT33050
         SPACE                                                          DMT33060
         EJECT                                                          DMT33070
*.                                                                      DMT33080
*                                                                       DMT33090
* ENTRY NAME -                                                          DMT33100
*                                                                       DMT33110
*        MSGPROC                                                        DMT33120
*                                                                       DMT33130
* FUNCTION -                                                            DMT33140
*                                                                       DMT33150
*        THIS ROUTINE IS ENTERED WHEN THE MSGECB IS POSTED BY           DMT33160
*        THIS TASK'S ASYNCHRONOUS EXIT, INDICATING MSGS ARE IN          DMT33170
*        THE MSG QUEUE FOR THIS TASK.  THIS MESSAGES ARE                DMT33180
*        UNSTACKED FROM THE MSG QUEUE BY REPEATED CALLS TO              DMT33190
*        GMSGREQ AND QUEUED FOR TRANSMISSION.                           DMT33200
*                                                                       DMT33210
* CALLS TO OTHER ROUTINES -                                             DMT33220
*                                                                       DMT33230
*        DMTCOM - TO UNSTACK THE MESSAGE                                DMT33240
*                                                                       DMT33250
* OPERATION -                                                           DMT33260
*                                                                       DMT33270
*        1. DEQUEUE MESSAGES FROM MESSAGE STACK VIA CALL TO GMSGREQ.    DMT33280
*                                                                       DMT33290
*        2. IF MESSAGE DEQUEUED SEND THE RECORD VIA CALL TO $PUT        DMT33300
*                                                                       DMT33310
*        3. EXIT TO COMMUTATOR.                                         DMT33320
*                                                                       DMT33330
* RESPONSES -                                                           DMT33340
*                                                                       DMT33350
*        NONE                                                           DMT33360
*                                                                       DMT33370
* ERROR MESSAGES -                                                      DMT33380
*                                                                       DMT33390
*        NONE                                                           DMT33400
*                                                                       DMT33410
*.                                                                      DMT33420
         SPACE 3                                                        DMT33430
MSGPROC  EQU   *                                                        DMT33440
         LA    R7,WTCT             ANOTHER CONSOLE USER                 DMT33450
         MVI   $MSGCOM+1,CLOSE     CLOSE THE GATE                       DMT33460
         TM    WCTSTAT,TCTREL      IS THE INTERLOCK ON?                 DMT33470
         BO    MSGPROC2            YES..ALREADY PACKED..CONTINUE        DMT33480
         LH    R8,=AL2(4096+NMROTANK-DMTXJEB) NMR tank offset     *XJE  DMT33490
         AR    R8,R9               -> NMROTANK                    *XJE  DMT33500
         USING TANKDSEC,R8         Get tank addressability     SML2NJE4 DMT33510
MSGPROC1 EQU   *                                                        DMT33520
         LA    R1,TANKDATA-2       Load stacked message here   SML2NJE4 DMT33530
         L     R2,XJELINK          Get link table address      SML2NJE4 DMT33540
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE  DMT33550
         L     R15,GMSGREQ         INDICATE WE WANT A MSG               DMT33560
         BALR  R14,R15             GO GET ONE                           DMT33570
         LTR   R15,R15             ANY AVAILABLE?                       DMT33580
         BNZ   MSGPREOF       SEND PSUEDO EOF                  @VA03480 DMT33590
         XR    R1,R1               Clear R1 for IC             SML2NJE4 DMT33600
         IC    R1,TANKDATA-2       Get the length of message   SML2NJE4 DMT33610
   LTR R1,R1
   BP VALMSG
   STM R0,R1,XJE3SAVE  save before ABEND macro
   ABEND 888,DUMP      abend U888 if msg len < 1
VALMSG EQU *
         CLI   TANKDATA-2+1,NMR    Is this already an NMR?     SML2NJE4 DMT33620
         BE    MSGISNMR            Skip building NMR header    SML2NJE4 DMT33630
         LA    R0,XJE3NMRM         Code for routine BLDNMRM       *XJE  DMT33640
         L     R15,=A(DMTXJE3)     -> NJE functions csect         *XJE  DMT33650
         BALR  R14,R15             Build NMR message header    SML2NJE4 DMT33660
MSGISNMR EQU   *                                               SML2NJE4 DMT33670
         LH    R8,=AL2(4096+NMROTANK-DMTXJEB) NMR tank offset     *XJE  DMT33680
         AR    R8,R9               -> NMROTANK                    *XJE  DMT33690
         STH   R1,TANKCNT          Store length of NMR message SML2NJE4 DMT33700
         EJECT                                                          DMT33710
MSGPROC2 EQU   *                                                        DMT33720
         BAL   R14,$PUT            AND WRITE THE BUFFER                 DMT33730
         MVI   TANKDATA,C' '       Get ready to clear buffer   SML2NJE4 DMT33740
         MVC   TANKDATA+1(NMRSIZE-1),TANKDATA Clear NMR buffer SML2NJE4 DMT33750
         B     MSGPROC1            AND GO GET ANOTHER                   DMT33760
         SPACE 1                                                        DMT33770
MSGPREOF EQU   *                                               @VA03480 DMT33780
         CLC   OBUFPTR(4),=F'0'    Is there an active buffer?  SML2NJE4 DMT33790
         BE    $MSGCOM+4      NO, JUST RETURN                  @VA03863 DMT33800
         MVC   TANKCNT,=F'0'       Count = 0 => EOF            SML2NJE4 DMT33810
         DROP  R8                                              SML2NJE4 DMT33820
         BAL   R14,$PUT       SEND THE RECORD                  @VA03480 DMT33830
         B     $MSGCOM+4      AND RETURN                       @VA03480 DMT33840
         EJECT                                                          DMT33850
*.                                                                      DMT33860
*                                                                       DMT33870
* ENTRY NAME -                                                          DMT33880
*                                                                       DMT33890
*        MSG                                                            DMT33900
*                                                                       DMT33910
* FUNCTION -                                                            DMT33920
*                                                                       DMT33930
*        THIS ROUTINE PREPARES AND SENDS REQUESTS TO THE                DMT33940
*        SPECIALIZED TASK REX, IN ORDER TO WRITE MESSAGES               DMT33950
*        ON THE OPERATOR'S CONSOLE.                                     DMT33960
*                                                                       DMT33970
* CALLS TO OTHER ROUTINES -                                             DMT33980
*                                                                       DMT33990
*        DMTREX - TO EXECUTE THE MSG WRITE                              DMT34000
*                                                                       DMT34010
* OPERATION -                                                           DMT34020
*                                                                       DMT34030
*        1. MOVE VARIABLE PART OF MSG TO GIVE REQUEST BUFFER            DMT34040
*                                                                       DMT34050
*        2. INITIATE GIVE REQUEST TO DMTREX WITH MSG BUFFER.            DMT34060
*                                                                       DMT34070
*        3. WAIT FOR COMPLETION                                         DMT34080
*                                                                       DMT34090
*        4. RETURN TO CALLER                                            DMT34100
*                                                                       DMT34110
* ENTRY CONDITIONS:                                                     DMT34120
*                                                                       DMT34130
*        IN REG. 14 THE RETURN ADDRESS                                  DMT34140
*        IN REG. 15 THE ROUTING CODE                                    DMT34150
*        IN REG. 1 THE POINTER TO THE VARIABLE PORTION OF               DMT34160
*              THE MESSAGE STRING                                       DMT34170
*        IN REG. 0 THE LENGTH OF THE VARIABLE PORTION OF THE MSG        DMT34180
*                                                                       DMT34190
* EXIT CONDITIONS:                                                      DMT34200
*                                                                       DMT34210
*        NONE                                                           DMT34220
*                                                                       DMT34230
* NOTE:                                                                 DMT34240
*        NONE                                                           DMT34250
*                                                                       DMT34260
* RESPONSES -                                                           DMT34270
*                                                                       DMT34280
*        NONE                                                           DMT34290
*                                                                       DMT34300
* ERROR MESSAGES -                                                      DMT34310
*                                                                       DMT34320
*        NONE                                                           DMT34330
*                                                                       DMT34340
*.                                                                      DMT34350
         EJECT                                                          DMT34360
MSG      DC    0H'0'                                                    DMT34370
         STM   R14,R2,MSGSAVE      SAVE REGISTERS                       DMT34380
         LR    R2,R0               MOVE R0 INTO WORK REG                DMT34400
         BCTR  R2,0                REDUCE BY ONE FOR MVC                DMT34410
         EX    R2,MSGMVC1          AND MOVE TO MSG REQ BUFFER           DMT34420
         AH    R2,=H'24'           UP FOR HEADER                        DMT34430
         STC   R2,MSGBLK           AND STORE IN MSG REQ BUFFER          DMT34440
         CLI   MSGLINK,X'00'       NEED ROUTING?                        DMT34450
         BNE   MSG1                NO CONTINUE                          DMT34460
         MVC   MSGLINK(8),AXSLINK  MOVE IN OUR LINKID                   DMT34470
MSG1     EQU   *                                                        DMT34480
         LA    R1,MSGREQ           GET READY FOR GIVE                   DMT34490
         XC    MSGREQ(4),MSGREQ    CLEAR OUT SYNCH LOCK                 DMT34500
         L     R15,GIVEREQ         SYSTEM GIVE REQUEST EXECUTATOR       DMT34510
         BALR  R14,R15             GO GIVE THE BUFFER TO REX            DMT34520
*********L     R15,WAITREQ         WAIT FOR THE COMPLETION OF           DMT34530
*********BALR  R14,R15             CONSOLE OPERATION                    DMT34540
         MVI   MSGLINK,X'00'       SHOW NO RESPONSE                     DMT34550
         MVI   MSGBLK+2,X'00'      INDICATE NO ROUTING                  DMT34560
         LM    R14,R2,MSGSAVE      RESTORE REGS                         DMT34570
         BR    R14                 AND RETURN                           DMT34580
         SPACE                                                          DMT34590
MSGMVC1  MVC   MSGBUF(0),0(R1)     TO BE EXECUTED FROM ABOVE            DMT34600
         SPACE                                                          DMT34610
         EJECT                                                          DMT34620
         EJECT                                                          DMT34630
*---------------------------------------------------------------------* DMT34640
*                                                                     * DMT34650
*                        FILE ACCESS INTERFACE                        * DMT34660
*                                                                     * DMT34670
*---------------------------------------------------------------------* DMT34680
         SPACE 1                                                        DMT34690
*                                                                       DMT34700
*        ON ENTRY:            R1 --> DEVICE REQUEST BLOCK               DMT34710
*                             R0  =  AXS REQUEST CODE                   DMT34720
*                                                                       DMT34730
*        ON EXIT:                                                       DMT34740
*                             R15 =  AXS RETURN CODE                    DMT34750
*                                                                       DMT34760
AXS      DS    0H                                                       DMT34770
         ST    R14,AXSAVE          SAVE RETURN REGISTER                 DMT34780
         STC   R0,17(R1)           SET REQUESTED FUNCTION               DMT34790
         XC    0(4,R1),0(R1)       CLEAR REQUEST SYNCH LOCK             DMT34800
         L     R15,GIVEREQ         GIVE REQUEST ADDRESS                 DMT34810
         BALR  R14,R15             GIVE THE REQUEST TO SUPERVISOR       DMT34820
         L     R15,WAITREQ         WAIT REQUEST                         DMT34830
         BALR  R14,R15             WAIT FOR OPERATION TO COMPLETE       DMT34840
         XC    0(4,R1),0(R1)       CLEAR OUT SYNC LOCK                  DMT34850
         L     R14,AXSAVE          RESTORE RETURN ADDRESS               DMT34860
         BR    R14                 RETURN TO CALLER                     DMT34870
         SPACE 1                                                        DMT34880
         EJECT                                                          DMT34890
*.                                                                      DMT34900
*                                                                       DMT34910
* ENTRY NAME -                                                          DMT34920
*                                                                       DMT34930
*        $TPPUT                                                         DMT34940
*                                                                       DMT34950
* FUNCTION -                                                            DMT34960
*                                                                       DMT34970
*        THIS ROUTINE TAKES A LINE AND PACKS IT INTO A TELE-            DMT34980
*        PROCESSING BUFFER.  WHEN A BUFFER IS FILLED IT IS QUEUED       DMT34990
*        ONTO $OUTBUF FOR PROCESSING BY COMSUP.                         DMT35000
*                                                                       DMT35010
* CALLS TO OTHER ROUTINES -                                             DMT35020
*                                                                       DMT35030
*        NONE                                                           DMT35040
*                                                                       DMT35050
* OPERATION -                                                           DMT35060
*                                                                       DMT35070
*        1. FIND THE CURRENT TP BUFFER FOR THE CALLING                  DMT35080
*           PROCESSOR.                                                  DMT35090
*                                                                       DMT35100
*        2. COMPRESS THE RECORD IN THE SUPPLIED TANK.                   DMT35110
*                                                                       DMT35120
*        3. TRY TO FIT IN THE EXISTING TP BUFFER.                       DMT35130
*                                                                       DMT35140
*        4. IF RECORD WILL NOT FIT, QUEUE CURRENT                       DMT35150
*           RECORD FOR TRANSMISSION, OBTAIN A NEW BUFFER                DMT35160
*           AND ADD RECORD TO IT.                                       DMT35170
*                                                                       DMT35180
*        5. FOR OPERATOR MESSAGES, PROCESS ONLY ONE RECORD              DMT35190
*           PER BUFFER.                                                 DMT35200
*                                                                       DMT35210
*        6. RETURN TO CALLER                                            DMT35220
*                                                                       DMT35230
* RESPONSES -                                                           DMT35240
*                                                                       DMT35250
*        NONE                                                           DMT35260
*                                                                       DMT35270
* ERROR MESSAGES -                                                      DMT35280
*                                                                       DMT35290
*        NONE                                                           DMT35300
*                                                                       DMT35310
*.                                                                      DMT35320
         EJECT                                                          DMT35330
*                                                                       DMT35340
*        $PUT  ROUTINE             INTERFACE WITH $TPPUT                DMT35350
*                                                                       DMT35360
*        R8 POINTS TO TANK, R14 POINTS TO RETURN, TCTR POINTS TO TCT    DMT35370
*                                                                       DMT35380
         USING TANKDSEC,R8                                              DMT35390
         USING TCTDSECT,TCTR                                            DMT35400
         SPACE 1                                                        DMT35410
$PUT     DS    0H                                                       DMT35420
         ST    R14,TCTSAV1         SAVE RETURN ADDRESS                  DMT35430
         ST    R8,TCTCCW           SAVE TANK ADDRESS                    DMT35440
OXLOOP   EQU   *                                                        DMT35450
         TM    TCTSTAT,TCTREL      IS INTERLOCK RELEASE ON              DMT35460
         BZ    OXPUT               IF NOT DO NORMAL $TPPUT              DMT35470
         LH    R8,=AL2(4096+NMROTANK-DMTXJEB) NMR tank offset     *XJE  DMT35480
         AR    R8,R9               -> NMROTANK                    *XJE  DMT35490
         BAL   R14,$TPREPUT        ATTEMPT TO SEND                      DMT35500
         L     R14,TCTSAV1         PICK UP RETURN ADDR                  DMT35510
         BNE   OXFINTST            IF TANK OK TEST FOR MORE WORK        DMT35520
         MVI   CMDINPGS,X'00'      RESET FLAG                  @VM01164 DMT35530
         MVI   $MSGCOM+1,CLOSE CLOSE THIS PROCESSOR            @VA03480 DMT35540
         B     $START         RETURN TO TOP OF COMMUTATOR      @VA03480 DMT35550
         SPACE 1                                                        DMT35560
OXFINTST EQU   *                                                        DMT35570
         NI    WCTSTAT,255-TCTREL  RESET INTERLOCK RELEASE              DMT35580
         BR    R14                 AND RETURN                           DMT35590
         SPACE 1                                                        DMT35600
OXPUT    EQU   *                                                        DMT35610
         BAL   R14,$TPPUT          SUBMIT TANK FOR TRANSMISSION         DMT35620
         L     R14,TCTSAV1         RESTORE RETURN POINTER               DMT35630
         BNER  R14                 IF TANK WENT OK THEN RETURN          DMT35640
         TM    TCTSTAT,TCT1052     IF NOT TEST FOR CONSOLE              DMT35650
         BZ    OXWAIT              IF NOT CONSOLE WAIT                  DMT35660
         OI    WCTSTAT,TCTREL      SET INTERLOCK RELEASE INDICATOR      DMT35670
         MVI   CMDINPGS,X'00'      RESET FLAG                  @VM01164 DMT35680
         MVI   $MSGCOM+1,CLOSE CLOSE THIS PROCESSOR            @VA03480 DMT35690
         B     $START         RETURN TO TOP OF COMMUTATOR      @VA03480 DMT35700
         SPACE 1                                                        DMT35710
OXWAIT   EQU   *                                                        DMT35720
         DS    0H                  WAIT TO RESUBMIT TANK                DMT35730
         MVC   TCTENTY(2),OBUFNOW  SET UP FOR REENTRY                   DMT35740
         L     R6,TCTCOM           GET COMMUTATOR ENTRY                 DMT35750
         MVI   1(R6),CLOSE         AND CLOSE GATE                       DMT35760
         MVI   TCTWFB,X'FF'        SET READER-WAITING-FOR-BUFFER        DMT35770
         B     TCTRTN              AND RETURN                           DMT35780
         EJECT                                                          DMT35790
BUFNOW   EQU   *                                                        DMT35800
         MVI   TCTWFB,X'00'        RESET WAIT SWITCH                    DMT35810
         L     R6,TCTCOM           GET COMMUTATOR ENTRY                 DMT35820
         MVI   1(R6),CLOSE         AND CLOSE GATE                       DMT35830
         L     R8,TCTCCW           PICK UP TANK ADDRESS                 DMT35840
         BAL   R14,$TPREPUT        RESUBMIT TANK FOR TRANSMISSION       DMT35850
         L     R14,TCTSAV1         PICK UP USER RETURN POINT            DMT35860
         BE    OXWAIT              WAIT                                 DMT35870
         BR    R14                 RETURN                               DMT35880
         DROP  R8                                                       DMT35890
         SPACE 1                                                        DMT35900
OBUFNOW  DC    S(BUFNOW)           RENTRY POINT                         DMT35910
         EJECT                                                          DMT35920
*---------------------------------------------------------------------* DMT35930
*                                                                     * DMT35940
*  ENTRY - $TPPUT                                                     * DMT35950
*                 REGISTERS - R8=RECORD TANK 2(R8)=RCB,3(R8)=SRCB     * DMT35960
*                            R14=RETURN ADDR ,CC=0 - RECORD NOT TAKEN * DMT35970
*                                             CC.NE.0-RECORD ACCEPTED * DMT35980
*                            R15 IS CONSIDERED VOLITILE               * DMT35990
*                                                                     * DMT36000
*                                                                     * DMT36010
*---------------------------------------------------------------------* DMT36020
         SPACE 1                                                        DMT36030
$TPPUT   DS    0H                                                       DMT36040
         ST    R14,OSAVR14         SAVE RETURN                          DMT36050
         ST    R5,OSAVR5           SAVE REGISTERS                       DMT36060
         ST    R6,OSAVR6           SAVE REGISTERS                       DMT36070
         ST    R8,OINADD           SAVE INPUT TANK ADDR                 DMT36080
         LA    R15,1               Get counter                 HRC001DT DMT36090
         L     R5,OINADD           COMPRESSION WORK AREA                DMT36100
         LA    R5,TANKRCB-TANKDSEC(,R5) Get RCB address        HRC001DT DMT36110
         USING TANKDSEC,R8         *                                    DMT36120
         XR    R6,R6               Clear R6 for ICM            HRC001DT DMT36130
         ICM   R6,B'0011',TANKCNT  Tank data count             HRC001DT DMT36140
         BE    OEOINCHK       BR IF YES TO CHECK EOF           @VA03480 DMT36150
         AR    R6,R8               INCLUDE TANK ADDR                    DMT36160
         ST    R6,OINEND           TO SAFE STORAGE                      DMT36170
         CLI   OTS(R8),2           IS THIS A TEXT CARD                  DMT36180
         BNE   OGOA                BR IF NO                             DMT36190
         SPACE 1                                                        DMT36200
*                   SKIP ATTEMPTING TO COMPRESS A TEXT CARD             DMT36210
         LH    R6,TANKCNT          INPUT COUNT                          DMT36220
         LTR   R4,R8               INPUT ADDR                           DMT36230
         AR    R8,R6               END OF RECORD                        DMT36240
         B     OSQUEEZE            GO PROCESS RECORD                    DMT36250
         SPACE 1                                                        DMT36260
OGOA     DS    0H                                                       DMT36270
         MVI   OTS(R6),0           SETUP ENDING CHARACTER               DMT36280
         CLI   OTS-1(R6),0         DOES ENDING MATCH LAST DATA CHAR     DMT36290
         BNE   OGOB                BR IF NOT                            DMT36300
         MVI   OTS(R6),255         YES...USE ANOTHER                    DMT36310
OGOB     EQU   *                                                        DMT36320
         MVC   OTS+1(3,R6),OTS(R6) PROPAGATE FOR DUPLICATION            DMT36330
OGO      DS    0H                                                       DMT36340
         LA    R14,OGO1            LOAD FOR SPEED                       DMT36350
         LA    R13,OSQUEEZE        LOAD FOR SPEED                       DMT36360
         SR    R6,R6               INITIAL COUNTER FOR MVC              DMT36370
         LTR   R4,R8               INPUT AREA TO R4                     DMT36380
OGO1     DS    0H                                                       DMT36390
         CLC   OTS(3,R8),OTS+1(R8) CHECK FOR COMPRESSABILITY            DMT36400
         BCR   8,R13               BR IF COMPRESSABLE (TO OSQUEEZE)     DMT36410
         AR    R8,R15              UP DATA PTR                          DMT36420
         AR    R6,R15              AND CHAR COUNT                       DMT36430
         BR    R14                 CONTINUE (TO OGO1)                   DMT36440
         EJECT                                                          DMT36450
*---------------------------------------------------------------------* DMT36460
*                                                                     * DMT36470
*             OSQUEEZE -  IDENTICAL CHARACTERS FOUND                  * DMT36480
*                                                                     * DMT36490
*---------------------------------------------------------------------* DMT36500
         SPACE 2                                                        DMT36510
OSQUEEZE DS    0H                  *                                    DMT36520
         LTR   R6,R6               Is a character string activeHRC001DT DMT36530
         BE    OCOMPTST            BR IF NO TO COMPRESS                 DMT36540
         CH    R6,=H'63'           DOES STRING EXCEED SCB               DMT36550
         BH    OBIGMOVE            BR IF YES                            DMT36560
         EX    R6,OMVC1A      MOVE TO TEMP BUFF THEN TO TANK   @VA04175 DMT36570
         EX    R6,OMVC1B      -TO AVOID CHARACTER PROPAGATION  @VA04175 DMT36580
         STC   R6,2(R5)            SET SCB COUNT                        DMT36590
         OI    2(R5),X'C0'         SET SCB ID BITS                      DMT36600
         AR    R5,R6               FIX OUTPUT POINTER                   DMT36610
         AR    R5,R15              COUNT SCB                            DMT36620
OCOMPTST DS    0H                                                       DMT36630
         C     R8,OINEND           TEST FOR EOI                         DMT36640
         BNL   OEOINPUT            BR IF YES                            DMT36650
OCOMP    DS    0H                                                       DMT36660
         LA    R14,OCOMP1          FOR LOOP SPEED                       DMT36670
         LA    R13,OCMPSTOP        FOR LOOP SPEED                       DMT36680
         LA    R6,4                Start compression counter   HRC001DT DMT36690
OCOMP1   DS    0H                  CONTINUE COMPRESSION TESTING         DMT36700
         CLC   OTS+3(1,R8),OTS+4(R8) DOES MATCH CONTINUE                DMT36710
         BCR   7,R13               BR IF NO (TO CMPSTOP)                DMT36720
         AR    R6,R15              ANOTHER MATCH... COUNT IT            DMT36730
         AR    R8,R15              UP TO NEXT CHAR                      DMT36740
         BR    R14                 CONTINUE (TO OCOMP1)                 DMT36750
         SPACE 1                                                        DMT36760
OMVC1A   MVC   OTEMP(*-*),OTS(R4) EXECUTED BY ABOVE CODE       @VA04175 DMT36770
OMVC1B   MVC   3(*-*,R5),OTEMP EXECUTED BY ABOVE CODE          @VA04175 DMT36780
         SPACE 1                                                        DMT36790
OCMPSTOP DS    0H                  IDENTICAL STRING ENDED               DMT36800
         CH    R6,=H'31'           DOES IT EXCEED SCB...                DMT36810
         BH    OBIGPROP            BR IF YES                            DMT36820
         STH   R6,$TEMP            TO TEMPORARY STORAGE                 DMT36830
         OI    $TEMP+1,X'80'       SET SCB ALWAYS BIT                   DMT36840
         MVC   2(1,R5),$TEMP+1     SET SCB                              DMT36850
         CLI   OTS+3(R8),C' '      ARE WE SQUEEZING BLANKS              DMT36860
         BE    OBLANK              BR IF YES                            DMT36870
         MVC   3(1,R5),OTS+3(R8)   SET DUPLICATION CHAR                 DMT36880
         OI    2(R5),X'20'         SHOW NON-BLANK DUPLICATION           DMT36890
         AR    R5,R15              SKIP SAMPLE CHAR                     DMT36900
OBLANK   DS    0H                                                       DMT36910
         AR    R5,R15              COUNT SCB                            DMT36920
         LA    R8,4(,R8)           Up to next                  HRC001DT DMT36930
         B     OGO                 AND CONTINUE RECORD                  DMT36940
         EJECT                                                          DMT36950
OBIGPROP DS    0H                  DUPLICATION COUNT EXCEEDS SCB        DMT36960
         MVI   2(R5),X'9F'         SHOW MAX SCB                         DMT36970
         CLI   OTS+3(R8),C' '      IS THIS BLANKS                       DMT36980
         BE    OBIGBLNK            BR IF YES                            DMT36990
         MVC   3(1,R5),OTS+3(R8)   SET SAMPLE CHAR                      DMT37000
         OI    2(R5),X'20'         SHOW NON-BLANK                       DMT37010
         AR    R5,R15              COUNT SAMPLE                         DMT37020
OBIGBLNK DS    0H                  EXCESSIVE COUNT BLANKS               DMT37030
         AR    R5,R15              COUNT SCB                            DMT37040
         SH    R6,=H'31'           ADJUST COUNT                         DMT37050
         B     OCMPSTOP            AND TRY AGAIN                        DMT37060
         SPACE 1                                                        DMT37070
OBIGMOVE DS    0H                  STRING COUNT EXCEEDS SCB MAXIMUM     DMT37080
         MVC   3(63,R5),OTS(R4)    MOVE MAX                             DMT37090
         MVI   2(R5),X'FF'         SET MAX SCB                          DMT37100
         LA    R5,64(,R5)          Add in count                HRC001DT DMT37110
         LA    R4,63(,R4)          Add in count                HRC001DT DMT37120
         SH    R6,=H'63'           REDUCE COUNT                         DMT37130
         B     OSQUEEZE            AND TRY AGAIN                        DMT37140
         SPACE 1                                                        DMT37150
OEOINCHK EQU   *                                               @VA03480 DMT37160
         CLC   TANKRCB(1),WCTRCBR  Messages?                   SML2NJE4 DMT37170
         BE    OFLUSH         JUST FLUSH THE BUFFER AS IS      @VA03480 DMT37180
         EJECT                                                          DMT37190
*---------------------------------------------------------------------* DMT37200
*                                                                     * DMT37210
*              END OF INPUT RECORD - TERMINATE AND ADD TO BUFFER      * DMT37220
*                                                                     * DMT37230
*---------------------------------------------------------------------* DMT37240
         SPACE 1                                                        DMT37250
OEOINPUT EQU   *                                                        DMT37260
         MVI   2(R5),0             END-OF-RECORD SCB                    DMT37270
         AR    R5,R15              COUNT IT                             DMT37280
         L     R8,OINADD           STARTING ADDR OF COMPRESSED REC      DMT37290
         SR    R5,R8               REDUCE TO ACTUAL COUNT               DMT37300
         SH    R5,=AL2(L'TANKCHN-2) COMPENSATE FOR FULL CHAIN WORD      DMT37310
         STH   R5,TANKCHN          SAVE COUNT IN TANK FOR $TPREPUT      DMT37320
OREENT   DS    0H                  RE-ENTRY POINT FROM $TPREPUT         DMT37330
         L     R6,OBUFPTR          GET ADDR OF ACTIVE BUFFER            DMT37340
         LTR   R6,R6               End?                        HRC001DT DMT37350
         BE    OGETBUF             BR IF NO                             DMT37360
OBUFOK   DS    0H                  VALID BUFFER                         DMT37370
         CH    R5,OBUFCNT          WILL THIS RECORD FIT...              DMT37380
         BH    OBUFFULL            BR IF NO                             DMT37390
         EX    R5,OMVC2            MOVE RECORD                          DMT37400
         AR    R6,R5               UPDATE CURRENT PTR                   DMT37410
         ST    R6,OBUFPTR          AND RESET                            DMT37420
         LH    R6,OBUFCNT          REMAINING COUNT                      DMT37430
         SR    R6,R5               REDUCE BY THIS RECORD                DMT37440
         STH   R6,OBUFCNT          AND RESET                            DMT37450
         CH    R5,=H'3'            WAS THIS A NULL RECORD               DMT37460
         BE    OFLUSH              BR IF YES TO WRITE BUFFER            DMT37470
         CLC   TANKRCB(1),WCTRCBR  Is this operator command?   SML2NJE4 DMT37480
         BE    OFLUSH              BR IF YES TO SEND BUFFER             DMT37490
ORETOK   DS    0H                  POSITIVE RETURN ENTRY                DMT37500
         OI    BUFSYNSW,OFLSW      OPEN NORMAL GATE AND SET COND CODE   DMT37510
ORETURN  DS    0H                  RETURN--COND. CODE ALREADY SET       DMT37520
         L     R8,OINADD           RESTORE TANK ADDR                    DMT37530
         L     R6,OSAVR6           RESTORE REG                          DMT37540
         L     R5,OSAVR5           RESTORE REG                          DMT37550
         L     R14,OSAVR14         GET RETURN                           DMT37560
         BR    R14                 AND DO IT                            DMT37570
         SPACE 1                                                        DMT37580
OMVC2    MVC   0(0,R6),L'TANKCHN(R8) TO BE EXECUTED FROM ABOVE          DMT37590
         EJECT                                                          DMT37600
OGETBUF  DS    0H                                                       DMT37610
         TM    BUFSYNSW,$TPPNONE   SHOULD WE STOP BUFFERING?            DMT37620
         BO    OGETBUF1       BUFFERING STOP                   @VA03306 DMT37630
         CLC   $BUFPOOL,=F'0'      ARE WE EMPTY?                        DMT37640
         BE    ORETURN             BR IF NONE (NOTE COND. CODE SET)     DMT37650
         L     R6,$BUFPOOL         GET FIRST BUFFER ADDR                DMT37660
         CLC   0(4,R6),=F'0'  ONLY ONE LEFT????                @VA03301 DMT37670
         BE    ORETURN        YEP...BETTER NOT USE IT          @VA03301 DMT37680
         MVC   $BUFPOOL(4),0(R6)   REMOVE THIS ONE FROM CHAIN           DMT37690
         ST    R6,OACTBUF          SET BUFFER ADDR                      DMT37700
         LA    R6,BUFDATA-BUFDSECT(,R6)                        HRC001DT DMT37710
         ST    R6,OBUFPTR          SET CURRENT POINTER                  DMT37720
         L     R14,TPBUFSIZ        GET TP BUFFER SIZE                   DMT37730
         SH    R14,=Y(BUFDATA+2-BUFSTART+2) ALLOW FOR HDR,ETB  @VA03348 DMT37740
         STH   R14,OBUFCNT         AND SAVE                             DMT37750
         B     OBUFOK              AND GO FIT RECORD                    DMT37760
         SPACE 1                                                        DMT37770
OGETBUF1 EQU   *                                               @VA03306 DMT37780
         SR    R6,R6          SET CONDITION CODE FIRST         @VA03306 DMT37790
         B     ORETURN        AND RETURN                       @VA03306 DMT37800
         EJECT                                                          DMT37810
*---------------------------------------------------------------------* DMT37820
*                                                                     * DMT37830
*              BUFFER IS FULL--SEND IT                                * DMT37840
*                                                                     * DMT37850
*---------------------------------------------------------------------* DMT37860
         SPACE 1                                                        DMT37870
OFLUSH   DS    0H                  ENTRY TO WRITE A PARTIAL BUFFER      DMT37880
         NI    BUFSYNSW,255-OFLSW  SET FLUSH SWITCH                     DMT37890
OBUFFULL DS    0H                                                       DMT37900
         L     R6,OBUFPTR          GET CURRENT BUFFER POINTER           DMT37910
         L     R13,OACTBUF         FOR $EXTP                            DMT37920
         USING BUFDSECT,R13        GET TP BUFFER ADDRESSABILITY         DMT37930
         MVI   0(R6),0             SET EOB                              DMT37940
         SR    R6,R13              SUBTRACT SOB                         DMT37950
         SH    R6,=Y(BUFSTART-BUFDSECT-1) MAKE COUNT ACTUAL             DMT37960
         STH   R6,BUFCOUNT         SET COUNT                            DMT37970
         SR    R6,R6               ZERO                                 DMT37980
         ST    R6,OBUFPTR          AND SHOW NO BUFFER                   DMT37990
         SPACE 1                                                        DMT38000
         USING BUFDSECT,R13        BUFFER ADDR IS IN R13                DMT38010
         LA    R6,$OUTBUF          QUEUE CONTROL WORD                   DMT38020
OBUFLOP  EQU   *                                                        DMT38030
         CLC   0(4,R6),=F'0'       IS IT THE LAST.QUEUE FOR TRANS       DMT38040
         BE    OBUFLOP1            YES                                  DMT38050
         L     R6,0(0,R6)          GET THE NEXT ONE                     DMT38060
         B     OBUFLOP             AND COMPARE                          DMT38070
         SPACE 1                                                        DMT38080
OBUFLOP1 EQU   *                                                        DMT38090
         ST    R13,0(0,R6)         CHAIN THIS ONE TO IT                 DMT38100
         MVC   0(4,R13),=F'0'      SET NEW FORWARD ZERO                 DMT38110
         SPACE 1                                                        DMT38120
         TM    BUFSYNSW,OFLSW      SHOULD WE FLUSH THE BUFFER?          DMT38130
         BO    OGETBUF             NO                                   DMT38140
         B     ORETOK              JUST RETURN IF FLUSH                 DMT38150
         DROP  R13                                                      DMT38160
         EJECT                                                          DMT38170
*---------------------------------------------------------------------* DMT38180
*                                                                     * DMT38190
*              RE-ENTRY POINT IF ORIGINAL $TPPUT NOT ACCEPTED         * DMT38200
*                R8=ORIGINAL TANK , R14= RETURN                       * DMT38210
*                                                                     * DMT38220
*---------------------------------------------------------------------* DMT38230
         SPACE 1                                                        DMT38240
$TPREPUT DS    0H                                                       DMT38250
         ST    R8,OINADD           SET FOR RESTORE                      DMT38260
         ST    R14,OSAVR14         RESET RETURN                         DMT38270
         ST    R5,OSAVR5           SAVE REG                             DMT38280
         ST    R6,OSAVR6           SAVE REG                             DMT38290
         LA    R15,1               Constant                    HRC001DT DMT38300
         LH    R5,TANKCHN          COMPRESSED COUNT                     DMT38310
         B     OREENT              ENTER FLOW                           DMT38320
         DROP  R8                                                       DMT38330
OTS      EQU   8                                                        DMT38340
         EJECT                                                          DMT38350
*.                                                                      DMT38360
*                                                                       DMT38370
* ENTRY NAME -                                                          DMT38380
*                                                                       DMT38390
*        $TPGET                                                         DMT38400
*                                                                       DMT38410
* FUNCTION -                                                            DMT38420
*                                                                       DMT38430
*        THIS ROUTINE DEBLOCKS RECEIVED TELECOMMUNICATIONS              DMT38440
*        BUFFERS INTO TANKS AND QUEUES THE TANK ONTO THE                DMT38450
*        APPROPRIATE PROCESSORS TCTTANK QUEUE.                          DMT38460
*                                                                       DMT38470
* CALLS TO OTHER ROUTINES -                                             DMT38480
*                                                                       DMT38490
*        NONE                                                           DMT38500
*                                                                       DMT38510
* OPERATION -                                                           DMT38520
*                                                                       DMT38530
*        1. GET A BUFFER FROM $INPUF QUEUE AND LOOK FOR                 DMT38540
*           A MATCHING TCT TO ATTACH THE BUFFER TO BY COMPARING         DMT38550
*           RCBS.                                                       DMT38560
*                                                                       DMT38570
*        2. GET A TANK TO DECOMPRESS A BUFFER INTO.                     DMT38580
*                                                                       DMT38590
*        3. DECOMPRESS THE BUFFER INTO THE TANK                         DMT38600
*                                                                       DMT38610
*        4. CHAIN THE TANK TO THE TCT TANK QUEUE FOR THE                DMT38620
*           PROCESSOR BEING SERVICED AND OPEN THE COMMUTATOR            DMT38630
*           GATE FOR THAT PROCESSOR.                                    DMT38640
*                                                                       DMT38650
* RESPONSES -                                                           DMT38660
*                                                                       DMT38670
*        NONE                                                           DMT38680
*                                                                       DMT38690
* ERROR MESSAGES -                                                      DMT38700
*                                                                       DMT38710
*        NONE                                                           DMT38720
*                                                                       DMT38730
*.                                                                      DMT38740
         SPACE 3                                                        DMT38750
*                                                                       DMT38760
*                                                                       DMT38770
$TPGET   DS    0H                  ENTERED FROM COMUTATOR               DMT38780
         MVI   $TPGETCM+1,CLOSE    CLOSE COMMUTATOR                     DMT38790
GDQ      EQU   *                                                        DMT38800
         TM    BUFSYNSW,GDQBUFS    STOP ALL BUFFERING?                  DMT38810
         BO    GWAIT               YES                                  DMT38820
GDQBUFS1 DS    0H                  BEGIN DEQUEUING CYCLE                DMT38830
         CLC   $INBUF,=F'0'        ARE WE EMPTY?                        DMT38840
         BE    GCONTTCT            YES                                  DMT38850
         L     R6,$INBUF           GET FIRST BUFFER ADDR                DMT38860
         MVC   $INBUF(4),0(R6)     REMOVE THIS ONE FROM CHAIN           DMT38870
         SPACE 1                                                        DMT38880
GDQBUFS2 EQU   *                                                        DMT38890
         LA    R8,BUFDATA-BUFDSECT DATA DISPLACEMENT                    DMT38900
         AR    R8,R6               R8=ACTUAL DATA ADDRESS               DMT38910
         BAL   R14,GASSIGN         GO ATTACH BUFFER TO TCT              DMT38920
         B     GDQBUFS1            AND CHECK AGAIN                      DMT38930
         SPACE 1                                                        DMT38940
GCONTTCT DS    0H                  SERVICE TCT'S                        DMT38950
         OI    BUFSYNSW,GDQBUFS    CLOSE DEQUE SW                       DMT38960
         SPACE 1                                                        DMT38970
         LA    R13,$TCT1           BEGINNING OF TCT'S                   DMT38980
         USING TCTDSECT,R13        **                                   DMT38990
GTEST    DS    0H                  *                                    DMT39000
         TM    TCTSTAT,TCTACT      IS ACTION REQUESTED                  DMT39010
         BO    GSERVICE            BR IF YES                            DMT39020
GNEXTTCT DS    0H                                                       DMT39030
         ICM   R13,B'1111',TCTNEXT TO NEXT TCT AND CHECK FOR END        DMT39040
         BNZ   GTEST               BR IF NO                             DMT39050
*                                                                       DMT39060
*              ALL TCT'S HAVE BEEN SERVICED...                          DMT39070
*                                                                       DMT39080
         B     GDQ                 GO TEST FOR MORE BUFFERS             DMT39090
         EJECT                                                          DMT39100
*                                                                       DMT39110
*              SERVICE TCT WITH ACTION BIT ON                           DMT39120
*                                                                       DMT39130
GSERVICE DS    0H                                                       DMT39140
         CLI   TCTBUFCT,0          ARE ANY BUFFERS AVAILABLE            DMT39150
         BNE   GTTANK              BR IF YES                            DMT39160
GNOACT   EQU   *                                                        DMT39170
         NI    TCTSTAT,255-TCTACT  NO... TURN OFF ACTION                DMT39180
         B     GNEXTTCT            AND CONTINUE                         DMT39190
         SPACE 1                                                        DMT39200
GTTANK   DS    0H                  A BUFFER IS PRESENT                  DMT39210
         CLC   TCTTNKCT,TCTTNKLM   ARE SUFFICIENT TANKS QUEUED          DMT39220
         BNL   GNOACT              BR IF YES                            DMT39230
         SPACE 1                                                        DMT39240
*                   A DECOMPRESSION IS REQUIRED                         DMT39250
         CLC   $TANKPOL,=F'0'      ARE WE EMPTY                         DMT39260
         BE    GWAIT                                                    DMT39270
         L     R5,$TANKPOL         GET FIRST BUFFER ADDR                DMT39280
         MVC   $TANKPOL(4),0(R5)   REMOVE THIS ONE FROM CHAIN           DMT39290
         USING TANKDSEC,R5         *                                    DMT39300
         MVI   TANKDATA,C' '  SET TO CLEAR TANK                @VA06381 DMT39310
         MVC   TANKDATA+1(L'TANKDATA-1),TANKDATA Clear tank    SML2NJE4 DMT39320
         L     R8,TCTBUFER         CURRENT BUFFER                       DMT39330
         LH    R15,(BUFCOUNT-BUFDSECT)(0,R8) GET COUNT                  DMT39340
         AR    R8,R15              ADD TO CURRENT COUNT                 DMT39350
         ST    R5,GTANK            SAVE TANK ADDR.                      DMT39360
         MVC   TANKRCB(2),0(R8)    MOVE RCB AND SRCB                    DMT39370
         LA    R15,1               Constant for speed          HRC001DT DMT39380
         CLI   0(R8),X'F0'    IS IT A GENERAL CONTROL RCB?     @VA03347 DMT39390
         BNE   GDECOMP        NO, GO & DECOMPRESS THE BUFFER   @VA03347 DMT39400
         MVC   TANKDATA(78),2(R8) YES, MOVE 78 BYTES INTO TANK @VA03347 DMT39410
         LA    R8,78(R8)      UPDATE POINTER IN BUFFER         @VA03347 DMT39420
         LA    R5,78(R5)      UPDATE POINTER IN TANK           @VA03347 DMT39430
         MVI   2(R8),X'00'    PUT ENDING SCB INTO BUFFER       @VA03347 DMT39440
         MVI   3(R8),X'00'    PUT ENDING RCB INTO BUFFER       @VA03347 DMT39450
         MVI   4(R8),XETB     PUT ETB INTO BUFFER              @VA03347 DMT39460
         B     GENDREC        GO TO PROCESS END OF RECORD      @VA03347 DMT39470
         EJECT                                                          DMT39480
*---------------------------------------------------------------------* DMT39490
*                                                                     * DMT39500
*                      DECOMPRESS A TP BUFFER                         * DMT39510
*                                                                     * DMT39520
*---------------------------------------------------------------------* DMT39530
         SPACE 1                                                        DMT39540
GDECOMP  DS    0H                  PROCESS AN SCB                       DMT39550
         MVC   GSCB(1),2(R8)       SET SCB                              DMT39560
         NI    GSCB,X'7F'          TURN OFF HIGH-BIT                    DMT39570
         BZ    GENDREC             END-OF-RECORD                        DMT39580
         MVC   GSCBCK(1),GSCB GET SCB TO TEST                  @VA06382 DMT39590
         TM    GSCBCK,X'40'   IS IT CHAR STRING                @VA06382 DMT39600
         BO    SCBCK          YES CHANGE STRIP COUNT           @VA06382 DMT39610
         NI    GSCBCK,X'1F'   STRIP THE INDICATOR BITS         @VA06382 DMT39620
SCCK2    SR    R6,R6          CLEAR R6                         @VA06382 DMT39630
         IC    R6,GSCBCK      GET STRING CONTROL BYTE          @VA06382 DMT39640
         AR    R6,R5          ADD TANK COUNT                   @VA06382 DMT39650
         S     R6,GTANK       SUBTRACT START ADDRESS           @VA06382 DMT39660
         CH    R6,TNKEND      WILL IT GO OVER TANK END         @VA06382 DMT39670
         BH    COMPERR        YES ERROR DONT DO IT             @VA06382 DMT39680
         TM    GSCB,X'40'          IS THIS A CHAR STRING...             DMT39690
         BZ    GPROP               BR IF NOT                            DMT39700
         NI    GSCB,X'3F'          TURN OFF STRING BIT                  DMT39710
         SR    R6,R6               CLEAR OUT R6 FOR IC                  DMT39720
         IC    R6,GSCB             GET STRING CONTROL BYTE              DMT39730
         EX    R6,GMVC1            MOVE BUFFER                          DMT39740
         AR    R8,R6               COUNT INPUT STRING                   DMT39750
GCONT    EQU   *                                                        DMT39760
         AR    R5,R6               COUNT OUTPUT STRING                  DMT39770
         AR    R8,R15              COUNT SCB                            DMT39780
         B     GDECOMP             CONTINUE WITH RECORD                 DMT39790
         SPACE 1                                                        DMT39800
GPROP    DS    0H                  PROPGATION REQUIRED                  DMT39810
         TM    GSCB,X'20'          IS THIS BLANKS...                    DMT39820
         BZ    GBLANKS             BR IF YES                            DMT39830
         NI    GSCB,X'1F'          NO .. REMOVE INDICATOR               DMT39840
         MVC   TANKDATA(1),3(R8)   SET SAMPLE CHARACTER                 DMT39850
         SR    R6,R6               CLEAR OUT R6 FOR IC                  DMT39860
         IC    R6,GSCB             GET STRING CONTROL BYTE              DMT39870
         BCTR  R6,0           REDUCE BY ONE FOR TANKDATA       @VA06381 DMT39880
         LTR   R6,R6                   IS MOVE FOR 1 BYTE ONLY @VA07697 DMT39890
         BZ    GDECONE                 YES,DONT DECREMENT MORE @VA07697 DMT39900
         BCTR  R6,0           REDUCE BY ONE FOR MOVE           @VA06381 DMT39910
         EX    R6,GMVC2            PROPAGATE COUNT (+2)                 DMT39920
         AR    R8,R15              COUNT SAMPLE CHAR                    DMT39930
         LA    R6,2(0,R6)     CORRECT CHAR COUNT               @VA06381 DMT39940
         B     GCONT               AND ENTER FLOW                       DMT39950
GDECONE  EQU   *                       EXPAND ONE BYTE ONLY    @VA07697 DMT39960
         AR    R8,R15                  COUNT SAMPLE CHAR       @VA07697 DMT39970
         LA    R6,1(0,R6)              CORRECT CHAR COUNT      @VA07697 DMT39980
         B     GCONT                   CONTINUE PROCESSING     @VA07697 DMT39990
         SPACE 1                                                        DMT40000
GBLANKS  DS    0H                  BLANK PROPAGATION REQUIRED           DMT40010
         MVI   TANKDATA,C' '       SET BLANK SAMPLE                     DMT40020
         SR    R6,R6               CLEAR OUT R6 FOR IC                  DMT40030
         IC    R6,GSCB             GET STRING CONTROL BYTE              DMT40040
         BCTR  R6,0           REDUCE BY ONE FOR MOVE           @VA06381 DMT40050
         EX    R6,GMVC2            PROPAGATE BLANKS                     DMT40060
         AR    R6,R15         CORRECT CHAR COUNT               @VA06381 DMT40070
         B     GCONT               ENTER FLOW                           DMT40080
         SPACE 1                                                        DMT40090
GMVC1    MVC   TANKDATA(0),3(R8)   TO BE EXECUTED BY ABOVE CODE         DMT40100
GMVC2    MVC   TANKDATA+1(0),TANKDATA TO BE EXECUTED BY ABOVE CODE      DMT40110
COMPERR  DS    0H             HERE ON COMPRESSION ERROR        @VA06382 DMT40120
         MSGX  937,AXSLINK    WRITE ERROR MSG                  @VA06382 DMT40130
         B     EOJ            GO TO END THIS                   @VA06382 DMT40140
SCBCK    NI    GSCBCK,X'3F'   USE THIS STRIP COUNT             @VA06382 DMT40150
         B     SCCK2          GO BACK TO TEST LENGTH           @VA06382 DMT40160
TNKEND   DC    AL2(TANKEND-TANKDSEC) Total tank length         SML2NJE4 DMT40170
         EJECT                                                          DMT40180
GENDREC  DS    0H                  END OF LOGICAL RECORD                DMT40190
         L     R6,GTANK            TANK ADDR                            DMT40200
         SR    R5,R6               FROM END PTR                         DMT40210
         DROP  R5                                                       DMT40220
         USING TANKDSEC,R6         GET TANKDSEC ADDRESSABILTIY          DMT40230
         STH   R5,TANKCNT          SET COUNT IN TANK                    DMT40240
         LA    R5,TCTTANK-TCTDSECT TANK CHAIN DISPLACEMENT              DMT40250
         AR    R5,R13              R5 = ABSOLUTE TANK CHAIN PTR         DMT40260
GENDREC1 EQU   *                                                        DMT40270
         CLC   0(4,R5),=F'0'       IS IT THE LAST?                      DMT40280
         BE    GENDREC2            YES                                  DMT40290
         L     R5,0(0,R5)          GET THE NEXT ONE                     DMT40300
         B     GENDREC1            AND COMPARE                          DMT40310
         SPACE 1                                                        DMT40320
GENDREC2 EQU   *                                                        DMT40330
         ST    R6,0(0,R5)          CHAIN THIS ONE TO IT                 DMT40340
         MVC   0(4,R6),=F'0'       SET NEW FORWARD ZERO                 DMT40350
         LA    R8,3(,R8)           Add in three                HRC001DT DMT40360
         LH    R5,TCTTNKLM         LIMIT AND COUNT                      DMT40370
         AR    R5,R15              INCREMENT COUNT                      DMT40380
         STH   R5,TCTTNKLM         AND RESET                            DMT40390
         L     R5,TCTCOM           GET COMMUTATOR ENTRY                 DMT40400
         MVI   1(R5),OPEN          OPEN PROCESSOR GATE                  DMT40410
         L     R6,TCTBUFER         CURRENT BUFFER ADDR                  DMT40420
         CLC   TCTRCBR,0(R8)       IS NEXT RECORD SAME                  DMT40430
         BNE   GSWITCH             BR IF NO                             DMT40440
         SR    R8,R6               REDUCE TO DATA DISPLACEMENT          DMT40450
         STH   R8,BUFCOUNT-BUFDSECT(0,R6)                               DMT40460
         B     GTTANK              AND CONTINUE                         DMT40470
         SPACE 1                                                        DMT40480
GSWITCH  DS    0H                  DIFFERENT RCB ENCOUNTERED            DMT40490
         NI    BUFSYNSW,255-GDQBUFS ALLOW DEQUEUING TRY                 DMT40500
         MVC   TCTBUFER,0(R6)      UPDATE CHAIN                         DMT40510
         BAL   R14,GASSIGN         GO RE-ASSIGN BUFFER                  DMT40520
         LH    R8,TCTBUFLM         BUFFER LIMIT AND COUNT               DMT40530
         BCTR  R8,0                REDUCE COUNT                         DMT40540
         STH   R8,TCTBUFLM         AND RESET                            DMT40550
         CLC   TCTBUFCT,TCTBUFLM   IS ANOTHER BUFFER REQUIRED           DMT40560
         BNL   GSERVICE            BR IF NO TO CONTINUE                 DMT40570
         OC    $FCSOUT,TCTFCS      SHOW NEXT BUFFER PERMITTED           DMT40580
         B     GSERVICE            AND CONTINUE                         DMT40590
         EJECT                                                          DMT40600
*---------------------------------------------------------------------* DMT40610
*                                                                     * DMT40620
*                       ASSIGN A TP BUFFER TO A TCT                   * DMT40630
*                                                                     * DMT40640
*              R6=BUFFER ADDRESS , R8=PTR TO CURRENT RCB IN BUFFER    * DMT40650
*                                                                     * DMT40660
*---------------------------------------------------------------------* DMT40670
         SPACE 1                                                        DMT40680
GASSIGN  DS    0H                  ASSIGN BUFFER TO CORRECT TCT         DMT40690
         ST    R13,GAST            PRESERVE TCT REG                     DMT40700
         LA    R13,$TCT1           START OF TCT'S                       DMT40710
GASNEXT  DS    0H                  *                                    DMT40720
         CLC   TCTRCBR,0(R8)       COMPARE RCB'S                        DMT40730
         BE    GASIT               BR IF FOUND                          DMT40740
         ICM   R13,B'1111',TCTNEXT TO NEXT AND CHECK FOR END            DMT40750
         BNZ   GASNEXT             BR IF NO TO CONTINUE                 DMT40760
         CLI   0(R8),0             IS THIS A NULL BUFFER                DMT40770
         BNE   GCTLCHK             BR IF NO                             DMT40780
         SPACE 1                                                        DMT40790
GIGNORIT DS    0H                  *                                    DMT40800
         MVC   0(4,R6),$BUFPOOL    GET FIRST FREE OFF QUEUE             DMT40810
         ST    R6,$BUFPOOL         MAKE THIS ONE THE FIRST              DMT40820
         TM    WCTSTAT,TCTREL      ARE MESSAGES QUEUED?                 DMT40830
         BNO   GIGNORT1            NO CONTINUE                          DMT40840
         OI    $MSGCOM+1,OPEN      OPEN THE MSG GATE                    DMT40850
         B     GASRET              DONT CHECK ANYTHING ELSE TILL LATER  DMT40860
         SPACE 1                                                        DMT40870
GIGNORT1 EQU   *                                                        DMT40880
         CLI   PCTWFB,X'FF'        PRT/PUN awaiting ACK buffer?SML2NJE4 DMT40890
         BNE   GIGNORT2                                        SML2NJE4 DMT40900
         OI    $PCOMM1+1,OPEN      Open the PRT/PUN gate       SML2NJE4 DMT40910
         B     GASRET              And return                  SML2NJE4 DMT40920
GIGNORT2 EQU   *                                               SML2NJE4 DMT40930
         CLI   RCTWFB,X'FF'        READER WAITING?                      DMT40940
         BNE   GASRET              NO - RETURN                          DMT40950
         OI    $RCOMM1+1,OPEN      OPEN THE READER GATE                 DMT40960
         B     GASRET              AND RETURN                           DMT40970
         SPACE 1                                                        DMT40980
GCTLCHK  DS    0H                  TEST FOR CONTROL RECORD              DMT40990
         CLI   0(R8),X'F0'         GENERAL CONTROL RECORD?              DMT41000
         BE    GCTLCHK1            YES GO PROCESS IT                    DMT41010
         TM    0(R8),15            IS RECORD TYPE = 0000                DMT41020
         BNZ   GIGNORIT            NO...SKIP RECORD(AND BUFFER)         DMT41030
GCTLCHK1 EQU   *                                                        DMT41040
         LA    R13,$CTLTCT         TYPE IS CTL...LOAD TCT               DMT41050
         EJECT                                                          DMT41060
GASIT    DS    0H                  TCT FOUND                            DMT41070
         SR    R8,R6               R8 = DATA DISPLACEMENT               DMT41080
         STH   R8,BUFCOUNT-BUFDSECT(0,R6) SAVE                          DMT41090
         LA    R8,TCTBUFER-TCTDSECT ACTUAL DISP                         DMT41100
         AR    R8,R13              ACTUAL ADDRESS                       DMT41110
GASIT1   EQU   *                                                        DMT41120
         CLC   0(4,R8),=F'0'       IS IT THE LAST                       DMT41130
         BE    GASIT2              YES                                  DMT41140
         L     R8,0(0,R8)          GET THE NEXT ONE                     DMT41150
         B     GASIT1              AND COMPARE                          DMT41160
         SPACE 1                                                        DMT41170
GASIT2   EQU   *                                                        DMT41180
         ST    R6,0(0,R8)          CHAIN THIS ONE TO IT                 DMT41190
         MVC   0(4,R6),=F'0'       SET NEW FORWARD ZERO                 DMT41200
         LH    R8,TCTBUFLM         LIMIT AND COUNT                      DMT41210
         LA    R8,1(,R8)           Count this                  HRC001DT DMT41220
         STH   R8,TCTBUFLM         AND RESET                            DMT41230
         OI    TCTSTAT,TCTACT      START ACTION                         DMT41240
         CLC   TCTBUFCT,TCTBUFLM   ARE ENOUGH BUFFERS HERE              DMT41250
         BL    GASRET              BR IF MORE BUFFERS NEEDED            DMT41260
         OC    $FCSOUT,TCTFCS      MODIFY FCS                           DMT41270
         XC    $FCSOUT,TCTFCS      TO STOP THIS STREAM                  DMT41280
GASRET   DS    0H                  RETURN ENTRY                         DMT41290
         L     R13,GAST            AND RETURN                           DMT41300
         BR    R14                 TO CALLER                            DMT41310
         SPACE 1                                                        DMT41320
GWAIT    DS    0H                  PREPARE FOR EXIT                     DMT41330
         NI    BUFSYNSW,255-GDQBUFS OPEN DEQUEUE GATE                   DMT41340
         B     $TPGETCM+4          EXIT                                 DMT41350
         SPACE 1                                                        DMT41360
         DROP  R6,R13              DISCONTINUE TANK REG                 DMT41370
         EJECT                                                          DMT41380
*---------------------------------------------------------------------* DMT41390
*                                                                     * DMT41400
*        $GETTNK           ROUTINE TO GET A TANK FOR PROCESSOR        * DMT41410
*                                                                     * DMT41420
*---------------------------------------------------------------------* DMT41430
         SPACE 1                                                        DMT41440
         USING TCTDSECT,TCTR       GET TCT ADDRESSABILITY               DMT41450
$GETTNK  DS    0H                                                       DMT41460
         ST    R14,TCTSAV1         SAVE USER REG FOR POSSIBLE WAIT      DMT41470
         MVC   TCTENTY(2),OACN2    SET REENTRY FOR POSSIBLE WAIT        DMT41480
OLOC2    EQU   *                                                        DMT41490
         CLC   TCTTANK,=F'0'       ARE WE EMPTY?                        DMT41500
         BE    $CLOSTCT            YES                                  DMT41510
         L     R8,TCTTANK          GET FIRST BUFFER ADDR                DMT41520
         MVC   TCTTANK(4),0(R8)    REMOVE THIS ONE FROM CHAIN           DMT41530
         LH    R6,TCTTNKLM         REDUCES COUNT IN TNKCT               DMT41540
         BCTR  R6,0                DOWN BY ONE                          DMT41550
         STH   R6,TCTTNKLM         AND REPLACE COUNT                    DMT41560
         OI    TCTSTAT,TCTACT      SIGNAL WE HAVE RECEIVED TANK         DMT41570
         MVI   $TPGETCM+1,OPEN     OPEN THE GATE TO TPGET ROUTINE       DMT41580
         L     R14,TCTSAV1         PICK UP USER                         DMT41590
         BR    R14                 RETURN TO HIM                        DMT41600
         SPACE 1                                                        DMT41610
*                                                                       DMT41620
*        $CLOSTCT                  ROUTINE TO CLOSE GATE AND RETURN     DMT41630
*                                                                       DMT41640
$CLOSTCT DS    0H                                                       DMT41650
         L     R6,TCTCOM           PICK UP COMMUTATOR                   DMT41660
         MVI   1(R6),CLOSE         CLOSE GATE                           DMT41670
         B     4(R6)               RETURN TO COMMUTATOR                 DMT41680
         SPACE 1                                                        DMT41690
OACN2    DC    S(OLOC2)            RENTRY POINT                         DMT41700
         EJECT                                                          DMT41710
*---------------------------------------------------------------------* DMT41720
*                                                                     * DMT41730
*                  $TPOPEN -- OPEN A STREAM                           * DMT41740
*                                                                     * DMT41750
*---------------------------------------------------------------------* DMT41760
         SPACE 1                                                        DMT41770
$TPOPEN  DS    0H                                                       DMT41780
         MVI   TTANK+TANKRCB-TANKDSEC,X'90' RCB to open stream SML2NJE4 DMT41790
$TPOPACK EQU   *                                               SML2NJE4 DMT41800
         ST    R14,TSAVA           SAVE CALLER'S                        DMT41810
         ST    R8,TSAVB            REGS                                 DMT41820
         MVC   TTANK+TANKSRCB-TANKDSEC(1),TANKRCB-TANKDSEC(R8) SET FCN  DMT41830
         L     R8,TANKCON          FOR $TPPUT                           DMT41840
         BAL   R14,$TPPUT          GO PUT RECORD                        DMT41850
         L     R8,TSAVB            CALLER'S                             DMT41860
         L     R14,TSAVA           REGS                                 DMT41870
         BR    R14                 RETURN TO CALLER                     DMT41880
         SPACE 1                                                        DMT41890
*---------------------------------------------------------------------* DMT41900
*                                                                     * DMT41910
*                  $TPACKTC -- Acknowledge transmission complete      * DMT41920
*                                                                     * DMT41930
*---------------------------------------------------------------------* DMT41940
$TPACKTC DS    0H                                              SML2NJE4 DMT41950
         MVI   TTANK+TANKRCB-TANKDSEC,X'C0' RCB to Acknowledge SML2NJE4 DMT41960
         B     $TPOPACK                                        SML2NJE4 DMT41970
         EJECT                                                          DMT41980
*.                                                                      DMT41990
*                                                                       DMT42000
* ENTRY NAME -                                                          DMT42010
*                                                                       DMT42020
*        COMSUP                                                         DMT42030
*                                                                       DMT42040
* FUNCTION -                                                            DMT42050
*                                                                       DMT42060
*        THIS ROUTINE IS RESPONSIBLE FOR ALL I/O ON THE                 DMT42070
*        COMMUNICATIONS LINE.  IT DEQUEUES TP BUFFERS FROM              DMT42080
*        $OUTBUF FOR TRANSMISSION AND QUEUES RECEIVED TP BUFFERS        DMT42090
*        ONTO THE $INBUF QUEUE FOR DEBLOCKING BY $TPGET.                DMT42100
*                                                                       DMT42110
* CALLS TO OTHER ROUTINES -                                             DMT42120
*                                                                       DMT42130
*        DMTIOMRQ - TO INITIATE AN I/O OPERATION                        DMT42140
*                                                                       DMT42150
* OPERATION -                                                           DMT42160
*                                                                       DMT42170
*        1. CLOSE THE LINE INTERRUPT ENTRY IN THE COMMUTATOR            DMT42180
*           TABLE AND CHECK CSW FOR ERRORS.                             DMT42190
*                                                                       DMT42200
*        2. CHECK BSC CONTROL CHARACTERS ON THE BUFFER RECEIVED         DMT42210
*           TO DETERMINE THE KIND OF RESPONSE FROM THE LINE             DMT42220
*                                                                       DMT42230
*        3. PROCESS AN ACK RESPONSE BY TRYING TO OBTAIN AN OUTPUT       DMT42240
*           BUFFER AND WRITING IT TO THE LINE.                          DMT42250
*                                                                       DMT42260
*        4. PROCESS STX RESPONSE BY VERIFYING THE BSC CONTROL           DMT42270
*           CHARACTERS AND QUEUEING THE INPUT BUFFER FOR DEBLOCKING     DMT42280
*           BY $TPGET.                                                  DMT42290
*                                                                       DMT42300
*        5. PROCESS NAK RESPONSE REST THE BSC LEADER CHARACTER AND RE-  DMT42310
*           WRITE THE BUFFER.                                           DMT42320
*                                                                       DMT42330
* RESPONSES -                                                           DMT42340
*                                                                       DMT42350
*        NONE                                                           DMT42360
*                                                                       DMT42370
* ERROR MESSAGES -                                                      DMT42380
*                                                                       DMT42390
*        NONE                                                           DMT42400
*                                                                       DMT42410
*.                                                                      DMT42420
         EJECT                                                          DMT42430
         USING LINKTABL,R6         GET LINKTABLE ADDRESSABILITY         DMT42440
COMSUP   EQU   *                                                        DMT42450
$INTRUPT MVI   $COMCOM+5,CLOSE                                          DMT42460
         TM    BUFSYNSW,$COMBUSY   IS THERE COMMUNICATIONS ACTIVE?      DMT42470
         BO    CEXIT               NO                                   DMT42480
         STM   R13,R15,CREGS       SAVE INTERRUPTED REGS                DMT42490
         L     R13,CBUFFER         GET CURRENT BUFFER ADDR              DMT42500
         TM    BUFSYNSW,CUWFAKE    DUMMY I/O                            DMT42510
         BO    CWRTSIO             YES                                  DMT42520
         TM    ADACSW+5,X'BF'      TEST FOR UNEXPECTED ERRORS           DMT42530
         BNZ   CBADERR             BR IF ANY                            DMT42540
         TM    ADACSW+4,X'F3'      TEST OTHER UNUSUAL ENDINGS           DMT42550
         BNZ   CERROR              BR IF ANY                            DMT42560
*              CHANNEL-END , DEVICE-END ASSUMED                         DMT42570
         EJECT                                                          DMT42580
         SPACE 3                                                        DMT42590
$ENDREAD DS    0H                  EXTERNAL ENTRY POINT                 DMT42600
         SPACE 1                                                        DMT42610
         USING BUFDSECT,R13        *                                    DMT42620
CNOLOGAL DS    0H                  ENTRY TO SKIP LOGGING EVERYTHING     DMT42630
         MVC   CCWC+6(2),RDCOUNT       RESET BUFFER SIZE       @VA08725 DMT42640
         TM    XJESYS,PRIMARY      Is remote end primary?      SML2NJE4 DMT42650
         BNO   CNOLOG0             NO CONTINUE                          DMT42660
         CLC   BUFSTART(2),IPRISEQ Did we get the start?       SML2NJE4 DMT42670
         BE    CACKED              YES TREAT LIKE ACK                   DMT42680
CNOLOG0  EQU   *                                                        DMT42690
         BAL   R14,TRTRAN          LOG THE TRANSACTION                  DMT42700
         MVC   CRESP,BUFSTART      GET FIRST RESPONSE BYTE              DMT42710
         XC    TOCNT(2),TOCNT CLEAR TIMEOUT COUNTER            @VA05950 DMT42720
         CLI   CRESP,XDLE          IS IT DLE LEADER...                  DMT42730
         BNE   CNOLOG1             BR IF NO                             DMT42740
         MVC   CRESP,BUFSTART+1    YES... GET REAL RESPONSE             DMT42750
CNOLOG1  EQU   *                                                        DMT42760
         CLI   CRESP,XSOH          IS THIS NON-XPARENT LEADER...        DMT42770
         BE    CINBUF              BR IF YES TO PROCESS TEXT            DMT42780
         CLI   CRESP,XSTX          IS THIS DATA                         DMT42790
         BE    CINBUF              BR IF YES TO PROCESS                 DMT42800
         CLI   CRESP,XACK0         IS THIS WRITE ACKNOWLEDGEMENT        DMT42810
         BE    CACKED              BR IF YES                            DMT42820
         CLI   CRESP,XNAK          WERE WE NAK'ED                       DMT42830
         BE    CNAKED              BR IF YES                            DMT42840
         B     CRESPBAD            UNKNOWN RESPONSE RECEIVED            DMT42850
         EJECT                                                          DMT42860
*                                                                       DMT42870
*              POSITIVE ACKNOWLEDGEMENT OF LAST WRITE RECEIVED          DMT42880
*                                                                       DMT42890
         SPACE 3                                                        DMT42900
CACKED   DS    0H                  ACKNOWLEDGEMENT WAS ACK              DMT42910
         TM    BUFSTAT,BUFTONAK+BUFNAK NAK SENT AFTER T/O      @VA08636 DMT42920
         BO    CNAKNAK                 NAK AFTER T/O ON DATA   @VA08636 DMT42930
         NI    BUFSTAT,X'FF'-BUFTONAK  RESET T/O INDICATOR     @VA08636 DMT42940
         NI    $FCSIN,255-X'40'    TURN OFF WAIT-A-BIT                  DMT42950
         OI    BUFSYNSW,CACKSW     SET ACK RECEIVED                     DMT42960
CWRTOK   DS    0H                                                       DMT42970
         TM    BUFSTAT,BUFFAKE     IS THIS A DUMMY BUFFER               DMT42980
         BO    CWRTNEXT            BR IF YES                            DMT42990
         MVI   BUFSTAT,0           RESET STATUS BYTE                    DMT43000
         MVC   0(4,R13),$BUFPOOL   GET FIRST FREE OFF QUEUE             DMT43010
         ST    R13,$BUFPOOL        MAKE THIS ONE THE FIRST              DMT43020
         TM    WCTSTAT,TCTREL      IS THE MSG PROC WAITING?             DMT43030
         BNO   CWRTOK1             NO CONTINUE                          DMT43040
         OI    $MSGCOM+1,OPEN      OPEN THE MSG GATE                    DMT43050
         B     CWRTNEXT            AND CONTINUE                         DMT43060
         SPACE                                                          DMT43070
CWRTOK1  EQU   *                                                        DMT43080
         CLI   PCTWFB,X'FF'        PRT/PUN waiting to send ACK?SML2NJE4 DMT43090
         BNE   CWRTOK2             No - continue               SML2NJE4 DMT43100
         OI    $PCOMM1+1,OPEN      Open the PRT/PUN gate       SML2NJE4 DMT43110
CWRTOK2  EQU   *                                               SML2NJE4 DMT43120
         CLI   RCTWFB,X'FF'        IS THE READER WAITING?               DMT43130
         BNE   CWRTNEXT            NO - CONTINUE                        DMT43140
         OI    $RCOMM1+1,OPEN      OPEN THE READER GATE                 DMT43150
CWRTNEXT EQU   *                   ENTRY TO START NEXT WRITE            DMT43160
         TM    BUFSYNSW,CACKSW     WAS AN ACK RECEIVED?                 DMT43170
         BO    CNOD                YES                                  DMT43180
         BAL   R15,CSETCOM         MAKE A COMMUTATOR PASS               DMT43190
         BAL   R15,CSETCOM         AND ANOTHER                          DMT43200
CNOD     EQU   *                   ACK BYPASS                           DMT43210
         NI    BUFSYNSW,255-CACKSW RESET SWITCH                         DMT43220
CYCLE    EQU   *                   COMMUTATOR CYCLE POINT               DMT43230
         TM    $FCSIN,X'40'        IS WAIT-A-BIT SET                    DMT43240
         BO    CWAITBIT            BR IF YES                            DMT43250
         MVC   CFCSTEMP(2),$FCSIN MOVE RECEIVED TO TEMP AREA   @VA03301 DMT43260
         NC    CFCSTEMP(2),CFCSSTD SETUP FOR TEST              @VA03301 DMT43270
         XC    CFCSTEMP(2),CFCSSTD TEST AGAINST STANDARD       @VA03301 DMT43280
         BC    4,CWAITBIT     STREAM IS NEGATED                @VA03301 DMT43290
CYCLE1   EQU   *                                               @VA03301 DMT43300
         NI    BUFSYNSW,255-$TPPNONE RESET BUFFERING STOP               DMT43310
         L     R6,XJELINK          Get link table address      HRC000DT DMT43320
         USING LINKTABL,R6         Link table addressability   SML2NJE3 DMT43330
         TM    LFLAG,LHOLD         ARE ARE HELD?                        DMT43340
         BO    CRESPOND       SEND RESPONSE                    @VA05952 DMT43350
         DROP  R6                  Finished with link table    SML2NJE3 DMT43360
         CLC   $OUTBUF,=F'0'       ARE WE EMPTY                         DMT43370
         BE    CRESPOND            YES                                  DMT43380
         L     R13,$OUTBUF         GET FIRST BUFFER ADDR                DMT43390
         MVC   $OUTBUF(4),0(R13)   REMOVE THIS ONE FROM CHAIN           DMT43400
         EJECT                                                          DMT43410
         SPACE 4                                                        DMT43420
CSTNDWRT DS    0H                  ENTRY FOR BUFFER WRITE WITH BCB      DMT43430
         MVC   BUFSTART,XSTXSEQ    SET START OF TEXT HEADER             DMT43440
         OI    BUFSTAT,BUFTEXT     SHOW TEXT BUFFER                     DMT43450
         MVC   CSETBCB(1),CBCBCNTO BCB FOR CURRENT BUFFER               DMT43460
         LH    R15,CBCBCNTO-1      GET CURRENT COUNT                    DMT43470
         LA    R15,1(,R15)         Increment to next           HRC001DT DMT43480
         STH   R15,CBCBCNTO-1      AND SAVE                             DMT43490
         NI    CBCBCNTO,X'80'+15   MODULO 16                            DMT43500
         B     CNWRITE             GO WRITE BUFFER                      DMT43510
         SPACE 3                                                        DMT43520
*                                                                       DMT43530
*              WAIT-A-BIT SEQUENCE RECEIVED                             DMT43540
*                                                                       DMT43550
         SPACE 1                                                        DMT43560
CWAITBIT DS    0H                  *                                    DMT43570
         OI    BUFSYNSW,$TPPNONE   STOP ALL BUFFERING                   DMT43580
         B     CRESPOND            GO RESPOND                           DMT43590
         EJECT                                                          DMT43600
         SPACE 3                                                        DMT43610
CINBUF   DS    0H                  *                                    DMT43620
         TM    BUFSTAT,BUFFAKE         IS THIS A DUMMY BUFFER? @VA08779 DMT43630
         BO    WAITON                  YES, NO CALC REQUIRED   @VA08779 DMT43640
         CLI   BUFDATA,X'E0'       SEE IF HE IS RESETING                DMT43650
         BE    CBCBRSET            AND GO TRY TO RESET THINGS           DMT43660
         LA    R15,BUFSTART-1      GET START OF ACTUAL BUFFER           DMT43670
         A     R15,TPBUFSIZ        POSITION TO END OF BUFFER            DMT43680
         SH    R15,ADACSW+6        SUBSTACT OUT RESIDUAL COUNT          DMT43690
         CLI   0(R15),XETB         WAS ENDING SEQUENCE CORRECT          DMT43700
         BNE   CRESPBAD            BR IF YES TO LOG AND NAK             DMT43710
WAITON   EQU   *                       NO CALC FOR BUFFER REQ  @VA08779 DMT43720
         MVC   $FCSIN,BUFFCS       SET NEW FUNCTION CONTROL             DMT43730
         SPACE 1                                                        DMT43740
*              VERIFY BLOCK CONTROL BYTE COUNT                          DMT43750
         MVC   CBCB(1),BUFBCB      GET BCB COUNT                        DMT43760
         CLC   CBCBCNTI(1),CBCB    DOES RECEIVED MATCH EXPECTED         DMT43770
         BNE   CBCBCHEK            BR IF NO                             DMT43780
         LH    R15,CBCBCNTI-1      GET CURRENT COUNT                    DMT43790
         LA    R15,1(,R15)         To next expected            HRC001DT DMT43800
         STH   R15,CBCBCNTI-1      AND RESET                            DMT43810
         NI    CBCBCNTI,X'80'+15   MOLULO 16                            DMT43820
         SPACE 1                                                        DMT43830
CBCBOK   DS    0H                  ENTRY FROM IGNORE                    DMT43840
         TM    BUFSTAT,BUFFAKE     IS THIS DUMMY BUFFER                 DMT43850
         BO    CWRTOK              BR IF YES TO IGNORE                  DMT43860
         CLI   BUFDATA,X'00'       IS IT A NULL BUFFER?                 DMT43870
         BE    CWRTOK              YES..ALL DONE                        DMT43880
         CLI   BUFDATA+1,C'B'      Q. IF SIGN-OFF RECORD FROM C         DMT43890
         BNE   CNOTOFF             IF NO CONTINUE                       DMT43900
*        Should also check hold, buffers, cancel I/O etc       SML2NJE4 DMT43910
         BAL   R14,CLOSEURS        Close any open UR devices   SML2NJE4 DMT43920
         B     ISIO                Go back to the beginning    SML2NJE4 DMT43930
         SPACE 1                                                        DMT43940
CNOTOFF  EQU   *                                                        DMT43950
         MVI   $TPGETCM+1,OPEN     OPEN TPGETS GATE                     DMT43960
         MVI   BUFSTAT,0           RESET BUFFER STATUS BITS             DMT43970
         LA    R15,$INBUF          QUEUE CONTROL WORD                   DMT43980
CINBUF1  EQU   *                                                        DMT43990
         CLC   0(4,R15),=F'0'      IS IT THE LAST                       DMT44000
         BE    CINBUF2             YES                                  DMT44010
         L     R15,0(0,R15)        GET THE NEXT ONE                     DMT44020
         B     CINBUF1             AND COMPARE                          DMT44030
         SPACE 1                                                        DMT44040
CINBUF2  EQU   *                                                        DMT44050
         ST    R13,0(0,R15)        CHAIN THIS ONE TO IT                 DMT44060
         MVC   0(4,R13),=F'0'      SET NEW FORWARD ZERO                 DMT44070
         B     CWRTNEXT            AND CONTINUE XMISSION                DMT44080
         EJECT                                                          DMT44090
*                                                                       DMT44100
*              RECEIVED BCB CHECK COUNT NOT CORRECT                     DMT44110
*                                                                       DMT44120
CBCBCHEK DS    0H                  DETERMINE DAMAGE                     DMT44130
         TM    CBCB,BCBIGNRE       IS THE IGNORE BIT ON                 DMT44140
         BO    CBCBOK              BR IF YES                            DMT44150
         TM    CBCB,BCBRESET       IS THIS A RESET REQUEST              DMT44160
         BZ    CBCBBAD             BR IF NO                             DMT44170
         MVN   CBCBCNTI(1),CBCB    YES... DO IT                         DMT44180
         B     CBCBOK              AND PROCESS RECORD                   DMT44190
         SPACE 1                                                        DMT44200
CBCBBAD  DS    0H                  BLOCK COUNTS DO NOT AGREE            DMT44210
         MVC   CTEMP+1(1),CBCB     ISOLATE RECEIVED CNT                 DMT44220
         LH    R15,CBCBCNTI-1      GET EXPECTED CNT                     DMT44230
         SH    R15,CTEMP           LESS RECEIVED                        DMT44240
         BP    CBCBBAD1            BR IF TOO LOW                        DMT44250
         AH    R15,=H'16'          MAKE DIFFERENCE POSITIVE             DMT44260
CBCBBAD1 EQU   *                                                        DMT44270
         CH    R15,CMAXDUP         IS DIFFERENCE REASONABLE             DMT44280
         BH    CBLKLOST            BR IF NO                             DMT44290
         B     CWRTOK              IGNORE BLOCK                         DMT44300
         SPACE 2                                                        DMT44310
CBLKLOST DS    0H                  ONE OR MORE BLOCKS ARE LOST          DMT44320
         MVN   CLOSTBCB,CBCB       SET RECEIVED BLOCK COUNT             DMT44330
         MVN   CLSTSRCB,CBCBCNTI   SET EXPECTED BLOCK COUNT             DMT44340
         MVC   BUFCOUNT(CLOSTEND-CLOSTBLK),CLOSTBLK SET BAD BLOCK       DMT44350
         MVC   CSETBCB(1),CLOSTBCB SET RESTORE BCB INSTRUCTION V03.1    DMT44360
         B     CNWRITE             GO TELL OTHER SIDE ABOUT BAD BCB     DMT44370
         EJECT                                                          DMT44380
         SPACE 3                                                        DMT44390
CRESPOND DS    0H                  ENTRY TO RESPOND                     DMT44400
         L     R6,XJELINK          Get link table address      HRC000DT DMT44410
         CLC   $BUFPOOL,=F'0'      ARE WE EMPTY?                        DMT44420
         BE    CSTOPIN             YES                                  DMT44430
         L     R13,$BUFPOOL        GET FIRST BUFFER ADDR                DMT44440
         MVC   $BUFPOOL(4),0(R13)  REMOVE THIS ONE FROM CHAIN           DMT44450
         B     CBUFGOTN            BR IF GOTTEN                         DMT44460
         SPACE 1                                                        DMT44470
CSTOPIN  DS    0H                  ENTRY TO STOP ALL INPUT              DMT44480
         LA    R13,CDUMMY          USE DUMMY BUFFER                     DMT44490
         MVI   BUFDATA,0           SET NULL BUFFER RCB                  DMT44500
         MVI   BUFSTAT,BUFFAKE     FORCE STATUS TO DUMMY                DMT44510
         B     CSTNDWRT            GO DO NORMAL WRITE                   DMT44520
         SPACE 1                                                        DMT44530
CBUFGOTN DS    0H                                                       DMT44540
         MVI   BUFDATA,0           SET NULL BUFFER RCB                  DMT44550
         MVC   BUFCOUNT,=AL2(CDUMEND-CDUMSTRT) SET WRITE COUNT          DMT44560
         CLC   CFCSOUT,$FCSOUT     HAS FCS BEEN CHANGED                 DMT44570
         BNE   CSTNDWRT            BR IF YES TO DO NORMAL WRITE         DMT44580
         MVC   BUFSTART,XACKSEQ    SETUP STANDARD SEQUENCE              DMT44590
CSENDRES DS    0H                  *                                    DMT44600
         OI    BUFSTAT,BUFRESP     SHOW RESPONSE BUFFER                 DMT44610
         B     CNWRITE             AND GO WRITE                         DMT44620
         EJECT                                                          DMT44630
*                                                                       DMT44640
*              A NEGATIVE RESPONSE RECEIVED                             DMT44650
*                                                                       DMT44660
         SPACE 3                                                        DMT44670
CNAKED   DS    0H                  PREPARE TO RETRANSMIT                DMT44680
         TM    BUFSTAT,BUFNAK      WERE WE SENDING A NAK                DMT44690
         BO    CNAKNAK             BR IF YES                            DMT44700
         MVC   BUFSTART(10),CBUFLAST RESET START OF BUFFER     @VA05474 DMT44710
         TM    BUFSTAT,BUFTEXT     WAS THIS A TEXT BUFFER               DMT44720
         BO    CREWRITE            BR IF YES TO RETRY                   DMT44730
         MVC   BUFSTART(2),XACKSEQ SETUP STANDARD SEQUENCE     @VA05470 DMT44740
         B     CWRTSIO             AND GO WRITE IT                      DMT44750
         SPACE 1                                                        DMT44760
CNAKNAK  DS    0H                  OUR NAK WAS NAK'ED                   DMT44770
         TM    BUFSTAT,BUFTEXT     WAS ORIGINAL BUFFER TEXT...          DMT44780
         BZ    CWRTOK              NO...FORGET IT                       DMT44790
*                                  YES...PREPARE TO RESEND              DMT44800
         MVC   BUFSTART,XSTXSEQ    RESET TEXT LEADERS                   DMT44810
         NI    BUFSTAT,X'FF'-BUFTONAK-BUFNAK-BUFRESP RESET BITS@VA08636 DMT44820
         B     CNWRITE             WRITE BUFFER AGAIN                   DMT44830
         SPACE 5                                                        DMT44840
*                                                                       DMT44850
*              UNKNOWN RESPONSE ... RESEND LAST DATA                    DMT44860
*                                                                       DMT44870
CRESPBAD DS    0H                                                       DMT44880
         SPACE 3                                                        DMT44890
*                                                                       DMT44900
*              SEND A NEGATIVE RESPONSE                                 DMT44910
*                                                                       DMT44920
CSENDNAK DS    0H                  ENTRY                                DMT44930
         MVC   BUFSTART,XNAKSEQ    SET NAK SEQUENCE                     DMT44940
         OI    BUFSTAT,BUFRESP+BUFNAK SHOW NAK RESPONSE                 DMT44950
         B     CNWRITE             AND GO WRITE IT                      DMT44960
         EJECT                                                          DMT44970
*                                                                       DMT44980
*                     A RESET BCB RECEIVED FROM OTHER END               DMT44990
*                     THE PROCEDURE USED HERE IS TO TREAT A RESET       DMT45000
*                     AS A NAK REPLACE THE FIRST 9 BYTES OF BUFFER      DMT45010
*                     AND RETRANSMIT WITH CORRECTED BCB COUNT           DMT45020
*                                                                       DMT45030
         SPACE 2                                                        DMT45040
CBCBRSET DS    0H                                                       DMT45050
*********************************************************************** DMT45060
* A BCB SEQUENCE CHECK WILL MEAN THAT A BLOCK OF DATA HAS BEEN LOST     DMT45070
* AND INTEGRITY OF THE DATA IS NOW QUESTIONABLE. THE ONLY RECOURSE      DMT45080
* TO ENSURE THE ENTIRE DATA SET IS COMPLETE IS TO TERMINATE THE         DMT45090
* LINK AND HAVE IT STARTED AGAIN WITH THE REMOTE OPERATOR FORWARD       DMT45100
* SPACE TO THE POINT OF BLOCK CHECK AND RESUMMING THE DATA SET AGAIN    DMT45110
*********************************************************************** DMT45120
         B     EOJ                     TERMINATE LINK NOW      @VA08633 DMT45130
         EJECT                                                          DMT45140
*                                                                       DMT45150
*              COMSUP IS EXITING WITHOUT I/O ACTIVE                     DMT45160
*              PREPARE FOR RE-ENTRY THROUGH COMUTATOR                   DMT45170
*                                                                       DMT45180
         SPACE 3                                                        DMT45190
CSETCOM  DS    0H                  *                                    DMT45200
         MVI   $COMCOM+1,OPEN      OPEN GATE                            DMT45210
         OI    BUFSYNSW,$COMBUSY   SHOW NO ACTIVITY                     DMT45220
         STM   R13,R15,CRETREGS    SAVE SOME REGISTERS                  DMT45230
         B     CREXIT              AND RETURN TO INTERRUPTED LOC        DMT45240
         SPACE 1                                                        DMT45250
$COMSUP  DS    0H                                                       DMT45260
         MVI   $COMCOM+1,CLOSE     CLOSE COMUTATOR ENTRY                DMT45270
         LM    R13,R15,CRETREGS    RESTORE                              DMT45280
         LA    R4,$COMCOM+4        -> exit addr to commutator     *XJE  DMT45290
         STCM  R4,7,$COMEXIT+1     Set it                         *XJE  DMT45300
**RELOC**MVC   $COMEXIT+1(3),=AL3($COMCOM+4) SET EXIT TO COMUTATOR      DMT45310
         NI    BUFSYNSW,255-$COMBUSY ALLOW COMMUNICATIONS INTERRUPTS    DMT45320
         BR    R15                 RE-ENTER COMSUP                      DMT45330
         EJECT                                                          DMT45340
         SPACE 3                                                        DMT45350
CNWRITE  DS    0H                                                       DMT45360
         LA    R15,BUFSTART        TO XMISSION POINT                    DMT45370
         ST    R15,CCWA            INTO CCW                             DMT45380
         MVI   CCWA,WRITE          RESET OP                             DMT45390
         ST    R15,CCWC            SET RETURN DATA ADDR                 DMT45400
         MVI   CCWC,READ           RESET OP                             DMT45410
         MVC   CCWA+6(2),BUFCOUNT  SET WRITE COUNT                      DMT45420
         MVI   CCWA+4,XCHN         SET PROPER CCW CHAINING              DMT45430
         ST    R13,CBUFFER         SAVE BUFFER ADDR                     DMT45440
         MVI   CCWB,WRITE          RESET OP FOR ENDING SEQ              DMT45450
         TM    BUFSTAT,BUFRESP     IS THIS JUST A RESPONSE              DMT45460
         BZ    CREWRITE            BR IF NO                             DMT45470
         MVI   CCWA+4,CC+SILI      SET COMMAND CHAINING                 DMT45480
         MVC   CCWA+6(3),=X'000203' SET COUNT AND 2ND CCW OP            DMT45490
         B     CWRTSIO             GO START WRITE                       DMT45500
         SPACE 1                                                        DMT45510
CREWRITE DS    0H                  ENTRY TO RETRY WRITE                 DMT45520
         MVC   CFCSOUT,$FCSOUT     SAVE LAST FCS SENT                   DMT45530
         MVC   BUFFCS,$FCSOUT      SET CURRENT FCS                      DMT45540
         MVC   BUFBCB(1),CSETBCB   SET BCB INTO BUFFER                  DMT45550
         MVC   COLDRCB(1),BUFDATA  SAVE RCB THAT IS SENT                DMT45560
         TM    BUFSTAT,BUFFAKE     IS THIS A DUMMY BUFFER               DMT45570
         BZ    CWRTSIO             BR IF NO                             DMT45580
         OI    BUFFCS,X'40'        YES...SET WAIT-A-BIT                 DMT45590
         MVC   CCWC+6(2),DUMCOUNT SET READ CNT FOR W/BIT       @VA07451 DMT45600
         SPACE 1                                                        DMT45610
CWRTSIO  DS    0H                  START THE WRITE                      DMT45620
         MVC   CBUFLAST(10),BUFSTART SAVE INCASE OF RESET               DMT45630
         NI    BUFSYNSW,255-CUWFAKE MAKE SURE DUMMY READ NOT ON         DMT45640
         BAL   R15,$SIO            ISSUE THE I/O                        DMT45650
         DC    AL4(CCWS-DMTXJEA)   Offset to CCW string           *XJE  DMT45660
         SPACE 3                                                        DMT45670
*                                                                       DMT45680
*              INTERRUPT EXIT ROUTINE                                   DMT45690
*                                                                       DMT45700
         SPACE 3                                                        DMT45710
CREXIT   DS    0H                                                       DMT45720
         LM    R13,R15,CREGS       RESTORE INTERRUPTED REGS             DMT45730
CEXIT    DS    0H                                                       DMT45740
         L     R4,$COMEXIT         GET RETURN POINT                     DMT45750
         BR    R4                  AND RETURN                           DMT45760
         EJECT                                                          DMT45770
*.                                                                      DMT45780
*                                                                       DMT45790
* ENTRY NAME -                                                          DMT45800
*                                                                       DMT45810
*        CERROR                                                         DMT45820
*                                                                       DMT45830
* FUNCTION -                                                            DMT45840
*                                                                       DMT45850
*        THIS ROUTINE IS RESPONSIBLE FOR ANALYZING ALL ERRORS ON        DMT45860
*        THE COMMUNICATIONS LINE.  THE APPROPRIATE CORRECTIVE           DMT45870
*        ACTIVE IS TAKEN DEPENDING ON THE TYPE OF ERROR.                DMT45880
*                                                                       DMT45890
* CALLS TO OTHER ROUTINES -                                             DMT45900
*                                                                       DMT45910
*        NONE                                                           DMT45920
*                                                                       DMT45930
* OPERATION -                                                           DMT45940
*                                                                       DMT45950
*        1. DETERMINE THE TYPE OF ERROR.                                DMT45960
*                                                                       DMT45970
*        2. TRY TO REWRITE THE LINE OR SEND A NEGATIVE                  DMT45980
*           RESPONSE.                                                   DMT45990
*                                                                       DMT46000
*        3. RECORD A LINE TRANSACTION, A LINE ERROR, OR                 DMT46010
*           TIMEOUT.                                                    DMT46020
*                                                                       DMT46030
*        4. WRITE AN ERROR MESSAGE.                                     DMT46040
*                                                                       DMT46050
* RESPONSES -                                                           DMT46060
*                                                                       DMT46070
*        NONE                                                           DMT46080
*                                                                       DMT46090
* ERROR MESSAGES -                                                      DMT46100
*                                                                       DMT46110
*        NONE                                                           DMT46120
*                                                                       DMT46130
*.                                                                      DMT46140
         SPACE 3                                                        DMT46150
CERROR   DS    0H                                                       DMT46160
         MVC   CCSW,ADACSW         PRESERVE CSW AROUND SENSE AND LOG    DMT46170
         TM    ADACSW+4,UC         TEST UNIT CHECK                      DMT46180
         BO    CUNITCHK            BR IF YES                            DMT46190
         TM    ADACSW+4,UE         TEST UNIT EXCEPTION                  DMT46200
         BO    CUNITEXC            BR IF YES                            DMT46210
         SPACE 1                                                        DMT46220
CBADERR  DS    0H                  ENTRY FOR UNUSUAL ERROR              DMT46230
         BAL   R14,TRERR           LOG THE ERROR                        DMT46240
         B     CHECKCCW            GO DETERMINE I/O TYPE                DMT46250
         EJECT                                                          DMT46260
CUNITCHK DS    0H                  ENTRY FOR UNIT CHECK                 DMT46270
         TM    ADASENSE,B'00000001' IS IT A TIMEOUT?                    DMT46280
         BO    CHECKTO             YES CONTINUE                         DMT46290
         BAL   R14,TRERR           RECORD THE ERROR                     DMT46300
         B     CHECKCCW            AND CONTINUE                         DMT46310
         SPACE 1                                                        DMT46320
CHECKTO  EQU   *                                                        DMT46330
         OI    BUFSTAT,BUFTONAK        T/O ON RD,SET FOR A NAK @VA08636 DMT46340
         BAL   R14,TRTIMOT         COUNT THE TIMEOUT                    DMT46350
         LH    R14,TOCNT      GET TIMEOUT COUNT                @VA05950 DMT46360
         LA    R14,1(R14)     UP BY ONE                        @VA05950 DMT46370
         STH   R14,TOCNT      SAVE FOR LATER                   @VA05950 DMT46380
         CH    R14,=H'17'     THRESHOLD REACHED (ABOUT 1 MIN)  @VA05950 DMT46390
         BNL   EOJ                                             @VA05950 DMT46400
         SPACE 1                                                        DMT46410
CHECKCCW EQU   *                                                        DMT46420
         LA    R14,CREWRITE        PREPARE TO REWRITE                   DMT46430
         ICM   R15,B'1111',CCSW    GET COMMAND ADDR AND CHECK FOR ZERO  DMT46440
         BCR   8,R14               BR IF YES TO TRY REWRITE             DMT46450
         TM    CCSW+5,CCC          TEST CHANNEL CONTROL CHECK           DMT46460
         BCR   1,R14               YES... GUESS AT REWRITE              DMT46470
         SH    R15,=H'8'           Otherwise back to failed CC HRC001DT DMT46480
         CLI   0(R15),WRITE        WAS IT A WRITE                       DMT46490
         BCR   8,R14               BR IF YES TO RETRY IT                DMT46500
         CLC   BUFDATA(1),COLDRCB  COMPARE AGAINST LAST RCB SENT        DMT46510
         BE    CSENDNAK                                        @VA05950 DMT46520
         NI    BUFSTAT,255-BUFTEXT OTHERWISE FORGET TEXT                DMT46530
         B     CSENDNAK                                        @VA05950 DMT46540
         SPACE 1                                                        DMT46550
         EJECT                                                          DMT46560
*                                                                       DMT46570
*              UNIT EXCEPTION SET                                       DMT46580
*                                                                       DMT46590
         SPACE 3                                                        DMT46600
CUNITEXC DS    0H                                                       DMT46610
         L     R15,ADACSW          GET CSW ADDR                         DMT46620
         SH    R15,=H'8'           Back up to cmd in error     HRC001DT DMT46630
         MVC   CUNITCMD(1),0(R15)  SAVE COMMAND CODE                    DMT46640
         SPACE 1                                                        DMT46650
         CLI   CUNITCMD,WRITE      WAS THIS A WRITE...                  DMT46660
         BNE   CSENDNAK            BR IF NO TO FORCE RESEND (EOT REC)   DMT46670
         SPACE 1                                                        DMT46680
CDMYREAD EQU   *                                                        DMT46690
         OI    BUFSYNSW,CUWFAKE    SET SWITCH TO IGNORE ERROR           DMT46700
         BAL   R15,$SIO            ISSUE THE I/O                        DMT46710
         DC    AL4(CCWD-DMTXJEA)   Offset to CCW string           *XJE  DMT46720
         B     CREXIT              AND EXIT TO AWAIT INT                DMT46730
         EJECT                                                          DMT46740
*---------------------------------------------------------------------* DMT46750
*                                                                     * DMT46760
*           IOERROR MESSAGE PRINT ROUTINE                             * DMT46770
*                                                                     * DMT46780
*               AT ENTRY: R1 --> TO FAILING CCW                       * DMT46790
*                                                                     * DMT46800
*                                                                     * DMT46810
*---------------------------------------------------------------------* DMT46820
         SPACE                                                          DMT46830
         DS    0H                                                       DMT46840
IOERRPRT EQU   *                                                        DMT46850
         STM   R14,R1,IOERRSV      STORE REGS IN SAVE AREA              DMT46860
         MVC   IOERRLNE(8),XJELINE Store line address in msg   HRC000DT DMT46870
         UNPK  IERRCSW1(9),ADACSW(5) SPREAD THE CSW                     DMT46880
         UNPK  IERRCSW2(9),ADACSW+4(5) SPREAD THE CSW                   DMT46890
         TR    IERRCSW1(16),AXSTRTAB-240 AND TRANSLATE TO HEX           DMT46900
         MVC   IERRSIO(1),ADASIOCC MOVE IN STARTIO CONDITION CODE       DMT46910
         OI    IERRSIO,X'F0'       AND MAKE PRINTABLE                   DMT46920
         UNPK  IERRSENS(3),ADASENSE(2) SPREAD THE DIGITS                DMT46930
         MVI   IERRSENS+2,C' '     RESTORE THE CLOBBERED BLANK          DMT46940
         TR    IERRSENS(2),AXSTRTAB-240 AND TRANSLATE TO HEX            DMT46950
         TM    ADASIOCC,X'02'      BAD CONDITION?                       DMT46960
         BO    IOERRPR1            YES SKIP CCW                         DMT46970
         UNPK  IERRCCW1(9),0(5,R1) UNPACK THE CCW INTO MSG              DMT46980
         UNPK  IERRCCW2(9),4(5,R1) UNPACK THE CCW INTO MSG              DMT46990
         TR    IERRCCW1(16),AXSTRTAB-240 AND TRANSLATE TO HEX           DMT47000
IOERRPR1 EQU   *                                                        DMT47010
         LA    R0,IOERMSGL         GET THE MSG LENGTH                   DMT47020
         LA    R1,IOERRMSG         GET THE MSG ADDR                     DMT47030
         BAL   R14,MSG             AND WRITE IT                         DMT47040
         MVI   IERRCCW1,C'0'       CLEAR FIRST BYTE                     DMT47050
         MVC   IERRCCW1+1(15),IERRCCW1 AND THE REST                     DMT47060
         LM    R14,R1,IOERRSV      RESTORE REGISTERS                    DMT47070
         BR    R14                 AND RETURN                           DMT47080
         EJECT                                                          DMT47090
*---------------------------------------------------------------------* DMT47100
*                                                                     * DMT47110
*                                                                     * DMT47120
*        EVENT TRACING ROUTINE                                        * DMT47130
*                                                                     * DMT47140
*              ENTRY:                                                 * DMT47150
*                                                                     * DMT47160
*                  TRTRAN -- TO RECORD A LINE TRANSACTION             * DMT47170
*                  TRERR -- TO RECORD A LINE ERROR                    * DMT47180
*                  TRTIMOT -- TO RECORD A TIMEOUT                     * DMT47190
*                                                                     * DMT47200
*                                                                     * DMT47210
*---------------------------------------------------------------------* DMT47220
         SPACE 1                                                        DMT47230
         USING LINKTABL,R1         GET LINK TABLE ADDRESSABILITY        DMT47240
         SPACE 1                                                        DMT47250
         DS    0H                                                       DMT47260
TRTRAN   EQU   *                                                        DMT47270
         STM   R14,R1,TRSAVE       SAVE REGISTERS                       DMT47280
         L     R1,XJELINK          Get link table address      HRC000DT DMT47290
         TM    LFLAG,LTRALL        SHOULD WE BE DOING THIS?             DMT47300
         BNO   TREXIT              NO -- TIME TO EXIT                   DMT47310
         LH    R15,LTRNSCNT        GET THE CURRENT COUNT                DMT47320
         LA    R15,1(,R15)         UP BY ONE                            DMT47330
         STH   R15,LTRNSCNT        AND REPLACE IN COUNT FIELD           DMT47340
         CL    R15,TRASHLD         IS IT TIME TO PRINT?                 DMT47350
         BL    TREXIT              NO RETURN                            DMT47360
         B     TRPRT               GO PRINT THE MSG                     DMT47370
         SPACE                                                          DMT47380
TRERR    EQU   *                                                        DMT47390
         STM   R14,R1,TRSAVE       SAVE REGISTERS                       DMT47400
         L     R1,XJELINK          Get link table address      HRC000DT DMT47410
         TM    LFLAG,LTRALL+LTRERR SHOULD WE BE DOING THIS?             DMT47420
         BZ    TREXIT              NO -- TIME TO EXIT                   DMT47430
         LH    R15,LERRCNT         GET THE CURRENT COUNT                DMT47440
         LA    R15,1(,R15)         UP BY ONE                            DMT47450
         STH   R15,LERRCNT         AND REPLACE IN COUNT FIELD           DMT47460
         CL    R15,ERRSHLD         IS IT TIME TO PRINT?                 DMT47470
         BL    TREXIT              NO RETURN                            DMT47480
         B     TRPRT               GO PRINT THE MSG                     DMT47490
         SPACE                                                          DMT47500
TRTIMOT  EQU   *                                                        DMT47510
         STM   R14,R1,TRSAVE       SAVE REGISTERS                       DMT47520
         L     R1,XJELINK          Get link table address      HRC000DT DMT47530
         TM    LFLAG,LTRALL+LTRERR SHOULD WE BE DOING THIS?             DMT47540
         BZ    TREXIT              NO -- TIME TO EXIT                   DMT47550
         LH    R15,LTOCNT          GET THE CURRENT COUNT                DMT47560
         LA    R15,1(,R15)         UP BY ONE                            DMT47570
         STH   R15,LTOCNT          AND REPLACE IN COUNT FIELD           DMT47580
         CL    R15,ERRSHLD         IS IT TIME TO PRINT?                 DMT47590
         BL    TREXIT              NO RETURN                            DMT47600
         EJECT                                                          DMT47610
TRPRT    EQU   *                                                        DMT47620
         MVC   TRLINK(8),AXSLINK   MOVE LINKID INTO MSG                 DMT47630
         LH    R15,LTRNSCNT        GET THE CURRENT COUNT                DMT47640
         CVD   R15,TRCVD           CONVERT TO DECIMAL                   DMT47650
         UNPK  TRMTRN,TRCVD        SPREAD THE DIGITS                    DMT47660
         OI    TRMTRN+7,X'F0'      MAKE THE LAST ONE PRINTABLE          DMT47670
         LH    R15,LERRCNT         GET THE CURRENT COUNT                DMT47680
         CVD   R15,TRCVD           CONVERT TO DECIMAL                   DMT47690
         UNPK  TRMERR,TRCVD        SPREAD THE DIGITS                    DMT47700
         OI    TRMERR+7,X'F0'      MAKE THE LAST ONE PRINTABLE          DMT47710
         LH    R15,LTOCNT          GET THE CURRENT COUNT                DMT47720
         CVD   R15,TRCVD           CONVERT TO DECIMAL                   DMT47730
         UNPK  TRMTO,TRCVD         SPREAD THE DIGITS                    DMT47740
         OI    TRMTO+7,X'F0'       MAKE THE LAST ONE PRINTABLE          DMT47750
         SR    R15,R15             CLEAR OUT R15                        DMT47760
         STH   R15,LTRNSCNT        CLEAR THE COUNTER                    DMT47770
         STH   R15,LERRCNT         CLEAR THE COUNTER                    DMT47780
         STH   R15,LTOCNT          CLEAR THE COUNTER                    DMT47790
         LA    R0,TRMSGL           GET THE MSG LENGTH                   DMT47800
         LA    R1,TRMSG            GET THE MSG ADDR                     DMT47810
         BAL   R14,MSG             AND WRITE OUT THE MSG                DMT47820
         SPACE                                                          DMT47830
TREXIT   EQU   *                                                        DMT47840
         LM    R14,R1,TRSAVE       RESTORE THE REGS                     DMT47850
         BR    R14                 AND RETURN                           DMT47860
         EJECT                                                          DMT47870
*---------------------------------------------------------------------* DMT47880
*                                                                     * DMT47890
*                       ADAPTER SIO ROUTINE                           * DMT47900
*                                                                     * DMT47910
*---------------------------------------------------------------------* DMT47920
         SPACE 1                                                        DMT47930
$SIO     DS    0H                                                       DMT47940
         STM   R11,R2,ADSAV        SAVE REGS                            DMT47950
         ICM   R14,15,0(R15)       Get offset to CCW string       *XJE  DMT47960
         AR    R14,R9              Compute actual addr            *XJE  DMT47970
         STCM  R14,7,ADCCWA+1      Put CCW ADDRESS TO IOB         *XJE  DMT47980
         ST    R14,CLASTCAW        SAVE                           *XJE  DMT47990
         MVI   ADASENSE,X'00'      CLEAR SENSE BYTE                     DMT48000
         CLI   0(R14),DISABLE IS IT A DISABLE?                 @VA04353 DMT48010
         BE    RSIO           YES...DON'T LOG IT               @VA04353 DMT48020
         CLI   0(R14),READ    IS IT A READ?                    @VA04353 DMT48030
         BE    NOTWRITE       YES...DON'T BUMP POINTER         @VA04353 DMT48040
         LA    R14,8(R14)     POINT TO WRITE DATA CCW          @VA04353 DMT48050
NOTWRITE MVC   KCCW,0(R14)    SAVE CCW                         @VA04353 DMT48060
         L     R14,0(R14)          GET CCW ADDR                         DMT48070
         LA    R1,W                INDICATE WRITE TO LOG                DMT48080
         BAL   R15,KLOGIT          GO LOG THE WRITE                     DMT48090
RSIO     EQU   *                                                        DMT48100
         XC    ADAECB(4),ADAECB    CLEAR OUT ADAPTER SYNCH LOCK         DMT48110
         LA    R1,ADAECB           GET ADAPTER IO BLOCK ADDR            DMT48120
         L     R15,IOREQ           SYSTEM I/O REQUEST PROCESSOR         DMT48130
         BALR  R14,R15             GO EXECUTE THE I/O                   DMT48140
         CLI   ADASIOCC,X'00'      DID IT START OKAY                    DMT48150
         BE    RSIO1               OKAY CONTINUE                        DMT48160
         L     R1,CLASTCAW         GET LAST CCW ADDR                    DMT48170
         BAL   R14,IOERRPRT        WRITE THE ERROR MSG                  DMT48180
         CLI   ADASIOCC,NOP            LINE NOT THERE?         @VA08191 DMT48190
         BE    XJECRASH                Yes, exit W/O disable   HRC000DT DMT48200
         B     RSIO                AND RETRY                            DMT48210
         SPACE 1                                                        DMT48220
RSIO1    EQU   *                                                        DMT48230
         LM    R11,R2,ADSAV        RESTORE REGS                         DMT48240
         B     4(R15)              BACK TO USER                         DMT48250
         EJECT                                                          DMT48260
*---------------------------------------------------------------------* DMT48270
*                                                                     * DMT48280
*              HERE IF ERRORS OCCURED DURING INITIALIZATION       *XJE* DMT48290
*                                                                     * DMT48300
*---------------------------------------------------------------------* DMT48310
         SPACE 1                                                        DMT48320
         DS    0H                                                       DMT48330
XJELERR1 EQU   *                                                  *XJE  DMT48340
         MSGX  901,AXSLINK         WRITE THE MESSAGE                    DMT48350
         B     EOJ                 AND EXIT                             DMT48360
         SPACE 2                                                        DMT48370
XJELERR2 EQU   *                                                  *XJE  DMT48380
         MSGX  906,AXSLINK         WRITE THE MSG                        DMT48390
         B     EOJ                 AND EXIT                             DMT48400
*                                                                       DMT48410
*---------------------------------------------------------------------* DMT48420
*                                                                     * DMT48430
*                     LOG ROUTINE                                     * DMT48440
*                                                                     * DMT48450
*---------------------------------------------------------------------* DMT48460
         SPACE 3                                                        DMT48470
         USING IOTABLE,R1          GET IOTABLE ADDRSSABILITY            DMT48480
KTAB     DC    C'0123456789ABCDEF' TRANSLATE TAB                        DMT48490
KLOGIT   STM   R13,R2,KSAV         SAVE REGISTERS                       DMT48500
         TM    $LOGSW,LOGON        IS LOGING SET ON?                    DMT48510
         BNOR  R15            (BN0  RSIO) NO...RETURN          @VA04353 DMT48520
         TM    $LOGSW,LOGOPEN      IS THE LOG DEVICE OPEN?              DMT48530
         BO    LOGCONT             YES CONTINUE                         DMT48540
         LA    R1,LOGBLK           GET LOG REQUEST BLOCK                DMT48550
         LA    R0,X'11'            INDICATE OPEN                        DMT48560
         BAL   R14,AXS             GO GET A DEVICE                      DMT48570
         MVC   LOGLINK(8),AXSLINK  SET LINKID IN MSG                    DMT48580
         LA    R1,LOGTIME          GET BUFFER FOR DIAG                  DMT48590
*********DIAG  R1,R2,X'0C'         GET TIME AND DATA FROM VM            DMT48600
         MVC   LOGDTIME(8),LOGTIME MOVE TO MSG                          DMT48610
         MVC   LOGDTIME+9(8),LOGTIME+8 MOVE TO MSG                      DMT48620
         L     R1,LOGFIOA          GET FIOA ADDR                        DMT48630
         LA    R15,LOGHDCCW        Move CCW addr to CAW           *XJE  DMT48640
         ST    R15,PROGADDR        Set it                         *XJE  DMT48650
         B     WRLOG1              AND CONTINUE                         DMT48660
         SPACE 1                                                        DMT48670
LOGCONT  EQU   *                                                        DMT48680
         UNPK  IOLINE(15),0(8,R14) CONVERT THE FIRST PART OF BUFFER     DMT48690
         TR    IOLINE(14),KTAB-240 TO EBCDIC                            DMT48700
         UNPK  IOLINE+14(15),7(8,R14) CONVERT THE SECOND PART OF BUFFER DMT48710
         TR    IOLINE+14(14),KTAB-240 TO EBCDIC                         DMT48720
         UNPK  IOLINE+28(15),14(8,R14) AND THE LAST PART                DMT48730
         TR    IOLINE+28(14),KTAB-240 TO EBCDIC                         DMT48740
         MVI   IOLINE+42,C' '      RESTORE CLOBBERED BLANK              DMT48750
         UNPK  IOLINE+43(15),ADACSW+1(8) CONVERT THE CSW                DMT48760
         TR    IOLINE+43(14),KTAB-240 TO EBCDIC                         DMT48770
         MVI   IOLINE+57,C' '      RESTORE CLOBBERED BLANK              DMT48780
         UNPK  IOLINE+58(7),ADAECB(4) CONVERT THE SYNCH LOCK            DMT48790
         TR    IOLINE+58(6),KTAB-240 TO EBCDIC                          DMT48800
         MVI   IOLINE+64,C' '      RESTORE CLOBBERED BLANK              DMT48810
         UNPK  IOLINE+66(3),ADASENSE(2) CONVERT THE SENSE INFO @VA04353 DMT48820
         TR    IOLINE+66(2),KTAB-240 ...TO EBCDIC              @VA04353 DMT48830
         MVI   IOLINE+68,C' ' RESTORE CLOBBERED BLANK          @VA04353 DMT48840
         CLI   0(R1),C'W'          CHECK FOR WRITE                      DMT48850
         BE    WRLOG2         CSW NOT USEFUL                   @VA04353 DMT48860
         ICM   R1,B'0111',ADACSW+1 LAST CCW ADDRESS            @VA04353 DMT48870
         BZ    KFULL          INVALID ADDRESS                  @VA04353 DMT48880
         SH    R1,=H'8'       Back up to last CCW              HRC001DT DMT48890
         MVC   KCCW,0(R1)     SAVE CCW                         @VA04353 DMT48900
WRLOG2   UNPK  IOLINE+70(9),KCCW(5) CCW1                       @VA04353 DMT48910
         TR    IOLINE+70(8),KTAB-240 TRANSLATE                 @VA04353 DMT48920
         UNPK  IOLINE+78(9),KCCW+4(5) CCW2                     @VA04353 DMT48930
         TR    IOLINE+78(8),KTAB-240 MAKE IT EBCDIC            @VA04353 DMT48940
         MVI   IOLINE+86,C' ' RESTORE CLOBBERED BLANK          @VA04353 DMT48950
         CLI   IOLINE+70,WRITE IS IT A WRITE?                  @VA04353 DMT48960
         BNE   WRLOG               NO..MUST BE READ                     DMT48970
         L     R13,KSAV            RESTORE R13                          DMT48980
         UNPK  IOLINE+43(15),0(8,R13) LETS SEE THE FIRST PART OF THE BU DMT48990
         TR    IOLINE+43(14),KTAB-240 TO EBCDIC                         DMT49000
         MVI   IOLINE+57,C' '      RESTORE CLOBBERED BLANK              DMT49010
         EJECT                                                          DMT49020
WRLOG    EQU   *                                                        DMT49030
         TM    KCCW+4,SKIP    TRANSFER SUPPRESSED?             @VA04353 DMT49040
         BO    KWRITE         NO BUFFER TO DISPLAY             @VA04353 DMT49050
         LH    R14,KCCW+6     LOAD CCW BYTE COUNT              @VA04353 DMT49060
         CLI   KCCW,WRITE     IS IT A WRITE?                   @VA04353 DMT49070
         BE    KWRITE         NOT LAST CCW                     @VA04353 DMT49080
         SH    R14,ADACSW+6   RESIDUAL BYTE COUNT              @VA04353 DMT49090
KWRITE   SLA   R14,1          *2 FOR UNPACK                    @VA04353 DMT49100
         CL    R14,=F'40'     MORE THAN 40 BYTES?              @VA04353 DMT49110
         BH    KFULL          YES...IOLINE IS FULL             @VA04353 DMT49120
         LA    R1,IOLINE(R14) ADDRESS OF BLANKING AREA         @VA04353 DMT49130
         LA    R14,IOLINE+41  END OF BLANKING AREA-1           @VA04353 DMT49140
         SR    R14,R1         SIZE OF BLANKING AREA-1          @VA04353 DMT49150
         MVI   0(R1),C' '     BLANK OUT THE AREA               @VA04353 DMT49160
         EX    R14,MVCBLANK                                    @VA04353 DMT49170
KFULL    EQU   *                                               @VA04353 DMT49180
         L     R1,LOGFIOA          GET LOG DEVICE BLOCK ADDR            DMT49190
         LA    R15,LOGCCW          Move CCW addr to CAW           *XJE  DMT49200
         ST    R15,PROGADDR        Set it                         *XJE  DMT49210
WRLOG1   EQU   *                                                        DMT49220
         XC    IOSYNCH(4),IOSYNCH  CLEAR SYNCH LOCK                     DMT49230
         L     R15,IOREQ           SYSTEM IO ROUTINE ADDR               DMT49240
         BALR  R14,R15             EXECUTE THE IO                       DMT49250
         L     R15,WAITREQ         PREPARE FOR WAIT                     DMT49260
         BALR  R14,R15             AND WAIT FOR COMPLETION              DMT49270
         MVI   IOLINE,C' '    MAKE THE....                     @VA04353 DMT49280
         MVC   IOLINE+1(119),IOLINE ....IOLINE BLANK           @VA04353 DMT49290
LOGRET   EQU   *                                                        DMT49300
         LM    R13,R2,KSAV         RESTORE REGISTERS                    DMT49310
         TM    $LOGSW,LOGOPEN IS THE LOG OPEN?                 @VA04353 DMT49320
         BOR   R15            YES...ALL DONE,RETURN.           @VA04353 DMT49330
         OI    $LOGSW,LOGOPEN SET LOG OPEN                     @VA04353 DMT49340
         B     LOGCONT        MAKE THE FIRST ENTRY             @VA04353 DMT49350
         DROP  R1                                              @VA04353 DMT49360
         EJECT                                                          DMT49370
*---------------------------------------------------------------------* DMT49380
*                                                                     * DMT49390
*                      CLOSE LOG ROUTINE                              * DMT49400
*                                                                     * DMT49410
*---------------------------------------------------------------------* DMT49420
         SPACE 1                                                        DMT49430
         DC    0H'0'                                                    DMT49440
LOGCLOSE EQU   *                                                        DMT49450
         TM    $LOGSW,LOGOPEN          IS LOG RUNNING          @VA08193 DMT49460
         BZR   R14                     QUICK RETURN IF NO      @VA08193 DMT49470
         STM   R14,R1,LOGCLSAV     SAVE REGISTERS                       DMT49480
         NI    $LOGSW,255-LOGON-LOGOPEN RESET FLAGS                     DMT49490
         LA    R1,LOGBLK           GET LOG REQUEST BLOCK                DMT49500
         LA    R0,X'12'            INDICATE CLOSE                       DMT49510
         BAL   R14,AXS             GET RID OF LOG DEVICE                DMT49520
         LM    R14,R1,LOGCLSAV     RESTORE REGISTERS                    DMT49530
         BR    R14                     AND RETURN              @VA08193 DMT49540
         SPACE 1                                                        DMT49550
LOGCLSAV DS    4F                  SAVE AREA                            DMT49560
         EJECT                                                          DMT49570
         SPACE 7                                                        DMT49580
         DS    0H                                                       DMT49590
SIGNOFF  EQU   *                                                        DMT49600
         BAL   R15,$SIO            Send signoff record on line SML2NJE4 DMT49610
         DC    AL4(SGNOFCCW-DMTXJEA)  Offset to CCW string        *XJE  DMT49620
         LA    R1,ADAECB           BSC adapter synch lock      SML2NJE4 DMT49630
         L     R15,WAITREQ         Address of system wait rtn  SML2NJE4 DMT49640
         BALR  R14,R15             Wait for record to be sent  SML2NJE4 DMT49650
EOJ      EQU   *                                               @VA05662 DMT49660
         BAL   R15,$SIO                DISABLE LINE            @VA08191 DMT49670
         DC    AL4(CCWOFF-DMTXJEA)     Offset to CCW string       *XJE  DMT49680
         LA    R1,ADAECB               BSC ADAPTER SYNC LOCK   @VA08191 DMT49690
         L     R15,WAITREQ             GO TO WAIT              @VA08191 DMT49700
         BALR  R14,R15                 FOR DISABLE COMPLETE    @VA08191 DMT49710
XJECRASH EQU   *                       No disable issued here  HRC000DT DMT49720
         BAL   R14,CLOSEURS        Close unit record devices   SML2NJE4 DMT49730
         MSGX  143,(AXSLINK,XJELINE) Write the message         HRC000DT DMT49740
*********LA    R1,TERMBLK          GET TERMINATE GIVE BUFFER            DMT49750
*********L     R15,GIVEREQ         GET GIVE PROCESSOR ADDRESS           DMT49760
*********BALR  R14,R15             GO EXECUTE THE REQUEST               DMT49770
*--Termination: return back to NJEINIT                            *XJE
*********L     R15,WAITREQ         GET SYSTEM WAIT ROUTINE              DMT49780
*********LA    R1,LONGWAIT         A VERY LONG WAIT                     DMT49790
*********BALR  R14,R15             WAIT A LONG TIME                     DMT49800
         L     R13,XJESAVE+4       -> caller's save area          *XJE
         LM    R14,R12,12(R13)     Restore caller's regs (NJEINIT)*XJE
         BR    R14                 Return to NJEINIT              *XJE
*
*
CLOSEURS EQU   *                                               SML2NJE4 DMT49810
         ST    R14,CLOSESAV        Save return address         SML2NJE4 DMT49820
         TM    MASTERSW,SYSOUT     SYSOUT output device open?  SML2NJE4 DMT49830
         BZ    NOSYSOUT            No PRT/PUN device to close  SML2NJE4 DMT49840
         LA    R1,PDEVSYNC         Get SYSOUT device block     SML2NJE4 DMT49850
         LA    R0,X'12'            Close output function code  SML2NJE4 DMT49860
         MVI   19(R1),X'20'        Close purge option          SML2NJE4 DMT49870
         BAL   R14,AXS             Call DMTAXS to close        SML2NJE4 DMT49880
         MVI   19(R1),X'00'        Restore default close opts  SML2NJE4 DMT49890
         NI    MASTERSW,255-SYSOUT Mark SYSOUT device closed   SML2NJE4 DMT49900
NOSYSOUT EQU   *                                               SML2NJE4 DMT49910
         TM    MASTERSW,JOB        SYSIN output device open?   SML2NJE4 DMT49920
         BZ    NOSYSIN             No PUN device to close      SML2NJE4 DMT49930
         LA    R1,JDEVSYNC         Get SYSIN device block      SML2NJE4 DMT49940
         LA    R0,X'12'            Close output function code  SML2NJE4 DMT49950
         MVI   19(R1),X'20'        Close purge option          SML2NJE4 DMT49960
         BAL   R14,AXS             Call DMTAXS to close        SML2NJE4 DMT49970
         MVI   19(R1),X'00'        Restore default close opts  SML2NJE4 DMT49980
         NI    MASTERSW,255-JOB    Mark SYSIN device closed    SML2NJE4 DMT49990
NOSYSIN  EQU   *                                               SML2NJE4 DMT50000
         TM    MASTERSW,READER     RDR input device open?      SML2NJE4 DMT50010
         BZ    NOREADER            Reader not currently open   SML2NJE4 DMT50020
         LA    R1,RDEVSYNC         Get input RDR device block  SML2NJE4 DMT50030
         LA    R0,X'02'            Close input function code   SML2NJE4 DMT50040
         MVI   19(R1),X'81'        Close hold and keep options SML2NJE4 DMT50050
         BAL   R14,AXS             Call DMTAXS to close RDR    SML2NJE4 DMT50060
         MVI   19(R1),X'00'        Restore default close opts  SML2NJE4 DMT50070
         NI    MASTERSW,255-READER Mark RDR device closed      SML2NJE4 DMT50080
NOREADER EQU   *                                               SML2NJE4 DMT50090
         BAL   R14,LOGCLOSE        Ensure logging PRT closed   SML2NJE4 DMT50100
         L     R14,CLOSESAV        Restore return address      SML2NJE4 DMT50110
         BR    R14                 Return to caller            SML2NJE4 DMT50120
*                                                              SML2NJE4 DMT50130
         DROP  R11,R10                                            *XJE  DMT50140
         LTORG                                                          DMT50150
         EJECT                                                          DMT50160
*                                                                       DMT50170
********************                                                    DMT50180
*                  *   Selected functions externalized from             DMT50190
* CSECT DMTXJE2    *   DMTXJE1 in order to provide base register        DMT50200
*                  *   relief.  Handles reading and purging             DMT50210
********************   spool files, in part.                            DMT50220
*                                                                       DMT50230
DMTXJE2  CSECT                                                    *XJE  DMT50240
         STM   R0,R15,XJE2SAVE     Save callers regs              *XJE  DMT50250
         LR    R12,R15                                            *XJE  DMT50260
         USING DMTXJE2,R12                                        *XJE  DMT50270
*                                                                 *XJE  DMT50280
         LR    R14,R0              Copy entry code                *XJE  DMT50290
         B     XJE2FUNC(R14)       Branch into branch table       *XJE  DMT50300
*                                                                 *XJE  DMT50310
XJE2FUNC B     AXSGET           00 Open reader file               *XJE  DMT50320
         B     AXSPURGE         04 Purge spool file               *XJE  DMT50330
         B     VMDEBLOK         08 Deblock VM spool records       *XJE  DMT50340
         B     TODEBCDX         0C Convert the time               *XJE  DMT50350
*.                                                                      DMT50360
*                                                                       DMT50370
* ENTRY NAME -                                                          DMT50380
*                                                                       DMT50390
*        AXSGET                                                         DMT50400
*                                                                       DMT50410
* FUNCTION -                                                            DMT50420
*                                                                       DMT50430
*        THIS ROUTINE FUNCTIONS AS THE INTERFACE TO DMTAXS, FOR         DMT50440
*        GETTING FILES TO TRANSMIT, AND PURGE THOSE FILES WHEN          DMT50450
*        TRANSMISSION IS COMPLETE.                                      DMT50460
*                                                                       DMT50470
* CALLS TO OTHER ROUTINES -                                             DMT50480
*                                                                       DMT50490
*        DMTWAT - TO WAIT FOR AN EVENT COMPLETION                       DMT50500
*        DMTGIV - TO INITIATE A GIVE REQUEST                            DMT50510
*                                                                       DMT50520
* OPERATION -                                                           DMT50530
*                                                                       DMT50540
*        1. INITIATE AND WAIT FOR COMPLETION A CALL TO DMTAXS           DMT50550
*           FOR AN INPUT SPOOL FILE TO TRANSMIT.                        DMT50560
*                                                                       DMT50570
*        2. IF FILE OPENED CONSTRUCT HEADER LINE AND SETUP INITIAL      DMT50580
*           PARAMETERS FOR VMDEBLOK                                     DMT50590
*                                                                       DMT50600
*        3. IF FILE NOT OPENED RETURN TO CALLER WITH CONDITION CODE SET DMT50610
*                                                                       DMT50620
*        FOR AN INPUT FILE PURGE:                                       DMT50630
*                                                                       DMT50640
*        1. SETUP UP A CALL TO DMTAXS TO CLOSE INPUT FILE.              DMT50650
*                                                                       DMT50660
*        2. WAIT FOR COMPLETION AND RETURN TO CALLER.                   DMT50670
*                                                                       DMT50680
* RESPONSES -                                                           DMT50690
*                                                                       DMT50700
*        NONE                                                           DMT50710
*                                                                       DMT50720
* ERROR MESSAGES -                                                      DMT50730
*                                                                       DMT50740
*        NONE                                                           DMT50750
*                                                                       DMT50760
*.                                                                      DMT50770
         EJECT                                                          DMT50780
         USING TAG,R8                                                   DMT50790
AXSGET   DC    0H'0'                                                    DMT50800
*                                                                       DMT50810
         MVI   RDEVRLEN,X'13'      SET REQUEST LENGTH                   DMT50820
         MVI   RDEVFUN,X'01'       SET FUNCTION FOR INPUT OPEN          DMT50830
         MVC   RDEVLINK(8),AXSLINK SET LINK ID IN REQUEST               DMT50840
         SR    R0,R0               CLEAR R0 TO SIGNAL GIVE INIT REQ     DMT50850
         ST    R0,RDEVSYNC         CLEAR THE AXS REQUEST SYNCH LOCK TOO DMT50860
         LA    R1,RDEVSYNC         R1=ADDR OF THE REQ ELEMENT FOR AXS   DMT50870
         L     R15,GIVEREQ         R15=ENTRY ADDR FOR SUP GIVE ROUTINE  DMT50880
         BALR  R14,R15             MAKE THE REQUEST AVAILABLE TO AXS0   DMT50890
         L     R15,WAITREQ         R1= ADDR OF ENTRY TO WAIT ROUTINE    DMT50900
         BALR  R14,R15             WAIT FOR AXS0 TO PROCESS THE REQUEST DMT50910
         CLI   RDEVSYNC,X'40'      WAS THE REQUEST SUCCESSFUL?    *XJE  DMT50920
         BE    AXSGOPEN            YEP - GO TRY TO OPEN THE FILE        DMT50930
         TM    RDEVSYNC,X'41'      FILE ALREADY THERE             *XJE  DMT50940
         BO    AXSGOPEN            THATS OKAY TOO                       DMT50950
         XC    RDEVSYNC(4),RDEVSYNC CLEAR OUT SYNC LOCK                 DMT50960
         LA    R15,4               SET NON ZERO RETURN CODE             DMT50970
         B     XJE2XIT             RETURN WITH NO BLOCK INDICATION*XJE  DMT50980
         SPACE 1                                                        DMT50990
AXSGOPEN EQU   *                                                        DMT51000
         USING SPLINK,R1           GET SPLINK ADDRESSABILITY            DMT51010
         OI    RSW1,RACTIV         INDICATE FILE OPENED                 DMT51020
         L     R1,RDEVFIOA         GET FILE I/O AREA ADDRESS            DMT51030
         L     R8,SPRECNUM         PICKUP SPRECNUM FROM NEW BLOCK       DMT51040
         ST    R8,VMSPNUM          PICKUP COUNT OF REMAINING CCWS       DMT51050
         LA    R8,SPRECNUM+4       SETP OVER POINTERS IN SPOOL BLOCK    DMT51060
         ST    R8,VMSPANCH         TO PICKUP CURRENT CCW ANCHOR         DMT51070
         ST    R8,VMSPNEXT         CCW POINTER AND NEXT                 DMT51080
         OI    RSW1,CLINE          TO INDICATE BLOCK PRESENT            DMT51090
         OI    RSW1,HEADFLAG       INDICATE TIME TO PRT HEADER          DMT51100
         L     R8,RDEVTAG          GET TAG ADDR                         DMT51110
         CLI   TAGINDEV,TYP3210    IS IT SPOOLED CONSOLE OUTPUT?        DMT51120
         BE    AXSGLINE            YES..TREAT LIKE PRINT                DMT51130
         TM    TAGINDEV,TYPPRT     IS IT A PRINT FILE?                  DMT51140
         BO    AXSGLINE            YEP - GO GIN UP A REM HEAD LINE      DMT51150
         MVI   HDRCHAR,X'5C'       INSERT *                             DMT51160
         MVC   HDRCHAR+1(80-HDRSGLEN-1),HDRCHAR AND PROPAGATE           DMT51170
         B     AXSGCOMM            AND ENTER COMMON HEAD CODE           DMT51180
         EJECT                                                          DMT51190
AXSGLINE EQU   *                                                        DMT51200
         MVI   HDRCHAR,C' '        INSERT BLANK                         DMT51210
         MVC   HDRCHAR+1(80-HDRSGLEN-1),HDRCHAR AND PROPAGATE           DMT51220
AXSGCOMM EQU   *                                                        DMT51230
         MVC   HDRORGID(8),TAGINLOC MOVE IN THE ORIGIN LOCATION         DMT51240
         MVC   HDRVMID(8),TAGINVM  AND THE ORIGIN VIRTUAL MACHINE       DMT51250
         MVC   HDRTOD(MASKLEN),TODMASK MOVE IN THE EDITING MASK         DMT51260
         LA    R2,HDRTOD           R2 CONTAINS THE EBCDIC TOD ADDR      DMT51280
         LA    R1,TAGINTOD         -> TOD clock data              *XJE
         BAL   R14,TODEBCD         AND CONVERT                          DMT51290
         DROP  R1                                                       DMT51300
         SPACE 1                                                        DMT51310
AXSGEXIT EQU   *                                                        DMT51320
         XC    RDEVSYNC(4),RDEVSYNC CLEAR OUT SYNC LOCK                 DMT51330
         SR    R15,R15             SET ZERO RETURN CODE                 DMT51340
         B     XJE2XIT             AND RETURN TO THE MAIN ROUTINE *XJE  DMT51350
         EJECT                                                          DMT51360
AXSPURGE EQU   *                                                        DMT51370
         MVI   RDEVFUN,X'02'       SET PURGE REQUEST CODE FOR AXS1      DMT51380
         SR    R0,R0               CLEAR R0 TO SIG GIVE INIT REQ        DMT51390
         ST    R0,RDEVSYNC         CLEAR THE REQUEST SYNCH LOCK TOO     DMT51400
         LA    R1,RDEVSYNC         R1=ADDR OF PURGE REQ FOR AXS         DMT51410
         L     R15,GIVEREQ         R15=ADDR OF ENTRY TO SUP GIVE ROUT   DMT51420
         BALR  R14,R15             INITIATE THE REQUEST                 DMT51430
         L     R15,WAITREQ         R15=ADDR OF ENTRY TO SUP WAIT ROUT   DMT51440
         BALR  R14,R15             WAIT FOR THE REQUEST TO BE COMPLETED DMT51450
         XC    RDEVSYNC(4),RDEVSYNC CLEAR OUT SYNC LOCK                 DMT51460
         XC    RDEVSOPT(1),RDEVSOPT CLEAR OUT SUBOPTION FIELD           DMT51470
         L     R15,XJE2SAVE+15*4   RESTORE Original R15           *XJE  DMT51480
         B     XJE2XIT             AND RETURN TO THE CALLER       *XJE  DMT51490
*                                                                       DMT51500
         DROP  R8                                                       DMT51510
*                                                                       DMT51520
         EJECT                                                          DMT51530
*.                                                                      DMT51540
*                                                                       DMT51550
* ENTRY NAME -                                                          DMT51560
*                                                                       DMT51570
*        VMDEBLOK                                                       DMT51580
*                                                                       DMT51590
* FUNCTION -                                                            DMT51600
*                                                                       DMT51610
*        THIS ROUTINE FUNCTIONS AS A DEBLOCK ROUTINE FOR THE            DMT51620
*        VM/370 PAGE SPOOL BUFFERS.  IT RETURNS THE DEBLOCKED           DMT51630
*        RECORD IN THE RCTTDTA1 BUFFER.                                 DMT51640
*                                                                       DMT51650
* CALLS TO OTHER ROUTINES -                                             DMT51660
*                                                                       DMT51670
*        DMKDRD - VIA DIAGNONE CODE X'0014'                             DMT51680
*                                                                       DMT51690
* OPERATION -                                                           DMT51700
*                                                                       DMT51710
*        1. IF NEEDED READ THE NEXT SPOOL PAGE BUFFER FROM VM.          DMT51720
*                                                                       DMT51730
*        2. CONSTRUCT THE RECORD FROM THE CCW DATA IN THE SPOOL         DMT51740
*           PAGE BUFFER.                                                DMT51750
*                                                                       DMT51760
*        3. MOVE IN THE CARRIAGE CONTROL BYTE FROM THE CCW.             DMT51770
*                                                                       DMT51780
*        4. RETURN TO CALLER.                                           DMT51790
*                                                                       DMT51800
* RESPONSES -                                                           DMT51810
*                                                                       DMT51820
*        NONE                                                           DMT51830
*                                                                       DMT51840
* ERROR MESSAGES -                                                      DMT51850
*                                                                       DMT51860
*        NONE                                                           DMT51870
*                                                                       DMT51880
*.                                                                      DMT51890
         SPACE 1                                                        DMT51900
*                                                                       DMT51910
*        REGISTERS                                                      DMT51920
*                                                                       DMT51930
*        GPR.1  INPUT AREA FOR PACK                                     DMT51940
*        GPR.2  OUTPUT AREA FOR PACK                                    DMT51950
*        GPR.3  ANCHOR CCW IN VM SPOOL BLOCK                            DMT51960
*        GPR.5  INPUT LENGTH FOR PACK                                   DMT51970
*        GPR.6  COUNT OF NON-TIC CCWS LEFT IN VM SPOOL BUFFER           DMT51980
*        GPR.7  NEXT CCW IN VM SPOOL BLOCK                              DMT51990
*        GPR.9  BASE REGISTER                                           DMT52000
*        GPR.10 BASE REGISTER                                           DMT52010
*        GPR.11 BASE REGISTER                                           DMT52020
*        GPR.12 BASE REGISTER                                           DMT52030
*        GPR.14 LINK REGISTER                                           DMT52040
         EJECT                                                          DMT52050
VMDEBLOK DS    0H                                                       DMT52060
         L     R1,RDEVFIOA         -> record buffer               *XJE
         L     R15,SPLREQ          -> NJESPL routine              *XJE
         BALR  R14,R15             Go read a record from NETSPOOL *XJE
         LTR   R15,R15             End of file?                   *XJE
         BNZ   VMDERET1            Branch if yes                  *XJE
*
         L     R1,RDEVFIOA         -> record                      *XJE
         MVI   RCTTDTA1+1,C' '     Blank first byte of buffer  SML2NJE4 DMT53590
         MVC   RCTTDTA1+2(132),RCTTDTA1+1 Blank rest of buffer SML2NJE4 DMT53600
         MVC   RCTOPCOD(1),2(R1)   Plug in CCW op-code            *XJE
         SR    R5,R5               Clear for IC                   *XJE
         ICM   R5,3,0(R1)          Pick up count of data          *XJE
         STH   R5,RCTCCWCT         SET DATA LENGTH IN TCT         *XJE  DMT53660
         BCTR  R5,0           REDUCE BY ONE FOR CHARACTER      @VA05472 DMT53670
*                             OPERATION                                 DMT53680
         LA    R2,RCTTDTA1+1        Get address for output dataSML2NJE4 DMT53690
         TM    RSW1,PTRANS          Is this a PRT file?        SML2NJE4 DMT53700
         BZ    XMSKIPCC             Not a PRT file. No CC.     SML2NJE4 DMT53710
         TM    RCTOPCOD,X'03'       Is this a NOP (NJE header) SML2NJE4 DMT53720
         BO    XMSKIPCC             Is a NOP. No CC then.      SML2NJE4 DMT53730
         LA    R2,RCTTDTA1+2        Skip an extra byte for CC  SML2NJE4 DMT53740
XMSKIPCC EQU   *                                                  *XJE  DMT53750
         LA    R1,3(,R1)            -> past len and OP byte       *XJE
         EX    R5,VMDEMVC          MOVE IN PACKED DATA.                 DMT53760
*VMDEMVC MVC   0(*-*,R2),0(R1)     Executed by above code      SML2NJE4 DMT53950
         B     VMDERET2                                           *XJE
*
*--- The rest of VMDEBLOK, below, is not used any longer and      *XJE  DMT52070
*--- is replaced by the code just above.                          *XJE  DMT52070
*                                                                       DMT52070
*                                                                       DMT52070
*                                                                       DMT52070
*        SETUP SPOOL BLOCK POINTERS                                     DMT52080
*                                                                       DMT52090
*                                                                       DMT52100
*        CHECK FOR VM SPOOL BLOCK PRESENT                               DMT52110
*                                                                       DMT52120
         TM    RSW1,CLINE          ANYTHING IN BUFFER?                  DMT52130
         BO    VMSPBIN             IF THE VM SPOOL BLOCK IS IN.         DMT52140
*                                                                       DMT52150
*        READ A VM SPOOL BLOCK.                                         DMT52160
*                                                                       DMT52170
VMSPGET  EQU   *                                                        DMT52180
*                                                                       DMT52190
         USING SPLINK,R5           GET SPLINK ADDRESSABILITY            DMT52200
         L     R5,RDEVFIOA         GET FILE I/O AREA ADDRESS            DMT52210
         L     R8,RDEVTAG          GET READER TAG ADDRESS               DMT52220
         LH    R6,TAGDEV-TAG(,R8)  GET READER ADDRESS             *XJE  DMT52230
         SR    R7,R7               IND READ OF NEXT SP BLK REC          DMT52240
*********DIAG  R5,R6,X'14'         COMMAND SPOOL READER                 DMT52250
*                                                                       DMT52260
         BC    8,VMSPOK            IF THE READ IS SUCCESSFUL.           DMT52270
*                                                                       DMT52280
         BC    4,VMDERET1          IF END OF FILE.                      DMT52290
         BC    2,VMDERET1          IF NO MORE FILES.                    DMT52300
*                                                                       DMT52310
*        ERROR ON SPOOL READ, GPR12 WILL CONTAIN..                      DMT52320
*  4     INVALID SPOOL READER ADDRESS                                   DMT52330
*  8     INVALID DEVICE                                                 DMT52340
* 12     DEVICE BUSY WITH SIO I/O                                       DMT52350
* 16     PAGING I/O ERROR IN SETTING UP BUFFER.                         DMT52360
*                                                                       DMT52370
**                                 WRITE ERROR MSG                      DMT52380
**       MSGX  108,AXSFILE         Message 108 expansion below    *XJE  DMT52390
         MVC   MSGXNUM,=AL2(108)      +                                 DMT52400
         MVC   MSGXVAL+0(8),AXSFILE   +                                 DMT52410
         LA    0,8+4                  +                                 DMT52420
         BAL   14,XJE3MSG          To local msg routine                 DMT52430
         B     VMDERET1            AND IGNORE FOR PRESENT.              DMT52440
         EJECT                                                          DMT52450
VMSPOK   EQU   *                   HERE ON SUCCESSFUL READ              DMT52460
         L     R6,SPRECNUM         PICKUP SPRECNUM FROM NEW BLOCK.      DMT52470
         LTR   R6,R6               ALL DONE IF ZERO                     DMT52480
         BZ    VMSPGET             TO GET THE NEXT SPOOL BLOCK.         DMT52490
         LA    R3,SPRECNUM+4       STEP OVER POINTERS IN SPOOL BLOCK    DMT52500
         LR    R7,R3               AND INITIALIZE WORKING REGS.         DMT52510
         OI    RSW1,CLINE          TO INDICATE BLOCK PRESENT            DMT52520
         B     VMSPCCW             TO PROCESS NEXT CCW CHAIN.           DMT52530
         DROP  R5                                                       DMT52540
         SPACE                                                          DMT52550
*                                                                       DMT52560
*        BUFFER IS PRESENT ON ENTRY TO VMSB2CP.                         DMT52570
*                                                                       DMT52580
VMSPBIN  EQU   *                                                        DMT52590
         L     R3,VMSPANCH         TO PICKUP CURRENT CCW ANCHOR.        DMT52600
         L     R7,VMSPNEXT         AND NEXT CCW POINTER.                DMT52610
         L     R6,VMSPNUM          PICKUP COUNT OF REMAINING CCWS.      DMT52620
         EJECT                                                          DMT52630
*                                                                       DMT52640
*        HERE TO PROCESS NEXT CCW CHAIN.                                DMT52650
*                                                                       DMT52660
VMSPCCW  EQU   *                                                        DMT52670
*                                                                       DMT52680
*   PRINTER                                                             DMT52690
*        DATA MOVING CCW'S ARE..                                        DMT52700
*          (0,1,8,9,A,B,C,D,E)(1,9)                                     DMT52710
*          PLUS 63 BUT NOT 81 AND E9.                                   DMT52720
*   PUNCH                                                               DMT52730
*        DATA MOVING CCW'S ARE..                                        DMT52740
*          (0,2,4,6,8,A)1                                               DMT52750
*                                                                       DMT52760
*   READER                                                              DMT52770
*        DATA MOVING CCW'S ARE 02 AND 42                                DMT52780
*          THESE ARE PRESENT FOR REAL READER FILES.                     DMT52790
*          (AND REQUIRE DIFFERENT TREATMENT THAN VIRTUAL FILES          DMT52800
*           FROM THE PRINTER OR PUNCH.)                                 DMT52810
*                                                                       DMT52820
*        IMMEDIATE CCW OPS WITH NO DATA ARE..                           DMT52830
*          (0,1,8,9,A,B,C,D,E)(B,3)                                     DMT52840
*          EXCEPT 03,83, AND EB.                                        DMT52850
*                                                                       DMT52860
*        03 IS NOP (USED FOR PASSING SPOOL INFORMATION.)                DMT52870
*        08 IS TIC TO NEXT CCW CHAIN, IF ANY.                           DMT52880
*                                                                       DMT52890
*        AFTER PROCESSING A NON-TIC CCW CC SUCCESSFULLY, BCT TO VMSPRET DMT52900
*                                                                       DMT52910
VMSP4    EQU   *                                                        DMT52920
         SPACE 2                                                        DMT52930
*        NOP (X'03') IS ASSUMED TO BE A DATA MOVER IF                   DMT52940
*        FOLLOWED BY A TIC, OTHERWISE IT IS PROCESSED                   DMT52950
*        AS AN IMMEDIATE.                                               DMT52960
*                                                                       DMT52970
*                                                                       DMT52980
         TM    0(R7),X'06'         DECODE CCW                           DMT52990
         BZ    VMSP1               IF DATA MOVER OR TIC                 DMT53000
         CLI   0(R7),X'63'         AND                                  DMT53010
         BE    VMSPDATA            IF THIS IS A LOAD OF FORMS BUFFER    DMT53020
         CLI   0(R7),X'03'         ALSO CHECK FOR A NOP AND             DMT53030
         BE    VMSPNOP             IF IT IS.                            DMT53040
*                                                                       DMT53050
***** CHECK FOR REAL READER FILES (42,02)      IGNORE FOR MOMENT ****** DMT53060
*                                                                       DMT53070
         CLI   0(R7),X'42'         REAL READER CCW?                     DMT53080
         BE    VMSPFINI            YES                                  DMT53090
         CLI   0(R7),X'02'         REAL READER CCW?                     DMT53100
         BE    VMSPFINI            YES                                  DMT53110
         EJECT                                                          DMT53120
*        NOT DATA MOVER, TIC, OR END.  IMMEDIATE IS ASSUMED.            DMT53130
*                                                                       DMT53140
VMSPIMED EQU   *                                                        DMT53150
         MVC   RCTOPCOD(1),0(R7)   SET OP CODE                          DMT53160
         LA    R4,1                SET DATA LENGTH TO 1                 DMT53170
         STH   R4,RCTCCWCT         AND STORE IN TCT                     DMT53180
         MVC   RCTTDTA1+1(2),BLANK  One (or two incl CC) bytes SML2NJE4 DMT53190
*                                                                       DMT53200
*        HERE IF NON-TIC                                                DMT53210
*                                                                       DMT53220
VMSP2    EQU   *                                                        DMT53230
         LA    R7,8(,R7)           STEP TO NEXT CCW AND                 DMT53240
         CLI   0(R7),X'08'         CHECK IF TIC                         DMT53250
         BE    VMSP3               IF IT IS, ELSE                       DMT53260
         LR    R3,R7               MOVE ANCHOR ALSO. THEN               DMT53270
VMSP3    EQU   *                                                        DMT53280
         BCT   R6,VMSPRET          TO PROCESS NEXT, IF ANY              DMT53290
         B     VMSPFINI            THAT'S ALL FOLKS.                    DMT53300
*                                                                       DMT53310
*        HERE IF CCW IS XXXXX00X (BASE 2)                               DMT53320
*                                                                       DMT53330
VMSP1    EQU   *                                                        DMT53340
         TM    0(R7),X'01'         CONTINUE DECODE                      DMT53350
         BO    VMSPDATA            IF CCW IS XXXXX001                   DMT53360
         CLI   0(R7),X'08'         CHECK DIRECTLY FOR TIC               DMT53370
         BE    VMSPTIC             IF YES.                              DMT53380
         SPACE 2                                                        DMT53390
**       MSGX  190,AXSFILE         MSG 190 expansion below              DMT53400
         MVC   MSGXNUM,=AL2(190)      +                                 DMT53410
         MVC   MSGXVAL+0(8),AXSFILE   +                                 DMT53420
         LA    0,8+4                  +                                 DMT53430
         BAL   14,XJE3MSG          To local msg routine                 DMT53440
         B     VMSPFINI            TO IGNORE FOR PRESENT.               DMT53450
         SPACE 3                                                        DMT53460
VMSPTIC  EQU   *                   PROCESS TIC.                         DMT53470
         LH    R7,2(R7)            GET DISPLACEMENT OF NEXT CCW AND     DMT53480
         AR    R3,R7               ADD IN LAST ANCHOR TO GET NEW ONE.   DMT53490
         LR    R7,R3               TO INDICATE NEXT CCW TO BE PROCESSED DMT53500
         B     VMSPCCW             TO PROCESS IT.                       DMT53510
         SPACE 3                                                        DMT53520
VMSPNOP  EQU   *                   PROCESS NOP                          DMT53530
         CLI   8(R7),X'08'         LOOK AHEAD FOR TIC AND               DMT53540
         BE    VMSPDATA            TREAT A DATA MOVER IF PRESENT.       DMT53550
         B     VMSPIMED            ELSE TREAT AS IMMEDIATE.             DMT53560
         EJECT                                                          DMT53570
VMSPDATA EQU   *                   HERE FOR DATA MOVING CCW CC.         DMT53580
         MVI   RCTTDTA1+1,C' '     Blank first byte of buffer  SML2NJE4 DMT53590
         MVC   RCTTDTA1+2(132),RCTTDTA1+1 Blank rest of buffer SML2NJE4 DMT53600
         LH    R1,2(R7)            GET OFFSET FROM ANCHOR FOR DATA      DMT53610
         AR    R1,R3               AND MAKE IT ABSOLUTE                 DMT53620
         SR    R5,R5               CLEAR OUT REGISTER                   DMT53630
         IC    R5,7(R7)            PICKUP COUNT OF DATA                 DMT53640
         MVC   RCTOPCOD(1),0(R7)   MOVE IN CCW CC, THEN                 DMT53650
         STH   R5,RCTCCWCT         SET DATA LENGTH IN TCT               DMT53660
         BCTR  R5,0           REDUCE BY ONE FOR CHARACTER      @VA05472 DMT53670
*                             OPERATION                                 DMT53680
         LA    R2,RCTTDTA1+1        Get address for output dataSML2NJE4 DMT53690
         TM    RSW1,PTRANS          Is this a PRT file?        SML2NJE4 DMT53700
         BZ    VMSKIPCC             Not a PRT file. No CC.     SML2NJE4 DMT53710
         TM    RCTOPCOD,X'03'       Is this a NOP (NJE header) SML2NJE4 DMT53720
         BO    VMSKIPCC             Is a NOP. No CC then.      SML2NJE4 DMT53730
         LA    R2,RCTTDTA1+2        Skip an extra byte for CC  SML2NJE4 DMT53740
VMSKIPCC EQU   *                                               SML2NJE4 DMT53750
         EX    R5,VMDEMVC          MOVE IN PACKED DATA.                 DMT53760
         B     VMSP2               AND RETURN                           DMT53770
         SPACE 3                                                        DMT53780
VMSPFINI EQU   *                   DONE WITH A VM SPOOL BLOCK           DMT53790
         NI    RSW1,X'FF'-CLINE    TO TURN OFF BLOCK FLAG AND           DMT53800
         SPACE 3                                                        DMT53810
VMSPRET  EQU   *                                                        DMT53820
         ST    R3,VMSPANCH         SAVE CCW ANCHOR.                     DMT53830
         ST    R7,VMSPNEXT         AND NEXT CCW                         DMT53840
         ST    R6,VMSPNUM          AND COUNT OF REMAINING CCW'S.        DMT53850
         SR    R15,R15             SET 0 RET CODE                       DMT53860
         B     VMDERET2            TO COMPLETE RETURN.                  DMT53870
         SPACE 1                                                        DMT53880
VMDERET1 EQU   *                                                        DMT53890
         LA    R15,4               SET NON ZERO RETURN CODE             DMT53900
         SPACE 1                                                        DMT53910
VMDERET2 EQU   *                                                        DMT53920
         B     XJE2XIT             AND RETURN                     *XJE  DMT53930
         SPACE 3                                                        DMT53940
VMDEMVC  MVC   0(*-*,R2),0(R1)     Executed by above code      SML2NJE4 DMT53950
         SPACE 1                                                        DMT53960
*        TEMPORARIES                                                    DMT53970
         EJECT                                                          DMT53980
*.                                                                      DMT53990
*                                                                       DMT54000
* ENTRY NAME -                                                          DMT54010
*                                                                       DMT54020
*        TODEBCD                                                        DMT54030
*                                                                       DMT54040
* FUNCTION -                                                            DMT54050
*                                                                       DMT54060
*        CONVERT S/370 TOD TO EBCDIC DATE AND TIME                      DMT54070
*                                                                       DMT54080
* CALLS TO OTHER ROUTINES -                                             DMT54090
*                                                                       DMT54100
*        GTODEBC - TO CONVERT THE TIME AND DATE                         DMT54110
*                                                                       DMT54120
* OPERATION -                                                           DMT54130
*                                                                       DMT54140
*        1. ISSUE A CALL TO COMMON GTODEBCD ROUTINE TO                  DMT54150
*           RETRIEVE TIME AND DATE.                                     DMT54160
*                                                                       DMT54170
* RESPONSES -                                                           DMT54180
*                                                                       DMT54190
*        NONE                                                           DMT54200
*                                                                       DMT54210
* ERROR MESSAGES -                                                      DMT54220
*                                                                       DMT54230
*        NONE                                                           DMT54240
*                                                                       DMT54250
* On entry:  R1 -> two words containing TOD value to convert      *XJE  DMT54250
*                                                                       DMT54250
*.                                                                      DMT54260
TODEBCDX EQU   *             EXTERNAL EP to TODEBCD                     DMT54270
         BAL   R14,TODEBCD                                              DMT54280
         B     XJE2XIT             AND RETURN                     *XJE  DMT54290
*                                                                       DMT54300
         SPACE 3                                                        DMT54310
TODEBCD  DC    0H'0'         LOCAL ENTRY                                DMT54320
         STM   R13,R14,TODSAVE1    SAVE RETURN                          DMT54330
         LM    R0,R1,0(R1)         Get file date / time           *XJE  DMT17420
         LA    R13,MMDDYYHH        GET WORK ADDR ADDR FOR CALL          DMT54340
*DEL     L     R15,TCOM            GET COMMON ROUTINES LIST       *XJE  DMT54350
         L     R15,GTODEBCD        AND THE TIME CONVERT ADDR            DMT54360
         BALR  R14,R15             AND DO IT                            DMT54370
         LM    R13,R14,TODSAVE1    RESTORE REGS                         DMT54380
         BR    R14                                                      DMT54390
*                                                                 *XJE  DMT54400
*.                                                                *XJE  DMT54410
*                                                                 *XJE  DMT54420
* ENTRY NAME -                                                    *XJE  DMT54430
*                                                                 *XJE  DMT54440
*        XJE3MSG                                                  *XJE  DMT54450
*                                                                 *XJE  DMT54460
* FUNCTION -                                                      *XJE  DMT54470
*                                                                 *XJE  DMT54480
*        This is a local copy of the MSG routine for this csect.  *XJE  DMT54490
*        THIS ROUTINE PREPARES AND SENDS REQUESTS TO THE          *XJE  DMT54500
*        SPECIALIZED TASK REX, IN ORDER TO WRITE MESSAGES         *XJE  DMT54510
*        ON THE OPERATOR'S CONSOLE.                               *XJE  DMT54520
*                                                                 *XJE  DMT54530
* CALLS TO OTHER ROUTINES -                                       *XJE  DMT54540
*                                                                 *XJE  DMT54550
*        DMTREX - TO EXECUTE THE MSG WRITE                        *XJE  DMT54560
*                                                                 *XJE  DMT54570
* OPERATION -                                                     *XJE  DMT54580
*                                                                 *XJE  DMT54590
*        1. MOVE VARIABLE PART OF MSG TO GIVE REQUEST BUFFER      *XJE  DMT54600
*                                                                 *XJE  DMT54610
*        2. INITIATE GIVE REQUEST TO DMTREX WITH MSG BUFFER.      *XJE  DMT54620
*                                                                 *XJE  DMT54630
*        3. WAIT FOR COMPLETION                                   *XJE  DMT54640
*                                                                 *XJE  DMT54650
*        4. RETURN TO CALLER                                      *XJE  DMT54660
*                                                                 *XJE  DMT54670
* ENTRY CONDITIONS:                                               *XJE  DMT54680
*                                                                 *XJE  DMT54690
*        IN REG. 14 THE RETURN ADDRESS                            *XJE  DMT54700
*        IN REG. 15 THE ROUTING CODE                              *XJE  DMT54710
*        IN REG. 1 THE POINTER TO THE VARIABLE PORTION OF         *XJE  DMT54720
*              THE MESSAGE STRING                                 *XJE  DMT54730
*        IN REG. 0 THE LENGTH OF THE VARIABLE PORTION OF THE MSG  *XJE  DMT54740
*                                                                 *XJE  DMT54750
* EXIT CONDITIONS:                                                *XJE  DMT54760
*                                                                 *XJE  DMT54770
*        NONE                                                     *XJE  DMT54780
*                                                                 *XJE  DMT54790
* NOTE:                                                           *XJE  DMT54800
*        NONE                                                     *XJE  DMT54810
*                                                                 *XJE  DMT54820
* RESPONSES -                                                     *XJE  DMT54830
*                                                                 *XJE  DMT54840
*        NONE                                                     *XJE  DMT54850
*                                                                 *XJE  DMT54860
* ERROR MESSAGES -                                                *XJE  DMT54870
*                                                                 *XJE  DMT54880
*        NONE                                                     *XJE  DMT54890
*                                                                 *XJE  DMT54900
*.                                                                *XJE  DMT54910
         EJECT                                                    *XJE  DMT54920
XJE3MSG  DC    0H'0'                                              *XJE  DMT54930
         STM   R14,R2,MSGSAVE      SAVE REGISTERS                 *XJE  DMT54940
*****    LA    R1,MSGXNUM          -> Message id, variables       *XJE  DMT54950
         LR    R2,R0               MOVE R0 INTO WORK REG          *XJE  DMT54960
         BCTR  R2,0                REDUCE BY ONE FOR MVC          *XJE  DMT54970
         EX    R2,XSGMVC1          AND MOVE TO MSG REQ BUFFER     *XJE  DMT54980
         AH    R2,=H'24'           UP FOR HEADER                  *XJE  DMT54990
         STC   R2,MSGBLK           AND STORE IN MSG REQ BUFFER    *XJE  DMT55000
         CLI   MSGLINK,X'00'       NEED ROUTING?                  *XJE  DMT55010
         BNE   XSG1                NO CONTINUE                    *XJE  DMT55020
         MVC   MSGLINK(8),AXSLINK  MOVE IN OUR LINKID             *XJE  DMT55030
XSG1     EQU   *                                                  *XJE  DMT55040
         LA    R1,MSGREQ           GET READY FOR GIVE             *XJE  DMT55050
         XC    MSGREQ(4),MSGREQ    CLEAR OUT SYNCH LOCK           *XJE  DMT55060
         L     R15,GIVEREQ         SYSTEM GIVE REQUEST EXECUTATOR *XJE  DMT55070
         BALR  R14,R15             GO GIVE THE BUFFER TO REX      *XJE  DMT55080
         L     R15,WAITREQ         WAIT FOR THE COMPLETION OF     *XJE  DMT55090
         BALR  R14,R15             CONSOLE OPERATION              *XJE  DMT55100
         MVI   MSGLINK,X'00'       SHOW NO RESPONSE               *XJE  DMT55110
         MVI   MSGBLK+2,X'00'      INDICATE NO ROUTING            *XJE  DMT55120
         LM    R14,R2,MSGSAVE      RESTORE REGS                   *XJE  DMT55130
         BR    R14                 AND RETURN                     *XJE  DMT55140
*                                                                 *XJE  DMT55150
XSGMVC1  MVC   MSGBUF(0),0(R1)     TO BE EXECUTED FROM ABOVE      *XJE  DMT55160
*                                                                 *XJE  DMT55170
XJE2XIT  EQU   *                   Exit with RC in R15            *XJE  DMT55180
         LM    R0,R14,XJE2SAVE                                    *XJE  DMT55190
         BR    R14                                                *XJE  DMT55200
*                                                                       DMT55210
         LTORG                                                    *XJE  DMT55220
         EJECT                                                          DMT55230
*                                                                       DMT55240
********************                                                    DMT55250
*                  *   Management of various NJE headers                DMT55260
* CSECT DMTXJE3    *   Uses csect DMTXJEB for header work               DMT55270
*                  *   areas.                                           DMT55280
********************                                                    DMT55290
*                                                                       DMT55300
DMTXJE3  CSECT                                                    *XJE  DMT55310
         STM   R0,R15,XJE3SAVE     Save regs                      *XJE  DMT55320
         LR    R12,R15             Set base                       *XJE  DMT55330
         USING DMTXJE3,R12                                        *XJE  DMT55340
*                                                                       DMT55350
         L     R10,=A(DMTXJEB)     -> DMTXJEB variables stg       *XJE  DMT55360
         USING DMTXJEB,R10         establish addressability       *XJE  DMT55370
  LA 10,2048(,R9)                                                       DMT55380
  LA  10,2048(,10)                                                      DMT55390
*                                                                       DMT55400
*                                                                       DMT55410
         LR    R14,R0              Get entry code                 *XJE  DMT55420
         B     XJE3FUNC(R14)       Branch into table of functions *XJE  DMT55430
*                                                                       DMT55440
XJE3FUNC B     BLDNMRC          00 Build NJE NMR hdr for cmd      *XJE  DMT55450
         B     BLDNMRM          04 Build NJE NMR hdr for msg      *XJE  DMT55460
         B     DEFNJEHD         08 Generate default NJE header    *XJE  DMT55470
         B     BLDNJEJH         0C Build NJE job hdr for out file *XJE  DMT55480
         B     BLDNJEDS         10 Build NJE dataset hdr out file *XJE  DMT55490
         B     BLDNJEJT         14 Build NJE job trailer out file *XJE  DMT55500
*                                                              SML2NJE4 DMT55510
*        BLDNMRC - Build NJE NMR header for command            SML2NJE4 DMT55520
*                                                              SML2NJE4 DMT55530
*        Registers on entry:                                   SML2NJE4 DMT55540
*              R1  - Length of command                         SML2NJE4 DMT55550
*              R14 - Return address                            SML2NJE4 DMT55560
*                                                              SML2NJE4 DMT55570
*              R2 is used to address NMRDSECT without saving   SML2NJE4 DMT55580
*                                                              SML2NJE4 DMT55590
*              Base registers R9/R10/R12 are used to              *XJE  DMT55600
*              address various items.                          SML2NJE4 DMT55610
*                                                              SML2NJE4 DMT55620
*        On exit, R1 is updated to include length of NMR hdrs  SML2NJE4 DMT55630
*                                                              SML2NJE4 DMT55640
BLDNMRC  DS    0H                                              SML2NJE4 DMT55650
         LA    R2,NMRODATA         Get address of NMR buffer   SML2NJE4 DMT55660
         USING NMRDSECT,R2         Get NMR addressability      SML2NJE4 DMT55670
         MVI   NMRFLAG,NMRFLAGC    Indicate command not msg    SML2NJE4 DMT55680
         MVI   NMRLVPR,X'77'       Set priority and level      SML2NJE4 DMT55690
         MVI   NMRTYPE,X'00'       Unformatted command         SML2NJE4 DMT55700
         STC   R1,NMRML            Set command length          SML2NJE4 DMT55710
         MVC   NMRTONOD,CMDRESP+20 Set destination node        SML2NJE4 DMT55720
         MVI   NMRTOQUL,X'00'      Zero NMRTOQUL               SML2NJE4 DMT55730
         MVC   NMROUT,CMDRESP+12   Set originating userid      SML2NJE4 DMT55740
         TM    NMROUT,X'80'        Is origin userid present?   SML2NJE4 DMT55750
         BZ    BNCNOSRU            No origin userid present    SML2NJE4 DMT55760
         OI    NMRFLAG,NMRFLAGT    Indicate org userid present SML2NJE4 DMT55770
BNCNOSRU EQU   *                                               SML2NJE4 DMT55780
         MVC   NMRFMNOD,LOCATION   Make origin node local      SML2NJE4 DMT55790
         MVI   NMRFMQUL,X'00'      Zero NMRFMQUL               SML2NJE4 DMT55800
         LA    R1,NMRHSIZE(,R1)    Add length of NMR header    SML2NJE4 DMT55810
         DROP  R2                                              SML2NJE4 DMT55820
         ST    R1,XJE3SAVE+1*4     Return the R1 value            *XJE  DMT55830
         B     XJE3XIT             Return to caller               *XJE  DMT55840
*                                                              SML2NJE4 DMT55850
*        BLDNMRM - Build NJE NMR header for message            SML2NJE4 DMT55860
*                                                              SML2NJE4 DMT55870
*        On entry, R1 should contain length of message.        SML2NJE4 DMT55880
*        On exit, R1 is updated to include length of NMR hdrs  SML2NJE4 DMT55890
*        Base registers R9/R10/R12 are used to address            *XJE  DMT55900
*        various items.  R0,R2-R8 are used for scratch         SML2NJE4 DMT55910
*                                                              SML2NJE4 DMT55920
*        This is pretty gruesome stuff!                        SML2NJE4 DMT55930
*                                                              SML2NJE4 DMT55940
BLDNMRM  DS    0H                                              SML2NJE4 DMT55950
         XC    NMROTEMP,NMROTEMP   Zero temporary workspace    SML2NJE4 DMT55960
         LA    R8,NMRODATA         Get address of NMR buffer   SML2NJE4 DMT55970
         USING NMRDSECT,R8         Get NMR addressability      SML2NJE4 DMT55980
         LM    R2,R5,NMRODATA      Get destination node,userid SML2NJE4 DMT55990
         STM   R2,R3,NMRTONOD      Store destination node      SML2NJE4 DMT56000
         MVI   NMRFLAG,0           Msg, no destination userid  SML2NJE4 DMT56010
         LTR   R4,R4               Check if dest userid blank  SML2NJE4 DMT56020
         BNM   BNMNODU             Top bit clear => blank / 0  SML2NJE4 DMT56030
         OI    NMRFLAG,NMRFLAGT    Flag dest userid in NMROUT  SML2NJE4 DMT56040
BNMNODU  DS    0H                                              SML2NJE4 DMT56050
         MVI   NMRLVPR,X'77'       Set level and priority      SML2NJE4 DMT56060
         MVI   NMRTYPE,NMRTYPET    No src userid, no timestamp SML2NJE4 DMT56070
         CLC   22(4,R8),=C'170I'   Is source userid present?   SML2NJE4 DMT56080
         BE    BNMNOUSR            MSG command, no src userid  SML2NJE4 DMT56090
         CLC   22(4,R8),=C'171I'   Is source userid present?   SML2NJE4 DMT56100
         BNE   BNMCMRSP            Locally generated cmd reply SML2NJE4 DMT56110
BNMNOUSR DS    0H                                              SML2NJE4 DMT56120
         STCM  R4,B'1111',NMROUT+0 Store 1/2 destination useridSML2NJE4 DMT56130
         STCM  R5,B'1111',NMROUT+4 Store 2/2 destination useridSML2NJE4 DMT56140
         LM    R3,R5,BNMADDRS      Get addresses for loop      SML2NJE4 DMT56150
         LA    R14,NMRODATA        -> data field                  *XJE  DMT56160
         AR    R3,R14              Add offset to address          *XJE  DMT56170
         AR    R5,R14              Add offset to address          *XJE  DMT56180
BNMLOOP1 DS    0H                                              SML2NJE4 DMT56190
         CLI   0(R3),C'('          Find bracket before userid  SML2NJE4 DMT56200
         BE    BNMSUSER            Found end of source node    SML2NJE4 DMT56210
         CLI   0(R3),C')'          Find bracket after userid   SML2NJE4 DMT56220
         BE    BNMUSRND            Found end of source userid  SML2NJE4 DMT56230
         CLI   0(R3),C':'          Find colon after link name  SML2NJE4 DMT56240
         BE    BNMSNODE            Found end of source node    SML2NJE4 DMT56250
BNMRSLP1 DS    0H                                              SML2NJE4 DMT56260
         BXLE  R3,R4,BNMLOOP1      Keep looking for colon      SML2NJE4 DMT56270
BNMCOLON DS    0H                                              SML2NJE4 DMT56280
         LA    R3,2(,R3)           Increment past colon, space SML2NJE4 DMT56290
         LA    R4,1                Restore loop increment      SML2NJE4 DMT56300
         LA    R5,8(,R3)           Longest possible userid     SML2NJE4 DMT56310
BNMLOOP2 DS    0H                                              SML2NJE4 DMT56320
         CLI   0(R3),C' '          Find blank after userid     SML2NJE4 DMT56330
         BE    BNMBLANK            Found blank after userid    SML2NJE4 DMT56340
         BXLE  R3,R4,BNMLOOP2      Keep looking for blank      SML2NJE4 DMT56350
BNMBLANK DS    0H                                              SML2NJE4 DMT56360
         LA    R6,1(,R3)           Get start of message        SML2NJE4 DMT56370
         LA    R3,NMRODATA(R1)     Get address of message end  SML2NJE4 DMT56380
         SR    R3,R6               Get length of message text  SML2NJE4 DMT56390
         LR    R1,R3               Save msg length for later   SML2NJE4 DMT56400
         LA    R4,NMRMSG           Get msg / src user address  SML2NJE4 DMT56410
         TM    NMRTYPE,NMRTYPE4    Source userid available?    SML2NJE4 DMT56420
         BNO   BNMNOSU             No. Via SML link or console SML2NJE4 DMT56430
         LA    R5,L'NMRECSID       Get length of NMRECSID      SML2NJE4 DMT56440
         LR    R3,R0               Get length of source userid SML2NJE4 DMT56450
         ICM   R3,B'1000',BLANK    Insert padding character    SML2NJE4 DMT56460
         MVCL  R4,R2               Move down source userid     SML2NJE4 DMT56470
         LR    R3,R1               Restore R3                  SML2NJE4 DMT56480
         LA    R1,L'NMRECSID(,R1)  Increase msg & NMR length   SML2NJE4 DMT56490
BNMNOSU  DS    0H                                              SML2NJE4 DMT56500
         LR    R2,R6               Get message start address   SML2NJE4 DMT56510
         LR    R5,R3               Dest length = source length SML2NJE4 DMT56520
         MVCL  R4,R2               Move message down           SML2NJE4 DMT56530
         B     BNMCOMON            Do common code              SML2NJE4 DMT56540
BNMSUSER DS    0H                                              SML2NJE4 DMT56550
         OI    NMRTYPE,NMRTYPE4    Source userid is present    SML2NJE4 DMT56560
BNMSNODE DS    0H                                              SML2NJE4 DMT56570
         CLI   NMROTEMP,X'00'      Already got source node?    SML2NJE4 DMT56580
         BNE   BNMCOLON            Yes. Skip getting it again  SML2NJE4 DMT56590
         LA    R2,NMRODATA+32      Get start of source node    SML2NJE4 DMT56600
         SR    R3,R2               Get length of source node   SML2NJE4 DMT56610
         ICM   R3,B'1000',BLANK    Insert padding character    SML2NJE4 DMT56620
         LA    R4,NMROTEMP         Get temporary staging area  SML2NJE4 DMT56630
         LA    R5,L'NMROTEMP       Get length of staging area  SML2NJE4 DMT56640
         MVCL  R4,R2               Copy source node            SML2NJE4 DMT56650
         LR    R3,R2               Restore pointer in R3       SML2NJE4 DMT56660
         CLI   0(R3),C'('          Are we done with source yet SML2NJE4 DMT56670
         BNE   BNMCOLON            Finished with msg source    SML2NJE4 DMT56680
         LM    R4,R5,BNMADDRS+4    Restore R4 and R5 too       SML2NJE4 DMT56690
         LA    R14,NMRODATA        -> data field                  *XJE  DMT56700
         AR    R5,R14              Add offset to address          *XJE  DMT56710
         LA    R2,1(,R3)           Save start of source userid SML2NJE4 DMT56720
         B     BNMRSLP1            Go back to looking for ')'  SML2NJE4 DMT56730
BNMUSRND DS    0H                                              SML2NJE4 DMT56740
         LR    R0,R3               Get end of source userid +1 SML2NJE4 DMT56750
         SLR   R0,R2               Get length of source userid SML2NJE4 DMT56760
         B     BNMRSLP1            Back to looking for colon   SML2NJE4 DMT56770
BNMCMRSP DS    0H                                              SML2NJE4 DMT56780
         MVC   NMROTEMP,LOCATION   Set source node to local    SML2NJE4 DMT56790
         LA    R6,NMRODATA-1(R1)   Get address of message end  SML2NJE4 DMT56800
         SH    R1,=H'16'           Subtract node, user length  SML2NJE4 DMT56810
         LR    R0,R1               Copy message length         SML2NJE4 DMT56820
BNMLOOP3 DS    0H                                              SML2NJE4 DMT56830
         MVC   NMRHSIZE-16(1,R6),0(R6) Move message up 14 bytesSML2NJE4 DMT56840
         BCTR  R6,0                Decrement address           SML2NJE4 DMT56850
         BCT   R0,BNMLOOP3         Loop until start of msg     SML2NJE4 DMT56860
         STCM  R4,B'1111',NMROUT+0 Store 1/2 destination useridSML2NJE4 DMT56870
         STCM  R5,B'1111',NMROUT+4 Store 2/2 destination useridSML2NJE4 DMT56880
BNMCOMON DS    0H                                              SML2NJE4 DMT56890
         STC   R1,NMRML            Set length of message text  SML2NJE4 DMT56900
         MVI   NMRTOQUL,X'00'      Clear NMRTOQUL              SML2NJE4 DMT56910
         MVC   NMRFMNOD,NMROTEMP   Move in originating node    SML2NJE4 DMT56920
         MVI   NMRFMQUL,X'00'      Fix NMRFMQUL                SML2NJE4 DMT56930
         DROP  R8                                              SML2NJE4 DMT56940
         LA    R1,NMRHSIZE(,R1)    Add in NMR header size      SML2NJE4 DMT56950
         ST    R1,XJE3SAVE+1*4     Return the R1 value            *XJE  DMT56960
         B     XJE3XIT             Return to caller               *XJE  DMT56970
*                                                                       DMT56980
*        DEFNJEHD - Generate default NJE header contents       SML2NJE4 DMT56990
*                                                              SML2NJE4 DMT57000
*        On entry, R3 should contain the address of the file   SML2NJE4 DMT57010
*        tag.                                                  SML2NJE4 DMT57020
*        Base registers R9/R10/R12 are used to address            *XJE  DMT57030
*        various items.                                        SML2NJE4 DMT57040
*                                                              SML2NJE4 DMT57050
DEFNJEHD DS    0H                                              SML2NJE4 DMT57060
         USING TAG,R3              Get tag addressability      SML2NJE4 DMT57070
         STCK  TAGINTOD            Default file time to now    SML2NJE4 DMT57080
         MVC   TAGINLOC,=C'????????' Default origin node       SML2NJE4 DMT57090
         MVC   TAGINVM,=C'????????'  Default origin userid     SML2NJE4 DMT57100
         MVC   TAGTOLOC,=C'????????' Default destination node  SML2NJE4 DMT57110
         MVC   PCTTOVM,=C'????????'  Default destination user  SML2NJE4 DMT57120
         MVI   TAGCLASS,C'A'       Default spool class to A    SML2NJE4 DMT57130
         MVC   TAGRECLN,=AL2(80)   Assume punch record length  SML2NJE4 DMT57140
         MVC   TAGDIST,=CL12' '    Blank distribution code     SML2NJE4 DMT57150
         MVC   TAGNAME,=CL12' '    Blank filename              SML2NJE4 DMT57160
         MVC   TAGTYPE,=CL12' '    Blank filetype              SML2NJE4 DMT57170
         MVC   TAGPRIOR,=AL2(50)   Transmission priority 50    SML2NJE4 DMT57180
         MVI   TAGINDEV,0          Don't assume device type    SML2NJE4 DMT57190
         MVC   TAGID,=H'0000'      Default spool file number   SML2NJE4 DMT57200
         MVC   TAGCOPY,=H'1'       Assume number of copies 1   SML2NJE4 DMT57210
         MVI   PSW1,X'00'          Clear discard and EOF flags SML2NJE4 DMT57220
         DROP  R3                  Finished with tag           SML2NJE4 DMT57230
         B     XJE3XIT             Return to caller               *XJE  DMT57240
         EJECT                                                 SML2NJE4 DMT57250
*                                                              SML2NJE4 DMT57260
*        BLDNJEJH - Build NJE job header for outgoing file     SML2NJE4 DMT57270
*                                                              SML2NJE4 DMT57280
*        On entry, R8 should contain the file tag.             SML2NJE4 DMT57290
*        R0 and R4 are modified without saving.                SML2NJE4 DMT57300
*        Base registers R9/R10/R12 are used to address            *XJE  DMT57310
*        various items.                                        SML2NJE4 DMT57320
*                                                              SML2NJE4 DMT57330
BLDNJEJH DS    0H                                              SML2NJE4 DMT57340
         USING TAG,R8                                          SML2NJE4 DMT57350
         MVI   RCTTSRC1,X'C0'      SRCB for NJE job header     SML2NJE4 DMT57360
         MVC   RCTTCT1,=AL2(NJHSIZE) Job header total length   SML2NJE4 DMT57370
         LA    R4,RCTTDTA1         NJE header buffer address   SML2NJE4 DMT57380
         USING NJEPDSEC,R4         Tell assembler to use it    SML2NJE4 DMT57390
         XC    NJEPDSEC(NJHSIZE),NJEPDSEC Zero whole segment   SML2NJE4 DMT57400
         MVC   NJEPLEN,=AL2(NJHSIZE) Length of job hdr segment SML2NJE4 DMT57410
         LA    R4,NJEPSIZE(,R4)    Skip over segment prefix    SML2NJE4 DMT57420
         USING NJHGDSEC,R4         Job header general section  SML2NJE4 DMT57430
         MVC   NJHGLEN,=AL2(NJHGSIZE) Length of general sect.  SML2NJE4 DMT57440
         MVC   NJHGJID,TAGID       Spool file number           SML2NJE4 DMT57450
         MVI   NJHGJCLS,C'A'       Execution class             SML2NJE4 DMT57460
         MVI   NJHGMCLS,C'A'       Message class               SML2NJE4 DMT57470
         MVI   NJHGPRIO,X'07'      Job priority                SML2NJE4 DMT57480
         MVI   NJHGJCPY,X'01'      Output copies               SML2NJE4 DMT57490
         XR    R0,R0               Assume PUN file (00)        SML2NJE4 DMT57500
         TM    TAGINDEV,TYPPUN     Are we actually punching?   SML2NJE4 DMT57510
         BO    NJEHPUN             Yes                         SML2NJE4 DMT57520
         BCTR  R0,0                Decrement to FF if PRT file SML2NJE4 DMT57530
NJEHPUN  STC   R0,NJHGLNCT         Lines per page              SML2NJE4 DMT57540
         MVC   NJHGACCT,BLANK      Accounting                  SML2NJE4 DMT57550
         MVC   NJHGJNAM,TAGINVM    Job name                    SML2NJE4 DMT57560
         MVC   NJHGUSID,TAGINVM    Job userid                  SML2NJE4 DMT57570
         MVC   NJHGETS,TAGINTOD    File date / time            SML2NJE4 DMT57580
         MVC   NJHGORGN,TAGINLOC   Originating node            SML2NJE4 DMT57590
         MVC   NJHGORGR,TAGINVM    Originating userid          SML2NJE4 DMT57600
*        The following two are TAGTOLOC and TAGTOVM for SYSIN  SML2NJE4 DMT57610
         MVC   NJHGXEQN,TAGINLOC   Execution node              SML2NJE4 DMT57620
         MVC   NJHGXEQU,TAGINVM    Execution userid            SML2NJE4 DMT57630
*        The following two are TAGINLOC and TAGINVM for SYSIN  SML2NJE4 DMT57640
         MVC   NJHGPRTN,TAGTOLOC   PRT file destination node   SML2NJE4 DMT57650
         MVC   NJHGPRTR,TAGTOVM    PRT file destination userid SML2NJE4 DMT57660
*        The following two are TAGINLOC and TAGINVM for SYSIN  SML2NJE4 DMT57670
         MVC   NJHGPUNN,TAGTOLOC   PUN file destination node   SML2NJE4 DMT57680
         MVC   NJHGPUNR,TAGTOVM    PUN file destination userid SML2NJE4 DMT57690
         MVC   NJHGPRGN(8),TAGINVM Start of programmer field   SML2NJE4 DMT57700
         MVC   NJHGPRGN+8(12),=CL12' ' End of programmer field SML2NJE4 DMT57710
         MVC   NJHGROOM,TAGDIST    Distribution code           SML2NJE4 DMT57720
         MVC   NJHGBLDG,BLANK      Building                    SML2NJE4 DMT57730
         MVC   NJHGNREC,TAGRECNM   Record count (SYSOUT only)  SML2NJE4 DMT57740
         B     XJE3XIT             Return to caller               *XJE  DMT57750
         DROP  R4                  Finished with job header    SML2NJE4 DMT57760
         DROP  R8                  Finished with file tag      SML2NJE4 DMT57770
*                                                              SML2NJE4 DMT57780
*        BLDNJEDS - Build NJE dataset header for outgoing file SML2NJE4 DMT57790
*                                                              SML2NJE4 DMT57800
*        On entry, R8 should contain the file tag.             SML2NJE4 DMT57810
*        R4 is modified without saving.                        SML2NJE4 DMT57820
*        Base registers R9/R10/R12 are used to address            *XJE  DMT57830
*        various items.                                        SML2NJE4 DMT57840
*                                                              SML2NJE4 DMT57850
BLDNJEDS DS    0H                                              SML2NJE4 DMT57860
         USING TAG,R8                                          SML2NJE4 DMT57870
         MVI   RCTTSRC1,X'E0'      SRCB for NJE data set hdr   SML2NJE4 DMT57880
         MVC   RCTTCT1,=AL2(NDHSIZE) Data set segment length   SML2NJE4 DMT57890
         LA    R4,RCTTDTA1         NJE header buffer address   SML2NJE4 DMT57900
         USING NJEPDSEC,R4         Tell assembler to use it    SML2NJE4 DMT57910
         XC    NJEPDSEC(NDHSIZE),NJEPDSEC Zero whole segment   SML2NJE4 DMT57920
         MVC   NJEPLEN,=AL2(NDHSIZE) Length of ds hdr segment  SML2NJE4 DMT57930
         LA    R4,NJEPSIZE(,R4)    Skip over segment prefix    SML2NJE4 DMT57940
         USING NDHGDSEC,R4         Ds header general section   SML2NJE4 DMT57950
         MVC   NDHGLEN,=AL2(NDHGSIZE) Ds hdr gen. sect. length SML2NJE4 DMT57960
         MVC   NDHGNODE,TAGTOLOC   Destination node            SML2NJE4 DMT57970
         MVC   NDHGRMT,TAGTOVM     Destination userid          SML2NJE4 DMT57980
         MVC   NDHGPROC,TAGNAME    Filename (1st 8 characters) SML2NJE4 DMT57990
         MVC   NDHGSTEP,TAGTYPE    Filetype (1st 8 characters) SML2NJE4 DMT58000
         MVC   NDHGDD,BLANK        DDNAME                      SML2NJE4 DMT58010
         MVC   NDHGCLAS,TAGCLASS   Sysout class                SML2NJE4 DMT58020
         MVC   NDHGNREC,TAGRECNM   Record count                SML2NJE4 DMT58030
         MVC   NDHGLREC,TAGRECLN   Record length               SML2NJE4 DMT58040
         MVC   NDHGDSCT,TAGCOPY+1  Copies                      SML2NJE4 DMT58050
         MVC   NDHGFORM,BLANK      Form                        SML2NJE4 DMT58060
         MVC   NDHGFCB,BLANK       FCB                         SML2NJE4 DMT58070
         MVC   NDHGUCS,BLANK       UCS                         SML2NJE4 DMT58080
         MVC   NDHGXWTR,BLANK      External writer             SML2NJE4 DMT58090
         MVC   NDHGNAME,BLANK      Data set name qualifier     SML2NJE4 DMT58100
         TM    TAGINDEV,TYPPUN     Are we punching?            SML2NJE4 DMT58110
         BNO   NJEDPRT             Skip over punch only stuff. SML2NJE4 DMT58120
         MVI   NDHGRCFM,X'80'      Record format fixed, nocc   SML2NJE4 DMT58130
         MVI   NDHGFLG2,X'40'      Flag as PUN file            SML2NJE4 DMT58140
         B     NJEDPUN             Skip over print only stuff. SML2NJE4 DMT58150
NJEDPRT  EQU   *                                               SML2NJE4 DMT58160
         MVI   NDHGRCFM,X'42'      Record format variable, cc  SML2NJE4 DMT58170
         MVI   NDHGFLG2,X'80'      Flag as PRT file            SML2NJE4 DMT58180
NJEDPUN  EQU   *                                               SML2NJE4 DMT58190
         DROP  R4                  Finished with gen sect. hdr SML2NJE4 DMT58200
*                                                              SML2NJE4 DMT58210
         LA    R4,NDHGSIZE(,R4)    Skip over general section   SML2NJE4 DMT58220
         USING NDHVDSEC,R4         Data set header RSCS sect.  SML2NJE4 DMT58230
         MVC   NDHVLEN(2),=AL2(NDHVSIZE) Ds RSCS sect. length  SML2NJE4 DMT58240
         MVI   NDHVTYPE,X'87'      RSCS section identifier     SML2NJE4 DMT58250
         MVC   NDHVCLAS,TAGCLASS   Spool file class            SML2NJE4 DMT58260
         MVC   NDHVIDEV,TAGINDEV   CP device type code         SML2NJE4 DMT58270
         MVC   NDHVDIST,TAGDIST    Distribution code           SML2NJE4 DMT58280
         MVC   NDHVFNAM,TAGNAME    Filename                    SML2NJE4 DMT58290
         MVC   NDHVFTYP,TAGTYPE    Filetype                    SML2NJE4 DMT58300
         MVI   NDHVPRIO+1,50       Transmission priority       SML2NJE4 DMT58310
         MVI   NDHVVRSN,X'01'      RSCS version 1              SML2NJE4 DMT58320
         MVI   NDHVRELN,X'07'      RSCS release 7              SML2NJE4 DMT58330
         B     XJE3XIT             Return to caller               *XJE  DMT58340
         DROP  R4                  Finished with RSCS section  SML2NJE4 DMT58350
         DROP  R8                  Finished with file tag      SML2NJE4 DMT58360
*                                                              SML2NJE4 DMT58370
*        BLDNJEJT - Build NJE job trailer for outgoing file    SML2NJE4 DMT58380
*                                                              SML2NJE4 DMT58390
*        On entry, R8 should contain the file tag.             SML2NJE4 DMT58400
*        R4 is modified without saving.                        SML2NJE4 DMT58410
*        Base registers R9/R10/R12 are used to address            *XJE  DMT58420
*        various items.                                        SML2NJE4 DMT58430
*                                                              SML2NJE4 DMT58440
BLDNJEJT DS    0H                                              SML2NJE4 DMT58450
         USING TAG,R8                                          SML2NJE4 DMT58460
         MVI   RCTTSRC1,X'D0'      SRCB for NJE job trailer    SML2NJE4 DMT58470
         MVC   RCTTCT1,=AL2(NJTSIZE) Job trailer segment len.  SML2NJE4 DMT58480
         LA    R4,RCTTDTA1         NJE header buffer address   SML2NJE4 DMT58490
         USING NJEPDSEC,R4         Tell assembler to use it    SML2NJE4 DMT58500
         XC    NJEPDSEC(NJTSIZE),NJEPDSEC Zero whole segment   SML2NJE4 DMT58510
         MVC   NJEPLEN,=AL2(NJTSIZE) Job trailer segment len.  SML2NJE4 DMT58520
         LA    R4,NJEPSIZE(,R4)    Skip over segment prefix    SML2NJE4 DMT58530
         USING NJTGDSEC,R4         Job trailer general section SML2NJE4 DMT58540
         MVC   NJTGLEN,=AL2(NJTGSIZE) Length of general sect.  SML2NJE4 DMT58550
         MVI   NJTGXCLS,C'A'       Execution class             SML2NJE4 DMT58560
         TM    TAGINDEV,TYPPUN     Are we punching?            SML2NJE4 DMT58570
         BO    NJETPUN             Yes. Skip print only stuff. SML2NJE4 DMT58580
         MVC   NJTGALIN,TAGRECNM   Record count                SML2NJE4 DMT58590
         B     NJETPRT             Skip over punch only stuff. SML2NJE4 DMT58600
NJETPUN  EQU   *                                               SML2NJE4 DMT58610
         MVC   NJTGACRD,TAGRECNM   Record count                SML2NJE4 DMT58620
NJETPRT  EQU   *                                               SML2NJE4 DMT58630
         MVI   NJTGIXPR,X'07'      Initial execution priority  SML2NJE4 DMT58640
         MVI   NJTGAXPR,X'07'      Actual execution priority   SML2NJE4 DMT58650
         MVI   NJTGIOPR,X'07'      Actual output priority      SML2NJE4 DMT58660
         MVI   NJTGAOPR,X'07'      Actual output priority      SML2NJE4 DMT58670
         B     XJE3XIT             Return to caller               *XJE  DMT58680
         DROP  R4                  Finished with job trailer   SML2NJE4 DMT58690
         DROP  R8                  Finished with file tag      SML2NJE4 DMT58700
         DROP  R10                 DMTXJEB                        *XJE  DMT58710
*                                                                       DMT58720
XJE3XIT  EQU   *                                                        DMT58730
         LM    R0,R15,XJE3SAVE     Restore caller's regs          *XJE  DMT58740
         BR    R14                 Return to caller               *XJE  DMT58750
*                                                              SML2NJE4 DMT58760
         LTORG                                                 SML2NJE4 DMT58770
*                        CONTROL CHARACTERS                             DMT58780
         SPACE 2                                                        DMT58790
XSOH     EQU   X'01'               START OF HEADING                     DMT58800
XSTX     EQU   X'02'               START OF TEXT                        DMT58810
XETX     EQU   X'03'               END OF TEXT                          DMT58820
XDLE     EQU   X'10'               DATA LINK ESCAPE                     DMT58830
XETB     EQU   X'26'               END OF TEXT BLOCK                    DMT58840
XENQ     EQU   X'2D'               ENQUIRY                              DMT58850
XSYN     EQU   X'32'               SYNCHRONIZATION                      DMT58860
XEOT     EQU   X'37'               LOST BLOCK ALARM                     DMT58870
XNAK     EQU   X'3D'               NEGATIVE ACKNOWLEDGEMENT             DMT58880
XACK1    EQU   X'61'               POSITIVE ACKNOWLEDGEMENT-CONDITIONAL DMT58890
XACK0    EQU   X'70'               POSITIVE ACKNOWLEDGEMENT             DMT58900
XLDR     EQU   XDLE                TRANSPARENT HEADER                   DMT58910
XTRL     EQU   XDLE                TRANSPARENT TRAILER                  DMT58920
XCHN     EQU   X'60'               TRANSPARENT CCW CHAINING BITS        DMT58930
         SPACE 2                                                        DMT58940
*                        BLOCK CONTROL BYTE INDICATORS                  DMT58950
         SPACE 2                                                        DMT58960
BCBIGNRE EQU   X'10'               IGNORE BLOCK COUNT INDICATOR         DMT58970
BCBRESET EQU   X'20'               RESET BLOCK COUNT INDICATOR          DMT58980
*                                                                       DMT58990
         EJECT                                                          DMT59020
*                                                                       DMT59030
********************                                                    DMT59040
*                  *   Contains certain structures and variables        DMT59050
* CSECT DMTXJEA    *   that were scattered all over the original        DMT59060
*                  *   line driver and consolidated here and is         DMT59070
********************   addressable by a single base register.           DMT59080
*                                                                       DMT59090
DMTXJEA  CSECT                                                          DMT59100
         USING DMTXJE1,R12,R11,R10 Addresability for labels       *XJE  DMT59110
*                                   used in instructions below.   *XJE  DMT59120
*
XJESAVE  DS    18F                 OS-style save area             *XJE
*                                                                       DMT59130
BUFMAXCT DC    F'5'                MAX LENGTH OF BUFFER FIELD           DMT59140
BUFFCNT  DC    H'0'                COUNT OF BUFFER FIELD                DMT59150
         CNOP  6,8                                                      DMT59160
$CCOM1   BALR  R7,0                ENTRY FROM COMMUTATOR TO PROCESSOR   DMT59170
$TCT1    DS    0H                  ORIGIN OF TASK CONTROL TABLE         DMT59180
CTCT     DS    0H                                                       DMT59190
$CTLTCT  EQU   *                                                        DMT59200
CCTSTRT  B     $CRTN1              B TO PROPER PROCESSOR ENTRY          DMT59210
CCTENTY  EQU   *-2                 ADR PORTION ***MODIFIED BY PROCE     DMT59220
CCTRTN   B     $CCOMM1+4           B TO NEXT PROCESSOR VIA COMMUTA      DMT59230
CCTCCW   DC    X'0'                CCW FOR DEVICE OP-CODE               DMT59240
CCTDATA  DC    AL3(0)              ADDRESS OF DATA TRANSFERRED          DMT59250
CCTFLAG  DC    X'20'               FLAGS ON CCW                         DMT59260
CCTOPCOD DC    X'00'               SAVE AREA FOR CCW OP-CODE            DMT59270
CCTCCWCT DC    AL2(80)             CCW COUNT OF DATA TRANSFERRED        DMT59280
CCTECB   DC    X'00'               EVENT CONTROL                        DMT59290
CCTSTAT  DC    X'00'               STATUS FLAGS                         DMT59300
CCTWFB   DC    AL1(0)              WAITING FOR BUFFERS                  DMT59310
CCTSAV1  DC    F'0'                SAVE AREA FOR PROCESSOR ROUTINE      DMT59320
CCTNEXT  DC    A($TCT2)            NEXT TCT IN CHAIN                    DMT59330
CCTFCS   DC    X'0000'             FUNCTION CONTROL SEQUENCE MASK       DMT59340
CCTRCBR  DC    X'80'               RECV RECORD CONTROL BLOCK            DMT59350
CCTRCBT  DC    X'00'               TRANS RECORD CONTROL BLOCK           DMT59360
CCTCOM   DC    A($CCOMM1)          POINTER BACK TO COMMUTATOR           DMT59370
CDEVSYNC DC    F'0'                SYNCH LOCK                           DMT59380
CDEVREQN DC    CL4'AXS '           FILE ACCESS NAME                     DMT59390
CDEVREQ  DC    A(*+8)              REQUEST BUFFER ADDRESS               DMT59400
CDEVRESP DC    AL1(19),AL3(*+3)    RESPONSE BUFFER                      DMT59410
CDEVRLEN DC    AL1(0)              REQUEST LENGTH                       DMT59420
CDEVFUN  DC    AL1(0)              REQUEST FUNCTION                     DMT59430
CDEVRESV DC    AL1(0)              RESERVED BYTE                        DMT59440
CDEVSOPT DC    AL1(0)              SUB OPTION BYTE                      DMT59450
CDEVTAG  DC    A(0)                TAG ADDRESS                          DMT59460
CDEVFIOA DC    A(0)                FILE I/O AREA                        DMT59470
CDEVLINK DC    CL8' '              LINK NAME                            DMT59480
CSW1     DC    AL1(0)              DEVICE SWITCH 1                      DMT59490
CSW2     DC    AL1(0)              DEVICE SWITCH 2                      DMT59500
CSW3     DC    AL1(0)              DEVICE SWITCH 3                      DMT59510
CSW4     DC    AL1(0)              DEVICE SWITCH 4                      DMT59520
CCTTOVM  DC    CL8' '              VM OUTPUT DESTINATION                DMT59530
*                                                                       DMT59540
*        NORMAL DEVICE ECTENTION                                        DMT59550
*                                                                       DMT59560
CCTTANK  DC    A(0)                NEXT TANK TO OUTPUT                  DMT59570
CCTBUFER DC    A(0)                ADDR OF CURRENT BUFFER               DMT59580
*                                                                       DMT59590
*              TNKLM,TNKCT AND BUFLM,BUFCT MUST APPEAR IN SEQ AND STRT  DMT59600
*                                  ON HALF WORD BOUNDARIES              DMT59610
CCTTNKLM DC    AL1(15)             MAX NUM OF TANKS ASSIGNABLE TO       DMT59620
CCTTNKCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT59630
CCTBUFLM DC    AL1(5)              MAX NUM OF BUFFERS ASSIGNABLE        DMT59640
CCTBUFCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT59650
*                                                                       DMT59660
         CNOP  6,8                                                      DMT59670
$WCOM1   BALR  R7,0                ENTRY FROM COMMUTATOR TO PROCESSOR   DMT59680
$TCT2    DS    0H                  ORIGIN OF TASK CONTROL TABLE         DMT59690
WTCT     DS    0H                                                       DMT59700
$CONTCT  EQU   *                                                        DMT59710
WCTSTRT  B     $WRTN1              B TO PROPER PROCESSOR ENTRY          DMT59720
WCTENTY  EQU   *-2                 ADR PORTION ***MODIFIED BY PROCE     DMT59730
WCTRTN   B     $WCOMM1+4           B TO NEXT PROCESSOR VIA COMMUTA      DMT59740
WCTCCW   DC    X'0'                CCW FOR DEVICE OP-CODE               DMT59750
WCTDATA  DC    AL3(0)              ADDRESS OF DATA TRANSFERRED          DMT59760
WCTFLAG  DC    X'20'               FLAGS ON CCW                         DMT59770
WCTOPCOD DC    X'00'               SAVE AREA FOR CCW OP-CODE            DMT59780
WCTCCWCT DC    AL2(80)             CCW COUNT OF DATA TRANSFERRED        DMT59790
WCTECB   DC    X'00'               EVENT CONTROL                        DMT59800
WCTSTAT  DC    X'10'               STATUS FLAGS                         DMT59810
WCTWFB   DC    AL1(0)              WAITING FOR BUFFERS                  DMT59820
WCTSAV1  DC    F'0'                SAVE AREA FOR PROCESSOR ROUTINE      DMT59830
WCTNEXT  DC    A($TCT3)            NEXT TCT IN CHAIN                    DMT59840
WCTFCS   DC    X'0040'             FUNCTION CONTROL SEQUENCE MASK       DMT59850
WCTRCBR  DC    X'9A'               Recv record control block            DMT59860
WCTRCBT  DC    X'00'               TRANS RECORD CONTROL BLOCK           DMT59870
WCTCOM   DC    A($WCOMM1)          POINTER BACK TO COMMUTATOR           DMT59880
WDEVSYNC DC    F'0'                SYNCH LOCK                           DMT59890
WDEVREQN DC    CL4'AXS '           FILE ACCESS NAME                     DMT59900
WDEVREQ  DC    A(*+8)              REQUEST BUFFER ADDRESS               DMT59910
WDEVRESP DC    AL1(19),AL3(*+3)    RESPONSE BUFFER                      DMT59920
WDEVRLEN DC    AL1(0)              REQUEST LENGTH                       DMT59930
WDEVFUN  DC    AL1(0)              REQUEST FUNCTION                     DMT59940
WDEVRESV DC    AL1(0)              RESERVED BYTE                        DMT59950
WDEVSOPT DC    AL1(0)              SUB OPTION BYTE                      DMT59960
WDEVTAG  DC    A(0)                TAG ADDRESS                          DMT59970
WDEVFIOA DC    A(0)                FILE I/O AREA                        DMT59980
WDEVLINK DC    CL8' '              LINK NAME                            DMT59990
WSW1     DC    AL1(0)              DEVICE SWITCH 1                      DMT60000
WSW2     DC    AL1(0)              DEVICE SWITCH 2                      DMT60010
WSW3     DC    AL1(0)              DEVICE SWITCH 3                      DMT60020
WSW4     DC    AL1(0)              DEVICE SWITCH 4                      DMT60030
WCTTOVM  DC    CL8' '              VM OUTPUT DESTINATION                DMT60040
*                                                                       DMT60050
*        NORMAL DEVICE EWTENTION                                        DMT60060
*                                                                       DMT60070
WCTTANK  DC    A(0)                NEXT TANK TO OUTPUT                  DMT60080
WCTBUFER DC    A(0)                ADDR OF CURRENT BUFFER               DMT60090
*                                                                       DMT60100
*              TNKLM,TNKCT AND BUFLM,BUFCT MUST APPEAR IN SEQ AND STRT  DMT60110
*                                  ON HALF WORD BOUNDARIES              DMT60120
WCTTNKLM DC    AL1(13)             MAX NUM OF TANKS ASSIGNABLE TO       DMT60130
WCTTNKCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT60140
WCTBUFLM DC    AL1(3)              MAX NUM OF BUFFERS ASSIGNABLE        DMT60150
WCTBUFCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT60160
         EJECT                                                          DMT60170
*                                                                       DMT60180
*        TANK EXTENTIONS FOR READER AND CONSOLE PROCESSORS              DMT60190
*                                                                       DMT60200
WCTTANK1 DC    A(0)                TANKCHN AND WORK AREA ONE            DMT60210
WCTTRCB1 DC    X'9A'               RCB identification for NMR  SML2NJE4 DMT60220
WCTTSRC1 DC    X'80'               SRCB identification         SML2NJE4 DMT60230
WCTTCT1  DC    H'0'                Number of data characters   SML2NJE4 DMT60240
*                                                              SML2NJE4 DMT60250
WCTTNMR1 DC    XL30'00'            NMR header                  SML2NJE4 DMT60260
WCTTDTA1 DC    CL148' '            NMRMSG message or command   SML2NJE4 DMT60270
         DC    CL4' '              Used for compress workspace?SML2NJE4 DMT60280
*                                                                       DMT60290
         CNOP  6,8                                                      DMT60300
$PCOM1   BALR  R7,0                ENTRY FROM COMMUTATOR TO PROCESSOR   DMT60310
$TCT3    DS    0H                  ORIGIN OF TASK CONTROL TABLE         DMT60320
PTCT     DS    0H                                                       DMT60330
PCTSTRT  B     $PRTN1              B TO PROPER PROCESSOR ENTRY          DMT60340
PCTENTY  EQU   *-2                 ADR PORTION ***MODIFIED BY PROCE     DMT60350
PCTRTN   B     $PCOMM1+4           B TO NEXT PROCESSOR VIA COMMUTA      DMT60360
PCTCCW   DC    X'0'                CCW FOR DEVICE OP-CODE               DMT60370
PCTDATA  DC    AL3(0)              ADDRESS OF DATA TRANSFERRED          DMT60380
PCTFLAG  DC    X'20'               FLAGS ON CCW                         DMT60390
PCTOPCOD DC    X'01'               SAVE AREA FOR CCW OP-CODE            DMT60400
PCTCCWCT DC    AL2(80)             CCW COUNT OF DATA TRANSFERRED        DMT60410
PCTECB   DC    X'00'               EVENT CONTROL                        DMT60420
PCTSTAT  DC    X'08'               STATUS FLAGS                         DMT60430
PCTWFB   DC    AL1(0)              WAITING FOR BUFFERS                  DMT60440
PCTSAV1  DC    F'0'                SAVE AREA FOR PROCESSOR ROUTINE      DMT60450
PCTNEXT  DC    A($TCT4)            NEXT TCT IN CHAIN                    DMT60460
PCTFCS   DC    X'0001'             FCS mask for this processor SML2NJE4 DMT60470
PCTRCBR  DC    X'99'               Receive RCB for stream 1    SML2NJE4 DMT60480
PCTRCBT  DC    X'00'               TRANS RECORD CONTROL BLOCK           DMT60490
PCTCOM   DC    A($PCOMM1)          POINTER BACK TO COMMUTATOR           DMT60500
PDEVSYNC DC    F'0'                SYNCH LOCK                           DMT60510
PDEVREQN DC    CL4'AXS '           FILE ACCESS NAME                     DMT60520
PDEVREQ  DC    A(*+8)              REQUEST BUFFER ADDRESS               DMT60530
PDEVRESP DC    AL1(19),AL3(*+3)    RESPONSE BUFFER                      DMT60540
PDEVRLEN DC    AL1(19)             REQUEST LENGTH                       DMT60550
PDEVFUN  DC    AL1(0)              REQUEST FUNCTION                     DMT60560
PDEVRESV DC    AL1(0)              RESERVED BYTE                        DMT60570
PDEVSOPT DC    AL1(0)              SUB OPTION BYTE                      DMT60580
APDEVTAG DC    A(PDEVTAG)          Tag address                 SML2NJE4 DMT60590
PDEVFIOA DC    A(0)                FILE I/O AREA                        DMT60600
PDEVLINK DC    CL8' '              LINK NAME                            DMT60610
PSW1     DC    AL1(0)              DEVICE SWITCH 1                      DMT60620
PSW2     DC    AL1(0)              DEVICE SWITCH 2                      DMT60630
PSW3     DC    AL1(0)              DEVICE SWITCH 3                      DMT60640
PSW4     DC    AL1(0)              DEVICE SWITCH 4                      DMT60650
PCTTOVM  DC    CL8' '              VM OUTPUT DESTINATION                DMT60660
*                                                                       DMT60670
*        NORMAL DEVICE EPTENTION                                        DMT60680
*                                                                       DMT60690
PCTTANK  DC    A(0)                NEXT TANK TO OUTPUT                  DMT60700
PCTBUFER DC    A(0)                ADDR OF CURRENT BUFFER               DMT60710
*                                                                       DMT60720
*              TNKLM,TNKCT AND BUFLM,BUFCT MUST APPEAR IN SEQ AND STRT  DMT60730
*                                  ON HALF WORD BOUNDARIES              DMT60740
PCTTNKLM DC    AL1(1)              MAX NUM OF TANKS ASSIGNABLE TO       DMT60750
PCTTNKCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT60760
PCTBUFLM DC    AL1(2)              MAX NUM OF BUFFERS ASSIGNABLE        DMT60770
PCTBUFCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT60780
*                                                              SML2NJE4 DMT60790
*        Added variable locations used to process NJE headers  SML2NJE4 DMT60800
*                                                              SML2NJE4 DMT60810
APNJEHDR DC    A(PNJEHEAD)         Start address of NJE headersSML2NJE4 DMT60820
APNJEDTA DC    A(0)                Address of NJE data set hdr SML2NJE4 DMT60830
APNJETRL DC    A(0)                Address of NJE job trailer  SML2NJE4 DMT60840
APNJEHND DC    A(PNJEHEND)         End address of NJE headers  SML2NJE4 DMT60850
PNJEBPTR DC    A(0)                NJE headers buffer pointer  SML2NJE4 DMT60860
PNRECLEN DC    H'0'                Record length of SYSOUT dev SML2NJE4 DMT60870
PNSEGNUM DC    X'FF'               Expected NJE segment number SML2NJE4 DMT60880
PNSEGTYP DC    X'70'               Expected NJE segment type   SML2NJE4 DMT60890
*                                                                       DMT60900
         CNOP  6,8                                                      DMT60910
$RCOM1   BALR  R7,0                ENTRY FROM COMMUTATOR TO PROCESSOR   DMT60920
$TCT4    DS    0H                  ORIGIN OF TASK CONTROL TABLE         DMT60930
RTCT     DS    0H                                                       DMT60940
RCTSTRT  B     $RRTN1              B TO PROPER PROCESSOR ENTRY          DMT60950
RCTENTY  EQU   *-2                 ADR PORTION ***MODIFIED BY PROCE     DMT60960
RCTRTN   B     $RCOMM1+4           B TO NEXT PROCESSOR VIA COMMUTA      DMT60970
RCTCCW   DC    X'0'                CCW FOR DEVICE OP-CODE               DMT60980
RCTDATA  DC    AL3(0)              ADDRESS OF DATA TRANSFERRED          DMT60990
RCTFLAG  DC    X'20'               FLAGS ON CCW                         DMT61000
RCTOPCOD DC    X'00'               SAVE AREA FOR CCW OP-CODE            DMT61010
RCTCCWCT DC    AL2(80)             CCW COUNT OF DATA TRANSFERRED        DMT61020
RCTECB   DC    X'00'               EVENT CONTROL                        DMT61030
RCTSTAT  DC    X'00'               STATUS FLAGS                         DMT61040
RCTWFB   DC    AL1(0)              WAITING FOR BUFFERS                  DMT61050
RCTSAV1  DC    F'0'                SAVE AREA FOR PROCESSOR ROUTINE      DMT61060
RCTNEXT  DC    A($TCT6)            Next TCT in chain           SML2NJE4 DMT61070
RCTFCS   DC    X'0800'             FUNCTION CONTROL SEQUENCE MASK       DMT61080
RCTRCBR  DC    X'FF'               RECV RECORD CONTROL BLOCK            DMT61090
RCTRCBT  DC    X'99'               Transmit RCB for stream 1   SML2NJE4 DMT61100
RCTCOM   DC    A($RCOMM1)          POINTER BACK TO COMMUTATOR           DMT61110
RDEVSYNC DC    F'0'                SYNCH LOCK                           DMT61120
RDEVREQN DC    CL4'AXS '           FILE ACCESS NAME                     DMT61130
RDEVREQ  DC    A(*+8)              REQUEST BUFFER ADDRESS               DMT61140
RDEVRESP DC    AL1(19),AL3(*+3)    RESPONSE BUFFER                      DMT61150
RDEVRLEN DC    AL1(0)              REQUEST LENGTH                       DMT61160
RDEVFUN  DC    AL1(0)              REQUEST FUNCTION                     DMT61170
RDEVRESV DC    AL1(0)              RESERVED BYTE                        DMT61180
RDEVSOPT DC    AL1(0)              SUB OPTION BYTE                      DMT61190
RDEVTAG  DC    A(0)                TAG ADDRESS                          DMT61200
RDEVFIOA DC    A(0)                FILE I/O AREA                        DMT61210
RDEVLINK DC    CL8' '              LINK NAME                            DMT61220
RSW1     DC    AL1(0)              DEVICE SWITCH 1                      DMT61230
RSW2     DC    AL1(0)              DEVICE SWITCH 2                      DMT61240
RSW3     DC    AL1(0)              DEVICE SWITCH 3                      DMT61250
RSW4     DC    AL1(0)              DEVICE SWITCH 4                      DMT61260
RCTTOVM  DC    CL8' '              VM OUTPUT DESTINATION                DMT61270
*                                                                       DMT61280
*        TANK ERTENTIONS FOR READER AND CONSOLE PROCESSORS              DMT61290
*                                                                       DMT61300
RCTTANK1 DC    A(0)                TANKCHN AND WORK AREA ONE            DMT61310
RCTTRCB1 DC    X'99'               Transmit RCB for stream 1   SML2NJE4 DMT61320
RCTTSRC1 DC    X'80'               SRCB IDENTIFICATION                  DMT61330
RCTTCT1  DC    H'80'               NUMBER OF DATA CHARACTERS            DMT61340
RCTTDTA1 DC    CL136' '                                                 DMT61350
         DC    CL64' '             Bigger tank for NJE headers SML2NJE4 DMT61360
*                                                              SML2NJE4 DMT61370
*        Added variable locations used to decode NJE headers   SML2NJE4 DMT61380
*                                                              SML2NJE4 DMT61390
ARNJEHDR DC    A(RNJEHEAD)         Start address of NJE headersSML2NJE4 DMT61400
ARNJEDTA DC    A(0)                Address of NJE data set hdr SML2NJE4 DMT61410
ARNJETRL DC    A(0)                Address of NJE job trailer  SML2NJE4 DMT61420
ARNJEHND DC    A(RNJEHEND)         End address of NJE headers  SML2NJE4 DMT61430
RNSAVE   DS    4F                  Save area across $PUT call  SML2NJE4 DMT61440
RNSEGNUM DS    X                   Current NJE segment number  SML2NJE4 DMT61450
*                                                                       DMT61460
         CNOP  6,8                                                      DMT61470
$JCOM1   BALR  R7,0                ENTRY FROM COMMUTATOR TO PROCESSOR   DMT61480
$TCT6    DS    0H                  ORIGIN OF TASK CONTROL TABLE         DMT61490
JTCT     DS    0H                                                       DMT61500
JCTSTRT  B     $JRTN1              B TO PROPER PROCESSOR ENTRY          DMT61510
JCTENTY  EQU   *-2                 ADR PORTION ***MODIFIED BY PROCE     DMT61520
JCTRTN   B     $JCOMM1+4           B TO NEXT PROCESSOR VIA COMMUTA      DMT61530
JCTCCW   DC    X'0'                CCW FOR DEVICE OP-CODE               DMT61540
JCTDATA  DC    AL3(0)              ADDRESS OF DATA TRANSFERRED          DMT61550
JCTFLAG  DC    X'20'               FLAGS ON CCW                         DMT61560
JCTOPCOD DC    X'41'               SAVE AREA FOR CCW OP-CODE            DMT61570
JCTCCWCT DC    AL2(80)             CCW COUNT OF DATA TRANSFERRED        DMT61580
JCTECB   DC    X'00'               EVENT CONTROL                        DMT61590
JCTSTAT  DC    X'00'               STATUS FLAGS                         DMT61600
JCTWFB   DC    AL1(0)              WAITING FOR BUFFERS                  DMT61610
JCTSAV1  DC    F'0'                SAVE AREA FOR PROCESSOR ROUTINE      DMT61620
JCTNEXT  DC    A(0)                NEXT TCT IN CHAIN                    DMT61630
JCTFCS   DC    X'0800'             FUNCTION CONTROL SEQUENCE MASK       DMT61640
JCTRCBR  DC    X'93'               RECV RECORD CONTROL BLOCK            DMT61650
JCTRCBT  DC    X'00'               TRANS RECORD CONTROL BLOCK           DMT61660
JCTCOM   DC    A($JCOMM1)          POINTER BACK TO COMMUTATOR           DMT61670
JDEVSYNC DC    F'0'                SYNCH LOCK                           DMT61680
JDEVREQN DC    CL4'AXS '           FILE ACCESS NAME                     DMT61690
JDEVREQ  DC    A(*+8)              REQUEST BUFFER ADDRESS               DMT61700
JDEVRESP DC    AL1(19),AL3(*+3)    RESPONSE BUFFER                      DMT61710
JDEVRLEN DC    AL1(19)             REQUEST LENGTH                       DMT61720
JDEVFUN  DC    AL1(0)              REQUEST FUNCTION                     DMT61730
JDEVRESV DC    AL1(0)              RESERVED BYTE                        DMT61740
JDEVSOPT DC    AL1(0)              SUB OPTION BYTE                      DMT61750
AJDEVTAG DC    A(JDEVTAG)          Tag address                 SML2NJE4 DMT61760
JDEVFIOA DC    A(0)                FILE I/O AREA                        DMT61770
JDEVLINK DC    CL8' '              LINK NAME                            DMT61780
JSW1     DC    AL1(0)              DEVICE SWITCH 1                      DMT61790
JSW2     DC    AL1(0)              DEVICE SWITCH 2                      DMT61800
JSW3     DC    AL1(0)              DEVICE SWITCH 3                      DMT61810
JSW4     DC    AL1(0)              DEVICE SWITCH 4                      DMT61820
JCTTOVM  DC    CL8' '              VM OUTPUT DESTINATION                DMT61830
*                                                                       DMT61840
*        NORMAL DEVICE EXTENTION                                        DMT61850
*                                                                       DMT61860
JCTTANK  DC    A(0)                NEXT TANK TO OUTPUT                  DMT61870
JCTBUFER DC    A(0)                ADDR OF CURRENT BUFFER               DMT61880
*                                                                       DMT61890
*              TNKLM,TNKCT AND BUFLM,BUFCT MUST APPEAR IN SEQ AND STRT  DMT61900
*                                  ON HALF WORD BOUNDARIES              DMT61910
JCTTNKLM DC    AL1(2)         MAX NUM OF TANKS ASSIGNABLE TO   @VA04612 DMT61920
JCTTNKCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT61930
JCTBUFLM DC    AL1(2)              MAX NUM OF BUFFERS ASSIGNABLE        DMT61940
JCTBUFCT DC    AL1(0)              CURRENT NUM ASSIGNED                 DMT61950
*                                                              SML2NJE4 DMT61960
*        Added variable locations used to decode NJE headers   SML2NJE4 DMT61970
*                                                              SML2NJE4 DMT61980
AJNJEHDR DC    A(JNJEHEAD)         Start address of NJE headersSML2NJE4 DMT61990
AJNJEDTA DC    A(0)                Address of NJE data set hdr SML2NJE4 DMT62000
AJNJETRL DC    A(0)                Address of NJE job trailer  SML2NJE4 DMT62010
AJNJEHND DC    A(JNJEHEND)         End address of NJE headers  SML2NJE4 DMT62020
JNJEBPTR DC    A(0)                NJE headers buffer pointer  SML2NJE4 DMT62030
JRECLEN  DC    H'0'                Record length of SYSIN dev  SML2NJE4 DMT62040
JNSEGNUM DC    X'00'               Expected NJE segment number SML2NJE4 DMT62050
JNSEGTYP DC    X'00'               Expected NJE segment type   SML2NJE4 DMT62060
*                                                                       DMT62070
*                                                                       DMT62080
INTFAKE  DC    AL4($START)         FAKE ENTRY POINT                     DMT62090
INITWAIT DC    A(ADAECB)                                                DMT62100
CECBA    DC    X'80',AL3(CMDECB)   WAIT LIST FOR INIT                   DMT62110
*                                                                       DMT62120
         DS    0D                  *                                    DMT62130
INITCCW  CCW   X'2F',INITCCW+5,CC+SILI,1 DISABLE  (CHANGED TO SENSE)    DMT62140
INITCCWS CCW   X'23',ISETMODE,CC+SILI,1 SET MODE (CHANGED TO A NOP)     DMT62150
INITENA  CCW   X'27',0,CC+SILI,1   ENABLE                               DMT62160
INITCCWR CCW   1,INITSEQ,CC+SILI,2 Write initial sequence      SML2NJE4 DMT62170
INITCCRD CCW   2,IREADRES,SILI,2   Read answer from remote     SML2NJE4 DMT62180
INITSEQ  DC    AL1(XSOH,XENQ)      Initial seq sent by primary SML2NJE4 DMT62190
IREADRES DC    AL2(0)              Response chars from remote  SML2NJE4 DMT62200
IPRISEQ  DC    AL1(XSOH,XENQ)      Expected reply from primary SML2NJE4 DMT62210
ISECRES  DC    AL1(XDLE,XACK0)     Expected rply from secondarySML2NJE4 DMT62220
IALTSEQ  DC    AL1(XDLE,XNAK)      Expected rply from undecidedSML2NJE4 DMT62230
IREADSKP CCW   2,0,CC+SILI+SKIP,65000 Read to clear data lost  SML2NJE4 DMT62240
ISETMODE DC    X'00'               SET MODE BYTE                        DMT62250
         EJECT                                                          DMT62260
*---------------------------------------------------------------------* DMT62270
*                                                                     * DMT62280
*                  TP BUFFER POOL                                     * DMT62290
*                                                                     * DMT62300
*---------------------------------------------------------------------* DMT62310
         SPACE 1                                                        DMT62320
BUFLN1   DC    A(0)                BUFFER LENGTH                        DMT62330
BUFLN2   DC    A(0)                DOUBLE BUFFER LENGTH                 DMT62340
TNKLN1   DC    A(TANKEND-TANKCHN)  TANK LENGTH                          DMT62350
TNKLN2   DC    A(2*(TANKEND-TANKCHN)) DOUBLE LENGTH                     DMT62360
BUFZEROS DC    F'0'                FW OF ZERO FOR CHAINING              DMT62370
BONE     DC    F'1'                FW OF ONE                            DMT62380
BNUMBUFS DC    F'4'                NUMBER OF TP BUFFERS                 DMT62390
TPBUFSIZ DC    F'4060'  1012       Default TP buffer size          *XJE DMT62400
TNUMBUFS DC    F'15'               NUMBER OF TANKS                      DMT62410
*                                                              SML2NJE4 DMT62420
BUFSPAGE DC    F'0'                Page allocated for TP buffs SML2NJE4 DMT62430
TANKPAGE DC    F'0'                Page allocated for tanks    SML2NJE4 DMT62440
         EJECT                                                 SML2NJE4 DMT62450
*---------------------------------------------------------------------* DMT62460
*                                                                     * DMT62470
*                XJEINIT -- Initialization routine             HRC000DT DMT62480
*                    for  D M T X J E  under RSCS              HRC000DT DMT62490
*                                                                     * DMT62500
*---------------------------------------------------------------------* DMT62510
         SPACE 1                                                        DMT62520
PASSMAX  DC    F'8'                Max password length         SML2NJE4 DMT62530
REXNAME  DC    CL4'REX '           MAIN TASK NAME                       DMT62540
AXSNAME  DC    CL4'AXS '           FILE ACCESS MANAGER TASK NAME        DMT62550
XJELINK  DC    A(0)                XJE link table entry        HRC000DT DMT62560
XJELINE  DC    CL8' '              EBCDIC line address         HRC000DT DMT62570
         SPACE 1                                                        DMT62580
PASSWORD DC    CL17' '             USERID/PASSWORD             @VM01162 DMT62590
BUFFER   DC    CL8' '              BUFFER SIZE                          DMT62600
MINBUF   DC    F'300'              Minimum size of a TP buffer SML2NJE4 DMT62610
MAXBUF   DC    F'4060'   1012      Maximum TP buffer length        *XJE DMT62620
         SPACE 1                                                        DMT62630
XJESYS   DC    X'00'               XJE driver status bits      HRC000DT DMT62640
*        Bits defined in XJESYS                                HRC000DT DMT62650
SECONDRY EQU   X'80'               Secondary remote system typ SML2NJE4 DMT62660
PRIMARY  EQU   X'10'               Primary remote system type  SML2NJE4 DMT62670
RESPEND  EQU   X'04'               Secondary response pending  SML2NJE4 DMT62680
PRIMONLY EQU   X'01'               Primary remote system only  SML2NJE4 DMT62690
SGNONREC EQU   X'08'               SIGNON HAS BEEN RECEIVED OR SENT     DMT62700
         SPACE 1                                                        DMT62710
MASTERSW DC    X'00'               PROCESSOR ACTIVE SWITCH              DMT62720
*        BITS DEFINED IN MASTERSW                                       DMT62730
READER   EQU   X'80'               READER ACTIVE                        DMT62740
SYSOUT   EQU   X'40'               SYSOUT PRT/PUN device open  SML2NJE4 DMT62750
JOB      EQU   X'10'               JOB PUNCH ACTIVE                     DMT62760
         SPACE                                                          DMT62770
INITSAV  DS    3F                  TEMP SAVE AREA                       DMT62780
         DS    0F                                                       DMT62790
MSGECB   DC    F'0'                MSG SYNCH LOCK                       DMT62800
CMDECB   DC    F'0'                CMD SYNCH LOCK                       DMT62810
CMDRESP  DC    CL132' '            CMD RESPOSE BUFFER                   DMT62820
         DC    CL16' '             More command element buffer HRC016DT DMT62830
CMDINPGS DC    X'00'               COMMAND IN PROGRESS SWITCH           DMT62840
COMSAVE  DC    18F'0'              COMMON ROUTINE SAVE AREA             DMT62850
ASYNSAVE DC    18F'0'              Dedicated ASYNEXIT savearea SML2NJE4 DMT62860
ECBLIST  DC    A(RDEVSYNC)         SYNCH LOCK LIST                      DMT62870
UACON    DC    X'40',AL3(0)        PUNCH SYNCH LOCK                     DMT62880
JACON    DC    X'40',AL3(0)        JOB PUNCH SYNCH LOCK                 DMT62890
LOKCMDA  DC    A(CMDECB)           COMMAND SYNCH LOCK                   DMT62900
LOKMSGA  DC    A(MSGECB)           MSGS QUEUED SYNCH LOCK               DMT62910
PACON    DC    X'40',AL3(0)        PRINT SYNCH LOCK                     DMT62920
         DC    X'80'               INDICATE LAST IN LIST                DMT62930
LOKADAA  DC    AL3(ADAECB)         ADAPTER SYNCH LOCK                   DMT62940
         SPACE                                                          DMT62950
KRSAV    DC    4F'0'               SAVE AREA                            DMT62960
*                                                                       DMT62970
*                  BEGINNING OF QUEUE CHAINS                            DMT62980
*                                                                       DMT62990
$TEMP    DC    H'0'                GLOBAL TEMPORARY WORK                DMT63000
$BUFPOOL DC    A(0)                BUFFER POOL CHAIN CONTROL WORD       DMT63010
$TANKPOL DC    A(0)                TANK QUEUE CONTROL WORD              DMT63020
$INBUF   DC    A(0)                RECEIVED BUFFER CHAIN CTL WORD       DMT63030
$OUTBUF  DC    A(0)                XMISSION BUFFER CHAIN CTL WORD       DMT63040
$FCSOUT  DS    0H                  OUTGOING FUNCTION CONTROL SEQUENCE   DMT63050
         DC    X'8FCF'             ALL FUNCTIONS PERMITTED              DMT63060
$FCSIN   DC    X'8FCF'             INCOMING FCS                         DMT63070
         SPACE 2                                                        DMT63080
MTANK    DC    A(0)                TANK REG STORAGE                     DMT63090
$USRCMDC DC    H'0'           NUM OF USER COMMANDS             @VA04612 DMT63100
*                                                                       DMT63110
TAGCMD   DC    C'TAG DEV XXX '     TAG COMMAND                          DMT63120
TAGDATA  DC    CL70' '             DATA FIELD                           DMT63130
TAGCMDL  EQU   *-TAGCMD            LENGTH OF TAG COMMAND                DMT63140
*                                                                       DMT63150
VMDESAVE DS    0F                  REGISTER SAVE AREAS            *XJE  DMT63160
XJE2SAVE DS    16F                                                *XJE  DMT63170
XJE3SAVE DS    16F                                                *XJE  DMT63180
*                                                                       DMT63190
AXSLINK  DC    CL8' '              REM LOC LINKID TO BE FILLED IN BY IN DMT63200
AXSCVD   DC    D'0'                TEMP AREA FOR CVD OPERATIONS         DMT63210
AXSFILE  DC    CL4' '              FILE ID                              DMT63220
         DC    CL4' '                                                   DMT63230
AXSRECS  DC    CL8' '              NUM OF RECORDS                       DMT63240
BLANK    DC    CL8' '              MSG FILLER                           DMT63250
LOCATION DC    CL8' '              LOCAL LOCATION                       DMT63260
SYSTYPE  DC    CL8' '              REMOTE SYSTEM TYPE          @VM01105 DMT63270
*                                                                       DMT63280
VMSPANCH DS    F                   CCW ANCHOR                           DMT63290
VMSPNEXT DS    F                   NEXT CCW                             DMT63300
VMSPNUM  DS    F                   NUMBER OF DATA RECORDS IN 4K BUFFER  DMT63310
HDRLINE  EQU   *                   PRINT LINE AND SPACE THREE COMMAND   DMT63320
HDRSGTOP EQU   *                                                        DMT63330
HDRORGID DC    8C'Y'               FILE ORIGIN LOC ID TO BE FILLED IN   DMT63340
         DC    4C' '               FOUR BLANKS                          DMT63350
HDRVMID  DC    8C'X'               FILE ORIGIN VM ID TO BE FILLED IN    DMT63360
         DC    3C' '               THREE MORE BLANKS                    DMT63370
HDRTOD   DC    C' '                BEGINNING OF FIELD TO BE EDITED      DMT63380
         DC    C'XX/XX/XX'         FILE ORIGIN DATE FROM TOD ROUTINE    DMT63390
         DC    4C' '               FOUR MORE BLANKS                     DMT63400
         DC    C'YY:YY:YY'         FILE ORIGIN TIME FROM TOD ROUTINE    DMT63410
         DC    2C' '               TWO MORE BLANKS                      DMT63420
         DC    6C' '          SIX MORE BLANKS                  @VA03113 DMT63430
         DC    C'  WAS THE ORIGIN' ENDING NOTE                          DMT63440
HDRSGLEN EQU   (*-HDRSGTOP)        END OF THE SEGMENT DATA FIELD        DMT63450
HDRCHAR  DC    (80-HDRSGLEN)C' '                                        DMT63460
HDRLEN   EQU   (*-HDRLINE)         END OF HEADER LINE RECORD            DMT63470
         SPACE                                                          DMT63480
TODMASK  DC    AL1(MASKLEN-1)      LENGTH OF REMAINING MASK FIELD       DMT63490
         DC    X'2120',C'/',X'2020',C'/',X'2020' DATE MASK              DMT63500
         DC    3C' '               THREE BLANKS                         DMT63510
         DC    X'22'               RESET SIGNIFICANCE INDICATOR         DMT63520
         DC    X'2120',C':',X'2020',C':',X'2020' TIME MASK              DMT63530
         DC    2C' '          2 BLANKS TO SEP ENDING NOTE      @VA03113 DMT63540
MASKLEN  EQU   (*-TODMASK)         END OF EDIT MASK                     DMT63550
         SPACE                                                          DMT63560
MMDDYYHH DC    D'0'                TO  HOLD NEW HOUR CALCULATION IN DEC DMT63570
         DC    D'0'                FOR APPENDING MMDDYYHH TO MMSSMMMM   DMT63580
MMSSMMMM DC    D'0'                TO RECEIVE DECIMAL MINUTE AND SECOND DMT63590
DAYNUMBR DC    A(0)                TO RECEIVE COMPUTED DAY OF WEEK 0->6 DMT63600
TODEBCON DC    F'-1',A(0+4,TIMEZON+4) SEE BELOW                         DMT63610
*        DC    F'-1' TO HOLD LAST CALCULATION ELAPSED HOURS             DMT63620
*        DC    A(0+4) SWITCH, USED AS AN INDEX, FOR STD VS. DLT TIME    DMT63630
*        DC    A(TIMEZON+4) EXTERNAL ADDRESS OF TIMEZONE DISP TABLE     DMT63640
TODSAVE  DC    11F'0'              TODEBCD ROUTINE SAVE AREA            DMT63650
         SPACE                                                          DMT63660
TODSAVE1 DC    2F'0'               SAVE AREA                            DMT63670
         SPACE                                                          DMT63680
TIMEZON  DC    Y(0),CL6'      ' DONT CONVERT TIME ZONE         @VA03113 DMT63690
         DC    Y(0),CL6'      ' ITS CORRECT AS IT IS           @VA03113 DMT63700
         SPACE 1                                                        DMT63710
WTOMCMD  DC    F'0'                SYNCH LOCK                           DMT63720
         DC    CL4'REX '           COMMAND EXECUTATOR                   DMT63730
WCMDA    DC    A(WTOMBUF)          REQUEST BUFFER                       DMT63740
         DC    A(0)                NO RESPONSE REQUESTED                DMT63750
         SPACE 1                                                        DMT63760
WTOMBUF  DC    AL1(0),X'00',AL2(0) LENGTH,FUNCTION,ZERO                 DMT63770
WTOMNODE DC    CL8' '              Source node of incoming cmd HRC016DT DMT63780
WTOMUSER DC    CL8' '              Source user of incoming cmd HRC016DT DMT63790
WTOBUF   DC    CL120' '            CONSOLE OUTPUT BUFFER                DMT63800
         SPACE 1                                                        DMT63810
WTORJMSG DC    AL2(170),AL2(0)     NUMBER PLUS SPARE                    DMT63820
         DC    CL8' '              LINKID                               DMT63830
WTORJBUF DC    CL120' '            MSG BUFFER                           DMT63840
WACN1    DC    S(WINIT)            RETURN ENTRY POINT                   DMT63850
CMDCMDSV DS    F                   RETURN SAVE                          DMT63860
CMDCVD   DC    D'0'                CONVERT AREA                         DMT63870
CMDFID   DC    CL4' '              COMMAND SPOOLID AREA                 DMT63880
         DC    CL4' '                                                   DMT63890
*                                                                       DMT63900
RDRCMD   DC    X'00'               READER COMMAND BYTE                  DMT63910
*        BITS DEFINED IN RDRCMD                                         DMT63920
RBACKFIL EQU   X'80'               BACKSPACE FILE                       DMT63930
RBACKCNT EQU   X'40'               BACKSPACE COUNT                      DMT63940
RFWDCNT  EQU   X'20'               FORWARD SPACE COUNT                  DMT63950
RFLSHCPY EQU   X'10'               FLUSH COPY                           DMT63960
RFLSHALL EQU   X'08'               FLUSH ALL COPIES                     DMT63970
RFLSHOLD EQU   X'04'               FLUSH AND HOLD                       DMT63980
RHLDIPGS EQU   X'02'               HOLD IN PROGRESS                     DMT63990
         SPACE                                                          DMT64000
HOLD     EQU   X'80'               SUB OPTION ON CLOSE INPUT REQ        DMT64010
ALL      EQU   X'40'               SUB OPTION ON CLOSE INPUT REQ        DMT64020
MULTOPEN EQU   X'80'               SUB OPTION ON OPEN OUTPUT REQ        DMT64030
         SPACE                                                          DMT64040
RDRCMDCT DC    F'0'                FILE SPACE COUNT                     DMT64050
RDRCMDID DC    H'0'                CMD INDICATED SPOOLID                DMT64060
RDRCMDLK DC    CL8' '              CMD RESPONSE LINKID                  DMT64070
HLDCMDLK DC    CL8' '              CMD RESPONSE LINKID                  DMT64080
         DS    0F                                                       DMT64090
MSGREQ   DC    F'0'                SYNCH LOCK                           DMT64100
         DC    CL4'REX '           TASK NAME                            DMT64110
MREQA    DC    A(MSGBLK)           REQUEST BUFFER                       DMT64120
         DC    A(0)                NO RESPONSE                          DMT64130
         SPACE 1                                                        DMT64140
MSGBLK   DC    AL1(0),AL1(2),AL1(0),AL1(0) LENGTH,FUNCTION,ROUTE,SEV    DMT64150
MSGLINK  DC    8X'00'              LINKID                               DMT64160
MSGVMID  DC    CL8' '              VIRTUAL MACHINE ID                   DMT64170
         DC    CL3'XJE',CL1' '     Module ID plus action code  HRC000DT DMT64180
MSGBUF   DC    CL120' '            MSG BUFFER                           DMT64190
         SPACE                                                          DMT64200
MSGSAVE  DC    5F'0'               SAVE AREA                            DMT64210
         EJECT                                                          DMT64220
*---------------------------------------------------------------------* DMT64230
*                                                                     * DMT64240
*                     $TPPUT STORAGE                                  * DMT64250
*                                                                     * DMT64260
*---------------------------------------------------------------------* DMT64270
AXSAVE   DS    F                   AXS SAVE AREA                        DMT64280
         SPACE 1                                                        DMT64290
OSAVR6   DC    A(0)                REG SAVE                             DMT64300
OSAVR5   DC    A(0)                REG SAVE                             DMT64310
OSAVR14  DC    A(0)                RETURN ADDR SAVE                     DMT64320
OINADD   DC    A(0)                INPUT TANK ADDR                      DMT64330
OINEND   DC    A(0)                LAST VALID DATA BYTE IN TANK         DMT64340
OACTBUF  DC    A(0)                ACTIVE BUFFER ADDR                   DMT64350
OBUFPTR  DC    A(0)                CURRENT POINTER IN BUFFER            DMT64360
OBUFCNT  DC    H'0'                REMAING SPACE COUNT IN BUFFER        DMT64370
OTEMP    DS    CL64           COMPRESSION WORK AREA            @VA04175 DMT64380
*                                  DUMMY TANK                           DMT64390
TTANK    DC    A(0)                CHAIN                                DMT64400
         DC    X'90'               RCB FOR FUNCTION CTL RECORD          DMT64410
         DC    X'00'               USER'S SRCB (FUNCTION TYPE)          DMT64420
         DC    H'0'                TANK COUNT                           DMT64430
TSAVA    DC    A(0)                SAVE AREA                            DMT64440
TSAVB    DC    A(0)                SAVE AREA                            DMT64450
TANKCON  DC    A(TTANK)            CONSTANT                             DMT64460
         SPACE                                                          DMT64470
IOERRSV  DS    4F                  SAVE AREA                            DMT64480
IOERRMSG DC    AL2(70),AL2(0)      MSG NUMBER AND SPARE                 DMT64490
IOERRLNE DC    CL8' '              LINE ADDR                            DMT64500
IERRSIO  DC    CL8' '              ADAPTER SIO COND CODE                DMT64510
IERRCSW1 DC    CL8' '              ADAPTER CSW                          DMT64520
IERRCSW2 DC    CL8' '              PART 2 OF CSW                        DMT64530
IERRSENS DC    CL8' '              ADAPTER SENSE BYTE                   DMT64540
IERRCCW1 DC    CL8'00000000'       ADAPTER FAILING CCW                  DMT64550
IERRCCW2 DC    CL8'00000000'       PART 2 OF CCW                        DMT64560
IOERMSGL EQU   *-IOERRMSG          LENGTH OF ERROR MSG                  DMT64570
         DC    CL1' '              GARBAGE BYTE                         DMT64580
         SPACE                                                          DMT64590
TRCVD    DS    D                   CVD AREA                             DMT64600
TRSAVE   DS    4F                  SAVE AREA                            DMT64610
         SPACE                                                          DMT64620
TRMSG    DC    AL2(149),AL2(0)     NUMBER PLUS SPARE                    DMT64630
TRLINK   DC    CL8' '              LINKID                               DMT64640
TRMTRN   DC    CL8' '              TRANSACTION COUNT                    DMT64650
TRMERR   DC    CL8' '              ERROR COUNT                          DMT64660
TRMTO    DC    CL8' '              TIMEOUT COUNT                        DMT64670
TRMSGL   EQU   *-TRMSG             LENGTH OF MSG                        DMT64680
         SPACE                                                          DMT64690
TRASHLD  DC    F'60'               THRESHOLD LEVEL FOR MSG              DMT64700
ERRSHLD  DC    F'20'               THRESHOLD LEVEL FOR MSG              DMT64710
*                                                                       DMT64720
KSAV     DC    6F'0'               SAVE AREA                            DMT64730
KCCW     DC    XL8'0'         SAVED CCW                        @VA04353 DMT64740
MVCBLANK MVC   1(0,R1),0(R1)  EXECUTED MVC                     @VA04353 DMT64750
IOLINE   DC    CL120' '            LOG PRINT LINE                       DMT64760
R        DC    C'R'                READ                                 DMT64770
W        DC    C'W'                WRITE                                DMT64780
         SPACE 1                                                        DMT64790
$LOGSW   DC    X'00'               LOG SWITCH                           DMT64800
*        BITS DEFINED IN $LOGSW                                         DMT64810
LOGON    EQU   X'80'               LOGING SET ON                        DMT64820
LOGOPEN  EQU   X'40'               LOG DEVICE OPEN                      DMT64830
         SPACE 1                                                        DMT64840
         DS    0F                                                       DMT64850
LOGBLK   DC    F'0'                SYNCH LOCK                           DMT64860
         DC    CL4'AXS '           FILE ACCESS TASK NAME                DMT64870
LOGREQA  DC    A(LOGGREQ)          REQUEST BUFFER ADDRESS               DMT64880
LOGREQG  DC    AL1(19),AL3(LOGGREQ) RESPONSE BUFFER ADDRESS             DMT64890
LOGGREQ  DC    AL1(19,0,0,0)       LENGTH,FUNCTION,SPARE,SUBCODE        DMT64900
ALDEVTAG DC    A(LDEVTAG)          Log tag address             SML2NJE4 DMT64910
LOGFIOA  DC    A(0)                FILE I/O AREA ADDRESS                DMT64920
         DC    CL8' '              LINK ID                              DMT64930
         SPACE 1                                                        DMT64940
         DS    0D                                                       DMT64950
LOGCCW   CCW   X'09',IOLINE,SILI,120 WRITE AND SPACE 1                  DMT64960
LOGHDCCW CCW   X'19',LOGHDLNE,SILI,LOGHDRLN WRITE AND SPACE 3           DMT64970
         SPACE 1                                                        DMT64980
LOGHDLNE DC    CL3' '                                                   DMT64990
         DC    C'D M T X J E   LINE TRANSACTION LOG FOR LINK ' HRC000DT DMT65000
LOGLINK  DC    CL8' '                                                   DMT65010
         DC    C' ON '                                                  DMT65020
LOGDTIME DC    CL17' '                                                  DMT65030
LOGHDRLN EQU   *-LOGHDLNE          LENGTH OF HDR LINE                   DMT65040
         DS    0D                                                       DMT65050
LOGTIME  DC    CL32' '             DIAG BUFFER                          DMT65060
CLOSESAV DS    F                   Save area for return addr   SML2NJE4 DMT65070
*                                                                       DMT65080
TERMBLK  DC    F'0',CL4'REX ',A(TERMREQ),A(0) GIVE REQUEST BLOCK        DMT65090
         SPACE 1                                                        DMT65100
TERMREQ  DC    AL1(1),X'03'        LENGTH,FUNCTION                      DMT65110
LONGWAIT DC    F'0'                LONG WAIT SYNCH LOCK                 DMT65120
*                                                                       DMT65130
CBUFFER  DC    A(0)                ACTIVE COMUNICATIONS BUFFER          DMT65140
CFCSOUT  DC    X'8FCF'        LAST FCS TRANSMITTED             @VA04174 DMT65150
CFCSSTD  DC    X'88C1'        STANDARD FCS                     @VA03425 DMT65160
CFCSTEMP DC    AL2(0)         FCS COMPARE AREA                 @VA03301 DMT65170
CTEMP    DC    H'0'                TEMPORARY STORAGE                    DMT65180
CMAXDUP  DC    H'3'                MAX REPEATED BLOCKS                  DMT65190
         DC    AL1(0)              FIRST BYTE OF HALF-WORD              DMT65200
CBCBCNTO DC    AL1(X'80')          BLOCK CHECK COUNT OUT                DMT65210
         DC    AL1(0)              SPACER                               DMT65220
CBCBCNTI DC    AL1(X'80')          BLOCK COUNT CHARACTER EXPECTED       DMT65230
         DC    H'0'                *                                    DMT65240
CBUFLAST DC    10X'00'             SAVE OF START OF LAST BUFFER         DMT65250
CRESP    DC    AL1(0)              RESPONSE CHARACTER RECEIVED          DMT65260
CREGS    DS    3F                  REGISTER SAVE AREA                   DMT65270
         SPACE 1                                                        DMT65280
CRETREGS DS    3F                  SAVE AREA                            DMT65290
$COMEXIT DC    A($START)           COMSUP INITIAL ENTRY POINT           DMT65300
         SPACE 1                                                        DMT65310
CBCB     DC    X'00'               LAST BCB SENT                        DMT65320
CSETBCB  DC    X'00'               HERE TOO..FOR RESET                  DMT65330
         SPACE 1                                                        DMT65340
         DS    0F                  FORCE FULL-WORD ALIGNMENT            DMT65350
CCSW     DC    XL8'00'             TEMP STORAGE FOR CSW                 DMT65360
COLDRCB  DC    X'00'               LAST RCB SENT                        DMT65370
CUNITCMD DC    X'00'               COMMAND CODE STORAGE                 DMT65380
         SPACE 1                                                        DMT65390
CLASTCAW DC    F'0'                CCW ADDR SAVE                        DMT65400
         SPACE 2                                                        DMT65410
BUFSYNSW DC    X'00'               BUFFER SYNCHRONIZATION SWITCH        DMT65420
*        BITS DEFINED IN BUFSYNSW                                       DMT65430
$TPPNONE EQU   X'80'               STOP ALL BUFFERING                   DMT65440
OFLSW    EQU   X'40'               FLUSH BUFFER                         DMT65450
GDQBUFS  EQU   X'20'               STOP DEQUEUING BUFFERS               DMT65460
$COMBUSY EQU   X'10'               COMMUNICATIONS INACTIVE              DMT65470
CUWFAKE  EQU   X'08'               DUMMY READ ON FOR UE RECOVERY        DMT65480
CACKSW   EQU   X'04'               ACK RECEIVED                         DMT65490
*                                                                       DMT65500
ADAECB   DC    F'0'                SYNCH LOCK                           DMT65510
ADACUU   DC    X'0000',AL1(1),AL1(TYP2700)                              DMT65520
ADCCWA   DC    A(CCTCCW)           ADAPTER CCW ADDR                     DMT65530
ADASIOCC EQU   *                   SIO CONDITION CODE                   DMT65540
ADACSW   DC    2F'0'               ADAPTER ENDING CSW                   DMT65550
ADASENSE DC    F'0'                ADAPTER SENSE BYTE                   DMT65560
         SPACE 3                                                        DMT65570
ADSAV    DC    8F'0'               $SIO REGISTER SAVE AREA              DMT65580
RDCOUNT  DC    H'0'           READ BUFFER SIZE                 @VA07451 DMT65590
DUMCOUNT DC    H'0010'                 MAX BUFFER FOR RD COUNT @VA08578 DMT65600
*
WERRCODE DS    AL2                 Error code                  SML2NJE4 DMT27650
         DS    AL2(0)              Spare bytes                 SML2NJE4
WERRLINK DS    CL8                 Link name subject of error  SML2NJE4 DMT27670
*                                                                       DMT65610
*                        CONTROL SEQUENCES                              DMT65620
XSTXSEQ  DC    AL1(XLDR,XSTX)      START-OF-TEXT SEQUENCE               DMT65630
XETBSEQ  DC    AL1(XTRL,XETB)      END-OF-TEXT-BLOCK SEQUENCE           DMT65640
XACKSEQ  DC    AL1(XDLE,XACK0)     POSITIVE ACKNOWLEDGEMENT SEQUENCE    DMT65650
XNAKSEQ  DC    AL1(XSYN,XNAK)      NEGATIVE ACKNOWLEDGEMENT SEQUENCE    DMT65660
XSYNSEQ  DC    AL1(XSYN,XSYN,XSYN,XSYN) SYNCHRONIZATION SEQUENC@VA03340 DMT65670
         SPACE 2                                                        DMT65680
*                        CHANNEL COMMAND WORDS                          DMT65690
         SPACE 1                                                        DMT65700
*                   NORMAL DATA WRITE WITH RETURN DATA READ             DMT65710
         SPACE 1                                                        DMT65720
CCWS     CCW   1,XSYNSEQ,CD+SILI,4 SYNCHRONIZATION SEQUENCE    @VA03340 DMT65730
CCWA     CCW   1,0,CC+SILI,0       WRITE BUFFER                         DMT65740
CCWB     CCW   1,XETBSEQ,CC+SILI,2 WRITE ENDING SEQUENCE                DMT65750
CCWC     CCW   2,0,SILI,0          READ RETURN DATA                     DMT65760
         SPACE 1                                                        DMT65770
*                   DUMMY READ TO TURN OFF LOST DATA SENSE              DMT65780
         SPACE 1                                                        DMT65790
CCWD     CCW   2,0,SILI+SKIP,65000 NON-READ A BUNCH                     DMT65800
         SPACE 1                                                        DMT65810
*                             DISABLE COMMAND                           DMT65820
CCWOFF   CCW   X'2F',0,SILI,1      DISABLE                              DMT65830
         SPACE 1                                                        DMT65840
WRITE    EQU   X'01'               ADAPTER WRITE COMMAND CODE           DMT65850
READ     EQU   X'02'               ADAPTER READ COMMAND CODE            DMT65860
NOP      EQU   X'03'               ADAPTER NOP COMMAND CODE             DMT65870
SENSE    EQU   X'04'               ADAPTER SENSE COMMAND CODE           DMT65880
SETMODE  EQU   X'23'               Adapter set mode command    SML2NJE4 DMT65890
DISABLE  EQU   X'2F'          ADAPTER DISABLE COMMAND          @VA04353 DMT65900
         SPACE 2                                                        DMT65910
*              PROTOTYPE CTL RECORD TO TELL THAT BLOCKS ARE LOST        DMT65920
         SPACE 1                                                        DMT65930
CLOSTBLK DS    0H                  START                                DMT65940
         DC    AL2(CLOSTEND-CLOSTBS) BUFCOUNT                           DMT65950
         DC    AL1(BUFTEXT)        BUFSTAT                              DMT65960
CLOSTBS  DC    AL1(XLDR,XSTX)      BUFSTART                             DMT65970
CLOSTBCB DC    AL1(X'80'+BCBIGNRE) BUFBCB(RECEIVED BLOCK CT ADDED       DMT65980
CLOSTFCS DC    AL2(0)              FCS                                  DMT65990
         DC    AL1(X'E0')          RCB (CTL REC,TYPE=LOST DATA)         DMT66000
CLSTSRCB DC    AL1(X'80')          SRCB(EXPECTED BLK CT ADDED)          DMT66010
         DC    AL1(0)              SCB (NULL RECORD)                    DMT66020
         DC    AL1(0)              RCB (END OF BLOCK)                   DMT66030
CLOSTEND EQU   *                   END OF PROTOTYPE                     DMT66040
         SPACE 1                                                        DMT66050
CDUMMY   DC    A(0)                NO CHAIN                             DMT66060
         DC    AL2(CDUMEND-CDUMSTRT) COUNT                              DMT66070
         DC    AL1(BUFFAKE)        BUFSTAT                              DMT66080
CDUMSTRT DC    AL1(XLDR,XSTX)      BUFSTART                             DMT66090
         DC    AL1(X'80'+BCBIGNRE) BUFBCB                               DMT66100
         DC    AL2(0)              FCS                                  DMT66110
         DC    AL1(0)              RCB (EOB)                            DMT66120
CDUMEND  EQU   *                   END OF DUMMY BUFFER                  DMT66130
         SPACE 1                                                        DMT66140
CUEFAKE  DC    A(0)                BUFCHAIN                             DMT66150
         DC    AL2(0)              BUFCOUNT                             DMT66160
         DC    AL1(BUFFAKE+BUFUCHEK) BUFFER STATUS                      DMT66170
         DC    CL10' '             DUMMY AREA JUST IN CASE              DMT66180
         SPACE 1                                                        DMT66190
ICTLS    DS    0H                  CONTROL INFO FOR BUFFER              DMT66200
         DC    AL2(ICTLE-*-3)      BUFCOUNT                             DMT66210
         DC    X'00'               BUFSTAT                              DMT66220
         DC    AL1(XLDR,XSTX)      BUFSTART                             DMT66230
         DC    AL1(X'80'+BCBRESET) BUFBCB (RESETS EXPECTED BLOCK CT)    DMT66240
         DC    AL2(0)              FCS                                  DMT66250
ICTLB    EQU   *                                               SML2NJE4 DMT66260
*                                                                       DMT66270
NCCRCB   DC    X'F0'               Path manager RCB            SML2NJE4 DMT66280
NCCSRCB  DC    C'I'                Signon record SRCB          SML2NJE4 DMT66290
NCCIDL   DC    AL1(ICTLE-ICTLB)    Length of signon record     SML2NJE4 DMT66300
NCCINODE DC    CL8' '              Name of this node           SML2NJE4 DMT66310
NCCIQUAL DC    AL1(1)              Member number of the node   SML2NJE4 DMT66320
NCCIEVNT DC    AL4(0)              Not used for signon         SML2NJE4 DMT66330
NCCIREST DC    AL2(0)              Partial node-node resistanceSML2NJE4 DMT66340
NCCIBFSZ DC    AL2(0)              Max transmit buffer size    SML2NJE4 DMT66350
NCCILPAS DC    CL8' '              Line password               SML2NJE4 DMT66360
NCCINPAS DC    CL8' '              Node password               SML2NJE4 DMT66370
NCCIFLG  DC    X'00'               Flags - all zero for signon SML2NJE4 DMT66380
NCCIFEAT DC    XL4'10000000'       Features - NCCIPACK only    SML2NJE4 DMT66390
ICTLE    EQU   *                                                        DMT66400
         SPACE                                                          DMT66410
SGNOFCCW CCW   1,SGNOFDTA,CC+SILI,SGNOFEND-SGNOFDTA Send SO recSML2NJE4 DMT66420
SGNCCWA  CCW   1,SGNOFEND,SILI,2   Send TRL ETB after record   SML2NJE4 DMT66430
SGNOFDTA DS    0H                  Signoff record              SML2NJE4 DMT66440
         DC    AL1(XLDR,XSTX)      Buffer start                SML2NJE4 DMT66450
         DC    AL1(X'80'+BCBIGNRE) Ask partner to ignore BCB   SML2NJE4 DMT66460
         DC    AL2(X'8FCF')        FCS                         SML2NJE4 DMT66470
         DC    X'F0'               General control RCB         SML2NJE4 DMT66480
         DC    C'B'                Signoff SRCB                SML2NJE4 DMT66490
SGNOFEND DC    AL1(XTRL,XETB)      End of transmission block   SML2NJE4 DMT66500
AXSTRTAB DC    C'0123456789ABCDEF' EBCDIC TRANSLATE TABLE               DMT66510
*                                                                       DMT66520
GINBUF   DC    A(0)                INPUT BUFFER ADDR                    DMT66530
GBUFPTR  DC    A(0)                INPUT BUFFER POINTER                 DMT66540
GTANK    DC    A(0)                TANK ADDR                            DMT66550
GAST     DC    A(0)                TEMP STORAGE                         DMT66560
GCTL     DC    H'0'                WORK SPACE 1                         DMT66570
GSCBCK   DC    H'0'           SCB CHECK CHAR                   @VA06382 DMT66580
TOCNT    DC    H'0'           CONSECUTIVE TIMEOUT COUNTER      @VA05950 DMT66590
GSCB     DC    X'00'               WORKING STRING CONTROL BYTE          DMT66600
*                                                                       DMT66610
$START   DS    0H                                                       DMT66620
$CCOMM1  NOP   $CONTROL            CONTROL RECORD PROCESSOR             DMT66630
$TPGETCM NOP   $TPGET              INPUT BUFFER MANAGER                 DMT66640
$PCOMM1  NOP   $PCOM1              ENTRY POINT TO PRINT                 DMT66650
$RCOMM1  NOP   $RCOM1              Entry point to read card    SML2NJE4 DMT66660
$JCOMM1  NOP   $JCOM1              ENTRY TO PUNCH JOB                   DMT66670
$WCOMM1  NOP   $WCOM1              TYPE ON CONSOLE                      DMT66680
$CMDCOM  NOP   CMDPROC             COMMAND INPUT                        DMT66690
$MSGCOM  NOP   MSGPROC             MESSAGE READY                        DMT66700
$COMCOM  NOP   $COMSUP             COMMUNICATIONS SUPERVISOR            DMT66710
         NOP   $INTRUPT            INTERRUPT ADDR                       DMT66720
$COMEND  EQU   *                                                        DMT66730
         B     CMDECK                                                   DMT66740
*                                                                       DMT66750
         DS    0F
MSGXNUM  DC    AL2(0),AL2(0)                                      *XJE  DMT66760
MSGXVAL  DC    5CL8' '                                            *XJE  DMT66770
*                                                                 *XJE
*--replacement svectors                                           *XJE
TLINKS   DC    A(0)                                               *XJE
ASYNREQ  DC    A(0)                                               *XJE
POSTREQ  DC    A(0)                                               *XJE
SPLREQ   DC    A(0) (was TCOM)                                    *XJE
IOREQ    DC    A(0)                                               *XJE
WAITREQ  DC    A(0)                                               *XJE
ALERTREQ DC    A(0)                                               *XJE
GIVEREQ  DC    A(0)                                               *XJE
*--replacement comdsect                                           *XJE
PMSGREQ  DC    A(0)                                               *XJE
GPAGEREQ DC    A(0)                                               *XJE
GLINKREQ DC    A(0)                                               *XJE
GROUTREQ DC    A(0)                                               *XJE
GMSGREQ  DC    A(0)                                               *XJE
GTODEBCD DC    A(0)                                               *XJE
SVLEN    EQU   *-TLINKS                                           *XJE
         DS    0D                  Force doubleword size          *XJE  DMT66780
DMTXJEAZ EQU   *-DMTXJEA           Size of storage area           *XJE  DMT66790
*                                                                       DMT66800
         DS    (4096-DMTXJEAZ)X    Fill space to end of page      *XJE  DMT66810
         DROP  R12,R11,R10                                        *XJE  DMT66820
*                                                                       DMT66830
*                                                                       DMT66840
********************                                                    DMT66850
*                  *   Contains NJE header management work areas.       DMT66860
* CSECT DMTXJEB    *   This csect is only used and referenced by        DMT66870
*                  *   the NJE header management routines in            DMT66880
********************   csect DMTXJE3.                                   DMT66890
*                                                                       DMT66900
* --- For proper relocation of adcons in the csect DMTXJEA above ---    DMT66910
* --- this csect must begin exactly 4096 bytes past the start of ---    DMT66920
* --- csect DMTXJEA.                                             ---    DMT66930
*                                                                       DMT66940
*                                                                 *XJE  DMT66950
DMTXJEB  CSECT                                                          DMT66960
*                        BNMADDRS are offsets into NMRODATA       *XJE  DMT66970
BNMADDRS DC    A(33)     Offset to first place colon might be     *XJE  DMT66980
         DC    A(1)                Loop increment              SML2NJE4 DMT66990
         DC    A(51)     Offset to last place colon might be      *XJE  DMT67000
*                                                                       DMT67010
*        Temporary workspace for constructing NMRs             SML2NJE4 DMT67020
NMROTEMP DS    CL8                 Temporary msg source node   SML2NJE4 DMT67030
*        Tank for constructing outgoing NMRs                   SML2NJE4 DMT67040
NMROTANK DC    A(0)                Address of next tank (none) SML2NJE4 DMT67050
         DC    X'9A'               NMR output tank RCB         SML2NJE4 DMT67060
         DC    X'80'               NMR output tank SRCB        SML2NJE4 DMT67070
         DS    H                   NMR output tank count       SML2NJE4 DMT67080
NMRODATA EQU   *                   NMR output tank data        SML2NJE4 DMT67090
         DS    30X                 NMR output header buffer    SML2NJE4 DMT67100
         DS    CL148               NMR output message buffer   SML2NJE4 DMT67110
         DS    CL4                 Compression routine overflowSML2NJE4 DMT67120
         EJECT                                                 SML2NJE4 DMT67130
*        Device tags moved out of range of base registers      SML2NJE4 DMT67140
         SPACE 1                                               SML2NJE4 DMT67150
PDEVTAG  DS    XL108          SYSOUT PUN / PRT device tag      SML2NJE4 DMT67160
JDEVTAG  DS    XL108          SYSIN PUN device tag             SML2NJE4 DMT67170
LDEVTAG  DS    XL108          Log printer tag                  SML2NJE4 DMT67180
         SPACE 1                                               SML2NJE4 DMT67190
*        Buffer space to decode incoming NJE headers           SML2NJE4 DMT67200
         SPACE 1                                               SML2NJE4 DMT67210
MAXNJEH  EQU   1024                Allow up to 1KB of headers  SML2NJE4 DMT67220
         SPACE 1                                               SML2NJE4 DMT67230
RNJEHEAD DS    XL(MAXNJEH)                                     SML2NJE4 DMT67240
RNJEHEND EQU   *                                               SML2NJE4 DMT67250
PNJEHEAD DS    XL(MAXNJEH)                                     SML2NJE4 DMT67260
PNJEHEND EQU   *                                               SML2NJE4 DMT67270
JNJEHEAD DS    XL(MAXNJEH)                                     SML2NJE4 DMT67280
JNJEHEND EQU   *                                               SML2NJE4 DMT67290
         DS    0D                  Force doubleword size          *XJE  DMT67300
DMTXJEBZ EQU   *-DMTXJEB           Size of storage area           *XJE  DMT67310
*                                                                       DMT67320
*                                                                       DMT67330
********************                                                    DMT67340
*                  *                                                    DMT67350
* RSCS DSECTS      *                                                    DMT67360
*                  *                                                    DMT67370
********************                                                    DMT67380
*                                                                       DMT67390
TCTDSECT DSECT                                                          DMT67400
         SPACE 1                                                        DMT67410
***                     TCT  -  TASK CONTROL TABLE                      DMT67420
*                                                                       DMT67430
*          0   +-----------------------+-----------------------+        DMT67440
*              |        TCTSTRT        |        TCTENTY        |        DMT67450
*          4   +-----------------------+-----------------------+        DMT67460
*              |                    TCTRTN                     |        DMT67470
*          8   +-----------+-----------------------------------+        DMT67480
*              |  TCTCCW   |              TCTDATA              |        DMT67490
*          C   +-----------+-----------+-----------------------+        DMT67500
*              | TCTFLAG   | TCTOPCOD  |     TCTCCWCT          |        DMT67510
*         10   +-----------+-----------+-----------+-----------+        DMT67520
*              |  TCTECB   |  TCTSTAT  |  TCTWFB   |           |        DMT67530
*         14   +-----------+-----------+-----------+-----------+        DMT67540
*              |         TCTFCS        |  TCTRCBR  |  TCTRCBT  |        DMT67550
*         18   +-----------------------+-----------+-----------+        DMT67560
*              |                    TCTCOM                     |        DMT67570
*         1C   +-----------------------------------------------+        DMT67580
*              |                   TDEVSYNC                    |        DMT67590
*         20   +-----------------------------------------------+        DMT67600
*              |                   TDEVREQN                    |        DMT67610
*         24   +-----------------------------------------------+        DMT67620
*              |                   TDEVREQ                     |        DMT67630
*         28   +-----------------------------------------------+        DMT67640
*              |                   TDEVRESP                    |        DMT67650
*         2C   +-----------+-----------+-----------+-----------+        DMT67660
*              | TDEVRLEN  |  TDEVFUN  |  TDEVRESV |  TDEVSOPT |        DMT67670
*         30   +-----------+-----------+-----------+-----------+        DMT67680
*              |                   TDEVTAG                     |        DMT67690
*         34   +-----------------------------------------------+        DMT67700
*              |                   TDEVFIOA                    |        DMT67710
*         38   +-----------------------------------------------+        DMT67720
*              |                   TDEVLINK                    |        DMT67730
*         3C   +-----------+-----------+-----------+-----------+        DMT67740
*              |   TSW1    |   TSW2    |   TSW3    |   TSW4    |        DMT67750
*         40   +-----------+-----------+-----------+-----------+        DMT67760
*              |                                               |        DMT67770
*              |                   TCTTOVM                     |        DMT67780
*              |                                               |        DMT67790
*         48   +-----------------------------------------------+        DMT67800
*              |                   TCTTANK                     |        DMT67810
*         4C   +-----------------------------------------------+        DMT67820
*              |                   TCTBUFER                    |        DMT67830
*         50   +-----------+-----------+-----------+-----------+        DMT67840
*              | TCTTNKLM  |  TCTTNKCT |  TCTBUFLM |  TCTBUFCT |        DMT67850
*         54   +-----------+-----------+-----------+-----------+        DMT67860
*                                                                       DMT67870
***                     TCT  -  TASK CONTROL TABLE                      DMT67880
         SPACE 1                                                        DMT67890
TTCT     DS    0H                                                       DMT67900
TCTSTRT  DS    CL2                 B TO PROPER PROCESSOR ENTRY          DMT67910
TCTENTY  DS    CL2                 ADR PORTION ***MODIFIED BY PROCE     DMT67920
TCTRTN   DS    CL4                 B TO NEXT PROCESSOR VIA COMMUTAT     DMT67930
TCTCCW   DS    CL1                 CCW FOR DEVICE OP-CODE               DMT67940
TCTDATA  DS    AL3                 ADDRESS OF DATA TRANSFERRED          DMT67950
TCTFLAG  DS    CL1                 FLAGS ON CCW                         DMT67960
TCTOPCOD DS    CL1                 SAVE AREA FOR CCW OP-CODE            DMT67970
TCTCCWCT DS    AL2                 CCW COUNT OF DATA TRANSFERRED        DMT67980
TCTECB   DS    CL1                 EVENT CONTROL                        DMT67990
TCTSTAT  DS    CL1                 STATUS FLAGS                         DMT68000
TCTWFB   DS    AL1                 WAITING FOR BUFFERS                  DMT68010
TCTSAV1  DS    1F                  SAVE AREA FOR PROCESSOR ROUTINE      DMT68020
TCTNEXT  DS    1F                  NEXT TCT IN CHAIN                    DMT68030
TCTFCS   DS    AL2                 FUNCTION CONTROL SEQUENCE MASK       DMT68040
TCTRCBR  DS    CL1                 RECV RECORD CONTROL BLOCK            DMT68050
TCTRCBT  DS    CL1                 TRANS RECORD CONTROL BLOCK           DMT68060
TCTCOM   DS    1F                  POINTER BACK TO COMMUTATOR           DMT68070
TDEVSYNC DS    1F                  SYNCH LOCK                           DMT68080
TDEVREQN DS    CL4                 FILE ACCESS NAME                     DMT68090
TDEVREQ  DS    1A                  REQUEST BUFFER ADDRESS               DMT68100
TDEVRESP DS    1A                  RESPONSE BUFFER                      DMT68110
TDEVRLEN DS    AL1                 REQUEST LENGTH                       DMT68120
TDEVFUN  DS    AL1                 REQUEST FUNCTION                     DMT68130
TDEVRESV DS    AL1                 RESERVED BYTE                        DMT68140
TDEVSOPT DS    AL1                 SUB OPTION BYTE                      DMT68150
TDEVTAG  DS    1A                  TAG ADDRESS                          DMT68160
TDEVFIOA DS    1A                  FILE I/O AREA                        DMT68170
TDEVLINK DS    CL8                 LINK NAME                            DMT68180
TSW1     DS    AL1                 DEVICE SWITCH 1                      DMT68190
TSW2     DS    AL1                 DEVICE SWITCH 2                      DMT68200
TSW3     DS    AL1                 DEVICE SWITCH 3                      DMT68210
TSW4     DS    AL1                 DEVICE SWITCH 4                      DMT68220
TCTTOVM  DS    CL8                 VM OUTPUT DESTINATION                DMT68230
*                                                                       DMT68240
*        NORMAL DEVICE EXTENTION                                        DMT68250
*                                                                       DMT68260
TCTTANK  DS    1F                  NEXT TANK TO OUTPUT                  DMT68270
TCTBUFER DS    1F                  ADDR OF CURRENT BUFFER               DMT68280
*                                                                       DMT68290
*              TNKLM,TNKCT AND BUFLM,BUFCT MUST APPEAR IN SEQ AND STRT  DMT68300
*                                  ON HALF WORD BOUNDARIES              DMT68310
TCTTNKLM DS    CL1                 MAX NUM OF TANKS ASSIGNABLE TO       DMT68320
TCTTNKCT DS    CL1                 CURRENT NUM ASSIGNED                 DMT68330
TCTBUFLM DS    CL1                 MAX NUM OF BUFFERS ASSIGNABLE        DMT68340
TCTBUFCT DS    CL1                 CURRENT NUM ASSIGNED                 DMT68350
         EJECT                                                          DMT68360
*                                                                       DMT68370
*        TCTSTAT BIT DEFINITIONS                                        DMT68380
*                                                                       DMT68390
TCT1052  EQU   X'10'               TCT STATUS FLAGS FOR 1052            DMT68400
TCTREL   EQU   X'04'               INTERLOCK RELEASE REQ FOR CONSOLE    DMT68410
TCTOPEN  EQU   X'80'               TCT OPEN BIT                         DMT68420
TCTACT   EQU   X'40'               ACTION REQUIRED ON THIS TCT          DMT68430
         SPACE 2                                                        DMT68440
***      TCTECB BIT DEFINITIONS                                         DMT68450
         SPACE 2                                                        DMT68460
TCTBUSY  EQU   X'10'               DEVICE BUSY BIT                      DMT68470
         EJECT                                                          DMT68480
BUFDSECT DSECT                                                          DMT68490
         SPACE 1                                                        DMT68500
***                 BUFFER  -  TELECOMMUNICATIONS BUFFER                DMT68510
*                                                                       DMT68520
*          0   +-----------------------------------------------+        DMT68530
*              |                   BUFCHAIN                    |        DMT68540
*          4   +-----------------------+-----------------------+        DMT68550
*              |      BUFCOUNT         |  BUFSTAT  | BUFSTART  |        DMT68560
*          8   +-----------+-----------+-----------------------+        DMT68570
*              | BUFSTART  |  BUFBCB   |        BUFFCS         |        DMT68580
*          C   +-----------+-----------+-----------------------+        DMT68590
*              |                                               |        DMT68600
*              |                   BUFDATA                     |        DMT68610
*              |                                               |        DMT68620
*              +-----------------------------------------------+        DMT68630
*                                                                       DMT68640
***                 BUFFER  -  TELECOMMUNICATIONS BUFFER                DMT68650
         SPACE 1                                                        DMT68660
BUFBEGIN DS    0F                  BEGINNING OF THE BUFFER              DMT68670
BUFCHAIN DC    A(0)                BUFFER CHAIN FIELD                   DMT68680
BUFCOUNT DS    1H                  COUNT OF BYTES TO TRANSMIT           DMT68690
BUFSTAT  DS    1C                  BUFFER STATUS BYTE                   DMT68700
BUFSTART DS    CL2                 TRANSMISSION CONTROL BYTES           DMT68710
BUFBCB   DS    1C                  BLOCK CONTROL BYTE                   DMT68720
BUFFCS   DS    CL2                 FUNCTION CONTROL SEQUENCE            DMT68730
BUFDATA  DS    0F                  DATA PORTION OF TP BUFFER            DMT68740
         SPACE 1                                                        DMT68750
*        BUFFER STATUS BIT DEFINITIONS                                  DMT68760
BUFFAKE  EQU   X'01'               DUMMY BUFFER INDICATOR               DMT68770
BUFRESP  EQU   X'02'               RESPONSE ONLY IN BUFFER              DMT68780
BUFNAK   EQU   X'04'               NAK RESPONSE BEING SENT              DMT68790
BUFTEXT  EQU   X'08'               BUFFER CONTAINS TEXT INFORMATION     DMT68800
BUFUCHEK EQU   X'10'               UNIT CHECK EXPECTED                  DMT68810
BUFTONAK EQU   X'20'                   T/O ON RD CCW INDICATOR @VA08636 DMT68820
         EJECT                                                          DMT68830
TANKDSEC DSECT                                                          DMT68840
         SPACE 1                                                        DMT68850
***                     TANKDSECT  -  UNIT RECORD TANK                  DMT68860
*                                                                       DMT68870
*          0   +-----------------------------------------------+        DMT68880
*              |                    TANKCHN                    |        DMT68890
*          4   +-----------+-----------+-----------------------+        DMT68900
*              |  TANKRCB  |  TANKSRCB |      TANKCNT          |        DMT68910
*          8   +-----------+-----------+-----------------------+        DMT68920
*              |                                               |        DMT68930
*              |                   TANKDATA                    |        DMT68940
*              |                                               |        DMT68950
*              +-----------------------------------------------+        DMT68960
*                                                                       DMT68970
***                     TANKDSECT  -  UNIT RECORD TANK                  DMT68980
         SPACE 1                                                        DMT68990
TANKCHN  DC    A(0)                TANK CHAIN FIELD                     DMT69000
TANKRCB  DS    1C                  TANK RECORD CONTROL BYTE             DMT69010
TANKSRCB DS    1C                  TANK SUB-RECORD CONTROL BYTE         DMT69020
TANKCNT  DS    1H                  COUNT OF DATA BYTES IN TANK          DMT69030
TANKDATA DS    CL256               Data area in the tank       SML2NJE4 DMT69040
TANKEND  DS    0F                  FORCE NEXT TO WORD BOUNDARY          DMT69050
*
IOTABLE  DSECT                     I/O TABLE
IOSYNCH  DS    1F                  SYNCH LOCK FOR I/O OPERATIONS
DEVCUU   DS    AL2                 CUU ADDRESS
SENSREQ  DS    AL1                 NUM OF SENSE BYTES REQUESTED
DEVCODE  DS    AL1                 VM/370 DEVICE CODE
PROGADDR DS    1F                  ADDR OF STRT CHANNEL PROGRAM
SIOCOND  EQU   *                   SIO CONDITION CODE
ENDCSW   DS    2F                  ENDING CSW WITH COMPOSITE STATUS
ENDSENSE DS    AL1                 REQUESTED RETURN SENSE INFO
*
*
* Part of CP SPOOL COPY, just for assembly purposes; not used.    *XJE
*                                                                 *XJE
SPLINK   DSECT                                                    *XJE
         DS    1F                                                 *XJE
         DS    1F                                                 *XJE
         DS    1F                                                 *XJE
SPRECNUM DS    1F               NUMBER OF DATA RECORDS IN BUFFER  *XJE
*                                                                 *XJE  DMT69060
********************                                                    DMT69070
*                  *                                                    DMT69080
* CSECT EQUATES    *                                                    DMT69090
*                  *                                                    DMT69100
********************                                                    DMT69110
*                                                                       DMT69120
*                                                                       DMT69130
*-- Equates for calls to csect based routines                     *XJE  DMT69140
*                                                                 *XJE  DMT69150
*-- Routines in csect DMTXJE1:                                    *XJE  DMT69160
XJE1ISIO EQU   0                   XJE2 main entry: init complete *XJE  DMT69170
XJE1ERR1 EQU   4                   Display init error msg 901     *XJE  DMT69180
XJE1ERR2 EQU   8                   Display init error msg 906     *XJE  DMT69190
*                                                                 *XJE  DMT69200
*-- Routines in csect DMTXJE2:                                    *XJE  DMT69210
XJE2AXSG EQU   0                   Try to open reader file        *XJE  DMT69220
XJE2AXSP EQU   4                   Purge spool file               *XJE  DMT69230
XJE2VMDB EQU   8                   Generate default NJE header    *XJE  DMT69240
XJE2TOD  EQU   12                  Build NJE job hdr for out file *XJE  DMT69250
*                                                                 *XJE  DMT69260
*-- Routines in csect DMTXJE3:                                    *XJE  DMT69270
XJE3NMRC EQU   0                   Build NJE NMR hdr for cmd      *XJE  DMT69280
XJE3NMRM EQU   4                   Build NJE NMR hdr for msg      *XJE  DMT69290
XJE3JEHD EQU   8                   Generate default NJE header    *XJE  DMT69300
XJE3JEJH EQU   12                  Build NJE job hdr for out file *XJE  DMT69310
XJE3JEDS EQU   16                  Build NJE dataset hdr out file *XJE  DMT69320
XJE3JEJT EQU   20                  Build NJE job trailer out file *XJE  DMT69330
*                                                                       DMT69340
*                                                                       DMT69350
*-- Other equates (was DEVTYPES)                                  *XJE  DMT69350
TYPPRT   EQU   X'40'               PRT dev                        *XJE
TYPPUN   EQU   X'80'               PUN dev                        *XJE
TYP2700  EQU   X'40'               2700 BISYNC LINE               *XJE
TYP3210  EQU   X'00'               3210 CONSOLE                   *XJE
*                                                                       DMT69360
         EJECT                                                          DMT69370
         COPY  NJE                                             SML2NJE4 DMT69380
         EJECT                                                 SML2NJE4 DMT69390
***      COPY  SVECTORS                                           *XJE  DMT69400
         EJECT                                                          DMT69410
***      COPY  TASKE                                              *XJE  DMT69420
         EJECT                                                          DMT69430
         COPY  LINKTABL                                                 DMT69440
         EJECT                                                          DMT69450
         COPY  RTE                                                *XJE  DMT69460
         EJECT                                                 SML2NJE4 DMT69470
***      COPY  IOTABLE                                            *XJE  DMT69480
         SPACE 1                                                        DMT69490
ECBSKIP  EQU   X'40'               SKIP THIS SYNCH LOCK IN LIST         DMT69500
         EJECT                                                          DMT69510
         COPY  TAG                                                      DMT69520
         EJECT                                                          DMT69530
         COPY  RSSEQU                                                   DMT69540
         EJECT                                                          DMT69550
***      COPY  DEVTYPES                                           *XJE  DMT69560
         EJECT                                                          DMT69570
***      COPY  SPOOL                                              *XJE  DMT69580
         END   DMTXJE                                             *XJE  DMT69590
