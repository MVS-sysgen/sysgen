//*
//*        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
//*        !!                                     !!
//*        !! DO NOT RENUMBER THIS JOBSTREAM FILE !!
//*        !!                                     !!
//*        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
//*
//*
//ZP60036  JOB (SYSGEN),'J01 M47: ZP60036',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*  SUPPORT ANY MVS-SUPPORTED DASD FOR LOGREC - SYSMOD 2 OF 3
//*
//STEP1   EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
++USERMOD(ZP60036)          /* FIX LOGREC DEVICE TYPE SUPPORT */  .
++VER(Z038) FMID(FBB1221) PRE(UZ53051)
 /*
   PROBLEM DESCRIPTION:
     MVS DOES NOT SUPPORT SYS1.LOGREC ON ALL DASD DEVICE TYPES.
       THE DASD DEVICE TYPES THAT THE LOGREC INITIALIZATION
       SUPPORTS IS HARD-CODED WITHIN THE MODULE.  THIS MEANS THAT
       IN ORDER MAINTAIN A FUNCTIONING LOGREC FACILTY THE SYSTEM
       RESIDENCE VOLUME IS LIMITED TO THE ORIGINAL SET OF DASD
       DEVICE TYPES AND CANNOT BE MIGRATED TO EXPLOIT LARGER VOLUME
       GEOMETRIES AS SUPPORT FOR NEWER DEVICES IS ADDED TO MVS.

       THIS USERMOD SHIPS A VERSION OF IFCDIP00 WHICH USES THE MVS
       TRKCALC SERVICE TO OBTAIN DASD GEOMETRY DEPENDENT DETAILS
       INSTEAD OF PRE-CODED VALUES SO THAT NOW IT SUPPORTS ANY
       DASD DEVICE TYPE SUPPORTED BY THE SYSTEM.

   SPECIAL CONDITIONS:
     NONE.

   COMMENTS:
     PRYCROFT SIX P/L PUBLIC DOMAIN USERMOD FOR MVS 3.8 NUMBER 36.

     THIS IS SYSMOD NUMBER 2 OF 3 IN A PACKAGE TO GENERALIZE LOGREC
     DASD SUPPORT WRITTEN BY TOM ARMSTRONG.  ALL 3 SYSMODS SHOULD BE
     ACTIVATED IN THE SAME IPL.  THE SYSMOD DETAILS ARE:
      +---------+----------+---------+------+-----------------------+
      | USERMOD | MODULE   | FMID    | COMP | MODULE FUNCTION       |
      +---------+----------+---------+------+-----------------------+
      | ZP60035 | IFBSVC76 | EBB1102 | BCP  | LOGREC WRITER         |
      | ZP60036 | IFCDIP00 | FBB1221 | SU64 | LOGREC INITIALIZATION |
      | ZP60037 | IFCIOHND | EER1400 | EREP | EREP I/O SERVICES     |
      +---------+----------+---------+------+-----------------------+

     THE FOLLOWING MODULES AND/OR MACROS ARE AFFECTED BY THIS USERMOD:
     MODULES:
       IFCDIP00
 */.
++MOD(IFCDIP00) DISTLIB(AOSCD).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(NEW,PASS),UNIT=SYSALLDA,
//             SPACE=(CYL,3),
//             DCB=(DSORG=PS,RECFM=FB,LRECL=80,BLKSIZE=4080)
//SYSIN    DD  DUMMY
//MACLIB   EXEC PGM=IEBUPDTE,PARM=NEW
//*
//* ***************************************************************** *
//* Create a small macro library containing only BASR which is        *
//* required for successful assembly in the next step. Reference:     *
//* http://www.jaymoseley.com/hercules/compiling/spopcodes.htm        *
//* ***************************************************************** *
//*
//SYSUT2   DD  DSN=&&BASRMAC,DISP=(NEW,PASS),
//             DCB=SYS1.MACLIB,UNIT=SYSDA,SPACE=(TRK,(10,,1))
//SYSPRINT DD  SYSOUT=*
//SYSIN DD DATA,DLM=')('
./ ADD NAME=BASR
         MACRO
&NAME    BASR  &R1,&R2
&NAME    DC    0H'0',X'0D',AL.4(&R1,&R2)
         MEND
)(
/*
//*
//STEP2   EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT)'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=*.MACLIB.SYSUT2,DISP=(OLD,PASS)
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  *
IFC      TITLE 'IFCDIP00 - SYS1.LOGREC INITIALIZATION'                  00000100
*                                                                       00000200
*        NAME - IFCDIP00                                                00000300
*                                                                       00000400
*        STATUS -                                                       00000500
*        AVAILABLE SOURCE CODE WAS UPDATED BY DISASSEMBLY TO            00000600
*        REFLECT THE OWNING FMID OF FBB1221. THE LOAD MODULE            00000700
*        ASSEMBLED FROM THE UPDATED SOURCE MATCHED THE MVS 3.8J         00000800
*        DISTRIBUTION MODULE PRIOR TO THE ENHANCEMENTS AS LISTED        00000900
*        BELOW                                                          00001000
*                                                                       00001100
*        ENHANCEMENTS -                                                 00001200
*        1. REMOVAL OF THE DASD GEOMETRY DATA TABLE                     00001300
*           EXCEPT FOR A TABLE OF DEVICE UNIT NAMES USED TO             00001400
*           IDENTIFY THE LOGREC DEVICE UNIT NAME IN MSG IFC001I         00001500
*        2. ALL DASD GEOMETRY DATA IS OBTAINED DYNAMICALLY              00001600
*           FROM IECZDTAB OR CALCULATED BY THE TRKCALC SERVICE          00001700
*        3. IFCDIP00 WILL INITIALIZE A LOGREC DATASET ON                00001800
*           ANY DASD SUPPORTED BY THE EXECUTING MVS SYSTEM              00001900
*        4. ADDITIONAL IFC001I MESSAGE IDENTIFYING THE DATASET          00002000
*           NAME AND VOLSER OF THE INITIALIZED LOGREC DATASET           00002100
*        5. USE OF STANDARD SYSTEM MAPPING MACROS                       00002200
*        6. NUMEROUS CHANGES TO IMPROVE SOURCE READABILITY              00002300
*                                                                       00002400
*        FUNCTION -                                                     00002500
*        IFCDIP00 PERFORMS THE FOLLOWING FUNCTIONS -                    00002600
*                 (1) INITIALIZE THE SYS1.LOGREC DATASET                00002700
*                     BY WRITING A HEADER RECORD DESCRIBING             00002800
*                     LOCATION OF THE DATASET AND THE DEVICE            00002900
*                     GEOMETRY OF THE DASD DEVICE.                      00003000
*                     ADDITIONALLY A SECOND RECORD IS WRITTEN           00003100
*                     WHICH IS UPDATED BY SVC 76 UPON SVC 76            00003200
*                     RECEIVING AN OUTAGE REQUEST.                      00003300
*                 (2) SUPPORT FOR THE 303X PROCESSORS.                  00003400
*                     EREP PROCESSING IS NOT DEPENDENT ON THE           00003500
*                     CONTENT OR ENGINEERING CHANGE (EC) LEVEL OF       00003600
*                     THE PROCESSOR LOGOUTS TO FORMAT MACHINE           00003700
*                     CHECK AND CHANNEL CHECK RECORDS. INSTEAD,         00003800
*                     THE 7443 SERVICE RECORD FILE (SRF) DEVICE         00003900
*                     PROVIDES FORMAT AND CONTENT INFORMATION           00004000
*                     CONTAINED IN FRAMES ON DISKETTE TO FORMAT         00004100
*                     MCH AND CCH RECORDS. IN A 303X ATTACHED           00004200
*                     PROCESSOR AND MULTIPROCESSOR ENVIRONMENT,         00004300
*                     EACH PROCESSOR HAS ITS OWN SRF DEVICE.            00004400
*                     CUSTOMER ENGINEERING MAINTAINS THE SRF            00004500
*                     FRAMES (RECORDS CONTAINING TEXT AND SCAN          00004600
*                     BUFFER CODES TO FORMAT MCH AND CCH RECORDS)       00004700
*                     ON EACH SRF DEVICE.                               00004800
*                     UP TO 16 FRAMESXX DD STATEMENTS ARE SUPPORTED     00004900
*                                                                       00005000
*       NOTE -                                                          00005100
*       IFCDIP00 MUST RUN AUTHORIZED BECAUSE IT ISSUES AN ENQ ON THE    00005200
*       MAJOR NAME OF SYSZLOGR AND THE MINOR NAME OF RECORDER. THIS     00005300
*       ENQ IS TO PREVENT IFBSVC76 UPDATING THE LOGREC DATASET          00005400
*       WHILST IT IS BEING INITIALIZED BY IFCDIP00.                     00005500
*       ENQS WITH A MAJOR NAME BEGINNNING WITH SYSZ CAN ONLY BE         00005600
*       ISSUED BY PROGRAMS RUNNING AUTHORIZED.                          00005700
*                                                                       00005800
*       HEADER RECORD -                                                 00005900
*                                                                       00006000
*       *************************************************************** 00006100
*       *              *                                *     HIGH    * 00006200
*  +0   *  F F F F     *          LOW EXTENT            *   EXTENT    * 00006300
*       *              *            (CCHH)              *      (CC)   * 00006400
*       *************************************************************** 00006500
*       * HIGH EXTENT  *       *         RECORD ENTRY AREA ADDR       * 00006600
*  +8   *   (CONT.)    * SPARE *                (BBCCHHR)             * 00006700
*       *    (HH)      *       *                                      * 00006800
*       *************************************************************** 00006900
*       *  REC. ENTRY  *  REMAINING     *  TOTAL BYTES  *  ADDR OF    * 00007000
*  +16  * AREA ADDR.   *   BYTES ON     *      ON       *  LAST RECORD* 00007100
*       *    (CONT.)   *     TRACK      *    TRACK      *    WRITTEN  * 00007200
*       *************************************************************** 00007300
*       *           ADDR OF LAST RECORD          * TRACKS      * EARLY* 00007400
*  +24  *                WRITTEN (CONT.)         *    PER      * WARN.* 00007500
*       *                                        * CYLINDER    *  CNT.* 00007600
*       *************************************************************** 00007700
*       * EARLY * DEV- *     EARLY WARNING              * EARLY*  CK. * 00007800
*  +32  * WARN. *  ICE *     MESSAGE TRACK              * WARN.* BYTE * 00007900
*       * CNT.  * TYPE *     (CCHH)                     * SWT. * (FF) * 00008000
*       *************************************************************** 00008100
*                                                                       00008200
IFCDIP00 CSECT                                                          00008300
*                                                                       00008400
         SAVE  (14,12),,'IFCDIP00 ZP60036 &SYSDATE &SYSTIME'            00008500
*                                                                       00008600
         LA    R10,0(,R15)                                              00008700
         LA    R11,2048(,R10)                                           00008800
         LA    R11,2048(,R11)                                           00008900
         LA    R12,2048(,R11)                                           00009000
         LA    R12,2048(,R12)                                           00009100
*                                                                       00009200
         USING IFCDIP00,R10,R11,R12                                     00009300
*                                                                       00009400
         ST    R13,@SA00001+4          CHAIN SAVE AREAS                 00009500
         LA    R14,@SA00001                                             00009600
         ST    R14,8(,R13)                                              00009700
         LR    R13,R14                                                  00009800
*                                                                       00009900
*RETCODE = 0; /*INITIALIZE RETURN CODE TO SUCCESSFULL                */ 00010000
         SLR   R15,R15                                                  00010100
         ST    R15,RETCODE                                              00010200
         ST    R15,HIGHRETC            ZERO HIGHRETC                    00010300
*                                                                       00010400
*********************************************************************** 00010500
*                                                                       00010600
*        PROCESS JCL PARM                                               00010700
*                                                                       00010800
*********************************************************************** 00010900
*                                                                       00011000
*PARMPTR = R1; /*ESTABLISH ADDRESSABILITY TO PARM FIELD              */ 00011100
*IF PARMLEN ¼= ZERO THEN /*IF PARM FIELD EXISTS                      */ 00011200
         L     R14,0(,R1)              R14 -> PARM ADDR                 00011300
         LH    R9,0(,R14)                                               00011400
         LTR   R9,R9                   L'PARM = 0 ?                     00011500
         BE    @RF00071                YES, BRANCH, NO PARM TO PROCESS  00011600
*  DO;                                                                  00011700
*    IF PARMLEN = SIX THEN  /*IF PARAMETER PROPER LENGTH THEN*/         00011800
         C     R9,KF6                                                   00011900
         BNE   @RF00073                                                 00012000
*     DO;                                                               00012100
*      IF PARM = FRAMES THEN  /*IF PARAMETER IS FRAMES              */  00012200
         CLC   2(L'KFRAMES,R14),KFRAMES  PARM=FRAMES ?                  00012300
         BNE   @RF00075                                                 00012400
*        FRAMEYES = ON;                                                 00012500
         OI    SWITCH,FRAMEYES         SET FRAMES REQUESTED             00012600
         B     @RF00071                                                 00012700
*                                                                       00012800
*      ELSE /*PARM IS NOT FRAMES                                    */  00012900
*       DO;                                                             00013000
*        CALL MSGWTR(11);                                               00013100
@RF00075 LA    R1,MSG11                                                 00013200
         BAL   R14,MSGWTR                                               00013300
*        RETCODE = SIXTEEN;                                             00013400
         MVC   RETCODE,KF16                                             00013500
         B     @RF00071                                                 00013600
*                                                                       00013700
*       END;                                                            00013800
*     END;                                                              00013900
*    ELSE /*NOT PROPER LENGTH                                           00014000
*     DO;                                                               00014100
*      CALL MSGWTR(11); /*ISSUE IMPROPER PARM FIELD MESSAGE          */ 00014200
@RF00073 LA    R1,MSG11                                                 00014300
         BAL   R14,MSGWTR                                               00014400
*      RETCODE = SIXTEEN;                                               00014500
         MVC   RETCODE,KF16                                             00014600
*     END;                                                              00014700
*  END;                                                                 00014800
*                                                                       00014900
*********************************************************************** 00015000
*                                                                       00015100
*        SETUP FOR PROCESSING LOGREC DATASET                            00015200
*                                                                       00015300
*********************************************************************** 00015400
*                                                                       00015500
*IF RETCODE = SUCCESS THEN                                              00015600
@RF00071 ICM   R15,B'1111',RETCODE     HAS THERE BEEN A BAD PARM ?      00015700
         BNZ   @RF00087                YES, BRANCH                      00015800
*DO;                                   NO, PROCEED                      00015900
*                           /*OPEN SYS1.LOGREC                       */ 00016000
         OPEN (SERERDS,OUTPUT)                                          00016100
*                                                                       00016200
*IF (OPENOK) = OPENOK THEN            /* SUCCESSFULL OPEN ?          */ 00016300
         TM    SERERDS+DCBOFLGS-IHADCB,DCBOFOPN                         00016400
         BNO   @RF00090                 DCB FAILED TO OPEN, BRANCH      00016500
*  DO;                                                                  00016600
*                                                                       00016700
*        ENQUEUE SYS1.LOGREC                                            00016800
*        LOCK OUT ALL OTHER LOGREC (SVC 76) USERS IN THE SYSTEM         00016900
*                                                                       00017000
         ENQ   (SYSZLOGR,LOGRECA,E,8,SYSTEM)                            00017100
*                                                                       00017200
*        READ THE JFCB TO GET LOGREC DSNAME AND VOLSER                  00017300
*                                                                       00017400
         RDJFCB (SERERDS)              DATASET HAS BEEN OPENED SO OK    00017500
*                                                                       00017600
*        LOCATE LOGREC DATASET IN THE TIOT TO GET THE UCB ADDR          00017700
*        AND HENCE THE UCBTYPE                                          00017800
*        THE DATASET HAS BEEN SUCCCESSFULLY OPENED SO THE TIOT          00017900
*        ENTRY WILL BE FOUND                                            00018000
*                                                                       00018100
         L     R1,CVTPTR                                                00018200
         USING CVTMAP,R1                                                00018300
         L     R1,CVTTCBP              R1 -> TCB PTR                    00018400
         DROP  R1                                                       00018500
         L     R1,4(,R1)               R1 -> CURRENT TCB                00018600
         USING TCB,R1                                                   00018700
         ICM   R1,B'1111',TCBTIO       R1 -> TIOT                       00018800
         DROP  R1                                                       00018900
         ST    R1,TIOTPTR              SAVE FOR LATER USE               00019000
         USING TIOT1,R1                                                 00019100
         SR    R15,R15                                                  00019200
GETTIOTL CLC   TIOEDDNM,KSERERDS       DDNAME SERERDS ?                 00019300
         BE    GETTIOTF                YES, BRANCH                      00019400
         IC    R15,TIOELNGH            NO, R15 = L'CURRENT TIOT ENTRY   00019500
         AR    R1,R15                  INCR TO NEXT TIOT ENTRY          00019600
         CLI   TIOELNGH,0              L'NEXT TIOT ENTRY = 0 ?          00019700
         BNE   GETTIOTL                NO, PROCESS NEXT TIOT ENTRY      00019800
         B     @RF00090                SOMETHING HAS GONE VERY WRONG    00019900
*                                                                       00020000
GETTIOTF SR    R3,R3                                                    00020100
         ICM   R3,B'0111',TIOEFSRT     GET UCB ADDR AND ADDR IEFUCBOB   00020200
         DROP  R1                                                       00020300
         USING UCB,R3                                                   00020400
*                                                                       00020500
*        LOCATE DEVICE ENTRY IN IECZDTAB FOR THIS DASD DEVICE TYPE      00020600
*                                                                       00020700
         LA    R2,DVCTYPMK             R1 = MASK TO EXTACT UNIT TYPE    00020800
         N     R2,UCBTYP               DASD UNIT TYPE NOW IN R2         00020900
         DROP  R3                                                       00021000
         SR    R3,R3                   ZERO WORK REG                    00021100
         L     R1,CVTPTR               R1 -> CVT                        00021200
         L     R1,CVTZDTAB-CVTMAP(,R1) R1 -> IECZDTAB                   00021300
         USING DVCTI,R1                R1 -> INDEX AT START OF IECZDTAB 00021400
         IC    R3,DVCTIOFF(R2)         R3  = DEVICE OFFSET IN IECZDTAB  00021500
         DROP  R1                                                       00021600
         AR    R3,R1                   R3 -> DEVICE ENTRY IN IECZDTAB   00021700
         ST    R3,ADVCT                SAVE IECZDTAB DEVICE ENTRY       00021800
*                                                                       00021900
*    CALL OLDDIP; /*CREATE HEADER RECORD AND NULL RECORD             */ 00022000
         BAL   R14,OLDDIP                                               00022100
*    IF RETCODE = SUCCESS & /*IF SUCCESSFULLY WRITE HDR              */ 00022200
*       FRAMEYES = ON THEN /*IF USER SPECIFIES WRITE FRAMES          */ 00022300
         ICM   R15,B'1111',RETCODE                                      00022400
         BNZ   @RF00094                                                 00022500
         TM    SWITCH,FRAMEYES                                          00022600
         BNO   @RF00094                                                 00022700
*     DO;                                                               00022800
*      CALL NEWDIP; /*WRITE FRAMES TO SYS1.LOGREC                    */ 00022900
         BAL   R14,NEWDIP                                               00023000
         TM    SWITCH,ONEFRAME                                          00023100
         BNO   IFCD00F0                                                 00023200
         BAL   R14,WRTHDR                                               00023300
*      IF RETCODE = FOUR THEN                                           00023400
IFCD00F0 CLC   RETCODE,KF4                                              00023500
         BNE   @RF00094                                                 00023600
*        RETCODE = SUCCESS;                                             00023700
         XC    RETCODE,RETCODE                                          00023800
*     END;                                                              00023900
*                                       /*OTHER USERS ALLOWED LOGREC*/  00024000
@RF00094 DEQ   (SYSZLOGR,LOGRECA,8,SYSTEM)                              00024100
*    IF RETCODE > TWELVE | FRAMEYES = NO THEN                           00024200
*      DO;                                                              00024300
         L     R15,RETCODE                                              00024400
         C     R15,KF12                                                 00024500
         BH    @RT00101                                                 00024600
         TM    SWITCH,FRAMEYES                                          00024700
         BNZ   @RF00101                                                 00024800
*      END;                                                             00024900
@RT00101 EQU   *                                                        00025000
*                                       /*OTHER USERS ALLOWED LOGREC*/  00025100
@RF00101 LA    R1,SERERDS               R1 - > DCB                      00025200
         USING IHADCB,R1                                                00025300
         MVC   DCBFDAD+3(4),SAVENDCC    SET DCBFDAD TO LAST TRACK       00025400
*                                       IN DATA SET                     00025500
         MVC   DCBTRBAL,SAVTRKLN        SET TRACK BALANCE TO EMPTY      00025600
*                                       TRACK                           00025700
         DROP  R1                                                       00025800
*                                                                       00025900
         CLOSE (SERERDS,DISP)                                           00026000
*                                                                       00026100
*    IF RETCODE < SIXTEEN THEN /*IF LOGREC HAS BEEN INITIALIZED*/       00026200
         L     R15,RETCODE                                              00026300
         C     R15,KF16                                                 00026400
         BNL   @RF00087                                                 00026500
*      CALL MSGWTR(1); /*ISSUE END OF JOB MESSAGE                    */ 00026600
         LA    R1,@AL00109                                              00026700
         BAL   R14,MSGWTR                                               00026800
         B     @RF00087                                                 00026900
*                                                                       00027000
*  END;                                                                 00027100
*ELSE  /*UNSUCCESSFULL OPEN OF SYS1.LOGREC                           */ 00027200
*  DO;                                                                  00027300
*    CALL MSGWTR(2);                                                    00027400
@RF00090 LA    R1,@AL00112                                              00027500
         BAL   R14,MSGWTR                                               00027600
*    RETCODE = SIXTEEN;                                                 00027700
         MVC   RETCODE,KF16                                             00027800
*  END;                                                                 00027900
*END;                                                                   00028000
*R15 = RETCODE;                                                         00028100
@RF00087 L     R15,RETCODE             SET RETURN COED IN R15 PRIOR     00028200
         B     @EL00001                TO EXIT                          00028300
*                                                                       00028400
*********************************************************************** 00028500
*                                                                       00028600
*        BUILD AND WRITE THE HEADER RECORD TO LOGREC                    00028700
*                                                                       00028800
*********************************************************************** 00028900
*                                                                       00029000
*OLDDIP: PROC;                                                          00029100
OLDDIP   STM   R14,R12,@SA00002                                         00029200
*CALL BUILDHDR; /*FORMAT SYS1.LOGREC HEADER FROM CONTROL BLOCK INFO  */ 00029300
         BAL   R14,BUILDHDR                                             00029400
*IF RETCODE = SUCCESS THEN /*IF VALID SYSTEM RESIDENCE DEVICE        */ 00029500
         ICM   R15,B'1111',RETCODE                                      00029600
         BNZ   @RF00119                                                 00029700
*  CALL WRITELOG(40,WRITEPTR); /*WRITE HEADER RECORD TO LOGREC       */ 00029800
         LA    R1,WRITEPRM                                              00029900
         BAL   R14,WRITELOG                                             00030000
*IF RETCODE = SUCCESS THEN                                              00030100
@RF00119 ICM   R15,B'1111',RETCODE                                      00030200
         BNZ   @RF00121                                                 00030300
*                                                                       00030400
*        WRITE NULL RECORD TO SYS1.LOGREC                               00030500
*        THIS WILL BE UPDATED BY SVC 76 TO BE THE IPL TIMESTAMP         00030600
*        RECORD                                                         00030700
*                                                                       00030800
*  DO;                                                                  00030900
*    BUF240 = (BUF240 && BUF240); /*CONSTRUCT NULL RECORD OF        */  00031000
*                                 /*HEX ZEROS VIA EXCLUSIVE OR      */  00031100
         XC    BUF240(HDRRECL),BUF240                                   00031200
*    CALL WRITELOG(40,WRITEPTR); /*WRITE NULL RECORD TO SYS1.LOGREC */  00031300
         LA    R1,WRITEPRM                                              00031400
         BAL   R14,WRITELOG                                             00031500
*    IF RETCODE = SUCCESS THEN RETURN TO CALLER                         00031600
         ICM   R15,B'1111',RETCODE                                      00031700
         BZ    @ER00002                                                 00031800
*  END;                                                                 00031900
*ELSE /*ERROR WRITING HEADER RECORD                                  */ 00032000
*  CALL MSGWTR(3);                                                      00032100
         LA    R1,DATA0FD4                                              00032200
         BAL   R14,MSGWTR                                               00032300
         B     @ER00002                                                 00032400
*                                                                       00032500
*  CALL MSGWTR(3);                                                      00032600
@RF00121 LA    R1,DATA0FD4                                              00032700
         BAL   R14,MSGWTR                                               00032800
*END; /*END OF PROC OLDDIP                                           */ 00032900
@ER00002 LM    R14,R12,@SA00002                                         00033000
         BR    R14                                                      00033100
*                                                                       00033200
*********************************************************************** 00033300
*                                                                       00033400
*        NEWDIP                                                         00033500
*        SCAN THROUGH THE TIOT AND PROCESS EACH FRAMESXX DD STMT        00033600
*                                                                       00033700
*********************************************************************** 00033800
*                                                                       00033900
*NEWDIP: PROC; /*READ THE SRF TO GET FRAME TEXT, CONSTRUCT FRAME     */ 00034000
NEWDIP   STM   R14,R12,@SA00003                                         00034100
*                                                                       00034200
         TIME  DEC                                                      00034300
*                                                                       00034400
         STCM  R0,B'1111',RECTIME                                       00034500
         STCM  R1,B'1111',RECDAT                                        00034600
         OI    FRFLAG,FRFLAGY                                           00034700
         B     IFCD028E                                                 00034800
*                                                                       00034900
IFCD0202 L     R15,TIOTPTR             R15 -> TIOT DD ENTRY             00035000
         USING TIOT1,R15                                                00035100
         CLC   TIOEDDNM(L'KFRAMES),KFRAMES  FRAMESXX DDNAME IN TIOT ?   00035200
         BNE   IFCD027E                NO, BRANCH                       00035300
         LH    R14,DDCOUNT             YES, GET CNT OF FRAMES DD STMTS  00035400
         C     R14,KF16                MORE THAN 16 ?                   00035500
         BNL   IFCD0272                YES, BRANCH                      00035600
         LA    R14,1(,R14)             INCR COUNT OF FRAMES DD STMTS    00035700
         STH   R14,DDCOUNT             UPDATE COUNT                     00035800
         MVC   FRAMEDD,TIOEDDNM        GET SPECIFIC FRAMESXX DDNAME     00035900
         MVC   SRFDCB+DCBDDNAM-IHADCB(8),TIOEDDNM  MOVE INTO DCB        00036000
         MVI   RECTYPE,X'A0'                                            00036100
         MVI   FRAMTYPS,X'02'                                           00036200
         MVI   SEQCNT,X'00'                                             00036300
         MVI   RECCNT,X'00'                                             00036400
         BAL   R14,PROCSRF             PROCESS A SRF DEVICE             00036500
         L     R15,RETCODE                                              00036600
         C     R15,HIGHRETC                                             00036700
         BNH   IFCD0254                                                 00036800
         ST    R15,HIGHRETC                                             00036900
*          IF RETCODE ¼= SUCCESS THEN  /*IF SUCCESSFUL READ          */ 00037000
IFCD0254 L     R15,RETCODE                                              00037100
         C     R15,KF16                RETURN CODE GT 16 ?              00037200
         BNL   IFCD026A                EQUAL OR GREATER, BRANCH         00037300
         SLR   R15,R15                                                  00037400
         ST    R15,RETCODE             ZERO RETCODE                     00037500
         B     IFCD027E                                                 00037600
*                                                                       00037700
IFCD026A NI    FRFLAG,255-FRFLAGY      NO FRAMESXX DD                   00037800
         B     IFCD027E                                                 00037900
*                                                                       00038000
IFCD0272 LA    R1,DATA0FD8                                              00038100
         BAL   R14,MSGWTR                                               00038200
         NI    FRFLAG,255-FRFLAGY      NO FRAMESXX DD                   00038300
IFCD027E L     R15,TIOTPTR             GET CURRENT TIOTPTR              00038400
         SLR   R14,R14                                                  00038500
         IC    R14,TIOELNGH            ADD L'CURRENT ENTRY              00038600
         AR    R15,R14                                                  00038700
         CLI   TIOELNGH,0              L'NEXT TIOT ENTRY = 0 ?          00038800
         BE    IFCD02A2                YES, BRANCH, END OF TIOT         00038900
         ST    R15,TIOTPTR             UPDATE TIOTPTR                   00039000
*                                                                       00039100
*        INITIAL ENTRY INTO ROUTINE                                     00039200
*                                                                       00039300
IFCD028E L     R15,TIOTPTR             R15 -> CURRENT TIOT ENTRY        00039400
         CLI   TIOELNGH,0              L'NEXT TIOT ENTRY = 0 ?          00039500
         BE    IFCD02A2                YES, BRANCH                      00039600
         TM    FRFLAG,FRFLAGY          FRAMESXX DD ?                    00039700
         BO    IFCD0202                RE-ENTER LOOP                    00039800
         DROP  R15                                                      00039900
IFCD02A2 CLC   HIGHRETC,KF12                                            00040000
         BNE   IFCD02BE                                                 00040100
         TM    SWITCH,ONEFRAME                                          00040200
         BNO   IFCD02BE                                                 00040300
         MVC   RETCODE,KF8                                              00040400
         B     IFCD02C6                                                 00040500
*                                                                       00040600
IFCD02BE L     R15,HIGHRETC                                             00040700
         ST    R15,RETCODE                                              00040800
IFCD02C6 LH    R15,DDCOUNT             ANY FRAMESXX DD STMTS ?          00040900
         LTR   R15,R15                                                  00041000
         BNZ   IFCD02D8                YES, BRANCH                      00041100
         LA    R1,DATA0FDC             MO, GENERATE ERROR MSG           00041200
         BAL   R14,MSGWTR                                               00041300
IFCD02D8 LM    R14,R12,@SA00003                                         00041400
         BR    R14                     RETURN                           00041500
*                                                                       00041600
*********************************************************************** 00041700
*                                                                       00041800
*        PROCESS SRF                                                    00041900
*                                                                       00042000
*********************************************************************** 00042100
*                                                                       00042200
*        FOR A MERIDIAN LIKE CPU (303X) WITH AN ACCESSIBLE SRF          00042300
*                                                                       00042400
PROCSRF  STM   R14,R12,@SA011C8                                         00042500
*            CALL OPENSRF;         /*OPEN SYSTEM REFERENCE FILE      */ 00042600
         BAL   R14,OPENSRF                                              00042700
*            IF RETCODE = SUCCESS THEN                                  00042800
         ICM   R15,B'1111',RETCODE                                      00042900
         BNZ   IFCD0364                                                 00043000
*              DO;                                                      00043100
*                CALL GETSER;       /*RETRIEVE CPU SERIAL NUMBER     */ 00043200
         BAL   R14,GETSER                                               00043300
*            IF RETCODE = SUCCESS THEN                                  00043400
         ICM   R15,B'1111',RETCODE                                      00043500
         BNZ   IFCD036C                                                 00043600
*                CALL BUILDFRH; /*BUILD CONSTANT PART OF FRAME HEADER*/ 00043700
         BAL   R14,BUILDFRH                                             00043800
*                CALL VERBPROC;            /* PERFORM VERBAGE        */ 00043900
         BAL   R14,VERBPROC                                             00044000
*                CALL READSRF;  /*READ FRAME TEXT ACROSS SYSTEM      */ 00044100
*                               /*REFERENCE FILE INTERFACE SET       */ 00044200
         BAL   R14,READSRF                                              00044300
*                               /*RETURN CODE IF EOF OR FAILURE      */ 00044400
*                IF RETCODE ¼= SUCCESS THEN /*IF NOT RETRIEVE FRAME*/   00044500
         ICM   R15,B'1111',RETCODE                                      00044600
         BZ    IFCD033A                                                 00044700
*                  DO;                                                  00044800
*                    IF RETCODE = FOUR THEN /*IF EOF ON 1ST READ     */ 00044900
         C     R15,KF4                                                  00045000
         BNE   IFCD0328                                                 00045100
*                      CALL MSGWTR(10);                                 00045200
         LA    R1,@AL00193                                              00045300
         BAL   R14,MSGWTR                                               00045400
         B     IFCD0330                                                 00045500
*                    ELSE  /*LEGITIMATE READ ERROR                   */ 00045600
*                      CALL MSGWTR(7);                                  00045700
IFCD0328 LA    R1,@AL00282                                              00045800
         BAL   R14,MSGWTR                                               00045900
*                    RETCODE = TWELVE; /*INDICATE NO FRAMES */          00046000
IFCD0330 MVC   RETCODE,KF12                                             00046100
         B     IFCD035C                                                 00046200
*                                                                       00046300
*                  END;                                                 00046400
*                ELSE /*SUCCESSFUL READ OF A FRAME                      00046500
*                  DO;                                                  00046600
*                    READPTR = (READPTR && WRITEPTR);/*SHIFT READ,WRTE* 00046700
IFCD033A L     R15,WRITEPTR                                             00046800
         L     R14,READPTR                                              00046900
         XR    R14,R15                                                  00047000
         ST    R14,READPTR                                              00047100
*                    WRITEPTR = (WRITEPTR && READPTR);/*BUFFERS VIA 3*/ 00047200
*                    READPTR = (READPTR && WRITEPTR); /*EXCLUSIVE ORS*/ 00047300
         XR    R15,R14                                                  00047400
         ST    R15,WRITEPTR                                             00047500
         XR    R14,R15                                                  00047600
         ST    R14,READPTR                                              00047700
*                    RECCNT = 1; /*FIRST FRAME OF THE SET            */ 00047800
         MVI   RECCNT,X'01'                                             00047900
*                    SEQCNT = 1; /*FIRST FRAME FOR 50 FRAME LIMIT CK*/  00048000
         MVI   SEQCNT,X'01'                                             00048100
IFCD035C BAL   R14,PROCREC                                              00048200
         B     IFCD036C                                                 00048300
*                                                                       00048400
IFCD0364 LA    R1,@AL00151                                              00048500
         BAL   R14,MSGWTR                                               00048600
IFCD036C LM    R14,R12,@SA011C8                                         00048700
         BR    R14                                                      00048800
*                                                                       00048900
*                  END;                                                 00049000
*              END;                                                     00049100
*                                                                       00049200
*********************************************************************** 00049300
*                                                                       00049400
*        PROCESS RECORD READ FROM SRF                                   00049500
*                                                                       00049600
*********************************************************************** 00049700
*                                                                       00049800
PROCREC  STM   R14,R12,@SA012F4                                         00049900
         B     IFCD0488                                                 00050000
*                                                                       00050100
IFCD037A BAL   R14,READSRF                                              00050200
         ICM   R15,B'1111',RETCODE     GET RETURN CODE                  00050300
         BZ    IFCD03CE                ZERO, BRANCH                     00050400
*                                      NON ZERO RETURN CODE             00050500
*              RECNLST = OFF;/*INDICATE RECORD IN BUFFER IS LAST OF ST* 00050600
         NI    RECNLST,B'01111111'                                      00050700
*              IF RETCODE = FOUR & /*IF END OF FILE                  */ 00050800
*                 FRAMTYPS = MCF THEN /*HAVE BEEN READING MCH FRMS*/    00050900
         C     R15,KF4                                                  00051000
         BNE   IFCD042C                                                 00051100
         CLI   FRAMTYPS,X'02'                                           00051200
         BNE   IFCD042C                                                 00051300
*                  DO;                                                  00051400
*                    FRAMTYPS = CCF; /*SET UP TO READ CCF FRAMES     */ 00051500
         MVI   FRAMTYPS,X'01'                                           00051600
*                    RETCODE = SUCCESS; /*IND SUCCESS, NOT COMPLETE  */ 00051700
         XC    RETCODE,RETCODE                                          00051800
*                    SEQCNT = ZERO; /*RESET PHYSICAL SEQUENCE NUMBER */ 00051900
         MVI   SEQCNT,X'00'                                             00052000
*                                   /*FOR NEXT SET OF FRAMES         */ 00052100
*                    CALL VERBPROC;        /* PERFORM VERBAGE        */ 00052200
         BAL   R14,VERBPROC                                             00052300
*                    CALL READSRF; /*READ SRF TO RESET SEQUENCING    */ 00052400
         BAL   R14,READSRF                                              00052500
*                    IF RETCODE = FOUR THEN /*IF EOF, NO CCF FRAMES  */ 00052600
         CLC   RETCODE,KF4                                              00052700
         BNE   IFCD042C                                                 00052800
*                      DO;   /*RETCODE ALREADY SET TO 8 IF HARD ERROR*/ 00052900
*                        CALL MSGWTR(10); /*MISSING FRAME SET MESSAGE*/ 00053000
         LA    R1,@AL00193                                              00053100
         BAL   R14,MSGWTR                                               00053200
*                        RETCODE = 12   ; /*INDICATE MISSING FRAMES  */ 00053300
         MVC   RETCODE,KF12                                             00053400
         B     IFCD042C                                                 00053500
*                                                                       00053600
*                  END;                                                 00053700
*            END;                                                       00053800
*          ELSE  /*IF SUCCESSFUL READ                                */ 00053900
*            IF RECCNT = MAXFRM THEN /*IF FRAME JUST READ IS ONE TOO */ 00054000
*              DO;                   /*MANY FOR EREP1 THEN           */ 00054100
IFCD03CE CLI   RECCNT,50               READ 50 RECORDS ?                00054200
         BNE   IFCD042C                NO, BRANCH                       00054300
*                CALL MSGWTR(8); /*MAXIMUM FRAME NUMBER EXCEEDED MESS*/ 00054400
         LA    R1,@AL00180                                              00054500
         BAL   R14,MSGWTR                                               00054600
*                RETCODE = 12   ; /*INDICATE LOST FRAMES             */ 00054700
         MVC   RETCODE,KF12                                             00054800
*                RECNLST = OFF; /*SET LAST FRAME SWITCH ON.          */ 00054900
         NI    RECNLST,B'01111111'                                      00055000
*                IF FRAMTYPS = MCF THEN /*IF CHANNEL FRAMES LEFT     */ 00055100
         CLI   FRAMTYPS,X'02'                                           00055200
         BNE   IFCD0426                                                 00055300
*                  DO;                                                  00055400
*                    RETCODE = ZERO; /*CONTINUE IN LOOP              */ 00055500
         XC    RETCODE,RETCODE                                          00055600
*                    FRAMLOST = ON; /*INDICATE FRAMES LOST WITHOUT   */ 00055700
*                     /*USING RETURN CODE AND EXITING LOOP           */ 00055800
         OI    SWITCH,FRAMLOST                                          00055900
*                    SEQCNT = ZERO; /*RESET FOR CHANNEL FRAMES       */ 00056000
         MVI   SEQCNT,X'00'                                             00056100
*                    FRAMTYPS = CCF; /*PREPARE TO READ CHANNEL FRMS  */ 00056200
         MVI   FRAMTYPS,X'01'                                           00056300
*                    CALL VERBPROC;        /* PERFORM VERBAGE        */ 00056400
         BAL   R14,VERBPROC                                             00056500
*                    CALL READSRF; /*READ FRAME OVERLAY TOO MANY FRAME* 00056600
         BAL   R14,READSRF                                              00056700
*                    IF RETCODE = FOUR THEN /*IF END OF FILE ON 1ST  */ 00056800
         CLC   RETCODE,KF4                                              00056900
         BNE   IFCD042C                                                 00057000
*                      DO;                /*CCH FRAME READ THEN*/       00057100
*                        CALL MSGWTR(10); /*ISSUE MISSING SET MESSAGE*/ 00057200
         LA    R1,@AL00193                                              00057300
         BAL   R14,MSGWTR                                               00057400
*                        RETCODE = 12;  /*IND MISSING FRAMES AND     */ 00057500
*                                       /*EXIT THE LOOP              */ 00057600
         MVC   RETCODE,KF12                                             00057700
         B     IFCD042C                                                 00057800
*                                                                       00057900
*                      END;                                             00058000
*                  END;                                                 00058100
*                ELSE /*NO MORE MACHINE FRAMES MUST BE READ          */ 00058200
*                  RETCODE = 12   ; /*DONT ALLOW FRAME JUST READ     */ 00058300
IFCD0426 MVC   RETCODE,KF12                                             00058400
*              END;               /*OR ANY FURTHER FRAMES TO BE READ */ 00058500
*          RECORD = RECBUILD;     /*MOVE BUILT HEADER TO BUFFER      */ 00058600
IFCD042C L     R1,WRITEPTR                                              00058700
         MVC   0(24,R1),RECBUILD                                        00058800
*          RECCNT = SEQCNT + 1; /*UP INDEX FOR NEXT RECORD           */ 00058900
         SR    R1,R1                                                    00059000
         IC    R1,SEQCNT                                                00059100
         LA    R1,1(,R1)                                                00059200
         STC   R1,RECCNT                                                00059300
*          SEQCNT = SEQCNT + 1; /*UP RUNNING SEQUENCE NUMBER OF RECRD*/ 00059400
         STC   R1,SEQCNT                                                00059500
*          RECNLST = ON;   /*RESET LAST RECORD SWITCH FOR NEXT RECORD*/ 00059600
         OI    RECNLST,B'10000000'                                      00059700
*          IF FRAMTYPS = CCF THEN /*IF NOW READING CHANNEL FRAMES    */ 00059800
         CLI   FRAMTYPS,X'01'                                           00059900
         BNE   IFCD0458                                                 00060000
*            RECTYPE = 'B0'X;     /*THEN SET RECORD TYPE TO CCF FOR  */ 00060100
         MVI   RECTYPE,X'B0'                                            00060200
*                                 /*FRAME WRITTEN NEXT LOOP ITERATION*/ 00060300
*          CALL WRITELOG(1944,WRITEPTR); /*WRITE PREVIOUS FRAME TO LG*/ 00060400
IFCD0458 LA    R1,@AL00205                                              00060500
         BAL   R14,WRITELOG                                             00060600
*                               /*NOTE ITS LOCATION AND CHECK FOR    */ 00060700
*                               /*OVERFLOW OF THE EXTENT             */ 00060800
*                               /*COUNT SUCCESSFUL WRITES OF FRAMES  */ 00060900
*          IF RETCODE = SUCCESS THEN                                    00061000
         ICM   R15,B'1111',RETCODE                                      00061100
         BNZ   IFCD046E                                                 00061200
*            ONEFRAME = ON;                                             00061300
         OI    SWITCH,ONEFRAME                                          00061400
*          READPTR = (READPTR && WRITEPTR); /*SWITCH READ,WRITE      */ 00061500
IFCD046E L     R15,WRITEPTR                                             00061600
         L     R14,READPTR                                              00061700
         XR    R14,R15                                                  00061800
         ST    R14,READPTR                                              00061900
*          WRITEPTR = (WRITEPTR && READPTR); /*BUFFERS VIA THREE     */ 00062000
         XR    R15,R14                                                  00062100
         ST    R15,WRITEPTR                                             00062200
*          READPTR = (READPTR && WRITEPTR); /*EXCLUSIVE OR           */ 00062300
         XR    R14,R15                                                  00062400
         ST    R14,READPTR                                              00062500
*         END; /*END OF READ, WRITE LOOP                             */ 00062600
IFCD0488 ICM   R15,B'1111',RETCODE                                      00062700
         BZ    IFCD037A                                                 00062800
*  CALL CLOSESRF; /*DISABLE AND CLOSE SRF                            */ 00062900
         BAL   R14,CLOSESRF                                             00063000
*  IF FRAMLOST = ON THEN /*IF FRAMES LOST BUT RETCODE NOT SET        */ 00063100
         TM    SWITCH,FRAMLOST                                          00063200
         BNO   IFCD04A4                                                 00063300
*    RETCODE = 12   ; /*USE RETCODE TO PASS RETURN CODE TO USER      */ 00063400
         MVC   RETCODE,KF12                                             00063500
IFCD04A4 LM    R14,R12,@SA012F4                                         00063600
         BR    R14                                                      00063700
*                                                                       00063800
*********************************************************************** 00063900
*                                                                       00064000
*        REWRITE HEADER RECORD                                          00064100
*                                                                       00064200
*********************************************************************** 00064300
*                                                                       00064400
WRTHDR   STM   R14,R12,@SA00004                                         00064500
         L     R6,SERERDS+DCBDEBAD-IHADCB  R6 ->SERERDS DEB             00064600
         USING DEBBASIC,R6                                              00064700
         LA    R6,DEBBASND                                              00064800
         USING DEBDASD,R6              R6 -> DEB DASD EXTENTION         00064900
         MVC   SERERDS+DCBFDAD+3-IHADCB(4),DEBENDCC   SET HIGH EXTENT   00065000
*                                                     FOR EOF           00065100
         DROP  R6                                                       00065200
*                                                                       00065300
         CLOSE (SERERDS,REREAD)    CLOSE LOGREC FOR NORMAL WRITING      00065400
*                                                                       00065500
         OPEN  (SERERDS,UPDAT)   OPEN LOGREC TO REWRITE THE HEADER      00065600
*                                                                       00065700
         READ  LISTDECB,SF,SERERDS,HDRREC,HDRRECL,,,,MF=E               00065800
*                                                                       00065900
         CHECK LISTDECB                                                 00066000
*                                                                       00066100
*     CALL REDOHDR;        /*REWRITE LOGREC HEADER TO REFLECT FRAMES*/  00066200
         BAL   R14,REDOHDR                                              00066300
*                                                                       00066400
         WRITE LISTDECB,SF,SERERDS,HDRREC,HDRRECL,,,,MF=E               00066500
*                                                                       00066600
         CHECK LISTDECB                                                 00066700
*    END;                                                               00066800
*END;                                                                   00066900
         LM    R14,R12,@SA00004                                         00067000
         BR    R14                                                      00067100
*                                                                       00067200
*********************************************************************** 00067300
*                                                                       00067400
*        FORMAT SYS1.LOGREC HEADER RECORD FROM INFO IN                  00067500
*        SYSTEM CONTROL BLOCKS                                          00067600
*                                                                       00067700
*********************************************************************** 00067800
*                                                                       00067900
*BUILDHDR: PROC;                                                        00068000
BUILDHDR STM   R14,R12,@SA0000X                                         00068100
*  CALL GETDEV; /*FORMAT HEADER RECORD FIELDS FROM DEVICE TABLE      */ 00068200
*               /*AND THE DCB,DEB                                    */ 00068300
         BAL   R14,GETDEV                                               00068400
         MVC   BUF240(HDRRECL),HDRREC   MOVE HEADER TO INITIAL WRITE BF 00068500
*END;                                                                   00068600
@ER00004 LM    R14,R12,@SA0000X                                         00068700
         BR    R14                                                      00068800
*                                                                       00068900
*********************************************************************** 00069000
*                                                                       00069100
*        WRITELOG                                                       00069200
*                                                                       00069300
*        WRITE A RECORD TO SYS1.LOGREC USING BSAM                       00069400
*        RETRIEVE THE ADDR OF THE RECORD USING NOTE CHECK TO SEE        00069500
*        IF SYS1.LOGREC EXTENT HAS OVERFLOWED                           00069600
*        SET RETURN CODE IF WRITE ERROR OR OVERFLOW EXTENT              00069700
*                                                                       00069800
*********************************************************************** 00069900
*                                                                       00070000
*        ON ENTRY -                                                     00070100
*        R1 -> A(L'RECORD)                                              00070200
*              A(RECORD TO BE WRITTEN)                                  00070300
*                                                                       00070400
*WRITELOG: PROC;                                                        00070500
WRITELOG STM   R14,R12,@SA00005                                         00070600
         L     R2,4(,R1)                R2 -> RECORD ADDR               00070700
         L     R2,0(,R2)                R2 -> RECORD                    00070800
*R3 = INPARM; /*LENGTH OF RECORD TO BE WRITTEN                       */ 00070900
         L     R3,0(,R1)                R3 -> L'RECORD ADDR             00071000
         L     R3,0(,R3)                R3 = L'RECORD                   00071100
*                                                                       00071200
DWRITE   WRITE SERDECB,SF,SERERDS,(2),(3)                               00071300
*                                                                       00071400
         CHECK SERDECB                                                  00071500
*                                                                       00071600
         NOTE  SERERDS                  RETRIEVE TTR OF RECORD WRITTEN  00071700
*                                                                       00071800
*TTRSAVE = R1;     /*STORE RELATIVE DIRECT ACCESS LOCATION FROM NOTE*/  00071900
         ST    R1,TTRSAVE                                               00072000
*IF FRAMEYES = ON &   /*IF FRAMES, CHECK TO SEE IF ENOUGH ROOM ON   */  00072100
*   TTRSAVE = MAXTTR THEN /*ON LOGREC FOR NEXT WRITE. ASSUME AT     */  00072200
         TM    SWITCH,FRAMEYES                                          00072300
         BNO   @RF00240                                                 00072400
         L     R15,TTRSAVE                                              00072500
         C     R15,MAXTTR                                               00072600
         BNE   @RF00240                                                 00072700
*                         /*LEAST ONE TRACK FOR HEADER AND TIME STMP */ 00072800
*  DO;                                                                  00072900
*    CALL MSGWTR(4); /*NOT ENOUGH ROOM FOR FRAMES                    */ 00073000
         LA    R1,@AL00242                                              00073100
         BAL   R14,MSGWTR                                               00073200
*    RETCODE = SIXTEEN; /*NO ROOM FOR ERROR RECORDS SO BETTER ABORT  */ 00073300
         MVC   RETCODE,KF16                                             00073400
         B     ENDOPROC                                                 00073500
*                                                                       00073600
*  END;                                                                 00073700
*ELSE IF FRAMEYES = ON THEN /*IF SUCCESSFUL WRITE OF A FRAME THEN    */ 00073800
@RF00240 TM    SWITCH,FRAMEYES                                          00073900
         BNO   ENDOPROC                                                 00074000
*  ONEFRAME = ON; /*AT LEAST ONE FRAME ON LOGREC SUCCESSFULLY        */ 00074100
         OI    SWITCH,ONEFRAME                                          00074200
*GOTO ENDOPROC; /*BOUNCE AROUND THE NON=SYNCHRONOUS ERROR EXIT*/        00074300
         B     ENDOPROC                                                 00074400
*                                                                       00074500
*LOGERR:; /*NON-STRUCTURED ASYNCHRONOUS ERROR EXIT                   */ 00074600
LOGERR   ST    R14,LOGSAVE                                              00074700
*                                                                       00074800
         SYNADAF ACSMETH=BSAM                                           00074900
*                                                                       00075000
*IF TTRSAVE < THIRD THEN /*IF WRITING HEADER                         */ 00075100
         L     R15,TTRSAVE                                              00075200
         C     R15,THIRD                                                00075300
         BNL   @RF00249                                                 00075400
*  DO;                                                                  00075500
*    CALL MSGWTR(3);                                                    00075600
         LA    R1,DATA0FD4                                              00075700
         BAL   R14,MSGWTR                                               00075800
*    RETCODE = 16;                                                      00075900
         MVC   RETCODE,KF16                                             00076000
         B     IFCD064E                                                 00076100
*                                                                       00076200
*  END;                                                                 00076300
*ELSE /*ATTEMPTING TO WRITE FRAME                                    */ 00076400
*  DO;                                                                  00076500
*    CALL MSGWTR(5);                                                    00076600
@RF00249 LA    R1,@AL00255                                              00076700
         BAL   R14,MSGWTR                                               00076800
*    RETCODE = 8;                                                       00076900
         MVC   RETCODE,KF16                                             00077000
*                                                                       00077100
IFCD064E SYNADRLS                                                       00077200
*                                                                       00077300
         L     R14,LOGSAVE                                              00077400
         BR    R14                                                      00077500
*  END;                                                                 00077600
*ENDOPROC:;                                                             00077700
*END; /*END OF WRITE TO LOGREC PROC                                     00077800
ENDOPROC LM    R14,12,@SA00005                                          00077900
         BR    R14                                                      00078000
*                                                                       00078100
*********************************************************************** 00078200
*                                                                       00078300
*        READ SRF, IDENTIFY END OF FILE AND ERROR CONDITIONS            00078400
*                                                                       00078500
*********************************************************************** 00078600
*                                                                       00078700
*READSRF: PROC;                                                         00078800
READSRF  STM   R14,R12,@SA00006                                         00078900
*IF RETCODE = SUCCESS THEN DO;                                          00079000
         SLR   R15,R15                                                  00079100
         C     R15,RETCODE             RETCODE = ZERO ?                 00079200
         BNE   @ER00006                NO, BRANCH                       00079300
* IOBSTART = ADDR(RDVERB);     /*SET ADDR OF FUNCTION SELECT CCW     */ 00079400
         LA    R14,RDVERB                                               00079500
         ST    R14,IOBSTART                                             00079600
* SRFECB = ZERO;               /*CLEAR THE EVENT CONTROL BLOCK       */ 00079700
         ST    R15,SRFECB                                               00079800
* RDADR  = READPTR + 24; /*  ADDR OF READ BUFF INTO CHANNEL PROGRAM  */ 00079900
         L     R1,READPTR                                               00080000
         LA    R1,24(,R1)                                               00080100
         STCM  R1,B'0111',RDVERB+1                                      00080200
* DO UNTIL ECB ¼= INTERCPT;/*DO UNTIL REQUEST NOT INTERCEPTED-44     */ 00080300
*                                                                       00080400
@DL00266 EXCP  SRFIOB                                                   00080500
*                                                                       00080600
         WAIT  ECB=SRFECB              WAIT UNTIL FRAME HAS BEEN READ   00080700
* END;                                                                  00080800
@DE00266 CLI   SRFECB,ECBINCPT                                          00080900
         BE    @DL00266                                                 00081000
* IF ECB ¼= OKAY THEN  /*EITHER ERROR OR END OF FILE                 */ 00081100
         CLI   SRFECB,ECBNORM                                           00081200
         BE    @ER00006                                                 00081300
*   DO;                                                                 00081400
*     IF ECB  = EOFMAYBE THEN /*IF ECB NON HARD ERROR                */ 00081500
         CLI   SRFECB,ECBPERR                                           00081600
         BNE   @RF00271                                                 00081700
*       DO;                                                             00081800
*         IF IOBUSTAT = ON & /*IF CHANNEL END                        */ 00081900
*            DEVEND  = ON & /*IF DEVICE END                          */ 00082000
*            UNITEXCP = ON & /*IF UNIT EXCEPTION                     */ 00082100
*            IOBUSTAT = OFF THEN /*IF NOT A UNIT CHECK               */ 00082200
         TM    IOBUSTAT,IOBUSB4+IOBUSB5+IOBUSB7                         00082300
         BNO   @RF00273                                                 00082400
         TM    IOBUSTAT,IOBUSB6                                         00082500
         BNZ   @RF00273                                                 00082600
*            RETCODE = FOUR; /*LEGITIMATE END OF FILE                */ 00082700
         MVC   RETCODE,KF4                                              00082800
         B     @ER00006                                                 00082900
*                                                                       00083000
*         ELSE /*ILLEGITIMATE                                        */ 00083100
*           DO;                                                         00083200
*             RETCODE = EIGHT; /*UNSUCCESSFUL FRAME READ             */ 00083300
@RF00273 MVC   RETCODE,KF12                                             00083400
*             CALL MSGWTR(7);                                           00083500
         LA    R1,@AL00282                                              00083600
         BAL   R14,MSGWTR                                               00083700
         B     @ER00006                                                 00083800
*                                                                       00083900
*           END;                                                        00084000
*       END;                                                            00084100
*     ELSE /*HARD ERROR BY DEFAULT                                   */ 00084200
*       DO;                                                             00084300
*         RETCODE = EIGHT;                                              00084400
@RF00271 MVC   RETCODE,KF12                                             00084500
*         CALL MSGWTR(7);                                               00084600
         LA    R1,@AL00282                                              00084700
         BAL   R14,MSGWTR                                               00084800
*       END;                                                            00084900
*   END;                                                                00085000
*END;                                      /* END OF READ            */ 00085100
*END; /*END OF PROC READSRF                                          */ 00085200
@ER00006 LM    R14,R12,@SA00006                                         00085300
         BR    R14                                                      00085400
*                                                                       00085500
*********************************************************************** 00085600
*                                                                       00085700
*        PERFORM VERBAGE CCW AND TEST FOR ERROR                         00085800
*                                                                       00085900
*********************************************************************** 00086000
*                                                                       00086100
*VERBPROC:  PROC;                                                       00086200
VERBPROC STM   R14,R12,@SA00007                                         00086300
*IF FRAMTYPS = CCF THEN                                                 00086400
         CLI   FRAMTYPS,X'01'                                           00086500
         BNE   @RF00288                                                 00086600
*  IOBFLAG1 = IOBUNREL                                                  00086700
         MVI   IOBFLAG1,IOBUNREL                                        00086800
*IOBSTART = ADDR(VERBAGE);         /* SET ADDR OF VERBAGE CCW        */ 00086900
@RF00288 LA    R15,VERBAGE                                              00087000
         ST    R15,IOBSTART                                             00087100
*SRFECB = ZERO;                    /* CLEAR ECB                      */ 00087200
         SLR   R15,R15                                                  00087300
         ST    R15,SRFECB                                               00087400
*DO UNTIL ECB ¼= INTERCPT;         /* LOOP UNTIL REQUEST NOT INTRCPTD*/ 00087500
*                                                                       00087600
@DL00292 EXCP  SRFIOB              ISSUE EXCP                           00087700
*                                                                       00087800
         WAIT  ECB=SRFECB          WAIT UNTIL ECB IS POSTED             00087900
*END;                                                                   00088000
@DE00292 CLI   SRFECB,ECBINCPT                                          00088100
         BE    @DL00292                                                 00088200
*IF ECB ¼= OKAY THEN               /* IF FRAME READ FAILED           */ 00088300
         CLI   SRFECB,ECBNORM                                           00088400
         BE    @ER00007                                                 00088500
*  DO;                                                                  00088600
*    CALL MSGWTR(12);                                                   00088700
         LA    R1,@AL00297                                              00088800
         BAL   R14,MSGWTR                                               00088900
*    RETCODE = EIGHT;                                                   00089000
         MVC   RETCODE,KF12                                             00089100
*  END;                                                                 00089200
*END;                              /* END OF VERBPROC PROC           */ 00089300
@ER00007 LM    R14,R12,@SA00007                                         00089400
         BR    R14                                                      00089500
*                                                                       00089600
*********************************************************************** 00089700
*                                                                       00089800
*        WRITE ERROR MESSAGES AND END OF JOB TEXT VIA WTO               00089900
*                                                                       00090000
*********************************************************************** 00090100
*                                                                       00090200
*MSGWTR: PROC;                                                          00090300
MSGWTR   STM   R14,R12,@SA00008                                         00090400
         MVC   @PC00008(4),0(R1)                                        00090500
*IF MSGNO = 1 THEN                                                      00090600
         L     R15,@PC00008                                             00090700
         CLC   0(4,R15),KF1                                             00090800
         BNE   @RF00303                                                 00090900
*  DO;                                                                  00091000
*    CALL BUILDTXT; /*MODIFY WTO MESSAGE TEXT                        */ 00091100
         BAL   R14,BUILDTXT                                             00091200
* MSG ALIGNMENT=         *+19   *+26 *+31       *+42       *+53         00091300
         CNOP  0,4                      ALIGN MODIFIED TEXT             00091400
IFC001I  WTO   'IFC001I  D=XXXX N=0Y F=CCCCHHHH L=CCCCHHHH S=CCCCHHHH02X00091500
                DIP COMPLETE',ROUTCDE=(1),DESC=(6)                      00091600
*                                                                       00091700
*        ISSUE WTO TO IDENTIFY LOGREC DATASET NAME AND VOLSER           00091800
*                                                                       00091900
         MVI   IFC001I+15,C' '         BLANK OUT TEXT                   00092000
         MVC   IFC001I+16(60),IFC001I+15                                00092100
         MVC   IFC001I+17(4),=C'DSN='   MOVE IN DATASET NAME            00092200
         MVC   IFC001I+21(L'JFCBDSNM),JFCBDSNM   MOVE IN DATASET NAME   00092300
         LA    R14,IFC001I+21                                           00092400
BLKLOOP  CLI   0(R14),C' '             LOOK FOR END OF DATASET NAME     00092500
         BNH   LOOPEND                                                  00092600
         LA    R14,1(,R14)              INCR LOOP PTR                   00092700
         B     BLKLOOP                                                  00092800
*                                                                       00092900
LOOPEND  MVC   1(4,R14),=C'VOL='                                        00093000
         MVC   5(6,R14),JFCBVOLS                                        00093100
         LA    R1,IFC001I+4                                             00093200
*                                                                       00093300
         WTO   MF=(E,(1))               ISSUE WTO                       00093400
*                                                                       00093500
         B     @RC00303                                                 00093600
*                                                                       00093700
*  END; /*END OF GENERATING MESSAGE 1                                */ 00093800
*ELSE /*NOT MESSAGE ONE                                              */ 00093900
*  DO;                                                                  00094000
*    IF MSGNO = 2 THEN                                                  00094100
@RF00303 L     R15,@PC00008                                             00094200
         CLC   0(4,R15),KF2                                             00094300
         BNE   @RF00309                                                 00094400
*      DO;                                                              00094500
*                                                                       00094600
         WTO   'IFC002I SYS1.LOGREC CANNOT BE OPENED',ROUTCDE=(1),     X00094700
               DESC=(6)                                                 00094800
*                                                                       00094900
         B     @RC00303                                                 00095000
*                                                                       00095100
*      END;                                                             00095200
*    ELSE /*NOT 1 NOR 2                                              */ 00095300
*      DO;                                                              00095400
*        IF MSGNO = 3 THEN                                              00095500
@RF00309 L     R15,@PC00008                                             00095600
         CLC   0(4,R15),KF3                                             00095700
         BNE   @RF00314                                                 00095800
*          DO;                                                          00095900
*            RETCODE = SIXTEEN; /*PREVENT FURTHER PROCESSING         */ 00096000
         MVC   RETCODE,KF16                                             00096100
*                                                                       00096200
         WTO   'IFC003I SYS1.LOGREC HEADER WRITE ERROR',ROUTCDE=(1),   X00096300
               DESC=(6)                                                 00096400
*                                                                       00096500
         B     @RC00303                                                 00096600
*                                                                       00096700
*          END;                                                         00096800
*        ELSE /*NOT 1,2,3                                            */ 00096900
*          DO;                                                          00097000
*            IF MSGNO = 5 THEN                                          00097100
@RF00314 L     R15,@PC00008                                             00097200
         CLC   0(4,R15),KF5                                             00097300
         BNE   @RF00320                                                 00097400
         MVC   IFC005I+49(8),FRAMEDD                                    00097500
*              DO;                                                      00097600
*                                                                       00097700
IFC005I  WTO   'IFC005I SYS1.LOGREC FRAME WRITE ERROR,DD=FRAMESXX',    X00097800
               ROUTCDE=(1),DESC=(6)                                     00097900
*                                                                       00098000
         B     @RC00303                                                 00098100
*                                                                       00098200
*              END;                                                     00098300
*            ELSE /*NOT 1,2,3,5                                      */ 00098400
*              DO;                                                      00098500
*                IF MSGNO = 4 THEN                                      00098600
@RF00320 L     R15,@PC00008                                             00098700
         CLC   0(4,R15),KF4                                             00098800
         BNE   @RF00325                                                 00098900
*                  DO;                                                  00099000
*                                                                       00099100
         WTO   'IFC004I SYS1.LOGREC ALLOCATION TOO SMALL FOR FRAMES',  X00099200
               ROUTCDE=(1),DESC=(6)                                     00099300
*                                                                       00099400
         B     @RC00303                                                 00099500
*                                                                       00099600
*                  END;                                                 00099700
*                ELSE /*NOT 1,2,3,4,5                                */ 00099800
*                  DO;                                                  00099900
*                    IF MSGNO = 6 THEN                                  00100000
@RF00325 L     R15,@PC00008                                             00100100
         CLC   0(4,R15),KF6                                             00100200
         BNE   @RF00330                                                 00100300
*                      DO;                                              00100400
         MVC   IFC006I+40(8),FRAMEDD                                    00100500
*                                                                       00100600
IFC006I  WTO   'IFC006I SRF CANNOT BE OPENED,DD=FRAMESXX',             X00100700
               ROUTCDE=(1),DESC=(6)                                     00100800
*                                                                       00100900
         B     @RC00303                                                 00101000
*                                                                       00101100
*                      END;                                             00101200
*                    ELSE /*NOT 1,2,3,4,5, OR 6                      */ 00101300
*                      DO;                                              00101400
*                        IF MSGNO = 7 THEN                              00101500
@RF00330 L     R15,@PC00008                                             00101600
         CLC   0(4,R15),KF7                                             00101700
         BNE   @RF00335                                                 00101800
*                          DO;                                          00101900
*                            CALL FILLMESS; /*FILL IN SPECIFICS OF MES* 00102000
         BAL   R14,FILLMESS                                             00102100
         MVC   IFC007I+64(8),FRAMEDD                                    00102200
*                                                                       00102300
IFC007I  WTO   'IFC007I SRF READ ERROR SENSE=SSSS,CSW=CCCCCCCCCCCCCC,DDX00102400
               =FRAMESXX',ROUTCDE=(1),DESC=(6)                          00102500
*                                                                       00102600
         B     @RC00303                                                 00102700
*                                                                       00102800
*                          END;                                         00102900
*                        ELSE /*NOT 1,2,3,4,5,6,7                    */ 00103000
*                          DO;                                          00103100
*                            IF MSGNO = 8 THEN                          00103200
@RF00335 L     R15,@PC00008                                             00103300
         CLC   0(4,R15),KF8                                             00103400
         BNE   @RF00341                                                 00103500
*                              DO;                                      00103600
         MVC   IFC008I+46(8),FRAMEDD                                    00103700
*                                                                       00103800
IFC008I  WTO   'IFC008I MORE THAN 50 FRAMES IN SET,DD=FRAMESXX',       *00103900
               ROUTCDE=(1),DESC=(6)                                     00104000
*                              END;                                     00104100
*                            ELSE /*NOT 1,2,3,4,5,6,7,8              */ 00104200
*                              DO;                                      00104300
         B     @RC00303                                                 00104400
*                                                                       00104500
*                                IF MSGNO = 9 THEN                      00104600
@RF00341 L     R15,@PC00008                                             00104700
         CLC   0(4,R15),KF9                                             00104800
         BNE   @RF00346                                                 00104900
*                                  DO;                                  00105000
*                                  RETCODE = SIXTEEN; /*ABORT        */ 00105100
         MVC   RETCODE,KF16                                             00105200
*                                                                       00105300
         WTO   'IFC009I INVALID SYSTEM RESIDENCE DEVICE',ROUTCDE=(1),  X00105400
               DESC=(6)                                                 00105500
*                                                                       00105600
         B     @RC00303                                                 00105700
*                                  END;                                 00105800
*                                ELSE /*NOT 1,2,3,4,5,6,7,8,9*/         00105900
*                                  DO;                                  00106000
*                                    IF MSGNO = 10 THEN                 00106100
@RF00346 L     R15,@PC00008                                             00106200
         CLC   0(4,R15),KF10                                            00106300
         BNE   @RF00352                                                 00106400
*                                      DO;                              00106500
*                                                                       00106600
IFC155I  WTO   'IFC155I FRAME SET MISSING,DD=FRAMESXX',                X00106700
               ROUTCDE=(1),DESC=(6)                                     00106800
*                                                                       00106900
         B     @RC00303                                                 00107000
*                                      END;                             00107100
*                                    ELSE IF MSGNO = 11 THEN            00107200
@RF00352 L     R15,@PC00008                                             00107300
         CLC   0(4,R15),KF11                                            00107400
         BNE   @RC00303                                                 00107500
*                                      DO;                              00107600
*                                                                       00107700
         WTO   'IFC156I INVALID PARM FIELD',ROUTCDE=(1),DESC=(6)        00107800
*                                                                       00107900
*                                      END;                             00108000
* IF MSGNO = TWELVE THEN                                                00108100
@RC00303 L     R15,@PC00008                                             00108200
         CLC   0(4,R15),KF12                                            00108300
         BNE   TESTE13                                                  00108400
*   DO;                                                                 00108500
*                                                                       00108600
         WTO   'IFC157I VERBAGE FAILURE',ROUTCDE=(1),DESC=(6)           00108700
*                                                                       00108800
         B     @ER00008                                                 00108900
*   END;                                                                00109000
TESTE13  L     R15,@PC00008                                             00109100
         CLC   0(4,R15),KF13                                            00109200
         BNE   TESTE14                                                  00109300
*                                                                       00109400
         WTO   'IFC158I MORE THAN 16 FRAMES DD STATEMENTS',            C00109500
               ROUTCDE=(1),DESC=(6)                                     00109600
*                                                                       00109700
         MVC   RETCODE,KF12                                             00109800
         B     @ER00008                                                 00109900
*                                                                       00110000
TESTE14  L     R15,@PC00008                                             00110100
         CLC   0(4,R15),KF14                                            00110200
         BNE   TESTE15                                                  00110300
         MVC   TESTE14A+41(8),FRAMEDD                                   00110400
*                                                                       00110500
TESTE14A WTO   'IFC159I UNABLE TO READ CPU ID,DD=FRAMESXX',            C00110600
               ROUTCDE=(1),DESC=(6)                                     00110700
*                                                                       00110800
         MVC   RETCODE,KF12                                             00110900
         B     @ER00008                                                 00111000
*                                                                       00111100
TESTE15  L     R15,@PC00008                                             00111200
         CLC   0(4,R15),KF15                                            00111300
         BNE   @ER00008                                                 00111400
*                                                                       00111500
TESTE16  WTO   'IFC160I NO FRAMES DD STATEMENTS, PARM=FRAMES IGNORED', C00111600
               ROUTCDE=(1),DESC=(6)                                     00111700
*                                                                       00111800
         MVC   RETCODE,KF12                                             00111900
*                                  END;                                 00112000
*                              END;                                     00112100
*                          END;                                         00112200
*                      END;                                             00112300
*                  END;                                                 00112400
*              END;                                                     00112500
*          END;                                                         00112600
*      END;                                                             00112700
*   END;                                                                00112800
*END; /*END OF PROC MSGWTR                                           */ 00112900
@ER00008 LM    R14,R12,@SA00008                                         00113000
         BR    R14                                                      00113100
*                                                                       00113200
*********************************************************************** 00113300
*                                                                       00113400
*        INSERT SENSE BYTES, CSW, AND DDNAME INTO ERROR MESSAGE         00113500
*        NUMBER SEVEN                                                   00113600
*                                                                       00113700
*********************************************************************** 00113800
*                                                                       00113900
*FILLMESS: PROC;                                                        00114000
FILLMESS STM   R14,R12,@SA00009                                         00114100
*R5 = ADDR(IOBSENS0); /*ADDRESS OF SENSE BYTE ONE FROM IOB           */ 00114200
         LA    R5,IOBSENS0                                              00114300
*R2 = ADDR(IFC007I+37);      /*LOCATION TO BE PLACED IN GENERATED WTO*/ 00114400
         LA    R2,IFC007I+37                                            00114500
*R3 = FOUR;                  /*NUMBER OF PRINTABLE CHARACTERS        */ 00114600
         LA    R3,4                                                     00114700
*CALL UNPACK;                /*RTN TO CONVERT TO PRINTABLE CHARACTERS*/ 00114800
         BAL   R14,UNPACK                                               00114900
*R5 = ADDR(IOBCSW); /*ADDRESS OF LOW ORDER 7 BYTES OF CSW            */ 00115000
         LA    R5,IOBCSW                                                00115100
*R2 = ADDR(IFC007I+46);      /*LOCATION TO BE PLACED IN GENERATED WTO*/ 00115200
         LA    R2,IFC007I+46                                            00115300
*R3 = EIGHT;                 /*NUMBER OF PRINTABLE CHARACTERS        */ 00115400
         LA    R3,8                                                     00115500
*CALL UNPACK;                /*CONVERT                               */ 00115600
         BAL   R14,UNPACK                                               00115700
*R5 = ADDR(IOBCSW) + 4;      /* ADDR OF LAST THREE BYTES OF CSW      */ 00115800
         LA    R5,IOBCSW+4                                              00115900
*R2 = ADDR(IFC007I+54);      /*WHERE PLACED IN WTO MESSAGE           */ 00116000
         LA    R2,IFC007I+54                                            00116100
*R3 = SIX;                   /*3 BYTES LEFT TO BE CONVERTED          */ 00116200
         LA    R3,6                                                     00116300
*CALL UNPACK;                /*CONVERT                               */ 00116400
         BAL   R14,UNPACK                                               00116500
*END;  /*END OF PROC FILLMESS                                        */ 00116600
@ER00009 LM    R14,R12,@SA00009                                         00116700
         BR    R14                                                      00116800
*                                                                       00116900
*********************************************************************** 00117000
*                                                                       00117100
*        RETRIEVE AND FORMAT CPU SERIAL NUMBER AND CPU VERSION          00117200
*        FROM SRF                                                       00117300
*                                                                       00117400
*********************************************************************** 00117500
*                                                                       00117600
*GETSER: PROC;                                                          00117700
GETSER   STM   R14,R12,@SA00010                                         00117800
         LA    R15,RDCPUID                                              00117900
         ST    R15,IOBSTART                                             00118000
         SLR   R15,R15                                                  00118100
         ST    R15,SRFECB                                               00118200
*                                                                       00118300
GETSERA  EXCP  SRFIOB                                                   00118400
*                                                                       00118500
         WAIT  1,ECB=SRFECB                                             00118600
*                                                                       00118700
         CLI   SRFECB,ECBINCPT                                          00118800
         BE    GETSERA                                                  00118900
         CLI   SRFECB,ECBNORM                                           00119000
         BE    GETSERB                                                  00119100
         LA    R1,DATA1004                                              00119200
         BAL   R14,MSGWTR                                               00119300
         B     @ER00010                EXIT                             00119400
*                                                                       00119500
GETSERB  MVZ   STCPUID(11),ALLZERO                                      00119600
         PACK  STCPUSER(6),STCPUID(11)                                  00119700
         MVI   STCPUMCL,X'00'                                           00119800
*END; /*END OF PROC GETSER                                           */ 00119900
@ER00010 LM    R14,R12,@SA00010                                         00120000
         BR    R14                                                      00120100
*                                                                       00120200
*********************************************************************** 00120300
*                                                                       00120400
*        ISSUE OPEN AND ENABLE FOR SRF                                  00120500
*                                                                       00120600
*********************************************************************** 00120700
*                                                                       00120800
*OPENSRF: PROC;                                                         00120900
OPENSRF  STM   R14,R12,@SA00011                                         00121000
         OI    SRFDCB+DCBIFLG-IHADCB,DCBIFNE3    NEVER USE IOS ERROR    00121100
*                                                RECOVERY               00121200
         OI    IOBFLAG1,IOBUNREL                                        00121300
         LA    R15,ENABLE              R15 -> ENABLE CCW                00121400
         ST    R15,IOBSTART                                             00121500
*                                                                       00121600
         OPEN  (SRFDCB,INPUT)                                           00121700
*                                                                       00121800
*IF (SRFDCB) ¼= OPENOK THEN          /*IF OPEN WAS NOT SUCCESSFUL*/     00121900
         TM    SRFDCB+DCBOFLGS-IHADCB,DCBOFOPN                          00122000
         BO    @DL00399               BRANCH, OPEN SUCCESSFUL           00122100
*  RETCODE = TWELVE; /*INDICATE NO FRAMES CAN BE RETRIEVED           */ 00122200
         MVC   RETCODE,KF12                                             00122300
         B     @ER00011                                                 00122400
*                                                                       00122500
*ELSE /*SUCCESSFUL OPEN                                              */ 00122600
* DO;                                                                   00122700
*   /*ECB IS INITIALIZED TO 00                                       */ 00122800
*   /*IOBFLAG1 INDICATING NEITHER COMMAND NOR DATA CHAINING IS ZERO  */ 00122900
*   /*IOBSTART POINTS TO THE ENABLE CHANNEL PROGRAM                  */ 00123000
*   DO UNTIL ECB ¼= INTERCPT;    /*LOOP UNTIL IO REQUEST HAS NOT BEEN*/ 00123100
*                                /*INTERCEPTED                       */ 00123200
*                                                                       00123300
@DL00399 EXCP  SRFIOB                                                   00123400
*                                                                       00123500
         WAIT  ECB=SRFECB     WAIT UNTIL ENABLE HAS BEEN SUCCESSFUL     00123600
*   END;                                                                00123700
@DE00399 CLI   SRFECB,ECBINCPT                                          00123800
         BE    @DL00399                                                 00123900
*   IF ECB ¼= OKAY THEN           /*IF ECB NOT 7F THEN ENABLE FAILED*/  00124000
         CLI   SRFECB,ECBNORM                                           00124100
         BE    @ER00011                                                 00124200
*     RETCODE = TWELVE;                                                 00124300
         MVC   RETCODE,KF12                                             00124400
* END;                                                                  00124500
*END; /*END OF PROC OPENSRF                                          */ 00124600
@ER00011 LM    R14,R12,@SA00011                                         00124700
         BR    R14                                                      00124800
*                                                                       00124900
*********************************************************************** 00125000
*                                                                       00125100
*        DISABLE AND CLOSE THE SRF                                      00125200
*                                                                       00125300
*********************************************************************** 00125400
*                                                                       00125500
*CLOSESRF: PROC;                                                        00125600
CLOSESRF STM   R14,R12,@SA00012                                         00125700
*    IOBFLAG1 = 0;     /*SPECIFY TYPE OF CHANNEL PROGRAM IN IOB*/       00125800
         MVI   IOBFLAG1,0                                               00125900
*    IOBSTART = ADDR(DISABLE); /*LOCATE CHANNEL PROGRAM FOR IOB*/       00126000
         LA    R15,DISABLE                                              00126100
         ST    R15,IOBSTART                                             00126200
*    SRFECB = ZERO; /*ZERO EVENT CONTROL BLOCK                       */ 00126300
         SLR   R15,R15                                                  00126400
         ST    R15,SRFECB                                               00126500
*    DO UNTIL ECB ¼= INTERCPT;   /*LOOP UNTIL IO REQUEST HAS NOT BEEN*/ 00126600
*                                /*INTERCEPTED                       */ 00126700
*                                                                       00126800
@DL00410 EXCP  SRFIOB                                                   00126900
*                                                                       00127000
         WAIT  ECB=SRFECB  WAIT UNTIL DISABLE IS SUCCESSFULL. DONT      00127100
*                          CHECK IF FAILS WHO CARES                     00127200
*    END;                                                               00127300
@DE00410 CLI   SRFECB,ECBINCPT                                          00127400
         BE    @DL00410                                                 00127500
*                               /*CLOSE SRF DEVICE                   */ 00127600
         CLOSE (SRFDCB,LEAVE)                                           00127700
*                               /*CLOSE SRF DEVICE                   */ 00127800
*   END; /*END OF PROC CLOSESRF                                      */ 00127900
@ER00012 LM    R14,R12,@SA00012                                         00128000
         BR    R14                                                      00128100
*                                                                       00128200
*********************************************************************** 00128300
*                                                                       00128400
*        BUILD CONSTANT PORTION OF FRAME HEADER                         00128500
*                                                                       00128600
*********************************************************************** 00128700
*                                                                       00128800
*BUILDFRH: PROC;                                                        00128900
BUILDFRH STM   R14,R12,12(R13)                                          00129000
*PACK(HOLD,CVTRELNO); /*PACK EBCDIC RELEASE NUMBER                   */ 00129100
         L     R15,CVTPTR                                               00129200
         LR    R14,R15                                                  00129300
         SL    R14,KF4                 R14 -> CVTRELNO                  00129400
         PACK  HOLD(8),0(2,R14)                                         00129500
*CVB(RECSYS,HOLD); /*PLACE BINARY RELEASE IN THE HEADING             */ 00129600
         CVB   R14,HOLD                                                 00129700
         STC   R14,RECSYS                                               00129800
*                                                                       00129900
*        IF (CVTDCB & '22'X) = '22'X THEN /*IF VS1 AND DYN.ADR.TRANS*/  00130000
         TM    CVTDCB-CVTMAP(R15),CVT2SPS+CVT6DAT                       00130100
         BNO   @RF00423                                                 00130200
*          RECSYS = (RECSYS | '40'X);  /*SET VS1 BITS ON             */ 00130300
         OI    RECSYS,X'40'                                             00130400
*                                                                       00130500
*        IF (CVTDCB & '12'X) = '12'X |    /*IF MVS OR SVS AND DY.ADR*/  00130600
*           (CVTDCB & '11'X) = '11'X THEN /*IF MVS                   */ 00130700
@RF00423 TM    CVTDCB-CVTMAP(R15),CVT4MS1+CVT6DAT                       00130800
         BO    @RT00425                                                 00130900
         TM    CVTDCB-CVTMAP(R15),CVT4MS1+CVTMVS2                       00131000
         BNO   @RF00425                                                 00131100
*          RECSYS = (RECSYS | '80'X);  /*SET VS2 BITS ON             */ 00131200
@RT00425 OI    RECSYS,X'80'                                             00131300
*        RECCPU = STCPUVER;/*PUT CPU VERSION, CPU MODEL ,CPU SERIAL, */ 00131400
@RF00425 MVC   RECCPU(8),STCPUVER                                       00131500
*                         /*AND MAXIMUM EXTENDED LOGOUT LENGTH IN HDR*/ 00131600
*END; /*END OF PROC BUILDFRH                                         */ 00131700
@ER00013 LM    R14,R12,12(R13)                                          00131800
         BR    R14                                                      00131900
*                                                                       00132000
*********************************************************************** 00132100
*                                                                       00132200
*        RECREATE HEADER TO REFLECT FRAMES                              00132300
*                                                                       00132400
*********************************************************************** 00132500
*                                                                       00132600
*REDOHDR:PROC;                                                          00132700
REDOHDR  STM   R14,R12,@SA00014                                         00132800
*R0 = TTRSAVE; /*R0 = TTR OF LAST WRITTEN RECORD                     */ 00132900
         L     R0,TTRSAVE                                               00133000
*R2 = ADDR(MBBCCHHR);               /*PASS LOCATION FOR ABSOLUTE ADDR*/ 00133100
         LA    R2,MBBCCHHR                                              00133200
*R15 = CVTPCNVT; /*LOAD ADDR OF CONVERSION ROUTINE                   */ 00133300
         L     R9,CVTPTR                                                00133400
         L     R15,CVTPCNVT-CVTMAP(,R9)                                 00133500
         LA    R1,SERERDS              R1 -> SERERDS DCB                00133600
         L     R1,DCBDEBAD-IHADCB(R1)  R1 -> DEB                        00133700
         LA    R3,MYSAVE               R3 -> SAVEAREA ACROSS CVTPCNVT   00133800
         STM   R9,R13,0(R3)            SAVE REGS ACROSS CALL            00133900
         BALR  R14,R15                 CALL CVTPCNVT TTR -> CCHHR RTN   00134000
         LM    R9,R13,0(R3)            RESTORE REGISTERS                00134100
         MVC   HDRREA,BBCCHHR          RECORD ENTRY AREA                00134200
         MVC   HDRLASTR,HDRREA         LAST RECORD WRITTEN LOCATION     00134300
         MVC   HDRTBAL,ARBSMALL        SET TRACK BALANCE SO SMALL       00134400
*                                      THAT NO RECORD WILL FIT          00134500
         OI    HDREWSW,HDRFRSW         SET FRAMES EXIST SWITCH          00134600
*END; /*END OF PROC REDOHDR                                          */ 00134700
@ER00014 LM    R14,R12,@SA00014                                         00134800
         BR    R14                                                      00134900
*                                                                       00135000
*****************************************************************       00135100
*                                                                       00135200
*        GETDEV                                                         00135300
*                                                                       00135400
*****************************************************************       00135500
*                                                                       00135600
*GETDEV: PROC;                                                          00135700
*        RETRIEVE EXTENT INFORMATION FROM THE DEB                       00135800
*        FORMAT HDR RECORD FIELDS                                       00135900
*        CALCULATE THE TRACK BALANCE                                    00136000
*        NOTE - ONLY THE FIRST EXTENT IS PROCESSED                      00136100
*                                                                       00136200
GETDEV   STM   R14,R12,@SA00015                                         00136300
         LA    R2,SERERDS               R2 -> SERERDS DCB               00136400
         L     R6,DCBDEBAD-IHADCB(,R2)  R6 -> DEB                       00136500
         USING DEBBASIC,R6                                              00136600
         LA    R6,DEBBASND                                              00136700
         USING DEBDASD,R6                                               00136800
*                                                                       00136900
*        INITIALIZE START AND END OF EXTENT FIELDS                      00137000
*                                                                       00137100
         MVC   HDRSTRCC,DEBSTRCC       START EXTENT OF SYS1.LOGREC      00137200
         MVC   HDRENDCC,DEBENDCC       END EXTENT OF SYS1.LOGREC        00137300
         MVC   SAVENDCC,DEBENDCC       SAVE FOR DCBFDAD                 00137400
*                                                                       00137500
         L     R7,ADVCT                R7 -> IECZDTAB DEVICE ENTRY      00137600
         USING DVCT,R7                                                  00137700
*                                                                       00137800
*        PREVENT ANY ATTEMPT TO WRITE PAST SYS1.LOGREC EXTENT           00137900
*                                                                       00138000
*        WHEN WRITING FRAMES TO SYS1.LOGREC BY CREATING                 00138100
*        ARTIFICIAL TTR0 FOR LATER COMPARISON TO NOTE AFTER BSAM        00138200
*        WRITE                                                          00138300
*                                                                       00138400
         SR    R4,R4                                                    00138500
         SR    R5,R5                                                    00138600
         MVC   SAVTRKLN,DVCTRKLN       SAVE FOR DCBTRBAL                00138700
         ICM   R5,B'0011',DVCTRKLN     R5 = BYTES PER TRACK ON LOGREC   00138800
*                                           DEVICE                      00138900
         D     R4,BYTPFRM              DIVIDE BY BYTES PER FRAME PLUS   00139000
*                                      GUESSTIMATED TRACK OVERHEAD      00139100
*                                      R5 = NUMBER OF FRAMES PER TRACK  00139200
         SR    R4,R4                                                    00139300
         ICM   R4,B'0011',DEBNMTRK     R4 = TOTAL TRACKS IN LOGREC      00139400
         BCTR  R4,0                    CHANGE TO RELATIVE TRACK NUMBER  00139500
         BCTR  R4,0                    MAKE ROOM FOR DUMMY END OF FILE  00139600
         SLL   R4,16                   MOVE TO HIGH ORDER HALFWRD (TT)  00139700
         SLL   R5,8                    FRAMES PER TRACK TO REL REC (R)  00139800
         OR    R4,R5                   MAKE MAXIMUM TTR0 IN R4          00139900
         ST    R4,MAXTTR               SAVE FOR COMPARE WHILE WRITING   00140000
*                                                                       00140100
*        COMPLETE DEVICE GEOMETRY FIELDS                                00140200
*                                                                       00140300
*        CALCULATE HDREWMT AS 90% OF TOTAL TRACKS IN EXTENT             00140400
*                                                                       00140500
         STM   R0,13,@SA00016          SAVE REGS                        00140600
         SR    R5,R5                                                    00140700
         ICM   R5,B'0011',DEBNMTRK     R5 = TRACKS IN EXTENT            00140800
         MH    R5,KH90                 CALC 90%                         00140900
         SR    R4,R4                                                    00141000
         D     R4,KF100                R5 = 90% OF TRACKS ALLOCATED     00141100
         LR    R0,R5                                                    00141200
         BCTR  R0,0                    CONVERT FROM NO OF TRACKS TO     00141300
*                                      RELATIVE TRACK                   00141400
         SLL   R0,16                   SHIFT TO TTRN FORMAT FOR         00141500
*                                      CVTPCNVT CALL                    00141600
         L     R1,SERERDS+DCBDEBAD-IHADCB  R1 -> DEB                    00141700
         LA    R2,WORKDW               R2 -> MBBCCHHR RESULTS FIELD     00141800
         LA    R4,@SA00016             GET SAVEAREA ADDR ACROSS CALL    00141900
         L     R15,CVTPTR                                               00142000
         L     R15,CVTPCNVT-CVTMAP(R15)                                 00142100
         BASR  R14,R15                 CONVERT TTRN TO MBBCCHHR         00142200
         LM    R0,R13,0(R4)            RESTORE REGS FROM @SA00016       00142300
         LTR   R15,R15                 GOOD RETURN CODE                 00142400
         BNZ   BADRES                  NO, BRANCH                       00142500
         MVC   HDREWMT,WORKDW+3        MOVE IN CCHH FOR EARLY WARNING   00142600
*                                      TEST                             00142700
*                                                                       00142800
*        CALCULATE HDREWTC AS 90% OF TRACK CAPACITY                     00142900
*                                                                       00143000
         SR    R5,R5                                                    00143100
         ICM   R5,B'0011',DVCTRKLN     R5 = BYTES PER TRACK ON LOGREC   00143200
*                                      DEVICE                           00143300
         MH    R5,KH90                                                  00143400
         SR    R4,R4                                                    00143500
         D     R4,KF100                                                 00143600
         STCM  R5,B'0011',HDREWTC                                       00143700
*                                                                       00143800
*        INITIALIZE TRACKS PER CYL FROM DEVICE TABLE ENTRY              00143900
*                                                                       00144000
         LH    R4,DVCTRK                                                00144100
         BCTR  R4,0                    DECR FOR COMPATIBLITY WITH       00144200
*                                      OLD VERSION OF IFCDIP00          00144300
         STCM  R4,B'0011',HDRTRK                                        00144400
*                                                                       00144500
*        INITIALIZE LAST RECORD WRITTEN AND NEXT RECORD TO WRITE        00144600
*                                                                       00144700
         MVC   HDRREA+2(4),HDRSTRCC    LOW EXT TO REC ENTRY AREA        00144800
         MVI   HDRREA+6,2              SET RECORD TO TWO                00144900
         MVC   HDRLASTR,HDRREA         MAKE LAST USED THE SAME          00145000
*                                                                       00145100
*        CALCULATE THE TRACK BALANCE THAT WILL RESULT AFTER             00145200
*        HEADER RECORD AND OUTAGE RECORD HAVE BEEN WRITTEN TO           00145300
*        LOGREC DATASET SO THAT THE HEADER RECORD WILL CONTAIN          00145400
*        THE CORRECT TRACK BALANCE VALUE                                00145500
*                                                                       00145600
         SR    R4,R4                                                    00145700
         ICM   R4,B'0011',SERERDS+DCBTRBAL-IHADCB   CURRENT TRK BALANCE 00145800
         LA    R5,HDRRECL              L'RECORD                         00145900
         ICM   R5,B'1000',=X'01'       SET RECORD NO = 1 FOR HDRREC     00146000
*                                                                       00146100
         TRKCALC FUNCTN=TRKBAL,REMOVE=NO,DEVTAB=(7),                   X00146200
               BALANCE=(4),RKDD=(5),REGSAVE=YES                         00146300
*                                                                       00146400
         LTR   R15,R15                 TRKCALC OK ?                     00146500
         BNZ   BADRES                  NO, BRANCH                       00146600
         LR    R4,R0                   YES, SET TRACK BALANCE           00146700
         ICM   R5,B'1000',=X'02'       SET RECORD NO = 2 FOR OUTAGE REC 00146800
*                                                                       00146900
         TRKCALC FUNCTN=TRKBAL,REMOVE=NO,DEVTAB=(7),                   X00147000
               BALANCE=(4),RKDD=(5),REGSAVE=YES                         00147100
*                                                                       00147200
         LTR   R15,R15                 TRKCALC OK ?                     00147300
         BNZ   BADRES                  NO, BRANCH                       00147400
         STCM  R0,B'0011',HDRTBAL      UPDATE HDRREC TRACK BALANCE      00147500
*                                                                       00147600
*        INITIALIZE TOTAL BYTES ON TRACK FROM DEVICE TABLE ENTRY        00147700
*                                                                       00147800
         MVC   HDRTRKLN,DVCTRKLN       TOTAL BYTES ON TRACK             00147900
*                                                                       00148000
*        INITIALIZE DEVICE TYPE FROM DCB                                00148100
*                                                                       00148200
         MVC   HDRDEVT,SERERDS+DCBDEVT-IHADCB   DEVICE TYPE CODE        00148300
         NI    HDRDEVT,DVCTYPMK        LOW ORDER NIBBLE ONLY            00148400
*                                                                       00148500
*        INITIALIZE FLAGS AND INDICATORS                                00148600
*                                                                       00148700
         MVI   HDRMSGCT,0              LOGREC FULL MSG COUNT            00148800
         MVI   HDREWSW,0               CLEAR SWITCH AREA                00148900
         MVI   HDRCHK,X'FF'            CHECK BYTE                       00149000
         B     ENDGETDV                GOTO EXIT                        00149100
*                                                                       00149200
*BADRES:;                                                               00149300
*        CALL MSGWTR(9);   /* IDENTIFY ILLEGAL SYSRES DEVICE         */ 00149400
BADRES   LA    R1,@AL00442                                              00149500
         BAL   R14,MSGWTR                                               00149600
*        RETCODE = SIXTEEN; /*DONT FORMAT SYS1.LOGREC                */ 00149700
         MVC   RETCODE,KF16                                             00149800
*ENDGETDV:;                                                             00149900
         DROP  R6,R7                                                    00150000
*END; /*END OF PROC GETDEV                                           */ 00150100
ENDGETDV LM    R14,R12,@SA00015                                         00150200
         BR    R14                                                      00150300
*                                                                       00150400
*********************************************************************** 00150500
*                                                                       00150600
*        BUILDTXT                                                       00150700
*        FORMAT HEADER RECORD INFORMATION FOR MSG IFC001I               00150800
*        MOVE INTO MSG                                                  00150900
*                                                                       00151000
*********************************************************************** 00151100
*                                                                       00151200
*BUILDTXT: PROC;                                                        00151300
BUILDTXT STM   R14,R12,@SA00017                                         00151400
         L     R5,HDRSTRCC              LOW EXTENT                      00151500
         LA    R2,F                     IMAGE AREA                      00151600
         LA    R3,8                     NUMBER OF CHAR TO CONVERT       00151700
*        CALL  UNPACK;                  /*CONVERT TO PRINTABLE*/        00151800
         BAL   R14,UNPACK                                               00151900
         LA    R3,8                     NUMBER OF CHAR TO CONVERT       00152000
         L     R5,HDRENDCC              HIGH EXTENT                     00152100
         LA    R2,L                     IMAGE AREA                      00152200
*        CALL  UNPACK;                  /*CONVERT TO PRINTABLE*/        00152300
         BAL   R14,UNPACK                                               00152400
         ICM   R5,B'1111',HDRREA+2      RESTART AREA IN HEADER (CCHH)   00152500
         LA    R3,8                     MAKE CCHH PRINTABLE             00152600
         LA    R2,S                     LOCATION IN MESSAGE             00152700
*        CALL  UNPACK;                  /*CONVERT TO PRINTABLE*/        00152800
         BAL   R14,UNPACK                                               00152900
         ICM   R5,B'1111',HDRREA+6      RESTART RECORD ADDR IN HDR      00153000
         LA    R3,2                     RECORD ADDRESS IS 2 PRINT DIG   00153100
         LA    R2,S+8                   WHERE TO PUT IN MESSAGE         00153200
*        CALL  UNPACK;                  /*CONVERT TO PRINTABLE*/        00153300
         BAL   R14,UNPACK                                               00153400
         SR    R7,R7                                                    00153500
         IC    R7,HDRDEVT               GET DEVICE CODE                 00153600
         LA    R2,HEXTAB(R7)            R2 -> PRINTABLE CHARACTER       00153700
         MVC   N(1),0(R2)               DEVICE CODE                     00153800
         BCTR  R7,0                     CONVERT TO 0 - 14               00153900
         SLL   R7,2                     MULTIPLY BY 4                   00154000
         LA    R7,DASDTAB(R7)           LOAD ENTRY ADDR OF SYSRES       00154100
         MVC   D(4),0(R7)               MOVE IN DEVICE NAME             00154200
*END; /*END OF PROC BUILDPROC                                        */ 00154300
@ER00017 LM    R14,R12,@SA00017                                         00154400
         BR    R14                                                      00154500
*                                                                       00154600
D        EQU   IFC001I+19               DEVICE NAME                     00154700
N        EQU   IFC001I+27               DEVICE TYPE CODE                00154800
F        EQU   IFC001I+31               FIRST TRACK ADDR                00154900
L        EQU   IFC001I+42               LAST TRACK ADDR                 00155000
S        EQU   IFC001I+53               RECORD START ADDRESS+ID         00155100
*                                                                       00155200
*********************************************************************** 00155300
*                                                                       00155400
*        UNPACK CHARACTERS FOR PRINT                                    00155500
*                                                                       00155600
*        R2 -> CONVERTED CHARACTERS                                     00155700
*        R5  = CHARACTERS TO BE CONVERTED                               00155800
*        R3  = NUMBER OF PRINTABLE CHARACTERS TO BE CREATED             00155900
*                                                                       00156000
*********************************************************************** 00156100
*                                                                       00156200
*UNPACK: PROC;                                                          00156300
UNPACK   STM   R14,R12,@SA00018                                         00156400
UNPACK1  SR    R4,R4                    CLEAR REG                       00156500
         SLDL  R4,4                     POSITION                        00156600
         IC    R4,HEXTAB(R4)            PRINTABLE CHARACTER             00156700
         STC   R4,0(R2)                 STORE IT                        00156800
         LA    R2,1(R2)                 UPDATE                          00156900
         BCT   R3,UNPACK1               NEXT                            00157000
*END; /*END OF UNPACK PROC                                              00157100
@ER00018 LM    R14,R12,@SA00018                                         00157200
         BR    R14                                                      00157300
*                                                                       00157400
*END; /*END OF EXTERNAL PROC IFCDIP00                                */ 00157500
@EL00001 L     R13,4(,R13)                                              00157600
         L     R14,12(,R13)                                             00157700
         LM    R0,R12,20(R13)                                           00157800
         BR    R14                     RETURN WITH RETURN CODE IN R15   00157900
*                                                                       00158000
         DC    0F'0'                                                    00158100
MSG11    DC    A(KF11)                 LIST WITH   1 ARGUMENT(S)        00158200
@AL00109 DC    A(KF1)                  LIST WITH   1 ARGUMENT(S)        00158300
@AL00112 DC    A(KF2)                  LIST WITH   1 ARGUMENT(S)        00158400
*                                                                       00158500
*        PARAMETER LIST FOR WRITELOG PROC                               00158600
*                                                                       00158700
WRITEPRM DC    A(KF40)                 LIST WITH   2 ARGUMENT(S)        00158800
         DC    A(WRITEPTR)                                              00158900
*                                                                       00159000
DATA0FD4 DC    A(KF3)                                                   00159100
DATA0FD8 DC    A(KF13)                                                  00159200
DATA0FDC DC    A(KF15)                                                  00159300
@AL00193 DC    A(KF10)                 LIST WITH   1 ARGUMENT(S)        00159400
@AL00282 DC    A(KF7)                  LIST WITH   1 ARGUMENT(S)        00159500
@AL00151 DC    A(KF6)                  LIST WITH   1 ARGUMENT(S)        00159600
@AL00180 DC    A(KF8)                  LIST WITH   1 ARGUMENT(S)        00159700
@AL00205 DC    A(KF1944)               LIST WITH   2 ARGUMENT(S)        00159800
         DC    A(WRITEPTR)                                              00159900
@AL00242 DC    A(KF4)                  LIST WITH   1 ARGUMENT(S)        00160000
@AL00255 DC    A(KF5)                  LIST WITH   1 ARGUMENT(S)        00160100
@AL00297 DC    A(KF12)                 LIST WITH   1 ARGUMENT(S)        00160200
DATA1004 DC    A(KF14)                                                  00160300
@AL00442 DC    A(KF9)                  LIST WITH   1 ARGUMENT(S)        00160400
*                                                                       00160500
*        SAVE AREAS                                                     00160600
*                                                                       00160700
@SA00001 DC    18F'0'                                                   00160800
@SA00008 DC    15F'0'                                                   00160900
@PC00008 DC    F'0'                                                     00161000
@SA00002 DC    15F'0'                                                   00161100
@SA00003 DC    15F'0'                                                   00161200
@SA00004 DC    15F'0'                                                   00161300
@SA0000X DC    15F'0'                                                   00161400
@SA00005 DC    15F'0'                                                   00161500
@SA011C8 DC    15F'0'                                                   00161600
@SA00011 DC    15F'0'                                                   00161700
@SA00010 DC    15F'0'                                                   00161800
@SA00007 DC    15F'0'                                                   00161900
@SA00006 DC    15F'0'                                                   00162000
@SA012F4 DC    15F'0'                                                   00162100
@SA00012 DC    15F'0'                                                   00162200
@SA00014 DC    15F'0'                                                   00162300
@SA00015 DC    15F'0'                                                   00162400
@SA00016 DC    15F'0'                                                   00162500
@SA00017 DC    15F'0'                                                   00162600
@SA00009 DC    15F'0'                                                   00162700
@SA00018 DC    15F'0'                                                   00162800
*                                                                       00162900
*        CONSTANTS                                                      00163000
*                                                                       00163100
KF1      DC    F'1'                                                     00163200
KF2      DC    F'2'                                                     00163300
KF3      DC    F'3'                                                     00163400
KF4      DC    F'4'                                                     00163500
KF5      DC    F'5'                                                     00163600
KF6      DC    F'6'                                                     00163700
KF7      DC    F'7'                                                     00163800
KF8      DC    F'8'                                                     00163900
KF9      DC    F'9'                                                     00164000
KF10     DC    F'10'                                                    00164100
KF11     DC    F'11'                                                    00164200
KF12     DC    F'12'                                                    00164300
KF13     DC    F'13'                                                    00164400
KF14     DC    F'14'                                                    00164500
KF15     DC    F'15'                                                    00164600
KF16     DC    F'16'                                                    00164700
KF40     DC    F'40'                                                    00164800
KF90     DC    F'90'                                                    00164900
KH90     EQU   KF90+2                                                   00165000
KF100    DC    F'100'                                                   00165100
KF1944   DC    F'1944'                                                  00165200
*                                                                       00165300
ADVCT    DC    A(0)                    -> IECZDTAB DEVICE ENTRY         00165400
RETCODE  DC    F'0'                                                     00165500
LOGSAVE  DC    F'0'                                                     00165600
READPTR  DC    AL4(BUF1)                                                00165700
WRITEPTR DC    AL4(BUF2)                                                00165800
HIGHRETC DC    F'0'                                                     00165900
TIOTPTR  DC    A(0)                                                     00166000
DDCOUNT  DC    H'0'                                                     00166100
SEQCNT   DC    AL1(0)                                                   00166200
*                                                                       00166300
SRFECB   DC    F'0'                                                     00166400
*                                                                       00166500
KFRAMES  DC    C'FRAMES'                                                00166600
KSERERDS DC    CL8'SERERDS'            SYS1.LOGREC DDNAME               00166700
*                                                                       00166800
*        ENQ MAJOR AND MINOR NAMES                                      00166900
*                                                                       00167000
*        NOTE THAT AN ENQ ON THE MAJOR NAME OF SYSZLOGR WILL RESULT     00167100
*        IN AN 338 ABEND UNLESS ISSUED BY AN AUTHORIZED PROGRAM         00167200
*                                                                       00167300
SYSZLOGR DC    CL8'SYSZLOGR'                                            00167400
LOGRECA  DC    CL8'RECORDER'                                            00167500
*                                                                       00167600
*        SRF CCW COMMNDS                                                00167700
*                                                                       00167800
ENABLE   CCW   SRFENAB,0,SLI,1                                          00167900
*                                                                       00168000
DISABLE  CCW   SRFDIS,0,SLI,1                                           00168100
*                                                                       00168200
RDCPUID  CCW   SRFRDCPU,STCPUID,SLI,10                                  00168300
*                                                                       00168400
STCPUID  DC    XL11'00000000000000000000F0'                             00168500
         DC    0D'0'                                                    00168600
STCPUVER DC    X'00'                                                    00168700
STCPUSER DC    X'000000'                                                00168800
STCPUMOD DC    X'0000'                                                  00168900
STCPUMCL DC    X'0000'                                                  00169000
*                                                                       00169100
ALLZERO  DC    CL11'00000000000'                                        00169200
*                                                                       00169300
VERBAGE  CCW   SRFVERB,FRAMTYPS,SLI,1                                   00169400
*                                                                       00169500
FRAMTYPS DC    X'02'                                                    00169600
*                                                                       00169700
RDVERB   CCW   SRFREAD,0,SLI,1920                                       00169800
*                                                                       00169900
SWITCH   DC    X'0000'                                                  00170000
FRAMEYES EQU   X'80'                                                    00170100
FRAMLOST EQU   X'40'                                                    00170200
ONEFRAME EQU   X'20'                                                    00170300
*                                                                       00170400
*        SYSTEM REFERENCE FILE IOB                                      00170500
*                                                                       00170600
SRFIOB   DC    4D'0'                   STANDARD NON DASD IOB            00170700
*                                                                       00170800
         ORG   SRFIOB-16               ALLOW FOR IOB PREFIX             00170900
         PRINT NOGEN                                                    00171000
         IEZIOB DSECT=NO                                                00171100
         PRINT GEN                                                      00171200
*        INITIALIZE SRF IOB FIELDS                                      00171300
         ORG   IOBECBPB                                                 00171400
         DC    AL3(SRFECB)             INIT IOB ECB ADDR                00171500
         ORG   IOBSTART                                                 00171600
         DC    AL4(ENABLE)             INIT CHANNEL PROG ADDR           00171700
         ORG   IOBDCBPB                                                 00171800
         DC    AL3(SRFDCB)             INIT IOB DCB ADDR                00171900
         ORG   SRFIOB+32               RESET COUNTER AFTER IOB MAP      00172000
*                                                                       00172100
BUF1     DS    CL1944                                                   00172200
BUF2     DS    CL1944                                                   00172300
         ORG   BUF2                                                     00172400
BUF240   DS    CL40                                                     00172500
         ORG   BUF2+1944                                                00172600
RECBUILD DS    CL24                                                     00172700
         ORG   RECBUILD                                                 00172800
RECTYPE  DC    X'A0'                                                    00172900
RECSYS   DC    X'00'                                                    00173000
RECSW0   DC    X'8800'                                                  00173100
         ORG   RECSW0                                                   00173200
RECNLST  DS    BL1                                                      00173300
         ORG   RECBUILD+4                                               00173400
@NM00005 DC    X'0000'                                                  00173500
RECCNT   DC    AL1(0)                                                   00173600
@NM00006 DC    X'00'                                                    00173700
RECDAT   DC    X'00000000'                                              00173800
RECTIME  DC    X'00000000'                                              00173900
RECCPU   DC    X'0000000000000000'                                      00174000
         ORG   RECBUILD+24                                              00174100
HOLD     DC    XL8'00'                                                  00174200
MBBCCHHR DS    CL8                                                      00174300
         ORG   MBBCCHHR                                                 00174400
M        DS    CL1                                                      00174500
BBCCHHR  DS    CL7                                                      00174600
         ORG   BBCCHHR                                                  00174700
BB       DS    CL2                                                      00174800
CCHHR    DS    CL5                                                      00174900
         ORG   MBBCCHHR+8                                               00175000
*                                                                       00175100
FRAMEDD  DC    XL8'0000000000000000'                                    00175200
FRFLAG   DC    X'00'                                                    00175300
FRFLAGY  EQU   X'80'                   GOT FRAMEXX DD                   00175400
*                                                                       00175500
*********************************************************************** 00175600
*                                                                       00175700
*        DEVICE TABLE                                                   00175800
*                                                                       00175900
*        DEVICE NAMES CURRENTLY SUPPORTED AS SYSTEM RESIDENCE           00176000
*        DEVICES                                                        00176100
*                                                                       00176200
*********************************************************************** 00176300
*                                                                       00176400
*        THIS TABLE IS ONLY USED FOR PURPOSES OF IDENTIFING THE         00176500
*        UNIT DEVICE NAME IN MSG IFC001I                                00176600
*                                                                       00176700
*              DEVICE NAME         DEVTYP                               00176800
DASDTAB  DC    CL4'2311'           X'01'                                00176900
         DC    CL4'2301'           X'02'                                00177000
         DC    CL4'2303'           X'03'                                00177100
         DC    CL4'9345'           X'04'    REPURPOSED FROM 2302        00177200
         DC    CL4'2321'           X'05'                                00177300
         DC    CL4'2351'           X'06'                                00177400
         DC    CL4'2352'           X'07'                                00177500
         DC    CL4'2314'           X'08'                                00177600
         DC    CL4'3330'           X'09'                                00177700
         DC    CL4'3340'           X'0A'                                00177800
         DC    CL4'3350'           X'0B'                                00177900
         DC    CL4'3375'           X'0C'                                00178000
         DC    CL4'3331'           X'0D'                                00178100
         DC    CL4'3380'           X'0E'                                00178200
         DC    CL4'3390'           X'0F'                                00178300
*                                                                       00178400
*********************************************************************** 00178500
*                                                                       00178600
*        LOGREC HEADER RECORD                                           00178700
*                                                                       00178800
*********************************************************************** 00178900
*                                                                       00179000
         CNOP  2,4                                                      00179100
HDRREC   DC    X'FFFF'             +00 RECORD ID                        00179200
HDRSTRCC DC    XL4'00000000'       +02 START OF LOGREC EXTENT CCHH      00179300
HDRENDCC DC    XL4'00000000'       +06 END OF LOGREC EXTENT CCHH        00179400
HDRMSGCT DC    XL1'00'             +10 COUNT OF LOGREC FULL MSG         00179500
HDRREA   DC    XL7'00000000000000' +11 RECORD ENTRY AREA (BBCCHHR)      00179600
*                                      START OF LOGREC RECORDS          00179700
HDRTBAL  DC    AL2(0)              +18 TRACK BALANCE                    00179800
HDRTRKLN DC    AL2(0)              +20 NO OF BYTES PER TRACK            00179900
HDRLASTR DC    XL7'00000000000000' +22 LAST RECORD WRITTEN (BBCCHHR)    00180000
HDRTRK   DC    AL2(0)              +29 TRKS PER CYL(HIGHEST TRK ON CYL) 00180100
HDREWTC  DC    AL2(0)              +31 EARLY WARNING TRACK CAPACITY     00180200
*                                      SET AT 90% OF LAST TRACK         00180300
HDRDEVT  DC    X'00'               +33 UNIT DEVICE TYPE (LOW NIBBLE)    00180400
HDREWMT  DC    XL4'00000000'       +34 EARLY WARNING TRK (CCHH)         00180500
*                                      SET AT 90% OF ALL TRACKS         00180600
HDREWSW  DC    X'00'               +38 EARLY WARNING SWITCH             00180700
HDREWMI  EQU   X'80'                   SET WHEN EARLY WARNING MSG       00180800
*                                      IFB060E HAS BEEN ISSUED TO OPER  00180900
HDRFRSW  EQU   X'20'                   FRAMES PRESENT IN LOGREC         00181000
*                                                                       00181100
HDRCHK   DC    X'FF'               +39 CHECK BYTE                       00181200
HDRRECL  EQU   *-HDRREC                L'HDRREC                         00181300
*                                                                       00181400
*********************************************************************** 00181500
*                                                                       00181600
*        SYS1.LOGREC DATASET DCB                                        00181700
*                                                                       00181800
*********************************************************************** 00181900
*                                                                       00182000
SERERDS  DCB   DDNAME=SERERDS,                                         X00182100
               DSORG=PS,                                               X00182200
               MACRF=(RP,WP),                                          X00182300
               RECFM=U,                                                X00182400
               BLKSIZE=1944,                                           X00182500
               DEVD=DA,                                                X00182600
               EXLST=EXITJFCB,                                         X00182700
               SYNAD=LOGERR                                             00182800
*                                                                       00182900
*********************************************************************** 00183000
*                                                                       00183100
*        SYSTEM REFERENCE FILE DCB                                      00183200
*                                                                       00183300
*********************************************************************** 00183400
*                                                                       00183500
SRFDCB   DCB   MACRF=(E),                                              X00183600
               IOBAD=SRFIOB,                                           X00183700
               DSORG=PS,                                               X00183800
               DEVD=DA,                                                X00183900
               RECFM=U,                                                X00184000
               DDNAME=FRAMES                                            00184100
*                                                                       00184200
*********************************************************************** 00184300
*                                                                       00184400
*        LOGREC DATASET DECB                                            00184500
*                                                                       00184600
*********************************************************************** 00184700
*                                                                       00184800
         WRITE LISTDECB,SF,SERERDS,HDRREC,HDRRECL,,,,MF=L               00184900
*                                                                       00185000
*        SERERDS DCB EXLST                                              00185100
*                                                                       00185200
         DC    0F'0'                                                    00185300
EXITJFCB DC    X'87'                   REQUEST RDJFCB                   00185400
         DC    AL3(JFCB)               ADDR OF JFCB                     00185500
*                                                                       00185600
WORKDW   DC    D'0'                    TEMP WORK AREA                   00185700
SAVENDCC DC    XL4'00'                 SAVED ENDCC FOR DCBFDAD          00185800
SAVTRKLN DC    H'0'                    SAVE TRACK LEN FOR DCBTRBAL      00185900
DEVTYPE  DC    X'00'                   DEVICE TYPE STORAGE              00186000
HEXTAB   DC    C'0123456789ABCDEF'     CONVERSION TABLE                 00186100
BYTPFRM  DC    F'2500'                 BYTES IN FRAME PLUS GUESSTIMATED 00186200
*                                      TRACK OVERHEAD (VERY APROXIMATE) 00186300
ARBSMALL DC    X'0014'                 SET TRKBAL SO NO RECORD WILL FIT 00186400
TTRSAVE  DC    F'0'                                                     00186500
TTRLST   DC    F'0'                    TTR OF LAST FRAME                00186600
MYSAVE   DC    5F'0'                   TRACK CONVERSION RTN SAVEAREA    00186700
MAXTTR   DC    X'00000000'  PLACE MAXIMUM RELATIVE LOCATION OF LOGREC   00186800
THIRD    DC    X'00000200'  TTR BEFORE 1ST FRAME. USED TO DETERMINE     00186900
*                           WHICH ERROR MESSAGE TO ISSUE. IF WRITE      00187000
*                           FAILS, NOTE WILL NOT BE EXECUTED AND TTR    00187100
*                           IN TTRSAVE WILL BE TTR FOR LAST RECORD OR   00187200
*                           ZERO IF HEADER WRITE FAIL.                  00187300
         DC    0D'0'                                                    00187400
JFCB     DC    XL176'00'                                                00187500
*                                                                       00187600
         ORG   JFCB                                                     00187700
*                                                                       00187800
*        PRINT NOGEN                                                    00187900
*                                                                       00188000
         IEFJFCBN                                                       00188100
*                                                                       00188200
         ORG   ,                                                        00188300
*                                                                       00188400
*        UCB DEVICE CHARACTERISTICS                                     00188500
*                                                                       00188600
DVADATA  DC    5F'0'                                                    00188700
         ORG   DVADATA                                                  00188800
*                                                                       00188900
         IHADVA DSECT=NO           MAP DEVTYPE DATA                     00189000
*                                                                       00189100
         ORG   ,                                                        00189200
*                                                                       00189300
         LTORG                                                          00189400
*                                                                       00189500
         PRINT GEN                                                      00189600
*                                                                       00189700
*        CCW COMMAND CODE EQUATES FOR DISK I/O                          00189800
*                                                                       00189900
CCWNOOP  EQU   X'03'               NO OPERATION                         00190000
CCWTIC   EQU   X'08'               TRANSFER IN CHANNEL                  00190100
SEEK     EQU   X'07'               SEEK                                 00190200
SEEKC    EQU   X'0B'               SEEK CYL                             00190300
SEEKH    EQU   X'1B'               SEEK HEAD                            00190400
SEARKEQ  EQU   X'29'               SEARCH KEY EQUAL                     00190500
SEARKHE  EQU   X'69'               SEARCH KEY HIGH OR EQUAL             00190600
READHA   EQU   X'1A'               READ HOME ADDRESS                    00190700
READR0   EQU   X'16'               READ RECORD 0                        00190800
READC    EQU   X'12'               READ COUNT                           00190900
READDATA EQU   X'06'               READ DATA                            00191000
READKD   EQU   X'0E'               READ KEY AND DATA                    00191100
READCKD  EQU   X'1E'               READ COUNT, KEY AND DATA             00191200
SETSECT  EQU   X'23'               SET SECTOR                           00191300
SETFM    EQU   X'1F'               SET FILE MASK                        00191400
READSECT EQU   X'22'               READ SECTOR                          00191500
SEARIDEQ EQU   X'31'               SEARCH IDENTIFIER EQUAL              00191600
*                                                                       00191700
SENSE    EQU   X'04'               SENSE                                00191800
WRITEDAT EQU   X'05'               WRITE DATA                           00191900
WRITEKD  EQU   X'0D'               WRITE KEY AND DATA                   00192000
WRITECKD EQU   X'1D'               WRITE COUNT, KEY, AND DATA           00192100
*                                                                       00192200
READEVCH EQU   X'64'               READ DEVICE CHARACTERISTICS          00192300
*                                  (64 BYTES)                           00192400
READMCKD EQU   X'5E'               READ MULTIPLE COUNT, KEY, AND DATA   00192500
MT       EQU   X'80'               'MULTI-TRACK' USE WITH APPROPRIATE   00192600
*                                  OPCODES AS -  CCW   SEARKHE+MT,B,C,D 00192700
*                                                                       00192800
*        CCW COMMAND CODE EQUATES FOR                                   00192900
*        IBM 7443 SERVICE RECORD FILE (SRF)                             00193000
*                                                                       00193100
SRFENAB  EQU   X'A3'                                                    00193200
SRFDIS   EQU   X'C3'                                                    00193300
SRFRDCPU EQU   X'FE'                                                    00193400
SRFVERB  EQU   X'69'                                                    00193500
SRFREAD  EQU   X'32'                                                    00193600
*                                                                       00193700
*        CCW FLAG EQUATES                                               00193800
*                                                                       00193900
CD       EQU   X'80'               CHAIN DATA                           00194000
CC       EQU   X'40'               CHAIN COMMAND                        00194100
SLI      EQU   X'20'               SUPPRESS INCORRECT LENGTH INDICATION 00194200
SKIP     EQU   X'10'               SKIP TRANSFER OF DATA                00194300
*                                                                       00194400
*        CSW FLAG EQUATES                                               00194500
*                                                                       00194600
*        UNIT STATUS BYTE                                               00194700
*                                                                       00194800
CUE      EQU   X'20'               CONTROL UNIT END                     00194900
CUB      EQU   X'10'               CONTROL UNIT BUSY                    00195000
CE       EQU   X'08'               CHANNEL END                          00195100
DE       EQU   X'04'               DEVICE END                           00195200
UC       EQU   X'02'               UNIT CHECK                           00195300
UE       EQU   X'01'               UNIT EXCEPTION                       00195400
*                                                                       00195500
*        CHANNEL STATUS BYTE                                            00195600
*                                                                       00195700
PCI      EQU   X'80'               PROGRAM CONTROLLED INTERRUPT         00195800
IL       EQU   X'40'               INCORRECT LENGTH                     00195900
PC       EQU   X'20'               PROGRAM CHECK                        00196000
PROTC    EQU   X'10'               PROTECTION CHECK                     00196100
CDC      EQU   X'08'               CHANNEL DATA CHECK                   00196200
CCC      EQU   X'04'               CHANNEL CONTROL CHECK                00196300
ICC      EQU   X'02'               INTERFACE CONTROL CHECK              00196400
CHK      EQU   X'01'               CHAINING CHECK                       00196500
*                                                                       00196600
*        REGISTER EQUATES                                               00196700
*                                                                       00196800
R0       EQU   0                                                        00196900
R1       EQU   1                                                        00197000
R2       EQU   2                                                        00197100
R3       EQU   3                                                        00197200
R4       EQU   4                                                        00197300
R5       EQU   5                                                        00197400
R6       EQU   6                                                        00197500
R7       EQU   7                                                        00197600
R8       EQU   8                                                        00197700
R9       EQU   9                                                        00197800
R10      EQU   10                                                       00197900
R11      EQU   11                                                       00198000
R12      EQU   12                                                       00198100
R13      EQU   13                                                       00198200
R14      EQU   14                                                       00198300
R15      EQU   15                                                       00198400
*                                                                       00198500
         PRINT NOGEN                                                    00198600
*                                                                       00198700
*        IEZDEB                                                         00198800
*                                                                       00198900
         IEZDEB                                                         00199000
*                                                                       00199100
*        IHADVCT - DEVICE CHARACTERISTICS TABLE                         00199200
*                                                                       00199300
         IHADVCT                                                        00199400
*                                                                       00199500
*        UCB                                                            00199600
*                                                                       00199700
UCB      DSECT                                                          00199800
*                                                                       00199900
         IEFUCBOB                                                       00200000
*                                                                       00200100
*        CVT                                                            00200200
*                                                                       00200300
         CVT   DSECT=YES,PREFIX=YES                                     00200400
*                                                                       00200500
*        TCB                                                            00200600
*                                                                       00200700
         IKJTCB                                                         00200800
*                                                                       00200900
*        TIOT                                                           00201000
*                                                                       00201100
TIOT     DSECT                                                          00201200
*                                                                       00201300
         IEFTIOT1                                                       00201400
*                                                                       00201500
*        DCB                                                            00201600
*                                                                       00201700
         DCBD  DSORG=PS,DEVD=(DA)                                       00201800
*                                                                       00201900
*        ECB                                                            00202000
*                                                                       00202100
         IHAECB                                                         00202200
*                                                                       00202300
         PRINT GEN                                                      00202400
*                                                                       00202500
         END   IFCDIP00                                                 00202600
/*
//*
//STEP3   EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
  IDENTIFY IFCDIP00('ZP60036')
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP4   EXEC SMPREC,WORK='SYSALLDA'
//SMPPTFIN DD  DSN=&&SMPMCS,DISP=(OLD,DELETE)
//SMPCNTL  DD  *
  RECEIVE
          SELECT(ZP60036)
          .
/*
//*
//STEP5CK EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60036)
        CHECK
        .
/*
//*
//STEP5   EXEC SMPAPP,COND=(0,NE),WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60036)
        DIS(WRITE)
        .
/*
//
//ZP60037  JOB (SYSGEN),'J02 M48: ZP60037',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*  SUPPORT ANY MVS-SUPPORTED DASD FOR LOGREC - SYSMOD 3 OF 3
//*
//STEP1   EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
++USERMOD(ZP60037)          /* FIX LOGREC DEVICE TYPE SUPPORT */  .
++VER(Z038) FMID(EER1400)
 /*
   PROBLEM DESCRIPTION:
     MVS DOES NOT SUPPORT SYS1.LOGREC ON ALL DASD DEVICE TYPES.
       THE DASD DEVICE TYPES THAT EREP I/O SERVICES SUPPORTS IS
       HARD-CODED WITHIN THE MODULE.  THIS MEANS THAT IN ORDER TO
       MAINTAIN A FUNCTIONING LOGREC FACILTY THE SYSTEM RESIDENCE
       VOLUME IS LIMITED TO THE ORIGINAL SET OF DASD DEVICE TYPES
       AND CANNOT BE MIGRATED TO EXPLOIT LARGER VOLUME GEOMETRIES
       AS SUPPORT FOR NEWER DEVICES IS ADDED TO MVS.

       THIS USERMOD SHIPS A VERSION OF IFCIOHND WHICH USES THE MVS
       TRKCALC SERVICE TO OBTAIN DASD GEOMETRY DEPENDENT DETAILS
       INSTEAD OF PRE-CODED VALUES SO THAT NOW IT SUPPORTS ANY
       DASD DEVICE TYPE SUPPORTED BY THE SYSTEM.

   SPECIAL CONDITIONS:
     NONE.

   COMMENTS:
     PRYCROFT SIX P/L PUBLIC DOMAIN USERMOD FOR MVS 3.8 NUMBER 37.

     THIS IS SYSMOD NUMBER 3 OF 3 IN A PACKAGE TO GENERALIZE LOGREC
     DASD SUPPORT WRITTEN BY TOM ARMSTRONG.  ALL 3 SYSMODS SHOULD BE
     ACTIVATED IN THE SAME IPL.  THE SYSMOD DETAILS ARE:
      +---------+----------+---------+------+-----------------------+
      | USERMOD | MODULE   | FMID    | COMP | MODULE FUNCTION       |
      +---------+----------+---------+------+-----------------------+
      | ZP60035 | IFBSVC76 | EBB1102 | BCP  | LOGREC WRITER         |
      | ZP60036 | IFCDIP00 | FBB1221 | SU64 | LOGREC INITIALIZATION |
      | ZP60037 | IFCIOHND | EER1400 | EREP | EREP I/O SERVICES     |
      +---------+----------+---------+------+-----------------------+

     THE FOLLOWING MODULES AND/OR MACROS ARE AFFECTED BY THIS USERMOD:
     MODULES:
       IFCIOHND
 */.
++MOD(IFCIOHND) DISTLIB(AOSCD).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(NEW,PASS),UNIT=SYSALLDA,
//             SPACE=(CYL,3),
//             DCB=(DSORG=PS,RECFM=FB,LRECL=80,BLKSIZE=4080)
//SYSIN    DD  DUMMY
//*
//STEP2   EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT)'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  *
         TITLE 'IFCIOHND - IO SERVICES MODULE FOR IFCEREP1'             00000100
*                                                                       00000200
*        NAME - IFCIOHND                                                00000300
*                                                                       00000400
*        STATUS -                                                       00000500
*        SOURCE CODE AS DISTRIBUTED WAS UPDATED BY DISASSEMBLY          00000600
*        TO REFLECT THE OWNING FMID OF EER1400. THE LOAD MODULE         00000700
*        ASSEMBLED FROM THE UPDATED SOURCE MATCHED THE MVS 3.8J         00000800
*        DISTRIBUTION MODULE PRIOR TO THE ENHANCEMENTS AS LISTED        00000900
*        BELOW                                                          00001000
*                                                                       00001100
*        ENHANCEMENTS -                                                 00001200
*        1. REMOVAL OF THE DASD GEOMETRY DATA TABLE                     00001300
*        2. ALL DASD GEOMETRY DATA IS OBTAINED DYNAMICALLY              00001400
*           FROM IECZDTAB AND/OR CALCULATED BY THE TRKCALC SERVICE      00001500
*        3. IFCIOHND WILL RE-INITIALIZE A LOGREC DATASET ON             00001600
*           ANY DASD SUPPORTED BY THE EXECUTING MVS 3.8 SYSTEM          00001700
*        4. USE OF STANDARD SYSTEM MAPPING MACROS                       00001800
*        5. NUMEROUS CHANGES TO IMPROVE SOURCE READABILITY              00001900
*        6. STANDARDIZED USE OF BASE REGISTERS                          00002000
*        7. Z/OS APAR #IO19631 HAS BEEN RETROFITTED TO IFCIOHND.        00002100
*           USERS WITH READ-ONLY ACCESS CAN NOW RUN IFCEREP1 IF         00002200
*           ZERO=N SPECIFIED OR DEFAULTED. WITH READ-ONLY ACCESS        00002300
*           AN ATTEMPT TO UPDATE THE LOGREC DATA SET BY SPECIFYING      00002400
*           ZERO=Y WILL RECEIVE A RACF ABENDS913.                       00002500
*                                                                       00002600
IFCIOHND CSECT                                                          00002700
*                                                                       00002800
         SAVE  (14,12),,'IFCIOHND ZP60037 &SYSDATE &SYSTIME'            00002900
*                                                                       00003000
         LA    R8,0(,R15)                                               00003100
         LA    R15,1                                                    00003200
         LA    R9,4095(R15,R8)                                          00003300
         LA    R10,4095(R15,R9)                                         00003400
         LA    R11,4095(R15,R10)                                        00003500
*                                                                       00003600
         USING IFCIOHND,R8,R9,R10,R11                                   00003700
*                                                                       00003800
         ST    R13,@SA00001+4                                           00003900
         LA    R14,@SA00001                                             00004000
         ST    R14,8(,R13)              CHAIN SAVE AREAS                00004100
         LR    R13,R14                                                  00004200
*DCL ADDNUM(1) CHAR(1) BASED(ADDNXT);                                   00004300
*DCL NEXTBY FIXED(31) INIT(0);                                          00004400
*DCL ADDNXT FIXED(31) INIT(0);                                          00004500
*DCL NUMBER FIXED(31) INIT(0);                                          00004600
*DCL GETTIT CHAR(4) DEFINED(GETHIS); /*ALPHA ACCESS OF GETHIS*/         00004700
*DCL LISTPTR PTR(31) BASED(PTRSPOT); /*POINTER TO LIST PARAMETER*/      00004800
*DCL INARG  FIXED(15) BASED(LISTPTR); /*INPUT PARAMETER WITH         */ 00004900
*                                     /*SERVICE REQUESTED CODE*/        00005000
*DCL LINECTT FIXED(15) INIT(0); /*RUNNING LINE COUNT FOR PAGE SKIPIN */ 00005100
*DCL LINEMAX FIXED(15) INIT(0); /*MAXIMUM LINES PER PAGE, TOURIST*/     00005200
*DCL CCSAVE  CHAR(1) INIT(' '); /*CARRIAGE CONTROL CHAR SAVE SPOT*/     00005300
*DCL BLANKS CHAR(134) INIT(' '); /*BLANKS FOR PRINT LINE                00005400
*DCL MSGNO  FIXED(31)  INIT(0); /*MESSAGE TEXT INDEX                    00005500
*DCL BADNEWS FIXED(31) INIT(0); /*RETURN CODE SAVE ITEM                 00005600
*DCL PACKPAS  CHAR(4) INIT('    ');                                     00005700
*DCL CHARPAS  CHAR(8) INIT('        ');                                 00005800
*DCL PASSNUM  FIXED(31) INIT(0);                                        00005900
*DCL EDIFILD(9) CHAR(1);                                                00006000
*DCL EDFLD CHAR(9) DEFINED(EDIFILD);                                    00006100
*DCL CTPTR(10) FIXED(31) DEFINED(CONTPTR);                              00006200
*/********************************************************************/ 00006300
*DCL CLOSEALL BIT(16) CONSTANT('FFFF'X); /*EOF ALL CLOSED MASK*/        00006400
*DCL SKIPNEW BIT(8) CONSTANT('8B'X);          /* SKIP TO CHANNEL ONE*/  00006500
*DCL NODSETS BIT(16) CONSTANT('0000'X); /*NO DATA SETS ASKED OPEN*/     00006600
*DCL DBLWORD BIT(32) CONSTANT('00000007'X); /*NO DOUBLE WORD MASK*/     00006700
*DCL NULL    BIT(32) CONSTANT('00000000'X);                             00006800
*DCL CHARZERO BIT(8) CONSTANT('F0'X);                                   00006900
*DCL BLANK    BIT(8) CONSTANT('40'X);                                   00007000
*/********************************************************************/ 00007100
*DCL  1  IOPLINE  CHAR(134)  BASED(PRINTADR), /*PRINT WORK AREA DSECT*/ 00007200
*      2 PRINTDS  CHAR(1), /*DATA SET IS ERREPT IF F0                */ 00007300
*                          /*DATA SET IS TOURIST IF F1               */ 00007400
*      2 PRINTCC  CHAR(1), /*CARRIAGE CONTROL CHARACTER, IGNORED*/      00007500
*                          /*IF FROM USER FOR TOURIST DATA SET*/        00007600
*      2 PRINTBDY CHAR(132); /*LINE TO BE PRINTED, WILL BE CLEARED*/    00007700
*                            /*TO BLANKS BEFORE RETURN TO USER*/        00007800
*/********************************************************************/ 00007900
*DCL PRNTBF CHAR(134) BDY(DWORD); /*INTERNAL PRINT LINE BUFFER*/        00008000
*/********************************************************************/ 00008100
*DCL 1  BUF1 BDY(DWORD), /*WORK AREA FOR QSAM RECORDS                */ 00008200
*     2 BUF1RDW, /*RECORD DESCRIPTOR WORD                            */ 00008300
*     3 BUF1RDWL FIXED(15) INIT(0), /*QSAM RECORD LENGTH             */ 00008400
*     3 BUF1L    FIXED(15) INIT(0), /*QSAM ZEROS                     */ 00008500
*     2 BUF1DTA  CHAR(2000);    /*MAXIMUM SYS1.LOGREC RECORD LENGTH*/   00008600
*/*******************************************************************/  00008700
*DCL  1 RECTB BASED(RUNPTR), /*ZEROALL RECORD SAVE AREA DSECT*/         00008800
*     2 FORPTR  PTR(31),                                                00008900
*     2 JUNK,                                                           00009000
*     3 JUNK1   CHAR(5),                                                00009100
*     3 JUNK2   CHAR(1),                                                00009200
*     3 JUNK3   FIXED(15),                                              00009300
*     2 RECSPT  CHAR(1894);                                             00009400
*/*******************************************************************/  00009500
* DCL 1 IOSWTCH CHAR(3) INIT('000000'X), /*NEW SWITCHES              */ 00009600
*     2 HISTOPN BIT(1), /*OUTPUT HIST IS OPENED FLAG                 */ 00009700
*     2 SECGET   BIT(1), /*ZEROALL GETMAIN SWITCH                    */ 00009800
*     2 FLIPFLOP BIT(1), /*OFF SERLOG READSEQ, ON ACCIN READSEQ      */ 00009900
*     2 HISTYES BIT(1), /*INDICATES ACCIN INPUT SPECIFIED            */ 00010000
*     2 DBLYES  BIT(1), /*DOUBLE WORD CREATION LOOP EXIT SWITCH      */ 00010100
*     2 LASTLOOP BIT(1),  /*ZEROALL PROCESSING                       */ 00010200
*     2 TOURERR BIT(1), /*ERROR WITH TOURIST DATA SET                */ 00010300
*     2 INHISO  BIT(1), /*INPUT HIST IS IPENED FLAG                  */ 00010400
*     2 SERLO   BIT(1), /*SERLOG IS OPENED FLAG                      */ 00010500
*     2 TWOTRY  BIT(1), /*OFF IMPLIES 1ST EOF READING SERLOG SEQ     */ 00010600
*     2 INDIR   BIT(1), /*DIRECTWK IS OPENED FOR SEQ WRITE           */ 00010700
*     2 NONBLANK BIT(1), /*NONBLANK LOOP FINDER SWITCH               */ 00010800
*     2 CLOSE2  BIT(1), /*DIRECTWK IS OPENED FOR DIR WRITE           */ 00010900
*     2 SYSOPN  BIT(1), /*SYSIN IS OPENED SWITCH                     */ 00011000
*     2 TOUROPN  BIT(1), /*TOURIST DS IS OPENED SWITCH               */ 00011100
*     2 ERPTOPN  BIT(1), /*REGULAR PRINT D.S. HAS BEEN OPENED        */ 00011200
*     2 READFR   BIT(1), /*FRAMES ARE BEING READ SWITCH              */ 00011300
*     2 SCRATCH  BIT(1), /*LAST OPERATION WAS READ DIRECT            */ 00011400
*     2 SNAPOP  BIT(1); /*SNAP DS HAS BEEN OPENED SWITCH             */ 00011500
*/********************************************************************/ 00011600
*DCL    1   HDRBUFF   CHAR(64) BDY(DWORD),   /* EXTRACTOR WORK AREA  */ 00011700
*          2   HDRSEEK             CHAR(8),  /* SEEK FIELD FOR I/O   */ 00011800
*             3   HDRM             CHAR(1) INIT('00'X),                 00011900
*             3   HDRBB            CHAR(2) INIT('0000'X),               00012000
*             3   HDRCC            CHAR(2) INIT('0000'X),               00012100
*             3   HDRHH            CHAR(2) INIT('0000'X),               00012200
*             3   HDRR             CHAR(1) INIT('00'X),                 00012300
*                                                                       00012400
*        LOGREC HEADER RECORD -                                         00012500
*                                                                       00012600
*       *************************************************************** 00012700
*       *              *                                *     HIGH    * 00012800
*  +0   *  F F F F     *          LOW EXTENT            *   EXTENT    * 00012900
*       *              *            (CCHH)              *      (CC)   * 00013000
*       *************************************************************** 00013100
*       * HIGH EXTENT  *       *         RECORD ENTRY AREA ADDRESS    * 00013200
*  +8   *   (CONT.)    * SPARE *                (BBCCHHR)             * 00013300
*       *    (HH)      *       *                                      * 00013400
*       *************************************************************** 00013500
*       *  REC. ENTRY  *  REMAINING     *  TOTAL BYTES  *  ADDRESS OF * 00013600
*  +16  * AREA ADDR.   *   BYTES ON     *      ON       *  LAST RECORD* 00013700
*       *    (CONT.)   *     TRACK      *    TRACK      *    WRITTEN  * 00013800
*       *************************************************************** 00013900
*       *           ADDRESS OF LAST RECORD       * TRACKS      * EARLY* 00014000
*  +24  *                WRITTEN (CONT.)         *    PER      * WARN.* 00014100
*       *                                        * CYLINDER    * 90%  * 00014200
*       *************************************************************** 00014300
*       * EARLY * DEV- *     EARLY WARNING              * EARLY*  CK. * 00014400
*  +32  * WARN. *  ICE *               MESSAGE TRACK    * WARN.* BYTE * 00014500
*       * L TRK * CODE *                                * SWT. * (FF) * 00014600
*       *************************************************************** 00014700
*                                                                       00014800
*                                                                       00014900
*          2   PREVSEEK            CHAR(8),  /* PREVIOUS SEEK FIELD  */ 00015000
*             3   PREVM            CHAR(1) INIT('FF'X), /* FF=CLOSED */ 00015100
*             3   PREVBB           CHAR(2),                             00015200
*             3   PREVCC           CHAR(2),                             00015300
*             3   PREVHH           CHAR(2),                             00015400
*             3   PREVR            CHAR(1);                             00015500
*DCL     LOGRECA    CHAR(11) INIT('SYS1.LOGREC'); /* ENQUE/DEQUE     */ 00015600
*DCL     LOGRECB    CHAR(8)  INIT('RECORDER');    /* NAMES FOR SYSTEM*/ 00015700
*DCL     RESID      CHAR(8)  INIT('SERLOG');      /* & STEP ENQ/DEQ  */ 00015800
*DCL     RESIDII    CHAR(8)  INIT('LOGREC');      /*                 */ 00015900
*DCL     SDRK  FIXED(15) INIT(0);                                       00016000
*DCL     ZEROA CHAR(24);                                                00016100
*DCL 1 SEEKSAVE CHAR(8) INIT('0000000000000000'X), /*BEGINNING OF LOG*/ 00016200
*    2 *      CHAR(7),                                                  00016300
*    2 SKSAVREC CHAR(1); /*R PORTION OF MBBCCHHR                     */ 00016400
*/********************************************************************/ 00016500
*/*                                                                  */ 00016600
*/*      CONSTANTS & WORK AREAS FOR TIME/DATE CONVERSION             */ 00016700
*/*                                                                  */ 00016800
*/********************************************************************/ 00016900
*/*                                                                  */ 00017000
*/*      DSECT OF INPUT BUFFER                                       */ 00017100
*/*                                                                  */ 00017200
*DCL    1   BUFFER  DEFINED(BUF1), /*USE FOR SERLOP EXCP READS       */ 00017300
*          2   BCOUNT              CHAR(8),  /* COUNT AREA           */ 00017400
*             3   BCCHHR           CHAR(5),  /* COUNT FROM REC       */ 00017500
*             3   BKEYL            CHAR(1),  /* KEY LENGTH=0         */ 00017600
*             3   BSIZE            CHAR(2),  /* SIZE OF RECORD READ  */ 00017700
*          2   BDATA                 CHAR(1900);                        00017800
*DCL  BSZ FIXED(15) DEFINED(BSIZE); /*ACCESS BSIZE AS NUMERIC        */ 00017900
*DCL SAVELENT FIXED(15) INIT(0); /*DATA LENGTH + 4 FROM READSEQ      */ 00018000
*DCL  BBRDW CHAR(2) DEFINED(BCCHHR) POSITION(5); /*USE TO SHUFFLE    */ 00018100
*                                /*LOGREC RECORD INTO V FORMAT*/        00018200
*/*                                                                     00018300
*/*      DSCECT OF AN INPUT RECORD                                      00018400
*/*                                                                     00018500
*DCL    1   RECAREA              BASED(TIMEBASE),                       00018600
*          2   RECKEY              CHAR(1),                             00018700
*          2   *                   CHAR(1),                             00018800
*          2   *                   CHAR(6),                             00018900
*             3   *                 BIT(1),                             00019000
*             3   NSSWITCH          BIT(1),  /* NS TIME INDICATOR    */ 00019100
*             3   *                 BIT(2),                             00019200
*             3   LCSWITCH          BIT(1),  /* LOCAL TIME  INDICATOR*/ 00019300
*             3   *                 BIT(3),                             00019400
*          2   DATETIME            CHAR(8),                             00019500
*             3   DATE             CHAR(4),                             00019600
*                4   DATE0         CHAR(1),                             00019700
*                   5   GMTSW       BIT(1),                             00019800
*                   5   *           BIT(7),                             00019900
*                4   YEAR          CHAR(1),                             00020000
*                4   DAYS          CHAR(2),                             00020100
*             3   TIME             CHAR(4),                             00020200
*                4   HOURS         CHAR(1),                             00020300
*                4   MINS          CHAR(1),                             00020400
*                4   SECS          CHAR(1),                             00020500
*                4   TNTHS         CHAR(1);                             00020600
*                                                                       00020700
*/********************************************************************/ 00020800
*/*                                                                  */ 00020900
*/*      STARTING LOCATION FOR IFCIOHND                              */ 00021000
*/*                                                                  */ 00021100
*/********************************************************************/ 00021200
*                                      /*R2 HAS COMTABLE ADDRESS     */ 00021300
*PTRSPOT = R1; /*GET PARAMETER LIST ADDRESS OF ADDRESS               */ 00021400
         ST    R1,PTRSPOT                                               00021500
*SAVER2 = R2; /*PRESUME THAT R2 HAS ADDRESS OF COMTABLE AT THIS POINT*/ 00021600
         ST    R2,SAVER2                                                00021700
         USING IHADCB,R12      USE R12 FOR ADDRESSING DCBS              00021800
*BADNEWS = ZERO; /*RETURN CODE SAVE ITEM                             */ 00021900
         SLR   R3,R3                                                    00022000
         ST    R3,BADNEWS                                               00022100
*                                                                       00022200
*        DETERMINE THE SERVICE THE CALLER HAS REQUESTED AND             00022300
*        BRANCH TO APPROPRIATE ROUTINE                                  00022400
*                                                                       00022500
*IF INARG = READSEQ THEN /*IF READ OF SERLOG OR ACCIN REQUESTED*/       00022600
         L     R6,PTRSPOT                                               00022700
         L     R12,0(,R6)                                               00022800
         CLC   0(2,R12),KH3                                             00022900
         BNE   @RF00136                                                 00023000
*  CALL READSIT;                                                        00023100
         BAL   R14,READSIT                                              00023200
         B     GOBACK                                                   00023300
*ELSE                                                                   00023400
*  DO;                                                                  00023500
*    IF INARG = READIRCT THEN                                           00023600
@RF00136 L     R6,PTRSPOT                                               00023700
         L     R12,0(,R6)                                               00023800
         CLC   0(2,R12),KH6                                             00023900
         BNE   @RF00139                                                 00024000
*      CALL DIRECTIT; /*EXCP READ OF SERLOG OR POINT SEQ READ OF WORK*/ 00024100
         BAL   R14,DIRECTIT                                             00024200
         B     GOBACK                                                   00024300
*    ELSE                                                               00024400
*      DO;                                                              00024500
*        IF INARG = RITEHIST THEN                                       00024600
@RF00139 L     R6,PTRSPOT                                               00024700
         L     R12,0(,R6)                                               00024800
         CLC   0(2,R12),KH4                                             00024900
         BNE   @RF00142                                                 00025000
*          CALL HISTIT; /*QSAM WRITE TO ACCDEV, HISTORY OUTPUT*/        00025100
         BAL   R14,HISTIT                                               00025200
         B     GOBACK                                                   00025300
*        ELSE                                                           00025400
*          DO;                                                          00025500
*            IF INARG = RITESCRT THEN /*SEQUENTIAL NOTE WRITE TO WORK*/ 00025600
@RF00142 L     R6,PTRSPOT                                               00025700
         L     R12,0(,R6)                                               00025800
         CLC   0(2,R12),KH5                                             00025900
         BNE   @RF00145                                                 00026000
*              CALL SCRCHIT;                                            00026100
         BAL   R14,SCRCHIT                                              00026200
         B     GOBACK                                                   00026300
*            ELSE                                                       00026400
*              DO;                                                      00026500
*                IF INARG = RITEPRTR THEN                               00026600
@RF00145 L     R6,PTRSPOT                                               00026700
         L     R12,0(,R6)                                               00026800
         CLC   0(2,R12),KH2                                             00026900
         BNE   @RF00148                                                 00027000
*                  CALL PRINTIT;                                        00027100
         BAL   R14,PRINTIT                                              00027200
         B     GOBACK                                                   00027300
*                ELSE                                                   00027400
*                  DO;                                                  00027500
*                    IF INARG = IOOPEN THEN                             00027600
@RF00148 L     R6,PTRSPOT                                               00027700
         L     R12,0(,R6)                                               00027800
         CLC   0(2,R12),KH1                                             00027900
         BNE   @RF00151                                                 00028000
*                      CALL OPENIT;                                     00028100
         BAL   R14,OPENIT                                               00028200
         B     GOBACK                                                   00028300
*                    ELSE                                               00028400
*                      DO;                                              00028500
*                        IF INARG = IOCLOSE THEN                        00028600
@RF00151 L     R6,PTRSPOT                                               00028700
         L     R12,0(,R6)                                               00028800
         CLC   0(2,R12),KH7                                             00028900
         BNE   @RF00154                                                 00029000
*                          CALL CLOSIT;                                 00029100
         BAL   R14,CLOSIT                                               00029200
         B     GOBACK                                                   00029300
*                        ELSE                                           00029400
*                          DO;                                          00029500
*                                IF INARG = READCARD THEN               00029600
@RF00154 L     R6,PTRSPOT                                               00029700
         L     R12,0(,R6)                                               00029800
         CLC   0(2,R12),KH9                                             00029900
         BNE   @RF00157                                                 00030000
*                                  CALL REEDSYS;                        00030100
         BAL   R14,REEDSYS                                              00030200
         B     GOBACK                                                   00030300
*                                ELSE                                   00030400
*                                  DO;                                  00030500
*                                     MSGNO = 1;                        00030600
@RF00157 MVC   MSGNO(4),KF1                                             00030700
*                                     CALL ERRMSG;                      00030800
         BAL   R14,ERRMSG                                               00030900
*                                  END;                                 00031000
*                           END;                                        00031100
*                       END;                                            00031200
*                    END;                                               00031300
*                END;                                                   00031400
*             END;                                                      00031500
*          END;                                                         00031600
*       END;                                                            00031700
*GOBACK: ;                                                              00031800
*R15 = BADNEWS;                                                         00031900
GOBACK   L     R15,BADNEWS                                              00032000
*IF R15 > FOUR THEN /*FIND OUT IF USER CHECKING RETURN CODE          */ 00032100
         C     R15,KF4                                                  00032200
         BNH   @EL00001                                                 00032300
*  ERRORENT = ERRORENT + 1; /*USER BUNGLE IF MORE THAN ONE           */ 00032400
         LA    R6,1                                                     00032500
         AL    R6,ERRORENT                                              00032600
         ST    R6,ERRORENT                                              00032700
*RETURN;                                                                00032800
@EL00001 L     R13,4(,R13)                                              00032900
@ER00001 L     R14,12(,R13)                                             00033000
         LM    R0,R6,20(R13)             NOTE R7 NOT RESTORED           00033100
         LM    R8,R12,52(R13)                                           00033200
         BR    R14                                                      00033300
*                                                                       00033400
*        THIS IS A STRUCTURED PROC TO REPLACE EXCPLOOP                  00033500
*                                                                       00033600
*        OTHERWISE, THE ONLY CHANGES ARE THAT ALL REFERENCES TO         00033700
*        ZEROING INDIVIDUAL RECORDS HAVE BEEN REMOVED AND THE           00033800
*        LOCATION OF THE BEGINNING OF LOGREC FROM THE DEB IS            00033900
*        SAVED FOR INITIALIZATION TO READ FRAMES EXCP LOOP THAT         00034000
*        PERFORMS ALL IO OPERATIONS TO LOGREC.                          00034100
*                                                                       00034200
*        ONE CCW CHAIN IS USE FOR ALL THREE TYPES OF I-O                00034300
*        PERFORMED.                                                     00034400
*        IN ALL CASES, THE FIRST CCW IS A SEARCH FOR A                  00034500
*        PARTICULAR MBBCCHHR ACTUAL PHYSICAL LOCATION OF A RECORD       00034600
*        ON LOGREC ACCROSS THE ENTIRE EXTENT ALLOCATED TO               00034700
*        LOGREC.                                                        00034800
*        THE NEXT CCW IS A TIC WHICH LOOPS BACK TO THE SEARCH IF        00034900
*        THE SEARCH FOR A PARTICULAR RECORD WAS UNSUCCESSFUL            00035000
*        THE TYPES OF OPERATIONS WHICH ARE PERFORMED ARE:               00035100
*        1. CC= 6, READ LOGREC HEADER BY GIVING MBBCCHHR OF             00035200
*                  HEADER                                               00035300
*        2. CC= 5, WRITE HEADER OF SAME LENGTH BACK TO EXACT            00035400
*                  LOCATION SPECIFIED IN GIVEN MBBCCHHR.                00035500
*        3. CC= 158, READ THE NEXT ERROR RECORD AFTER THE RECORD        00035600
*                  WHOSE MBBCCHHR IS GIVEN IN THE SEARCH                00035700
*        R7 -> AREA TO PLACE THE RECORD READ                            00035800
*                                                                       00035900
*EXCPLOOP: PROC;                                                        00036000
EXCPLOOP STM   R14,R12,@SA00002                                         00036100
*CKDAREA = R7; /*SET UP CCW3 CORE ADDRESS TO READ RECORD TO          */ 00036200
         STCM  R7,7,CKDAREA                                             00036300
*AREAADR = ADDR(HDRCC); /*SEARCH ID FOR FIRST CCW                    */ 00036400
         LA    R14,HDRCC                                                00036500
         STCM  R14,7,AREAADR                                            00036600
*IF SBT4 = ON THEN     /*IF HEADER I/O HAS BEEN REQUESTED            */ 00036700
         TM    SBT4,B'00010000'                                         00036800
         BNO   @RF00180                                                 00036900
*  DO;                                                                  00037000
*    CKDCOUNT = 40;   /*3RD CCW NUMBER OF BYTES IN HEADER TO BE READ*/  00037100
         MVC   CKDCOUNT(2),KH40                                         00037200
*    IF SBT2 = ON THEN /*IF HEADER IS TO BE WRITTEN THEN             */ 00037300
         TM    SBT2,B'01000000'                                         00037400
         BNO   @RF00183                                                 00037500
*      CKDCOM = '05'X; /*SET 3RD CCW CHANNEL COMMAND TO WRITE IN PLACE* 00037600
         MVI   CKDCOM,X'05'                                             00037700
         B     @RC00183                                                 00037800
*                                                                       00037900
*    ELSE              /*IF HEADER IS TO BE READ                     */ 00038000
*      CKDCOM = '06'X; /*SET 3RD CCW CHANNEL COMMAND TO READ SAME    */ 00038100
*                      /*RECORD AS SEARCH ID EQUAL HAS FOUND         */ 00038200
@RF00183 MVI   CKDCOM,X'06'                                             00038300
*    HDRM = '00'X;                                                      00038400
@RC00183 MVI   HDRM,X'00'                                               00038500
*    HDRR = '01'X;    /*HEADER RECORD IS RECORD 1                    */ 00038600
         MVI   HDRR,X'01'                                               00038700
*                        /*SET LOGREC DCB DSECT BASE ADDRESS         */ 00038800
         LA    R12,LOGREC                                               00038900
*                         /*LOAD ADDRESS OF DEB FROM DCB FOR LOGREC*/   00039000
         L     R5,DCBDEBAD                                              00039100
*                                /*GET BBCCHH OF BEGINNING OF LOGREC*/  00039200
         MVC   HDRBB(6),DEBBINUM-DEBDASD+DEBBASND-DEBBASIC(R5)          00039300
*      /*FROM FIRST EXTENT DIRECT ACCESS EXTENSION TO THE DEB*/         00039400
*    SEEKSAVE = HDRSEEK; /*SAVE FOR USE WHEN READING FRAMES          */ 00039500
         MVC   SEEKSAVE(8),HDRSEEK                                      00039600
*    SKSAVREC = '02'X; /*INDICATE TIME STAMP AS RECORD BEFORE 1ST FRM*/ 00039700
         MVI   SEEKSAVE+7,X'02'                                         00039800
         B     @RC00180                                                 00039900
*  END;                                                                 00040000
*ELSE  /*IF NORMAL, NON HEADER, READ OF LOGREC                       */ 00040100
*  DO;                                                                  00040200
*    HDRSEEK = PREVSEEK; /*SET ADDRESS TO SEEK FROM COUNT FIELD OF */   00040300
*                        /*PREVIOUS RECORD                           */ 00040400
@RF00180 MVC   HDRSEEK(8),PREVSEEK                                      00040500
*    CKDCOM = '9E'X;  /*SET THIRD CCW CHANNEL COMMAND TO SEEK NEXT */   00040600
*                     /*RECORD AFTER RECORD WHOSE SEEK ID EQUAL IS */   00040700
*                     /*FOUND AS RESULT OF CCW1. DONE FOR SPEED*/       00040800
         MVI   CKDCOM,X'9E'                                             00040900
*    CKDCOUNT = 1944; /*SET NUMBER OF BYTES TO READ. INCORRECT LENGTH*/ 00041000
*                     /*ERRORS ARE SUPPRESSED                        */ 00041100
         MVC   CKDCOUNT(2),KH1944                                       00041200
*  END;                                                                 00041300
*XIOBSEEK = HDRSEEK; /*SET IOB SEEK ADDRESS                          */ 00041400
@RC00180 MVC   IOBSEEK,HDRSEEK                                          00041500
*XWRECB = 0;         /*ZERO THE EVENT CONTROL BLOCK                  */ 00041600
         SLR   R4,R4                                                    00041700
         ST    R4,XWRECB                                                00041800
*DO UNTIL POST Å= '44'X; /*LOOP UNTIL IO REQUEST NOT INTERCEPTED*/      0004190
*                  /*ISSUE SVC 0                                     */ 00042000
@DL00201 EXCP  XIOB                                                     00042100
*                        /*WAIT FOR COMPLETION OF IO                 */ 00042200
         WAIT  ECB=XWRECB                                               00042300
*END;                                                                   00042400
         CLI   POST,X'44'                                               00042500
         BE    @DL00201                                                 00042600
*END;                                                                   00042700
         LM    R14,R12,@SA00002                                         00042800
         BR    R14                                                      00042900
*                                                                       00043000
*READSER: PROC OPTIONS (DONTSAVE(7)); /*READ SYS1.LOGREC SEQUENTIALLY*/ 00043100
READSER  STM   R14,R6,@SA00003                                          00043200
         STM   R8,R12,@SA00003+36                                       00043300
*                                                                       00043400
*        PROC HAS BEEN REWRITTEN TO HANDLE READING OF FRAMES AT         00043500
*        END OF OF FILE FOR ERROR RECORDS, IF FRAMES EXIST.             00043600
*        THE PROC IS NOW STRUCTURED                                     00043700
*                                                                       00043800
*RSEQCNT = RSEQCNT + 1; /*COUNT NUMBER OF READ ATTEMPTS              */ 00043900
         LA    R6,1                                                     00044000
         AL    R6,RSEQCNT                                               00044100
         ST    R6,RSEQCNT                                               00044200
*IF SERLO = YES THEN    /*IF SYS1.LOGREC IS OPEN THEN                */ 00044300
         TM    IOSWTCH+1,SERLO                                          00044400
         BNO   @RF00210                                                 00044500
*  DO;                                                                  00044600
*    IF READFR = OFF THEN /*IF READING ERROR RECORDS                 */ 00044700
         TM    IOSWTCH+2,READFR                                         00044800
         BNZ   @RF00212                                                 00044900
*      DO;                                                              00045000
*        IF PREVSEEK(2:8) = HDRLASTR THEN /*IF CURRENT SEEK ADDRESS */  00045100
*      /*IS EQUAL TO LAST ACTIVE RECORD SEEK ADDRESS, IMPLICATION IS */ 00045200
*         /*THAT THIS LAST RECORD HAS ALREADY BEEN READ              */ 00045300
         CLC   PREVSEEK+1(7),HDRLASTR                                   00045400
         BNE   @RC00212                                                 00045500
*          DO;                                                          00045600
*            IF TWOTRY = NO & /*SECOND TRY FOR EOF ON SEQUENTIAL INPT*/ 00045700
*               LASTLOOP = NO THEN /*NOT AN END OF FILE SAVING OF    */ 00045800
         TM    IOSWTCH+1,TWOTRY                                         00045900
         BNZ   @RF00216                                                 00046000
         TM    IOSWTCH,LASTLOOP                                         00046100
         BNZ   @RF00216                                                 00046200
*                                  /*RECORDS DURING ZERO ALL PROCESS*/  00046300
*              DO;                                                      00046400
*                TWOTRY = YES; /*SET SECOND SEQUENTIAL READ TRY FLAG*/  00046500
         OI    IOSWTCH+1,TWOTRY                                         00046600
*                CALL CHECKHDR; /*ANY RECORDS WRITTEN WHILE READING?*/  00046700
         BAL   R14,CHECKHDR                                             00046800
*                IF BADNEWS = FOUR &    /*IF NO NEW RECORDS WRITTEN*/   00046900
*                   FRAMES  = YES THEN  /*AND FRAMES EXIST ON LOGREC*/  00047000
         CLC   BADNEWS(4),KF4                                           00047100
         BNE   @RC00212                                                 00047200
         TM    HDREWSW,FRAMES                                           00047300
         BNO   @RC00212                                                 00047400
*                  DO;                                                  00047500
*                    BADNEWS = ZERO; /*INDICATE NO END OF FILE YET*/    00047600
         SLR   R12,R12                                                  00047700
         ST    R12,BADNEWS                                              00047800
*                    READFR = YES; /*SET READ FRAME SWITCH           */ 00047900
         OI    IOSWTCH+2,READFR                                         00048000
*                    IF DEBUG15 = ON THEN /*IF DEBUG 15 MONITORING*/    00048100
         L     R14,SAVER2                                               00048200
         TM    DEBUG15(R14),B'00000001'                                 00048300
         BNO   @RF00224                                                 00048400
*                      DO;                                              00048500
*                        MSGNO = 70; /*START OF FRAME READ MONITOR*/    00048600
         MVC   MSGNO(4),KF70                                            00048700
*                        CALL ERRMSG; /*PRINT MESSAGE TO TOURIST*/      00048800
         BAL   R14,ERRMSG                                               00048900
*                      END;                                             00049000
*                    PREVSEEK = SEEKSAVE; /*GET TIME STAMP LOCATION*/   00049100
@RF00224 MVC   PREVSEEK(8),SEEKSAVE                                     00049200
         B     @RC00212                                                 00049300
*                                                                       00049400
*                  END;                                                 00049500
*              END;                                                     00049600
*            ELSE  /*EITHER SECOND END OF FILE OR ZEROALL PROCESSING*/  00049700
*              DO;                                                      00049800
*                IF FRAMES = YES &    /*DO FRAMES EXIST ON SERLOG*/     00049900
*                   LASTLOOP = NO THEN /*NOT ZEROALL PROCESSING  */     00050000
@RF00216 TM    HDREWSW,FRAMES                                           00050100
         BNO   @RF00233                                                 00050200
         TM    IOSWTCH,LASTLOOP                                         00050300
         BNZ   @RF00233                                                 00050400
*                  DO;                                                  00050500
*                    READFR = YES; /*SET READING FRAMES SWITCH*/        00050600
         OI    IOSWTCH+2,READFR                                         00050700
*                    IF DEBUG15 = ON THEN /*IF DEBUG15 MONITORING*/     00050800
         L     R6,SAVER2                                                00050900
         TM    DEBUG15(R6),B'00000001'                                  00051000
         BNO   @RF00236                                                 00051100
*                      DO;                                              00051200
*                        MSGNO = 70; /*START OF FRAME READ MESSAGE*/    00051300
         MVC   MSGNO(4),KF70                                            00051400
*                        CALL ERRMSG; /*WRITE MESSAGE TO TOURIST*/      00051500
         BAL   R14,ERRMSG                                               00051600
*                      END;                                             00051700
*                    PREVSEEK = SEEKSAVE; /*GET STARTING LOCATION*/     00051800
*                    /*OF LOGREC FROM DEB. IMPLICATION IS THAT   */     00051900
*                    /*1ST FRAME MUST BE ON SAME TRACK AS HEADER */     00052000
@RF00236 MVC   PREVSEEK(8),SEEKSAVE                                     00052100
*                   END;                                                00052200
*                 ELSE  /*LEGITIMATE END OF FILE                     */ 00052300
*                   BADNEWS = FOUR; /*INDICATE EOF TO WORLD          */ 00052400
         B     @RC00212                                                 00052500
*                                                                       00052600
@RF00233 MVC   BADNEWS(4),KF4                                           00052700
         B     @RC00212                                                 00052800
*               END;                                                    00052900
*           END;                                                        00053000
*      END;                                                             00053100
*    ELSE  /*FRAMES ARE BEING READ                                   */ 00053200
*      DO;                                                              00053300
*        IF PREVSEEK(2:8) = HDRREA THEN /*IF SEEK ADDRESS FOR        */ 00053400
*          /*PREVIOUS RECORD IS EQUAL TO SEEK ADDRESS OF LAST FRAME  */ 00053500
*          /*THEN END OF FILE ON LOGREC HAS BEEN REACHED             */ 00053600
@RF00212 CLC   PREVSEEK+1(7),HDRREA                                     00053700
         BNE   @RF00248                                                 00053800
*          BADNEWS = FOUR; /*INDICATE END OF FILE                    */ 00053900
         MVC   BADNEWS(4),KF4                                           00054000
         B     @RC00212                                                 00054100
*                                                                       00054200
*        ELSE  /*NOT LAST FRAME                                      */ 00054300
*          RFRCOUNT = RFRCOUNT + 1; /*COUNT FRAMES FOR DEBUG16 TOTAL*/  00054400
@RF00248 LA    R12,1                                                    00054500
         AL    R12,RFRCOUNT                                             00054600
         ST    R12,RFRCOUNT                                             00054700
*      END;                                                             00054800
*    IF BADNEWS = ZERO THEN /*IF NO EOF OR ERROR CONDITIONS THEN*/      00054900
@RC00212 L     R14,BADNEWS                                              00055000
         LTR   R14,R14                                                  00055100
         BNZ   @ER00003                                                 00055200
*      DO;                                                              00055300
*        R7 = ADDR(BUF1); /*ADDRESS READ BUFFER                      */ 00055400
         LA    R7,BUF1                                                  00055500
*        CALL EXCPLOOP; /*ISSUE EXCP READ                            */ 00055600
         BAL   R14,EXCPLOOP                                             00055700
*        IF POST \= '7F'X THEN /*IF UNSUCCESSFULL READ               */ 00055800
         CLI   POST,X'7F'                                               00055900
         BE    @RF00256                                                 00056000
*          DO;                                                          00056100
*            IF POST = '42'X THEN /*OUT OF LOGREC EXTENT ERROR*/        00056200
         CLI   POST,X'42'                                               00056300
         BNE   @RF00258                                                 00056400
*              MSGNO = 14;                                              00056500
         MVC   MSGNO(4),KF14                                            00056600
         B     @RC00258                                                 00056700
*                                                                       00056800
*            ELSE   /* HARD I-O ERROR                                */ 00056900
*              MSGNO = 39;                                              00057000
@RF00258 MVC   MSGNO(4),KF39                                            00057100
*            CALL ERRMSG;                                               00057200
@RC00258 BAL   R14,ERRMSG                                               00057300
*            BADNEWS = TWELVE;                                          00057400
         MVC   BADNEWS(4),KF12                                          00057500
         B     @ER00003                                                 00057600
*                                                                       00057700
*          END;                                                         00057800
*        ELSE /*SUCCESSFUL READ                                      */ 00057900
*          DO;                                                          00058000
*            PREVCC(1:5) = BCOUNT; /*DIRECT ACCESS ADDRESS,CCHHR,*/     00058100
*           /*OF RECORD LAST READ FROM COUNT RECORD PRECEEDING DATA*/   00058200
*           /*RECORD ON COUNT,DATA FORMATTED DIRECT ACCESS FILE*/       00058300
@RF00256 MVC   PREVCC(5),BCOUNT                                         00058400
*            FLIPFLOP = NO; /*INDICATE SEQUENTIAL INPUT FROM LOGREC,*/  00058500
*                           /* AND NOT FROM HISTORY INPUT            */ 00058600
         NI    IOSWTCH,255-FLIPFLOP                                     00058700
*            RECCCHHR = BCOUNT; /*PASS SAME VALUE TO USER VIA PARM*/    00058800
         L     R12,SAVER2                                               00058900
         MVC   RECCCHHR(5,R12),BCOUNT                                   00059000
*            RECLNGTH = BSIZE; /*PASS RECORD LENGTH FROM COUNT RECRD*/  00059100
         LH    R14,BSIZE                                                00059200
         N     R14,KX00FFFF                                             00059300
         STH   R14,RECLNGTH(,R12)                                       00059400
*            SAVELENT = BSIZE + 4; /*SAVE RECORD QSAM LENGTH FOR */     00059500
         LA    R14,4(,R14)                                              00059600
         STH   R14,SAVELENT                                             00059700
*                                  /*RITESCRT,RITEHIST               */ 00059800
*            R7 = ADDR(BDATA); /*BKEY IS DATA PORTION OF RECORD SINCE*/ 00059900
         LA    R7,BDATA                                                 00060000
*            TIMEBASE = R7; /*TELL TIME CONVERSION WHERE RECORD IS*/    00060100
         ST    R7,TIMEBASE                                              00060200
*            CALL CONVTIME; /*CONVERT TIME, IF NECESSARY             */ 00060300
         BAL   R14,CONVTIME                                             00060400
         B     @ER00003                                                 00060500
*                                                                       00060600
*          END;                                                         00060700
*      END;                                                             00060800
*  END;                                                                 00060900
*ELSE /*IF LOGREC HAS NOT BEEN OPENED                                */ 00061000
*  DO;                                                                  00061100
*    MSGNO = 47;                                                        00061200
@RF00210 MVC   MSGNO(4),KF47                                            00061300
*    CALL ERRMSG;                                                       00061400
         BAL   R14,ERRMSG                                               00061500
*    BADNEWS = TWELVE;                                                  00061600
         MVC   BADNEWS(4),KF12                                          00061700
*  END;                                                                 00061800
*END; /*END OF PROC READSER                                          */ 00061900
@ER00003 LM    R14,R6,@SA00003                                          00062000
         LM    R8,R12,@SA00003+36                                       00062100
         BR    R14                                                      00062200
*                                                                       00062300
*DIRRDSER: PROC OPTIONS(DONTSAVE(R7)); /*READ SERLOG DIRECTLY*/         00062400
DIRRDSER STM   R14,R6,@SA00004                                          00062500
         STM   R8,R12,@SA00004+36                                       00062600
*IF SERLO = YES THEN /*DO ONLY IF SERLOG IS OPEN                     */ 00062700
         TM    IOSWTCH+1,SERLO                                          00062800
         BNO   @RF00284                                                 00062900
*  DO;                                                                  00063000
*    RSERDCNT = RSERDCNT + 1; /*COUNT NUMBER OF READ ATTEMPTS*/         00063100
         LA    R12,1                                                    00063200
         AL    R12,RSERDCNT                                             00063300
         ST    R12,RSERDCNT                                             00063400
*    PREVCC(1:5) = RECCCHHR;                                            00063500
         L     R14,SAVER2                                               00063600
         MVC   PREVCC(5),RECCCHHR(R14)                                  00063700
*    R7 = ADDR(BUF1);                                                   00063800
         LA    R7,BUF1                                                  00063900
*    PREVR = PREVR - 1;                                                 00064000
         SLR   R12,R12                                                  00064100
         IC    R12,PREVR                                                00064200
         BCTR  R12,0                                                    00064300
         STC   R12,PREVR                                                00064400
*    CALL EXCPLOOP;                                                     00064500
         BAL   R14,EXCPLOOP                                             00064600
*    IF POST Å= '7F'X THEN                                              0006470
         CLI   POST,X'7F'                                               00064800
         BE    @RF00291                                                 00064900
*      DO;                                                              00065000
*        MSGNO = 25;                                                    00065100
         MVC   MSGNO(4),KF25                                            00065200
*        CALL ERRMSG;                                                   00065300
         BAL   R14,ERRMSG                                               00065400
*        BADNEWS = TWELVE;                                              00065500
         MVC   BADNEWS(4),KF12                                          00065600
*        RETURN;                                                        00065700
@ER00004 LM    R14,R6,@SA00004                                          00065800
         LM    R8,R12,@SA00004+36                                       00065900
         BR    R14                                                      00066000
*                                                                       00066100
*      END;                                                             00066200
*     PREVCC(1:5) = BCOUNT;                                             00066300
@RF00291 MVC   PREVCC(5),BCOUNT                                         00066400
*     RECLNGTH = BSZ;                                                   00066500
         LH    R6,BSZ                                                   00066600
         L     R12,SAVER2                                               00066700
         STH   R6,RECLNGTH(,R12)                                        00066800
*     R7 = ADDR(BDATA);                                                 00066900
         LA    R7,BDATA                                                 00067000
*     TIMEBASE = R7;                                                    00067100
         ST    R7,TIMEBASE                                              00067200
*     CALL CONVTIME;                                                    00067300
         BAL   R14,CONVTIME                                             00067400
         B     @ER00004                                                 00067500
*                                                                       00067600
*  END;                                                                 00067700
*ELSE /*SERLOG NOT OPEN                                                 00067800
*  DO;                                                                  00067900
*    MSGNO = 47;                                                        00068000
@RF00284 MVC   MSGNO(4),KF47                                            00068100
*    CALL ERRMSG;                                                       00068200
         BAL   R14,ERRMSG                                               00068300
*    BADNEWS = TWELVE;                                                  00068400
         MVC   BADNEWS(4),KF12                                          00068500
*  END;                                                                 00068600
*END; /*CLOSING END TO DIRRDSER PROC */                                 00068700
         B     @ER00004                                                 00068800
*                                                                       00068900
*/********************************************************************/ 00069000
*/*                                                                  */ 00069100
*/*      RESET HEADER TO INDICATE AN EMPTY LOGREC DATA SET           */ 00069200
*/*                                                                  */ 00069300
*/********************************************************************/ 00069400
*RESETHDR: PROC;                                                        00069500
RESETHDR STM   R14,R12,@SA00005                                         00069600
*        IF DEBUG15 = ON THEN                                           00069700
         L     R12,SAVER2                                               00069800
         TM    DEBUG15(R12),B'00000001'                                 00069900
         BNO   @RF00313                                                 00070000
*          DO; /*PRINT TO TOURIST ATTEMPT TO RESET HEADER            */ 00070100
*            MSGNO = 55;                                                00070200
         MVC   MSGNO(4),KF55                                            00070300
*            CALL ERRMSG;                                               00070400
         BAL   R14,ERRMSG                                               00070500
*          END;                                                         00070600
*        R7=ADDR(HEADER);               /* POINT TO HEADER AREA      */ 00070700
@RF00313 LA    R7,HEADER                                                00070800
*        SBT2='1'B;                     /* SET HEADER & WRITE        */ 00070900
*        SBT4='1'B;                     /* SWITCHES ON               */ 00071000
         OI    SBT2,B'01010000'                                         00071100
*        HDRLASTR=HDRREA;               /* RESET LAST REC WRITTEN    */ 00071200
         MVC   HDRLASTR(7),HDRREA                                       00071300
*       IF FRAMES = YES THEN /*IF FRAMES TO BE SAVED FOR MERIDIAN*/     00071400
         TM    HDREWSW,FRAMES                                           00071500
         BNO   RESETNF                     NO FRAMES, BRANCH            00071600
*         HDRTBAL = 20; /*DONT LET RECORDS ON LAST FRAME TRACK*/        00071700
         MVC   HDRTBAL(2),KH20             MAKE TRACK BALANCE TOO       00071800
*                                          SMALL FOR ANY RECORD TO FIT  00071900
         B     @RF00326                                                 00072000
*                                                                       00072100
*        CALCULATE THE TRACK BALANCE ALLOWING FOR THE HEADER            00072200
*        RECORD AND OUTAGE RECORD LOGREC DATASET                        00072300
*                                                                       00072400
RESETNF  SR    R4,R4                                                    00072500
         ICM   R4,B'0011',HDRTRKCP     DEVICE TRACK CAPACITY            00072600
         LA    R12,LOGREC              R12 -> LOGREC DCB                00072700
         L     R7,DCBDEBAD             R7 -> LOGREC DEB                 00072800
*                                      R7 -> LOGREC UCB                 00072900
         L     R7,DEBUCBAD-DEBDASD+DEBBASND-DEBBASIC(,R7)               00073000
         LA    R5,L'HEADER             L'RECORD                         00073100
         ICM   R5,B'1000',=X'01'       SET RECORD NO = 1 FOR HDRREC     00073200
*                                                                       00073300
         TRKCALC FUNCTN=TRKBAL,REMOVE=NO,UCB=(7),                      X00073400
               BALANCE=(4),RKDD=(5),REGSAVE=YES                         00073500
*                                                                       00073600
         LTR   R15,R15                 TRKCALC OK ?                     00073700
         BNZ   RESETBAD                NO, BRANCH                       00073800
         LR    R4,R0                   YES, SET TRACK BALANCE           00073900
         ICM   R5,B'1000',=X'02'       SET RECORD NO = 2 FOR OUTAGE REC 00074000
*                                                                       00074100
         TRKCALC FUNCTN=TRKBAL,REMOVE=NO,UCB=(7),                      X00074200
               BALANCE=(4),RKDD=(5),REGSAVE=YES                         00074300
*                                                                       00074400
         LTR   R15,R15                 TRKCALC OK ?                     00074500
         BNZ   RESETBAD                NO, BRANCH                       00074600
         STCM  R0,B'0011',HDRTBAL      UPDATE HDRREC TRACK BALANCE      00074700
*                                                                       00074800
*        HDRWNGBT='0'B;                 /* TURN OFF EARLY WARN SWITCH*/ 00074900
@RF00326 NI    HDREWSW,255-HDRWNGBT                                     00075000
*        HDRCOUNT = '00'X;             /* RESET THE MSG FIELD */        00075100
         MVI   HDRCOUNT,X'00'                                           00075200
*        CALL EXCPLOOP;                                                 00075300
         BAL   R14,EXCPLOOP                                             00075400
*        IF POST\='7F'X THEN            /* TEST FOR NORMAL           */ 00075500
         CLI   POST,X'7F'                                               00075600
         BE    @ER00005                                                 00075700
*          DO;                                                          00075800
*            MSGNO = 48;                                                00075900
RESETBAD MVC   MSGNO(4),KF48                                            00076000
*            CALL ERRMSG;                                               00076100
         BAL   R14,ERRMSG                                               00076200
*            BADNEWS = TWELVE;                                          00076300
         MVC   BADNEWS(4),KF12                                          00076400
*            R2 = SAVER2;               /*INSURE COMTBL ADDR BY R2   */ 00076500
         L     R12,SAVER2                                               00076600
         LR    R2,R12                                                   00076700
*            CALL IFCMSG(201,ADDR(PRNTBF));                             00076800
         LA    R14,PRNTBF                                               00076900
         ST    R14,@AFTEMPS                                             00077000
         L     R15,ADIFCMSG(,R12)                                       00077100
         LA    R1,@AL00337                                              00077200
         BALR  R14,R15                                                  00077300
*            RETURN;                                                    00077400
@ER00005 LM    R14,R12,@SA00005                                         00077500
         BR    R14                                                      00077600
*          END;                                                         00077700
*END; /*CLOSING END TO PROC RESETHDR                                 */ 00077800
         B     @ER00005                                                 00077900
*                                                                       00078000
*/********************************************************************/ 00078100
*/*                                                                  */ 00078200
*/*      OPEN SYS1.LOGREC                                            */ 00078300
*/*                                                                  */ 00078400
*/********************************************************************/ 00078500
*OPENSERL: PROC;                                                        00078600
OPENSERL STM   R14,R12,@SA00006                                         00078700
*IF DEBUG15 = ON THEN                                                   00078800
         L     R6,SAVER2                                                00078900
         TM    DEBUG15(R6),B'00000001'                                  00079000
         BNO   @RF00344                                                 00079100
*  DO;                                                                  00079200
*    MSGNO = 53;                                                        00079300
         MVC   MSGNO(4),KF53                                            00079400
*    CALL ERRMSG;                                                       00079500
         BAL   R14,ERRMSG                                               00079600
*  END;                                                                 00079700
@RF00344 LA    R1,LOGREC                                                00079800
         ST    R1,IOBDCBPT                                              00079900
*IF SERLO = YES THEN /*IF SERLOG ALREADY OPEN THEN                   */ 00080000
         TM    IOSWTCH+1,SERLO                                          00080100
         BNO   @RF00350                                                 00080200
*  DO;                                                                  00080300
*    MSGNO = 41;                                                        00080400
         MVC   MSGNO(4),KF41                                            00080500
*    CALL ERRMSG;                                                       00080600
         BAL   R14,ERRMSG                                               00080700
*    BADNEWS = TWELVE;                                                  00080800
         MVC   BADNEWS(4),KF12                                          00080900
*    RETURN;                                                            00081000
@ER00006 LM    R14,R12,@SA00006                                         00081100
         BR    R14                                                      00081200
*  END;                                                                 00081300
*/*                                                                  */ 00081400
*ZEROA = (ZEROA && ZEROA); /*CLEAR FIELD                                00081500
@RF00350 XC    ZEROA,ZEROA                                              00081600
*IF NOSDR = NO THEN /*IF USER WANTS SDR COUNTERS DUMPED              */ 00081700
         L     R14,SAVER2                                               00081800
         TM    NOSDR(R14),B'00000001'                                   00081900
         BNZ   @RF00358                                                 00082000
*DO;                                                                    00082100
         LA    R0,4                     FUNCTION CODE TO DUMP SDR'S     00082200
         SVC   76                       ISSUE SVC TO DUMP SDR'S         00082300
*END;                                                                   00082400
@RF00358 ENQ   (RESID,LOGRECA,E,11,STEP) ENQ TO PREVENT OTHER ACCESS    00082500
*                                        FROM ANOTHER IFCEREP0 TASK     00082600
         L     R14,SAVER2                                               00082700
         TM    ZEROALL(R14),B'01000000'  LOGREC TO BE ZEROED?  #IO19631 00082800
         BO    @RF00359                  YES, BRANCH           #IO19631 00082900
         OPEN  (LOGREC,(INPUT))          NO, OPEN FOR INPUT    #IO19631 00083000
         B     @RF00360                                        #IO19631 00083100
@RF00359 OPEN  (LOGREC,(OUTPUT))                               #IO19631 00083200
*                                                                       00083300
@RF00360 LA    R12,LOGREC               R12 -> LOGREC DCB FOR DSECT     00083400
         TM    DCBOFLGS,DCBOFOPN        DID OPEN GO OK ?                00083500
         BZ    BADOPENA                 BRANCH,  BAD OPEN               00083600
*        SERLO = YES;                   /* TURN ON OPEN DISK IND     */ 00083700
         OI    IOSWTCH+1,SERLO                                          00083800
*        SBT4='1'B;                     /* TURN ON HDR READ SW       */ 00083900
         OI    SBT4,B'00010000'                                         00084000
*        R7=ADDR(HEADER);               /* POINT TO HEADER AREA      */ 00084100
         LA    R7,HEADER                                                00084200
*        CALL EXCPLOOP;                 /* GO DO I/O TO READ HDR     */ 00084300
         BAL   R14,EXCPLOOP                                             00084400
*        SBT4='0'B;                     /* TURN OFF HDR READ SW      */ 00084500
         NI    SBT4,B'11101111'                                         00084600
*        IF POST\='7F'X                 /* TEST FOR NORMAL            / 00084700
*              THEN                     /* RETURN FROM I/O            / 00084800
         CLI   POST,X'7F'                                               00084900
         BNE   HDRERR0                                                  00085000
*                   GOTO HDRERR0;       /* IF NOT GOTO ERROR EXIT    */ 00085100
*        IF HDRSAFE\='FF'X              /* TEST FOR SAFETY BYTE      */ 00085200
*              THEN                     /* IN HEADER RECORD          */ 00085300
         CLI   HDRSAFE,X'FF'                                            00085400
         BNE   HDRERR1                                                  00085500
*                   GOTO HDRERR1;       /* IF NOT TAKE ERROR EXIT    */ 00085600
         MVC   DCBFDAD+3(4),HDRECC      SET DCB HIGH EXTENT FIELD       00085700
         XC    DCBTRBAL,DCBTRBAL        ZERO THE TRACK BALANCE FIELD    00085800
*PREVSEEK(2:8) = HDRREA; /*SET START SEEK AT LAST FRAME LOCATION*/      00085900
         MVC   PREVSEEK+1(7),HDRREA                                     00086000
*PREVM = '00'X; /*INDICATE DATA SET OPEN                             */ 00086100
         MVI   PREVM,X'00'                                              00086200
*        RETURN;                        /* TAKE NORMAL EXIT          */ 00086300
         B     @ER00006                                                 00086400
*                                                                       00086500
*HDRERR0:     ;                                                         00086600
*        IF POST='42'X                  /* TEST FOR OUT OF EXTENT    */ 00086700
*              THEN                     /* IF YES                    */ 00086800
HDRERR0  CLI   POST,X'42'                                               00086900
         BNE   @RF00377                                                 00087000
*                MSGNO = 14;                                            00087100
         MVC   MSGNO(4),KF14                                            00087200
         B     @RC00377                                                 00087300
*                                                                       00087400
*              ELSE                                                     00087500
*                MSGNO = 15;                                            00087600
@RF00377 MVC   MSGNO(4),KF15                                            00087700
*         CALL ERRMSG;                                                  00087800
@RC00377 BAL   R14,ERRMSG                                               00087900
*         BADNEWS = TWELVE;                                             00088000
         MVC   BADNEWS(4),KF12                                          00088100
*         RETURN;                                                       00088200
         B     @ER00006                                                 00088300
*                                                                       00088400
*HDRERR1:     ;                                                         00088500
*      MSGNO = 16;                                                      00088600
HDRERR1  MVC   MSGNO(4),KF16                                            00088700
*      CALL ERRMSG;                                                     00088800
         BAL   R14,ERRMSG                                               00088900
*      BADNEWS = TWELVE;                                                00089000
         MVC   BADNEWS(4),KF12                                          00089100
*END; /*CLOSING END TO PROC OPENSERL, OPEN SERLOG DATA SET           */ 00089200
         B     @ER00006                                                 00089300
*                                                                       00089400
*/********************************************************************/ 00089500
*/*                                                                  */ 00089600
*/*      CHECK HEADER FOR MORE RECORDS WRITTEN WHILE PROCESSING      */ 00089700
*/*                                                                  */ 00089800
*/********************************************************************/ 00089900
*                                                                       00090000
*CHECKHDR: PROC;                                                        00090100
CHECKHDR STM   R14,R12,@SA00007                                         00090200
*        IF DEBUG15 = ON THEN                                           00090300
         L     R12,SAVER2                                               00090400
         TM    DEBUG15(R12),B'00000001'                                 00090500
         BNO   @RF00391                                                 00090600
*          DO;                                                          00090700
*            MSGNO = 54;                                                00090800
         MVC   MSGNO(4),KF54                                            00090900
*            CALL ERRMSG;                                               00091000
         BAL   R14,ERRMSG                                               00091100
*          END;                                                         00091200
*        IF SERLO = NO THEN             /* TEST FOR DISK OPEN        */ 00091300
@RF00391 TM    IOSWTCH+1,SERLO                                          00091400
         BNZ   @RF00396                                                 00091500
*          DO;                                                          00091600
*            MSGNO = 49;                                                00091700
         MVC   MSGNO(4),KF49                                            00091800
*            CALL ERRMSG;                                               00091900
         BAL   R14,ERRMSG                                               00092000
*            BADNEWS = TWELVE;                                          00092100
         MVC   BADNEWS(4),KF12                                          00092200
*            RETURN;                                                    00092300
@ER00007 LM    R14,R12,@SA00007                                         00092400
         BR    R14                                                      00092500
*          END;                                                         00092600
*                                       /* GET STORAGE TO HOLD HEADER*/ 00092700
@RF00396 GETMAIN R,LV=40                                                00092800
*        R4=R1;                         /* SET BASE FOR OLD HEADER   */ 00092900
         LR    R4,R1                                                    00093000
*        OHEADER=HEADER;                /* MOVE HEADER TO GOTTEN CORE*/ 00093100
         MVC   OHEADER(40,R4),HEADER                                    00093200
*        R7=ADDR(HEADER);               /* POINT TO BUFF FOR READ    */ 00093300
         LA    R7,HEADER                                                00093400
*        SBT4='1'B;                     /* TURN ON READ HEADER       */ 00093500
         OI    SBT4,B'00010000'                                         00093600
*        IF LASTLOOP = YES THEN /*DONT ENQUEUE EXCEPT FOR ZEROALL PRO*/ 00093700
*        DO; /*CESSING. MAYBE EXTRA RECORD WRITTEN AT EOF FOR READSEQ*/ 00093800
         TM    IOSWTCH,LASTLOOP                                         00093900
         BNO   @RF00408                                                 00094000
*        SBT7='1'B;                     /* TURN ON INTERNAL ENQ SW   */ 00094100
         OI    SBT7,B'00001000'                                         00094200
*                                                                       00094300
         ENQ  (RESIDII,LOGRECB,E,8,SYSTEM)                              00094400
*                                                                       00094500
*        END;                                                           00094600
*        CALL EXCPLOOP;                 /* GO DO I/O READ HEADER     */ 00094700
@RF00408 BAL   R14,EXCPLOOP                                             00094800
*CHK01  :     ;                                                         00094900
*        IF POST\='7F'X                 /* TEST POST CODE FOR NORMAL */ 00095000
*              THEN                     /* RETURN IF NOT             */ 00095100
CHK01    CLI   POST,X'7F'                                               00095200
         BNE   CHK03                                                    00095300
*                   GOTO CHK03;         /* TAKE ERROR EXIT           */ 00095400
*        IF HDRSAFE\='FF'X              /* TEST HDR REC JUST READ FOR*/ 00095500
*              THEN                     /* SAFETY BYTE               */ 00095600
         CLI   HDRSAFE,X'FF'                                            00095700
         BNE   CHK04                                                    00095800
*                   GOTO CHK04;         /* IF NOT FF TAKE ERR EXIT   */ 00095900
*        IF HDRLASTR=OHDRREC2           /* TEST LAST REC WRITTEN FLDS*/ 00096000
*              THEN                     /* IF THEY MATCH             */ 00096100
         CLC   HDRLASTR(7),OHDRREC2(R4)                                 00096200
         BNE   @RF00419                                                 00096300
*                   DO;                 /* THEN                      */ 00096400
*                        BADNEWS = FOUR; /*INDICATE REAL END OF FILE */ 00096500
         MVC   BADNEWS(4),KF4                                           00096600
*                        GOTO CHK02;    /* GO ON                     */ 00096700
         B     CHK02                                                    00096800
*                   END;                                                00096900
*        PREVSEEK(2:8)=OHDRREC2  ;                                      00097000
@RF00419 MVC   PREVSEEK+1(7),OHDRREC2(R4)                               00097100
*CHK02  :     ;                                                         00097200
*        SBT4='0'B;                     /* TURN OF HEADER SW         */ 00097300
CHK02    NI    SBT4,B'11101111'                                         00097400
*        R1=R4;                         /* SET R1 FOR FREE MAIN      */ 00097500
         LR    R1,R4                                                    00097600
*                                       /* FREE MAIN OF GOTTEN CORE  */ 00097700
         FREEMAIN R,LV=40,A=(1)                                         00097800
*          RETURN; /*GO BACK TO CALLER                               */ 00097900
         B     @ER00007                                                 00098000
*                                                                       00098100
*CHK03  :     ;                                                         00098200
*        IF POST = '42'X THEN /*42 MEANS OUT OF EXTENT                  00098300
CHK03    CLI   POST,X'42'                                               00098400
         BNE   @RF00431                                                 00098500
*          MSGNO = 14;                                                  00098600
         MVC   MSGNO(4),KF14                                            00098700
         B     @RC00431                                                 00098800
*                                                                       00098900
*        ELSE                                                           00099000
*          MSGNO = 15;   /*NOT 42 MEANS IO ERROR                     */ 00099100
@RF00431 MVC   MSGNO(4),KF15                                            00099200
*        CALL ERRMSG;                                                   00099300
@RC00431 BAL   R14,ERRMSG                                               00099400
*        BADNEWS = TWELVE;                                              00099500
         MVC   BADNEWS(4),KF12                                          00099600
*        GOTO  CHK02;     /*GO BACK TO FREE EXCESS CORE                 00099700
         B     CHK02                                                    00099800
*CHK04  :     ;                                                         00099900
*        MSGNO = 16; /*HEADER CHECK BYTE BAD                            00100000
CHK04    MVC   MSGNO(4),KF16                                            00100100
*        CALL ERRMSG;                                                   00100200
         BAL   R14,ERRMSG                                               00100300
*        BADNEWS = TWELVE;                                              00100400
         MVC   BADNEWS(4),KF12                                          00100500
*        GOTO CHK02;                     /*GO BACK TO DEQ            */ 00100600
         B     CHK02                                                    00100700
*                                                                       00100800
*END; /*CLOSING END TO PROC CHECK HEADER                             */ 00100900
*                                                                       00101000
*/********************************************************************/ 00101100
*/*                                                                  */ 00101200
*/*      CONVERT TIME ROUTINE                                        */ 00101300
*/*                                                                  */ 00101400
*/********************************************************************/ 00101500
*                                                                       00101600
*CONVTIME: PROC;                                                        00101700
CONVTIME STM   R14,R12,@SA00008                                         00101800
*        R7SAVE = R7;  /*SAVE RECORD ADDRESS                         */ 00101900
         ST    R7,R7SAVE                                                00102000
*        IF LCSWITCH='1'B               /*  HAS TIME BEEN CONVERTED  */ 00102100
*              THEN                     /*  OR IS IT IN PROPER FORM  */ 00102200
         L     R12,TIMEBASE                                             00102300
         TM    LCSWITCH(R12),B'00001000'                                00102400
         BO    @ER00008                                                 00102500
*                   RETURN;               /*  YES EXIT TO CALLER   */   00102600
*        CONVTCT = CONVTCT + 1;         /*NUMBER OF CONVERSIONS DONE*/  00102700
         LA    R14,1                                                    00102800
         AL    R14,CONVTCT                                              00102900
         ST    R14,CONVTCT                                              00103000
*/********************************************************************/ 00103100
*/*      NEW SYSTEM - TO YYDDD & HHMMSS                              */ 00103200
*/********************************************************************/ 00103300
*CONVNS :     ;                                                         00103400
*        WORK8=DATETIME;                /* MOVE DATE & TIME TO WORK  */ 00103500
CONVNS   L     R2,TIMEBASE                                              00103600
         MVC   WORK8(8),DATETIME(R2)                                    00103700
*        NSSWITCH='0'B;                 /* TURN OFF NS SWITCH        */ 00103800
*        LCSWITCH='1'B ;                /* TURN ON LOCAL SW          */ 00103900
         OI    LCSWITCH(R2),B'00001000'                                 00104000
         NI    NSSWITCH(R2),B'10111111'                                 00104100
*        IF WORK=0 &                    /* TEST FOR                  */ 00104200
*           WORKB=0                     /* ZERO FIELD                */ 00104300
*              THEN                     /* IF YES EXIT TO CALLER     */ 00104400
         SLR   R12,R12                                                  00104500
         C     R12,WORK                                                 00104600
         BNE   @RF00454                                                 00104700
         C     R12,WORKB                                                00104800
         BNE   @RF00454                                                 00104900
*                DO;                                                    00105000
*                  R7 = R7SAVE;                                         00105100
         L     R7,R7SAVE                                                00105200
*                   RETURN;                                             00105300
@ER00008 LM    R14,R12,@SA00008                                         00105400
         BR    R14                                                      00105500
*                END;                                                   00105600
*        R4=WORK ;                      /* PICK UP DATE/TIME         */ 00105700
@RF00454 L     R4,WORK                                                  00105800
*        R5=WORKB;                      /* INTO WORK REGS            */ 00105900
         L     R5,WORKB                                                 00106000
*                                       /* CONVERT FROM NANO TO MICRO*/ 00106100
         SRDL  R4,12                                                    00106200
*                                       /* DIVIDE TO GET # OF MINUTES*/ 00106300
         D     R4,SIXTYMIL                                              00106400
         SLR   R6,R6                                                    00106500
*                                       /* MOVE REMAINDER TO OTHER RG*/ 00106600
         LR    R7,R4                                                    00106700
*                                       /* DIVIDE TO GET SECONDS     */ 00106800
         D     R6,MILLION                                               00106900
*                                       /* CONVERT # OF SECONDS      */ 00107000
         CVD   R7,WORK8                                                 00107100
*                                       /* PICK IT UP TO WORK REG    */ 00107200
         L     R4,WORKB                                                 00107300
*                                       /* MOVE IT TO HI ORDER       */ 00107400
         SRL   R4,4                                                     00107500
*                                       /* PUT BYTE INTO RECORD      */ 00107600
         L     R12,TIMEBASE                                             00107700
         STC   R4,SECS(,R12)                                            00107800
         SLR   R4,R4                                                    00107900
         LR    R7,R6                                                    00108000
*        R6= 0 ;                                                        00108100
         SLR   R6,R6                                                    00108200
         D     R6,THCONV                                                00108300
         CVD   R7,WORK8                                                 00108400
*        R6=WORKB ;                                                     00108500
         L     R6,WORKB                                                 00108600
*        SRL (R6,FOUR);                                                 00108700
         SRL   R6,4                                                     00108800
*        TNTHS=R6 ;                                                     00108900
         L     R12,TIMEBASE                                             00109000
         STC   R6,TNTHS(,R12)                                           00109100
*                                       /* DIVIDE MIN TO GET HOURS   */ 00109200
         D     R4,SIXTY                                                 00109300
*                                       /* CONVERT # MINUTES         */ 00109400
         CVD   R4,WORK8                                                 00109500
*        R4=WORKB;                      /* PICK UP CONVERTED #       */ 00109600
         L     R4,WORKB                                                 00109700
*        SRL (R4,FOUR);                 /* POSITION IT               */ 00109800
         SRL   R4,4                                                     00109900
*        MINS=R4;                       /* SET IT INTO REC AS # MINS */ 00110000
         L     R12,TIMEBASE                                             00110100
         STC   R4,MINS(,R12)                                            00110200
*        R4=0 ;                         /*                           */ 00110300
         SLR   R4,R4                                                    00110400
*                                       /* DIVIDE TO GET HOURS       */ 00110500
         D     R4,TWENTY4                                               00110600
*                                       /* CONVERT # OF HOURS        */ 00110700
         CVD   R4,WORK8                                                 00110800
*        R4=WORKB;                      /* PICK UP VALUE             */ 00110900
         L     R4,WORKB                                                 00111000
*        SRL (R4,FOUR);                 /* POSITION IT IN REG        */ 00111100
         SRL   R4,4                                                     00111200
*        HOURS=R4;                      /* PUT VALUE INTO RECORD     */ 00111300
         L     R12,TIMEBASE                                             00111400
         STC   R4,HOURS(,R12)                                           00111500
*        IF GMTSW='1'B                  /* TEST FOR BASE VALUE TO BE */ 00111600
*              THEN                     /* 1900 OR 1960              */ 00111700
         TM    GMTSW(R12),B'10000000'                                   00111800
         BNO   @RF00489                                                 00111900
*                DO;                                                    00112000
*                  R4 = 0;              /* BIT ON BASE IS 00         */ 00112100
         SLR   R4,R4                                                    00112200
*                  R5 = R5 + 1;         /* INCREMENT DAY COUNT          00112300
*                                          SINCE 1900 IS NOT            00112400
*                                          A LEAP YEAR AND              00112500
*                                          LOOP ASSUMES IT IS        */ 00112600
         AL    R5,KF1                                                   00112700
         B     LEAPYEAR                                                 00112800
*                                                                       00112900
*                END;                                                   00113000
*              ELSE                     /* IF BIT OFF SET BASE TO 60 */ 00113100
*                   R4=60;                                              00113200
@RF00489 LA    R4,60                                                    00113300
*LEAPYEAR:    ;                         /* R5 HAS NUMBER OF DAYS     */ 00113400
*        R5=R5-366;                     /* DECREMENT BY A LEAP YEAR  */ 00113500
LEAPYEAR LA    R12,366                                                  00113600
         SLR   R5,R12                                                   00113700
*        IF R5 < ZERO                   /* IF TOO MUCH               */ 00113800
*              THEN                     /* THEN DO THE FOLLOWING     */ 00113900
         LTR   R5,R5                                                    00114000
         BNM   @RF00497                                                 00114100
*                   DO;                 /*                           */ 00114200
*                        R5=R5+366;     /* BUMP BACK # OF DAYS BY 366*/ 00114300
         ALR   R5,R12                                                   00114400
*                        GOTO CONVNSDN; /* EXIT CONVERSION DONE      */ 00114500
         B     CONVNSDN                                                 00114600
*                   END;                                                00114700
*        R4=R4+1;                       /* ADD 1 FOR YEAR            */ 00114800
@RF00497 LA    R14,1                                                    00114900
         ALR   R4,R14                                                   00115000
*                                       /*                           */ 00115100
*                                       /*  DO LOOP FOR REG YEARS    */ 00115200
*        DO A=1 TO 3 BY 1;                                              00115300
         ST    R14,A                                                    00115400
*              R5=R5-365;               /* DECREMENT BY 365 DAYS     */ 00115500
@DL00503 LA    R2,365                                                   00115600
         SLR   R5,R2                                                    00115700
*              IF R5 < ZERO             /* HAS VALUE                 */ 00115800
*                   THEN                /* GON NEGATIVE              */ 00115900
         LTR   R5,R5                                                    00116000
         BNM   @RF00505                                                 00116100
*                        DO;            /* IF YES THEN               */ 00116200
*                             R5=R5+365;     /* ADD BACK 365 DAYS    */ 00116300
         ALR   R5,R2                                                    00116400
*                             GOTO CONVNSDN; /* & EXIT TO FINISH UP  */ 00116500
         B     CONVNSDN                                                 00116600
*                        END;                                           00116700
*              R4=R4+1;                 /* ADD 1 YEAR                */ 00116800
@RF00505 AL    R4,KF1                                                   00116900
*        END ;                          /* END OF DO LOOP REPEAT 3X  */ 00117000
         LA    R14,1                                                    00117100
         AL    R14,A                                                    00117200
         ST    R14,A                                                    00117300
         C     R14,KF3                                                  00117400
         BNH   @DL00503                                                 00117500
*        GOTO LEAPYEAR;                                                 00117600
         B     LEAPYEAR                                                 00117700
*                                                                       00117800
*CONVNSDN:    ;                         /* R4 HAS YEAR               */ 00117900
*        R5=R5+1;                       /* R5 HAS DAYS ADD 1 TO YEAR */ 00118000
CONVNSDN AL    R5,KF1                                                   00118100
*                                       /* CONVERT YEARS TO DEC      */ 00118200
         CVD   R4,WORK8                                                 00118300
*        R4=WORKB;                      /* PICK UP VALUE             */ 00118400
         L     R4,WORKB                                                 00118500
*        SRL (R4,FOUR);                 /* POSITION IT IN REG        */ 00118600
         SRL   R4,4                                                     00118700
*        YEAR=R4;                       /* PUT YEAR IN RECORD        */ 00118800
         L     R12,TIMEBASE                                             00118900
         STC   R4,YEAR(,R12)                                            00119000
*                                       /* CONVERT THE NO OF DAYS    */ 00119100
         CVD   R5,WORK8                                                 00119200
*        DAYS=(WDAYS | '000F'X);        /* PUT DAYS INTO REC WTH SIGN*/ 00119300
         L     R14,TIMEBASE                                             00119400
         MVC   DAYS(2,R14),WDAYS                                        00119500
         OC    DAYS(2,R14),@CB00983                                     00119600
*        DATE0='00'X;                   /* SET HI DIGITS TO ZERO     */ 00119700
         MVI   DATE0(R14),X'00'                                         00119800
*        R7 = R7SAVE;                                                   00119900
         L     R7,R7SAVE                                                00120000
* END; /*CLOSING END TO PROC CONVTIME                                */ 00120100
         B     @ER00008                                                 00120200
*                                                                       00120300
*OPENIT: PROC;                                                          00120400
OPENIT   STM   R14,R12,@SA00009                                         00120500
*IF OTOURIST = YES THEN                                                 00120600
         L     R12,SAVER2                                               00120700
         TM    OTOURIST(R12),B'10000000'                                00120800
         BNO   @RF00526                                                 00120900
*  CALL OPENTOUR;                                                       00121000
         BAL   R14,OPENTOUR                                             00121100
*IF OEREPPT = YES THEN                                                  00121200
@RF00526 L     R14,SAVER2                                               00121300
         TM    OEREPPT(R14),B'01000000'                                 00121400
         BNO   @RF00528                                                 00121500
*  CALL OPENERPT;                                                       00121600
         BAL   R14,OPENERPT                                             00121700
*IF OSERLOG = YES THEN                                                  00121800
@RF00528 L     R12,SAVER2                                               00121900
         TM    OSERLOG(R12),B'00100000'                                 00122000
         BNO   @RF00530                                                 00122100
*  CALL OPENSERL;                                                       00122200
         BAL   R14,OPENSERL                                             00122300
*IF OACCIN = YES THEN                                                   00122400
@RF00530 L     R14,SAVER2                                               00122500
         TM    OACCIN(R14),B'00010000'                                  00122600
         BNO   @RF00532                                                 00122700
*  CALL OPENHIST;                                                       00122800
         BAL   R14,OPENHIST                                             00122900
*IF OACCDEV = YES THEN                                                  00123000
@RF00532 L     R12,SAVER2                                               00123100
         TM    OACCDEV(R12),B'00001000'                                 00123200
         BNO   @RF00534                                                 00123300
*  CALL OPENDEV;                                                        00123400
         BAL   R14,OPENDEV                                              00123500
*IF OSYSIN = YES THEN                                                   00123600
@RF00534 L     R14,SAVER2                                               00123700
         TM    OSYSIN(R14),B'00000100'                                  00123800
         BNO   @RF00536                                                 00123900
*  CALL OPENSYS;                                                        00124000
         BAL   R14,OPENSYS                                              00124100
*IF ODRCTWRK = YES THEN                                                 00124200
@RF00536 L     R12,SAVER2                                               00124300
         TM    ODRCTWRK(R12),B'00000010'                                00124400
         BNO   @RF00538                                                 00124500
*  CALL OPENDIR;                                                        00124600
         BAL   R14,OPENDIR                                              00124700
*IF OPENIO = NODSETS THEN                                               00124800
@RF00538 L     R14,SAVER2                                               00124900
         CLC   OPENIO(2,R14),KXNULL                                     00125000
         BNE   @ER00009                                                 00125100
*  DO;                                                                  00125200
*    MSGNO = 17;                                                        00125300
         MVC   MSGNO(4),KF17                                            00125400
*    CALL ERRMSG;                                                       00125500
         BAL   R14,ERRMSG                                               00125600
*    BADNEWS = TWELVE;                                                  00125700
         MVC   BADNEWS(4),KF12                                          00125800
*  END;                                                                 00125900
*END; /*CLOSING END TO PROC OPENIT                                   */ 00126000
@ER00009 LM    R14,R12,@SA00009                                         00126100
         BR    R14                                                      00126200
*                                                                       00126300
*CLOSIT: PROC; /*SELECT DATA SET SPECIFIED AND CLOSE IT              */ 00126400
CLOSIT   STM   R14,R12,@SA00010                                         00126500
*IF CEREPPT = YES THEN                                                  00126600
         L     R12,SAVER2                                               00126700
         TM    CEREPPT(R12),B'01000000'                                 00126800
         BNO   @RF00548                                                 00126900
*  CALL CLOSERPT;                                                       00127000
         BAL   R14,CLOSERPT                                             00127100
*IF CACCIN = YES THEN                                                   00127200
@RF00548 L     R14,SAVER2                                               00127300
         TM    CACCIN(R14),B'00010000'                                  00127400
         BNO   @RF00550                                                 00127500
*  CALL CLOSHIST;                                                       00127600
         BAL   R14,CLOSHIST                                             00127700
*IF CACCDEV = YES THEN                                                  00127800
@RF00550 L     R12,SAVER2                                               00127900
         TM    CACCDEV(R12),B'00001000'                                 00128000
         BNO   @RF00552                                                 00128100
*  CALL CLOSEDEV;                                                       00128200
         BAL   R14,CLOSEDEV                                             00128300
*IF CSYSIN = ON THEN                                                    00128400
@RF00552 L     R14,SAVER2                                               00128500
         TM    CSYSIN(R14),B'00000100'                                  00128600
         BNO   @RF00554                                                 00128700
*  CALL CLOSSYS;                                                        00128800
         BAL   R14,CLOSSYS                                              00128900
*IF CDRCTWRK = YES THEN                                                 00129000
@RF00554 L     R12,SAVER2                                               00129100
         TM    CDRCTWRK(R12),B'00000010'                                00129200
         BNO   @RF00556                                                 00129300
*  CALL CLOSDIR;                                                        00129400
         BAL   R14,CLOSDIR                                              00129500
*IF CSERLOG = YES THEN                                                  00129600
@RF00556 L     R14,SAVER2                                               00129700
         TM    CSERLOG(R14),B'00100000'                                 00129800
         BNO   @RF00558                                                 00129900
*  CALL CLOSSERL;                                                       00130000
         BAL   R14,CLOSSERL                                             00130100
*IF CTOURIST = YES THEN                                                 00130200
@RF00558 L     R12,SAVER2                                               00130300
         TM    CTOURIST(R12),B'10000000'                                00130400
         BNO   @RF00560                                                 00130500
*  CALL CLOSTOUR;                                                       00130600
         BAL   R14,CLOSTOUR                                             00130700
*                                                                       00130800
*        MUST CLOSE TOURIST LAST TO GET ALL POSSIBLE ERROR MESSAGES     00130900
*        MUST CLOSE SERLOG SECOND TO LAST IN ORDER TO FREE UP AS        00131000
*        MUCH BUFFER SPACE IN ORDER TO DO A POTENTIAL ZEROALL,          00131100
*        WHICH IMPLIES RECORDS WRITTEN WHILE PROCESSING MUST BE         00131200
*        SAVED IN CORE.                                                 00131300
*        I HOPE THAT EREP1 HAD ENOUGH SENSE TO FREE UP THE              00131400
*        SORTABLE OR ITS EQUIVALENT                                     00131500
*                                                                       00131600
*IF CLOSEIO = NODSETS THEN                                              00131700
@RF00560 L     R14,SAVER2                                               00131800
         CLC   CLOSEIO(2,R14),KXNULL                                    00131900
         BNE   @ER00010                                                 00132000
*  DO;                                                                  00132100
*    MSGNO = 32;                                                        00132200
         MVC   MSGNO(4),KF32                                            00132300
*    CALL ERRMSG;                                                       00132400
         BAL   R14,ERRMSG                                               00132500
*    BADNEWS = TWELVE;                                                  00132600
         MVC   BADNEWS(4),KF12                                          00132700
*  END;                                                                 00132800
*END; /*CLOSING END TO CLOSIT                                        */ 00132900
@ER00010 LM    R14,R12,@SA00010                                         00133000
         BR    R14                                                      00133100
*                                                                       00133200
*CLOSSERL: PROC; /*CLOSE THE SERLOG DATA SET AND ALL THAT IMPLIES*/     00133300
CLOSSERL STM   R14,R12,@SA00011                                         00133400
*IF SERLO = ON THEN /*ONLY ATTEMPT TO CLOSE LOGREC IF ALREADY OPEN*/    00133500
         TM    IOSWTCH+1,SERLO                                          00133600
         BNO   @RF00571                                                 00133700
*DO;                                                                    00133800
*IF DEBUG15 = ON THEN                                                   00133900
         L     R12,SAVER2                                               00134000
         TM    DEBUG15(R12),B'00000001'                                 00134100
         BNO   @RF00573                                                 00134200
*  DO;                                                                  00134300
*    MSGNO = 56;                                                        00134400
         MVC   MSGNO(4),KF56                                            00134500
*    CALL ERRMSG;                                                       00134600
         BAL   R14,ERRMSG                                               00134700
*  END;                                                                 00134800
*                                                                       00134900
*        ZEROALL MEANS RESET THE HEADER TO INDICATE NO DATA             00135000
*        1. ANY RECORDS WRITTEN WHILE PROCESSING ARE READ               00135100
*           INTO CORE                                                   00135200
*        2. THE HEADER IS RESET                                         00135300
*        3. SVC 76 IS ISSUED TO REWRITE THE RECORDS BACK                00135400
*           TO THE NEW SERLOG                                           00135500
*                                                                       00135600
*IF ZEROALL = YES                                                       00135700
*  THEN DO;                                                             00135800
@RF00573 L     R14,SAVER2                                               00135900
         TM    ZEROALL(R14),B'01000000'                                 00136000
         BNO   @RF00578                                                 00136100
*    IF DEBUG15 = ON THEN                                               00136200
         TM    DEBUG15(R14),B'00000001'                                 00136300
         BNO   @RF00580                                                 00136400
*      DO;                                                              00136500
*        MSGNO = 57;                                                    00136600
         MVC   MSGNO(4),KF57                                            00136700
*        CALL ERRMSG;                                                   00136800
         BAL   R14,ERRMSG                                               00136900
*      END;                                                             00137000
*    LASTLOOP = YES; /*INDICATE ZEROALL PROCESSING                   */ 00137100
@RF00580 OI    IOSWTCH,LASTLOOP                                         00137200
*    READFR = OFF;  /* DO NOT READ FRAMES DURING ZEROALL             */ 00137300
         NI    IOSWTCH+2,255-READFR                                     00137400
*    CALL CHECKHDR; /*SET UP TO READ RECORDS WRITTEN TO LOGREC WHILE*/  00137500
*                   /*EREP HAS BEEN PROCESSING                       */ 00137600
         BAL   R14,CHECKHDR                                             00137700
*    IF BADNEWS = ZERO THEN /*NO PROBLEMS, YES THERE ARE MORE RECORDS*/ 00137800
         L     R12,BADNEWS                                              00137900
         LTR   R12,R12                                                  00138000
         BNZ   @RF00588                                                 00138100
*      DO;                                                              00138200
*        CALL SAVEM; /*READ RECORDS INTO CORE                        */ 00138300
         BAL   R14,SAVEM                                                00138400
*        CALL RESETHDR;                                                 00138500
         BAL   R14,RESETHDR                                             00138600
*                                                                       00138700
         DEQ  (RESIDII,LOGRECB,8,SYSTEM)                                00138800
*                                                                       00138900
*        RUNPTR = FRSPTR;                                               00139000
         L     R14,FRSPTR                                               00139100
         ST    R14,RUNPTR                                               00139200
*        IF FRSPTR Å= ZERO THEN                                         0013930
         LTR   R14,R14                                                  00139400
         BZ    @RF00578                                                 00139500
*         DO UNTIL RUNPTR = ZERO;                                       00139600
*           CALL ISSUE76;                                               00139700
@DL00595 BAL   R14,ISSUE76                                              00139800
*           RUNPTR = FORPTR;                                            00139900
         L     R12,RUNPTR                                               00140000
         L     R14,FORPTR(,R12)                                         00140100
         ST    R14,RUNPTR                                               00140200
*         END;                                                          00140300
         LTR   R14,R14                                                  00140400
         BNZ   @DL00595                                                 00140500
         B     @RF00578                                                 00140600
*                                                                       00140700
*      END;                                                             00140800
*    ELSE                                                               00140900
*      DO;     /* NO RECORDS WRITTEN WHILE PROCESSING?               */ 00141000
*        IF BADNEWS = FOUR THEN                                         00141100
@RF00588 CLC   BADNEWS(4),KF4                                           00141200
         BNE   @RF00601                                                 00141300
*          DO;                                                          00141400
*            BADNEWS=ZERO;                /* RESET RTN CODE          */ 00141500
         SLR   R12,R12                                                  00141600
         ST    R12,BADNEWS                                              00141700
*            CALL RESETHDR;               /* RESET HEADER            */ 00141800
         BAL   R14,RESETHDR                                             00141900
*          END;                                                         00142000
*                                                                       00142100
@RF00601 DEQ  (RESIDII,LOGRECB,8,SYSTEM)                                00142200
*                                                                       00142300
*      END;                                                             00142400
*  END;                                                                 00142500
*                                    /*LET OTHER EREPS AT LOGREC*/      00142600
*                                                                       00142700
@RF00578 DEQ   (RESID,LOGRECA,11,STEP)                                  00142800
*                      /*CLOSE THE DCB                               */ 00142900
         CLOSE (LOGREC)                                                 00143000
*                                                                       00143100
*SERLO = OFF; /*INDICATE THAT SERLOG IS CLOSED                       */ 00143200
         NI    IOSWTCH+1,255-SERLO                                      00143300
         B     @ER00011                                                 00143400
*                                                                       00143500
*END;                                                                   00143600
*ELSE /*IF SERLOG WAS NOT OPEN                                          00143700
*  DO;                                                                  00143800
*    IF CLOSEIO \= CLOSEALL THEN /*END OF JOB WRAPUP CLOSEALL ALLOWED*/ 00143900
@RF00571 L     R14,SAVER2                                               00144000
         CLC   CLOSEIO(2,R14),@CB00262                                  00144100
         BE    @ER00011                                                 00144200
*      DO;                                                              00144300
*        MSGNO = 51;                                                    00144400
         MVC   MSGNO(4),KF51                                            00144500
*        CALL ERRMSG;                                                   00144600
         BAL   R14,ERRMSG                                               00144700
*        BADNEWS = TWELVE;                                              00144800
         MVC   BADNEWS(4),KF12                                          00144900
*      END;                                                             00145000
*  END;                                                                 00145100
*END; /*CLOSING END TO PROC CLOSSERL                                 */ 00145200
@ER00011 LM    R14,R12,@SA00011                                         00145300
         BR    R14                                                      00145400
*                                                                       00145500
*ISSUE76: PROC;                                                         00145600
ISSUE76  STM   R14,R12,@SA00012                                         00145700
*IF DEBUG15 = ON THEN                                                   00145800
         L     R12,SAVER2                                               00145900
         TM    DEBUG15(R12),B'00000001'                                 00146000
         BNO   @RF00625                                                 00146100
*  DO;                                                                  00146200
*    MSGNO = 58;                                                        00146300
         MVC   MSGNO(4),KF58                                            00146400
*    CALL ERRMSG;                                                       00146500
         BAL   R14,ERRMSG                                               00146600
*  END;                                                                 00146700
*R0 =JUNK3;                                                             00146800
@RF00625 L     R12,RUNPTR                                               00146900
         LH    R0,JUNK3(,R12)                                           00147000
*R1 = ADDR(RECSPT);                                                     00147100
         LA    R1,RECSPT(,R12)                                          00147200
*R0 = R0 * (-1);                                                        00147300
         LR    R12,R0                                                   00147400
         MH    R12,KHM1                                                 00147500
         LR    R0,R12                                                   00147600
*SVC(76);                                                               00147700
         SVC   76                                                       00147800
*END; /*CLOSING END TO PROC ISSUE76                                  */ 00147900
@ER00012 LM    R14,R12,@SA00012                                         00148000
         BR    R14                                                      00148100
*                                                                       00148200
*SAVEM: PROC;                                                           00148300
SAVEM    STM   R14,R12,@SA00013                                         00148400
*DO WHILE BADNEWS = ZERO;                                               00148500
         B     @DE00638                                                 00148600
*                                                                       00148700
*  CALL READSER;                                                        00148800
@DL00638 BAL   R14,READSER                                              00148900
*  IF BADNEWS = ZERO THEN                                               00149000
         L     R14,BADNEWS                                              00149100
         LTR   R14,R14                                                  00149200
         BNZ   @DE00638                                                 00149300
*    DO;                                                                00149400
*      DBLYES = NO;                                                     00149500
         NI    IOSWTCH,255-DBLYES                                       00149600
*      GETHIS = BSZ;                                                    00149700
         LH    R7,BSZ                                                   00149800
         ST    R7,GETHIS                                                00149900
*      GETHIS = GETHIS + 12;                                            00150000
         AL    R7,KF12                                                  00150100
         ST    R7,GETHIS                                                00150200
*      DO WHILE DBLYES = NO;                                            00150300
         B     @DE00645                                                 00150400
*                                                                       00150500
*        IF (GETTIT & DBLWORD) \= NULL THEN                             00150600
@DL00645 MVC   WORKD(4),GETTIT                                          00150700
         NC    WORKD(4),KX07                                            00150800
         CLC   WORKD(4),KXNULL                                          00150900
         BE    @RF00646                                                 00151000
*          GETHIS = GETHIS + 1;                                         00151100
         LA    R12,1                                                    00151200
         AL    R12,GETHIS                                               00151300
         ST    R12,GETHIS                                               00151400
         B     @DE00645                                                 00151500
*                                                                       00151600
*        ELSE                                                           00151700
*          DBLYES = YES;                                                00151800
@RF00646 OI    IOSWTCH,DBLYES                                           00151900
*      END;                                                             00152000
@DE00645 TM    IOSWTCH,DBLYES                                           00152100
         BZ    @DL00645                                                 00152200
*      R6 = GETTIT; /*NUMBER OF BYTES NEEDED IN R6                   */ 00152300
         L     R6,GETTIT                                                00152400
*                                          /*STORAGE FOR RECORD*/       00152500
         GETMAIN  EC,LV=(R6),A=SAVEPTR                                  00152600
*                                                                       00152700
*      NUMRECSV = NUMRECSV + 1;                                         00152800
         LA    R7,1                                                     00152900
         AL    R7,NUMRECSV                                              00153000
         ST    R7,NUMRECSV                                              00153100
*      IF R15 = ZERO THEN                                               00153200
         LTR   R15,R15                                                  00153300
         BNZ   @RF00653                                                 00153400
*        DO;                                                            00153500
*          IF SECGET = NO THEN /*IF FIRST RECORD SAVED THEN          */ 00153600
         TM    IOSWTCH,SECGET                                           00153700
         BNZ   @RF00655                                                 00153800
*            DO;                                                        00153900
*              SECGET = YES;                                            00154000
         OI    IOSWTCH,SECGET                                           00154100
*              FRSPTR = SAVEPTR; /*POINTER TO FIRST RECORD SAVED*/      00154200
         L     R12,SAVEPTR                                              00154300
         ST    R12,FRSPTR                                               00154400
*              RUNPTR = SAVEPTR; /*ESTABLISH ADDRESSABILITY          */ 00154500
         ST    R12,RUNPTR                                               00154600
         B     @RC00655                                                 00154700
*                                                                       00154800
*            END;                                                       00154900
*           ELSE /*IF SAVING SECOND RECORD THEN                      */ 00155000
*            DO;                                                        00155100
*              FORPTR = SAVEPTR; /*SET FORWARD POINTER FROM OLD REC*/   00155200
@RF00655 L     R14,SAVEPTR                                              00155300
         L     R7,RUNPTR                                                00155400
         ST    R14,FORPTR(,R7)                                          00155500
*                                /*TO LOCATION OF NEW RECORD SAVE ARR*/ 00155600
*              RUNPTR = SAVEPTR; /*ESTABLISH ADDRESS OF NEW RECORD*/    00155700
         ST    R14,RUNPTR                                               00155800
*            END;                                                       00155900
*          R2 = ADDR(JUNK);                                             00156000
@RC00655 L     R2,RUNPTR                                                00156100
         LA    R2,JUNK(,R2)                                             00156200
*          R3 = GETHIS - 4;                                             00156300
         L     R3,GETHIS                                                00156400
         SL    R3,KF4                                                   00156500
*          R4 = ADDR(BCOUNT); /*MAY BE WRONG                            00156600
         LA    R4,BCOUNT                                                00156700
*          R5 = R3;                                                     00156800
         LR    R5,R3                                                    00156900
*          MVCL(R2,R4);                                                 00157000
         MVCL  R2,R4                                                    00157100
*          FORPTR = ZERO;                                               00157200
         L     R7,RUNPTR                                                00157300
         SLR   R12,R12                                                  00157400
         ST    R12,FORPTR(,R7)                                          00157500
         B     @DE00638                                                 00157600
*                                                                       00157700
*        END;                                                           00157800
*      ELSE                                                             00157900
*        DO;                                                            00158000
*          MSGNO = 50;                                                  00158100
@RF00653 MVC   MSGNO(4),KF50                                            00158200
*          CALL ERRMSG;                                                 00158300
         BAL   R14,ERRMSG                                               00158400
*          BADNEWS = TWELVE;                                            00158500
         MVC   BADNEWS(4),KF12                                          00158600
*        END;                                                           00158700
*     END;                                                              00158800
*   END;                                                                00158900
@DE00638 L     R14,BADNEWS                                              00159000
         LTR   R14,R14                                                  00159100
         BZ    @DL00638                                                 00159200
*END; /*CLOSING END TO PROC SAVEM                                    */ 00159300
@ER00013 LM    R14,R12,@SA00013                                         00159400
         BR    R14                                                      00159500
*                                                                       00159600
*ERRMSG: PROC; /*WRITE ERROR MESSAGES TO THE TOURIST DATA SET*/         00159700
*                                                                       00159800
*        IF THE PROBLEM EXISTS WITH THE TOURIST DATA SET THEN           00159900
*        WRITE TO THE OPERATOR. IF THE OPERATOR CANNOT BE               00160000
*        REACHED, THEN YOU ARE ASKING TOO MUCH OF THIS PROGRAM          00160100
*                                                                       00160200
ERRMSG   STM   R14,R12,@SA00014                                         00160300
*                             /*CLEAR INTERNAL PRINT BUFFER          */ 00160400
         MVC   PRNTBF(134),BLANKS                                       00160500
*IF MSGNO <= 52 THEN            /* SYSTEM ERROR MESSAGE ?            */ 00160600
         L     R4,MSGNO                                                 00160700
         C     R4,KF52                                                  00160800
         BH    @RF00684                                                 00160900
*  DO;                                                                  00161000
*    R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2               */ 00161100
         L     R6,SAVER2                                                00161200
         LR    R2,R6                                                    00161300
*    CALL IFCMSG(MSGNO,ADDR(PRNTBF)+2);                                 00161400
         LA    R4,PRNTBF                                                00161500
         AL    R4,KF2                                                   00161600
         ST    R4,@AFTEMPS+4                                            00161700
         L     R15,ADIFCMSG(,R6)                                        00161800
         LA    R1,@AL00687                                              00161900
         BALR  R14,R15                                                  00162000
*    PRNTBF(1:2) = '1 ';                                                00162100
         MVC   PRNTBF(2),KC1B                                           00162200
         B     @RC00684                                                 00162300
*                                                                       00162400
*  END;                                                                 00162500
*ELSE                                                                   00162600
*  DO;                                                                  00162700
*    MSGNO = MSGNO - 52;                                                00162800
@RF00684 L     R4,MSGNO                                                 00162900
         SL    R4,KF52                                                  00163000
         ST    R4,MSGNO                                                 00163100
*    R5 = ADDR(ERRLINE) + (51 * (MSGNO - 1)); /*POINT TO MESSAGE TEXT*/ 00163200
         LA    R5,ERRLINE                                               00163300
         BCTR  R4,0                                                     00163400
         MH    R4,KH51                                                  00163500
         ALR   R5,R4                                                    00163600
*                               /*MOVE TEXT TO INTERNAL PRINT BUFFER*/  00163700
         MVC   PRNTBF(51),0(R5)                                         00163800
*  END;                                                                 00163900
*PRINTADR = ADDR(PRNTBF); /*ADDRESS THE DATA SET TYPE                */ 00164000
@RC00684 LA    R6,PRNTBF                                                00164100
         L     R4,SAVER2                                                00164200
         ST    R6,PRINTADR(,R4)                                         00164300
*IF TOUROPN = YES                 THEN /*IF TOURIST DATA SET IS OPEN*/  00164400
         TM    IOSWTCH+1,TOUROPN                                        00164500
         BNO   @RF00696                                                 00164600
*  DO;                                                                  00164700
*     R7 = PRINTADR + 1; /*POINT PAST DATA SET INDICATOR             */ 00164800
         LA    R7,1                                                     00164900
         ALR   R7,R6                                                    00165000
*     CCSAVE = PRINTCC; /*SAVE CARRIAGE CONTROL FROM CALLER          */ 00165100
         MVC   CCSAVE(1),PRINTCC(R6)                                    00165200
*     PRINTCC = '09'X; /*CARRIAGE CONTROL TO PRINT ONE LINE          */ 00165300
         MVI   PRINTCC(R6),X'09'                                        00165400
*                          /*ADDRESS TOURIST DCB                     */ 00165500
         LA    R12,TOURDCB                                              00165600
*                                                                       00165700
         PUT   (12),(R7)                                                00165800
*                                                                       00165900
*     PRINTCC = CCSAVE; /*RESTORE CALLERS CARRIAGE CONTROL           */ 00166000
         L     R4,SAVER2                                                00166100
         L     R6,PRINTADR(,R4)                                         00166200
         MVC   PRINTCC(1,R6),CCSAVE                                     00166300
*     PRINTBDY = BLANKS; /*CLEAR PRINT LINE FOR CALLER               */ 00166400
         MVC   PRINTBDY(132,R6),BLANKS                                  00166500
*     LINECTT = LINECTT + 1;                                            00166600
         LA    R14,1                                                    00166700
         AH    R14,LINECTT                                              00166800
         STH   R14,LINECTT                                              00166900
*     IF LINECTT = LINECT THEN                                          00167000
         CH    R14,LINECT(,R4)                                          00167100
         BNE   @ER00014                                                 00167200
*       DO;                                                             00167300
*         LINECTT = 0;                                                  00167400
         SLR   R4,R4                                                    00167500
         STH   R4,LINECTT                                               00167600
*         CCSAVE = PRINTCC;                                             00167700
         MVC   CCSAVE(1),PRINTCC(R6)                                    00167800
*         PRINTCC = SKIPNEW;                                            00167900
         MVI   PRINTCC(R6),X'8B'                                        00168000
*                                                                       00168100
         PUT   (R12),(R7)                                               00168200
*         PRINTCC = CCSAVE;                                             00168300
         L     R6,SAVER2                                                00168400
         L     R4,PRINTADR(,R6)                                         00168500
         MVC   PRINTCC(1,R4),CCSAVE                                     00168600
         B     @ER00014                                                 00168700
*                                                                       00168800
*       END;                                                            00168900
*  END;                                                                 00169000
* ELSE /*IF TOURIST NOT OPEN THEN GO TO OPERATOR                        00169100
*   DO;                                                                 00169200
*    R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2               */ 00169300
@RF00696 L     R6,SAVER2                                                00169400
         LR    R2,R6                                                    00169500
*    CALL IFCMSG(203,ADDR(PRNTBF));                                     00169600
         LA    R4,PRNTBF                                                00169700
         ST    R4,@AFTEMPS+4                                            00169800
         L     R15,ADIFCMSG(,R6)                                        00169900
         LA    R1,@AL00717                                              00170000
         BALR  R14,R15                                                  00170100
*   END;                                                                00170200
* END; /*CLOSING END TO ERRMSG PROC                                  */ 00170300
@ER00014 LM    R14,R12,@SA00014                                         00170400
         BR    R14                                                      00170500
*                                                                       00170600
*PRINTIT: PROC; /*SELECT PRINT DATA SET AND PRINT LINE REQUESTED*/      00170700
PRINTIT  STM   R14,R12,@SA00015                                         00170800
*IF PRINTDS = 'F0'X THEN /*IF PRINT TO ERREPT THEN                   */ 00170900
         L     R6,SAVER2                                                00171000
         L     R6,PRINTADR(,R6)                                         00171100
         CLI   PRINTDS(R6),X'F0'                                        00171200
         BNE   @RF00723                                                 00171300
*  DO;                                                                  00171400
*    IF ERPTOPN = ON THEN /*IF ERREPT HAS BEEN OPENED THEN           */ 00171500
         TM    IOSWTCH+1,ERPTOPN                                        00171600
         BNO   @RF00725                                                 00171700
*      DO;                                                              00171800
*                              /*ADDRESS ERREPT DCB                  */ 00171900
         LA    R12,EREPTDCB                                             00172000
*        R7 = PRINTADR + 1; /*POINT PAST THE DATA SET DEFINER*/         00172100
         LA    R7,1                                                     00172200
         L     R6,SAVER2                                                00172300
         AL    R7,PRINTADR(,R6)                                         00172400
*                                  /* ENSURE VALID CODE              */ 00172500
         TR    0(1,R7),MACHCODE                                         00172600
*                                                                       00172700
         PUT (12),(7)                                                   00172800
*                                                                       00172900
         L     R6,SAVER2                                                00173000
         L     R1,PRINTADR(,R6)                                         00173100
*        PRINTBDY = BLANKS; /*CLEAR PRINT LINE FOR CALLER            */ 00173200
         MVC   PRINTBDY(132,R1),BLANKS                                  00173300
         LH    R2,LINECTSV(,R6)                                         00173400
         LTR   R2,R2                                                    00173500
         BP    IFCD0C86                                                 00173600
         LH    R4,LINECT(,R6)                                           00173700
         STH   R4,LINECTSV(,R6)                                         00173800
IFCD0C86 L     R6,SAVER2                                                00173900
         L     R1,PRINTADR(,R6)                                         00174000
         CLI   1(R1),X'1B'             CC = SPACE 3 AFTER WRITE ?       00174100
         BNH   IFCD0CA2                                                 00174200
         LH    R3,LINECT(,R6)                                           00174300
         STH   R3,LINECTSV(,R6)                                         00174400
         B     IFCD0D3C                                                 00174500
*                                                                       00174600
IFCD0CA2 L     R6,SAVER2                                                00174700
         L     R1,PRINTADR(,R6)                                         00174800
         CLI   1(R1),X'01'             CC = SPACE 0 AFTER WRITE ?       00174900
         BNE   IFCD0CBE                                                 00175000
         LH    R2,LINECTSV(,R6)                                         00175100
         STH   R2,LINECTSV(,R6)                                         00175200
         B     IFCD0D3C                                                 00175300
*                                                                       00175400
IFCD0CBE L     R6,SAVER2                                                00175500
         L     R6,PRINTADR(,R6)                                         00175600
         CLI   1(R6),X'09'             CC = SPACE 1 AFTER WRITE         00175700
         BE    IFCD0CD6                                                 00175800
         CLI   1(R6),X'0B'             CC = SPACE 1 IMMEDIATE ?         00175900
         BNE   IFCD0CE8                                                 00176000
IFCD0CD6 L     R6,SAVER2                                                00176100
         LH    R14,LINECTSV(,R6)                                        00176200
         BCTR  R14,0                                                    00176300
         STH   R14,LINECTSV(,R6)                                        00176400
         B     IFCD0D3C                                                 00176500
*                                                                       00176600
IFCD0CE8 L     R6,SAVER2                                                00176700
         L     R6,PRINTADR(,R6)                                         00176800
         CLI   1(R6),X'11'             CC = SPACE 2 AFTER WRITE ?       00176900
         BE    IFCD0D00                                                 00177000
         CLI   1(R6),X'13'             CC = SPACE 2 IMMEDIATE ?         00177100
         BNE   IFCD0D14                                                 00177200
IFCD0D00 L     R6,SAVER2                                                00177300
         LH    R14,LINECTSV(,R6)                                        00177400
         BCTR  R14,R0                                                   00177500
         BCTR  R14,R0                                                   00177600
         STH   R14,LINECTSV(,R6)                                        00177700
         B     IFCD0D3C                                                 00177800
*                                                                       00177900
IFCD0D14 L     R6,SAVER2                                                00178000
         L     R6,PRINTADR(,R6)                                         00178100
         CLI   1(R6),X'19'             CC = SPACE 3 AFTER WRITE ?       00178200
         BE    IFCD0D2C                                                 00178300
         CLI   1(R6),X'1B'             CC = SPACE 3 IMMEDIATE ?         00178400
         BNE   IFCD0D3C                                                 00178500
IFCD0D2C L     R6,SAVER2                                                00178600
         LH    R14,LINECTSV(,R6)                                        00178700
         SL    R14,KF3                                                  00178800
         STH   R14,LINECTSV(,R6)                                        00178900
IFCD0D3C L     R6,SAVER2                                                00179000
         L     R6,PRINTADR(,R6)                                         00179100
         MVI   1(R6),X'09'             SET CC = SPACE 1 AFTER WRITE     00179200
         B     @ER00015                                                 00179300
*                                                                       00179400
*      END;                                                             00179500
*    ELSE /*REQUEST TO WRITE TO DATA SET NOT OPEN                    */ 00179600
*      DO;                                                              00179700
*        BADNEWS = TWELVE;                                              00179800
@RF00725 MVC   BADNEWS(4),KF12                                          00179900
*        MSGNO = 19;                                                    00180000
         MVC   MSGNO(4),KF19                                            00180100
*        CALL ERRMSG;                                                   00180200
         BAL   R14,ERRMSG                                               00180300
         B     @ER00015                                                 00180400
*                                                                       00180500
*      END;                                                             00180600
*  END;                                                                 00180700
*ELSE /*REQUEST FOR WRITE TO TOURIST DATA SET                        */ 00180800
*  DO;                                                                  00180900
*    IF TOUROPN = YES THEN /*IF TOURIST DATA SET IS OPEN THEN*/         00181000
@RF00723 TM    IOSWTCH+1,TOUROPN                                        00181100
         BNO   @RF00740                                                 00181200
*      DO;                                                              00181300
*        R7 = PRINTADR + 1; /* POINT PAST DATA SET ID                */ 00181400
         L     R1,SAVER2                                                00181500
         L     R2,PRINTADR(,R1)                                         00181600
         LA    R7,1                                                     00181700
         ALR   R7,R2                                                    00181800
*        CCSAVE = PRINTCC;                                              00181900
         MVC   CCSAVE(1),PRINTCC(R2)                                    00182000
*        PRINTCC = '09'X; /*SET TO PRINT AND SKIP ONE                */ 00182100
         MVI   PRINTCC(R2),X'09'                                        00182200
*                             /*ADDRESS TOURIST DCB                  */ 00182300
         LA    R12,TOURDCB                                              00182400
*                           /*PUT TO TOURIST                         */ 00182500
         PUT   (12),(7)                                                 00182600
*                                                                       00182700
*        PRINTCC = CCSAVE; /*RESTORE USERS CARRIAGE CONTROL          */ 00182800
         L     R6,SAVER2                                                00182900
         L     R14,PRINTADR(,R6)                                        00183000
         MVC   PRINTCC(1,R14),CCSAVE                                    00183100
*        PRINTBDY = BLANKS; /*BLANKS TO CALLERS LINE                 */ 00183200
         MVC   PRINTBDY(132,R14),BLANKS                                 00183300
*        LINECTT = LINECTT + 1;                                         00183400
         LA    R15,1                                                    00183500
         AH    R15,LINECTT                                              00183600
         STH   R15,LINECTT                                              00183700
*        IF LINECTT = LINECT THEN                                       00183800
         CH    R15,LINECT(,R6)                                          00183900
         BNE   @ER00015                                                 00184000
*          DO;                                                          00184100
*            LINECTT = 0;                                               00184200
         SLR   R6,R6                                                    00184300
         STH   R6,LINECTT                                               00184400
*            CCSAVE = PRINTCC;                                          00184500
         MVC   CCSAVE(1),PRINTCC(R14)                                   00184600
*            PRINTCC = SKIPNEW;                                         00184700
         MVI   PRINTCC(R14),X'8B'                                       00184800
*                                                                       00184900
         PUT   (R12),(R7)                                               00185000
*            PRINTCC = CCSAVE;                                          00185100
         L     R6,SAVER2                                                00185200
         L     R6,PRINTADR(,R6)                                         00185300
         MVC   PRINTCC(1,R6),CCSAVE                                     00185400
         B     @ER00015                                                 00185500
*                                                                       00185600
*          END;                                                         00185700
*     END;                                                              00185800
*   ELSE  /*IMPLIES TOURIST DATA SET NOT OPEN                        */ 00185900
*     DO;                                                               00186000
*       R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2            */ 00186100
@RF00740 L     R6,SAVER2                                                00186200
         LR    R2,R6                                                    00186300
*       CALL IFCMSG(203,ADDR(PRNTBF));                                  00186400
         LA    R14,PRNTBF                                               00186500
         ST    R14,@AFTEMPS+8                                           00186600
         L     R15,ADIFCMSG(,R6)                                        00186700
         LA    R1,@AL00761                                              00186800
         BALR  R14,R15                                                  00186900
*       BADNEWS = TWELVE;                                               00187000
         MVC   BADNEWS(4),KF12                                          00187100
*     END;                                                              00187200
*  END;                                                                 00187300
*END; /*CLOSING END TO PROC PRINTIT                                  */ 00187400
@ER00015 LM    R14,R12,@SA00015                                         00187500
         BR    R14                                                      00187600
*                                                                       00187700
*OPENSYS: PROC; /*OPEN SYSIN DATA SET TO READ CONTROL STATEMENTS     */ 00187800
OPENSYS  STM   R14,R12,@SA00016                                         00187900
*IF SYSOPN = NO THEN /* IF ALREADY OPEN IS NO NO                     */ 00188000
         TM    IOSWTCH+1,SYSOPN                                         00188100
         BNZ   @RF00769                                                 00188200
*  DO;                                                                  00188300
*    IF DEBUG15 = ON THEN                                               00188400
         L     R1,SAVER2                                                00188500
         TM    DEBUG15(R1),B'00000001'                                  00188600
         BNO   @RF00771                                                 00188700
*      DO;                                                              00188800
*        MSGNO = 59;                                                    00188900
         MVC   MSGNO(4),KF59                                            00189000
*        CALL ERRMSG;                                                   00189100
         BAL   R14,ERRMSG                                               00189200
*      END;                                                             00189300
@RF00771 LA    R12,SYSDCB                                               00189400
*                                                                       00189500
         OPEN  ((R12),(INPUT))                                          00189600
*                                                                       00189700
         TM    DCBOFLGS,DCBOFOPN                                        00189800
         BZ    SYSOBAD                                                  00189900
*   SYSOPN = YES;                                                       00190000
         OI    IOSWTCH+1,SYSOPN                                         00190100
         B     @ER00016                                                 00190200
*                                                                       00190300
*  END;                                                                 00190400
*ELSE                                                                   00190500
*  DO;                                                                  00190600
*    MSGNO = 33;                                                        00190700
@RF00769 MVC   MSGNO(4),KF33                                            00190800
*    CALL ERRMSG;                                                       00190900
         BAL   R14,ERRMSG                                               00191000
*    BADNEWS = TWELVE;                                                  00191100
         MVC   BADNEWS(4),KF12                                          00191200
*  END;                                                                 00191300
*END; /*CLOSING END TO PROC OPENSYS                                  */ 00191400
@ER00016 LM    R14,R12,@SA00016                                         00191500
         BR    R14                                                      00191600
*                                                                       00191700
*CLOSSYS: PROC; /*CLOSE SYSIN DATA SET FOR READING CONTROL STATEMENTS*/ 00191800
CLOSSYS  STM   R14,R12,@SA00017                                         00191900
*IF SYSOPN = YES THEN                                                   00192000
         TM    IOSWTCH+1,SYSOPN                                         00192100
         BNO   @RF00788                                                 00192200
*  DO;                                                                  00192300
*    IF DEBUG15 = ON THEN                                               00192400
         L     R1,SAVER2                                                00192500
         TM    DEBUG15(R1),B'00000001'                                  00192600
         BNO   @RF00790                                                 00192700
*      DO;                                                              00192800
*        MSGNO = 60;                                                    00192900
         MVC   MSGNO(4),KF60                                            00193000
*        CALL ERRMSG;                                                   00193100
         BAL   R14,ERRMSG                                               00193200
*      END;                                                             00193300
*                                                                       00193400
@RF00790 CLOSE (SYSDCB)                                                 00193500
*                                                                       00193600
*    SYSOPN = NO;                                                       00193700
         NI    IOSWTCH+1,255-SYSOPN                                     00193800
         B     @ER00017                                                 00193900
*                                                                       00194000
*  END;                                                                 00194100
*ELSE                                                                   00194200
*  DO;                                                                  00194300
*    IF CLOSEIO Å= CLOSEALL THEN                                        0019440
@RF00788 L     R1,SAVER2                                                00194500
         CLC   CLOSEIO(2,R1),@CB00262                                   00194600
         BE    @ER00017                                                 00194700
*      DO;                                                              00194800
*        MSGNO = 34;                                                    00194900
         MVC   MSGNO(4),KF34                                            00195000
*        CALL ERRMSG;                                                   00195100
         BAL   R14,ERRMSG                                               00195200
*        BADNEWS = 12;                                                  00195300
         MVC   BADNEWS(4),KF12                                          00195400
*      END;                                                             00195500
*   END;                                                                00195600
*END; /*CLOSING END TO PROC CLOSSYS                                  */ 00195700
@ER00017 LM    R14,R12,@SA00017                                         00195800
         BR    R14                                                      00195900
*                                                                       00196000
*REEDSYS: PROC OPTIONS(DONTSAVE(R7)); /*READ THE SYSIN CONTROL STMTS */ 00196100
REEDSYS  STM   R14,R6,@SA00018                                          00196200
         STM   R8,R12,@SA00018+36                                       00196300
*IF SYSOPN = YES THEN                                                   00196400
         TM    IOSWTCH+1,SYSOPN                                         00196500
         BNO   @RF00810                                                 00196600
*  DO;                                                                  00196700
*    SYSRDCT = SYSRDCT + 1; /*NUMBER OF READS ATTEMPTED              */ 00196800
         LA    R6,1                                                     00196900
         AL    R6,SYSRDCT                                               00197000
         ST    R6,SYSRDCT                                               00197100
         LA    R7,CARDSPOT             R7  -> READIN AREA               00197200
         LA    R12,SYSDCB              R12 -> DCB                       00197300
*                                                                       00197400
         GET   (12),(7)                                                 00197500
*                                                                       00197600
         B     @ER00018                                                 00197700
*                                                                       00197800
*  END;                                                                 00197900
*ELSE                                                                   00198000
*  DO;                                                                  00198100
*    MSGNO = 35;                                                        00198200
@RF00810 MVC   MSGNO(4),KF35                                            00198300
*    CALL ERRMSG;                                                       00198400
         BAL   R14,ERRMSG                                               00198500
*    BADNEWS = TWELVE;                                                  00198600
         MVC   BADNEWS(4),KF12                                          00198700
*  END;                                                                 00198800
*END; /*CLOSING END TO REEDSYS PROC                                  */ 00198900
@ER00018 LM    R14,R6,@SA00018                                          00199000
         LM    R8,R12,@SA00018+36                                       00199100
         BR    R14                                                      00199200
*                                                                       00199300
*SCRCHIT: PROC; /*WRITE TO DIRECTWK DATA SET SEQUENTIALLY            */ 00199400
SCRCHIT  STM   R14,R12,@SA00019                                         00199500
*IF INDIR = YES & /*IF DATA SET IS OPEN AND OPEN FOR SEQUENTIAL*/       00199600
*   CLOSE2 = NO THEN /*WRITING THEN                                  */ 00199700
         TM    IOSWTCH+1,INDIR                                          00199800
         BNO   @RF00824                                                 00199900
         TM    IOSWTCH+1,CLOSE2                                         00200000
         BNZ   @RF00824                                                 00200100
*  DO;                                                                  00200200
*    RITEWKCT = RITEWKCT + 1; /*NUMBER OF WRITE ATTEMPTS             */ 00200300
         LA    R0,1                                                     00200400
         AL    R0,RITEWKCT                                              00200500
         ST    R0,RITEWKCT                                              00200600
         LA    R7,BUF1     GET ADDRESS OF RECORD                        00200700
*        IF FLIPFLOP = OFF THEN /*MUST REARRANGE SERLOG PRE RECORD*/    00200800
         TM    IOSWTCH,FLIPFLOP                                         00200900
         BNZ   @RF00828                                                 00201000
         MVC   SDRK,OUTHIST+DCBLRECL-IHADCB                             00201100
*          DO;                                                          00201200
*            BBRDW = SAVELENT; /*GET UNMODIFIED QSAM RECORD LENGTH*/    00201300
         LH    R6,SDRK                                                  00201400
         CH    R6,SAVELENT                                              00201500
         BNL   IFCD0F4C                                                 00201600
         STH   R6,SAVELENT                                              00201700
IFCD0F4C LH    R6,SAVELENT                                              00201800
         STH   R6,BBRDW                                                 00201900
*            BSIZE = '0000'X;                                           00202000
         XC    BSIZE(2),BSIZE                                           00202100
*            R7 = ADDR(BBRDW);                                          00202200
         LA    R7,BBRDW                                                 00202300
*          END;                                                         00202400
@RF00828 LA    R12,WORKWDCB   GET DCB ADDRESS                           00202500
*                                                                       00202600
         WRITE WORKWDEC,SF,(12),(7)  ISSUE WRITE                        00202700
*                                                                       00202800
         CHECK WORKWDEC     MAKE SURE WRITE COMPLETES BEFORE PROCEED    00202900
*                                                                       00203000
         NOTE  (12)     RETRIEVE RELATIVE RECORD LOCATION ON DIRECTWK   00203100
*                                                                       00203200
         ST    R1,TTRSAVE  SAVE TTR FOR SORTABLE                        00203300
         CLC   TTRSAVE(2),MAXTRK         ON LAST TRACK OF DATA SET ?    00203400
         BNL   OVERFLOW    GO TELL OF OVERFLOW CONDITION                00203500
*RECCCHHR = TTRSAVE; /*PUT IN COMTABLE FOR USER ACCESS               */ 00203600
         L     R6,SAVER2                                                00203700
         MVI   RECCCHHR+4(R6),C' '                                      00203800
         MVC   RECCCHHR(4,R6),TTRSAVE                                   00203900
         B     @ER00019                                                 00204000
*                                                                       00204100
*END;                                                                   00204200
*ELSE /*IF DATA SET IS NOT OPEN                                      */ 00204300
*  DO;                                                                  00204400
*    MSGNO = 28;                                                        00204500
@RF00824 MVC   MSGNO(4),KF28                                            00204600
*    CALL ERRMSG;                                                       00204700
         BAL   R14,ERRMSG                                               00204800
*    BADNEWS = TWELVE;                                                  00204900
         MVC   BADNEWS(4),KF12                                          00205000
*  END;                                                                 00205100
*END; /*CLOSING END TO SCRSCHT PROC                                  */ 00205200
@ER00019 LM    R14,R12,@SA00019                                         00205300
         BR    R14                                                      00205400
*                                                                       00205500
*DIRRDSCR: PROC OPTIONS(DONTSAVE(R7)); /*READ DIRECTWK SEQUENTIALLY*/   00205600
DIRRDSCR STM   R14,R6,@SA00020                                          00205700
         STM   R8,R12,@SA00020+36                                       00205800
*                                     /*USING POINT                  */ 00205900
*IF INDIR = YES &  /*IF DATA SET OPEN AND OPEN FOR SEQUENTIAL*/         00206000
*   CLOSE2 = YES THEN /*POINT READING                                */ 00206100
         TM    IOSWTCH+1,INDIR+CLOSE2                                   00206200
         BNO   @RF00846                                                 00206300
*  DO;                                                                  00206400
*    READWKCT = READWKCT + 1;                                           00206500
         LA    R14,1                                                    00206600
         AL    R14,READWKCT                                             00206700
         ST    R14,READWKCT                                             00206800
         LA    R7,BUF1                                                  00206900
         LA    R12,WORKRDCB                                             00207000
         LA    R6,RECCCHHR                                              00207100
         A     R6,SAVER2                                                00207200
*                                                                       00207300
         POINT (12),(6)                                                 00207400
*                                                                       00207500
         READ  WORKRDEC,SF,(12),(7)                                     00207600
*                                                                       00207700
         CHECK WORKRDEC                                                 00207800
*                                                                       00207900
*        R7 = R7 + 4; /*POINT PAST RDW FOR RETURN TO CALLER          */ 00208000
         LA    R15,4                                                    00208100
         ALR   R7,R15                                                   00208200
*        BUF1L = BUF1RDWL; /*MOVE RECORD LENGTH TO 2 BYTES BEFORE REC*/ 00208300
         LH    R14,BUF1RDWL                                             00208400
         STH   R14,BUF1L                                                00208500
*        BUF1L = BUF1L - 4; /*RECORD DATA LENGTH ONLY                */ 00208600
         SLR   R14,R15                                                  00208700
         STH   R14,BUF1L                                                00208800
*        SCRATCH = YES; /*JUST READ CURRENT RECORD OFF DIRECTWK*/       00208900
         OI    IOSWTCH+2,SCRATCH                                        00209000
*        RECLNGTH = BUF1L;                                              00209100
         L     R15,SAVER2                                               00209200
         STH   R14,RECLNGTH(,R15)                                       00209300
         B     @ER00020                                                 00209400
*                                                                       00209500
*  END;                                                                 00209600
*ELSE /*DATA SET NOT OPEN                                            */ 00209700
*  DO;                                                                  00209800
*    MSGNO = 46;                                                        00209900
@RF00846 MVC   MSGNO(4),KF46                                            00210000
*    CALL ERRMSG;                                                       00210100
         BAL   R14,ERRMSG                                               00210200
*    BADNEWS = TWELVE;                                                  00210300
         MVC   BADNEWS(4),KF12                                          00210400
*  END;                                                                 00210500
*END; /*CLOSING END TO PROC DIRRDSER                                 */ 00210600
@ER00020 LM    R14,R6,@SA00020                                          00210700
         LM    R8,R12,@SA00020+36                                       00210800
         BR    R14                                                      00210900
*                                                                       00211000
*DIRECTIT: PROC OPTIONS(DONTSAVE(R7)); /*CHOOSE DIRECT READ OF SERLOG*/ 00211100
DIRECTIT STM   R14,R6,@SA00021                                          00211200
         STM   R8,R12,@SA00021+36                                       00211300
*                                     /*OR DIRECTWK                  */ 00211400
*IF HISTYES = YES THEN /*IS DIRECTWK DATA SET                        */ 00211500
         TM    IOSWTCH,HISTYES                                          00211600
         BNO   @RF00865                                                 00211700
*  CALL DIRRDSCR;                                                       00211800
         BAL   R14,DIRRDSCR                                             00211900
         B     @ER00021                                                 00212000
*                                                                       00212100
*ELSE /*IS SERLOG BY DEFAULT                                         */ 00212200
*  CALL DIRRDSER;                                                       00212300
@RF00865 BAL   R14,DIRRDSER                                             00212400
*END; /*CLOSING END TO DIRECTIT                                      */ 00212500
@ER00021 LM    R14,R6,@SA00021                                          00212600
         LM    R8,R12,@SA00021+36                                       00212700
         BR    R14                                                      00212800
*                                                                       00212900
*CLOSDIR: PROC; /*CLOSE DIRECTWK DATA SET                            */ 00213000
CLOSDIR  STM   R14,R12,@SA00022                                         00213100
*IF INDIR = YES THEN /*IF DATA SET IS OPEN THEN                      */ 00213200
         TM    IOSWTCH+1,INDIR                                          00213300
         BNO   @RF00872                                                 00213400
*  DO;                                                                  00213500
*    IF CLOSE2 = NO THEN /*IF CLOSING DIRECTWK FOR WRITING           */ 00213600
         TM    IOSWTCH+1,CLOSE2                                         00213700
         BNZ   @RF00874                                                 00213800
*      DO;                                                              00213900
*        IF DEBUG15 = ON THEN                                           00214000
         L     R1,SAVER2                                                00214100
         TM    DEBUG15(R1),B'00000001'                                  00214200
         BNO   @RF00876                                                 00214300
*          DO;                                                          00214400
*            MSGNO = 61;                                                00214500
         MVC   MSGNO(4),KF61                                            00214600
*            CALL ERRMSG;                                               00214700
         BAL   R14,ERRMSG                                               00214800
*          END;                                                         00214900
*        CLOSE2 = YES; /*INDICATE CLOSED FOR WRITING                 */ 00215000
@RF00876 OI    IOSWTCH+1,CLOSE2                                         00215100
*                                                                       00215200
         CLOSE (WORKWDCB)           CLOSE WRITE DCB                     00215300
*                                                                       00215400
         LA    R12,WORKRDCB         GET READING DCB                     00215500
*                                                                       00215600
         OPEN  ((R12),(INPUT))      OPEN FOR READING DIRECTWK           00215700
*                                                                       00215800
         TM    DCBOFLGS,DCBOFOPN    IF OPEN SUCCESSFUL                  00215900
         BZ    BADBRSEQ     IF FAILS,GO PRINT MESSAGE;                  00216000
*    INDIR = YES; /*INDICATE OPEN SUCCESSFUL                         */ 00216100
         OI    IOSWTCH+1,INDIR                                          00216200
         L     R1,SAVER2                                                00216300
         TM    DEBUG15(R1),B'00000001'                                  00216400
         BNO   @ER00022                                                 00216500
         MVC   MSGNO(4),KF82                                            00216600
         BAL   R14,ERRMSG                                               00216700
         B     @ER00022                                                 00216800
*                                                                       00216900
*   END;                                                                00217000
*  ELSE /*CLOSE FOR SEQUENTIAL POINT READING                         */ 00217100
*    DO;                                                                00217200
*      IF DEBUG15 = ON THEN                                             00217300
@RF00874 L     R1,SAVER2                                                00217400
         TM    DEBUG15(R1),B'00000001'                                  00217500
         BNO   @RF00886                                                 00217600
*        DO;                                                            00217700
*          MSGNO = 62;                                                  00217800
         MVC   MSGNO(4),KF62                                            00217900
*          CALL ERRMSG;                                                 00218000
         BAL   R14,ERRMSG                                               00218100
*        END;                                                           00218200
*                             /*ISSUE CLOSE SVC                      */ 00218300
@RF00886 CLOSE (WORKRDCB)                                               00218400
*                                                                       00218500
         B     @ER00022                                                 00218600
*                                                                       00218700
*    END;                                                               00218800
*   END;                                                                00218900
* ELSE  /*CLOSE REQUESTED WHEN NOT OPEN                              */ 00219000
*   DO;                                                                 00219100
*     IF CLOSEIO Å= CLOSEALL THEN /*END OF JOB WRAPUP IS ALLOWED*/      0021920
@RF00872 L     R1,SAVER2                                                00219300
         CLC   CLOSEIO(2,R1),@CB00262                                   00219400
         BE    @ER00022                                                 00219500
*       DO;                                                             00219600
*         MSGNO = 29;                                                   00219700
         MVC   MSGNO(4),KF29                                            00219800
*         CALL ERRMSG;                                                  00219900
         BAL   R14,ERRMSG                                               00220000
*         BADNEWS = TWELVE;                                             00220100
         MVC   BADNEWS(4),KF12                                          00220200
*       END;                                                            00220300
*   END;                                                                00220400
*END; /*CLOSING END TO PROC CLOSDIR                                  */ 00220500
@ER00022 LM    R14,R12,@SA00022                                         00220600
         BR    R14                                                      00220700
*                                                                       00220800
*READSIT: PROC OPTIONS(DONTSAVE(R7)); /*READ FROM SERLOG OR ACCIN*/     00220900
*                                     /*SEQUENTIALLY                 */ 00221000
READSIT  STM   R14,R6,@SA00023                                          00221100
         STM   R8,R12,@SA00023+36                                       00221200
*IF INHISO = YES THEN /*IF ACCIN IS OPEN, READ IT. IF BOTH SERLOG */    00221300
         TM    IOSWTCH,INHISO                                           00221400
         BNO   @RF00906                                                 00221500
*  CALL READHIST;     /*AND ACCIN ARE OPEN, READ ACCIN FIRST         */ 00221600
         BAL   R14,READHIST                                             00221700
         B     @ER00023                                                 00221800
*                                                                       00221900
*ELSE           /*IMPLIES HISTORY NOT OPEN                           */ 00222000
*  DO;                                                                  00222100
*    IF SERLO = YES THEN /*IF SERLOG IS OPEN THEN IMPLIES ACCIN*/       00222200
@RF00906 TM    IOSWTCH+1,SERLO                                          00222300
         BNO   @RF00909                                                 00222400
*      CALL READSER;    /*NEVER OPEN OR ACCIN HAS BEEN READ, CLOSED*/   00222500
         BAL   R14,READSER                                              00222600
         B     @ER00023                                                 00222700
*                                                                       00222800
*    ELSE                /*NEITHER DATA SET OPEN IMPLIED             */ 00222900
*      DO;                                                              00223000
*        BADNEWS = TWELVE; /*SET BAD RETURN CODE                     */ 00223100
@RF00909 MVC   BADNEWS(4),KF12                                          00223200
*        MSGNO = 21;     /*INDICATE ERROR MESSAGE TEXT NUMBER*/         00223300
         MVC   MSGNO(4),KF21                                            00223400
*        CALL ERRMSG; /*PRINT THE ERROR TO TOURIST                   */ 00223500
         BAL   R14,ERRMSG                                               00223600
*      END;                                                             00223700
*   END;                                                                00223800
* END; /*CLOSING END TO READSIT PROC                                 */ 00223900
@ER00023 LM    R14,R6,@SA00023                                          00224000
         LM    R8,R12,@SA00023+36                                       00224100
         BR    R14                                                      00224200
*                                                                       00224300
*READHIST: PROC OPTIONS(DONTSAVE(R7)); /*READ ACCIN SEQUENTIALLY*/      00224400
READHIST STM   R14,R6,@SA00024                                          00224500
         STM   R8,R12,@SA00024+36                                       00224600
*    ACIRDCT = ACIRDCT + 1; /*ACCIN READ ATTEMPTS                    */ 00224700
         LA    R6,1                                                     00224800
         AL    R6,ACIRDCT                                               00224900
         ST    R6,ACIRDCT                                               00225000
*    R7 = ADDR(BUF1RDW); /*GET ADDRESS OF WORKAREA                   */ 00225100
         LA    R7,BUF1RDW                                               00225200
*                        /*GET ADDRESS OF DCB                        */ 00225300
         LA    R12,INHIST                                               00225400
*                         /*RETRIEVE A RECORD. NOTE THAT RECORD WILL*/  00225500
         GET   (R12),(R7)                                               00225600
*                       /*WILL BE HERE FOR RITE TO SCRATCH AND FOR*/    00225700
*                       /*WRITE TO ACCDEV                            */ 00225800
*    R7 = R7 + 4; /*POINT PAST RDW FOR RETURN TO CALLER              */ 00225900
         LA    R6,4                                                     00226000
         ALR   R7,R6                                                    00226100
*    FLIPFLOP = YES;  /*TELL READIRCT WHAT STORY IS                  */ 00226200
         OI    IOSWTCH,FLIPFLOP                                         00226300
*    RECCCHHR = (RECCCHHR && RECCCHHR); /*SET TO ACCIN INPUT IN PARM*/  00226400
         L     R14,SAVER2                                               00226500
         XC    RECCCHHR(5,R14),RECCCHHR(R14)                            00226600
*    RECLNGTH = BUF1RDWL-4;  /*SET REC LTH IN PARM TABLE             */ 00226700
         LCR   R6,R6                                                    00226800
         AH    R6,BUF1RDWL                                              00226900
         STH   R6,RECLNGTH(,R14)                                        00227000
*END; /*CLOSING END TO READHIST PROC                                 */ 00227100
@ER00024 LM    R14,R6,@SA00024                                          00227200
         LM    R8,R12,@SA00024+36                                       00227300
         BR    R14                                                      00227400
*                                                                       00227500
*OPENDIR : PROC; /*OPEN DIRECTWK DATA SET FOR SEQUENTIAL LOAD*/         00227600
OPENDIR  STM   R14,R12,@SA00025                                         00227700
*IF INDIR  = NO THEN /*IF IT HASNT BEEN OPENED BEFORE                */ 00227800
         TM    IOSWTCH+1,INDIR                                          00227900
         BNZ   @RF00933                                                 00228000
*  DO;                                                                  00228100
*    IF DEBUG15 = ON THEN                                               00228200
         L     R15,SAVER2                                               00228300
         TM    DEBUG15(R15),B'00000001'                                 00228400
         BNO   @RF00935                                                 00228500
*      DO;                                                              00228600
*        MSGNO = 63;                                                    00228700
         MVC   MSGNO(4),KF63                                            00228800
*        CALL ERRMSG;                                                   00228900
         BAL   R14,ERRMSG                                               00229000
*      END;                                                             00229100
*                          /*GET ADDRESS OF DCB                      */ 00229200
@RF00935 LA    R12,WORKWDCB                                             00229300
*                                /*OPEN DIRECTWK TO LOAD SEQUENTIALLY*/ 00229400
         OPEN  ((R12),(OUTPUT))                                         00229500
*                                    /*WAS OPEN SUCCESSFUL           */ 00229600
         TM    DCBOFLGS,DCBOFOPN                                        00229700
*                       /*SET BAD RETURN CODE AND PRINT ERRMSG*/        00229800
         BZ    BADBWSEQ                                                 00229900
         L     R1,DCBDEBAD  R1 -> DEB                                   00230000
*                           LOAD NUMBER OF TRACKS IN THIS EXTENT        00230100
         LH    R1,DEBNMTRK-DEBDASD+DEBBASND-DEBBASIC(R1)                00230200
         BCTR  R1,0         SUBTRACT ONE FOR RELATIVE TRACK NUMBER      00230300
         STH   R1,MAXTRK    SAVE NUMBER OF TRACKS OF OVERFLOW CHECK     00230400
*INDIR = YES; /*SET SUCCESSFUL OPEN OF DIRECTWK FLAG                 */ 00230500
         OI    IOSWTCH+1,INDIR                                          00230600
         B     @ER00025                                                 00230700
*                                                                       00230800
*END;                                                                   00230900
*ELSE /*IF DATA SET IS ALREADY OPEN                                  */ 00231000
*  DO;                                                                  00231100
*    BADNEWS = TWELVE; /*SET RETURN CODE TO ERROR                    */ 00231200
@RF00933 MVC   BADNEWS(4),KF12                                          00231300
*    MSGNO = 31;                                                        00231400
         MVC   MSGNO(4),KF31                                            00231500
*    CALL ERRMSG; /*WRITE MESSAGE TO TOURIST DATA SET                */ 00231600
         BAL   R14,ERRMSG                                               00231700
*  END;                                                                 00231800
*END; /*CLOSING END TO OPENDIR PROC                                  */ 00231900
@ER00025 LM    R14,R12,@SA00025                                         00232000
         BR    R14                                                      00232100
*                                                                       00232200
*OPENHIST: PROC; /*OPEN ACCIN DATA SET                               */ 00232300
OPENHIST STM   R14,R12,@SA00026                                         00232400
*IF INHISO = NO THEN /*IF IT HASNT BEEN OPENED BEFORE                */ 00232500
         TM    IOSWTCH,INHISO                                           00232600
         BNZ   @RF00956                                                 00232700
*  DO;                                                                  00232800
*    IF DEBUG15 = ON THEN                                               00232900
         L     R1,SAVER2                                                00233000
         TM    DEBUG15(R1),B'00000001'                                  00233100
         BNO   @RF00958                                                 00233200
*      DO;                                                              00233300
*        MSGNO = 64;                                                    00233400
         MVC   MSGNO(4),KF64                                            00233500
*        CALL ERRMSG;                                                   00233600
         BAL   R14,ERRMSG                                               00233700
*      END;                                                             00233800
*                        /*GET ADDRESS OF DCB                        */ 00233900
@RF00958 LA    R12,INHIST                                               00234000
*                               /*OPEN ACCIN                         */ 00234100
         OPEN  ((R12),(INPUT))                                          00234200
*                             /*WAS OPEN SUCCESSFUL ?                */ 00234300
         TM    DCBOFLGS,DCBOFOPN                                        00234400
*                      /*SET BAD RETURN CODE AND PRINT ERRMSG*/         00234500
         BZ    BDOIHST                                                  00234600
*                              /*IS CORRECT FORMAT                   */ 00234700
         TM    DCBRECFM,DCBRECV                                         00234800
*                      /*IF NOT, GO TELL WORLD, SET BAD R.C.         */ 00234900
         BZ    BDIST                                                    00235000
*                              /*IS RECFM U                          */ 00235100
         TM    DCBRECFM,DCBRECU                                         00235200
         BO    BDIST                                                    00235300
*    INHISO = YES; /*TELL OF SUCCESSFUL OPEN OF ACCIN                */ 00235400
*    HISTYES = YES;                                                     00235500
         OI    IOSWTCH,HISTYES+INHISO                                   00235600
         B     @ER00026                                                 00235700
*                                                                       00235800
*  END;                                                                 00235900
*ELSE /*IF OPEN ASKED WHEN ALREADY OPEN                                 00236000
*  DO;                                                                  00236100
*    MSGNO = 11; /*TELL WHAT MESSAGE NUMBER TO PRINT                 */ 00236200
@RF00956 MVC   MSGNO(4),KF11                                            00236300
*    CALL ERRMSG; /*GO SELECT MESSAGE AND PRINT TO TOURIST           */ 00236400
         BAL   R14,ERRMSG                                               00236500
*    BADNEWS = TWELVE; /*TELL USER BAD NEWS                          */ 00236600
         MVC   BADNEWS(4),KF12                                          00236700
*  END;                                                                 00236800
*END; /*CLOSING END TO OPEN HISTORY INPUT DATA SET PROC              */ 00236900
@ER00026 LM    R14,R12,@SA00026                                         00237000
         BR    R14                                                      00237100
*                                                                       00237200
*CLOSHIST: PROC; /*CLOSE ACCIN DATA SET                              */ 00237300
CLOSHIST STM   R14,R12,@SA00027                                         00237400
*IF INHISO = YES THEN /*IF DATA SET IS OPEN THEN                     */ 00237500
         TM    IOSWTCH,INHISO                                           00237600
         BNO   @RF00983                                                 00237700
*  DO;                                                                  00237800
*    IF DEBUG15 = ON THEN                                               00237900
         L     R1,SAVER2                                                00238000
         TM    DEBUG15(R1),B'00000001'                                  00238100
         BNO   @RF00985                                                 00238200
*      DO;                                                              00238300
*        MSGNO = 65;                                                    00238400
         MVC   MSGNO(4),KF65                                            00238500
*        CALL ERRMSG;                                                   00238600
         BAL   R14,ERRMSG                                               00238700
*      END;                                                             00238800
*                         /*GET ACCIN DCB ADDRESS                    */ 00238900
@RF00985 LA    R12,INHIST                                               00239000
*                                  /*ISSUE CLOSE SVC                 */ 00239100
         CLOSE  (INHIST)                                                00239200
*                          /*GET RID OF ACCIN BUFFERS                */ 00239300
         FREEPOOL  (R12)                                                00239400
*    INHISO = NO; /*SAY THAT ACCIN IS CLOSED                         */ 00239500
         NI    IOSWTCH,255-INHISO                                       00239600
         B     @ER00027                                                 00239700
*                                                                       00239800
*  END;                                                                 00239900
*ELSE  /*IF DATA SET IS ALREADY CLOSED                               */ 00240000
*  DO;                                                                  00240100
*    IF CLOSEIO Å= CLOSEALL THEN                                        0024020
@RF00983 L     R1,SAVER2                                                00240300
         CLC   CLOSEIO(2,R1),@CB00262                                   00240400
         BE    @ER00027                                                 00240500
*    DO;                                                                00240600
*    MSGNO = 12;                                                        00240700
         LA    R2,12                                                    00240800
         ST    R2,MSGNO                                                 00240900
*    BADNEWS = TWELVE;                                                  00241000
         ST    R2,BADNEWS                                               00241100
*    CALL ERRMSG;                                                       00241200
         BAL   R14,ERRMSG                                               00241300
*    END;                                                               00241400
*  END;                                                                 00241500
*END; /*CLOSING END TO CLOSE ACCIN DATA SET PROC                     */ 00241600
@ER00027 LM    R14,R12,@SA00027                                         00241700
         BR    R14                                                      00241800
*                                                                       00241900
*CLOSEDEV: PROC; /*PROC TO CLOSE ACCDEV DATA SET                     */ 00242000
CLOSEDEV STM   R14,R12,@SA00028                                         00242100
*IF HISTOPN = YES THEN                                                  00242200
         TM    IOSWTCH,HISTOPN                                          00242300
         BNO   @RF01007                                                 00242400
*  DO;                                                                  00242500
*    IF DEBUG15 = ON THEN                                               00242600
         L     R1,SAVER2                                                00242700
         TM    DEBUG15(R1),B'00000001'                                  00242800
         BNO   @RF01009                                                 00242900
*      DO;                                                              00243000
*        MSGNO = 66;                                                    00243100
         MVC   MSGNO(4),KF66                                            00243200
*        CALL ERRMSG;                                                   00243300
         BAL   R14,ERRMSG                                               00243400
*      END;                                                             00243500
*                         /*FIND ADDRESS OF DCB                      */ 00243600
@RF01009 LA    R12,OUTHIST                                              00243700
*                                /*ISSUE CLOSE SVC                   */ 00243800
         CLOSE (OUTHIST)                                                00243900
*                          /*GET RID OF ACCDEV BUFFERS               */ 00244000
         FREEPOOL  (R12)                                                00244100
*    HISTOPN = NO; /*SAY THAT DATA SET IS CLOSED                     */ 00244200
         NI    IOSWTCH,255-HISTOPN                                      00244300
         B     @ER00028                                                 00244400
*                                                                       00244500
*  END;                                                                 00244600
*ELSE /*IF ACCDEV IS ALREADY CLOSED                                     00244700
* DO;                                                                   00244800
*   IF CLOSEIO \= CLOSEALL /*END OF JOB STEP VALID REQUEST           */ 00244900
*     THEN DO;                                                          00245000
@RF01007 L     R1,SAVER2                                                00245100
         CLC   CLOSEIO(2,R1),@CB00262                                   00245200
         BE    @ER00028                                                 00245300
*       MSGNO = 8;                                                      00245400
         MVC   MSGNO(4),KF8                                             00245500
*       BADNEWS = TWELVE;                                               00245600
         MVC   BADNEWS(4),KF12                                          00245700
*       CALL ERRMSG;                                                    00245800
         BAL   R14,ERRMSG                                               00245900
*     END;                                                              00246000
* END;                                                                  00246100
*END; /*CLOSING END TO PROC CLOSEDEV                                 */ 00246200
@ER00028 LM    R14,R12,@SA00028                                         00246300
         BR    R14                                                      00246400
*                                                                       00246500
*OPENTOUR : PROC; /*OPEN THE TOURIST DATA SET                        */ 00246600
OPENTOUR STM   R14,R12,@SA00029                                         00246700
*  IF TOUROPN = NO THEN /*ILLEGAL TO OPEN AN OPEN DATA SET           */ 00246800
         TM    IOSWTCH+1,TOUROPN                                        00246900
         BNZ   @RF01031                                                 00247000
*    DO;                                                                00247100
         LA    R12,TOURDCB                                              00247200
*                                                                       00247300
         OPEN  ((R12),(OUTPUT))                                         00247400
*                                                                       00247500
         TM    DCBOFLGS,DCBOFOPN  CHECK FOR SUCCESS                     00247600
         BZ    BADOTOUR                                                 00247700
*      TOUROPN = YES; /*HURRAY FOR SUCCESSFUL OPEN                   */ 00247800
         OI    IOSWTCH+1,TOUROPN                                        00247900
*      PRINTADR = ADDR(PRNTBF);                                         00248000
         LA    R6,PRNTBF                                                00248100
         L     R1,SAVER2                                                00248200
         ST    R6,PRINTADR(,R1)                                         00248300
*      R7 = PRINTADR + 1;                                               00248400
         LA    R7,1                                                     00248500
         ALR   R7,R6                                                    00248600
*      PRINTCC = SKIPNEW;                                               00248700
         MVI   PRINTCC(R6),X'8B'                                        00248800
*                            /*INITIAL SKIP TO NEW PAGE              */ 00248900
         PUT  (R12),(R7)                                                00249000
*                                                                       00249100
         B     @ER00029                                                 00249200
*    END;                                                               00249300
* ELSE  /*IF TOURIST ALREADY OPEN THEN                                  00249400
*   DO;                                                                 00249500
*     MSGNO = 23;                                                       00249600
@RF01031 MVC   MSGNO(4),KF23                                            00249700
*     CALL ERRMSG;                                                      00249800
         BAL   R14,ERRMSG                                               00249900
*     BADNEWS = TWELVE;                                                 00250000
         MVC   BADNEWS(4),KF12                                          00250100
*   END;                                                                00250200
*END; /*CLOSING END TO PROC OPENTOUR                                 */ 00250300
@ER00029 LM    R14,R12,@SA00029                                         00250400
         BR    R14                                                      00250500
*                                                                       00250600
*CLOSTOUR: PROC; /*CLOSE THE TOURIST DATA SET                        */ 00250700
CLOSTOUR STM   R14,R12,@SA00030                                         00250800
*IF TOUROPN = YES THEN /*IF REALLY NEEDS CLOSING                     */ 00250900
         TM    IOSWTCH+1,TOUROPN                                        00251000
         BNO   @RF01049                                                 00251100
*  DO;                                                                  00251200
*    IF DEBUG15 = ON THEN /*PRINT SUMMARY OF IO OPERATIONS DURING RUN*/ 00251300
         L     R1,SAVER2                                                00251400
         TM    DEBUG15(R1),B'00000001'                                  00251500
         BNO   @RF01051                                                 00251600
*             DO J = 1 TO 11; /*PRINT ALL DEBUG15 TOTALS             */ 00251700
         LA    R2,1                                                     00251800
         ST    R2,J                                                     00251900
*           MSGNO = J + 70; /*INCREMENT PAST SYSTEM MESSAGES         */ 00252000
@DL01052 AL    R2,KF70                                                  00252100
         ST    R2,MSGNO                                                 00252200
*          CALL ERRMSG; /*PRINT OUT SUMMARY MESSAGE TEXT             */ 00252300
         BAL   R14,ERRMSG                                               00252400
*          PASSNUM = CTPTR(J); /*ACCESS PARTICULAR COUNT             */ 00252500
         L     R3,J                                                     00252600
         SLA   R3,2                                                     00252700
         L     R4,CTPTR-4(R3)                                           00252800
         ST    R4,PASSNUM                                               00252900
*          CVD(PASSNUM,PACKPAS); /*CONVERT BINARY TO PACKED          */ 00253000
         CVD   R4,WORKD                                                 00253100
         MVC   PACKPAS(4),WORKD+4                                       00253200
*          PACKPAS = (PACKPAS | '0000000F'X); /*TURN C TO F          */ 00253300
         OC    PACKPAS(4),@CB01094                                      00253400
*          UNPK(EDFLD,PACKPAS); /*CHANGE PACKED TO PRINTABLE         */ 00253500
         UNPK  EDFLD(9),PACKPAS(4)                                      00253600
*          NONBLANK = OFF;                                              00253700
         NI    IOSWTCH+1,255-NONBLANK                                   00253800
*          DO K = 1 BY 1 TO 8 WHILE NONBLANK = OFF;                     00253900
         LA    R5,1                                                     00254000
         ST    R5,K                                                     00254100
@DL01060 TM    IOSWTCH+1,NONBLANK                                       00254200
         BNZ   @DC01060                                                 00254300
*            IF EDIFILD(K) = CHARZERO THEN                              00254400
         LA    R4,EDIFILD-1(R5)                                         00254500
         CLI   0(R4),X'F0'                                              00254600
         BNE   @RF01061                                                 00254700
*              EDIFILD(K) = BLANK;                                      00254800
         LA    R4,EDIFILD-1(R5)                                         00254900
         MVI   0(R4),X'40'                                              00255000
         B     @RC01061                                                 00255100
*                                                                       00255200
*            ELSE                                                       00255300
*              NONBLANK = ON;                                           00255400
@RF01061 OI    IOSWTCH+1,NONBLANK                                       00255500
*          END;                                                         00255600
@RC01061 LA    R5,1                                                     00255700
         AL    R5,K                                                     00255800
         ST    R5,K                                                     00255900
         C     R5,KF8                                                   00256000
         BNH   @DL01060                                                 00256100
*          PRINTADR = ADDR(PRNTBF);                                     00256200
@DC01060 LA    R6,PRNTBF                                                00256300
         L     R7,SAVER2                                                00256400
         ST    R6,PRINTADR(,R7)                                         00256500
*          PRINTDS = '1'; /*INDICATE PRINT TO TOURIST                */ 00256600
         MVI   PRINTDS(R6),C'1'                                         00256700
*     PRINTBDY = BLANKS; /*CLEAR PRINT LINE FOR CALLER               */ 00256800
         MVC   PRINTBDY(132,R6),BLANKS                                  00256900
         MVC   PRNTBF+10(9),EDFLD                                       00257000
*          CALL PRINTIT;                                                00257100
         BAL   R14,PRINTIT                                              00257200
*        END;                                                           00257300
         LA    R2,1                                                     00257400
         AL    R2,J                                                     00257500
         ST    R2,J                                                     00257600
         C     R2,KF11                                                  00257700
         BNH   @DL01052                                                 00257800
@RF01051 LA    R12,TOURDCB                                              00257900
*                                                                       00258000
         CLOSE (TOURDCB)                                                00258100
*                                                                       00258200
         FREEPOOL (12)                                                  00258300
*    TOUROPN = NO; /*INDICATE CLOSE                                  */ 00258400
         NI    IOSWTCH+1,255-TOUROPN                                    00258500
         B     @ER00030                                                 00258600
*                                                                       00258700
* END;                                                                  00258800
*ELSE /*IF ALREADY CLOSED THEN                                          00258900
* DO;                                                                   00259000
*   IF CLOSEIO Å= CLOSEALL THEN /*LEGAL TO DO END OF JOB WRAPUP*/       0025910
@RF01049 L     R3,SAVER2                                                00259200
         CLC   CLOSEIO(2,R3),@CB00262                                   00259300
         BE    @ER00030                                                 00259400
*     DO;                                                               00259500
*       R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2            */ 00259600
         LR    R2,R3                                                    00259700
*       CALL IFCMSG(204,ADDR(PRNTBF));                                  00259800
         LA    R2,PRNTBF                                                00259900
         ST    R2,@AFTEMPS+12                                           00260000
         L     R15,ADIFCMSG(,R3)                                        00260100
         LA    R1,@AL01078                                              00260200
         BALR  R14,R15                                                  00260300
*       BADNEWS = TWELVE;                                               00260400
         MVC   BADNEWS(4),KF12                                          00260500
*     END;                                                              00260600
* END;                                                                  00260700
*END; /*CLOSING END TO CLOSTOUR PROCEDURE                            */ 00260800
@ER00030 LM    R14,R12,@SA00030                                         00260900
         BR    R14                                                      00261000
*                                                                       00261100
*OPENERPT: PROC; /*OPEN THE ERREPT D.S. FOR PRINTING                 */ 00261200
OPENERPT STM   R14,R12,@SA00031                                         00261300
*IF ERPTOPN = NO THEN                                                   00261400
         TM    IOSWTCH+1,ERPTOPN                                        00261500
         BNZ   @RF01086                                                 00261600
*  DO;                                                                  00261700
*    IF DEBUG15 = ON THEN                                               00261800
         L     R1,SAVER2                                                00261900
         TM    DEBUG15(R1),B'00000001'                                  00262000
         BNO   @RF01088                                                 00262100
*      DO;                                                              00262200
*        MSGNO = 67;                                                    00262300
         MVC   MSGNO(4),KF67                                            00262400
*        CALL ERRMSG;                                                   00262500
         BAL   R14,ERRMSG                                               00262600
*      END;                                                             00262700
@RF01088 LA    R12,EREPTDCB                                             00262800
*                                                                       00262900
         OPEN  ((R12),(OUTPUT))                                         00263000
*                                                                       00263100
         TM    DCBOFLGS,DCBOFOPN                                        00263200
         BZ    BADORPT                                                  00263300
*    ERPTOPN = YES; /*INDICATE SUCCESSFUL OPEN                       */ 00263400
         OI    IOSWTCH+1,ERPTOPN                                        00263500
*  END;                                                                 00263600
*ELSE /*IF OPEN REQUESTED WHEN DATA SET ALREADY OPEN                    00263700
*  DO;                                                                  00263800
         B     @ER00031                                                 00263900
@RF01086 DS    0H                                                       00264000
*    MSGNO = 45;                                                        00264100
         MVC   MSGNO(4),KF45                                            00264200
*    CALL ERRMSG;                                                       00264300
         BAL   R14,ERRMSG                                               00264400
*    BADNEWS = TWELVE;                                                  00264500
         MVC   BADNEWS(4),KF12                                          00264600
*  END;                                                                 00264700
*END; /*CLOSING END TO PROC OPENERPT                                 */ 00264800
@ER00031 LM    R14,R12,@SA00031                                         00264900
         BR    R14                                                      00265000
*                                                                       00265100
*CLOSERPT : PROC; /*OPEN ERREPT DATA SET                             */ 00265200
CLOSERPT STM   R14,R12,@SA00032                                         00265300
*IF ERPTOPN = YES THEN /*MUST BE OPEN IN ORDER TO CLOSE              */ 00265400
         TM    IOSWTCH+1,ERPTOPN                                        00265500
         BNO   @RF01105                                                 00265600
*  DO;                                                                  00265700
*    IF DEBUG15 = ON THEN                                               00265800
         L     R1,SAVER2                                                00265900
         TM    DEBUG15(R1),B'00000001'                                  00266000
         BNO   @RF01107                                                 00266100
*      DO;                                                              00266200
*        MSGNO = 68;                                                    00266300
         MVC   MSGNO(4),KF68                                            00266400
*        CALL ERRMSG;                                                   00266500
         BAL   R14,ERRMSG                                               00266600
*      END;                                                             00266700
@RF01107 LA    R12,EREPTDCB                                             00266800
*                                                                       00266900
         CLOSE (EREPTDCB)                                               00267000
*                                                                       00267100
         FREEPOOL (R12)                                                 00267200
*    ERPTOPN = NO; /*INDICATE ERREPT IS CLOSED                       */ 00267300
         NI    IOSWTCH+1,255-ERPTOPN                                    00267400
         B     @ER00032                                                 00267500
*                                                                       00267600
*  END;                                                                 00267700
*ELSE /*IF CLOSE REQUESTED WHEN NOT OPEN THEN                           00267800
* DO;                                                                   00267900
*   IF CLOSEIO \= CLOSEALL THEN  /*VALID POTPOURI OF CLOSES          */ 00268000
@RF01105 L     R1,SAVER2                                                00268100
         CLC   CLOSEIO(2,R1),@CB00262                                   00268200
         BE    @ER00032                                                 00268300
*     DO;                                                               00268400
*       MSGNO = 22;                                                     00268500
         MVC   MSGNO(4),KF22                                            00268600
*       CALL ERRMSG;                                                    00268700
         BAL   R14,ERRMSG                                               00268800
*       BADNEWS = TWELVE;                                               00268900
         MVC   BADNEWS(4),KF12                                          00269000
*     END;                                                              00269100
*   END;                                                                00269200
*END; /*CLOSING END TO CLOSERPT PROC                                 */ 00269300
@ER00032 LM    R14,R12,@SA00032                                         00269400
         BR    R14                                                      00269500
*                                                                       00269600
*OPENDEV: PROC; /*OPEN ACCDEV DATA SET                               */ 00269700
OPENDEV  STM   R14,R12,@SA00033                                         00269800
*IF HISTOPN = NO THEN /*IF DATA SET HAS NOT ALREADY BEEN OPENED*/       00269900
         TM    IOSWTCH,HISTOPN                                          00270000
         BNZ   @RF01127                                                 00270100
*  DO;                                                                  00270200
*    IF DEBUG15 = ON THEN                                               00270300
         L     R1,SAVER2                                                00270400
         TM    DEBUG15(R1),B'00000001'                                  00270500
         BNO   @RF01129                                                 00270600
*      DO;                                                              00270700
*        MSGNO = 69;                                                    00270800
         MVC   MSGNO(4),KF69                                            00270900
*        CALL ERRMSG;                                                   00271000
         BAL   R14,ERRMSG                                               00271100
*      END;                                                             00271200
*                           /*FIND ADDRESS OF DCB                    */ 00271300
@RF01129 LA    R12,OUTHIST                                              00271400
*                                     /*ISSUE OPEN SVC               */ 00271500
         OPEN  ((R12),(OUTPUT,DISP))                                    00271600
*                             /*WAS OPEN SUCCESSFULL                 */ 00271700
         TM    DCBOFLGS,DCBOFOPN                                        00271800
*                      /*GO TO ERROR ROUTINE                         */ 00271900
         BZ    BADOOHST                                                 00272000
*    HISTOPN = YES;                                                     00272100
         OI    IOSWTCH,HISTOPN                                          00272200
         B     @ER00033                                                 00272300
*                                                                       00272400
*  END;                                                                 00272500
*ELSE                                                                   00272600
*  DO;                                                                  00272700
*    MSGNO = 2;                                                         00272800
@RF01127 MVC   MSGNO(4),KF2                                             00272900
*    CALL ERRMSG;                                                       00273000
         BAL   R14,ERRMSG                                               00273100
*    BADNEWS = TWELVE; /*ABORT RETURN CODE                              00273200
         MVC   BADNEWS(4),KF12                                          00273300
*  END;                                                                 00273400
*END; /*CLOSING END TO PROC OPENDEV                                  */ 00273500
@ER00033 LM    R14,R12,@SA00033                                         00273600
         BR    R14                                                      00273700
*                                                                       00273800
*HISTIT: PROC; /*WRITE TO ACCDEV USING QSAM                          */ 00273900
HISTIT   STM   R14,R12,@SA00034                                         00274000
*IF HISTOPN = YES THEN                                                  00274100
         TM    IOSWTCH,HISTOPN                                          00274200
         BNO   @RF01149                                                 00274300
*  DO;                                                                  00274400
*    DEVCT = DEVCT + 1;                                                 00274500
         LA    R6,1                                                     00274600
         AL    R6,DEVCT                                                 00274700
         ST    R6,DEVCT                                                 00274800
*                           /*GET DCB ADDRESS                        */ 00274900
         LA    R12,OUTHIST                                              00275000
*    R7 = ADDR(BUF1RDW); /*ADDRESS THE RECORD DESCRIPTOR WORD*/         00275100
         LA    R7,BUF1RDW                                               00275200
*    IF SCRATCH = YES THEN /*IF FRAMES FROM DIRECTWK, MUST FIX REC*/    00275300
*      DO;                 /*ORD DESCRIPTOR WORD BECAUSE IT WAS   */    00275400
*                          /*MANGLED FOR EDSUM MODULES               */ 00275500
         TM    IOSWTCH+2,SCRATCH                                        00275600
         BNO   @RF01154                                                 00275700
*        BUF1RDWL = BUF1L + 4; /*RE-ADD RDW LENGTH, MOVE TO RDW   */    00275800
         LH    R6,BUF1L                                                 00275900
         LA    R6,4(,R6)                                                00276000
         STH   R6,BUF1RDWL                                              00276100
*        BUF1L = '0000'X;      /*FINISH RDW RIGHTMOST TWO BYTES   */    00276200
         SLR   R6,R6                                                    00276300
         STH   R6,BUF1L                                                 00276400
*        R7 = ADDR(BUF1);      /*POINT TO RECORD FOR QSAM PUT     */    00276500
         LA    R7,BUF1                                                  00276600
         B     @RC01154                                                 00276700
*                                                                       00276800
*      END;                                                             00276900
*    ELSE   /*RECORD NOT RETRIEVED FROM DIRECTWK                     */ 00277000
*      IF FLIPFLOP = OFF THEN /*IF RECORD FROM READSEQ OF LOGREC*/      00277100
@RF01154 TM    IOSWTCH,FLIPFLOP                                         00277200
         BNZ   @RC01154                                                 00277300
*        DO;                                                            00277400
*          BBRDW = SAVELENT; /*GET UNMODIFIED QSAM LENGTH            */ 00277500
         MVC   SDRK,OUTHIST+DCBLRECL-IHADCB                             00277600
         LH    R6,SDRK                                                  00277700
         CH    R6,SAVELENT                                              00277800
         BNL   HISTIT01                                                 00277900
         STH   R6,SAVELENT                                              00278000
HISTIT01 LH    R6,SAVELENT                                              00278100
         STH   R6,BBRDW                                                 00278200
*          BSIZE = '0000'X; /*COMPLETE RDW                           */ 00278300
         XC    BSIZE(2),BSIZE                                           00278400
*          R7 = ADDR(BBRDW);                                            00278500
         LA    R7,BBRDW                                                 00278600
*        END;                                                           00278700
*                          /*ISSUE WRITE USING QSAM                  */ 00278800
@RC01154 PUT  (R12),(R7)                                                00278900
         B    @ER00034                                                  00279000
*                                                                       00279100
*  END;                                                                 00279200
*ELSE                                                                   00279300
*  DO;                                                                  00279400
*    BADNEWS = TWELVE;                                                  00279500
@RF01149 MVC   BADNEWS(4),KF12                                          00279600
*    MSGNO = 4;                                                         00279700
         MVC   MSGNO(4),KF4                                             00279800
*    CALL ERRMSG;                                                       00279900
         BAL   R14,ERRMSG                                               00280000
*  END;                                                                 00280100
*END; /*CLOSING END TO PROC HISTIT                                   */ 00280200
@ER00034 LM    R14,R12,@SA00034                                         00280300
         BR    R14                                                      00280400
*                                                                       00280500
*        PROC TO CONVERT HEX DATE INTO PRINTABLE FORMAT                 00280600
*                                                                       00280700
*        NUMBER  = NUMBER OF BYTES TO BE CONVERTED                      00280800
*        NEXTBY -> THE DATA TO BE CONVERTED                             00280900
*        ADDNXT -> WHERE THE CONVERTED DATA IS TO BE PUT                00281000
*                                                                       00281100
*CONVERT: PROC;                                                         00281200
CONVERT  STM   R14,R12,12(R13)                                          00281300
*DO J = NUMBER BY -1 TO 1;                                              00281400
         L     R12,NUMBER                                               00281500
         ST    R12,J                                                    00281600
         B     @DE01177                                                 00281700
*                                                                       00281800
*  R2 = NEXTBYTE(J);                                                    00281900
@DL01177 L     R1,NEXTBY                                                00282000
         BCTR  R1,0                                                     00282100
         SLR   R2,R2                                                    00282200
         IC    R2,NEXTBYTE(R12,R1)                                      00282300
*  K  = 2 * J;                                                          00282400
         LR    R4,R12                                                   00282500
         ALR   R4,R4                                                    00282600
         ST    R4,K                                                     00282700
*  SRDL(R2,4);                                                          00282800
         SRDL  R2,4                                                     00282900
*  SRL(R3,28);                                                          00283000
         SRL   R3,28                                                    00283100
*  R3 = R3 + 1;                                                         00283200
         LA    R5,1                                                     00283300
         ALR   R3,R5                                                    00283400
*  R2 = R2 + 1;                                                         00283500
         ALR   R2,R5                                                    00283600
*  ADDNUM(K-1) = CHARS(R2);                                             00283700
         L     R5,ADDNXT                                                00283800
         ALR   R4,R5                                                    00283900
         BCTR  R4,0                                                     00284000
         BCTR  R4,0                                                     00284100
         LA    R1,CHARS-1(R2)                                           00284200
         MVC   ADDNUM(1,R4),0(R1)                                       00284300
*  ADDNUM(K) = CHARS(R3);                                               00284400
         L     R4,K                                                     00284500
         ALR   R5,R4                                                    00284600
         BCTR  R5,0                                                     00284700
         LA    R4,CHARS-1(R3)                                           00284800
         MVC   ADDNUM(1,R5),0(R4)                                       00284900
*END;                                                                   00285000
         BCTR  R12,0                                                    00285100
         ST    R12,J                                                    00285200
@DE01177 LTR   R12,R12                                                  00285300
         BP    @DL01177                                                 00285400
*END; /*CLOSING END TO PROC CONVERT                                  */ 00285500
@ER00035 LM    R14,R12,12(R13)                                          00285600
         BR    R14                                                      00285700
*                                                                       00285800
*BADORPT:  ; /*ERREPT  UNSUCCESSFUL OPEN                             */ 00285900
*MSGNO = 44;                                                            00286000
BADORPT  MVC   MSGNO(4),KF44                                            00286100
*CALL ERRMSG;                                                           00286200
         BAL   R14,ERRMSG                                               00286300
*BADNEWS = TWELVE;                                                      00286400
         MVC   BADNEWS(4),KF12                                          00286500
*GOTO GOBACK;                                                           00286600
         B     GOBACK                                                   00286700
*                                                                       00286800
*BADOTOUR: ; /*TOURIST UNSUCCESSFUL OPEN                             */ 00286900
*R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2                   */ 00287000
BADOTOUR L     R12,SAVER2                                               00287100
         LR    R2,R12                                                   00287200
* CALL IFCMSG(205,ADDR(PRNTBF));                                        00287300
         LA    R14,PRNTBF                                               00287400
         ST    R14,@AFTEMPS+16                                          00287500
         L     R15,ADIFCMSG(,R12)                                       00287600
         LA    R1,@AL01196                                              00287700
         BALR  R14,R15                                                  00287800
*BADNEWS = TWELVE;                                                      00287900
         MVC   BADNEWS(4),KF12                                          00288000
*GOTO GOBACK;                                                           00288100
         B     GOBACK                                                   00288200
*                                                                       00288300
*HISTBAD:  ; /*ERROR EXIT WRITING TO ACCDEV                          */ 00288400
*                                   /* GET OWN SAVE AREA             */ 00288500
HISTBAD  SYNADAF  ACSMETH=QSAM                                          00288600
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00288700
         ST    R14,SAVER14                                              00288800
*MSGNO = 6;                                                             00288900
         MVC   MSGNO(4),KF6                                             00289000
*CALL ERRMSG;                                                           00289100
         BAL   R14,ERRMSG                                               00289200
*BADNEWS = TWELVE;                                                      00289300
         MVC   BADNEWS(4),KF12                                          00289400
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00289500
         B     GOOUT                                                    00289600
*                                                                       00289700
*HISTEND:  ; /*EOF EXIT FOR READING ACCIN                            */ 00289800
*CALL CLOSHIST;                                                         00289900
HISTEND  BAL   R14,CLOSHIST                                             00290000
*IF SERLO = ON THEN /*IF SERLOG IS ALSO ON WE MUST READ IT ALSO*/       00290100
         TM    IOSWTCH+1,SERLO                                          00290200
         BNO   @RF01208                                                 00290300
* DO;                                                                   00290400
*  CALL READSER; /*WILL START READING SERLOG SEQUENTIALLY THERE*/       00290500
         BAL   R14,READSER                                              00290600
*  GOTO GOBACK;   /*RETURN TO CALLER                                 */ 00290700
         B     GOBACK                                                   00290800
*                                                                       00290900
* END;                                                                  00291000
*ELSE                                                                   00291100
*  DO;                                                                  00291200
*    BADNEWS = FOUR; /*INDICATE EOF ON SEQUENTIAL DATA                  00291300
@RF01208 MVC   BADNEWS(4),KF4                                           00291400
*    GOTO GOBACK;                                                       00291500
         B     GOBACK                                                   00291600
*                                                                       00291700
*  END;                                                                 00291800
*HISTINBD:  ; /*ERROR EXIT FOR READING ACCIN                         */ 00291900
*                                   /* GET OWN SAVE AREA             */ 00292000
HISTINBD SYNADAF  ACSMETH=QSAM                                          00292100
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00292200
         ST    R14,SAVER14                                              00292300
*BADNEWS = TWELVE;                                                      00292400
         MVC   BADNEWS(4),KF12                                          00292500
*MSGNO =7;                                                              00292600
         MVC   MSGNO(4),KF7                                             00292700
*CALL ERRMSG;                                                           00292800
         BAL   R14,ERRMSG                                               00292900
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00293000
         B     GOOUT                                                    00293100
*                                                                       00293200
*BADBRSEQ: ; /*CANT OPEN DIRECTWK FOR READ EXIT                      */ 00293300
*MSGNO = 30;                                                            00293400
BADBRSEQ MVC   MSGNO(4),KF30                                            00293500
*CALL ERRMSG;                                                           00293600
         BAL   R14,ERRMSG                                               00293700
*BADNEWS = TWELVE;                                                      00293800
         MVC   BADNEWS(4),KF12                                          00293900
*GOTO GOBACK;                                                           00294000
         B     GOBACK                                                   00294100
*                                                                       00294200
*BADOPENA: ; /*SERLOG OPEN FAILED EXIT                               */ 00294300
*                                    /*STEP DEQUEUE                  */ 00294400
BADOPENA DEQ   (RESID,LOGRECA,11,STEP)                                  00294500
*MSGNO = 13;                                                            00294600
         MVC   MSGNO(4),KF13                                            00294700
*CALL ERRMSG;                                                           00294800
         BAL   R14,ERRMSG                                               00294900
*BADNEWS = TWELVE;                                                      00295000
         MVC   BADNEWS(4),KF12                                          00295100
*GOTO GOBACK;                                                           00295200
         B     GOBACK                                                   00295300
*                                                                       00295400
*BADBWSEQ:  ; /*ERROR EXIT IF CANT OPEN DIRECTWK FOR WRITING         */ 00295500
*BADNEWS = TWELVE;                                                      00295600
BADBWSEQ MVC   BADNEWS(4),KF12                                          00295700
*MSGNO = 27;                                                            00295800
         MVC   MSGNO(4),KF27                                            00295900
*CALL ERRMSG;                                                           00296000
         BAL   R14,ERRMSG                                               00296100
*GOTO GOBACK;                                                           00296200
         B     GOBACK                                                   00296300
*                                                                       00296400
*BDIST: ; /*IMPROPER RECORD FORMAT EXIT FOR ACCIN                    */ 00296500
*BADNEWS = TWELVE;                                                      00296600
BDIST    MVC   BADNEWS(4),KF12                                          00296700
*MSGNO = 10;                                                            00296800
         MVC   MSGNO(4),KF10                                            00296900
*CALL ERRMSG;                                                           00297000
         BAL   R14,ERRMSG                                               00297100
*GOTO GOBACK;                                                           00297200
         B     GOBACK                                                   00297300
*                                                                       00297400
*BDOIHST: ;  /*CANT OPEN ACCIN EXIT                                  */ 00297500
*MSGNO = 9;                                                             00297600
BDOIHST  MVC   MSGNO(4),KF9                                             00297700
*CALL ERRMSG;                                                           00297800
         BAL   R14,ERRMSG                                               00297900
*BADNEWS = TWELVE;                                                      00298000
         MVC   BADNEWS(4),KF12                                          00298100
*GOTO GOBACK;                                                           00298200
         B     GOBACK                                                   00298300
*                                                                       00298400
*BADRDIR: ; /*SYNAD FOR READING DIRECTWK D.S. SEQUENTIALLY WITH POINT*/ 00298500
*                                   /* GET OWN SAVE AREA             */ 00298600
BADRDIR  SYNADAF  ACSMETH=BSAM                                          00298700
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00298800
         ST    R14,SAVER14                                              00298900
*MSGNO = 42;                                                            00299000
         MVC   MSGNO(4),KF42                                            00299100
*CALL ERRMSG;                                                           00299200
         BAL   R14,ERRMSG                                               00299300
*BADNEWS = TWELVE;                                                      00299400
         MVC   BADNEWS(4),KF12                                          00299500
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00299600
         B     GOOUT                                                    00299700
*                                                                       00299800
*BADOOHST: ; /*CANT OPEN ACCDEV EXIT                                 */ 00299900
*MSGNO = 3;                                                             00300000
BADOOHST MVC   MSGNO(4),KF3                                             00300100
*CALL ERRMSG;                                                           00300200
         BAL   R14,ERRMSG                                               00300300
*BADNEWS = TWELVE;                                                      00300400
         MVC   BADNEWS(4),KF12                                          00300500
*GOTO GOBACK;                                                           00300600
         B     GOBACK                                                   00300700
*                                                                       00300800
*SYSOBAD: ;                                                             00300900
*BADNEWS = TWELVE;                                                      00301000
SYSOBAD  MVC   BADNEWS(4),KF12                                          00301100
*GOTO GOBACK;                                                           00301200
         B     GOBACK                                                   00301300
*                                                                       00301400
*SYSBAD: ;                                                              00301500
*                                   /* GET OWN SAVE AREA             */ 00301600
SYSBAD   SYNADAF  ACSMETH=QSAM                                          00301700
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00301800
         ST    R14,SAVER14                                              00301900
*MSGNO = 36; /*SYSIN READ ERROR                                      */ 00302000
         MVC   MSGNO(4),KF36                                            00302100
*CALL ERRMSG;                                                           00302200
         BAL   R14,ERRMSG                                               00302300
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00302400
         B     GOOUT                                                    00302500
*                                                                       00302600
*OVERFLOW: ;                                                            00302700
*MSGNO = 37;                                                            00302800
OVERFLOW MVC   MSGNO(4),KF37                                            00302900
*CALL ERRMSG;                                                           00303000
         BAL   R14,ERRMSG                                               00303100
*MSGNO = 38;                                                            00303200
         MVC   MSGNO(4),KF38                                            00303300
*CALL ERRMSG;                                                           00303400
         BAL   R14,ERRMSG                                               00303500
*PRINTADR = ADDR(PRNTBF);                                               00303600
         LA    R12,PRNTBF                                               00303700
         L     R1,SAVER2                                                00303800
         ST    R12,PRINTADR(,R1)                                        00303900
*PRINTDS = 'F1'X;                                                       00304000
         MVI   PRINTDS(R12),C'1'                                        00304100
*PRINTCC = '09'X;                                                       00304200
         MVI   PRINTCC(R12),X'09'                                       00304300
*NUMBER = 40; /*NUMBER OF BYTES OF LAST RECORD WRITTEN TO BE PRINTED*/  00304400
         MVC   NUMBER(4),KF40                                           00304500
*NEXTBY = R7 + 4; /*ADDRESS OF RECORD PAST RECORD LENGTH             */ 00304600
         LA    R6,4                                                     00304700
         ALR   R6,R7                                                    00304800
         ST    R6,NEXTBY                                                00304900
*ADDNXT = PRINTADR + 2; /*PUT PRINTABLE NUMBER HERE IN PRINT BUFFER*/   00305000
         AL    R12,KF2                                                  00305100
         ST    R12,ADDNXT                                               00305200
*CALL CONVERT; /*CONVERT HEXIDECIMAL RECORD HEADER TO PRINTABLE*/       00305300
         BAL   R14,CONVERT                                              00305400
*CALL PRINTIT; /*WRITE RECORD LAST PROCESSED TO THE TOURIST DATA SET*/  00305500
         BAL   R14,PRINTIT                                              00305600
*BADNEWS = 8;                                                           00305700
         MVC   BADNEWS(4),KF8                                           00305800
*GOTO GOBACK;                                                           00305900
         B     GOBACK                                                   00306000
*                                                                       00306100
*SYSEOF: ;                                                              00306200
*BADNEWS = FOUR;                                                        00306300
SYSEOF   MVC   BADNEWS(4),KF4                                           00306400
*GOTO GOBACK;                                                           00306500
         B     GOBACK                                                   00306600
*                                                                       00306700
*PRINTBAD: ;                                                            00306800
*                                   /* GET OWN SAVE AREA             */ 00306900
PRINTBAD SYNADAF  ACSMETH=QSAM                                          00307000
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00307100
         ST    R14,SAVER14                                              00307200
*MSGNO = 18;                                                            00307300
         MVC   MSGNO(4),KF18                                            00307400
*CALL ERRMSG;                                                           00307500
         BAL   R14,ERRMSG                                               00307600
*BADNEWS = TWELVE;                                                      00307700
         MVC   BADNEWS(4),KF12                                          00307800
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00307900
         B     GOOUT                                                    00308000
*                                                                       00308100
*TOURBAD: ;                                                             00308200
*                                   /* GET OWN SAVE AREA             */ 00308300
TOURBAD  SYNADAF  ACSMETH=QSAM                                          00308400
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00308500
         ST    R14,SAVER14                                              00308600
*BADNEWS = TWELVE;                                                      00308700
         MVC   BADNEWS(4),KF12                                          00308800
*R2 = SAVER2;    /*INSURE COMTABLE ADDRESSED BY R2                   */ 00308900
         L     R12,SAVER2                                               00309000
         LR    R2,R12                                                   00309100
*CALL IFCMSG(202,ADDR(PRNTBF));                                         00309200
         LA    R14,PRNTBF                                               00309300
         ST    R14,@AFTEMPS+16                                          00309400
         L     R15,ADIFCMSG(,R12)                                       00309500
         LA    R1,@AL01302                                              00309600
         BALR  R14,R15                                                  00309700
* GOTO GOOUT;                       /* RETURN TO SUPERVISOR          */ 00309800
         B     GOOUT                                                    00309900
*                                                                       00310000
*WRITEERR:;                                                             00310100
*                                   /* GET OWN SAVE AREA             */ 00310200
WRITEERR SYNADAF  ACSMETH=BSAM                                          00310300
* SAVER14 = R14;                    /* SAVE RETURN ADDRESS           */ 00310400
         ST    R14,SAVER14                                              00310500
* GOOUT:;                           /* RETURN TO SUPERVISOR          */ 00310600
*                                   /* USE R15 FOR RET CODE          */ 00310700
*  R15 = BADNEWS;                   /* GET RETURN CODE               */ 00310800
GOOUT    L     R15,BADNEWS                                              00310900
*  IF  R15 > FOUR THEN              /* MORE THAN ONE REQ             */ 00311000
         C     R15,KF4                                                  00311100
         BNH   @RF01310                                                 00311200
*   ERRORENT = ERRORENT + 1;        /* CAN NOT DO                    */ 00311300
         LA    R12,1                                                    00311400
         AL    R12,ERRORENT                                             00311500
         ST    R12,ERRORENT                                             00311600
*  R14 = SAVER14;                   /* RESTORE SPVR RET ADR          */ 00311700
@RF01310 L     R14,SAVER14                                              00311800
*                                   /* RSTR SPVR REGS                */ 00311900
         SYNADRLS                                                       00312000
* RETURN;                           /* RETURN TO SUPERVISOR          */ 00312100
         B     @EL00001                                                 00312200
*                                                                       00312300
*        DCBS                                                           00312400
*                                                                       00312500
         PRINT NOGEN                                                    00312600
*                                                                       00312700
OUTHIST  DCB   MACRF=(PM),SYNAD=HISTBAD,LRECL=2000,                    C00312800
               DSORG=PS,DDNAME=ACCDEV,BUFNO=2                           00312900
*                                                                       00313000
INHIST   DCB   MACRF=(GM),DSORG=PS,DDNAME=ACCIN,LRECL=2000,            C00313100
               EODAD=HISTEND,SYNAD=HISTINBD,BUFNO=2                     00313200
*                                                                       00313300
LOGREC   DCB   MACRF=(E),IOBAD=XIOB,DSORG=DA,DEVD=DA,RECFM=U,          C00313400
               DDNAME=SERLOG                                            00313500
*                                                                       00313600
*        DIRECTWK IS READ WITH THE FIRST DCB USING NOTE LOGIC           00313700
*        AND READ WITH THE SECOND DCB USING POINT LOGIC.                00313800
*        A CLOSE TO THE FIRST DCB MUST BE ISSUED BEFORE USING THE       00313900
*        SECOND                                                         00314000
*                                                                       00314100
WORKWDCB DCB   DDNAME=DIRECTWK,DEVD=DA,DSORG=PS,BLKSIZE=2000,          C00314200
               MACRF=(WP),RECFM=V,SYNAD=WRITEERR                        00314300
*                                                                       00314400
WORKRDCB DCB   DDNAME=DIRECTWK,DEVD=DA,DSORG=PS,BLKSIZE=2000,          C00314500
               MACRF=(RP),RECFM=V,SYNAD=BADRDIR                         00314600
*                                                                       00314700
SYSDCB   DCB   DDNAME=SYSIN,DEVD=DA,DSORG=PS,EODAD=SYSEOF,             C00314800
               LRECL=80,MACRF=GM,SYNAD=SYSBAD,EXLST=BLKEXIT             00314900
*                                                                       00315000
*        NOTE THAT EREPPT COMMAND CHARACTERS HAVE FLUCTUATED            00315100
*        BETWEEN ANSI AND MACHINE CHARACTERS                            00315200
*                                                                       00315300
EREPTDCB DCB   MACRF=(PM),SYNAD=PRINTBAD,LRECL=133,DDNAME=EREPPT,      C00315400
               DEVD=DA,DSORG=PS,RECFM=FBM,EXLST=BLKEXIT                 00315500
*                                                                       00315600
TOURDCB  DCB   MACRF=(PM),SYNAD=TOURBAD,LRECL=133,DDNAME=TOURIST,      C00315700
               DEVD=DA,DSORG=PS,RECFM=FBM,EXLST=BLKEXIT                 00315800
*                                                                       00315900
         PRINT GEN                                                      00316000
*                                                                       00316100
BLKEXIT  DC    0F'0'                      ALIGN ON A FULLWORD           00316200
         DC    AL1(128+5),AL3(ADDBLKSZ)   DCB OPEN EXIT                 00316300
*                                                                       00316400
*        DCB OPEN EXIT                                                  00316500
*                                                                       00316600
         DROP  R12                                                      00316700
         USING IHADCB,R1                                                00316800
ADDBLKSZ OC    DCBBLKSI,DCBBLKSI      BLKSIZE SPECIFIED ?               00316900
         BNZR  R14                    YES, RETURN                       00317000
         MVC   DCBBLKSI,DCBLRECL      DEFAULT BLKSIZE = LRECL ?         00317100
         BR    R14                    RETURN                            00317200
         DROP  R1                                                       00317300
*                                                                       00317400
*/********************************************************************/ 00317500
*        END  /*CLOSING END TO EXTERNAL PROC IFCIOHND                */ 00317600
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM      */ 00317700
*/*%INCLUDE SYSLIB  (COMTABLE)                                       */ 00317800
*;                                                                      00317900
KH5      DC    H'5'                                                     00318000
KH20     DC    H'20'                                                    00318100
KH1944   DC    H'1944'                                                  00318200
KHM1     DC    H'-1'                                                    00318300
*                                                                       00318400
*        PARAMETER LISTS                                                00318500
*                                                                       00318600
@AL00337 DC    A(KF201)                LIST WITH   2 ARGUMENT(S)        00318700
         DC    A(@AFTEMPS)                                              00318800
@AL00687 DC    A(MSGNO)                LIST WITH   2 ARGUMENT(S)        00318900
         DC    A(@AFTEMPS+4)                                            00319000
@AL00717 DC    A(KF202)                LIST WITH   2 ARGUMENT(S)        00319100
         DC    A(@AFTEMPS+4)                                            00319200
@AL00761 DC    A(KF203)                LIST WITH   2 ARGUMENT(S)        00319300
         DC    A(@AFTEMPS+8)                                            00319400
@AL01078 DC    A(KF204)                LIST WITH   2 ARGUMENT(S)        00319500
         DC    A(@AFTEMPS+12)                                           00319600
@AL01196 DC    A(KF205)                LIST WITH   2 ARGUMENT(S)        00319700
         DC    A(@AFTEMPS+16)                                           00319800
@AL01302 DC    A(KF202)                LIST WITH   2 ARGUMENT(S)        00319900
         DC    A(@AFTEMPS+16)                                           00320000
*                                                                       00320100
*        SAVEAREAS                                                      00320200
*                                                                       00320300
@SA00001 DC    18F'0'                                                   00320400
@SA00023 DC    14F'0'                                                   00320500
@SA00021 DC    14F'0'                                                   00320600
@SA00034 DC    15F'0'                                                   00320700
@SA00019 DC    15F'0'                                                   00320800
@SA00015 DC    15F'0'                                                   00320900
@SA00009 DC    15F'0'                                                   00321000
@SA00010 DC    15F'0'                                                   00321100
@SA00018 DC    14F'0'                                                   00321200
@SA00014 DC    15F'0'                                                   00321300
@SA00002 DC    15F'0'                                                   00321400
@SA00003 DC    14F'0'                                                   00321500
@SA00007 DC    15F'0'                                                   00321600
@SA00008 DC    15F'0'                                                   00321700
@SA00004 DC    14F'0'                                                   00321800
@SA00005 DC    15F'0'                                                   00321900
@SA00006 DC    15F'0'                                                   00322000
@SA00029 DC    15F'0'                                                   00322100
@SA00031 DC    15F'0'                                                   00322200
@SA00026 DC    15F'0'                                                   00322300
@SA00033 DC    15F'0'                                                   00322400
@SA00016 DC    15F'0'                                                   00322500
@SA00025 DC    15F'0'                                                   00322600
@SA00032 DC    15F'0'                                                   00322700
@SA00027 DC    15F'0'                                                   00322800
@SA00028 DC    15F'0'                                                   00322900
@SA00017 DC    15F'0'                                                   00323000
@SA00022 DC    15F'0'                                                   00323100
@SA00011 DC    15F'0'                                                   00323200
@SA00030 DC    15F'0'                                                   00323300
@SA00013 DC    15F'0'                                                   00323400
@SA00012 DC    15F'0'                                                   00323500
@SA00020 DC    14F'0'                                                   00323600
@SA00024 DC    14F'0'                                                   00323700
@AFTEMPS DC    5F'0'                                                    00323800
*                                                                       00323900
KF1      DC    F'1'                                                     00324000
KH1      EQU   KF1+2                                                    00324100
KF2      DC    F'2'                                                     00324200
KH2      EQU   KF2+2                                                    00324300
KF3      DC    F'3'                                                     00324400
KH3      EQU   KF3+2                                                    00324500
KF4      DC    F'4'                                                     00324600
KH4      EQU   KF4+2                                                    00324700
KF6      DC    F'6'                                                     00324800
KH6      EQU   KF6+2                                                    00324900
KF7      DC    F'7'                                                     00325000
KH7      EQU   KF7+2                                                    00325100
KF8      DC    F'8'                                                     00325200
KF9      DC    F'9'                                                     00325300
KH9      EQU   KF9+2                                                    00325400
KF10     DC    F'10'                                                    00325500
KF11     DC    F'11'                                                    00325600
KF12     DC    F'12'                                                    00325700
KF13     DC    F'13'                                                    00325800
KF14     DC    F'14'                                                    00325900
KF15     DC    F'15'                                                    00326000
KF16     DC    F'16'                                                    00326100
KF17     DC    F'17'                                                    00326200
KF18     DC    F'18'                                                    00326300
KF19     DC    F'19'                                                    00326400
KF21     DC    F'21'                                                    00326500
KF22     DC    F'22'                                                    00326600
KF23     DC    F'23'                                                    00326700
KF25     DC    F'25'                                                    00326800
KF27     DC    F'27'                                                    00326900
KF28     DC    F'28'                                                    00327000
KF29     DC    F'29'                                                    00327100
KF30     DC    F'30'                                                    00327200
KF31     DC    F'31'                                                    00327300
KF32     DC    F'32'                                                    00327400
KF33     DC    F'33'                                                    00327500
KF34     DC    F'34'                                                    00327600
KF35     DC    F'35'                                                    00327700
KF36     DC    F'36'                                                    00327800
KF37     DC    F'37'                                                    00327900
KF38     DC    F'38'                                                    00328000
KF39     DC    F'39'                                                    00328100
KF40     DC    F'40'                                                    00328200
KH40     EQU   KF40+2                                                   00328300
KF41     DC    F'41'                                                    00328400
KF42     DC    F'42'                                                    00328500
KF44     DC    F'44'                                                    00328600
KF45     DC    F'45'                                                    00328700
KF46     DC    F'46'                                                    00328800
KF47     DC    F'47'                                                    00328900
KF48     DC    F'48'                                                    00329000
KF49     DC    F'49'                                                    00329100
KF50     DC    F'50'                                                    00329200
KF51     DC    F'51'                                                    00329300
KH51     EQU   KF51+2                                                   00329400
KF52     DC    F'52'                                                    00329500
KF53     DC    F'53'                                                    00329600
KF54     DC    F'54'                                                    00329700
KF55     DC    F'55'                                                    00329800
KF56     DC    F'56'                                                    00329900
KF57     DC    F'57'                                                    00330000
KF58     DC    F'58'                                                    00330100
KF59     DC    F'59'                                                    00330200
KF60     DC    F'60'                                                    00330300
KF61     DC    F'61'                                                    00330400
KF62     DC    F'62'                                                    00330500
KF63     DC    F'63'                                                    00330600
KF64     DC    F'64'                                                    00330700
KF65     DC    F'65'                                                    00330800
KF66     DC    F'66'                                                    00330900
KF67     DC    F'67'                                                    00331000
KF68     DC    F'68'                                                    00331100
KF69     DC    F'69'                                                    00331200
KF70     DC    F'70'                                                    00331300
KF82     DC    F'82'                                                    00331400
KF201    DC    F'201'                                                   00331500
KF202    DC    F'202'                                                   00331600
KF203    DC    F'203'                                                   00331700
KF204    DC    F'204'                                                   00331800
KF205    DC    F'205'                                                   00331900
KX00FFFF DC    XL4'0000FFFF'                                            00332000
         DC    0D'0'                                                    00332100
SAVER2   DC    A(0)                    -> COM TABLE                     00332200
PTRSPOT  DC    A(0)                    -> HALF WORD FUNCTION REQUEST    00332300
SAVEPTR  DC    A(0)                                                     00332400
FRSPTR   DC    A(0)                                                     00332500
RUNPTR   DC    A(0)                                                     00332600
SAVER14  DC    A(0)                                                     00332700
A        DC    F'0'                                                     00332800
K        DC    F'0'                                                     00332900
J        DC    F'0'                                                     00333000
GETHIS   DC    F'0'                                                     00333100
R7SAVE   DC    F'0'                                                     00333200
TIMEBASE DC    A(0)                                                     00333300
NEXTBY   DC    F'0'                                                     00333400
ADDNXT   DC    F'0'                                                     00333500
NUMBER   DC    F'0'                                                     00333600
MSGNO    DC    F'0'                                                     00333700
BADNEWS  DC    F'0'                                                     00333800
PASSNUM  DC    F'0'                                                     00333900
*                                                                       00334000
XWRECB   DC    F'0'                                                     00334100
         ORG   XWRECB                                                   00334200
POST     DS    CL1                                                      00334300
         DS    CL3                                                      00334400
         ORG   XWRECB+4                                                 00334500
*                                                                       00334600
MILLION  DC    F'1000000'                                               00334700
TWENTY4  DC    F'24'                                                    00334800
SIXTY    DC    F'60'                                                    00334900
CONSTG   DC    XL4'30040'                                               00335000
CONSTH   DC    XL4'24AE062'                                             00335100
SIXTYMIL DC    F'60000000'                                              00335200
THCONV   DC    F'10000'                                                 00335300
TIMDIV   DC    F'0'                                                     00335400
SAVELNGT DC    H'0'                                                     00335500
LINECTT  DC    H'0'                                                     00335600
LINEMAX  DC    H'0'                                                     00335700
SDRK     DC    H'0'                                                     00335800
         DC    H'0'                                                     00335900
SAVELENT DC    H'0'                                                     00336000
*                                                                       00336100
WORKD    DC    D'0'                                                     00336200
KC1B     DC    C'1 '                                                    00336300
KXNULL   DC    X'00000000'                                              00336400
KX07     DC    X'00000007'                                              00336500
@CB01094 DC    X'0000000F'                                              00336600
@CB00262 DC    X'FFFF'                                                  00336700
@CB00983 DC    X'000F'                                                  00336800
CARDSPOT DC    CL80' '                 CONTROL STMT READIN AREA         00336900
         DC    0F'0'                                                    00337000
MAXTRK   DC    X'00000000'                                              00337100
LOOKATIT DC    CL40'XXXXXXXXOPERATION COUNTS IFCEREP1XXXXXXX'           00337200
*                                                                       00337300
CONTPTR  DS    CL44                                                     00337400
         ORG   CONTPTR                                                  00337500
ERRORENT DC    F'0'                                                     00337600
RSEQCNT  DC    F'0'                                                     00337700
RSERDCNT DC    F'0'                                                     00337800
CONVTCT  DC    F'0'                                                     00337900
NUMRECSV DC    F'0'                                                     00338000
SYSRDCT  DC    F'0'                                                     00338100
RITEWKCT DC    F'0'                                                     00338200
READWKCT DC    F'0'                                                     00338300
ACIRDCT  DC    F'0'                                                     00338400
DEVCT    DC    F'0'                                                     00338500
RFRCOUNT DC    F'0'                                                     00338600
         ORG   CONTPTR+44                                               00338700
*                                                                       00338800
TTRSAVE  DC    X'00000000'                                              00338900
CCSAVE   DC    CL1' '                                                   00339000
BLANKS   DC    CL134' '                                                 00339100
PACKPAS  DC    CL4'    '                                                00339200
CHARPAS  DC    CL8'        '                                            00339300
CHARS    DC    CL16'0123456789ABCDEF'                                   00339400
         DC    0D'0'                                                    00339500
PRNTBF   DC    CL134' '                                                 00339600
         DC    XL2'00'                                                  00339700
*                                                                       00339800
BUF1     DS    CL2004                                                   00339900
         ORG   BUF1                                                     00340000
BUF1RDW  DS    CL4                                                      00340100
         ORG   BUF1RDW                                                  00340200
BUF1RDWL DC    H'0'                                                     00340300
BUF1L    DC    H'0'                                                     00340400
         ORG   BUF1+4                                                   00340500
BUF1DTA  DS    CL2000                                                   00340600
         ORG   BUF1+2004                                                00340700
*                                                                       00340800
*        SWITCHES                                                       00340900
*                                                                       00341000
IOSWTCH  DC    X'000000'                                                00341100
*                                      +00                              00341200
HISTOPN  EQU   X'80'                                                    00341300
SECGET   EQU   X'40'                                                    00341400
FLIPFLOP EQU   X'20'                                                    00341500
HISTYES  EQU   X'10'                                                    00341600
DBLYES   EQU   X'08'                                                    00341700
LASTLOOP EQU   X'04'                                                    00341800
TOURERR  EQU   X'02'                                                    00341900
INHISO   EQU   X'01'                                                    00342000
*                                      +01                              00342100
SERLO    EQU   X'80'                                                    00342200
TWOTRY   EQU   X'40'                                                    00342300
INDIR    EQU   X'20'                                                    00342400
NONBLANK EQU   X'10'                                                    00342500
CLOSE2   EQU   X'08'                                                    00342600
SYSOPN   EQU   X'04'                                                    00342700
TOUROPN  EQU   X'02'                                                    00342800
ERPTOPN  EQU   X'01'                                                    00342900
*                                      +02                              00343000
READFR   EQU   X'80'                                                    00343100
SCRATCH  EQU   X'40'                                                    00343200
*                                                                       00343300
         DC    X'00'                                                    00343400
*                                                                       00343500
HDRBUFF  DC    XL64'00'                                                 00343600
         ORG   HDRBUFF                                                  00343700
HDRSEEK  DS    0CL8                                                     00343800
HDRM     DC    X'00'                                                    00343900
HDRBB    DC    X'0000'                                                  00344000
HDRCC    DC    X'0000'                                                  00344100
HDRHH    DC    X'0000'                                                  00344200
HDRR     DC    X'00'                                                    00344300
         ORG   HDRBUFF+8                                                00344400
*                                                                       00344500
*        LOGREC HEADER RECORD                                           00344600
*                                                                       00344700
HEADER   DC    XL40'00'                                                 00344800
         ORG   HEADER                                                   00344900
HDRKEY   DS    CL2                +00 RECORD ID X'FFFF'                 00345000
HDRSCC   DS    CL2                +02 START OF LOGREC EXTENT CCHH       00345100
HDRSHH   DS    CL2                                                      00345200
HDRECC   DS    CL2                +06 END OF LOGREC EXTENT CCHH         00345300
HDREHH   DS    CL2                                                      00345400
HDRCOUNT DS    CL1                +10 COUNT OF LOGREC FULL MSG          00345500
HDRREA   DS    0CL7               +11 RECORD ENTRY AREA (BBCCHHR)       00345600
HDR1BB   DS    CL2                    START OF LOGREC RECORDS           00345700
HDR1CC   DS    CL2                                                      00345800
HDR1HH   DS    CL2                                                      00345900
HDR1R    DS    CL1                                                      00346000
HDRTBAL  DS    CL2                +18 TRACK BALANCE                     00346100
HDRTRKCP DS    CL2                +20 NO OF BYTES PER TRACK             00346200
HDRLASTR DS    0CL7               +22 LAST RECORD WRITTEN (BBCCHHR)     00346300
HDR2BB   DS    CL2                                                      00346400
HDR2CC   DS    CL2                                                      00346500
HDR2HH   DS    CL2                                                      00346600
HDR2R    DS    CL1                                                      00346700
HDRTCYL  DS    CL2                +29 TRKS PER CYL(HIGHEST TRK ON CYL)  00346800
HDREXSZE DS    CL2                +31 EARLY WARNING TRACK CAPACITY      00346900
*                                     SET AT 90% OF LAST TRACK          00347000
HDRDEVT  DS    CL1                +33 UNIT DEVICE TYPE (LOW NIBBLE)     00347100
HDREWMT  DS    CL4                +34 EARLY WARNING TRK (CCHH)          00347200
*                                     SET AT 90% OF ALL TRACKS          00347300
HDREWSW  DS    XL1                                                      00347400
HDRWNGBT EQU   X'80'                                                    00347500
FRAMES   EQU   X'20'                                                    00347600
*                                                                       00347700
HDRSAFE  DS    CL1                +39 CHECK BYTE X'FF'                  00347800
*                                                                       00347900
PREVSEEK DS    0CL8                                                     00348000
         ORG   PREVSEEK                                                 00348100
PREVM    DC    X'FF'                                                    00348200
PREVBB   DS    CL2                                                      00348300
PREVCC   DS    CL2                                                      00348400
PREVHH   DS    CL2                                                      00348500
PREVR    DS    CL1                                                      00348600
         ORG   HDRBUFF+64                                               00348700
*                                                                       00348800
LOGRECA  DC    C'SYS1.LOGREC'                                           00348900
LOGRECB  DC    CL8'RECORDER'                                            00349000
RESID    DC    CL8'SERLOG'                                              00349100
RESIDII  DC    CL8'SYSZLOGR'                                            00349200
*                                                                       00349300
ZEROA    DC    XL24'00'                                                 00349400
*                                                                       00349500
SEEKSAVE DC    XL8'00'                   SAVE SEEK ADDRESS              00349600
*                                                                       00349700
*        IOB                                                            00349800
*                                                                       00349900
XIOB     DC    5D'00'                                                   00350000
         ORG   XIOB-16                                                  00350100
*                                                                       00350200
         PRINT NOGEN                                                    00350300
*                                                                       00350400
         IEZIOB DSECT=NO                  MAP IOB                       00350500
*                                                                       00350600
         PRINT GEN                                                      00350700
*                                                                       00350800
         ORG   IOBFLAG1                                                 00350900
         DC    AL1(IOBCMDCH+IOBUNREL)     INIT IOBFLAG1                 00351000
         ORG   IOBECBPT                                                 00351100
         DC    AL4(XWRECB)                INIT IOBECBPT                 00351200
         ORG   IOBSTART                                                 00351300
         DC    AL4(SEQ)                   INIT IOBSTART                 00351400
         ORG   XIOB+40                                                  00351500
*                                                                       00351600
*        CCWS                                                           00351700
*                                                                       00351800
SEQ      DS    CL24                                                     00351900
         ORG   SEQ                                                      00352000
SID1     DS    CL8                                                      00352100
         ORG   SID1                                                     00352200
@NM00018 DC    X'31'                                                    00352300
AREAADR  DS    AL3                                                      00352400
@NM00019 DC    X'4000'                                                  00352500
@NM00020 DC    H'5'                                                     00352600
         ORG   SEQ+8                                                    00352700
TIC1     DS    CL8                                                      00352800
         ORG   TIC1                                                     00352900
@NM00021 DC    X'08'                                                    00353000
@NM00022 DC    AL3(SID1)                                                00353100
@NM00023 DC    X'4000'                                                  00353200
@NM00024 DC    H'1'                                                     00353300
         ORG   SEQ+16                                                   00353400
CKD1     DS    CL8                                                      00353500
         ORG   CKD1                                                     00353600
CKDCOM   DS    CL1                                                      00353700
CKDAREA  DS    AL3                                                      00353800
CKDCHAIN DC    X'20'                                                    00353900
@NM00025 DC    X'00'                                                    00354000
CKDCOUNT DS    FL2                                                      00354100
         ORG   SEQ+24                                                   00354200
*                                                                       00354300
SWITCH   DC    X'00'                                                    00354400
         ORG   SWITCH                                                   00354500
SBT0     DS    BL1                                                      00354600
SBT2     EQU   SWITCH+0                                                 00354700
SBT3     EQU   SWITCH+0                                                 00354800
SBT4     EQU   SWITCH+0                                                 00354900
SBT7     EQU   SWITCH+0                                                 00355000
         ORG   SWITCH+1                                                 00355100
         DC    XL7'00'                                                  00355200
WORK8    DC    D'0'                                                     00355300
         ORG   WORK8                                                    00355400
WORK     DS    FL4                                                      00355500
WORKB    DS    FL4                                                      00355600
         ORG   WORKB                                                    00355700
WHOURS   DS    CL1                                                      00355800
WMINS    DS    CL1                                                      00355900
WDAYS    DS    CL2                                                      00356000
         ORG   WDAYS                                                    00356100
WSECS    DS    CL1                                                      00356200
WTNTHS   DS    CL1                                                      00356300
         ORG   WORK8+8                                                  00356400
*                                                                       00356500
*DCL 1 ERRLINE(29), /*INTERNAL DEBUG15 MESSAGES                      */ 00356600
*    2 ERRDS CHAR(1) INIT((29)'1'),                                     00356700
*    2 ERRCS CHAR(1) INIT((29)' '),                                     00356800
*    2 PRINTNM CHAR(9) INIT((29)'DEBUG15  '),                           00356900
*    2 PRNTXT CHAR(40)                                                  00357000
*INIT('SERLOG OPEN ATTEMPTED                   ', /*53               */ 00357100
*     'CHECK HEADER FOR MORE RECORDS ATTEMPTED ', /*54               */ 00357200
*     'RESET OF SERLOG HEADER ATTEMPTED        ', /*55               */ 00357300
*     'SERLOG CLOSE ATTEMPTED                  ', /*56               */ 00357400
*     'ZEROALL ATTEMPTED                       ', /*57               */ 00357500
*     'SDR COUNTER DUMP ATTEMPTED              ', /*58               */ 00357600
*     'SYSIN OPEN ATTEMPTED                    ', /*59               */ 00357700
*     'SYSIN CLOSE ATTEMPTED                   ', /*60               */ 00357800
*     'DIRECTWK CLOSE FOR WRITING ATTEMPTED    ', /*61               */ 00357900
*     'DIRECTWK CLOSE FOR READING ATTEMPTED    ', /*62               */ 00358000
*     'DIRECTWK OPEN FOR WRITE ATTEMPTED       ', /*63               */ 00358100
*     'ACCIN OPEN ATTEMPTED                    ', /*64               */ 00358200
*     'ACCIN CLOSE ATTEMPTED                   ', /*65               */ 00358300
*     'ACCDEV CLOSE ATTEMPTED                  ', /*66               */ 00358400
*     'EREPPT OPEN ATTEMPTED                   ', /*67               */ 00358500
*     'EREPPT CLOSE ATTEMPTED                  ', /*68               */ 00358600
*     'ACCDEV OPEN ATTEMPTED                   ', /*69               */ 00358700
*     'FIRST FRAME READ ATTEMPT                ',                       00358800
*     'TIMES IFCIOHND EXITED WITH R.C.12       ', /*70               */ 00358900
*     'SERLOG SEQUENTIAL READ ATTEMPTS         ', /*71               */ 00359000
*     'SERLOG DIRECT READ ATTEMPTS             ', /*72               */ 00359100
*     'TIME CONVERSION NECESSARY NUM. TIMES    ', /*73               */ 00359200
*     'RECORDS SAVED DURING ZEROALL PROCESSING ', /*74               */ 00359300
*     'SYSIN READ ATTEMPTS                     ', /*75               */ 00359400
*     'DIRECTWK WRITE ATTEMPTS                 ', /*76               */ 00359500
*     'DIRECTWK READ ATTEMPTS                  ', /*77               */ 00359600
*     'ACCIN SEQUENTIAL READ ATTEMPTS          ', /*78               */ 00359700
*     'ACCDEV WRITE ATTEMPTS                   ', /*79               */ 00359800
*     'FRAME READ ATTEMPTS OF SYS1.LOGREC      ');/*80               */ 00359900
EDIFILD  DC    XL9'00'                                                  00360000
ERRLINE  DC    CL51' '                                                  00360100
         ORG   ERRLINE                                                  00360200
ERRDS    DC    CL1'1'                                                   00360300
ERRCS    DC    CL1' '                                                   00360400
PRINTNM  DC    CL9'DEBUG15  '                                           00360500
PRNTXT   DC    CL40'SERLOG OPEN ATTEMPTED                   '           00360600
         DC    C'1 '                                                    00360700
         DC    CL9'DEBUG15  '                                           00360800
         DC    CL40'CHECK HEADER FOR MORE RECORDS ATTEMPTED '           00360900
         DC    C'1 '                                                    00361000
         DC    CL9'DEBUG15  '                                           00361100
         DC    CL40'RESET OF SERLOG HEADER ATTEMPTED        '           00361200
         DC    C'1 '                                                    00361300
         DC    CL9'DEBUG15  '                                           00361400
         DC    CL40'SERLOG CLOSE ATTEMPTED                  '           00361500
         DC    C'1 '                                                    00361600
         DC    CL9'DEBUG15  '                                           00361700
         DC    CL40'ZEROALL ATTEMPTED                       '           00361800
         DC    C'1 '                                                    00361900
         DC    CL9'DEBUG15  '                                           00362000
         DC    CL40'SDR COUNTER DUMP ATTEMPTED              '           00362100
         DC    C'1 '                                                    00362200
         DC    CL9'DEBUG15  '                                           00362300
         DC    CL40'SYSIN OPEN ATTEMPTED                    '           00362400
         DC    C'1 '                                                    00362500
         DC    CL9'DEBUG15  '                                           00362600
         DC    CL40'SYSIN CLOSE ATTEMPTED                   '           00362700
         DC    C'1 '                                                    00362800
         DC    CL9'DEBUG15  '                                           00362900
         DC    CL40'DIRECTWK CLOSE FOR WRITING ATTEMPTED    '           00363000
         DC    C'1 '                                                    00363100
         DC    CL9'DEBUG15  '                                           00363200
         DC    CL40'DIRECTWK CLOSE FOR READING ATTEMPTED    '           00363300
         DC    C'1 '                                                    00363400
         DC    CL9'DEBUG15  '                                           00363500
         DC    CL40'DIRECTWK OPEN FOR WRITE ATTEMPTED      '            00363600
         DC    C'1 '                                                    00363700
         DC    CL9'DEBUG15  '                                           00363800
         DC    CL40'ACCIN OPEN ATTEMPTED                    '           00363900
         DC    C'1 '                                                    00364000
         DC    CL9'DEBUG15  '                                           00364100
         DC    CL40'ACCIN CLOSE ATTEMPTED                   '           00364200
         DC    C'1 '                                                    00364300
         DC    CL9'DEBUG15  '                                           00364400
         DC    CL40'ACCDEV CLOSE ATTEMPTED                  '           00364500
         DC    C'1 '                                                    00364600
         DC    CL9'DEBUG15  '                                           00364700
         DC    CL40'EREPPT OPEN ATTEMPTED                   '           00364800
         DC    C'1 '                                                    00364900
         DC    CL9'DEBUG15  '                                           00365000
         DC    CL40'EREPPT CLOSE ATTEMPTED                  '           00365100
         DC    C'1 '                                                    00365200
         DC    CL9'DEBUG15  '                                           00365300
         DC    CL40'ACCDEV OPEN ATTEMPTED                   '           00365400
         DC    C'1 '                                                    00365500
         DC    CL9'DEBUG15  '                                           00365600
         DC    CL40'FIRST FRAME READ ATTEMPT                '           00365700
         DC    C'1 '                                                    00365800
         DC    CL9'DEBUG15  '                                           00365900
         DC    CL40'TIMES IFCIOHND EXITED WITH R.C.12       '           00366000
         DC    C'1 '                                                    00366100
         DC    CL9'DEBUG15  '                                           00366200
         DC    CL40'SERLOG SEQUENTIAL READ ATTEMPTS         '           00366300
         DC    C'1 '                                                    00366400
         DC    CL9'DEBUG15  '                                           00366500
         DC    CL40'SERLOG DIRECT READ ATTEMPTS             '           00366600
         DC    C'1 '                                                    00366700
         DC    CL9'DEBUG15  '                                           00366800
         DC    CL40'TIME CONVERSION NECESSARY NUM. TIMES    '           00366900
         DC    C'1 '                                                    00367000
         DC    CL9'DEBUG15  '                                           00367100
         DC    CL40'RECORDS SAVED DURING ZEROALL PROCESSING '           00367200
         DC    C'1 '                                                    00367300
         DC    CL9'DEBUG15  '                                           00367400
         DC    CL40'SYSIN READ ATTEMPTS                     '           00367500
         DC    C'1 '                                                    00367600
         DC    CL9'DEBUG15  '                                           00367700
         DC    CL40'DIRECTWK WRITE ATTEMPTS                 '           00367800
         DC    C'1 '                                                    00367900
         DC    CL9'DEBUG15  '                                           00368000
         DC    CL40'DIRECTWK READ ATTEMPTS                  '           00368100
         DC    C'1 '                                                    00368200
         DC    CL9'DEBUG15  '                                           00368300
         DC    CL40'ACCIN SEQUENTIAL READ ATTEMPTS          '           00368400
         DC    C'1 '                                                    00368500
         DC    CL9'DEBUG15  '                                           00368600
         DC    CL40'ACCDEV WRITE ATTEMPTS                   '           00368700
         DC    C'1 '                                                    00368800
         DC    CL9'DEBUG15  '                                           00368900
         DC    CL40'FRAME READ ATTEMPTS OF SYS1.LOGREC      '           00369000
         DC    C'1 '                                                    00369100
         DC    CL9'DEBUG15  '                                           00369200
         DC    CL40'DIRECTWK OPEN FOR READING               '           00369300
*                                                                       00369400
*        MACHINE CONTROL CHARACTER TRANSLATE TABLE                      00369500
*                                                                       00369600
MACHCODE DC    X'0901090909090909'                                      00369700
         DC    X'0909090B09090909'                                      00369800
         DC    X'0911091309090909'                                      00369900
         DC    X'0919091B09090909'                                      00370000
         DC    X'0909090909090909'                                      00370100
         DC    X'0909090909090909'                                      00370200
         DC    X'0909090909090909'                                      00370300
         DC    X'0909090909090909'                                      00370400
         DC    X'0909090909090909'                                      00370500
         DC    X'0909090909090909'                                      00370600
         DC    X'0909090909090909'                                      00370700
         DC    X'0909090909090909'                                      00370800
         DC    X'0909090909090909'                                      00370900
         DC    X'0909090909090909'                                      00371000
         DC    X'0909090909090909'                                      00371100
         DC    X'0909090909090909'                                      00371200
         DC    X'0909090909090909'                                      00371300
         DC    X'0989098B09090909'                                      00371400
         DC    X'0991099309090909'                                      00371500
         DC    X'0999099B09090909'                                      00371600
         DC    X'09A109A309090909'                                      00371700
         DC    X'090909AB09090909'                                      00371800
         DC    X'09B109B309090909'                                      00371900
         DC    X'09B909BB09090909'                                      00372000
         DC    X'09C109C309090909'                                      00372100
         DC    X'090909CB09090909'                                      00372200
         DC    X'09D109D309090909'                                      00372300
         DC    X'09D909DB09090909'                                      00372400
         DC    X'09E109E309090909'                                      00372500
         DC    X'0909090909090909'                                      00372600
         DC    X'0909090909090909'                                      00372700
         DC    X'0909090909090909'                                      00372800
*                                                                       00372900
*        LTORG                                                          00373000
*                                                                       00373100
         LTORG                                                          00373200
*                                                                       00373300
         PRINT NOGEN                                                    00373400
*                                                                       00373500
         DCBD  DSORG=PS,DEVD=DA        DCB DSECT                        00373600
*                                                                       00373700
*        IEZDEB                                                         00373800
*                                                                       00373900
         IEZDEB                                                         00374000
*                                                                       00374100
         PRINT GEN                                                      00374200
*                                                                       00374300
IFCIOHND CSECT                                                          00374400
*                                                                       00374500
R0       EQU   00                      EQUATES FOR REGISTERS 0-15       00374600
R1       EQU   01                                                       00374700
R2       EQU   02                                                       00374800
R3       EQU   03                                                       00374900
R4       EQU   04                                                       00375000
R5       EQU   05                                                       00375100
R6       EQU   06                                                       00375200
R7       EQU   07                                                       00375300
R8       EQU   08                                                       00375400
R9       EQU   09                                                       00375500
R10      EQU   10                                                       00375600
R11      EQU   11                                                       00375700
R12      EQU   12                                                       00375800
R13      EQU   13                                                       00375900
R14      EQU   14                                                       00376000
R15      EQU   15                                                       00376100
*                                                                       00376200
PARM     EQU   0                                                        00376300
RECTYPE  EQU   PARM                                                     00376400
SWITCHES EQU   PARM+2                                                   00376500
NOSDR    EQU   SWITCHES                                                 00376600
ZEROALL  EQU   SWITCHES+1                                               00376700
DEBUG    EQU   PARM+4                                                   00376800
DEBUG15  EQU   DEBUG+1                                                  00376900
DEBUGA   EQU   PARM+8                                                   00377000
MISC     EQU   PARM+12                                                  00377100
PRINTES  EQU   MISC                                                     00377200
OPENCLSE EQU   PARM+13                                                  00377300
OPENIO   EQU   OPENCLSE                                                 00377400
OTOURIST EQU   OPENIO                                                   00377500
OEREPPT  EQU   OPENIO                                                   00377600
OSERLOG  EQU   OPENIO                                                   00377700
OACCIN   EQU   OPENIO                                                   00377800
OACCDEV  EQU   OPENIO                                                   00377900
OSYSIN   EQU   OPENIO                                                   00378000
ODRCTWRK EQU   OPENIO                                                   00378100
CLOSEIO  EQU   OPENCLSE+2                                               00378200
CTOURIST EQU   CLOSEIO                                                  00378300
CEREPPT  EQU   CLOSEIO                                                  00378400
CSERLOG  EQU   CLOSEIO                                                  00378500
CACCIN   EQU   CLOSEIO                                                  00378600
CACCDEV  EQU   CLOSEIO                                                  00378700
CSYSIN   EQU   CLOSEIO                                                  00378800
CDRCTWRK EQU   CLOSEIO                                                  00378900
DATENOW  EQU   PARM+17                                                  00379000
STDT     EQU   PARM+23                                                  00379100
STDATE   EQU   STDT                                                     00379200
PSTD     EQU   STDATE+1                                                 00379300
ENDDT    EQU   PARM+31                                                  00379400
ENDDATE  EQU   ENDDT                                                    00379500
PEND     EQU   ENDDATE+1                                                00379600
STTIME1  EQU   PARM+39                                                  00379700
ENDTIME1 EQU   PARM+43                                                  00379800
STTIME2  EQU   PARM+47                                                  00379900
ENDTIME2 EQU   PARM+51                                                  00380000
STRTDATE EQU   PARM+55                                                  00380100
@NM00006 EQU   PARM+72                                                  00380200
@NM00007 EQU   PARM+75                                                  00380300
ERRID    EQU   PARM+92                                                  00380400
IDTIMEA  EQU   ERRID+6                                                  00380500
IDTIME   EQU   IDTIMEA                                                  00380600
CCHHRLNG EQU   PARM+112                                                 00380700
RECCCHHR EQU   CCHHRLNG                                                 00380800
RECLNGTH EQU   CCHHRLNG+6                                               00380900
LINECT   EQU   PARM+120                                                 00381000
LINECTSV EQU   PARM+122                                                 00381100
ADIOHND  EQU   PARM+124                                                 00381200
ADIFCMSG EQU   PARM+128                                                 00381300
ADEDITB  EQU   PARM+132                                                 00381400
EVPTR    EQU   PARM+136                                                 00381500
SORTADR  EQU   PARM+140                                                 00381600
PRINTADR EQU   PARM+148                                                 00381700
CUAPTR   EQU   PARM+152                                                 00381800
DEVPTR   EQU   PARM+156                                                 00381900
MODPTR   EQU   PARM+160                                                 00382000
SERPTR   EQU   PARM+164                                                 00382100
VOLPTR   EQU   PARM+168                                                 00382200
CPUPTR   EQU   PARM+172                                                 00382300
CPCUAPTR EQU   PARM+176                                                 00382400
LIBADPTR EQU   PARM+180                                                 00382500
SYMCDPTR EQU   PARM+184                                                 00382600
SYSUMPTR EQU   PARM+188                                                 00382700
TRENPTR  EQU   PARM+192                                                 00382800
SHAREPTR EQU   PARM+196                                                 00382900
MERDCPTR EQU   PARM+208                                                 00383000
DUMPTABL EQU   PARM+228                                                 00383100
DUMPINFO EQU   DUMPTABL+4                                               00383200
TRENDONE EQU   0                                                        00383300
TREGEN   EQU   TRENDONE+8                                               00383400
TRECCH0  EQU   TREGEN+8                                                 00383500
TREND2   EQU   0                                                        00383600
TRENDKEY EQU   TREND2                                                   00383700
TRENDRT  EQU   TRENDKEY+1                                               00383800
TRENCPUS EQU   TRENDKEY+3                                               00383900
TRENDITM EQU   TRENDKEY+4                                               00384000
EVTABLE  EQU   0                                                        00384100
EVSTOP   EQU   EVTABLE                                                  00384200
EVKEY    EQU   EVTABLE+6                                                00384300
SORTABLE EQU   0                                                        00384400
SORTKEY  EQU   SORTABLE                                                 00384500
SORTCCHR EQU   SORTABLE+5                                               00384600
SYSUMONE EQU   0                                                        00384700
SYSUM2   EQU   0                                                        00384800
SYSUMKEY EQU   SYSUM2                                                   00384900
SYSRT    EQU   SYSUMKEY+1                                               00385000
SYSCPUS  EQU   SYSUMKEY+3                                               00385100
SYSITEM  EQU   SYSUMKEY+4                                               00385200
SHARE    EQU   0                                                        00385300
SHAREIO  EQU   SHARE+2                                                  00385400
SHRBASE  EQU   SHAREIO+1                                                00385500
SHRCUCPU EQU   SHAREIO+8                                                00385600
EDITLOAD EQU   0                                                        00385700
EDITABLE EQU   EDITLOAD+4                                               00385800
CUA      EQU   0                                                        00385900
CUAVAL   EQU   CUA+2                                                    00386000
DEVICE   EQU   0                                                        00386100
MODELS   EQU   0                                                        00386200
DEVSERAL EQU   0                                                        00386300
VOLUME   EQU   0                                                        00386400
CPUS     EQU   0                                                        00386500
CPUCUAS  EQU   0                                                        00386600
CPUCUAV  EQU   CPUCUAS+2                                                00386700
LIBADR   EQU   0                                                        00386800
SYMCODE  EQU   0                                                        00386900
SYMVAL   EQU   SYMCODE+2                                                00387000
MERIDIAN EQU   0                                                        00387100
NEXTBYTE EQU   0                                                        00387200
ADDNUM   EQU   0                                                        00387300
*                                                                       00387400
IOPLINE  EQU   0                                                        00387500
PRINTDS  EQU   IOPLINE                                                  00387600
PRINTCC  EQU   IOPLINE+1                                                00387700
PRINTBDY EQU   IOPLINE+2                                                00387800
*                                                                       00387900
RECTB    EQU   0                                                        00388000
FORPTR   EQU   RECTB                                                    00388100
JUNK     EQU   RECTB+4                                                  00388200
JUNK3    EQU   JUNK+6                                                   00388300
RECSPT   EQU   RECTB+12                                                 00388400
OHEADER  EQU   0                                                        00388500
OHDRREC1 EQU   OHEADER+11                                               00388600
OHDRREC2 EQU   OHEADER+22                                               00388700
RECAREA  EQU   0                                                        00388800
@NM00028 EQU   RECAREA+2                                                00388900
NSSWITCH EQU   @NM00028                                                 00389000
LCSWITCH EQU   @NM00028                                                 00389100
DATETIME EQU   RECAREA+8                                                00389200
DATE     EQU   DATETIME                                                 00389300
DATE0    EQU   DATE                                                     00389400
GMTSW    EQU   DATE0                                                    00389500
YEAR     EQU   DATE+1                                                   00389600
DAYS     EQU   DATE+2                                                   00389700
TIME     EQU   DATETIME+4                                               00389800
HOURS    EQU   TIME                                                     00389900
MINS     EQU   TIME+1                                                   00390000
SECS     EQU   TIME+2                                                   00390100
TNTHS    EQU   TIME+3                                                   00390200
GETTIT   EQU   GETHIS                                                   00390300
EDFLD    EQU   EDIFILD                                                  00390400
CTPTR    EQU   CONTPTR                                                  00390500
BUFFER   EQU   BUF1                                                     00390600
BCOUNT   EQU   BUFFER                                                   00390700
BCCHHR   EQU   BCOUNT                                                   00390800
BSIZE    EQU   BCOUNT+6                                                 00390900
BDATA    EQU   BUFFER+8                                                 00391000
BSZ      EQU   BSIZE                                                    00391100
BBRDW    EQU   BCCHHR+4                                                 00391200
*                                                                       00391300
         END   IFCIOHND                                                 00391400
/*
//*
//STEP3   EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
  IDENTIFY IFCIOHND('ZP60037')
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP4   EXEC SMPREC,WORK='SYSALLDA'
//SMPPTFIN DD  DSN=&&SMPMCS,DISP=(OLD,DELETE)
//SMPCNTL  DD  *
  RECEIVE
          SELECT(ZP60037)
          .
/*
//*
//STEP5CK EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60037)
        CHECK
        .
/*
//*
//STEP5   EXEC SMPAPP,COND=(0,NE),WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60037)
        DIS(WRITE)
        .
/*
//
//ZP60038  JOB (SYSGEN),'J03 M49: ZP60038',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*  ADD CLIST VARIABLE PROCESSING APPLICATION PROGRAM INTERFACE
//*
//STEP01  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DATA
++USERMOD(ZP60038) REWORK(20190727)  /* ADD CLIST VARIABLE API */ .
++VER(Z038) FMID(EBB1102)
  PRE(UY01301,ZP60014)
 /*
   PROBLEM DESCRIPTION:
     THERE IS NO PROGRAMATIC INTERFACE FOR CLIST VARIABLE PROCESSING.
       APPLICATIONS RUNNING IN A TSO CLIST ENVIRONMENT HAVE NO
       SUPPORTED METHOD OF RETRIEVING OR SETTING THE VALUES OF CLIST
       SYMBOLIC VARIABLES.

       THIS USERMOD SUPPLIES A NEW MODULE CALLED IKJCT441 WHICH
       PROVIDES AN API TO ALLOW PROGRAMS TO PROCESS CLIST SYMBOLIC
       VARIABLES.  THE PARAMETER LIST AND RETURN CODE INTERFACE IS
       COMPATIBLE WITH THAT OF THE IKJCT441 MODULE IN IBM'S TSO/E.


   SPECIAL CONDITIONS:
     ACTION:
       A "CLPA" MUST BE PERFORMED AT IPL TIME FOR THIS SYSMOD TO
       BECOME ACTIVE.

       THE MODULE SUPPLIED IN THIS SYSMOD CALLS AN ENTRY POINT
       CREATED BY SYSMOD ZP60014.

   COMMENTS:
     PRYCROFT SIX P/L PUBLIC DOMAIN USERMOD FOR MVS 3.8 NUMBER 38.

     REWORK HISTORY:
       2018-01-20: INITIAL AVAILABILITY.
       2019-07-27: ALLOW A RETRIEVE/CREATE REQUEST TO SET A NON-NULL
                   INITIAL VALUE WHEN THE SYMBOL IS BEING CREATED.

     THE FOLLOWING MODULES AND/OR MACROS ARE AFFECTED BY THIS USERMOD:
     MODULES:
       IKJCT441
     MACROS:
       SGIKJ441
 */.
++JCLIN.
//P638    EXEC PGM=IEWL,PARM='NCAL,LIST,XREF,LET,REUS,RENT'
//SYSPRINT DD  SYSOUT=*
//AOST4    DD  DISP=SHR,DSN=SYS1.AOST4
//SYSLMOD  DD  DISP=SHR,DSN=SYS1.LPALIB
//SYSLIN DD *
    ORDER IKJEFT30,IKJEFT35,IKJEFT40,IKJEFT45
    ORDER IKJEFT52,IKJEFT53,IKJEFT54,IKJEFT55
    ORDER IKJEFT56,IKJRBBMC,IKJCT433,IKJCT434
    ORDER IKJCT436,IKJCT441
    INCLUDE AOST4(IKJEFT30,IKJEFT35,IKJEFT40)
    INCLUDE AOST4(IKJEFT45,IKJEFT52,IKJEFT53)
    INCLUDE AOST4(IKJEFT54,IKJEFT55,IKJEFT56)
    INCLUDE AOST4(IKJRBBMC,IKJCT441)
    INCLUDE AOST4(IKJCT433,IKJCT434,IKJCT436)
    ALIAS IKJGETL,IKJPUTL,IKJSTCK,IKJCT441
    ENTRY IKJPTGT
 NAME IKJPTGT(R)
++MOD(IKJCT441) DISTLIB(AOST4).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(NEW,PASS),UNIT=SYSALLDA,
//             SPACE=(CYL,3),
//             DCB=(DSORG=PS,RECFM=FB,LRECL=80,BLKSIZE=4080)
//SYSIN    DD  DUMMY
//*
//STEP02  EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT),RENT'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//         DD  DSN=SYS1.APVTMACS,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  *
IKJCT441 TITLE ' CLIST VARIABLE ACCESS ROUTINE '
*
*  NAME        - IKJCT441
*
*  FUNCTION    - TO PROVIDE AN INTERFACE FOR USER-WRITTEN PROGRAMS
*                TO RETRIEVE AND UPDATE CLIST VARIABLES.
*
*  ATTRIBUTES  - REENTRANT, REFRESHABLE, NO APF REQUIREMENTS.
*
*  ENVIRONMENT - ADDRESS SPACE CONTROLLED BY THE TERMINAL MONITOR
*                PROGRAM WHERE A CLIST IS BEING EXECUTED.
*                THE CALLER IS EXPECTED TO BE RUNNING IN THE TASK
*                TREE WHICH CAN ACQUIRE AND FREE STORAGE IN THE
*                SUBPOOL 78 SHARED BY THE TMP.
*
*  AUTHOR      - GREG PRICE - JANUARY 2018.
*
*                THIS PROGRAM USES MACROS FROM:
*                SYS1.MACLIB, SYS1.AMODGEN AND SYS1.APVTMACS.
*
*  CHANGE LOG:
*    20JAN2018 - DELIVERED IN USERMOD ZP60038.
*    27JUL2019 - ALLOW A RETRIEVE/CREATE REQUEST TO SET A NON-NULL
*                INITIAL VALUE WHEN THE SYMBOL IS BEING CREATED.
*                THE FIX WAS TO DELETE 7 LINES OF CODE LOCATED 2
*                LINES AFTER THE LABEL LOCNTFND WHICH ERRONEOUSLY
*                DIFFERENTIATED BETWEEN THE RETRIEVE/CREATE AND THE
*                UPDATE/CREATE REQUEST TYPES.
*
         TITLE ' PARAMETER LIST '
*
*  6, 7, 8 OR 9 WORD PARAMETER LIST:
*
*     *****************************                  1=RETURN/CREATE
*     *                           *   ************   2=UPDATE/CREATE
*  +0 * -> ENTRY CODE             *-->* ECODE    *   3=LOCATE ALL
*     *                           *   ************  18=RETURN/NOCREATE
*     *****************************
*     *                           *   ************   *****************
*  +4 * -> VARIABLE NAME ADDRESS  *-->* NAMEPTR  *-->* VARIABLE NAME *
*     *                           *   ************   *****************
*     *****************************
*     *                           *   ************
*  +8 * -> VARIABLE NAME LENGTH   *-->* NAMELEN  *
*     *                           *   ************
*     *****************************
*     *                           *   ************   ************
* +12 * -> VARIABLE VALUE ADDRESS *-->* VALUEPTR *-->* VALUE    *
*     *                           *   ************   ************
*     *****************************
*     *                           *   ************
* +16 * -> VARIABLE VALUE LENGTH  *-->* VALUELEN *
*     *                           *   ************
*     *****************************
*     *                           *   ************   TOKEN MUST EXIST
* +20 * -> TOKEN                  *-->* TOKEN    *   AND START AS ZERO
*     *                           *   ************   FOR "LOCATE ALL"
*     *****************************
*     *                           *   ************   IF HIGH VALUES OR
* +24 * -> ECT                    *-->* ECTPARM  *   NOT IN PLIST THEN
*     *                (OPTIONAL) *   ************   USE LWAPECT
*     *****************************
*     *                           *   ************   REQUIRED IF
* +28 * -> RETURN CODE            *-->* RETCODE  *   NEXTLIST IS
*     *                (OPTIONAL) *   ************   PRESENT
*     *****************************
*     *                           *   ************   *****************
* +32 * -> NEXT PLIST ADDRESS     *-->* NEXTLIST *-->* -> ENTRY CODE *
*     *                (OPTIONAL) *   ************   *****************
*     *****************************                  *               *
*                                                    ~~~~~~~~~~~~~~~~~
         TITLE ' ENTRY AND RETURN CODES '
*
*  ENTRY CODES (WITH NAMES FROM THE Z/OS IKJTSVT MACRO):
*
*      1 - TSVERETR - RETRIEVE/CREATE REQUEST
*      2 - TSVEUPDT - UPDATE/CREATE REQUEST
*      3 - TSVELOC  - LOCATE ALL REQUEST (WHICH USES THE TOKEN)
*     18 - TSVNOIMP - RETRIEVE/NOCREATE REQUEST
*
*  NOTE THAT UPDATE FUNCTIONS (REQUIRED WHEN CREATING AND UPDATING
*  VARIABLES) WILL BE PERFORMED BY CALLS TO IKJINIT, WHICH IS THE
*  SAME AS IKJUPDT EXCEPT THAT NON-EXISTENT VARIABLES ARE CREATED.
*
*  IKJINIT AND IKJUPDT ARE ENTRY POINTS OF MODULE IKJCT433.
*  IKJINIT WAS CREATED BY USERMOD ZP60014 (CLIST EXTENSIONS).
*
*
*  RETURN CODES:
*
*      0 - SUCCESS
*      4 - VARIABLE RETURNED SHOULDN'T BE RE-SCANNED
*      8 - VARIABLE RETURNED REQUIRES EVALUATION
*     12 - VARIABLE RETURNED IS A LABEL (CANNOT UPDATE)
*     16 - SYSTEM VARIABLE - CAN'T BE UPDATED BY THE USER
*     20 - FOR LOCATE - NO MORE VARIABLES TO RETURN
*     32 - GETMAIN/FREEMAIN FAILURE
*     36 - NAME LENGTH < 1 OR > 252 -OR- VALUE LENGTH < 0 OR > 32767
*     40 - INCORRECT ENVIRONMENT - PLIST ERROR OR NO CLIST ACTIVE
*     44 - INVALID ENTRY CODE
*     52 - UNDEFINED VARIABLE
*
*  NOTE THAT GPR15 WILL RETURN WITH THE FIRST NON-ZERO RETURN CODE
*  IN A REQUEST LIST, OR ZERO IF ALL REQUESTS SUCCEEDED.
*
*  IF ADDITIONAL RETURN CODES ARE REQUIRED THEN THEY SHOULD BE
*  CHOSEN SUCH THAT INCOMPATIBILITIES WITH THE Z/OS VERSION OF
*  IKJCT441 ARE MINIMIZED.  THERE ARE OTHER IKJCT441 RETURN CODE
*  VALUES NOT USED HERE.  SEE:
*  SA32-0973 Z/OS TSO/E PROGRAMMING SERVICES
*            - CHAPTER 24. USING THE VARIABLE ACCESS ROUTINE IKJCT441
*
         TITLE ' REGISTER EQUATES AND SYSTEM DATA AREAS '
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
         SPACE
         PRINT NOGEN
         SPACE
         IHAPSA DSECT=YES          PREFIXED SAVE AREA
         SPACE
         IHAASCB DSECT=YES         ADDRESS SPACE CONTOL BLOCK
         SPACE
         IHAASXB DSECT=YES         ADDRESS SPACE EXTENSION BLOCK
         SPACE
         IKJEFLWA ,                LOGON WORK AREA
         SPACE
         IKJPSCB ,                 PROTECTED STEP CONTROL BLOCK
         SPACE
         PRINT GEN
         TITLE ' TSO DATA AREAS '
*
*         ENVIRONMENT CONTROL TABLE
*
         IKJECT ,                  LWAPECT -> SESSION'S FIRST ECT
         SPACE
*
*         I/O SERVICE ROUTINE WORK AREA
*
IOSRL    DSECT ,                   ECTIOWA -> IOSRL
IOSTELM  DS    A                   TOP STACK ELEMENT POINTER
IOSBELM  DS    A                   BOTTOM ELEMENT POINTER
IOSTLEN  DS    H                   STACK SIZE
IOSNELM  DS    H                   NUMBER OF ELEMENTS
IOSUNUSD DS    F                   SPARE
         SPACE
*
*         INPUT STACK ELEMENT
*
INSTACK  DSECT ,                   IOSTELM -> TOP ELEMENT
INSCODE  DS    X                   INPUT STACK OPTIONS
INSTERM  EQU   X'80'               TERMINAL INPUT STACK ENTRY
INSSTOR  EQU   X'40'               IN STORAGE LIST
INSINDD  EQU   X'20'               INPUT FROM DD VIA DCB
INSOTDD  EQU   X'10'               OUTPUT TO DD VIA DCB
INSEXEC  EQU   X'08'               EXEC COMMAND STACK ENTRY
INSPROM  EQU   X'04'               PROMPT ALLOWED
INSPROC  EQU   X'02'               PROCEDURE FLAG
INSLIST  EQU   X'01'               LIST LINES BEFORE EXEC
INSADLSD DS    AL3                 POINTER TO LSD
         SPACE
*
*         (IN-STORAGE) LIST SOURCE DESCRIPTOR
*
         IKJLSD ,                  INSADLSD -> LSD
         SPACE
*
*         EXECDATA CONTROL BLOCK
*
EXECDATA DSECT ,                   LSDEXEC -> EXECDATA
SNTABFST DS    A                   -> FIRST SNTAB
SVTABFST DS    A                   -> FIRST SVTAB
GEXECDAT DS    A                   -> GLOBAL EXECDATA
LASTTSO  DS    A                   -> LAST TSO COMMAND EXECUTED
EXINSAVE DS    X                   TERMIN INSTACK SAVE AREA
         DS    XL3
ERACTSTR DS    A                   -> START OF THE ERROR ACTION FOR
*                                  THIS CLIST - THIS FIELD IS ZERO
*                                  WHEN THERE IS NO ERROR ACTION
ERACTEND DS    A                   -> END OF THE ERROR ACTION RANGE
RETPTR   DS    A                   -> THE COMMAND AFTER THE 1 IN ERROR
EXDATFLG DS    X                   EXEC DATA FLAG AREA (1ST BYTE)
CONLST   EQU   X'80'               ON IF CONTROL STATEMENTS ARE
*                                  TO BE LISTED AS THEY ARE EXECUTED
ERRCMD   EQU   X'40'               ON IF AN ERROR COMMAND IS IN EFFECT
NOFLUSH  EQU   X'20'               ON IF NOFLUSH OPTION IN EFFECT
SYMLST   EQU   X'10'               ON IF SYMLIST OPTION IN EFFECT
ERINCNTL EQU   X'08'               ON WHEN THE PROCESSING IN AN
*                                  ERROR RANGE IS A DIRECT RESULT
*                                  OF A CLIST STMT ERROR
CMAIN    EQU   X'04'               ON FOR CONTROL CLIST (MAIN)
NOMSG    EQU   X'02'               ON FOR NOMSG OPTION
ATTNCMD  EQU   X'01'               ON IF ATTENTION CMD IN EFFECT
EXDATFL1 DS    X                   EXEC DATA FLAG AREA (2ND BYTE)
ATINCNTL EQU   X'80'               IN ATTN ON BEHALF OF ATTN
NOLASTCC EQU   X'40'               SKIP LASTCC UPDATE AFTER STMT
*        EQU   X'20'               RESERVED
*        EQU   X'10'               RESERVED
*        EQU   X'08'               RESERVED
*        EQU   X'04'               RESERVED
*        EQU   X'02'               RESERVED
*        EQU   X'01'               RESERVED
STAECNT  DS    H                   CT433 STAE LOOP CTL
GEXECCNT DS    F                   NUMBER OF GLOBAL VARIABLES
*                                  SUPPORTED FOR NESTED PROCEDURES
EXDLMPTR DS    A                   -> TERMIN DELIMS
ATACTSTR DS    A                   -> ATTENTION ACTION START
ATACTEND DS    A                   -> ATTENTION ACTION END
RETPTR2  DS    A                   -> ALTERNATE RETURN
FILEDCBS DS    A                   -> FILE I/O DCB CHAIN
         DS    F
         SPACE
*
*         SYMBOLIC NAME TABLE
*
SNTAB    DSECT ,                   SNTABPTR -> SNTAB
SNTABNXT DS    A                   -> NEXT SNTAB
SNTABLNG DS    F                   LENGTH OF THIS SNTAB
SNTABUSE DS    F                   USED BYTES IN THIS SNTAB
SNTELFST DS    0X                  FIRST SNTAB ELEMENT
         SPACE
*
*         SYMBOLIC NAME TABLE ELEMENT
*
SNTELEM  DSECT ,                   SNTAB ELEMENT
SNTVLPTR DS    0A                  ADDRESS OF THE SVTAB ELEMENT
*                                  FOR THIS SYMBOLIC PARAMETER OR
SNTGVAL  DS    F                   THE GLOBAL VARIABLE NAME IF
*                                  PARAMETER IS GLOBAL
SNTFLAGS DS    X                   SNTAB ELEMENT FLAGS (1ST BYTE)
*                                  - DEFINES THE TYPE OF PARM
SNTPOSIT EQU   X'80'               POSITIONAL ELEMENT
SNTKEY   EQU   X'40'               KEYWORD ELEMENT
SNTKEYW  EQU   X'20'               KEYWORD WITH VALUE ELEMENT
SNTLABEL EQU   X'10'               LABEL ELEMENT
SNTNOSCN EQU   X'08'               VARIABLE NOT RESCANNABLE
SNTNAUTH EQU   X'04'               CONTROL VARIABLE CAN NOT BE
*                                  SET BY THE USER
SNTEVAL  EQU   X'02'               CONTROL VARIABLE REQUIRES
*                                  IMMEDIATE EVALUATION
SNTLAST  EQU   X'01'               DEFINES THE LAST ELEMENT IN
*                                  THIS SNTAB
SNTFLAG1 DS    X                   SNTAB ELEMENT FLAGS (2ND BYTE)
SNTGLOB  EQU   X'80'               VARIABLE IS A GLOBAL VARIABLE
*        EQU   X'40'               RESERVED
*        EQU   X'20'               RESERVED
*        EQU   X'10'               RESERVED
*        EQU   X'08'               RESERVED
*        EQU   X'04'               RESERVED
*        EQU   X'02'               RESERVED
*        EQU   X'01'               RESERVED
SNTLNG   DS    H                   SYMBOLIC PARAMETER NAME LENGTH
SNTDATA  DS    0C                  SYMBOLIC PARAMETER NAME
         SPACE
*
*         SYMBOLIC VALUE TABLE
*
SVTAB    DSECT ,                   SVTABPTR -> SNTAB
SVTABNXT DS    A                   -> NEXT SVTAB
SVTABLNG DS    F                   LENGTH OF THIS SVTAB
SVTABUSE DS    F                   USED BYTES IN THIS SVTAB
SVTABFRE DS    F                   UNUSED BYTES IN THIS SVTAB
SVTELFST DS    0X                  FIRST SVTAB ELEMENT
         SPACE
*
*         SYMBOLIC VALUE TABLE ELEMENT
*
SVTELEM  DSECT ,                   SVTAB ELEMENT
SVTLNG   DS    H                   CURRENT VALUE LENGTH
SVTORIG  DS    H                   ORIGINAL VALUE LENGTH
SVTDATA  DS    0C                  CURRENT VALUE
         TITLE ' INITIALIZATION '
*
*         ENTRY - ACQUIRE WORKING STORAGE
*
         USING PSA,0
         USING IKJCT441,R15
IKJCT441 CSECT
         B     $START
         DC    AL1(25),CL25'IKJCT441 ZP60038 20180120'
         DROP  R15                 (IKJCT441)
         USING IKJCT441,R12
$START   STM   R14,R12,12(R13)     SAVE REGISTERS
         LR    R12,R15             SET LOCAL BASE
         LA    R2,0(,R1)           COPY PARAMETER LIST ADDRESS
         LA    R0,$WKSIZE          GET WORKING STORAGE SIZE
         GETMAIN RC,LV=(0)         GET WORKING STORAGE
         LTR   R15,R15             SUCCESS?
         BZ    WRKSTGOK            YES
         LM    R14,R12,12(R13)     NO, RESTORE REGISTERS
         LA    R15,32              SET RC=32
         BR    R14                 RETURN TO CALLER
*
*         ENTRY - PREPARE WORKING STORAGE FOR USE
*
WRKSTGOK LR    R14,R1              POINT TO THE NEW STORAGE
         LA    R15,$WKSIZE         GET ITS SIZE
         SR    R3,R3               ZERO SOURCE LENGTH AND PAD
         MVCL  R14,R2              ZERO THE NEW STORAGE
         ST    R13,4(,R1)          CHAIN BACK TO CALLER'S SAVE AREA
         ST    R1,8(,R13)          CHAIN FORWARD TO NEW SAVE AREA
         LR    R13,R1              POINT TO NEW CURRENT SAVE AREA
         USING WORKAREA,R13
         MVC   LOCALID,=CL8'WRKCT441'
         LTR   R2,R2               ANY PARAMETERS SUPPLIED?
         BZ    EXIT40              NO, BAD PARAMETER LIST
         ST    R2,PARM9            SAVE PAREMETER LIST ADDRESS
*
*         MAIN LOOP - PROCESS NEXT REQUEST
*
NEXTRQST L     R3,PARM9            POINT TO PARAMETER LIST
         LTR   R3,R3               MORE TO DO?
         BZ    FINISHUP            NO, TIME TO FINISH UP
         XC    PARMLIST($PRMSIZE),PARMLIST
         LA    R0,=F'-1'           POINT TO A WORD OF HIGH VALUES
         ST    R0,PARM7            SET DEFAULT ECT SPEC.
         LA    R4,PARMLIST         POINT TO LOCAL PLIST AREA
         LA    R0,$PRMSIZE/4       GET MAXIMUM PLIST WORD COUNT
REQPRMLP L     R2,0(,R3)           LOAD PLIST ENTRY
         LA    R1,0(,R2)           ENSURE ADDRESS FORMAT
         ST    R1,0(,R4)           SAVE IT
         LTR   R2,R2               LAST PARAMETER?
         BM    CHKPARMS            YES
         LA    R3,4(,R3)           POINT TO NEXT PLIST ENTRY
         LA    R4,4(,R4)           POINT TO NEXT PLIST ENTRY COPY AREA
         BCT   R0,REQPRMLP         KEEP COPYING PLIST ENTRIES
CHKPARMS LA    R0,5                GET INITIAL CHECK WORD COUNT
         LA    R3,PARMLIST         POINT TO PLIST COPY
CHKPRMLP ICM   R2,15,0(R3)         ZERO ADDRESS SUPPLIED?
         BZ    EXIT40              YES, SO END THIS REQUEST
         LA    R3,4(,R3)           NO, POINT TO NEXT PLIST ENTRY
         BCT   R0,CHKPRMLP         CHECK FIRST SEVERAL PLIST ENTRIES
         L     R2,PARM1            POINT TO ECODE
         L     R2,0(,R2)           LOAD ECODE
         ST    R2,ECODE            SAVE A COPY LOCALLY
         ICM   R2,14,ECODE         RELOAD THE FIRST 3 BYTES OF ECODE
         BNZ   EXIT40              INVALID ECODE IF NOT ZERO
         CLI   ECODE1,EC$EUPDT     UPDATE/CREATE REQUEST?
         BE    ECODEOK             YES, ECODE IS VALID
         CLI   ECODE1,EC$ERETR     RETRIEVE/CREATE REQUEST?
         BE    ECODEOK             YES, ECODE IS VALID
         CLI   ECODE1,EC$NOIMP     RETRIEVE/NOCREATE REQUEST?
         BE    ECODEOK             YES, ECODE IS VALID
         CLI   ECODE1,EC$ELOC      LOCATE ALL REQUEST?
         BNE   EXIT40              NO, ECODE IS INVALID
         ICM   R2,15,PARM6         YES, WAS A TOKEN SUPPLIED?
         BZ    EXIT40              NO, INVALID FOR LOCATE ALL
ECODEOK  ICM   R2,15,PARM2         HAVE ADDRESS OF NAMEPTR?
         BZ    EXIT40              NO, INVALID FOR ALL CALL TYPES
         ICM   R2,15,PARM3         HAVE ADDRESS OF NAMELEN?
         BZ    EXIT40              NO, INVALID FOR ALL CALL TYPES
         ICM   R2,15,PARM4         HAVE ADDRESS OF VALUEPTR?
         BZ    EXIT40              NO, INVALID FOR ALL CALL TYPES
         ICM   R2,15,PARM5         HAVE ADDRESS OF VALUELEN?
         BZ    EXIT40              NO, INVALID FOR ALL CALL TYPES
         ICM   R2,15,PARM9         IS ANOTHER REQUEST CHAINED?
         BZ    PRMCHKOK            NO, END OF INITIAL PLIST CHECK
         ICM   R3,15,PARM8         WAS A RETCODE ADDRESS SUPPLIED?
         BZ    EXIT40              NO, INVALID
PRMCHKOK DC    0H'0'               END OF INITIAL PLIST CHECK
*
*         ACQUIRE ECT TO USE IF NONE WAS SPECIFIED
*
         ICM   R7,15,PARM7         POINT TO ECTPARM
         BZ    EXIT40              A ZERO ECT ADDRESS IS INVALID
         L     R1,PSAAOLD          POINT TO THE CURRENT ASCB
         L     R2,ASCBASXB-ASCB(,R1)    AND THEN TO THE ASXB
         L     R1,ASXBLWA-ASXB(,R2)     AND THEN TO THE LWA
         L     R3,LWAPECT-LWA(,R1)      AND THEN TO THE ECT
         L     R2,LWAPSCB-LWA(,R1)      AND ALSO TO THE PSCB
         L     R2,PSCBUPT-PSCB(,R2)     AND THEN TO THE UPT
         CLC   =F'-1',0(R7)        DEFAULT ECT REQUESTED?
         BNE   PARM7OK             NO
         ST    R3,PARM7            SAVE THE ECT ADDRESS
*
*         SET UP THE IKJINIT PARAMETER LIST
*
PARM7OK  MVC   ECT@,PARM7          COPY ECT ADDRESS
         ST    R2,UPT@             SAVE THE UPT ADDRESS
         LA    R0,ECBAREA          POINT TO THE ECB AREA
         ST    R0,ECB@             SAVE THE ADDRESS IN THE PLIST
         LA    R0,UPLIST           POINT TO THE UPDATE PLIST
         ST    R0,UPLIST@          SAVE THE ADDRESS IN THE PLIST
*
*         VERIFY THE CLIST ENVIRONMENT
*
REDRIVE  L     R7,ECT@             POINT TO THE ECT
         USING ECT,R7
         L     R6,ECTIOWA          POINT TO IOSRL
         DROP  R7                  (ECT)
         USING IOSRL,R6
         L     R8,IOSTELM          POINT TO TOP STACK ELEMENT
         DROP  R6                  (IOSRL)
         USING INSTACK,R8
         TM    INSCODE,INSEXEC     IS A CLIST ACTIVE?
         BNO   EXIT40              NO, INVALID CALL
*
*         LOCATE THE FIRST SYMBOL NAME TABLE
*
         SLR   R7,R7               CLEAR FOR INSERT
         ICM   R7,7,INSADLSD       POINT TO THE LSD
         USING LSD,R7
         L     R7,LSDEXEC          POINT TO EXECDATA
         DROP  R7,R8               (LSD, INSTACK)
         USING EXECDATA,R7
         LA    R4,SNTABFST         POINT TO FIRST SNTAB ADDRESS
         ST    R7,SVLCLED@         SAVE LOCAL EXECDATA BLOCK ADDRESS
         MVC   SVGLBED@,GEXECDAT   SAVE GLOBAL EXECDATA BLOCK ADDRESS
         DROP  R7                  (EXECDATA)
*
*         DIVERGE IF "LOCATE ALL" REQUEST
*
         CLI   ECODE1,EC$ELOC      LOCATE ALL REQUEST?
         BE    ALLLOCAT            YES
*
*         VALIDATE PRESENCE OF VARIABLE NAME
*
         L     R2,PARM2            POINT TO NAMEPTR
         L     R2,0(,R2)           POINT TO NAME
         LA    R2,0(,R2)           ENSURE ADDRESS FORMAT
         LTR   R2,R2               WAS AN ACTUAL NAME SUPPLIED?
         BZ    EXIT40              NO, INVALID
*
*         VALIDATE LENGTH OF VARIABLE NAME
*
         L     R3,PARM3            POINT TO NAMELEN
         L     R3,0(,R3)           GET THE LENGTH
         LTR   R3,R3               IS THE LENGTH POSITIVE?
         BNP   EXIT36              NO, INVALID
         CH    R3,=H'252'          IS THE LENGTH TOO LONG?
         BH    EXIT36              YES, INVALID
         TITLE ' LOCATE RELEVANT SYMBOL NAME TABLE ELEMENT '
*
*  AT THIS STAGE:
*     R2 = SYMBOL NAME ADDRESS
*     R3 = SYMBOL NAME LENGTH
*     R4 = ADDRESS OF POINTER TO THE FIRST SYMBOL NAME TABLE
*
         LR    R15,R3              GET THE NAME LENGTH
         BCTR  R15,0               GET THE NAME LENGTH CODE
*
*         CHAIN TO THE NEXT SNTAB
*
         USING SNTAB,R4
LOCSNT   L     R4,SNTABNXT         POINT TO THE NEXT SNTAB
         LTR   R4,R4               DOES IT EXIST?
         BZ    LOCNTFND            NO, SYMBOL NOT FOUND
         LA    R5,SNTELFST         YES, POINT TO FIRST ELEMENT
*
*         LOOK AT THE SNTAB ELEMENT
*
         USING SNTELEM,R5
LOCSNTEL CH    R3,SNTLNG           SAME LENGTH AS NAME TO FIND?
         BNE   LNXTSNTE            NO, IT HAS A DIFFERENT LENGTH
         EX    R15,NAMECLC         DOES THE NAME MATCH?
         BE    LGOTSNTE            YES, FOUND IT
LNXTSNTE TM    SNTFLAGS,SNTLAST    LAST ELEMENT IN SNTAB?
         BO    LOCSNT              YES, GO GET THE NEXT SNTAB
         LH    R1,SNTLNG           NO, GET THE NAME'S LENGTH
         LA    R5,SNTDATA(R1)      POINT TO THE NEXT SNTAB ELEMENT
         B     LOCSNTEL            GO LOOK AT IT
         SPACE
NAMECLC  CLC   SNTDATA(0),0(R2)    <<< EXECUTED >>>
         SPACE
*
*         CHECK FOR A GLOBAL VARIABLE
*
LGOTSNTE ST    R5,SVLSNTE@         SAVE LOCAL SNTEL ADDRESS
         TM    SNTFLAG1,SNTGLOB    GLOBAL ELEMENT?
         BNO   HAVESNTE            NO, FOUND VARIABLE DETAILS
         BAL   R14,GLOCATE         YES, FIND THE GLOBAL SNTEL
         LTR   R15,R15             WAS IT FOUND?
         BNZ   LOCNTFND            NO, SYMBOL NOT FOUND
         L     R5,SVGSNTE@         POINT TO FOUND SNTEL ADDRESS
HAVESNTE L     R6,SNTVLPTR         POINT TO SYMBOL VALUE ELEMENT
*
*         DIVERGE AFTER SUCCESSFUL LOCATION IF UPDATE REQUEST
*
         CLI   ECODE1,EC$EUPDT     UPDATE/CREATE REQUEST?
         BE    UPDATE              YES
*
*         RETRIEVE VALUE FOR CALLER
*
         USING SVTELEM,R6
         LH    R0,SVTLNG           GET THE VALUE LENGTH
         LA    R1,SVTDATA          GET THE VALUE ADDRESS
         L     R2,PARM4            POINT TO VALUEPTR
         L     R3,PARM5            POINT TO VALUELEN
         ST    R1,0(,R2)           SET VALUEPTR
         ST    R0,0(,R3)           SET VALUELEN
         TM    SNTFLAGS,SNTLABEL   IS THIS SYMBOL A LABEL?
         BO    EXIT12              YES
         TM    SNTFLAGS,SNTNOSCN   NON-RESCANABLE SYMBOL?
         BO    EXIT04              YES
         TM    SNTFLAGS,SNTEVAL    EVALUATION REQUIRED?
         BO    EXIT08              YES
         B     EXIT00              RETURN WITH SUCCESS
         DROP  R5,R6               (SNTELEM, SVTELEM)
*
*         HANDLE UNDEFINED SYMBOL
*
LOCNTFND CLI   ECODE1,EC$NOIMP     RETRIEVE/NOCREATE REQUEST?
         BE    EXIT52              YES, UNDEFINED VARIABLE
         B     NEWVELEM            GO CREATE NEW VARIABLE
         TITLE ' UPDATE VARIABLE VALUE '
         USING SNTELEM,R5
         USING SVTELEM,R6
         USING EXECDATA,R7
UPDATE   L     R7,SVLCLED@         POINT TO LOCAL EXECDATA BLOCK
         C     R5,SVLSNTE@         CORRECT ONE?
         BE    UPDATE01            YES
         L     R7,SVGLBED@         NO, USE THE ONE FOR GLOBALS
UPDATE01 TM    SNTFLAGS,SNTNAUTH   SYSTEM/CONTROL VARIABLE?
         BO    EXIT16              YES, UPDATE NOT ALLOWED
         TM    SNTFLAGS,SNTLABEL   IS THIS SYMBOL A LABEL?
         BO    EXIT12              YES, UPDATE NOT ALLOWED
         LA    R2,SVTABFST         POINT TO FIRST SVTAB ADDRESS
         DROP  R5                  (SNTELEM)
*
*         SEARCH FOR SYMBOL VALUE TABLE IN WHICH SVTEL RESIDES
*
         USING SVTAB,R2
UPDLPSVT L     R2,SVTABNXT         POINT TO NEXT SVTAB
         LTR   R2,R2               IS THERE A NEXT ONE?
         BZ    EXIT40              NO, DATA CORRUPTION IT SEEMS
         CLR   R6,R2               IS ELEMENT ADDRESS LOWER?
         BNH   UPDLPSVT            YES, SO CAN'T BE IN THIS SVTAB
         L     R15,SVTABLNG        GET THE SIZE OF THIS SVTAB
         AR    R15,R2              POINT PAST THIS SVTAB
         CLR   R6,R15              IS THIS ALSO PAST THE ELEMENT?
         BNL   UPDLPSVT            NO, SO CAN'T BE IN THIS SVTAB
*
*         DETERMINE IF THE NEW DATA WILL FIT IN EXISTING SVTELEM
*
         L     R4,PARM4            POINT TO VALUEPTR
         L     R5,PARM5            POINT TO VALUELEN
         CLC   =F'32767',0(R5)     IS THE VALUE LENGTH VALID?
         BL    EXIT36              NO, REJECT THE OPERATION
         L     R4,0(,R4)           POINT TO VALUE
         L     R5,0(,R5)           LOAD VALUELEN
         CH    R5,SVTORIG          WILL IT FIT?
         BH    NEWVELEM            NO, NEED A NEW VALUE ELEMENT
*
*         UPDATE THE EXISTING VALUE ELEMENT
*
         LH    R0,SVTLNG           GET THE OLD LENGTH
         SR    R0,R5               SUBTRACT THE NEW LENGTH
         A     R0,SVTABFRE         GET NEW SNTAB "GAS" TOTAL
         ST    R0,SVTABFRE         SAVE IT
         LA    R0,SVTDATA          GET THE TARGET ADDRESS
         LH    R1,SVTORIG          GET THE TARGET LENGTH
         STH   R5,SVTLNG           SET THE NEW VALUE LENGTH
         MVCL  R0,R4               UPDATE THE DATA (WITH NUL PAD)
         B     EXIT00              VARIABLE SUCCESSFULLY UPDATED
*
*         UPDATE THE SYMBOL VALUE - CREATING IT IF NECESSARY
*
NEWVELEM LM    R2,R5,PARM2         POINT TO UPDATE PLIST ITEMS
         MVC   LCVALPTR,0(R2)      SUPPLY LOCATE VALUE ADDRESS
         MVC   LCVALLEN,0(R3)         AND THE ADDRESS OF ITS LENGTH
         MVC   UPVALPTR,0(R4)      SUPPLY UPDATE VALUE ADDRESS
         MVC   UPVALLEN,0(R5)         AND THE ADDRESS OF ITS LENGTH
         LA    R1,UPDTPL           POINT TO PARAMETER LIST
         L     R15,=V(IKJINIT)     POINT TO ROUTINE ENTRY POINT
         BALR  R14,R15             UPDATE VARIABLE
         CH    R15,=H'300'         PROTECTED VARIABLE?
         BE    EXIT16              YES, REPORT WITH RC=16
         CH    R15,=H'16'          VIRTUAL STORAGE PROBLEM?
         BE    EXIT32              YES, REPORT WITH RC=32
         CH    R15,=H'940'         IS NAME TOO LONG?
         BE    EXIT36              YES, REPORT WITH RC=36
         CH    R15,=H'904'         WAS NAME NOT FOUND?
         BE    EXIT52              YES, REPORT WITH RC=52
         LTR   R15,R15             ANY OTHER PROBLEM?
         BNZ   SETRC               YES, FEED BACK THE CODE
         CLI   ECODE1,EC$ERETR     RETRIEVE/CREATE REQUEST?
         BE    REDRIVE             YES, GO REDRIVE THE REQUEST
         B     EXIT00              VARIABLE SUCCESSFULLY UPDATED
         TITLE ' LOCATE GLOBAL VARIABLE '
*
*  A LOCAL VARIABLE SYMBOL NAME TABLE ELEMENT OF INTEREST HAS BEEN
*  FOUND, BUT IT HAS BEEN DISCOVERED TO BE A GLOBAL VARIABLE.  NOW
*  IN ORDER TO ASCERTAIN ITS VALUE, ITS GLOBAL NAME MUST BE LOCATED
*  IN THE SYNBOL NAME TABLE.  THE GLOBAL NAME RETRIEVED FROM THE
*  FIRST 4 BYTES OF THE LOCAL SNT ELEMENT MUST BE SEARCHED FOR IN
*  THE ORIGINAL OR OUTER-MOST SNT CHAIN OF A NESTED CLIST EXECUTION
*  ENVIRONMENT.  IN PRACTICE, THE GLOBAL VARIABLE "NAMES" ARE SIMPLY
*  FULLWORD VALUES OF THE GLOBAL VARIABLE SEQUENTIAL NUMBER.
*
*  ON ENTRY:
*     SVLSNTE@ POINTS TO THE LOCAL SNT ELEMENT WITH SNTGLOB SET.
*
*  ON EXIT:
*     R15 = 0  =>  SVGSNTE@ POINTS TO THE GLOBAL SNT ELEMENT.
*     R15 = 4  =>  THE GLOBAL VARIABLE COULD NOT BE FOUND.
*
         SPACE
GLOCATE  STM   R14,R12,12(R13)     SAVE REGISTERS
         L     R5,SVLSNTE@         POINT TO LOCAL SNTEL
         USING SNTELEM,R5
         XC    SVGSNTE@,SVGSNTE@   RESET GLOBAL SNTEL ADDRESS
         L     R6,SNTGVAL          GET GLOBAL VARIABLE "NAME"
         L     R7,SVGLBED@         POINT TO GLOBAL EXECDATA BLOCK
         USING EXECDATA,R7
         LA    R4,SNTABFST         POINT TO FIRST SNTAB ADDRESS
         DROP  R7                  (EXECDATA)
*
*         CHAIN TO THE NEXT SNTAB
*
         USING SNTAB,R4
GLBSNT   L     R4,SNTABNXT         POINT TO THE NEXT SNTAB
         LTR   R4,R4               DOES IT EXIST?
         BZ    GLBNTFND            NO, SYMBOL NOT FOUND
         LA    R5,SNTELFST         YES, POINT TO FIRST ELEMENT
*
*         LOOK AT THE SNTAB ELEMENT
*
GLBSNTEL CLC   =H'4',SNTLNG        SAME LENGTH AS NAME TO FIND?
         BNE   GNXTSNTE            NO, IT HAS A DIFFERENT LENGTH
         CLM   R6,15,SNTDATA       DOES THE "NAME" MATCH?
         BE    GGOTSNTE            YES, FOUND IT
GNXTSNTE TM    SNTFLAGS,SNTLAST    LAST ELEMENT IN SNTAB?
         BO    GLBSNT              YES, GO GET THE NEXT SNTAB
         LH    R1,SNTLNG           NO, GET THE NAME'S LENGTH
         LA    R5,SNTDATA(R1)      POINT TO THE NEXT SNTAB ELEMENT
         B     GLBSNTEL            GO LOOK AT IT
         DROP  R4,R5               (SNTAB, SNTELEM)
*
*         RETURN AFTER FINDING THE GLOBAL VARIABLE
*
GGOTSNTE ST    R5,SVGSNTE@         SAVE GLOBAL VARIABLE SNTEL ADDRESS
         LM    R14,R12,12(R13)     RESTORE REGISTERS
         SLR   R15,R15             SET RC=0
         BR    R14                 RETURN TO CALLER
*
*         RETURN AFTER NOT FINDING THE GLOBAL VARIABLE
*
GLBNTFND LM    R14,R12,12(R13)     RESTORE REGISTERS
         LA    R15,4               SET RC=4
         BR    R14                 RETURN TO CALLER
         TITLE ' RETRIEVE EACH SYMBOL IN TURN '
*
*  AT THIS STAGE:
*     R4 = ADDRESS OF POINTER TO THE FIRST SYMBOL NAME TABLE
*
ALLLOCAT L     R6,PARM6            POINT TO THE TOKEN
         ICM   R7,15,0(R6)         GET THE TOKEN
*
*         CHAIN TO THE NEXT SNTAB
*
         USING SNTAB,R4
ALLSNT   L     R4,SNTABNXT         POINT TO THE NEXT SNTAB
         LTR   R4,R4               DOES IT EXIST?
         BZ    ALLNTFND            NO, END OF SNTAB CHAIN
         LA    R5,SNTELFST         YES, POINT TO FIRST ELEMENT
*
*         LOOK AT THE SNTAB ELEMENT
*
         USING SNTELEM,R5
ALLSNTEL LTR   R7,R7               RETRIEVE THIS SYMBOL?
         BZ    ALLLOCOK            YES
         CLR   R5,R7               FOUND SYMBOL FROM LAST TIME?
         BNE   ALLLNEXT            NO, KEEP LOOKING
         SR    R7,R7
ALLLNEXT TM    SNTFLAGS,SNTLAST    LAST ELEMENT IN SNTAB?
         BO    ALLSNT              YES, GO GET THE NEXT SNTAB
         LH    R1,SNTLNG           NO, GET THE NAME'S LENGTH
         LA    R5,SNTDATA(R1)      POINT TO THE NEXT SNTAB ELEMENT
         B     ALLSNTEL            GO LOOK AT IT
*
*         RETRIEVE SYMBOL NAME DETAILS FOR CALLER
*
ALLLOCOK L     R2,PARM2            POINT TO NAMEPTR
         L     R3,PARM3            POINT TO NAMELEN
         LH    R0,SNTLNG           GET THE SYMBOL NAME LENGTH
         LA    R1,SNTDATA          GET THE SYMBOL NAME ADDRESS
         CLI   SNTLNG+1,4          GLOBAL VARIABLE KEY NAME LENGTH?
         BNE   ALLLNOTG            NO, NOT GLOBAL VARIABLE VALUE ENTRY
         CLI   0(R1),C'$'          GLOBAL VARIABLE VALUE ENTRY?
         BL    ALLLNEXT            YES, DO NOT RETURN IT
ALLLNOTG ST    R5,0(,R6)           UPDATE THE TOKEN FOR NEXT TIME
         ST    R0,0(,R3)           UPDATE NAMELEN
         ST    R1,0(,R2)           UPDATE NAMEPTR
*
*         RETRIEVE SYMBOL VALUE DETAILS FOR CALLER
*
         ST    R5,SVLSNTE@         SAVE LOCAL SNTEL ADDRESS
         L     R2,PARM4            POINT TO VALUEPTR
         L     R3,PARM5            POINT TO VALUELEN
         ST    R7,0(,R2)           RESET VALUEPTR
         ST    R7,0(,R3)           RESET VALUELEN
         TM    SNTFLAG1,SNTGLOB    GLOBAL ELEMENT?
         BNO   ALLLRITE            NO, FOUND VARIABLE DETAILS
         BAL   R14,GLOCATE         YES, FIND THE GLOBAL SNTEL
         LTR   R15,R15             WAS IT FOUND?
         BNZ   EXIT52              NO, BIG TROUBLE SOMEWHERE
         L     R5,SVGSNTE@         POINT TO FOUND SNTEL ADDRESS
ALLLRITE L     R6,SNTVLPTR         POINT TO SYMBOL VALUE ELEMENT
         USING SVTELEM,R6
         LH    R0,SVTLNG           GET THE VALUE LENGTH
         LA    R1,SVTDATA          GET THE VALUE ADDRESS
         ST    R1,0(,R2)           SET VALUEPTR
         ST    R0,0(,R3)           SET VALUELEN
         TM    SNTFLAGS,SNTLABEL   IS THIS SYMBOL A LABEL?
         BO    EXIT12              YES
         TM    SNTFLAGS,SNTNOSCN   NON-RESCANABLE SYMBOL?
         BO    EXIT04              YES
         TM    SNTFLAGS,SNTEVAL    EVALUATION REQUIRED?
         BO    EXIT08              YES
         B     EXIT00              RETURN WITH SUCCESS
         DROP  R4,R5,R6            (SNTAB, SNTELEM, SVTELEM)
*
*         HANDLE REACHING THE END OF THE SNTAB CHAIN
*
ALLNTFND LTR   R7,R7               RETURNING VERY NEXT SYMBOL?
         BNZ   EXIT40              NO, CORRUPT TOKEN (BAD PLIST)
         LM    R2,R5,PARM2         POINT TO NAME/VALUE DESCRIPTORS
         ST    R7,0(,R2)           RESET NAMEPTR
         ST    R7,0(,R3)           RESET NAMELEN
         ST    R7,0(,R4)           RESET VALUEPTR
         ST    R7,0(,R5)           RESET VALUELEN
         B     EXIT20              NO MORE VARIABLES TO RETURN
         TITLE ' TERMINATION AND EXIT '
*
*         REQUEST TERMINATION
*
EXIT52   LA    R15,52              RC=52 - UNDEFINED VARIABLE
         B     SETRC
EXIT40   LA    R15,40              RC=40 - BAD ENVIRONMENT OR PLIST
         B     SETRC
EXIT36   LA    R15,36              RC=36 - INVALID NAME LENGTH
         B     SETRC
EXIT32   LA    R15,32              RC=32 - GETMAIN/FREEMAIN ERROR
         B     SETRC
****24   LA    R15,24              RC=24 - SYMBOL IS A PROCEDURE NAME
****     B     SETRC
EXIT20   LA    R15,20              RC=20 - NO MORE VARIABLES TO RETURN
         B     SETRC
EXIT16   LA    R15,16              RC=16 - CANNOT UPDATE SYSTEM SYMBOL
         B     SETRC
EXIT12   LA    R15,12              RC=12 - SYMBOL IS A LABEL
         B     SETRC
EXIT08   LA    R15,08              RC=08 - SYMBOL REQUIRES EVALUATION
         B     SETRC
EXIT04   LA    R15,04              RC=04 - SYMBOL MUST NOT BE RESCANNED
         B     SETRC
EXIT00   SR    R15,R15             RC=00 - SUCCESS
SETRC    ICM   R0,15,GPR15RC       HAD A PREVIOUS NON-ZERO RETURN CODE?
         BNZ   RCSET               YES, DO NOT OVERLAY IT
         ST    R15,GPR15RC         NO, CLEAR TO SET RETURN CODE NOW
RCSET    ICM   R8,15,PARM8         POINT TO SUPPLIED RETCODE AREA
         BZ    NEXTRQST            THERE IS NONE SO ON TO NEXT REQUEST
         ST    R15,0(,R8)          SET RETURN CODE FOR THIS REQUEST
         B     NEXTRQST            ON TO NEXT REQUEST
*
*         INVOCATION TERMINATION
*
FINISHUP L     R2,GPR15RC          PRESERVE PROGRAM RETURN CODE
         ST    R2,LOCALID          FLAG AREA NOW INACTIVE
         LR    R1,R13              POINT TO WORKING STORAGE
         LA    R0,$WKSIZE          GET WORKING STORAGE SIZE
         L     R13,4(,R13)         POINT TO CALLER'S SAVE AREA
         FREEMAIN RU,LV=(0),A=(1)  FREE WORKING STORAGE
         L     R14,12(,R13)        RESTORE RETURN ADDRESS
         LR    R15,R2              SET PROGRAM RETURN CODE
         LM    R0,R12,20(R13)      RESTORE REMAINING REGISTERS
         BR    R14                 RETURN TO CALLER
         DROP  R12,R13             (IKJCT441, WORKAREA)
         TITLE ' CONSTANTS AND LITERALS '
         LTORG
         DC    0D'0'               END OF CSECT
         DROP  0                   (PSA)
         SPACE
         TITLE ' WORKING STORAGE '
WORKAREA DSECT
         DS    18F                 REGISTER SAVE AREA
         SPACE
LOCALID  DS    CL8                 STORAGE AREA IDENTIFIER
         SPACE
PARMLIST DS    0F                  PARAMETER LIST SAVE AREA
PARM1    DS    F                   POINTER TO SUPPLIED ECODE
PARM2    DS    F                   POINTER TO SUPPLIED NAMEPTR
PARM3    DS    F                   POINTER TO SUPPLIED NAMELEN
PARM4    DS    F                   POINTER TO SUPPLIED VALUEPTR
PARM5    DS    F                   POINTER TO SUPPLIED VALUELEN
PARM6    DS    F                   POINTER TO SUPPLIED TOKEN
PARM7    DS    F                   POINTER TO SUPPLIED ECTPARM
PARM8    DS    F                   POINTER TO SUPPLIED RETCODE
PARM9    DS    F                   POINTER TO SUPPLIED NEXTLIST
$PRMSIZE EQU   *-PARMLIST          MAXIMUM SIZE OF PARAMETER LIST
         SPACE
ECODE    DS    F                   LOCAL COPY OF ENTRY CODE
ECODE1   EQU   ECODE+3,1           LOW-ORDER ENTRY CODE BYTE
         SPACE
EC$ERETR EQU   1                   RETRIEVE/CREATE REQUEST
EC$EUPDT EQU   2                   UPDATE/CREATE REQUEST
EC$ELOC  EQU   3                   LOCATE ALL REQUEST
EC$NOIMP EQU   18                  RETRIEVE/NOCREATE REQUEST
         SPACE
GPR15RC  DS    F                   RETURN CODE VALUE FOR GPR15
         SPACE
SVLCLED@ DS    A                   LOCAL EXECDATA ADDRESS SAVE AREA
SVGLBED@ DS    A                   GLOBAL EXECDATA ADDRESS SAVE AREA
SVLSNTE@ DS    A                   LOCAL SNTEL ADDRESS SAVE AREA
SVGSNTE@ DS    A                   GLOBAL SNTEL ADDRESS SAVE AREA
         SPACE
UPDTPL   DS    0F                  IKJINIT / IKJUPDT  PARAMETER  LIST
UPT@     DS    A                   UPT ADDRESS
ECT@     DS    A                   ECT ADDRESS
ECB@     DS    A                   ECB ADDRESS
UPLIST@  DS    A                   UPDATE PARAMETER LIST ADDRESS
         SPACE
ECBAREA  DS    F                   ECB
         SPACE
UPLIST   EQU   *,16                UPDATE PARAMETER LIST
LCVALPTR DS    A                   -> LOCATE VALUE
LCVALLEN DS    A                   -> LOCATE VALUE LENGTH (FULLWORD)
UPVALPTR DS    A                   -> UPDATE VALUE
UPVALLEN DS    A                   -> UPDATE VALUE LENGTH (FULLWORD)
         SPACE
WORKEND  DS    0D                  END OF DSECT
$WKSIZE  EQU   WORKEND-WORKAREA
         SPACE
         END   IKJCT441
/*
//*
//STEP03  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
  IDENTIFY IKJCT441('ZP60038')
++MACUPD(SGIKJ441) DISTLIB(AGENLIB).
./ CHANGE NAME=SGIKJ441
.* CHANGES = ZP60038 ADD IKJCT441 CLIST SYMBOL API TO IKJPTGT  @ZP60038 00096900
         PUNCH '    ORDER IKJCT436,IKJCT441 '                  @ZP60038 00770000
         PUNCH '    INCLUDE AOST4(IKJRBBMC,IKJCT441)'          @ZP60038 00807000
         PUNCH '    ALIAS IKJGETL,IKJPUTL,IKJSTCK,IKJCT441'    @ZP60038 00830000
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP04  EXEC SMPREC,WORK='SYSALLDA'
//SMPPTFIN DD  DSN=&&SMPMCS,DISP=(OLD,DELETE)
//SMPCNTL  DD  *
  RECEIVE
          SELECT(ZP60038)
          .
/*
//*
//STEP05CK EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60038)
        CHECK
        .
/*
//*
//STEP05  EXEC SMPAPP,COND=(0,NE),WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60038)
        DIS(WRITE)
        .
//*
//
//ZP60039  JOB (SYSGEN),'J04 M50/51: ZP60039',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*  ADD TEXT= OPERAND SUPPORT TO WTO AND WTOR
//*
//STEP01  EXEC PGM=IEBUPDTE,PARM='NEW'
//SYSPRINT DD  SYSOUT=*
//SYSUT2   DD  DSN=&&MACLIB,DISP=(NEW,PASS),
//             UNIT=SYSALLDA,SPACE=(CYL,(1,1,10)),
//             DCB=(DSORG=PO,RECFM=FB,LRECL=80,BLKSIZE=6160)
//SYSIN    DD  *
./ ADD NAME=IEZWPL
         MACRO                                                          00001000
         IEZWPL &DSECT=YES                                              00002000
*                                                                       00003000
*/********************************************************************/ 00004000
*/*                                                                  */ 00005000
*/*      WTO/WTOR/WTOR31/MLWTO/XWPL/WTP PARAMETER LIST DEFINITION    */ 00006000
*/*                                                                  */ 00007000
*/*      STATUS -                                                    */ 00008000
*/*      LASTUPD         = EBB1102  TYPE=ADD                         */ 00009000
*/*      LIBRARIES       = DISTLIB=AMODGEN                           */ 00010000
*/*      FMID            = FBB1221                                   */ 00011000
*/*      RMID            = FBB1221                                   */ 00012000
*/*      SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS    */ 00013000
*/*                        EBB1102  FUNCTION  00.000  MAC  ACC RGN   */ 00014000
*/*                        FBB1221  FUNCTION  00.000  MAC  ACC RGN   */ 00015000
*/*                                                                  */ 00016000
*/*      MACRO IEZWPL HAS BEEN UPDATED TO PROVIDE MAPPING FOR:       */ 00017000
*/*       - WTOR 31 BIT PARAMETER LIST                               */ 00018000
*/*       - EXTENDED WPL PARAMETER LIST                              */ 00019000
*/*      THIS UPDATED MACRO MUST BE USED TO ASSEMBLE USERMODS        */ 00020000
*/*      ZP60039 AND ZP60040 THAT PROVIDE WTO[R] TEXT= SUPPORT       */ 00021000
*/*                                                                  */ 00022000
*/*      METHOD OF ACCESS                                            */ 00023000
*/*      BAL  - DSECT IS PRODUCED UNLESS DSECT=NO IS SPECIFIED.      */ 00024000
*/*             USING ON WPLRF GIVES ADDRESSABILITY FOR ALL SYMBOLS  */ 00025000
*/*      PL/S - DCL WPLPTR PTR                                       */ 00026000
*/*                                                                  */ 00027000
*/* **************************************************************** */ 00028000
*                                                                       00029000
         IEZBITS  ,           SYMBOLIC BIT DEFINITIONS                  00030000
*                                                                       00031000
*********************************************************************** 00032000
*                                                                     * 00033000
*        WTOR PREFIX                                                  * 00034000
*                                                                     * 00035000
*********************************************************************** 00036000
*                                                                       00037000
         AIF   ('&DSECT' EQ 'NO').WPL0000                               00038000
WPLRF    DSECT ,              START OF WTOR PREFIX                      00039000
         AGO   .WPL0020                                                 00040000
.WPL0000 ANOP                                                           00041000
         DS    0D                                                       00042000
WPLRF    EQU   *              START OF WTOR PREFIX                      00043000
.WPL0020 ANOP                                                           00044000
WPLRPTR  DS    0A             POINTER TO REPLY BUFFER                   00045000
WPLRLN   DS    FL1            MAXIMUM LENGTH OF REPLY                   00046000
WPLRPTRA DS    AL3            ADDRESS OF REPLY BUFFER                   00047000
WPLRECB  DS    A              ADDRESS OF REPLY ECB                      00048000
*                                                                       00049000
*********************************************************************** 00050000
*                                                                     * 00051000
*        WTOR PREFIX (31-BIT PARAMETER LIST)                          * 00052000
*                                                                     * 00053000
*********************************************************************** 00054000
*                                                                       00055000
         ORG   WPLRF                                                    00056000
WPL31RF  EQU   *              START OF WTOR PREFIX (31-BIT PARM LIST)   00057000
WPL31RRP DS    A              ADDRESS OF REPLY BUFFER                   00058000
WPL31RFG EQU   X'80'          INDICATES A WTOR                          00059000
WPL31REP DS    A              ADDRESS OF REPLY ECB                      00060000
*                                                                       00061000
*********************************************************************** 00062000
*                                                                     * 00063000
*        COMMON SECTION                                               * 00064000
*                                                                     * 00065000
*********************************************************************** 00066000
*                                                                       00067000
         ORG   WPLRF                                                    00068000
WPL      EQU   *              START OF COMMON SECTION                   00069000
WPLLGH   DS    0H             MESSAGE LENGTH (COMBINED LENGTH OF        00070000
*                             MESSAGE TEXT, MESSAGE LENGTH FIELD,       00071000
*                             AND MCS FLAGS FIELD) FOR 24 BIT WPL       00072000
WPL31RLN DS    FL1            WTOR 31 BIT PARMLIST ONLY, L'REPLY BUFFER 00073000
*                             ZERO FOR ALL OTHER WPL FORMATS            00074000
WPLLPTXT DS    FL1            MESSAGE LENGTH (COMBINED LENGTH OF MSG    00075000
*                             TEXT, MSG LENGTH FIELD AND MCS FLAGS      00076000
WPLMCSF  DS    0BL2           MCS FLAGS                                 00077000
WPLMCSF1 DS    B              FIRST BYTE OF MCS FLAGS                   00078000
WPLMCSFA EQU   BIT0           ROUTE/DESCRIPTOR CODE FIELDS PRESENT      00079000
WPLMCSFB EQU   BIT1           QUEUE TO CONSOLE IF ACTIVE (ID IN R0)     00080000
WPLMCSFC EQU   BIT2           COMMAND RESPONSE                          00081000
WPLMCSFD EQU   BIT3           MESSAGE TYPE FIELD EXISTS                 00082000
WPLMCSFE EQU   BIT4           THIS WPL IS A REPLY TO A WTOR             00083000
WPLMCSFF EQU   BIT5           BROADCAST THIS MSG TO ALL ACTIVE          00084000
*                             CONSOLES                                  00085000
WPLMCSFG EQU   BIT6           QUEUE TO HARD COPY ONLY                   00086000
WPLMCSFH EQU   BIT7           QUEUE UNCONDITIONALLY TO CONSOLE (ID IN   00087000
*                             REG 0)                                    00088000
WPLMCSF2 DS    B              SECOND BYTE OF MCS FLAGS                  00089000
WPLMCSFI EQU   BIT0           DO NOT TIME STAMP THIS MESSAGE            00090000
WPLMCSFJ EQU   BIT1           MLWTO INDICATOR                           00091000
WPLMCSFK EQU   BIT2           THE TEXT IN THIS WPL IS TO BE             00092000
*                             ROUTED TO THE JOB'S PRINTER ONLY          00093000
*                             (OS/VS1 ONLY)                             00094000
WPLMCSFL EQU   BIT3           EXTENDED WPL FORMAT (WPX) EXISTS          00095000
*                             WAS WPLNOWTP SUPPRESS WTP (OS/VS1 ONLY)   00096000
WPLMCSFM EQU   BIT4           THE MESSAGE IS AN OPERATOR COMMAND        00097000
WPLMCSFN EQU   BIT5           BYPASS QUEUING MESSAGE TO HARD COPY       00098000
WPLRSV04 EQU   BIT6           RESERVED                                  00099000
WPLRSV05 EQU   BIT7           RESERVED                                  00100000
*                                                                       00101000
WPLTXT   DS    0CL126         MESSAGE TEXT (MAXIMUM 126 CHARACTERS)     00102000
         DS    CL125          MESSAGE TEXT                              00103000
WPLTXTL  DS    C              LAST BYTE OF MESSAGE TEXT                 00104000
*                                                                       00105000
*        THE FOLLOWING FIELDS BEGIN IMMEDIATELY FOLLOWING THE           00106000
*        LAST BYTE OF MESSAGE TEXT                                      00107000
*                                                                       00108000
         ORG   WPLRF                                                    00109000
*                                                                       00110000
WPLFLGS  EQU   *              START OF WPL FLAGS FIELDS                 00111000
WPLDESC  DS    0BL2           DESCRIPTOR CODES                          00112000
WPLDESC1 DS    B              FIRST BYTE OF DESCRIPTOR CODES            00113000
WPLDESCA EQU   BIT0           SYSTEM FAILURE MESSAGE                    00114000
WPLDESCB EQU   BIT1           IMMEDIATE ACTION REQUIRED MESSAGE         00115000
WPLDESCC EQU   BIT2           EVENTUAL ACTION REQUIRED MESSAGE          00116000
WPLDESCD EQU   BIT3           SYSTEM STATUS MESSAGE                     00117000
WPLDESCE EQU   BIT4           IMMEDIATE COMMAND RESPONSE MESSAGE        00118000
WPLDESCF EQU   BIT5           JOB STATUS MESSAGE                        00119000
WPLDESCG EQU   BIT6           APPLICATION PROGRAM/PROCESSOR MESSAGE     00120000
WPLDESCH EQU   BIT7           OUT-OF-LINE MESSAGE                       00121000
WPLDESC2 DS    B              SECOND BYTE OF DESCRIPTOR CODES           00122000
WPLDESCI EQU   BIT0           DESCRIPTOR CODE 9                         00123000
WPLDESCJ EQU   BIT1           DESCRIPTOR CODE 10 (OS/VS2)               00124000
WPLDESCK EQU   BIT2           CRITICAL EVENTUAL ACTION MESSAGE -        00125000
*                             DESCRIPTOR CODE 11                        00126000
WPLRSV08 EQU   BIT3           RESERVED                                  00127000
WPLRSV09 EQU   BIT4           RESERVED                                  00128000
WPLRSV10 EQU   BIT5           RESERVED                                  00129000
WPLRSV11 EQU   BIT6           RESERVED                                  00130000
WPLRSV12 EQU   BIT7           RESERVED                                  00131000
*                                                                       00132000
*        ROUTING CODES                                                  00133000
*        THESE CODES INDICATE THE FUNCTIONAL AREA OR AREAS TO           00134000
*        WHICH A MESSAGE IS TO BE SENT                                  00135000
*                                                                       00136000
WPLROUT  DS    0BL2           ROUTING CODES                             00137000
WPLROUT1 DS    B              1ST BYTE OF ROUTING CODES                 00138000
WPLROUTA EQU   BIT0           MASTER CONSOLE                            00139000
WPLROUTB EQU   BIT1           MASTER CONSOLE INFORMATIONAL              00140000
WPLROUTC EQU   BIT2           TAPE POOL                                 00141000
WPLROUTD EQU   BIT3           DIRECT ACCESS POOL                        00142000
WPLROUTE EQU   BIT4           TAPE LIBRARY                              00143000
WPLROUTF EQU   BIT5           DISK LIBRARY                              00144000
WPLROUTG EQU   BIT6           UNIT RECORD POOL                          00145000
WPLROUTH EQU   BIT7           TELEPROCESSING CONTROL                    00146000
WPLROUT2 DS    B              2ND BYTE OF ROUTING CODES                 00147000
WPLROUTI EQU   BIT0           SYSTEM SECURITY                           00148000
WPLROUTJ EQU   BIT1           SYSTEM/ERROR MAINTENANCE                  00149000
WPLROUTK EQU   BIT2           PROGRAMMER INFORMATION                    00150000
WPLROUTL EQU   BIT3           EMULATOR INFORMATION                      00151000
WPLROUTM EQU   BIT4           USER ROUTING CODE                         00152000
WPLROUTN EQU   BIT5           USER ROUTING CODE                         00153000
WPLROUTO EQU   BIT6           USER ROUTING CODE                         00154000
WPLRSV13 EQU   BIT7           RESERVED                                  00155000
*                                                                       00156000
WPLMSGTY DS    0BL2           MESSAGE TYPE FLAGS                        00157000
WPLMSGT1 DS    B              FIRST BYTE OF MESSAGE TYPE FLAGS          00158000
WPLMSGTA EQU   BIT0           DISPLAY JOBNAMES                          00159000
WPLMSGTB EQU   BIT1           DISPLAY STATUS                            00160000
WPLMSGTC EQU   BIT2           MONITOR ACTIVE (OS/VS1)                   00161000
WPLMSGTD EQU   BIT3           INDICATES EXISTENCE OF QID FIELD IN       00162000
*                             WPL (OS/VS1 ONLY)                         00163000
WPLRSV14 EQU   BIT4           RESERVED                                  00164000
WPLMSGTF EQU   BIT5           MONITOR SESS                              00165000
WPLRSV15 EQU   BIT6           RESERVED                                  00166000
WPLRSV16 EQU   BIT7           RESERVED                                  00167000
WPLMSGT2 DS    B              SECOND BYTE OF MESSAGE TYPE FLAGS         00168000
WPLRSV25 EQU   BIT0           RESERVED                                  00169000
WPLRSV26 EQU   BIT1           RESERVED                                  00170000
WPLRSV27 EQU   BIT2           RESERVED                                  00171000
WPLRSV28 EQU   BIT3           RESERVED                                  00172000
WPLRSV29 EQU   BIT4           RESERVED                                  00173000
WPLRSV30 EQU   BIT5           RESERVED                                  00174000
WPLRSV31 EQU   BIT6           RESERVED                                  00175000
WPLRSV32 EQU   BIT7           RESERVED                                  00176000
WPLQID   DS    H              STATION IDENTIFICATION FOR RES SUPPORT    00177000
*                             (OS/VS1 ONLY)                             00178000
*                                                                       00179000
*********************************************************************** 00180000
*                                                                     * 00181000
*        MLWTO EXTENSION                                              * 00182000
*                                                                     * 00183000
*********************************************************************** 00184000
*                                                                       00185000
*        THE FOLLOWING FIELDS ARE ALWAYS PRESENT WHEN MLWTO             00186000
*        IS SPECIFIED                                                   00187000
*                                                                       00188000
         ORG   WPLRF                                                    00189000
*                                                                       00190000
WPLLTF   DS    0BL2           LINE TYPE FLAGS FOR WPLTXT                00191000
WPLLTF1  DS    B              1ST BYTE OF WPLTXT LINE TYPE FLAGS        00192000
WPLLTFA  EQU   BIT0           CONTROL LINE                              00193000
WPLLTFB  EQU   BIT1           LABEL LINE                                00194000
WPLLTFC  EQU   BIT2           DATA LINE                                 00195000
WPLLTFD  EQU   BIT3           END LINE                                  00196000
WPLRSV17 EQU   BIT4           RESERVED                                  00197000
WPLRSV18 EQU   BIT5           RESERVED                                  00198000
WPLRSV19 EQU   BIT6           RESERVED                                  00199000
WPLRSV20 EQU   BIT7           RESERVED                                  00200000
WPLLTF2  DS    B              2ND BYTE OF WPLTXT LINE TYPE FLAGS        00201000
WPLAREA  DS    C              AREA IDENTIFICATION                       00202000
WPLLINES DS    FL1            NUMBER OF LINES (1 + NUMBER OF WPLMLTXT   00203000
*                             LINES)                                    00204000
*                                                                       00205000
*        THE FOLLOWING FIELDS ARE OPTIONAL FOR MLWTO                    00206000
*        THEY REPRESENT A MAPPING OF THE ENTRIES DESCRIBING THE         00207000
*        MINOR MESSAGE TEXT LINES CREATED IN ADDITION TO THE            00208000
*        MAJOR WPLTXT MESSAGE TEXT LINE                                 00209000
*                                                                       00210000
         ORG   WPLRF                                                    00211000
*                                                                       00212000
WPLML    EQU   *              START OF ADDITIONAL MLWTO LINE ENTRY      00213000
WPLML0   DS    FL1            ALWAYS ZERO                               00214000
WPLMLLEN DS    FL1            MESSAGE LENGTH FOR THIS LINE (LENGTH OF   00215000
*                             MESSAGE TEXT + 4)                         00216000
WPLMLLTF DS    0BL2           TYPE FLAGS FOR THIS LINE (WPLMLTXT)       00217000
WPLMLLT1 DS    B              1ST BYTE OF LINE TYPE FLAGS FOR           00218000
*                             WPLMLTXT                                  00219000
WPLMLLTA EQU   BIT0           CONTROL LINE                              00220000
WPLMLLTB EQU   BIT1           LABEL LINE                                00221000
WPLMLLTC EQU   BIT2           DATA LINE                                 00222000
WPLMLLTD EQU   BIT3           END LINE                                  00223000
WPLRSV21 EQU   BIT4           RESERVED                                  00224000
WPLRSV22 EQU   BIT5           RESERVED                                  00225000
WPLRSV23 EQU   BIT6           RESERVED                                  00226000
WPLRSV24 EQU   BIT7           RESERVED                                  00227000
WPLMLLT2 DS    B              2ND BYTE OF LINE TYPE FLAGS FOR           00228000
*                             WPLMLTXT                                  00229000
WPLMLTXT DS    CL126          MESSAGE TEXT FOR THIS LINE (MAXIMUM 126   00230000
*                             CHARACTERS)                               00231000
*********************************************************************** 00232000
*                                                                       00233000
*        XWPL FIELDS                                                    00234000
*        AN XWPL IS INDICATED BY THE MCS FLAG WPLMCSFL                  00235000
*                                                                       00236000
*********************************************************************** 00237000
*                                                                       00238000
         ORG   WPLRF                                                    00239000
*                                                                       00240000
WPX      EQU   *              START OF WPL EXTENSION                    00241000
WPXVRSN  DS    AL1            VERSION LEVEL                             00242000
WPXFLAGS DS    X              FLAGS, RESERVED                           00243000
WPXRPYLN DS    AL1            LENGTH OF REPLY BUFFER                    00244000
WPXLNGTH DS    AL1            LENGTH OF WPX (ZERO FOR VER 1)            00245000
*********************************************************************** 00246000
*                                                                       00247000
*        EXTENDED MCS FLAGS                                             00248000
*                                                                       00249000
*********************************************************************** 00250000
WPXMCSF1 DS    0XL2                                                     00251000
WPXMCS1  DS    X              FIRST BYTE OF EXTENDED MCS FLAGS          00252000
WPXRSV68 EQU   BIT0           RESERVED                                  00253000
WPXCONS  EQU   BIT1           FOUR BYTE CONSOLE ID WAS SPECIFIED        00254000
WPXRSV71 EQU   BIT2           RESERVED                                  00255000
WPXCONN  EQU   BIT3           CONNECT ID WAS SPECIFIED                  00256000
WPXWTOR  EQU   BIT4           WTOR WITH EXTENDED PARM LIST              00257000
WPXRSV72 EQU   BIT5           RESERVED                                  00258000
WPXCNM   EQU   BIT6           CONSOLE NAME WAS SPECIFIED                00259000
WPXMCS2  DS    X              2ND BYTE OF EXTENDED MCS FLAGS            00260000
WPXTXTAD EQU   BIT0           TEXT ADDRESS WAS SPECIFIED                00261000
WPXRSV1A EQU   BIT1           RESERVED                                  00262000
WPXRSV48 EQU   BIT2           RESERVED                                  00263000
WPXRSV49 EQU   BIT3           RESERVED                                  00264000
WPXRSV50 EQU   BIT4           RESERVED                                  00265000
WPXSYNC  EQU   BIT5           PROCESS SYNCHRONOUS                       00266000
WPXRSV51 EQU   BIT6           RESERVED                                  00267000
WPXRSV52 EQU   BIT7           RESERVED                                  00268000
WPXCPFLG DS    0XL2           FLAGS FOR CONTROL PROGRAM USE ONLY        00269000
*                                                                       00270000
WPXCPFL1 DS    X              FLAGS FOR CONTROL PROGRAM USE BYTE 1      00271000
WPXRROK  EQU   BIT0                                                     00272000
WPXNOHO  EQU   BIT1                                                     00273000
WPXNLCK  EQU   BIT2                                                     00274000
WPXACLW  EQU   BIT3                                                     00275000
WPXSPVD  EQU   BIT4                                                     00276000
WPXQNLY  EQU   BIT5                                                     00277000
WPXRSV56 EQU   BIT6                                                     00278000
WPXRSV57 EQU   BIT7                                                     00279000
WPXCPFL2 DS    X              FLAGS FOR CONTROL PROGRAM USE BYTE 2      00280000
WPXRSV60 EQU   BIT0                                                     00281000
WPXRSV61 EQU   BIT1                                                     00282000
WPXRSV62 EQU   BIT2                                                     00283000
WPXRSV63 EQU   BIT3                                                     00284000
WPXRSV64 EQU   BIT4                                                     00285000
WPXRSV65 EQU   BIT5                                                     00286000
WPXRSV66 EQU   BIT6                                                     00287000
WPXRSV67 EQU   BIT7                                                     00288000
*                                                                       00289000
WPXRPBUF DS    AL4            REPLY BUFFER ADDR - WTOR ONLY             00290000
WPXECBP  DS    AL4            REPLY ECB ADDRESS - WTOR ONLY             00291000
WPXSEQN  DS    0F             DOM/CONNECT ID                            00292000
WPXSYSID DS    AL1            SYSTEM ID                                 00293000
WPXSQID  DS    AL3            DOM SEQUENCE NUMBER                       00294000
*                                                                       00295000
*********************************************************************** 00296000
*                                                                       00297000
*        DESCRIPTOR CODES                                               00298000
*                                                                       00299000
*********************************************************************** 00300000
*                                                                       00301000
WPXDESC  DS    0XL4           DESCRIPTOR CODES                          00302000
WPXDESC1 DS    X              FIRST BYTE OF DESCRIPTOR CODES            00303000
WPXDESCA EQU   BIT0           SYSTEM FAILURE MESSAGE                    00304000
WPXDESCB EQU   BIT1           IMMEDIATE ACTION REQUIRED MESSAGE         00305000
WPXDESCC EQU   BIT2           EVENTUAL ACTION REQUIRED MESSAGE          00306000
WPXDESCD EQU   BIT3           SYSTEM STATUS MESSAGE                     00307000
WPXDESCE EQU   BIT4           IMMEDIATE COMMAND RESPONSE MESSAGE        00308000
WPXDESCF EQU   BIT5           JOB STATUS MESSAGE                        00309000
WPXDESCG EQU   BIT6           APPL PROGRAM - PROCESSOR MESSAGE          00310000
WPXDESCH EQU   BIT7           OUT-OF-LINE MESSAGE                       00311000
WPXDESC2 DS    X              SECOND BYTE OF DESCRIPTOR CODES           00312000
WPXDESCI EQU   BIT0           DESCRIPTOR CODE 9                         00313000
WPXDESCJ EQU   BIT1           DESCRIPTOR CODE 10                        00314000
WPXDESCK EQU   BIT2           DESCRIPTOR CODE 11                        00315000
WPXDESCL EQU   BIT3           DELIVERED BUT NOT HELD                    00316000
WPXRSV4  EQU   BIT4           RESERVED                                  00317000
WPXRSV5  EQU   BIT5           RESERVED                                  00318000
WPXRSV6  EQU   BIT6           RESERVED                                  00319000
WPXRSV7  EQU   BIT7           RESERVED                                  00320000
WPXDESC3 DS    X              RESERVED                                  00321000
WPXDESC4 DS    X              RESERVED                                  00322000
*                                                                       00323000
*********************************************************************** 00324000
*                                                                       00325000
*        ROUTING CODES 1-128                                            00326000
*                                                                       00327000
*        THESE CODES INDICATE THE FUNCTIONAL AREA OR AREAS TO           00328000
*        WHICH A MESSAGE IS TO BE SENT                                  00329000
*                                                                       00330000
*********************************************************************** 00331000
*                                                                       00332000
WPXROUT  DS    0XL16          ROUTING CODES                             00333000
WPXR001  DS    X              1ST BYTE OF ROUTING CODES                 00334000
WPXR01   EQU   BIT0           MASTER CONSOLE                            00335000
WPXR02   EQU   BIT1           MASTER CONSOLE INFORMATIONAL              00336000
WPXR03   EQU   BIT2           TAPE POOL                                 00337000
WPXR04   EQU   BIT3           DIRECT ACCESS POOL                        00338000
WPXR05   EQU   BIT4           TAPE LIBRARY                              00339000
WPXR06   EQU   BIT5           DISK LIBRARY                              00340000
WPXR07   EQU   BIT6           UNIT RECORD POOL                          00341000
WPXR08   EQU   BIT7           TELEPROCESSING CONTROL                    00342000
*                                                                       00343000
WPXR002  DS    X              2ND BYTE OF ROUTING CODES                 00344000
WPXR09   EQU   BIT0           SYSTEM SECURITY                           00345000
WPXR10   EQU   BIT1           SYSTEM/ERROR MAINTENANCE                  00346000
WPXR11   EQU   BIT2           PROGRAMMER INFORMATION                    00347000
WPXR12   EQU   BIT3           EMULATOR INFORMATION                      00348000
WPXR13   EQU   BIT4           USER ROUTING CODE                         00349000
WPXR14   EQU   BIT5           USER ROUTING CODE                         00350000
WPXR15   EQU   BIT6           USER ROUTING CODE                         00351000
WPXR16   EQU   BIT7           USER ROUTING CODE                         00352000
*                                                                       00353000
WPXR003  DS    X              3RD TO 16TH BYTE OF ROUTING CODES         00354000
WPXR004  DS    X                                                        00355000
WPXR005  DS    X                                                        00356000
WPXR006  DS    X                                                        00357000
WPXR007  DS    X                                                        00358000
WPXR008  DS    X                                                        00359000
WPXR009  DS    X                                                        00360000
WPXR010  DS    X                                                        00361000
WPXR011  DS    X                                                        00362000
WPXR012  DS    X                                                        00363000
WPXR013  DS    X                                                        00364000
WPXR014  DS    X                                                        00365000
WPXR015  DS    X                                                        00366000
WPXR016  DS    X                                                        00367000
*                                                                       00368000
*********************************************************************** 00369000
*                                                                       00370000
*        MESSAGE TYPE FLAGS                                             00371000
*                                                                       00372000
*********************************************************************** 00373000
*                                                                       00374000
WPXMSGTY DS    0XL2           MESSAGE TYPE FLAGS                        00375000
WPXMSGT1 DS    X              FIRST BYTE OF MESSAGE TYPE FLAGS          00376000
WPXMSGTA EQU   BIT0           MONITOR JOBNAMES                          00377000
WPXMSGTB EQU   BIT1           MONITOR STATUS                            00378000
WPXRSV9  EQU   BIT2           RESERVED                                  00379000
WPXRSV10 EQU   BIT3           RESERVED                                  00380000
WPXRSV11 EQU   BIT4           RESERVED                                  00381000
WPXMSGTF EQU   BIT5           MONITOR SESS                              00382000
WPXRSV12 EQU   BIT6           RESERVED                                  00383000
WPXRSV13 EQU   BIT7           RESERVED                                  00384000
WPXMSGT2 DS    X              SECOND BYTE OF MESSAGE TYPE FLAGS         00385000
WPXRSV14 EQU   BIT0           RESERVED                                  00386000
WPXRSV15 EQU   BIT1           RESERVED                                  00387000
WPXRSV16 EQU   BIT2           RESERVED                                  00388000
WPXRSV17 EQU   BIT3           RESERVED                                  00389000
WPXRSV18 EQU   BIT4           RESERVED                                  00390000
WPXRSV19 EQU   BIT5           RESERVED                                  00391000
WPXRSV20 EQU   BIT6           RESERVED                                  00392000
WPXRSV21 EQU   BIT7           RESERVED                                  00393000
*                                                                       00394000
WPXRSV73 DS    AL2            RESERVED                                  00395000
WPXJOBID DS    CL8            JOB ID                                    00396000
WPXJOBNM DS    CL8            JOBNAME                                   00397000
WPXKEY   DS    CL8            RETRIEVAL KEY                             00398000
WPXTOKN  DS    AL4            TOKEN FOR DOM                             00399000
WPXCNID  DS    AL4            CONSOLE ID                                00400000
WPXSYSNA DS    CL8            SYSTEM NAME                               00401000
WPXCNNME DS    CL8            CONSOLE NAME                              00402000
WPXRCNA  DS    AL4            ADDRESS OF 12 BYTE FIELD FOR REPLYING     00403000
*                             CONSOLE NAME/ID                           00404000
WPXCART  DS    AL4            ADDRESS OF CART                           00405000
WPXWSPRM DS    AL4            ADDRESS OF WAIT STATE PARM LIST           00406000
WPXASCB  DS    AL4            ASCB ADDRESS                              00407000
WPXRSV30 DS    CL16           RESERVED                                  00408000
WPXLEN   EQU   *-WPX          LENGTH OF THE WPX                         00409000
WPX2LEN  EQU   104            LENGTH OF VERSION 2 WPX                   00410000
WPX4LEN  EQU   124            LENGTH OF VERSION 4 WPX                   00411000
         MEND  ,              */                                        00412000
*%WPLL2: ;                                                              00413000
*                                                                       00414000
* @SPACE(2);                             /*                  @G64DP9A*/ 00415000
*/********************************************************************/ 00416000
*/*                                                                  */ 00417000
*/*                      WTOR PREFIX                                 */ 00418000
*/*                                                                  */ 00419000
*/********************************************************************/ 00420000
*                                                                       00421000
*DECLARE                                                                00422000
*  1 WPLRF  BASED(WPLPTR) BDY(WORD),     /* START OF WTOR PREFIX     */ 00423000
*   2 WPLRPTR     PTR(31),               /* POINTER TO REPLY BUFFER  */ 00424000
*    3 WPLRLN      PTR(8),               /* MAXIMUM LENGTH OF REPLY  */ 00425000
*    3 WPLRPTRA    PTR(24),              /* ADDRESS OF REPLY BUFFER  */ 00426000
*   2 WPLRECB     PTR(31);               /* ADDRESS OF REPLY ECB     */ 00427000
*                                                                       00428000
*/********************************************************************/ 00429000
*/*                                                                  */ 00430000
*/*                      COMMON SECTION                              */ 00431000
*/*                                                                  */ 00432000
*/********************************************************************/ 00433000
*                                                                       00434000
*DECLARE                                                                00435000
*  1 WPL  BASED(WPLPTR) BDY(WORD),       /* START OF COMMON SECTION  */ 00436000
*   2 WPLLGH      FIXED(15),             /* MESSAGE LENGTH (4 +         00437000
*                                           MESSAGE TEXT LENGTH      */ 00438000
*   2 WPLMCSF     CHAR(2),               /* MCS FLAGS                */ 00439000
*    3 WPLMCSF1    BIT(8),               /* 1ST BYTE OF MCS FLAGS    */ 00440000
*     4 WPLMCSFA BIT(1),                 /* ROUTE/DESCRIPTOR CODE       00441000
*                                           FIELDS PRESENT           */ 00442000
*     4 WPLMCSFB BIT(1),                 /* QUEUE TO CONSOLE IF ACTIVE  00443000
*                                           (ID IN REG 0)            */ 00444000
*     4 WPLMCSFC BIT(1),                 /* COMMAND RESPONSE         */ 00445000
*     4 WPLMCSFD BIT(1),                 /* MESSAGE TYPE FIELD EXISTS*/ 00446000
*     4 WPLMCSFE BIT(1),                 /* THIS WPL IS A REPLY TO A    00447000
*                                           WTOR                     */ 00448000
*     4 WPLMCSFF BIT(1),                 /* BROADCAST THIS MESSAGE      00449000
*                                           TO ALL ACTIVE CONSOLES   */ 00450000
*     4 WPLMCSFG BIT(1),                 /* QUEUE TO HARD COPY ONLY  */ 00451000
*     4 WPLMCSFH BIT(1),                 /* QUEUE UNCONDITIONALLY       00452000
*                                           TO CONSOLE (ID IN REG 0) */ 00453000
*    3 WPLMCSF2    BIT(8),               /* 2ND BYTE OF MCS FLAGS    */ 00454000
*     4 WPLMCSFI BIT(1),                 /* DO NOT TIME STAMP THIS      00455000
*                                           MESSAGE                  */ 00456000
*     4 WPLMCSFJ BIT(1),                 /* MLWTO INDICATOR          */ 00457000
*     4 WPLMCSFK BIT(1),                 /* IF ON, THE TEXT IN THIS     00458000
*                                           WPL IS TO BE ROUTED TO      00459000
*                                           THE JOB'S PRINTER ONLY      00460000
*                                           (OS/VS1)           MDC003*/ 00461000
*     4 WPLMCSFL BIT(1),                 /* EXTENDED WPL FORMAT EXITS   00462000
*                                           WAS WPLNOWTP SUPPRESS       00463000
*                                           WTP (VS1 ONLY)           */ 00464000
*     4 WPLRSV03 BIT(1),                 /* RESERVED                 */ 00465000
*     4 WPLMCSFN BIT(1),                 /* BYPASS QUEUING MESSAGE      00466000
*                                           TO HARD COPY             */ 00467000
*     4 WPLRSV04 BIT(1),                 /* RESERVED                 */ 00468000
*     4 WPLRSV05 BIT(1),                 /* RESERVED                 */ 00469000
*   2 WPLTXT      CHAR(126) BDY(WORD),   /* MESSAGE TEXT (MAXIMUM       00470000
*                                           126 CHARACTERS           */ 00471000
*    3 *           CHAR(125),            /* MESSAGE TEXT             */ 00472000
*    3 WPLTXTL     CHAR(1);              /* LAST BYTE OF MESSAGE        00473000
*                                           TEXT                     */ 00474000
*                                                                       00475000
*/*      THE FOLLOWING FIELDS BEGIN IMMEDIATELY FOLLOWING THE LAST   */ 00476000
*/*      CHARACTER (BYTE) OF MESSAGE TEXT IN WPLTXT                  */ 00477000
*                                                                       00478000
*DECLARE                                                                00479000
*  1 WPLFLGS  BASED(WPLPTR) BDY(BYTE),   /* START OF WPL FLGS FIELDS */ 00480000
*   2 WPLDESC     CHAR(2),               /* DESCRIPTOR CODES         */ 00481000
*                                                                       00482000
*/*      DESCRIPTOR CODES ARE USED TO FUNCTIONALLY CLASSIFY WTO AND  */ 00483000
*/*      WTOR MESSAGES.                                              */ 00484000
*                                                                       00485000
*    3 WPLDESC1    BIT(8),               /* 1ST BYTE OF DESCRIPTOR      00486000
*                                           CODES                    */ 00487000
*     4 WPLDESCA BIT(1),                 /* SYSTEM FAILURE MESSAGE   */ 00488000
*     4 WPLDESCB BIT(1),                 /* IMMEDIATE ACTION            00489000
*                                           REQUIRED MESSAGE         */ 00490000
*     4 WPLDESCC BIT(1),                 /* EVENTUAL ACTION             00491000
*                                           REQUIRED MESSAGE         */ 00492000
*     4 WPLDESCD BIT(1),                 /* SYSTEM STATUS MESSAGE    */ 00493000
*     4 WPLDESCE BIT(1),                 /* IMMEDIATE COMMAND           00494000
*                                           RESPONSE MESSAGE         */ 00495000
*     4 WPLDESCF BIT(1),                 /* JOB STATUS MESSAGE       */ 00496000
*     4 WPLDESCG BIT(1),                 /* APPLICATION PROGRAM/        00497000
*                                           PROCESSOR MESSAGE        */ 00498000
*     4 WPLDESCH BIT(1),                 /* OUT-OF-LINE MESSAGE      */ 00499000
*    3 WPLDESC2    BIT(8),               /* 2ND BYTE OF DESCRIPTOR      00500000
*                                           CODES                    */ 00501000
*     4 WPLDESCI BIT(1),                 /* DESCRIPTOR CODE 9        */ 00502000
*     4 WPLDESCJ BIT(1),                 /* DESCRIPTOR CODE 10          00503000
*                                           (OS/VS2)           MDC002*/ 00504000
*     4 WPLDESCK BIT(1),                 /* CRITICAL EVENTUAL ACTION    00505000
*                                           MESSAGE - DESCRIPTOR CODE   00506000
*                                           11  (MDC300)     @G64DP9A*/ 00507000
*     4 WPLRSV08 BIT(1),                 /* RESERVED                 */ 00508000
*     4 WPLRSV09 BIT(1),                 /* RESERVED                 */ 00509000
*     4 WPLRSV10 BIT(1),                 /* RESERVED                 */ 00510000
*     4 WPLRSV11 BIT(1),                 /* RESERVED                 */ 00511000
*     4 WPLRSV12 BIT(1),                 /* RESERVED                 */ 00512000
*                                                                       00513000
*   2 WPLROUT     CHAR(2),               /* ROUTING CODES            */ 00514000
*                                                                       00515000
*/*      THESE CODES INDICATE THE FUNCTIONAL AREA OR AREAS TO WHICH  */ 00516000
*/*      A MESSAGE IS TO BE SENT                                     */ 00517000
*                                                                       00518000
*    3 WPLROUT1    BIT(8),               /* 1ST BYTE OF ROUTING CODES*/ 00519000
*     4 WPLROUTA BIT(1),                 /* MASTER CONSOLE           */ 00520000
*     4 WPLROUTB BIT(1),                 /* MASTER CONSOLE INFO      */ 00521000
*     4 WPLROUTC BIT(1),                 /* TAPE POOL                */ 00522000
*     4 WPLROUTD BIT(1),                 /* DIRECT ACCESS POOL       */ 00523000
*     4 WPLROUTE BIT(1),                 /* TAPE LIBRARY             */ 00524000
*     4 WPLROUTF BIT(1),                 /* DISK LIBRARY             */ 00525000
*     4 WPLROUTG BIT(1),                 /* UNIT RECORD POOL         */ 00526000
*     4 WPLROUTH BIT(1),                 /* TELEPROCESSING CONTROL   */ 00527000
*    3 WPLROUT2    BIT(8),               /* 2ND BYTE OF ROUTING CODES*/ 00528000
*     4 WPLROUTI BIT(1),                 /* SYSTEM SECURITY          */ 00529000
*     4 WPLROUTJ BIT(1),                 /* SYSTEM/ERROR MAINTENANCE */ 00530000
*     4 WPLROUTK BIT(1),                 /* PROGRAMMER INFORMATION   */ 00531000
*     4 WPLROUTL BIT(1),                 /* EMULATOR INFORMATION     */ 00532000
*     4 WPLROUTM BIT(1),                 /* USER ROUTING CODE        */ 00533000
*     4 WPLROUTN BIT(1),                 /* USER ROUTING CODE        */ 00534000
*     4 WPLROUTO BIT(1),                 /* USER ROUTING CODE        */ 00535000
*     4 WPLRSV13 BIT(1),                 /* RESERVED                 */ 00536000
*                                                                       00537000
*   2 WPLMSGTY    CHAR(2),               /* MESSAGE TYPE FLAGS       */ 00538000
*    3 WPLMSGT1    BIT(8),               /* 1ST BYTE OF MESSAGE         00539000
*                                           TYPE FLAGS               */ 00540000
*     4 WPLMSGTA BIT(1),                 /* DISPLAY JOBNAMES         */ 00541000
*     4 WPLMSGTB BIT(1),                 /* DISPLAY STATUS           */ 00542000
*     4 WPLMSGTC BIT(1),                 /* MONITOR ACTIVE              00543000
*                                           (OS/VS1)           MDC001*/ 00544000
*     4 WPLMSGTD BIT(1),                 /* INDICATES EXISTENCE OF      00545000
*                                           QID FIELD IN WPL            00546000
*                                           (OS/VS1)           ICB467*/ 00547000
*     4 WPLRSV14 BIT(1),                 /* RESERVED                 */ 00548000
*     4 WPLMSGTF BIT(1),                 /* MONITOR SESS             */ 00549000
*     4 WPLRSV15 BIT(1),                 /* RESERVED                 */ 00550000
*     4 WPLRSV16 BIT(1),                 /* RESERVED                 */ 00551000
*    3 WPLMSGT2    BIT(8),               /* 2ND BYTE OF MESSAGE         00552000
*                                           TYPE FLAGS               */ 00553000
*     4 WPLRSV25 BIT(1),                 /* RESERVED                 */ 00554000
*     4 WPLRSV26 BIT(1),                 /* RESERVED                 */ 00555000
*     4 WPLRSV27 BIT(1),                 /* RESERVED                 */ 00556000
*     4 WPLRSV28 BIT(1),                 /* RESERVED                 */ 00557000
*     4 WPLRSV29 BIT(1),                 /* RESERVED                 */ 00558000
*     4 WPLRSV30 BIT(1),                 /* RESERVED                 */ 00559000
*     4 WPLRSV31 BIT(1),                 /* RESERVED                 */ 00560000
*     4 WPLRSV32 BIT(1),                 /* RESERVED                 */ 00561000
*   2 WPLQID      FIXED(15) BDY(BYTE);   /* STATION IDENTIFICATION      00562000
*                                           FOR RES SUPPORT             00563000
*                                           (OS/VS1)           ICB467*/ 00564000
*                                                                       00565000
*/********************************************************************/ 00566000
*/*                                                                  */ 00567000
*/*                      MLWTO EXTENSION                             */ 00568000
*/*                                                                  */ 00569000
*/********************************************************************/ 00570000
*                                                                       00571000
* /*     THE FOLLOWING FIELDS ARE ALWAYS PRESENT WHEN MLWTO IS       */ 00572000
* /*     SPECIFIED.                                                  */ 00573000
*                                                                       00574000
*DECLARE                                                                00575000
*  1 WPLLS01  BASED(WPLPTR) BDY(BYTE),                                  00576000
*   2 WPLLTF      CHAR(2),               /* LINE TYPE FLAGS FOR MSG     00577000
*                                           TEXT IN WPLTXT           */ 00578000
*    3 WPLLTF1     BIT(8),               /* 1ST BYTE OF LINE TYPE       00579000
*                                           FLAGS FOR WPLTXT         */ 00580000
*     4 WPLLTFA  BIT(1),                 /* CONTROL LINE             */ 00581000
*     4 WPLLTFB  BIT(1),                 /* LABEL LINE               */ 00582000
*     4 WPLLTFC  BIT(1),                 /* DATA LINE                */ 00583000
*     4 WPLLTFD  BIT(1),                 /* END LINE                 */ 00584000
*     4 WPLRSV17 BIT(1),                 /* RESERVED                 */ 00585000
*     4 WPLRSV18 BIT(1),                 /* RESERVED                 */ 00586000
*     4 WPLRSV19 BIT(1),                 /* RESERVED                 */ 00587000
*     4 WPLRSV20 BIT(1),                 /* RESERVED                 */ 00588000
*    3 WPLLTF2     BIT(8),               /* 2ND BYTE OF LINE TYPE       00589000
*                                           FLAGS FOR WPLTXT         */ 00590000
*   2 WPLAREA     CHAR(1),               /* AREA IDENTIFICATION      */ 00591000
*   2 WPLLINES    PTR(8);                /* NUMBER OF LINES (1 +        00592000
*                                           NUMBER OF WPLMLTXT LINES)*/ 00593000
*                                                                       00594000
* /*     THE FOLLOWING FIELDS ARE OPTIONAL FOR MLWTO.  THEY REPRE-   */ 00595000
* /*     SENT A MAPPING OF THE ENTRIES DESCRIBING MESSAGE TEXT LINES */ 00596000
* /*     CREATED IN ADDITION TO THE WPLTXT MESSAGE TEXT LINE.        */ 00597000
*                                                                       00598000
*DECLARE                                                                00599000
*  1 WPLML  BASED(WPLPTR) BDY(WORD),     /* START OF ADDITIONAL MSG     00600000
*                                           TEXT LINE ENTRY          */ 00601000
*   2 WPLML0      PTR(8),                /* HIGH-ORDER BYTE OF LENGTH   00602000
*                                           FIELD FOR WPLMLTXT (ALWAYS  00603000
*                                           ZERO)                    */ 00604000
*   2 WPLMLLEN    PTR(8),                /* LENGTH OF ADDITIONAL MSG    00605000
*                                           TEXT LINE ENTRY (4 +        00606000
*                                           LENGTH OF WPLMLTXT TEXT) */ 00607000
*   2 WPLMLLTF    CHAR(2),               /* LINE TYPE FLAGS FOR         00608000
*                                           WPLMLTXT TEXT            */ 00609000
*    3 WPLMLLT1    BIT(8),               /* 1ST BYTE OF LINE TYPE       00610000
*                                           FLAGS FOR WPLMLTXT       */ 00611000
*     4 WPLMLLTA BIT(1),                 /* CONTROL LINE             */ 00612000
*     4 WPLMLLTB BIT(1),                 /* LABEL LINE               */ 00613000
*     4 WPLMLLTC BIT(1),                 /* DATA LINE                */ 00614000
*     4 WPLMLLTD BIT(1),                 /* END LINE                 */ 00615000
*     4 WPLRSV21 BIT(1),                 /* RESERVED                 */ 00616000
*     4 WPLRSV22 BIT(1),                 /* RESERVED                 */ 00617000
*     4 WPLRSV23 BIT(1),                 /* RESERVED                 */ 00618000
*     4 WPLRSV24 BIT(1),                 /* RESERVED                 */ 00619000
*    3 WPLMLLT2    BIT(8),               /* 2ND BYTE OF LINE TYPE       00620000
*                                           FLAGS FOR WPLMLTXT       */ 00621000
*                                                                       00622000
*   2 WPLMLTXT    CHAR(126);             /* ADDITIONAL LINE MESSAGE     00623000
*                                           TEXT (MAX 126 CHARS)     */ 00624000
*                                                                       00625000
* /************************** END OF WPL *****************************/ 00626000
./ ADD NAME=WTO
*  %/*                                                                  00001000
         MACRO                                                          00002000
&NAME   WTO    &MESG,&MF=I,&ROUTCDE=,&DESC=,&MSGTYP=,&MCSFLAG=,&QID=,&AX00003000
               REAID=,&TEXT=^                                           00004000
.********************************************************************** 00005000
.*                                                                      00006000
.*       WTO - WRITE TO OPERATOR                                        00007000
.*                                                                      00008000
.*       INVOCATION - SPECIFY -  WTO MESG,ROUTCDE=,DESC=,MSGTYP=,       00009000
.*                            MCSFLAG=,QID=,AREAID=,MF=,TEXT=           00010000
.*              WHERE -                                                 00011000
.*                MESG     THE MESSAGE TEXT FOR A SINGLE OR             00012000
.*                         MULTIPLE LINE MESSAGE TO BE                  00013000
.*                         WRITTEN                                      00014000
.*                                                                      00015000
.*                ROUTCDE= ROUTING CODES TO BE ASSIGNED TO THE          00016000
.*                         MESSAGE                                      00017000
.*                                                                      00018000
.*                DESC=    DESCRIPTOR CODES TO BE ASSIGNED TO           00019000
.*                         THE MESSAGE                                  00020000
.*                                                                      00021000
.*                MSGTYP=  SPECIFIES HOW THE MESSAGE IS TO BE           00022000
.*                         ROUTED. VALID VALUES ARE:                    00023000
.*                         N,Y,SESS,JOBNAMES,STATUS,ACTIVE,             00024000
.*                         SHOW                                         00025000
.*                                                                      00026000
.*                MCSFLAG= SPECIFIES ATTRIBUTES OF THE                  00027000
.*                         MESSAGE. VALID VALUES ARE:                   00028000
.*                         REG0,RESP,REPLY,BRDCST,HRDCPY,               00029000
.*                         QREG0,NOTIME,NOCPY                           00030000
.*                                                                      00031000
.*                QID=     REMOTE ENTRY SERVICES (RSS) QUEUE            00032000
.*                         ID (OS/VS1 ONLY). PARAMETER ACCEPTED         00033000
.*                         BUT IGNORED BY MVS                           00034000
.*                                                                      00035000
.*                AREAID=  SPECIFIES A DISPLAY AREA ON THE              00036000
.*                         CONSOLE WHERE THE MESSAGE IS TO BE           00037000
.*                         WRITTEN.                                     00038000
.*                                                                      00039000
.*                MF=      SPECIFIES THE TYPE OF EXPANSION              00040000
.*                         REQUIRED. VALID VALUES ARE:                  00041000
.*                           I,L,E                                      00042000
.*                                                                      00043000
.*                TEXT=    SPECIFIES A DATA AREA CONTAINING A 2         00044000
.*                         BYTE MESSAGE LENGTH FIELD FOLLOWED BY        00045000
.*                         THE ACTUAL MESSAGE TEXT. IF A REGISTER       00046000
.*                         IS USED, THE REGISTER CONTAINS THE           00047000
.*                         ADDRESS OF THE DATA AREA. IF A FIELD         00048000
.*                         IS USED, THE ADDRESS OF THE FIELD IS         00049000
.*                         STORED IN THE WPL. THE TEXT KEYWORD IS       00050000
.*                         MUTUALLY EXCLUSIVE WITH INLINE               00051000
.*                         MESSAGE TEXT. EITHER TEXT OR INLINE          00052000
.*                         TEXT (BUT NOT BOTH) IS REQUIRED ON THE       00053000
.*                         STANDARD OR LIST FORM OF WTO                 00054000
.*                                                                      00055000
.*       FUNCTION - BUILDS ONE OF THREE POSSIBLE PARAMETER LIST         00056000
.*                  FORMATS AND/OR THE CODE WHICH WILL INVOKE           00057000
.*                  SVC 35 TO ISSUE THE MESSAGE.                        00058000
.*                  1. A STANDARD WPL IS BUILT IF INLINE TEXT IS        00059000
.*                     SPECIFIED AND NO ROUTING CODE GREATER THAN 16    00060000
.*                     IS SPECIFIED.                                    00061000
.*                  2. IF INLINE TEXT IS SPECIFIED AND A ROUTING CODE   00062000
.*                     GREATER THAN 16 IS SPECIFIED THEN AN EXTENDED    00063000
.*                     WPL VERSION 1 IS BUILT.                          00064000
.*                  3. IF THE TEXT OPERAND IS SPECIFIED THEN AN         00065000
.*                     EXTENDED WPL VERSION 2 IS GENERATED.             00066000
.*                                                                      00067000
.*       STATUS -                                                       00068000
.*       LASTUPD         = EBB1102  TYPE=ADD                            00069000
.*       LIBRARIES       = DISTLIB=AMACLIB                              00070000
.*       FMID            = FBB1221                                      00071000
.*       RMID            = UZ31484                                      00072000
.*       SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS       00073000
.*                         EBB1102  FUNCTION  00.000  MAC  ACC RGN      00074000
.*                         FBB1221  FUNCTION  00.000  MAC  ACC RGN      00075000
.*                                                                      00076000
.*       CHANGE ACTIVITY -                                              00077000
.*              ZP60039  - EXTENSIVE REVISION OF THE MACRO AND          00078000
.*                         SUPPORT FOR THE TEXT OPERAND WHICH           00079000
.*                         REQUIRES GENERATION OF AN EXTENDED WPL       00080000
.*                                                                      00081000
.********************************************************************** 00082000
         GBLB  &IHBWTL                                                  00083000
         LCLA  &LT(256),&H,&I,&II,&N,&J,&K,&LEN,&LLCNT                  00084000
         LCLA  &NUMENT                 NUMBER OF SUBLIST ENTRIES        00085000
         LCLA  &LENENT                 L'ENTRY                          00086000
         LCLB  &AD,&E,&E1,&E2,&E3,&E4,&E5,&E6,&MLW  MLWTO FLAGS         00087000
         LCLB  &SECONDL,&PAIR                                           00088000
         LCLC  &GNAME                                                   00089000
         LCLB  &RO(128),&DE(16),&MC(32),&MT(16)  FLAGS FOR THE FIELDS   00090000
         LCLC  &LOWNUM,&HIGHNUM        ROUTE RANGE NUMBERS              00091000
         LCLB  &GENRD                  GENERATE ROUT AND DESC FIELDS    00092000
         LCLB  &GENMT                  GENERATE MSGTYP FIELD            00093000
         LCLB  &GENXWPL                GENERATE AN XWPL                 00094000
         LCLA  &WPLXLEV                LEVEL OF XWPL TO GENERATE        00095000
         LCLB  &MTY,&MTN               FLAGS FOR MSGTYP PROCESSING      00096000
         ACTR  30000                                                    00097000
.*                                                                      00098000
.*       INITIALIZATION                                                 00099000
.*                                                                      00100000
&GNAME   SETC  'IHB'.'&SYSNDX'         FOR BAL INSTRUCTION              00101000
&WPLXLEV SETA  1                                                        00102000
.********************************************************************** 00103000
.*                                                                      00104000
.*       BEGIN PROCESSING PARAMETERS                                    00105000
.*                                                                      00106000
.********************************************************************** 00107000
.********************************************************************** 00108000
.*                                                                      00109000
.*        PROCESS ROUTING CODES                                         00110000
.*        DETERMINE IF ROUTING CODES HAVE BEEN SPECIFIED                00111000
.*                                                                      00112000
.*        ROUTING CODES 1-128 MAY BE SET HOWEVER FOR MVS 3.8 ONLY       00113000
.*        ONLY ROUTING CODES 1-16 WILL BE ACTIONED                      00114000
.*        ANY ROUTING CODE GREATER THAN 16 WILL BE IGNORED              00115000
.*        WITHOUT ERROR HOWEVER SPECIFYING A ROUTING CODE GREATER       00116000
.*        THAN 16 WILL CAUSE THE GENERATION OF AN EXTENDED FORMAT       00117000
.*        VERSION 1 WPL (XWPL).                                         00118000
.*                                                                      00119000
.********************************************************************** 00120000
         AIF   (T'&ROUTCDE EQ 'O').ENDROUT   ROUTING CODES APECIFIED ?  00121000
&GENRD   SETB  1                    ROUTING CODES PRESENT               00122000
&I       SETA  1                    INITIALIZE LIST INDEX               00123000
&NUMENT  SETA  N'&ROUTCDE           TOTAL NUMBER OF ENTRIES IN &ROUTCDE 00124000
.*       ROUTING CODE LOOP                                              00125000
.ROULOOP ANOP                                                           00126000
&LENENT  SETA  K'&ROUTCDE(&I)       SET L'CURRENT ELEMENT               00127000
         AIF   (&LENENT EQ 0).BADENT  NULL ENTRY, ERROR                 00128000
         AIF   (T'&ROUTCDE(&I) EQ 'N').ROUVAL   SINGLE NUMERIC VALUE    00129000
.*                                                                      00130000
.*       RANGE OF ROUTING CODES HAS BEEN SPECIFIED                      00131000
.*                                                                      00132000
.*       SCAN FOR DASH SEPERATOR                                        00133000
.*                                                                      00134000
&II      SETA  1                    INITIALIZE ELEMENT INDEX            00135000
.DASHL   ANOP                       DASH SCANNING LOOP                  00136000
         AIF   ('&ROUTCDE(&I)'(&II,1) EQ '-').DASHFND                   00137000
&II      SETA  &II+1                INCREMENT ELEMENT INDEX             00138000
         AIF   (&II GE &LENENT).BADRANG   CHECK INDEX POSITION          00139000
         AGO   .DASHL               LOOP AROUND FOR NEXT CHAR           00140000
.*       FOUND A DASH SEPERATOR                                         00141000
.DASHFND ANOP                                                           00142000
         AIF   (&II EQ 1).BADRANG         DASH UP FRONT ? ERROR         00143000
         AIF   (&II EQ &LENENT).BADRANG   DASH AT THE END ? ERROR       00144000
&LOWNUM  SETC  '&ROUTCDE(&I)'(1,&II-1) SET FIRST NUMBER OF RANGE        00145000
&HIGHNUM SETC  '&ROUTCDE(&I)'(&II+1,&LENENT-&II) SET SECOND NUMBER      00146000
.*       FIRST NUMBER > LAST NUMBER ? ERROR                             00147000
         AIF   ('&LOWNUM' GT '&HIGHNUM').BADRANG                        00148000
.*       OUTSIDE THE RANGE OF VALID ROUTING CODES ? ERROR               00149000
         AIF   ('&LOWNUM' LT '1' OR '&LOWNUM' GT '128' OR              X00150000
               '&HIGHNUM' LT '1' OR '&HIGHNUM' GT '128').BADRANG        00151000
&J       SETA  &LOWNUM              INITIALIZE START OF RANGE           00152000
&K       SETA  &HIGHNUM             INITIALIZE END OF RANGE             00153000
.*       LOOP TO SET ON ROUTING CODES                                   00154000
.*       IF ALREADY SET ON THEN ERROR                                   00155000
.RANLOOP ANOP                                                           00156000
         AIF   (&RO(&J)).BADRANG                                        00157000
&RO(&J)  SETB  1                    SET ROUTING CODE &J ON              00158000
         AIF   (&J LT 17).RANLOPA                                       00159000
&GENXWPL SETB  1                    ANY VALUE > 16 FORCES A XWPL        00160000
.RANLOPA ANOP                                                           00161000
&J       SETA  &J+1                 INCREMENT LOOP INDEX                00162000
         AIF   (&J LE &K).RANLOOP   LOOP THROUGH RANGE                  00163000
.*       RANGE PROCESSED                                                00164000
         AGO   .NEXTROU             DETERMINE NEXT ROUTING CODE         00165000
.*                                                                      00166000
.*       ROUTING CODE VALUE HAS BEEN SPECIFIED. VERIFY THAT IT IS       00167000
.*       WITHIN THE PROPER RANGE AND, IF SO, SET THE CORRECT BIT        00168000
.*                                                                      00169000
.ROUVAL  ANOP                                                           00170000
&J       SETA  &ROUTCDE(&I)         GET NEXT ROUTING CODE VALUE         00171000
         AIF   (&J GE 1 AND &J LE 128).ROUOK   VALID VALUE ?            00172000
         MNOTE 4,'ROUTCDE &J IS AN INVALID ROUTING CODE'                00173000
         AGO   .NEXTROU                                                 00174000
.ROUOK   ANOP                       VALID ROUTING CODE SPECIFIED        00175000
         AIF   (&RO(&J)).BADRANG                                        00176000
&RO(&J)  SETB  1                    SET ROUTING CODE &J ON              00177000
         AIF   (&J LT 17).NEXTROU                                       00178000
&GENXWPL SETB  1                    ANY VALUE > 16 FORCES A XWPL        00179000
&MC(12)  SETB  1                    SET MCS FLAG FOR XWPL (WPLMCSFL)    00180000
         AGO   .NEXTROU             LOOP TO NEXT VALUE                  00181000
.*       A NULL ROUTING CODE HAS BEEN SPECIFIED                         00182000
.*       ISSUE AN MNOTE AND SKIP TO THE NEXT ROUTING CODE               00183000
.BADENT  ANOP                                                           00184000
         MNOTE 4,'NULL ROUTING CODE SPECIFIED'                          00185000
         AGO   .NEXTROU                                                 00186000
.*       AN INVALID ROUTING CODE RANGE HAS BEEN SPECIFIED               00187000
.*       ISSUE AN MNOTE AND SKIP TO THE NEXT ROUTING CODE               00188000
.BADRANG ANOP                                                           00189000
         MNOTE 4,'INVALID RANGE OF ROUTING CODES IGNORED.'              00190000
.*       FALL THROUGH TO SETUP FOR NEXT VALUE                           00191000
.*                                                                      00192000
.*       SETUP TO PROCESS NEXT ROUTE CODE ENTRY                         00193000
.NEXTROU ANOP                                                           00194000
&I       SETA  &I+1                 INCREMENT INDEX TO ROUT CODE VALUES 00195000
         AIF   (&I LE &NUMENT).ROULOOP IF MORE CODES, CHECK NEXT ONE    00196000
.ENDROUT ANOP                       DONE WITH ROUTING CODES             00197000
.********************************************************************** 00198000
.*                                                                      00199000
.*        PROCESS DESCRIPTOR CODES                                      00200000
.*        DETERMINE IF DESCRIPTOR CODES HAVE BEEN SPECIFIED             00201000
.*                                                                      00202000
.********************************************************************** 00203000
         AIF   (T'&DESC EQ 'O').ENDDESC   NO DESCRIPTOR, BRANCH         00204000
&GENRD   SETB  1                 FORCE GENERATION OF DESC AND ROUTCDES  00205000
&NUMENT  SETA  N'&DESC           NUMBER OF ENTRIES                      00206000
&I       SETA  1                                                        00207000
&J       SETA  0                 COUNTER TO DETECT MUTUALLY EXCL VALUE  00208000
.DESCLOP ANOP                                                           00209000
&II      SETA  &DESC(&I)                                                00210000
         AIF   (&II GE 1 AND &II LE 16).DESCOK                          00211000
.DESCERR MNOTE 8,'DESC &N IS INVALID DESCRIPTOR - IGNORED'              00212000
         AGO   .NEXTDES                                                 00213000
.DESCOK  ANOP                                                           00214000
         AIF   (&DE(&II)).DESERR            ALREADY SPECIFIED           00215000
         AIF   (&II GT 6).DESCJMP                                       00216000
&J       SETA  &J+1                         A VALUE LOWER THAN 7 SPEC   00217000
.DESCJMP ANOP                                                           00218000
&DE(&II) SETB  1                                                        00219000
.NEXTDES ANOP                                                           00220000
&I       SETA  &I+1                         INCR ENTRY COUNTER          00221000
         AIF   (&I LE &NUMENT).DESCLOP      PROCESS NEXT ENTRY          00222000
.*       ALL ENTRIES PROCESSED                                          00223000
.*       TEST FOR ANY MUTUALLY EXCLUSIVE ENTRIES                        00224000
         AIF   (&J LT 2).ENDDESC            ALL OK                      00225000
         MNOTE 8,'DESC MUTUALLY EXCLUSIVE VALUE SPECIFIED'              00226000
         MEXIT                                                          00227000
.DESERR  MNOTE 8,'DUPLICATE DESCRIPTOR VALUE SPECIFIED'                 00228000
         MEXIT                                                          00229000
.ENDDESC ANOP                                                           00230000
.********************************************************************** 00231000
.*                                                                      00232000
.*       PROCESS MSGTYP PARAMETERS                                      00233000
.*       DETERMINE IF MSGTYP PARAMETERS HAVE BEEN SPECIFIED             00234000
.*       PARAMETERS -                                                   00235000
.*       Y        - GENERATES MSGTYP FIELD BUT IGNORES OTHER            00236000
.*                  PARAMETERS (ALL MSGTYP FLAGS ZERO)                  00237000
.*                  THIS MUST BE THE FIRST PARAMETER                    00238000
.*       N        - SUPPESSSES THE GENERATION OF THE MSGTYP             00239000
.*                  FIELD EVEN THOUGH OTHER PARAMETERS HAVE BEEN        00240000
.*                  SPECIFIED                                           00241000
.*                  THIS MUST BE THE FIRST PARAMETER                    00242000
.*       JOBNAMES -                                                     00243000
.*       STATUS   -                                                     00244000
.*       ACTIVE   -                                                     00245000
.*       SHOW     - FOR VS/1 CRJE SUPPORT                               00246000
.*       SESS     -                                                     00247000
.*       NOTE THAT THE MSGTYP FIELD WILL BE GENERATED AND THE           00248000
.*       WPLMSGTD FLAG WILL BE SET IF THE QID PARAMETER IS              00249000
.*       CODED ON THE WTO MACRO                                         00250000
.*                                                                      00251000
.********************************************************************** 00252000
         AIF   (T'&MSGTYP EQ 'O').ENDMSGT   MSGTYP PARAMS SPECIFIED ?   00253000
.*                                          YES, USE OF MSGTYPE FORCES  00254000
&GENRD   SETB  1                            GENERATION OF ROUT/DESC     00255000
&NUMENT  SETA  N'&MSGTYP                    NUMBER OF ENTRIES           00256000
         AIF   ('&MSGTYP(1)' NE 'N').MSGL1                              00257000
&MTN     SETB  1                            MSGTYP=N CODED              00258000
         AGO   .MSGL2                                                   00259000
.MSGL1   AIF   ('&MSGTYP(1)' NE 'Y').MSGL3  MSGTYP=Y CODED              00260000
&MTY     SETB  1                                                        00261000
.MSGL2   ANOP                               EITHER MSGTYP =Y/N CODED    00262000
&I       SETA  1                            FIRST PARAMETER PROCESSED   00263000
         AGO   .NEXTMSG                                                 00264000
.MSGL3   ANOP                                                           00265000
&I       SETA  0                                                        00266000
         AGO   .NEXTMSG                                                 00267000
.MSGTLOP ANOP                               LOOP THROUGH PARAMETERS     00268000
         AIF   ('&MSGTYP(&I)' NE 'JOBNAMES').MSGL4                      00269000
         AIF   (&MT(1)).MTERR               JOBNAMES ALREADY CODED ?    00270000
&MT(1)   SETB  1                            TURN ON JOBNAMES            00271000
         AGO   .NEXTMSG                                                 00272000
.MSGL4   ANOP                                                           00273000
         AIF   ('&MSGTYP(&I)' NE 'STATUS').MSGL5                        00274000
         AIF   (&MT(2)).MTERR               STATUS ALREADY CODED ?      00275000
&MT(2)   SETB  1                            TURN ON STATUS              00276000
         AGO   .NEXTMSG                                                 00277000
.MSGL5   ANOP                                                           00278000
         AIF   ('&MSGTYP(&I)' NE 'ACTIVE').MSGL6                        00279000
         AIF   (&MT(3)).MTERR               ACTIVE ALREADY CODED ?      00280000
&MT(3)   SETB  1                            TURN ON ACTIVE              00281000
         AGO   .NEXTMSG                                                 00282000
.MSGL6   ANOP                                                           00283000
         AIF   ('&MSGTYP(&I)' NE 'SHOW').MSGL7                          00284000
         AIF   (&MT(5)).MTERR               SHOW ALREADY CODED ?        00285000
&MT(5)   SETB  1                            TURN ON SHOW                00286000
         AGO   .NEXTMSG                                                 00287000
.MSGL7   ANOP                                                           00288000
         AIF   ('&MSGTYP(&I)' NE 'SESS').MTERR                          00289000
         AIF   (&MT(6)).MTERR               SESS ALREADY CODED ?        00290000
&MT(6)   SETB  1                            TURN ON SESS                00291000
.NEXTMSG ANOP                                                           00292000
&GENMT   SETB  1                            GENERATE MSGTYP FIELD       00293000
&I       SETA  &I+1                         INCR ENTRY COUNTER          00294000
         AIF   (&I LE &NUMENT).MSGTLOP      PROCESS NEXT ENTRY          00295000
.*       ALL ENTRIES PROCESSED                                          00296000
.*       PROCESS FLAGS                                                  00297000
&GENMT   SETB  (NOT &MTN)                   SUPRESS MT GEN IF MSGTYP=N  00298000
         AIF   (&MTN OR &MTY).MSGL8                                     00299000
         AGO   .ENDMSGT                                                 00300000
.*       ERROR PROCESSING                                               00301000
.MTERR   MNOTE 8,'MESSAGE TYPE FIELD INVALID - N IS ASSUMED'            00302000
&MTN     SETB  1                                                        00303000
&MTY     SETB  0                                                        00304000
.MSGL8   ANOP                               TURN OFF ALL FLAGS          00305000
&MT(1)   SETB  0                                                        00306000
&MT(2)   SETB  0                                                        00307000
&MT(3)   SETB  0                                                        00308000
&MT(5)   SETB  0                                                        00309000
&MT(6)   SETB  0                                                        00310000
.ENDMSGT ANOP                                                           00311000
.********************************************************************** 00312000
.*                                                                      00313000
.*       PROCESS MCSFLAG PARAMETERS                                     00314000
.*       DETERMINE IF MCSFLAG PARAMETERS HAVE BEEN SPECIFIED            00315000
.*       PARAMETERS -                                                   00316000
.*       REG0     - MSG TO CONSOLE WITH SOURCE ID IN R0                 00317000
.*       RESP     - WTO IS IMMEDIATE COMMAND RESPONSE                   00318000
.*       REPLY    - WTO IS A REPLY TO A WTOR                            00319000
.*       BRDCAST  - MSG TO BE BROADCAST TO ALL ACTIVE CONSOLES          00320000
.*       HRDCOPY  - MSG TO BE QUEUED FOR HARDCOPY ONLY                  00321000
.*       QREG0    - MSG TO BE QUEUED UNCONDITIONALLY TO CON ID IN R0    00322000
.*       NOTIME   - TIME IS NOT TO BE APPENDED TO MSG  TER              00323000
.*       NOCPY    - IF WTO OR WTOR IS ISSUED IN SUPERVISOR STATE        00324000
.*                  THEN DO NOT QUEUE FOR HARDCOPY                      00325000
.*                                                                      00326000
.********************************************************************** 00327000
         AIF   (T'&MCSFLAG EQ 'O').ENDMCS    MCSFLAG PARAMS SPECIFIED ? 00328000
&I       SETA  1                    SET LIST INDEX                      00329000
&NUMENT  SETA  N'&MCSFLAG           NUMBER OF ENTRIES                   00330000
.MCLOOP  ANOP                       START LOOP THROUGH PARAMETERS       00331000
         AIF   ('&MCSFLAG(&I)' NE 'REG0').MCL1                          00332000
         AIF   (&MC(2)).MCERR       REG0 ALREADY CODED ?                00333000
&MC(2)   SETB  1                    TURN ON REG0 (WPLMCSFB)             00334000
         AGO   .NEXTMC                                                  00335000
.MCL1    ANOP                                                           00336000
         AIF   ('&MCSFLAG(&I)' NE 'RESP').MCL2                          00337000
         AIF   (&MC(3)).MCERR       RESP ALREADY CODED ?                00338000
&MC(3)   SETB  1                    TURN ON RESP (WPLMCSFC)             00339000
         AGO   .NEXTMC                                                  00340000
.MCL2    ANOP                                                           00341000
         AIF   ('&MCSFLAG(&I)' NE 'REPLY').MCL3                         00342000
         AIF   (&MC(5)).MCERR       REPLYG0 ALREADY CODED ?             00343000
&MC(5)   SETB  1                    TURN ON REPLY (WPLMCSFE)            00344000
         AGO   .NEXTMC                                                  00345000
.MCL3    ANOP                                                           00346000
         AIF   ('&MCSFLAG(&I)' NE 'BRDCAST').MCL4                       00347000
         AIF   (&MC(6)).MCERR       BRDCAST ALREADY CODED ?             00348000
&MC(6)   SETB  1                    TURN ON BRDCAST (WPLMCSFF)          00349000
         AGO   .NEXTMC                                                  00350000
.MCL4    ANOP                                                           00351000
         AIF   ('&MCSFLAG(&I)' NE 'HRDCPY').MCL5                        00352000
         AIF   (&MC(7)).MCERR       HRDCPY ALREADY CODED ?              00353000
&MC(7)   SETB  1                    TURN ON HRDCPY (WPLMCSFG)           00354000
         AGO   .NEXTMC                                                  00355000
.MCL5    ANOP                                                           00356000
         AIF   ('&MCSFLAG(&I)' NE 'QREG0').MCL6                         00357000
         AIF   (&MC(8)).MCERR       QREG0 ALREADY CODED ?               00358000
&MC(8)   SETB  1                    TURN ON QREG0 (WPLMCSFH)            00359000
         AGO   .NEXTMC                                                  00360000
.MCL6    ANOP                                                           00361000
         AIF   ('&MCSFLAG(&I)' NE 'NOTIME').MCL7                        00362000
         AIF   (&MC(9)).MCERR       NOTIME ALREADY CODED ?              00363000
&MC(9)   SETB  1                    TURN ON NOTIME (WPLMCSFI)           00364000
         AGO   .NEXTMC                                                  00365000
.MCL7    ANOP                                                           00366000
         AIF   ('&MCSFLAG(&I)' NE 'NOCPY').MCERR                        00367000
         AIF   (&MC(14)).MCERR      NOTIME ALREADY CODED ?              00368000
&MC(14)  SETB  1                    TURN ON NOTTIME (WPLMCSFN)          00369000
         AGO   .NEXTMC                                                  00370000
.MCERR   ANOP                                                           00371000
         MNOTE 8,'&MCSFLAG(&I) IS INVALID - IGNORED'                    00372000
.NEXTMC  ANOP                       INCR ENTRY INDEX                    00373000
&I       SETA  &I+1                                                     00374000
         AIF   (&I LE &NUMENT).MCLOOP                                   00375000
.*       TEST FOR ERRORS                                                00376000
         AIF   (&MC(7) AND &MC(14)).MCEXCL    HRDCOPY AND NOCPY ?       00377000
         AGO   .ENDMCS                                                  00378000
.MCEXCL  MNOTE 8,'HRDCPY AND NOCPY MUTUALLY EXCLUSIVE, HRDCPY ASSUMED'  00379000
&MC(14)  SETB  0                      TURN OFF NOCPY                    00380000
.ENDMCS  ANOP                                                           00381000
.********************************************************************** 00382000
.*                                                                      00383000
.*       ALL PARAMETERS EXCEPT MESSAGE TEXT AND MF HAVE BEEN PROCESSED  00384000
.*       PROCESS ANY PARAMETER INTERACTIONS                             00385000
.*                                                                      00386000
.********************************************************************** 00387000
.*       DETERMINE IF A DEFAULT ROUTING CODE OF 2 HAS TO BE SET         00388000
.*                                                                      00389000
.*       IF THE GENERATION OF ROUTING AND DESCRIPTOR CODES FLAG         00390000
.*       HAS BEEN SET HOWEVER NO ROUTING AND DESCRIPTOR CODES           00391000
.*       HAVE BEEN PROVIDED THEN SET ROUTING CODE 2 AS A DEFAULT        00392000
         AIF   ((&GENRD) AND (T'&ROUTCDE EQ 'O')).INT1A                 00393000
         AIF   (NOT &GENMT).INT1    NO MSGTYP, BRANCH                   00394000
         AIF   (&MC(2) OR &MC(8)).INT1   MCS REG0 OR QREG0 CODED ?      00395000
.INT1A   ANOP                                                           00396000
.*       SET A DEFAULT ROUTING CODE OF 2                                00397000
&GENRD   SETB  1                                                        00398000
&RO(2)   SETB  1                                                        00399000
.INT1    ANOP                                                           00400000
.*       QID FORCES GENERATION OF DESC AND ROUTE FIELDS                 00401000
&GENRD   SETB  (&GENRD OR (T'&QID NE 'O'))                              00402000
.*       DETERMINE IF THE MCS FLAG FOR ROUT/DESC PRESENT SHOULD BE ON   00403000
&MC(1)   SETB  (&GENRD)                                                 00404000
.*       DETERMINE IF MCS FLAG FOR MSGTYP PRESENT SHOULD BE ON          00405000
&MC(4)   SETB  (&GENMT)                                                 00406000
.********************************************************************** 00407000
.*                                                                      00408000
.*       DETERMINE SOURCE OF TEXT FOR MESSAGE                           00409000
.*                                                                      00410000
.********************************************************************** 00411000
.*       MESSAGE TEXT AND INLINE TEXT ARE MUTUALLY EXCLUSIVE            00412000
.*       ISSUE ERROR MESSAGE IF CODED EXCEPT IF MF=E                    00413000
         AIF   (('&MESG' NE '') AND ('&TEXT' NE '^')).INT2              00414000
         AGO   .INT3                                                    00415000
.INT2    MNOTE 12,'''TEXT'' AND INLINE TEXT ARE MUTUALLY EXCLUSIVE'     00416000
         AGO   .END                                                     00417000
.*       EITHER MESG OR TEXT MUST BE SPECIFIED UNLESS MF=E              00418000
.INT3    AIF   ('&MF(1)' EQ 'E').INT5                                   00419000
         AIF   (('&MESG' EQ '') AND ('&TEXT' EQ '^')).INT4              00420000
         AGO   .INT5                                                    00421000
.INT4    MNOTE 12,'NO MESSAGE TEXT OR TEXT PARAMETER SPECIFIED'         00422000
         AGO   .END                                                     00423000
.INT5    ANOP                                                           00424000
.*       USE OF TEXT= PARAMETER FORCES GENERATION OF TYPE 2 XWPL        00425000
         AIF   ('&TEXT' EQ '^').INT6                                    00426000
&GENXWPL SETB  1                       GENERATE AN XWPL                 00427000
&WPLXLEV SETA  2                       LEVEL OF XWPL TO GENERATE        00428000
&MC(12)  SETB  1                       SET MCS FLAG FOR XWPL (WPLMCSFL) 00429000
&MC(25)  SETB  1                       TEXT ADDR SPECIFIED (WPXTXTAD)   00430000
.INT6    ANOP                                                           00431000
.********************************************************************** 00432000
.*                                                                      00433000
.*       PROCESS MF PARAMETER                                           00434000
.*                                                                      00435000
.********************************************************************** 00436000
         AIF    ('&MF' EQ 'I' OR '&MF' EQ 'L').WPLGEN                   00437000
.*                                                                      00438000
.*       MF=(E,X) PROCESSING                                            00439000
.*                                                                      00440000
         AIF   ('&MF(1)' NE 'E').ERROR1                                 00441000
         AIF   (N'&MF NE 2).ERROR1                                      00442000
&NAME    IHBINNRA &MF(2)            GENERATE INITIAL LR OR LA IF NEEDED 00443000
         AIF   (&IHBWTL).END                                            00444000
         AIF   (NOT &GENXWPL).MFESVC                                    00445000
.*       UPDATE MCS FLAGS                                               00446000
         OI    2(1),B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)'X00447000
                                        MCS FLAGS                       00448000
         OI    3(1),B'&MC(9)&MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&X00449000
               MC(16)'                  MCS FLAGS                       00450000
.*       ANY NEED TO UPDATE ADDITIONAL WPLX FIELDS ?                    00451000
         AIF   ((NOT &GENRD) AND (NOT &GENMT) AND (NOT &MC(25))).MFESVC 00452000
         AIF   ('&TEXT' EQ '^').MFE1                                    00453000
         AIF   ('&TEXT'(1,1) EQ '(').MFE2   TEXT=REG ?                  00454000
         LA    15,&TEXT                 R15 -> TEXT                     00455000
         ST    15,4(,1)                 STORE TEXT ADDR INTO XWPL       00456000
         AGO   .MFE1                                                    00457000
.MFE2    ST    &TEXT(1),4(,1)           STORE TEXT ADDR INTO XWPL       00458000
.MFE1    ANOP                                                           00459000
         LA    14,0(,1)                                                 00460000
         AH    14,0(,14)            ADD L'TEXT + LEN FIELD + MCS FIELD  00461000
         AIF   ('&TEXT' EQ '^').MFE3    NEED TO SET EXTENDED MCS ?      00462000
         OI    4(14),B'&MC(17)&MC(18)&MC(19)&MC(20)&MC(21)&MC(22)&MC(23X00463000
               )&MC(24)'                EXTENDED MCS                    00464000
         OI    5(14),B'&MC(25)&MC(26)&MC(27)&MC(28)&MC(29)&MC(30)&MC(31X00465000
               )&MC(32)'                EXTENDED MCS                    00466000
.MFE3    AIF   (NOT &GENRD).MFE4        NEED TO GEN ROUTE/DESC ?        00467000
         MVI   20(14),B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8X00468000
               )'                       DESCRIPTOR CODES                00469000
         MVI   21(14),B'&DE(9)&DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15X00470000
               )&DE(16)'                DESCRIPTOR CODES                00471000
         MVI   24(14),B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8X00472000
               )'                       ROUTING CODES                   00473000
         MVI   25(14),B'&RO(9)&RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15X00474000
               )&RO(16)'                ROUTING CODES                   00475000
.MFE4    AIF   (NOT &GENMT).MFESVC      NEED TO GEN MSGTYP FLAGS ?      00476000
         MVI   40(14),B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8X00477000
               )'                       MSGTYP                          00478000
         MVI   41(14),B'&MT(9)&MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15X00479000
               )&MT(16)'                MSGTYP                          00480000
.MFESVC  ANOP                                                           00481000
         SVC   35                                                       00482000
         AGO   .END                 EXIT MACRO, PROCESSING COMPLETE     00483000
.*                                                                      00484000
.*       MF=I AND MF=L PROCESSING                                       00485000
.*                                                                      00486000
.WPLGEN  ANOP                                                           00487000
.*       TEXT FOR PRESENCE OF INLINE TEXT                               00488000
         AIF   (((N'&SYSLIST EQ 0) OR (N'&SYSLIST GT 255)) AND         X00489000
               ('&TEXT' EQ '^')).NOTXT                                  00490000
         AIF   ('&MF' EQ 'L').DCNAME                                    00491000
.*       MF=I PROCESSING                                                00492000
         CNOP  0,4                                                      00493000
&NAME    BAL   1,&GNAME.A                                               00494000
         AGO   .MESCHK                                                  00495000
.DCNAME  ANOP                                                           00496000
&NAME    DC    0F'0'                                                    00497000
.MESCHK  ANOP                                                           00498000
         AIF   (&GENXWPL).XWPL01         GENERATE XWPL                  00499000
         AIF   ('&MESG' EQ '').NOTXT     TEXT SPECIFIED ? NO, ERROR     00500000
.*       TEST FOR MULTI-LINE WTO                                        00501000
&MLW     SETB  ((N'&SYSLIST NE 1) OR (N'&SYSLIST(1) NE 1))              00502000
&MC(10)  SETB  (&MLW)                    SET MLWTO IF APPROPRIATE       00503000
         AIF   (NOT &MLW).HDCYOK                                        00504000
         AIF   (NOT &MC(7)).HDCYOK                                      00505000
         IHBERMAC 248           MCSFLAG=HRDCPY INVALID FOR MLWTO        00506000
&GNAME.A DS    0H                                                       00507000
         MEXIT                  TERMINATE MACRO                         00508000
.HDCYOK  ANOP                                                           00509000
.GENDCS  AIF   (NOT &MLW).NOTMLW1  GENERATE REGULAR WTO                 00510000
.********************************************************************** 00511000
.*                                                                      00512000
.*       SETUP TO GENERATE MLWTO                                        00513000
.*                                                                      00514000
.********************************************************************** 00515000
.*                                                                      00516000
.*       SET LINETYPE                                                   00517000
.*                                                                      00518000
&H       SETA  1                                                        00519000
         AIF   ('&SYSLIST(1,1)' EQ '').MLW04                            00520000
         AIF   (N'&SYSLIST(1) GT 2).MLW05                               00521000
         AIF   ('&SYSLIST(1,2)' NE 'C').MLW02                           00522000
&LT(1)   SETA  80                                                       00523000
.MLW01   AIF   (N'&SYSLIST LE &H).MLW11                                 00524000
&H       SETA  &H+1                                                     00525000
         AIF   (N'&SYSLIST(&H) GT 2).MLW05                              00526000
.MLW02   AIF   ('&SYSLIST(&H,2)' NE 'L' OR '&SYSLIST(&H,1)' EQ '').MLW0X00527000
               4                                                        00528000
&LT(&H)  SETA  40                                                       00529000
         AIF   (&SECONDL).MLW03                                         00530000
&SECONDL SETB  1                                                        00531000
         AGO   .MLW01                                                   00532000
.MLW03   AIF   (N'&SYSLIST LE &H).MLW11                                 00533000
&H       SETA  &H+1                                                     00534000
         AIF   (N'&SYSLIST(&H) GT 2).MLW05                              00535000
.MLW04   AIF   ('&SYSLIST(&H,2)' EQ 'E').MLW06                          00536000
         AIF   ('&SYSLIST(&H,1)' EQ '').MLW05                           00537000
         AIF   ('&SYSLIST(&H,2)' EQ 'DE').MLW08                         00538000
         AIF   ('&SYSLIST(&H,2)' EQ 'L' OR '&SYSLIST(&H,2)' EQ 'C').MLWX00539000
               09                                                       00540000
         AIF   ('&SYSLIST(&H,2)' NE 'D' AND '&SYSLIST(&H,2)' NE '').MLW*00541000
               10                                                       00542000
&LT(&H)  SETA  20                                                       00543000
         AGO   .MLW03                                                   00544000
.MLW05   ANOP                                                           00545000
&E5      SETB  1                                                        00546000
&LT(&H)  SETA  10                                                       00547000
         AGO   .MLW11                                                   00548000
.MLW06   ANOP                                                           00549000
&LT(&H)  SETA  10                                                       00550000
.MLW07   ANOP                                                           00551000
&E4      SETB  (&H NE N'&SYSLIST)                                       00552000
         AGO   .MLW11                                                   00553000
.MLW08   ANOP                                                           00554000
&LT(&H)  SETA  30                                                       00555000
         AGO   .MLW07                                                   00556000
.MLW09   ANOP                                                           00557000
&E3      SETB  1                                                        00558000
&LT(&H)  SETA  30                                                       00559000
         AGO   .MLW11                                                   00560000
.MLW10   ANOP                                                           00561000
&E5      SETB  1                                                        00562000
&LT(&H)  SETA  30                                                       00563000
.MLW11   ANOP                                                           00564000
&LLCNT   SETA  &H                                                       00565000
&H       SETA  1                                                        00566000
.********************************************************************** 00567000
.*                                                                      00568000
.*       GENERATE START OF WPL                                          00569000
.*                                                                      00570000
.********************************************************************** 00571000
.NOTMLW1 ANOP                                                           00572000
&I       SETA  1                                                        00573000
&LEN     SETA  K'&SYSLIST(1,1)-2                                        00574000
&PAIR    SETB  0                                                        00575000
.QLOOP1  ANOP                                                           00576000
&I       SETA  &I+1+&PAIR                                               00577000
         AIF   (&I GE K'&SYSLIST(1,1)).QDONE1                           00578000
&PAIR    SETB  ('&SYSLIST(1,1)'(&I,2) EQ '''''' OR '&SYSLIST(1,1)'(&I,2X00579000
               ) EQ '&&')                                               00580000
&LEN     SETA  &LEN-&PAIR                                               00581000
         AGO   .QLOOP1                                                  00582000
.QDONE1  ANOP                                                           00583000
&AD      SETB  (&LT(1) NE 10)      0 IF E-TYPE LINE, 1 IF NOT           00584000
&LEN     SETA  4+&LEN*&AD                                               00585000
         DC    AL2(&LEN)               TEXT LENGTH                      00586000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00587000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00588000
                                       MCS FLAGS                        00589000
         AIF   (&LEN EQ 4).SKIPDC                                       00590000
         DC    C&SYSLIST(1,1)          MESSAGE TEXT                     00591000
.SKIPDC  AIF   (NOT &GENRD).OLDEXIT    GENERATING ROUT/DESC/MSGTYP ?    00592000
         DC    B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8)&DE(9)X00593000
               &DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15)&DE(16)'      X00594000
                                       DESCRIPTOR CODES                 00595000
         DC    B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8)&RO(9)X00596000
               &RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15)&RO(16)'      X00597000
                                       ROUTING CODES                    00598000
         AIF   (NOT &GENMT).OLDEXIT    GENERATING MSGTYP ?              00599000
         DC    B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8)&MT(9)X00600000
               &MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15)&MT(16)'      X00601000
                                       MSGTYP                           00602000
                                                                        00603000
.OLDEXIT AIF   (NOT &MLW).NOTMLW2                                       00604000
.********************************************************************** 00605000
.*                                                                      00606000
.*       GENERATE MLWTO FIELDS                                          00607000
.*                                                                      00608000
.********************************************************************** 00609000
         DC    XL2'&LT(1)00'           LINE TYPE                        00610000
         AIF   ('&AREAID' EQ '').ID0                                    00611000
         DC    CL1'&AREAID'            AREA ID                          00612000
         AGO   .IDA                                                     00613000
.ID0     DC    X'00'                   NULL AREA ID                     00614000
.IDA     ANOP                                                           00615000
         DC    AL1(&LLCNT)             TOTAL NUMBER OF LINES            00616000
.MLW12   AIF   (&H GE &LLCNT).MLW14                                     00617000
&H       SETA  &H+1                                                     00618000
&I       SETA  1                                                        00619000
&LEN     SETA  K'&SYSLIST(&H,1)-2                                       00620000
&PAIR    SETB  0                                                        00621000
.QLOOPH  ANOP                                                           00622000
&I       SETA  &I+1+&PAIR                                               00623000
         AIF   (&I GE K'&SYSLIST(&H,1)).QDONEH                          00624000
&PAIR    SETB  ('&SYSLIST(&H,1)'(&I,2) EQ '''''' OR '&SYSLIST(&H,1)'(&IX00625000
               ,2) EQ '&&')                                             00626000
&LEN     SETA  &LEN-&PAIR                                               00627000
         AGO   .QLOOPH                                                  00628000
.QDONEH  ANOP                                                           00629000
&AD      SETB  (&LT(&H) NE 10)     0 IF E-TYPE LINE, 1 IF NOT           00630000
&LEN     SETA  4+&LEN*&AD                                               00631000
         DC    AL2(&LEN)               LENGTH                           00632000
         DC    XL2'&LT(&H)00'          LINE TYPE                        00633000
         AIF   (&LEN EQ 4).MLW12                                        00634000
         DC    C&SYSLIST(&H,1)                                          00635000
         AGO   .MLW12                                                   00636000
.MLW14   AIF   (NOT &E4).MLW15                                          00637000
         IHBERMAC 242         GEN TERMINATED BY E OR DE LINE TYPE       00638000
.MLW15   AIF   (NOT &E5).MLW17                                          00639000
         IHBERMAC 243                                                   00640000
.MLW17   AIF   (NOT &E3).NOTMLW2                                        00641000
         IHBERMAC 244                                                   00642000
.NOTMLW2 AIF   ('&MF' NE 'I').END                                       00643000
&GNAME.A DS    0H                                                       00644000
.NOTMLW3 ANOP                                                           00645000
         AIF   (&E6 OR &E3 OR &IHBWTL).END                              00646000
         SVC   035                                                      00647000
         MEXIT                                                          00648000
.********************************************************************** 00649000
.*                                                                      00650000
.*       GENERATE XWPL                                                  00651000
.*                                                                      00652000
.********************************************************************** 00653000
.XWPL01  ANOP                                                           00654000
         AIF   ('&TEXT' NE '^').XWPL04     HAVE MESSAGE TEXT TO PROCESS 00655000
&I       SETA  1                                                        00656000
&LEN     SETA  K'&SYSLIST(1,1)-2    L'TEXT                              00657000
&PAIR    SETB  0                                                        00658000
.*       LOOP THROUGH TEXT STRING AND PROCESS DUPLICATE QUOTES          00659000
.*       AND AMPERSANDS                                                 00660000
.XWPL02  ANOP                                                           00661000
&I       SETA  &I+1+&PAIR                                               00662000
         AIF   (&I GE K'&SYSLIST(1,1)).XWPL03   GOTO LOOP EXIT          00663000
&PAIR    SETB  ('&SYSLIST(1,1)'(&I,2) EQ '''''' OR '&SYSLIST(1,1)'(&I,2X00664000
               ) EQ '&&')                                               00665000
&LEN     SETA  &LEN-&PAIR                                               00666000
         AGO   .XWPL02                 EXIT FROM LOOP                   00667000
.*       GENERATE XWPL FIELDS                                           00668000
.XWPL03  ANOP                                                           00669000
.*       GENERATE TEXT XWPL VERSION 1                                   00670000
&LEN     SETA  4+&LEN                                                   00671000
         AIF   (&LEN EQ 4).NOTXT                                        00672000
         DC    AL2(&LEN)                TEXT LENGTH                     00673000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00674000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00675000
                                        MCS FLAGS                       00676000
         DC    C&SYSLIST(1,1)           MESSAGE TEXT                    00677000
         DC    AL1(1)                   XWPL VERSION LEVEL              00678000
         AGO   .XWPL05                                                  00679000
.*       GENERATE TEXT ADDR XWPL VERSION 2                              00680000
.XWPL04  ANOP                                                           00681000
         DC    AL2(8)                   TEXT LENGTH                     00682000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00683000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00684000
                                        MCS FLAGS                       00685000
         DC    AL4(0)                   ADDR OF MESSAGE TEXT            00686000
         DC    AL1(2)                   XWPL VERSION LEVEL              00687000
.*       GENERATE FIELDS COMMON TO XWPL VER 1 AND XWPL VER 2            00688000
.XWPL05  ANOP                                                           00689000
         DC    B'00000000'              MISCELLANEOUS FLAGS             00690000
         DC    AL1(0)                   L'REPLY FOR WTOR                00691000
         AIF   (&WPLXLEV EQ 2).XWPL06   DETERMINE LEVEL OF XWPL         00692000
.*       XWPL LENGTH VALUE FOR XWPL VERSION 1                           00693000
         DC    AL1(0)                   RESERVED                        00694000
         AGO   .XWPL07                                                  00695000
.*       XWPL LENGTH VALUE FOR XWPL VERSION 2                           00696000
.XWPL06  ANOP                                                           00697000
         DC    AL1(104)                 LENGTH OF XWPL VERSION 2        00698000
.XWPL07  ANOP                                                           00699000
.*       GENERATE EXTENDED MCS FLAGS                                    00700000
         DC    B'&MC(17)&MC(18)&MC(19)&MC(20)&MC(21)&MC(22)&MC(23)&MC(2X00701000
               4)&MC(25)&MC(26)&MC(27)&MC(28)&MC(29)&MC(30)&MC(31)&MC(3X00702000
               2)'                      EXTENDED MCS FLGS               00703000
         DC    XL2'0000'                MCS FLAGS FOR CNTL PROGRAM USE  00704000
         DC    AL4(0)                   ADDR OF REPLY BUFFER FOR WTOR   00705000
         DC    AL4(0)                   ADDR OF REPLY ECB FOR WTOR      00706000
         DC    AL4(0)                   RESERVED - CONNECT ID           00707000
         DC    B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8)&DE(9)X00708000
               &DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15)&DE(16)'      X00709000
                                        DESCRIPTOR CODES                00710000
         DC    AL2(0)                   RESERVED                        00711000
         DC    B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8)&RO(9)X00712000
               &RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15)&RO(16)'      X00713000
                                        EXTENDED ROUTING CODES          00714000
         DC    B'&RO(17)&RO(18)&RO(19)&RO(20)&RO(21)&RO(22)&RO(23)&RO(2X00715000
               4)&RO(25)&RO(26)&RO(27)&RO(28)&RO(29)&RO(30)&RO(31)&RO(3X00716000
               2)'                                                      00717000
         DC    B'&RO(33)&RO(34)&RO(35)&RO(36)&RO(37)&RO(38)&RO(39)&RO(4X00718000
               0)&RO(41)&RO(42)&RO(43)&RO(44)&RO(45)&RO(46)&RO(47)&RO(4X00719000
               8)'                                                      00720000
         DC    B'&RO(49)&RO(50)&RO(51)&RO(52)&RO(53)&RO(54)&RO(55)&RO(5X00721000
               6)&RO(57)&RO(58)&RO(59)&RO(60)&RO(61)&RO(62)&RO(63)&RO(6X00722000
               4)'                                                      00723000
         DC    B'&RO(65)&RO(66)&RO(67)&RO(68)&RO(69)&RO(70)&RO(71)&RO(7X00724000
               2)&RO(73)&RO(74)&RO(75)&RO(76)&RO(77)&RO(78)&RO(79)&RO(8X00725000
               0)'                                                      00726000
         DC    B'&RO(81)&RO(82)&RO(83)&RO(84)&RO(85)&RO(86)&RO(87)&RO(8X00727000
               8)&RO(89)&RO(90)&RO(91)&RO(92)&RO(93)&RO(94)&RO(95)&RO(9X00728000
               6)'                                                      00729000
         DC    B'&RO(97)&RO(98)&RO(99)&RO(100)&RO(101)&RO(102)&RO(103)&X00730000
               RO(104)&RO(105)&RO(106)&RO(107)&RO(108)&RO(109)&RO(110)&X00731000
               RO(111)&RO(112)'                                         00732000
         DC    B'&RO(113)&RO(114)&RO(115)&RO(116)&RO(117)&RO(118)&RO(11X00733000
               9)&RO(120)&RO(121)&RO(122)&RO(123)&RO(124)&RO(125)&RO(12X00734000
               6)&RO(127)&RO(128)'                                      00735000
.*                                                                      00736000
         DC    B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8)&MT(9)X00737000
               &MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15)&MT(16)'      X00738000
                                        MSGTYPE                         00739000
         DC    AL2(0)                   MESSAGE PRIORITY                00740000
         DC    CL8'        '            JOB ID                          00741000
         DC    CL8'        '            JOB NAME                        00742000
         DC    CL8'        '            RETRIEVAL KEY                   00743000
         DC    AL4(0)                   TOKEN FOR DOM                   00744000
         DC    AL4(0)                   CONSOLE ID                      00745000
         DC    CL8'        '            SYSTEM NAME                     00746000
         AIF   (&WPLXLEV EQ 1).XWPL08   BRANCH TO GENERATE XWPL VER 1   00747000
         DC    CL8'        '            CONSOLE NAME                    00748000
         DC    AL4(0)                   REPLY CONSOLE NAME/ID ADDR      00749000
         DC    AL4(0)                   CART ADDRESS                    00750000
         DC    AL4(0)                   WSPARM ADDRESS                  00751000
         AIF   ('&MF' EQ 'L').NOTMLW2                                   00752000
.*       STORE ADDR OF TEXT INTO XWPL (VERSION 2 XWPL ONLY)             00753000
.*       GENERATE LABEL FOR BAL BRANCH                                  00754000
&GNAME.A DS    0H                                                       00755000
         AIF   ('&TEXT' EQ '^').NOTMLW3  SHOULD NOT HAPPEN              00756000
         AIF   ('&TEXT'(1,1) EQ '(').XWPL10   TEXT=(REG) ?              00757000
         LA    15,&TEXT                 R15 -> TEXT                     00758000
         ST    15,4(,1)                 STORE TEXT ADDR INTO XWPL       00759000
         AGO   .NOTMLW3                                                 00760000
.XWPL10  ANOP                                                           00761000
         ST    &TEXT(1),4(,1)           STORE TEXT ADDR INTO XWPL       00762000
         AGO   .NOTMLW3                                                 00763000
.*       XWPL VERSION 1 FIELDS                                          00764000
.XWPL08  ANOP                                                           00765000
         DC    AL4(0)                   RESERVED                        00766000
         DC    AL4(0)                   RESERVED                        00767000
         AGO   .NOTMLW2                                                 00768000
.********************************************************************** 00769000
.*       ISSUE ERROR MESSAGE - 12,INVALID MF OPERAND SPECIFIED-MF       00770000
.********************************************************************** 00771000
         IHBERMAC 35,,&MF                                               00772000
.ERROR1  ANOP                                                           00773000
         MEXIT                                                          00774000
.NOTXT   ANOP                                                           00775000
         MNOTE 12,'NUMBER OF LINES REQUESTED IS 0 OR GREATER THAN 255 -X00776000
                GENERATION TERMINATED'                                  00777000
.END     MEND                                                           00778000
./ ADD NAME=WTOR
         MACRO                                                          00001000
&NAME    WTOR  &MESG,&RYAD,&LENGTH,&ECB,&MF=I,&MSGTYP=,&ROUTCDE=,      X00002000
               &DESC=,&MCSFLAG=,&QID=,&TEXT=^                           00003000
.*                                                                      00004000
.********************************************************************** 00005000
.*                                                                      00006000
.*       WTOR - WRITE TO OPERATOR WITH REPLY                            00007000
.*                                                                      00008000
.*       INVOCATION - SPECIFY WTOR MESG,RYAD,LENGTH,ECB,ROUTCDE=,       00009000
.*                                 DESC=,MSGTYP=,MCSFLAG=,MF=,          00010000
.*                                 TEXT=(TEXTADDR,RYAD,LENGTH,ECB)      00011000
.*              WHERE:                                                  00012000
.*                MESG     THE MESSAGE TEXT FOR A SINGLE LINE MESSAGE   00013000
.*                         TO BE WRITTEN TO A CONSOLE                   00014000
.*                                                                      00015000
.*                RYAD     THE ADDRESS OF THE REPLY TEXT                00016000
.*                                                                      00017000
.*                LENGTH   MAXIMUM LENGTH OF THE REPLY TEXT FIELD       00018000
.*                                                                      00019000
.*                ECB      THE ADDRESS OF THE ECB TO BE POSTED ON       00020000
.*                         COMPLETION OF ENTRY OF THE REPLY TEXT        00021000
.*                                                                      00022000
.*                ROUTCDE= ROUTING CODES TO BE ASSIGNED TO THE          00023000
.*                         MESSAGE                                      00024000
.*                                                                      00025000
.*                DESC=    DESCRIPTOR CODES TO BE ASSIGNED TO           00026000
.*                         THE MESSAGE                                  00027000
.*                                                                      00028000
.*                MSGTYP=  SPECIFIES HOW THE MESSAGE IS TO BE           00029000
.*                         ROUTED. VALID VALUES ARE -                   00030000
.*                         N,Y,SESS,JOBNAMES,STATUS,ACTIVE,SHOW         00031000
.*                                                                      00032000
.*                MCSFLAG= SPECIFIES ATTRIBUTES OF THE                  00033000
.*                         MESSAGE. VALID VALUES ARE -                  00034000
.*                         REG0,RESP,REPLY,BRDCST,HRDCPY,               00035000
.*                         QREG0,NOTIME,NOCPY                           00036000
.*                                                                      00037000
.*                QID=     REMOTE ENTRY SERVICES (RSS) QUEUE            00038000
.*                         ID (OS/VS1 ONLY). PARAMETER ACCEPTED         00039000
.*                         BUT IGNORED BY MVS                           00040000
.*                                                                      00041000
.*                MF=      SPECIFIES THE TYPE OF EXPANSION              00042000
.*                         REQUIRED. VALID VALUES ARE -                 00043000
.*                         I  -  DEFAULT VALUE                          00044000
.*                         L                                            00045000
.*                         (E,[ADDR OF WPL])                            00046000
.*                         (E,[ADDR OF WPL],EXTENDED)                   00047000
.*                         THE THIRD MF PARAMETER MUST BE USED          00048000
.*                         WHEN THE TARGET WPL IS AN XWPL AND           00049000
.*                         THE WTOR REPLY FIELDS ARE PROVIDED TO        00050000
.*                         UPDATE THE TARGET XWPL                       00051000
.*                                                                      00052000
.*                TEXT=    FOR A WTOR THE FIRST PARAMETER               00053000
.*                         SPECIFIES A DATA AREA CONTAINING A 2         00054000
.*                         BYTE MESSAGE LENGTH FIELD FOLLOWED BY        00055000
.*                         THE ACTUAL MESSAGE TEXT. THE                 00056000
.*                         ADDITIONAL POSITIONAL PARAMETERS,            00057000
.*                         RYAD, LENGTH AND ECB ADDRESS MUST BE         00058000
.*                         SPECIFIED AS THE SECOND, THIRD AND           00059000
.*                         FOURTH POSITIONAL PARAMETERS ON THE          00060000
.*                         TEXT KEYWORD. REGISTER NOTATION CAN BE       00061000
.*                         USED FOR ALL THE FIELDS. IF USED, THE        00062000
.*                         REGISTER CONTAINS THE ADDRESS OF THE         00063000
.*                         DATA AREA. IF A FIELD IS USED, THE           00064000
.*                         ADDRESS OF THE FIELD IS STORED IN THE        00065000
.*                         EXTENDED WPL. THE TEXT KEYWORD IS            00066000
.*                         MUTUALLY EXCLUSIVE WITH INLINE MESSAGE       00067000
.*                         TEXT. EITHER TEXT OR INLINE TEXT (BUT        00068000
.*                         NOT BOTH) IS REQUIRED ON THE STANDARD        00069000
.*                         OR LIST FORM OF WTOR.                        00070000
.*                                                                      00071000
.*       FUNCTION - BUILDS ONE OF THREE POSSIBLE PARAMETER LIST         00072000
.*                  FORMATS AND/OR THE CODE WHICH WILL INVOKE           00073000
.*                  SVC 35 TO ISSUE THE MESSAGE.                        00074000
.*                  1. A STANDARD WPL IS BUILT IF INLINE TEXT IS        00075000
.*                     SPECIFIED AND NO ROUTING CODE GREATER THAN 16    00076000
.*                     IS SPECIFIED.                                    00077000
.*                  2. IF INLINE TEXT IS SPECIFIED AND A ROUTING CODE   00078000
.*                     GREATER THAN 16 IS SPECIFIED THEN AN EXTENDED    00079000
.*                     WPL VERSION 1 IS BUILT.                          00080000
.*                  3. IF THE TEXT OPERAND IS SPECIFIED THEN AN         00081000
.*                     EXTENDED WPL VERSION 2 IS GENERATED OR           00082000
.*                     ASSUMED AS THE TARGET OF AN MF=E SPECIFICATION.  00083000
.*                     THE ADDITIONAL POSITIONAL PARAMETERS,            00084000
.*                     RYAD, LENGTH AND ECB ADDRESS, MUST BE            00085000
.*                     SPECIFIED AS THE SECOND, THIRD AND               00086000
.*                     FOURTH POSITIONAL PARAMETERS ON THE              00087000
.*                     TEXT KEYWORD.                                    00088000
.*                     IF MF=(E,TARGET.... IS SPECIFIED, USE OF THE     00089000
.*                     MF=(E,TARGET,EXTENDED) KEYWORD IS OPTIONAL AS    00090000
.*                     SPECIFYING THE TEXT PARAMETER ASSUMES THE        00091000
.*                     USE OF AN EXTENDED WPL VERSION 2.                00092000
.*                                                                      00093000
.*       STATUS -                                                       00094000
.*       LASTUPD         = EBB1102  TYPE=ADD                            00095000
.*       LIBRARIES       = DISTLIB=AMACLIB                              00096000
.*       FMID            = EBB1102                                      00097000
.*       RMID            = EBB1102                                      00098000
.*       SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS       00099000
.*                         EBB1102  FUNCTION  00.000  MAC  ACC RGN      00100000
.*                                                                      00101000
.*       CHANGE ACTIVITY -                                              00102000
.*              ZP600040 - EXTENSIVE REVISION OF THE MACRO AND          00103000
.*                         SUPPORT FOR THE TEXT OPERAND WHICH           00104000
.*                         REQUIRES GENERATION OF AN EXTENDED WPL       00105000
.*                                                                      00106000
.********************************************************************** 00107000
         LCLA  &H,&I,&II,&N,&J,&K,&LEN,&LLCNT                           00108000
         LCLA  &NUMENT                 NUMBER OF SUBLIST ENTRIES        00109000
         LCLA  &LENENT                 L'ENTRY                          00110000
         LCLB  &SECONDL,&PAIR                                           00111000
         LCLC  &GNAME,&WORKT,&WORKA,&WORKL,&WORKE                       00112000
         LCLB  &RO(128),&DE(16),&MC(32),&MT(16)  FLAGS FOR THE FIELDS   00113000
         LCLC  &LOWNUM,&HIGHNUM        ROUTE RANGE NUMBERS              00114000
         LCLB  &GENRD                  GENERATE ROUT AND DESC FIELDS    00115000
         LCLB  &GENMT                  GENERATE MSGTYP FIELD            00116000
         LCLB  &GENXWPL                GENERATE AN XWPL                 00117000
         LCLA  &WPLXLEV                LEVEL OF XWPL TO GENERATE        00118000
         LCLB  &MTY,&MTN               FLAGS FOR MSGTYP PROCESSING      00119000
         ACTR  30000                                                    00120000
.*                                                                      00121000
.*       INITIALIZATION                                                 00122000
.*                                                                      00123000
&GNAME   SETC  'IHB'.'&SYSNDX'         FOR BAL INSTRUCTION              00124000
&WPLXLEV SETA  1                                                        00125000
.********************************************************************** 00126000
.*                                                                      00127000
.*       BEGIN PROCESSING PARAMETERS                                    00128000
.*                                                                      00129000
.********************************************************************** 00130000
.********************************************************************** 00131000
.*                                                                      00132000
.*        PROCESS ROUTING CODES                                         00133000
.*        DETERMINE IF ROUTING CODES HAVE BEEN SPECIFIED                00134000
.*                                                                      00135000
.*        ROUTING CODES 1-128 MAY BE SET HOWEVER FOR MVS 3.8 ONLY       00136000
.*        ONLY ROUTING CODES 1-16 WILL BE ACTIONED                      00137000
.*        ANY ROUTING CODE GREATER THAN 16 WILL BE IGNORED              00138000
.*        WITHOUT ERROR HOWEVER SPECIFYING A ROUTING CODE GREATER       00139000
.*        THAN 16 WILL CAUSE THE GENERATION OF AN EXTENDED FORMAT       00140000
.*        VERSION 1 WPL (XWPL).                                         00141000
.*                                                                      00142000
.********************************************************************** 00143000
         AIF   (T'&ROUTCDE EQ 'O').ENDROUT   ROUTING CODES SPECIFIED ?  00144000
&GENRD   SETB  1                    ROUTING CODES PRESENT               00145000
&I       SETA  1                    INITIALIZE LIST INDEX               00146000
&NUMENT  SETA  N'&ROUTCDE           TOTAL NUMBER OF ENTRIES IN &ROUTCDE 00147000
.*       ROUTING CODE LOOP                                              00148000
.ROULOOP ANOP                                                           00149000
&LENENT  SETA  K'&ROUTCDE(&I)       SET L'CURRENT ELEMENT               00150000
         AIF   (&LENENT EQ 0).BADENT  NULL ENTRY, ERROR                 00151000
         AIF   (T'&ROUTCDE(&I) EQ 'N').ROUVAL   SINGLE NUMERIC VALUE    00152000
.*                                                                      00153000
.*       RANGE OF ROUTING CODES HAS BEEN SPECIFIED                      00154000
.*                                                                      00155000
.*       SCAN FOR DASH SEPERATOR                                        00156000
.*                                                                      00157000
&II      SETA  1                    INITIALIZE ELEMENT INDEX            00158000
.DASHL   ANOP                       DASH SCANNING LOOP                  00159000
         AIF   ('&ROUTCDE(&I)'(&II,1) EQ '-').DASHFND                   00160000
&II      SETA  &II+1                INCREMENT ELEMENT INDEX             00161000
         AIF   (&II GE &LENENT).BADRANG   CHECK INDEX POSITION          00162000
         AGO   .DASHL               LOOP AROUND FOR NEXT CHAR           00163000
.*       FOUND A DASH SEPERATOR                                         00164000
.DASHFND ANOP                                                           00165000
         AIF   (&II EQ 1).BADRANG         DASH UP FRONT ? ERROR         00166000
         AIF   (&II EQ &LENENT).BADRANG   DASH AT THE END ? ERROR       00167000
&LOWNUM  SETC  '&ROUTCDE(&I)'(1,&II-1) SET FIRST NUMBER OF RANGE        00168000
&HIGHNUM SETC  '&ROUTCDE(&I)'(&II+1,&LENENT-&II) SET SECOND NUMBER      00169000
.*       FIRST NUMBER > LAST NUMBER ? ERROR                             00170000
         AIF   ('&LOWNUM' GT '&HIGHNUM').BADRANG                        00171000
.*       OUTSIDE THE RANGE OF VALID ROUTING CODES ? ERROR               00172000
         AIF   ('&LOWNUM' LT '1' OR '&LOWNUM' GT '128' OR              X00173000
               '&HIGHNUM' LT '1' OR '&HIGHNUM' GT '128').BADRANG        00174000
&J       SETA  &LOWNUM              INITIALIZE START OF RANGE           00175000
&K       SETA  &HIGHNUM             INITIALIZE END OF RANGE             00176000
.*       LOOP TO SET ON ROUTING CODES                                   00177000
.*       IF ALREADY SET ON THEN ERROR                                   00178000
.RANLOOP ANOP                                                           00179000
         AIF   (&RO(&J)).BADRANG                                        00180000
&RO(&J)  SETB  1                    SET ROUTING CODE &J ON              00181000
         AIF   (&J LT 17).RANLOPA                                       00182000
&GENXWPL SETB  1                    ANY VALUE > 16 FORCES A XWPL        00183000
.RANLOPA ANOP                                                           00184000
&J       SETA  &J+1                 INCREMENT LOOP INDEX                00185000
         AIF   (&J LE &K).RANLOOP   LOOP THROUGH RANGE                  00186000
.*       RANGE PROCESSED                                                00187000
         AGO   .NEXTROU             DETERMINE NEXT ROUTING CODE         00188000
.*                                                                      00189000
.*       ROUTING CODE VALUE HAS BEEN SPECIFIED. VERIFY THAT IT IS       00190000
.*       WITHIN THE PROPER RANGE AND, IF SO, SET THE CORRECT BIT        00191000
.*                                                                      00192000
.ROUVAL  ANOP                                                           00193000
&J       SETA  &ROUTCDE(&I)         GET NEXT ROUTING CODE VALUE         00194000
         AIF   (&J GE 1 AND &J LE 128).ROUOK   VALID VALUE ?            00195000
         MNOTE 4,'ROUTCDE &J IS AN INVALID ROUTING CODE'                00196000
         AGO   .NEXTROU                                                 00197000
.ROUOK   ANOP                       VALID ROUTING CODE SPECIFIED        00198000
         AIF   (&RO(&J)).BADRANG                                        00199000
&RO(&J)  SETB  1                    SET ROUTING CODE &J ON              00200000
         AIF   (&J LT 17).NEXTROU                                       00201000
.*       ROUTCDE GT 16 DOES NOT FORCE XWPL IF MF=E                      00202000
         AIF   ('&MF(1)' EQ 'E').NEXTROU                                00203000
&GENXWPL SETB  1                    ANY VALUE > 16 FORCES A XWPL        00204000
&MC(12)  SETB  1                    SET MCS FLAG FOR XWPL (WPLMCSFL)    00205000
&MC(21)  SETB  1                    WTOR WITH EXT PARM    (WPXWTOR)     00206000
         AGO   .NEXTROU             LOOP TO NEXT VALUE                  00207000
.*       A NULL ROUTING CODE HAS BEEN SPECIFIED                         00208000
.*       ISSUE AN MNOTE AND SKIP TO THE NEXT ROUTING CODE               00209000
.BADENT  ANOP                                                           00210000
         MNOTE 4,'NULL ROUTING CODE SPECIFIED'                          00211000
         AGO   .NEXTROU                                                 00212000
.*       AN INVALID ROUTING CODE RANGE HAS BEEN SPECIFIED               00213000
.*       ISSUE AN MNOTE AND SKIP TO THE NEXT ROUTING CODE               00214000
.BADRANG ANOP                                                           00215000
         MNOTE 4,'INVALID RANGE OF ROUTING CODES IGNORED'               00216000
.*       FALL THROUGH TO SETUP FOR NEXT VALUE                           00217000
.*                                                                      00218000
.*       SETUP TO PROCESS NEXT ROUTE CODE ENTRY                         00219000
.NEXTROU ANOP                                                           00220000
&I       SETA  &I+1                 INCREMENT INDEX TO ROUT CODE VALUES 00221000
         AIF   (&I LE &NUMENT).ROULOOP IF MORE CODES, CHECK NEXT ONE    00222000
.ENDROUT ANOP                       DONE WITH ROUTING CODES             00223000
.********************************************************************** 00224000
.*                                                                      00225000
.*       PROCESS DESCRIPTOR CODES                                       00226000
.*       DETERMINE IF DESCRIPTOR CODES HAVE BEEN SPECIFIED              00227000
.*                                                                      00228000
.********************************************************************** 00229000
         AIF   (T'&DESC EQ 'O').ENDDESC   NO DESCRIPTOR, BRANCH         00230000
&NUMENT  SETA  N'&DESC           NUMBER OF ENTRIES                      00231000
&I       SETA  1                                                        00232000
&J       SETA  0                 COUNTER TO DETECT MUTUALLY EXCL VALUE  00233000
.DESCLOP ANOP                                                           00234000
&II      SETA  &DESC(&I)                                                00235000
         AIF   (&II GE 1 AND &II LE 16).DESCOK                          00236000
.DESCERR MNOTE 8,'DESC &N IS INVALID DESCRIPTOR - IGNORED'              00237000
         AGO   .NEXTDES                                                 00238000
.DESCOK  ANOP                                                           00239000
         AIF   (&DE(&II)).DESERR             ALREADY SPECIFIED          00240000
         AIF   (&II GT 6).DESCJMP                                       00241000
&J       SETA  &J+1                         A VALUE LOWER THAN 7 SPEC   00242000
.DESCJMP ANOP                                                           00243000
&DE(&II) SETB  1                                                        00244000
.NEXTDES ANOP                                                           00245000
&I       SETA  &I+1                         INCR ENTRY COUNTER          00246000
         AIF   (&I LE &NUMENT).DESCLOP      PROCESS NEXT ENTRY          00247000
.*       ALL ENTRIES PROCESSED                                          00248000
.*       TEST FOR ANY MUTUALLY EXCLUSIVE ENTRIES                        00249000
         AIF   (&J EQ 1).ENDDESC            ALL OK                      00250000
         MNOTE 8,'DESC MUTUALLY EXCLUSIVE VALUE SPECIFIED'              00251000
         MEXIT                                                          00252000
.DESERR  MNOTE 8,'DUPLICATE DESCRIPTOR VALUE SPECIFIED'                 00253000
         MEXIT                                                          00254000
.ENDDESC ANOP                                                           00255000
.********************************************************************** 00256000
.*                                                                      00257000
.*       PROCESS MSGTYP PARAMETERS                                      00258000
.*       DETERMINE IF MSGTYP PARAMETERS HAVE BEEN SPECIFIED             00259000
.*       PARAMETERS -                                                   00260000
.*       Y        - GENERATES MSGTYP FIELD BUT IGNORES OTHER            00261000
.*                  PARAMETERS (ALL MSGTYP FLAGS ZERO)                  00262000
.*                  THIS MUST BE THE FIRST PARAMETER                    00263000
.*       N        - SUPPESSSES THE GENERATION OF THE MSGTYP             00264000
.*                  FIELD EVEN THOUGH OTHER PARAMETERS HAVE BEEN        00265000
.*                  SPECIFIED                                           00266000
.*                  THIS MUST BE THE FIRST PARAMETER                    00267000
.*       JOBNAMES -                                                     00268000
.*       STATUS   -                                                     00269000
.*       ACTIVE   -                                                     00270000
.*       SHOW     - FOR VS/1 CRJE SUPPORT                               00271000
.*       SESS     -                                                     00272000
.*       NOTE THAT THE MSGTYP FIELD WILL BE GENERATED AND THE           00273000
.*       WPLMSGTD FLAG WILL BE SET IF THE QID PARAMETER IS              00274000
.*       CODED ON THE WTO MACRO                                         00275000
.*                                                                      00276000
.********************************************************************** 00277000
         AIF   (T'&MSGTYP EQ 'O').ENDMSGT   MSGTYP PARAMS SPECIFIED ?   00278000
&GENRD   SETB  1                            MSGTYPE CAUSED ROUT/DESC    00279000
&NUMENT  SETA  N'&MSGTYP                    NUMBER OF ENTRIES           00280000
         AIF   ('&MSGTYP(1)' NE 'N').MSGL1                              00281000
&MTN     SETB  1                            MSGTYP=N CODED              00282000
         AGO   .MSGL2                                                   00283000
.MSGL1   AIF   ('&MSGTYP(1)' NE 'Y').MSGL3  MSGTYP=Y CODED              00284000
&MTY     SETB  1                                                        00285000
.MSGL2   ANOP                               EITHER MSGTYP =Y/N CODED    00286000
&I       SETA  1                            FIRST PARAMETER PROCESSED   00287000
         AGO   .NEXTMSG                                                 00288000
.MSGL3   ANOP                                                           00289000
&I       SETA  0                                                        00290000
         AGO   .NEXTMSG                                                 00291000
.MSGTLOP ANOP                               LOOP THROUGH PARAMETERS     00292000
         AIF   ('&MSGTYP(&I)' NE 'JOBNAMES').MSGL4                      00293000
         AIF   (&MT(1)).MTERR               JOBNAMES ALREADY CODED ?    00294000
&MT(1)   SETB  1                            TURN ON JOBNAMES            00295000
         AGO   .NEXTMSG                                                 00296000
.MSGL4   ANOP                                                           00297000
         AIF   ('&MSGTYP(&I)' NE 'STATUS').MSGL5                        00298000
         AIF   (&MT(2)).MTERR               STATUS ALREADY CODED ?      00299000
&MT(2)   SETB  1                            TURN ON STATUS              00300000
         AGO   .NEXTMSG                                                 00301000
.MSGL5   ANOP                                                           00302000
         AIF   ('&MSGTYP(&I)' NE 'ACTIVE').MSGL6                        00303000
         AIF   (&MT(3)).MTERR               ACTIVE ALREADY CODED ?      00304000
&MT(3)   SETB  1                            TURN ON ACTIVE              00305000
         AGO   .NEXTMSG                                                 00306000
.MSGL6   ANOP                                                           00307000
         AIF   ('&MSGTYP(&I)' NE 'SHOW').MSGL7                          00308000
         AIF   (&MT(5)).MTERR               SHOW ALREADY CODED ?        00309000
&MT(5)   SETB  1                            TURN ON SHOW                00310000
         AGO   .NEXTMSG                                                 00311000
.MSGL7   ANOP                                                           00312000
         AIF   ('&MSGTYP(&I)' NE 'SESS').MTERR                          00313000
         AIF   (&MT(6)).MTERR               SESS ALREADY CODED ?        00314000
&MT(6)   SETB  1                            TURN ON SESS                00315000
.NEXTMSG ANOP                                                           00316000
&GENMT   SETB  1                            GENERATE MSGTYP FIELD       00317000
&I       SETA  &I+1                         INCR ENTRY COUNTER          00318000
         AIF   (&I LE &NUMENT).MSGTLOP      PROCESS NEXT ENTRY          00319000
.*       ALL ENTRIES PROCESSED                                          00320000
.*       PROCESS FLAGS                                                  00321000
&GENMT   SETB  (NOT &MTN)                   SUPRESS MT GEN IF MSGTYP=N  00322000
         AIF   (&MTN OR &MTY).MSGL8                                     00323000
         AGO   .ENDMSGT                                                 00324000
.*       ERROR PROCESSING                                               00325000
.MTERR   MNOTE 8,'MESSAGE TYPE FIELD INVALID - N IS ASSUMED'            00326000
&MTN     SETB  1                                                        00327000
&MTY     SETB  0                                                        00328000
.MSGL8   ANOP                               TURN OFF ALL FLAGS          00329000
&MT(1)   SETB  0                                                        00330000
&MT(2)   SETB  0                                                        00331000
&MT(3)   SETB  0                                                        00332000
&MT(5)   SETB  0                                                        00333000
&MT(6)   SETB  0                                                        00334000
.ENDMSGT ANOP                                                           00335000
.********************************************************************** 00336000
.*                                                                      00337000
.*       PROCESS MCSFLAG PARAMETERS                                     00338000
.*       DETERMINE IF MCSFLAG PARAMETERS HAVE BEEN SPECIFIED            00339000
.*       PARAMETERS -                                                   00340000
.*       REG0     - MSG TO CONSOLE WITH SOURCE ID IN R0                 00341000
.*       RESP     - WTO IS IMMEDIATE COMMAND RESPONSE                   00342000
.*       REPLY    - WTO IS A REPLY TO A WTOR                            00343000
.*       BRDCAST  - MSG TO BE BROADCAST TO ALL ACTIVE CONSOLES          00344000
.*       HRDCOPY  - MSG TO BE QUEUED FOR HARDCOPY ONLY                  00345000
.*       QREG0    - MSG TO BE QUEUED UNCONDITIONALLY TO CON ID IN R0    00346000
.*       NOTIME   - TIME IS NOT TO BE APPENDED TO MSG  TER              00347000
.*       NOCPY    - IF WTO OR WTOR IS ISSUED IN SUPERVISOR STATE        00348000
.*                  THEN DO NOT QUEUE FOR HARDCOPY                      00349000
.*                                                                      00350000
.********************************************************************** 00351000
         AIF   (T'&MCSFLAG EQ 'O').ENDMCS    MCSFLAG PARAMS SPECIFIED ? 00352000
&I       SETA  1                    SET LIST INDEX                      00353000
&NUMENT  SETA  N'&MCSFLAG           NUMBER OF ENTRIES                   00354000
.MCLOOP  ANOP                       START LOOP THROUGH PARAMETERS       00355000
         AIF   ('&MCSFLAG(&I)' NE 'REG0').MCL1                          00356000
         AIF   (&MC(2)).MCERR       REG0 ALREADY CODED ?                00357000
&MC(2)   SETB  1                    TURN ON REG0 (WPLMCSFB)             00358000
         AGO   .NEXTMC                                                  00359000
.MCL1    ANOP                                                           00360000
         AIF   ('&MCSFLAG(&I)' NE 'RESP').MCL2                          00361000
         AIF   (&MC(3)).MCERR       RESP ALREADY CODED ?                00362000
&MC(3)   SETB  1                    TURN ON RESP (WPLMCSFC)             00363000
         AGO   .NEXTMC                                                  00364000
.MCL2    ANOP                                                           00365000
         AIF   ('&MCSFLAG(&I)' NE 'REPLY').MCL3                         00366000
         AIF   (&MC(5)).MCERR       REPLYG0 ALREADY CODED ?             00367000
&MC(5)   SETB  1                    TURN ON REPLY (WPLMCSFE)            00368000
         AGO   .NEXTMC                                                  00369000
.MCL3    ANOP                                                           00370000
         AIF   ('&MCSFLAG(&I)' NE 'BRDCAST').MCL4                       00371000
         AIF   (&MC(6)).MCERR       BRDCAST ALREADY CODED ?             00372000
&MC(6)   SETB  1                    TURN ON BRDCAST (WPLMCSFF)          00373000
         AGO   .NEXTMC                                                  00374000
.MCL4    ANOP                                                           00375000
         AIF   ('&MCSFLAG(&I)' NE 'HRDCPY').MCL5                        00376000
         AIF   (&MC(7)).MCERR       HRDCPY ALREADY CODED ?              00377000
&MC(7)   SETB  1                    TURN ON HRDCPY (WPLMCSFG)           00378000
         AGO   .NEXTMC                                                  00379000
.MCL5    ANOP                                                           00380000
         AIF   ('&MCSFLAG(&I)' NE 'QREG0').MCL6                         00381000
         AIF   (&MC(8)).MCERR       QREG0 ALREADY CODED ?               00382000
&MC(8)   SETB  1                    TURN ON QREG0 (WPLMCSFH)            00383000
         AGO   .NEXTMC                                                  00384000
.MCL6    ANOP                                                           00385000
         AIF   ('&MCSFLAG(&I)' NE 'NOTIME').MCL7                        00386000
         AIF   (&MC(9)).MCERR       NOTIME ALREADY CODED ?              00387000
&MC(9)   SETB  1                    TURN ON NOTIME (WPLMCSFI)           00388000
         AGO   .NEXTMC                                                  00389000
.MCL7    ANOP                                                           00390000
         AIF   ('&MCSFLAG(&I)' NE 'NOCPY').MCERR                        00391000
         AIF   (&MC(14)).MCERR      NOTIME ALREADY CODED ?              00392000
&MC(14)  SETB  1                    TURN ON NOTTIME (WPLMCSFN)          00393000
         AGO   .NEXTMC                                                  00394000
.MCERR   ANOP                                                           00395000
         MNOTE 8,'&MCSFLAG(&I) IS INVALID - IGNORED'                    00396000
.NEXTMC  ANOP                       INCR ENTRY INDEX                    00397000
&I       SETA  &I+1                                                     00398000
         AIF   (&I LE &NUMENT).MCLOOP                                   00399000
.*       TEST FOR ERRORS                                                00400000
         AIF   (&MC(7) AND &MC(14)).MCEXCL    HRDCOPY AND NOCPY ?       00401000
         AGO   .ENDMCS                                                  00402000
.MCEXCL  MNOTE 8,'HRDCPY AND NOCPY MUTUALLY EXCLUSIVE, HRDCPY ASSUMED'  00403000
&MC(14)  SETB  0                      TURN OFF NOCPY                    00404000
.ENDMCS  ANOP                                                           00405000
.********************************************************************** 00406000
.*                                                                      00407000
.*       ALL PARAMETERS EXCEPT MESSAGE TEXT AND MF HAVE BEEN PROCESSED  00408000
.*       PROCESS ANY PARAMETER INTERACTIONS                             00409000
.*                                                                      00410000
.********************************************************************** 00411000
.*       DETERMINE IF A DEFAULT ROUTING CODE OF 2 HAS TO BE SET         00412000
         AIF   (&GENRD).INT1        ROUTCDE SPECIFIED, BRANCH           00413000
         AIF   (NOT &GENMT).INT1    NO MSGTYP, BRANCH                   00414000
         AIF   (&MC(2) OR &MC(8)).INT1   MCS REG0 OR QREG0 CODED ?      00415000
.*       SET A DEFAULT ROUTING CODE OF 2                                00416000
&GENRD   SETB  1                                                        00417000
&RO(2)   SETB  1                                                        00418000
.INT1    ANOP                                                           00419000
.*       QID FORCES GENERATION OF DESC AND ROUTE FIELDS                 00420000
&GENRD   SETB  (&GENRD OR (T'&QID NE 'O'))                              00421000
.*       DETERMINE IF THE MCS FLAG FOR ROUT/DESC PRESENT SHOULD BE ON   00422000
&MC(1)   SETB  (&GENRD)                                                 00423000
.*       DETERMINE IF MCS FLAG FOR MSGTYP PRESENT SHOULD BE ON          00424000
&MC(4)   SETB  (&GENMT)                                                 00425000
.********************************************************************** 00426000
.*                                                                      00427000
.*       DETERMINE SOURCE OF TEXT FOR MESSAGE                           00428000
.*                                                                      00429000
.********************************************************************** 00430000
.*       TEST &MESG FOR MULTI-LINE                                      00431000
.*       MULTI-LINE WTOR NOT SUPPORTED                                  00432000
         AIF   ((N'&SYSLIST(1) EQ 0) OR (N'&SYSLIST(1) EQ 1)).INT1A     00433000
         AGO   .ERROR7                 GENERATE MSG MLWTO/WTOR ERROR    00434000
.INT1A   ANOP                                                           00435000
.*       MESSAGE TEXT AND INLINE TEXT ARE MUTUALLY EXCLUSIVE            00436000
.*       ISSUE ERROR MESSAGE IF BOTH PROVIDED                           00437000
         AIF   (('&TEXT' NE '^') AND ('&MESG' NE '')).ERROR9            00438000
.*       EITHER MESG OR TEXT MUST BE SPECIFIED UNLESS MF=E              00439000
.INT3    AIF   ('&MF(1)' EQ 'E').INT5                                   00440000
         AIF   (('&MESG' EQ '') AND ('&TEXT' EQ '^')).INT4              00441000
         AGO   .INT5                                                    00442000
.INT4    MNOTE 12,'NO INLINE MESSAGE TEXT OR TEXT PARAMETER SPECIFIED'  00443000
         MEXIT                                                          00444000
.INT5    ANOP                                                           00445000
.*       USE OF TEXT= PARAMETER FORCES GENERATION OF TYPE 2 XWPL        00446000
         AIF   ('&TEXT' EQ '^').INT6                                    00447000
&GENXWPL SETB  1                       GENERATE AN XWPL                 00448000
&WPLXLEV SETA  2                       LEVEL OF XWPL TO GENERATE        00449000
&MC(12)  SETB  1                       SET MCS FLAG FOR XWPL (WPLMCSFL) 00450000
&MC(21)  SETB  1                       WTOR WITH EXT PARM  (WPXWTOR)    00451000
&MC(25)  SETB  1                       TEXT ADDR SPECIFIED (WPXTXTAD)   00452000
.********************************************************************** 00453000
.*                                                                      00454000
.*       PROCESS MF PARAMETER                                           00455000
.*                                                                      00456000
.********************************************************************** 00457000
.INT6    AIF    ('&MF' EQ 'I' OR '&MF' EQ 'L').WPLGEN                   00458000
.*                                                                      00459000
.*       MF=(E,X) PROCESSING                                            00460000
.*                                                                      00461000
         AIF   ('&MF(1)' NE 'E').ERROR1    CONFIRM THAT IT IS MF=E      00462000
         AIF   (N'&MF EQ 2).MFE5                                        00463000
         AIF   ((N'&MF EQ 3) AND ('&MF(3)' NE 'EXTENDED')).ERROR1       00464000
&GENXWPL SETB  ((N'&MF EQ 3) AND ('&MF(3)' EQ 'EXTENDED'))              00465000
&MC(12)  SETB  1                    SET MCS FLAG FOR XWPL (WPLMCSFL)    00466000
&MC(21)  SETB  1                       WTOR WITH EXT PARM  (WPXWTOR)    00467000
.MFE5    ANOP                                                           00468000
&NAME    IHBINNRA &MF(2)            GENERATE INITIAL LR OR LA IF NEEDED 00469000
         AIF   (&GENXWPL).MFE6                                          00470000
.*       PROCESS STANDARD WPL FOR MF=E WTOR                             00471000
         AIF   ('&RYAD' EQ '').MFE6A                                    00472000
         AIF   ('&LENGTH' NE '').MFE6B                                  00473000
         IC    14,0(1,0)                SAVE REPLY LENGTH               00474000
.MFE6B   AIF   ('&RYAD'(1,1) EQ '(').MFE6C                              00475000
         LA    15,&RYAD                 LOAD REPLY ADDR                 00476000
         ST    15,0(1,0)                STORE RPLY ADDR                 00477000
         AGO   .MFE6H                                                   00478000
         ANOP                                                           00479000
.MFE6C   ST    &RYAD(1),0(1,0)          STORE REPLY ADDR                00480000
.MFE6H   AIF   ('&LENGTH' NE '').MFE6E                                  00481000
         STC   14,0(1,0)                RESTORE REPLY LENGTH            00482000
         AGO   .MFE6G                                                   00483000
.MFE6E   AIF   ('&LENGTH'(1,1) EQ '(').MFE6D                            00484000
         MVI   0(1),&LENGTH             MOVE IN REPLY LENGTH            00485000
         AGO   .MFE6G                                                   00486000
.MFE6D   STC   &LENGTH(1),0(1,0)        STORE REPLY LENGTH              00487000
         AGO   .MFE6G                                                   00488000
.MFE6A   AIF   ('&LENGTH' NE '').MFE6E                                  00489000
.MFE6G   AIF   ('&ECB' EQ '').MFE6Z                                     00490000
         AIF   ('&ECB'(1,1) EQ '(').MFE6F                               00491000
         LA    14,&ECB                  LOAD ADDRESS OF ECB             00492000
         ST    14,4(1,0)                STORE ECB ADDRESS               00493000
         AGO   .MFE6Z                                                   00494000
.MFE6F   ST    &ECB(1),4(1,0)           STORE ECB ADDRESS               00495000
.MFE6Z   AGO   .MFESVC                                                  00496000
.*       PROCESS XWPL FOR MF=E WTOR                                     00497000
.*       EITHER USE OF A PARAMETER OR PROVIDING MF=(E,..,EXTENDED) HAS  00498000
.*       FORCED USE OF AN XWPL                                          00499000
.*       UPDATE MCS FLAGS                                               00500000
         OI    2(1),B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)'X00501000
                                        MCS FLAGS                       00502000
         OI    3(1),B'&MC(9)&MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&X00503000
               MC(16)'                  MCS FLAGS                       00504000
.MFE6    ANOP                                                           00505000
         AIF   ('&TEXT' EQ '^').MFE1A                                   00506000
         AIF   ('&TEXT' EQ '').ERROR2   TEXT= CANNOT BE NULL            00507000
&WORKT   SETC  '&TEXT(1)'                                               00508000
         AIF   ('&WORKT'(1,1) EQ '(').MFE2   TEXT=REG ?                 00509000
         LA    15,&WORKT                R15 -> TEXT                     00510000
         ST    15,4(,1)                 STORE TEXT ADDR INTO XWPL       00511000
         AGO   .MFE1                                                    00512000
.MFE2    ANOP                                                           00513000
&I       SETA  K'&WORKT                                                 00514000
&WORKT   SETC  '&WORKT'(2,&I-2)         ASSIGN REGISTER NOTATION        00515000
         ST    &WORKT,4(,1)             STORE TEXT ADDR INTO XWPL       00516000
.*       TEXT= PARAMETER HAS BEEN PROVIDED. THE SECOND, THIRD AND       00517000
.*       FORTH POSITIONAL PARAMETERS MUST NOT BE PROVIDED               00518000
.MFE1    AIF   (('&RYAD' NE '') OR ('&LENGTH' NE '') OR                X00519000
               ('&ECB' NE '')).ERROR6                                   00520000
&WORKA   SETC  '&TEXT(2)'               XWPL VERSION 2                  00521000
&WORKL   SETC  '&TEXT(3)'               XWPL VERSION 2                  00522000
&WORKE   SETC  '&TEXT(4)'               XWPL VERSION 2                  00523000
         AGO   .MFE1B                                                   00524000
.*       PROCESS XWPL VERSION 1 WTOR PARAMETERS                         00525000
.MFE1A   ANOP                                                           00526000
&WORKA   SETC  '&RYAD'                  XWPL VERSION 1                  00527000
&WORKL   SETC  '&LENGTH'                XWPL VERSION 1                  00528000
&WORKE   SETC  '&ECB'                   XWPL VERSION 1                  00529000
.MFE1B   ANOP                                                           00530000
.*       ANY NEED TO UPDATE ADDITIONAL WPLX FIELDS ?                    00531000
         AIF   ((NOT &GENRD) AND (NOT &GENMT) AND (NOT &MC(25))        X00532000
               AND ('&WORKA' EQ '') AND ('&WORKL' EQ '') AND           X00533000
               ('&WORKE' EQ '')).MFESVC  EXIT TO SVC                    00534000
         LA    14,0(,1)                                                 00535000
         AH    14,0(,14)            ADD L'TEXT + LEN FIELD + MCS FIELD  00536000
         AIF   ('&WORKL' EQ '').MFE1C   L'REPLY PROVIDED ?              00537000
         AIF   ('&WORKL'(1,1) EQ '(').MFE1D   REGISTER NOTATION ?       00538000
         MVI   2(14),&WORKL             STORE REPLY LENGTH              00539000
         AGO   .MFE1C                                                   00540000
.MFE1D   ANOP                                                           00541000
&I       SETA  K'&WORKL                                                 00542000
&WORKL   SETC  '&WORKL'(2,&I-2)         ASSIGN REGISTER NOTATION        00543000
         STC   &WORKL,2(,14)            STORE REPLY LENGTH              00544000
.MFE1C   ANOP                                                           00545000
         AIF   ('&TEXT' EQ '^').MFE4    NEED TO SET EXTENDED MCS ?      00546000
         OI    4(14),B'&MC(17)&MC(18)&MC(19)&MC(20)&MC(21)&MC(22)&MC(23X00547000
               )&MC(24)'                EXTENDED MCS                    00548000
         OI    5(14),B'&MC(25)&MC(26)&MC(27)&MC(28)&MC(29)&MC(30)&MC(31X00549000
               )&MC(32)'                EXTENDED MCS                    00550000
.MFE4    AIF   ('&WORKA' EQ '').MFE4A   REPLY ADDRESS PROVIDED ?        00551000
         AIF   ('&WORKA'(1,1) EQ '(').MFE4D   REGISTER NOTATION ?       00552000
         LA    15,&WORKA                15 -> REPLY ADDRESS             00553000
         ST    15,8(,14)                STORE REPLY ADDR                00554000
         AGO   .MFE4A                                                   00555000
.MFE4D   ANOP                                                           00556000
&I       SETA  K'&WORKA                                                 00557000
&WORKA   SETC  '&WORKA'(2,&I-2)                                         00558000
         ST    &WORKA,8(,14)            STORE REPLY ADDR                00559000
.*                                                                      00560000
.MFE4A   AIF   ('&WORKE' EQ '').MFE4G   ECB ADDRESS PROVIDED ?          00561000
         AIF   ('&WORKE'(1,1) EQ '(').MFE4F   REGISTER NOTATION ?       00562000
         LA    15,&WORKE                15 -> ECB ADDRESS               00563000
         ST    15,12(,14)               STORE ECB ADDR                  00564000
         AGO   .MFE4G                                                   00565000
.MFE4F   ANOP                                                           00566000
&I       SETA  K'&WORKE                                                 00567000
&WORKE   SETC  '&WORKE'(2,&I-2)                                         00568000
         ST    &WORKE,12(,14)           STORE ECB ADDR                  00569000
.*                                                                      00570000
.MFE4G   AIF   (NOT &GENMT).MFESVC      NEED TO GEN MSGTYP FLAGS ?      00571000
         MVI   40(14),B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8X00572000
               )'                       MSGTYP                          00573000
         MVI   41(14),B'&MT(9)&MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15X00574000
               )&MT(16)'                MSGTYP                          00575000
.MFE3    AIF   (NOT &GENRD).MFESVC      NEED TO GEN ROUTE/DESC ?        00576000
         MVI   20(14),B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8X00577000
               )'                       DESCRIPTOR CODES                00578000
         MVI   21(14),B'&DE(9)&DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15X00579000
               )&DE(16)'                DESCRIPTOR CODES                00580000
         MVI   24(14),B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8X00581000
               )'                       ROUTING CODES                   00582000
         MVI   25(14),B'&RO(9)&RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15X00583000
               )&RO(16)'                ROUTING CODES                   00584000
.MFESVC  ANOP                                                           00585000
         SVC   35                                                       00586000
         MEXIT                      EXIT MACRO, PROCESSING COMPLETE     00587000
.********************************************************************** 00588000
.*                                                                      00589000
.*       MF=I AND MF=L PROCESSING                                       00590000
.*                                                                      00591000
.*       GENERATE A STANDARD WPL OR AN XWPL VERSION 1 OR VERSION 2      00592000
.*       DEPENDING ON PARAMETERS PROVIDED                               00593000
.*                                                                      00594000
.********************************************************************** 00595000
.WPLGEN  ANOP                                                           00596000
         AIF   ('&MF' EQ 'L').DCNAME                                    00597000
.*       MF=I PROCESSING                                                00598000
         CNOP  0,4                                                      00599000
&NAME    BAL   1,&GNAME.A                                               00600000
         AGO   .MFIL01                                                  00601000
.*       MF=L PROCESSING                                                00602000
.DCNAME  ANOP                                                           00603000
&NAME    DC    0F'0'                                                    00604000
.MFIL01  ANOP                                                           00605000
         AIF   (&GENXWPL).XWPL01         GO GENERATE XWPL               00606000
.********************************************************************** 00607000
.*                                                                      00608000
.*       GENERATE STANDARD WPL FOR MF=I OR MF=L                         00609000
.*                                                                      00610000
.********************************************************************** 00611000
.*       LENGTH MUST BE PROVIDED FOR MF=I                               00612000
         AIF   (('&LENGTH' EQ '') AND ('&MF' EQ 'I')).ERROR4            00613000
         AIF   (('&LENGTH' EQ '') AND ('&MF' EQ 'L')).MFIL02            00614000
         AIF   ('&LENGTH'(1,1) EQ '(').MFIL02                           00615000
         DC    AL1(&LENGTH)             REPLY LENGTH                    00616000
         AGO   .MFIL03                                                  00617000
.MFIL02  DC    AL1(0)                   REPLY LENGTH                    00618000
.*       REPLY ADDR MUST BE PROVIDED FOR MF=I                           00619000
.MFIL03  AIF   (('&RYAD' EQ '') AND ('&MF' EQ 'I')).ERROR5              00620000
         AIF   (('&RYAD' EQ '') AND ('&MF' EQ 'L')).MFIL04              00621000
         AIF   ('&RYAD'(1,1) EQ '(').MFIL04                             00622000
         DC    AL3(&RYAD)               REPLY ADDRESS                   00623000
         AGO   .MFIL05                                                  00624000
.MFIL04  DC    AL3(0)                   REPLY ADDRESS                   00625000
.*       ECB ADDR MUST BE PROVIDED FOR MF=I                             00626000
.MFIL05  AIF   (('&ECB' EQ '') AND ('&MF' EQ 'I')).ERROR6               00627000
         AIF   (('&ECB' EQ '') AND ('&MF' EQ 'L')).MFIL06               00628000
         AIF   ('&ECB'(1,1) EQ '(').MFIL06                              00629000
         DC    A(&ECB)                  ECB ADDRESS                     00630000
         AGO   .MFIL07                                                  00631000
.MFIL06  DC    A(0)                     ECB ADDRESS                     00632000
.MFIL07  ANOP                                                           00633000
.*       GENERATE INLINE MESSAGE TEXT                                   00634000
&I       SETA  1                                                        00635000
&LEN     SETA  K'&SYSLIST(1,1)-2                                        00636000
&PAIR    SETB  0                                                        00637000
.QLOOP1  ANOP                                                           00638000
&I       SETA  &I+1+&PAIR                                               00639000
         AIF   (&I GE K'&SYSLIST(1,1)).QDONE1                           00640000
&PAIR    SETB  ('&SYSLIST(1,1)'(&I,2) EQ '''''' OR '&SYSLIST(1,1)'(&I,2X00641000
               ) EQ '&&')                                               00642000
&LEN     SETA  &LEN-&PAIR                                               00643000
         AGO   .QLOOP1                                                  00644000
.QDONE1  ANOP                                                           00645000
&LEN     SETA  4+&LEN                                                   00646000
         DC    AL2(&LEN)                TEXT LENGTH                     00647000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00648000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00649000
                                        MCS FLAGS                       00650000
         AIF   (&LEN EQ 4).MFE6BDC                                      00651000
         DC    C&SYSLIST(1,1)           MESSAGE TEXT                    00652000
.*       GENERATE FLAG BYTES                                            00653000
.MFE6BDC AIF   (NOT &GENRD).MFIL08      GENERATING ROUT/DESC/MSGTYP ?   00654000
         DC    B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8)&DE(9)X00655000
               &DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15)&DE(16)'      X00656000
                                        DESCRIPTOR CODES                00657000
         DC    B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8)&RO(9)X00658000
               &RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15)&RO(16)'      X00659000
                                        ROUTING CODES                   00660000
         AIF   (NOT &GENMT).MFIL08      GENERATING MSGTYP ?             00661000
         DC    B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8)&MT(9)X00662000
               &MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15)&MT(16)'      X00663000
                                        MSGTYP                          00664000
                                                                        00665000
.MFIL08  ANOP                                                           00666000
         AIF   ('&MF' EQ 'I').MFIL09                                    00667000
.*       MF=L, ENSURE NO REGISTER VALUES HAVE BEEN PROVIDED             00668000
         AIF   ('&RYAD' EQ '').MFIL08A                                  00669000
         AIF   ('&RYAD'(1,1) EQ '(').ERROR3                             00670000
.MFIL08A AIF   ('&LENGTH' EQ '').MFIL08B                                00671000
         AIF   ('&LENGTH'(1,1) EQ '(').ERROR3                           00672000
.MFIL08B AIF   ('&ECB' EQ '').MFIL08C                                   00673000
         AIF   ('&ECB'(1,1) EQ '(').ERROR3                              00674000
.MFIL08C MEXIT                                                          00675000
.*       MF=I, STORE ANY VALUES PROVIDED IN REGISTERS                   00676000
.MFIL09  ANOP                                                           00677000
&GNAME.A DS    0H                                                       00678000
         AIF   ('&RYAD'(1,1) NE '(').MFIL10                             00679000
         AIF   ('&LENGTH'(1,1) EQ '(').MFIL11                           00680000
         IC    14,0(1,0)                SAVE REPLY LENGTH               00681000
         ST    &RYAD(1),0(1,0)          STORE REPLY ADDRESS             00682000
         STC   14,0(1,0)                RESTORE REPLY LENGTH            00683000
         AGO   .MFIL12                                                  00684000
.MFIL11  ST    &RYAD(1),0(1,0)          STORE REPLY ADDRESS             00685000
.MFIL13  STC   &LENGTH(1),0(1,0)        STORE REPLY LENGTH              00686000
         AGO   .MFIL12                                                  00687000
.MFIL10  AIF   ('&LENGTH'(1,1) EQ '(').MFIL13                           00688000
.MFIL12  AIF   ('&ECB'(1,1) NE '(').MFIL14                              00689000
         ST    &ECB(1),4(1,0)           STORE ECB ADDRESS               00690000
.MFIL14  SVC   35                                                       00691000
         MEXIT                                                          00692000
.********************************************************************** 00693000
.*                                                                      00694000
.*       GENERATE XWPL VERSION 1 OR VERSION 2 FOR WTOR                  00695000
.*                                                                      00696000
.********************************************************************** 00697000
.*                                                                      00698000
.*       A VERSION 1 XWPL WILL BE GENERATED IF INLINE TEXT IS           00699000
.*       PROVIDED. THE WTOR MACRO POSITIONAL PARAMETERS OF &RYAD,       00700000
.*       &LENGTH AND &ECB WILL BE PLACED IN THE VERSION 1 XWPL FIELDS   00701000
.*       IF THE TEXT= PARAMETER IS PROVIDED THEN A VERSION 2 XWPL       00702000
.*       WILL BE GENERATED. THE &RYAD, &LENGTH AND &ECB FIELDS          00703000
.*       MUST BE PROVIDED AS SUB-PARAMETERS IN THE TEXT= PARAMETER.     00704000
.*       THE POSITIONAL PARAMETERS &RYAD, &LENGTH AND &ECB MUST NOT     00705000
.*       BE PROVIDED.                                                   00706000
.*                                                                      00707000
.XWPL01  AIF   ('&TEXT' NE '^').XWPL04     HAVE TEXT= PARM TO PROCESS ? 00708000
.*       GENERATE INLINE TEXT FOR A XWPL VERSION 1                      00709000
.XWPL01A ANOP                                                           00710000
&I       SETA  1                                                        00711000
&LEN     SETA  K'&SYSLIST(1,1)-2    L'TEXT                              00712000
&PAIR    SETB  0                                                        00713000
.*       LOOP THROUGH TEXT STRING AND PROCESS DUPLICATE QUOTES AND      00714000
.*       AMPERSANDS                                                     00715000
.XWPL02  ANOP                                                           00716000
&I       SETA  &I+1+&PAIR                                               00717000
         AIF   (&I GE K'&SYSLIST(1,1)).XWPL03   GOTO LOOP EXIT          00718000
&PAIR    SETB  ('&SYSLIST(1,1)'(&I,2) EQ '''''' OR '&SYSLIST(1,1)'(&I,2X00719000
               ) EQ '&&')                                               00720000
&LEN     SETA  &LEN-&PAIR                                               00721000
         AGO   .XWPL02                 EXIT FROM LOOP                   00722000
.*       GENERATE XWPL FIELDS                                           00723000
.XWPL03  ANOP                                                           00724000
.*       GENERATE TEXT FOR XWPL VERSION 1                               00725000
&LEN     SETA  4+&LEN                                                   00726000
         AIF   (&LEN EQ 4).ERROR8                                       00727000
         DC    AL2(&LEN)                TEXT LENGTH                     00728000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00729000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00730000
                                        MCS FLAGS                       00731000
         DC    C&SYSLIST(1,1)           MESSAGE TEXT                    00732000
         DC    AL1(1)                   XWPL VERSION LEVEL              00733000
         AGO   .XWPL05                                                  00734000
.*                                                                      00735000
.*       GENERATE TEXT ADDR XWPL VERSION 2                              00736000
.*                                                                      00737000
.*       TEXT= PARAMETER HAS BEEN PROVIDED. THE SECOND, THIRD AND       00738000
.*       FORTH POSITIONAL PARAMETERS MUST NOT BE PROVIDED               00739000
.XWPL04  AIF   ('&TEXT' EQ '').ERROR2     TEXT= CANNOT BE NULL          00740000
         AIF   (('&RYAD' NE '') OR ('&LENGTH' NE '') OR                X00741000
               ('&ECB' NE '')).ERROR6                                   00742000
         DC    AL2(8)                   TEXT LENGTH                     00743000
         DC    B'&MC(1)&MC(2)&MC(3)&MC(4)&MC(5)&MC(6)&MC(7)&MC(8)&MC(9)X00744000
               &MC(10)&MC(11)&MC(12)&MC(13)&MC(14)&MC(15)&MC(16)'      X00745000
                                        MCS FLAGS                       00746000
         AIF   ('&MF' NE 'I').XWPL04A                                   00747000
.*       MF=I GENERATE ADDR IF PROVIDED                                 00748000
         AIF   ('&TEXT(1)' EQ '').ERROR2  MUST BE PROVIDED FOR MF=I     00749000
         AIF   ('&TEXT(1)'(1,1) EQ '(').XWPL04A  REG NOTATION ?         00750000
         DC    AL4(&TEXT(1))            ADDR OF MESSAGE TEXT            00751000
         AGO   .XWPL05                                                  00752000
.XWPL04A ANOP                                                           00753000
         DC    AL4(0)                   ADDR OF MESSAGE TEXT            00754000
         DC    AL1(2)                   XWPL VERSION LEVEL              00755000
.*       GENERATE FIELDS COMMON TO XWPL VER 1 AND XWPL VER 2            00756000
.XWPL05  ANOP                                                           00757000
         DC    B'00000000'              MISCELLANEOUS FLAGS             00758000
.*       REPLY LENGTH PROCESSING                                        00759000
&WORKL   SETC  '&LENGTH'                                                00760000
         AIF   (&WPLXLEV EQ 1).XWPL05C                                  00761000
&WORKL   SETC  '&TEXT(3)'               XWPL VERSION 2                  00762000
.XWPL05C AIF   (('&MF' EQ 'L') AND ('&WORKL' EQ '')).XWPL05A            00763000
         AIF   (('&MF' EQ 'L') AND ('&WORKL'(1,1) EQ '(')).ERROR3       00764000
         AIF   (('&MF' EQ 'I') AND ('&WORKL' EQ '')).ERROR4             00765000
         AIF   ('&WORKL'(1,1) EQ '(').XWPL05A  REGISTER NOTATION ?      00766000
         DC    AL1(&WORKL)              L'REPLY FOR WTOR                00767000
         AGO   .XWPL05B                                                 00768000
.XWPL05A DC    AL1(0)                   L'REPLY FOR WTOR                00769000
.*       DETERMINE LEVEL OF XWPL                                        00770000
.XWPL05B AIF   (&WPLXLEV EQ 2).XWPL06                                   00771000
.*       XWPL LENGTH VALUE FOR XWPL VERSION 1                           00772000
         DC    AL1(0)                   RESERVED                        00773000
         AGO   .XWPL07                                                  00774000
.*       XWPL LENGTH VALUE FOR XWPL VERSION 2                           00775000
.XWPL06  ANOP                                                           00776000
         DC    AL1(104)                 LENGTH OF XWPL VERSION 2        00777000
.XWPL07  ANOP                                                           00778000
.*       GENERATE EXTENDED MCS FLAGS                                    00779000
         DC    B'&MC(17)&MC(18)&MC(19)&MC(20)&MC(21)&MC(22)&MC(23)&MC(2X00780000
               4)&MC(25)&MC(26)&MC(27)&MC(28)&MC(29)&MC(30)&MC(31)&MC(3X00781000
               2)'                      EXTENDED MCS FLAGS              00782000
         DC    XL2'0000'                MCS FLAGS FOR CNTL PROGRAM USE  00783000
.*       REPLY BUFFER PROCESSING                                        00784000
&WORKA   SETC  '&RYAD'                                                  00785000
         AIF   (&WPLXLEV EQ 1).XWPL07C                                  00786000
&WORKA   SETC  '&TEXT(2)'               XWPL VERSION 2                  00787000
.XWPL07C AIF   (('&MF' EQ 'L') AND ('&WORKA' EQ '')).XWPL07A            00788000
         AIF   (('&MF' EQ 'L') AND ('&WORKA'(1,1) EQ '(')).ERROR3       00789000
         AIF   (('&MF' EQ 'I') AND ('&WORKA' EQ '')).ERROR5             00790000
         AIF   ('&WORKA'(1,1) EQ '(').XWPL07A  REGISTER NOTATION ?      00791000
         DC    AL4(&WORKA)              ADDR OF REPLY BUFFER FOR WTOR   00792000
         AGO   .XWPL07B                                                 00793000
.XWPL07A DC    AL4(0)                   ADDR OF REPLY BUFFER FOR WTOR   00794000
.XWPL07B ANOP                                                           00795000
.*       REPLY ECB PROCESSING                                           00796000
&WORKE   SETC  '&ECB'                                                   00797000
         AIF   (&WPLXLEV EQ 1).XWPL08C                                  00798000
&WORKE   SETC  '&TEXT(4)'               XWPL VERSION 2                  00799000
.XWPL08C AIF   (('&MF' EQ 'L') AND ('&WORKE' EQ '')).XWPL08A            00800000
         AIF   (('&MF' EQ 'L') AND ('&WORKE'(1,1) EQ '(')).ERROR3       00801000
         AIF   (('&MF' EQ 'I') AND ('&WORKE' EQ '')).ERROR6             00802000
         AIF   ('&WORKE'(1,1) EQ '(').XWPL08A  REGISTER NOTATION ?      00803000
         DC    AL4(&WORKE)              ADDR OF REPLY ECB FOR WTOR      00804000
         AGO   .XWPL08B                                                 00805000
.XWPL08A DC    AL4(0)                   ADDR OF REPLY ECB FOR WTOR      00806000
.XWPL08B ANOP                                                           00807000
         DC    AL4(0)                   RESERVED - CONNECT ID           00808000
         DC    B'&DE(1)&DE(2)&DE(3)&DE(4)&DE(5)&DE(6)&DE(7)&DE(8)&DE(9)X00809000
               &DE(10)&DE(11)&DE(12)&DE(13)&DE(14)&DE(15)&DE(16)'      X00810000
                                        DESCRIPTOR CODES                00811000
         DC    AL2(0)                   RESERVED                        00812000
         DC    B'&RO(1)&RO(2)&RO(3)&RO(4)&RO(5)&RO(6)&RO(7)&RO(8)&RO(9)X00813000
               &RO(10)&RO(11)&RO(12)&RO(13)&RO(14)&RO(15)&RO(16)'      X00814000
                                        EXTENDED ROUTING CODES          00815000
         DC    B'&RO(17)&RO(18)&RO(19)&RO(20)&RO(21)&RO(22)&RO(23)&RO(2X00816000
               4)&RO(25)&RO(26)&RO(27)&RO(28)&RO(29)&RO(30)&RO(31)&RO(3X00817000
               2)'                                                      00818000
         DC    B'&RO(33)&RO(34)&RO(35)&RO(36)&RO(37)&RO(38)&RO(39)&RO(4X00819000
               0)&RO(41)&RO(42)&RO(43)&RO(44)&RO(45)&RO(46)&RO(47)&RO(4X00820000
               8)'                                                      00821000
         DC    B'&RO(49)&RO(50)&RO(51)&RO(52)&RO(53)&RO(54)&RO(55)&RO(5X00822000
               6)&RO(57)&RO(58)&RO(59)&RO(60)&RO(61)&RO(62)&RO(63)&RO(6X00823000
               4)'                                                      00824000
         DC    B'&RO(65)&RO(66)&RO(67)&RO(68)&RO(69)&RO(70)&RO(71)&RO(7X00825000
               2)&RO(73)&RO(74)&RO(75)&RO(76)&RO(77)&RO(78)&RO(79)&RO(8X00826000
               0)'                                                      00827000
         DC    B'&RO(81)&RO(82)&RO(83)&RO(84)&RO(85)&RO(86)&RO(87)&RO(8X00828000
               8)&RO(89)&RO(90)&RO(91)&RO(92)&RO(93)&RO(94)&RO(95)&RO(9X00829000
               6)'                                                      00830000
         DC    B'&RO(97)&RO(98)&RO(99)&RO(100)&RO(101)&RO(102)&RO(103)&X00831000
               RO(104)&RO(105)&RO(106)&RO(107)&RO(108)&RO(109)&RO(110)&X00832000
               RO(111)&RO(112)'                                         00833000
         DC    B'&RO(113)&RO(114)&RO(115)&RO(116)&RO(117)&RO(118)&RO(11X00834000
               9)&RO(120)&RO(121)&RO(122)&RO(123)&RO(124)&RO(125)&RO(12X00835000
               6)&RO(127)&RO(128)'                                      00836000
.*                                                                      00837000
         DC    B'&MT(1)&MT(2)&MT(3)&MT(4)&MT(5)&MT(6)&MT(7)&MT(8)&MT(9)X00838000
               &MT(10)&MT(11)&MT(12)&MT(13)&MT(14)&MT(15)&MT(16)'      X00839000
                                        MSGTYPE                         00840000
         DC    AL2(0)                   MESSAGE PRIORITY                00841000
         DC    CL8'        '            JOB ID                          00842000
         DC    CL8'        '            JOB NAME                        00843000
         DC    CL8'        '            RETRIEVAL KEY                   00844000
         DC    AL4(0)                   TOKEN FOR DOM                   00845000
         DC    AL4(0)                   CONSOLE ID                      00846000
         DC    CL8'        '            SYSTEM NAME                     00847000
         AIF   (&WPLXLEV EQ 1).XWPL08   BRANCH TO GENERATE XWPL VER 1   00848000
         DC    CL8'        '            CONSOLE NAME                    00849000
         DC    AL4(0)                   REPLY CONSOLE NAME/ID ADDR      00850000
         DC    AL4(0)                   CART ADDRESS                    00851000
         DC    AL4(0)                   WSPARM ADDRESS                  00852000
         AGO   .XWPL09                                                  00853000
.*       XWPL VERSION 1 FIELDS                                          00854000
.XWPL08  ANOP                                                           00855000
         DC    AL4(0)                   RESERVED                        00856000
         DC    AL4(0)                   RESERVED                        00857000
.XWPL09  ANOP                                                           00858000
         AIF   ('&MF' EQ 'L').XWPL99    MF=L ALL FINISHED               00859000
.*       MF=I PROCESSING FOR XWPL VERSION 1 AND VERSION 2               00860000
&GNAME.A DS    0H                                                       00861000
.*       STORE ADDR OF TEXT INTO XWPL                                   00862000
         AIF   ('&TEXT' EQ '^').XWPL11                                  00863000
         AIF   ('&TEXT(1)'(1,1) EQ '(').XWPL10   TEXT=(REG) ?           00864000
         LA    15,&TEXT(1)              R15 -> TEXT                     00865000
         ST    15,4(,1)                 STORE TEXT ADDR INTO XWPL       00866000
         AGO   .XWPL11                                                  00867000
.XWPL10  ANOP                                                           00868000
         ST    &TEXT(1),4(,1)           STORE TEXT ADDR INTO XWPL       00869000
.*       DETERMINE IF REGISTER NOTATION HAS BEEN USED FOR ANY PARAMETER 00870000
.XWPL11  AIF   (('&WORKA'(1,1) NE '(') AND ('&WORKL'(1,1) NE '(') AND  X00871000
               ('&WORKE'(1,1) NE '(')).XWPL98   N REGISTER NOTATION     00872000
.*       REGISTER NOTATION HAS BEEN USED, SAVE VALUES IN REGISTERS      00873000
         LA    14,0(,1)                                                 00874000
         AH    14,0(,14)            ADD L'TEXT + LEN FIELD + MCS FIELD  00875000
         AIF   ('&WORKL'(1,1) NE '(').XWPL12                            00876000
         STC   &WORKL,2(,14)            STORE L'REPLY                   00877000
.XWPL12  AIF   ('&WORKA'(1,1) NE '(').XWPL13                            00878000
         ST    &WORKA,8(,14)            STORE ADDR OF REPLY             00879000
.XWPL13  AIF   ('&WORKE'(1,1) NE '(').XWPL98                            00880000
         ST    &WORKE,12(,14)           STORE ADDR OF ECB               00881000
.XWPL98  SVC   35                                                       00882000
.XWPL99  MEXIT                                                          00883000
.*                                                                      00884000
.********************************************************************** 00885000
.*       ISSUE ERROR MESSAGES                                           00886000
.********************************************************************** 00887000
.*                                                                      00888000
.*       INVALID MF OPERAND SPECIFIED-MF                                00889000
.*                                                                      00890000
.ERROR1  IHBERMAC 35,,&MF                                               00891000
         MEXIT                                                          00892000
.*       MESSAGE OPERAND REQ'D-NOT SPECIFIED                            00893000
.ERROR2  IHBERMAC 19                                                    00894000
         MEXIT                                                          00895000
.*       INVALID REGISTER NOTATION WITH MF=L SPECIFIED                  00896000
.ERROR3  IHBERMAC 69                                                    00897000
         MEXIT                                                          00898000
.*       REQUIRED LENGTH OPERAND NOT SPECIFIED                          00899000
.ERROR4  IHBERMAC 14                                                    00900000
         MEXIT                                                          00901000
.*       REQUIRED SECOND OPERAND NOT SPECIFIED                          00902000
.ERROR5  IHBERMAC 03                                                    00903000
         MEXIT                                                          00904000
.*       REQUIRED ECB OPERAND NOT SPECIFIED                             00905000
.ERROR6  IHBERMAC 11                                                    00906000
         MEXIT                                                          00907000
.*       MLWTO/WTOR MUTUALLY EXCLUSIVE                                  00908000
.ERROR7  IHBERMAC 246                                                   00909000
         MEXIT                                                          00910000
.*       MISSING OR EXCESSIVE MESSAGE TEXT                              00911000
.ERROR8  MNOTE 12,'NUMBER OF LINES REQUESTED IS 0 OR GREATER THAN 255 -X00912000
                GENERATION TERMINATED'                                  00913000
         MEXIT                                                          00914000
.*       MESG AND TEXT BOTH PROVIDED                                    00915000
.ERROR9  MNOTE 12,'INLINE TEXT AND ''TEXT'' ARE MUTUALLY EXCLUSIVE'     00916000
.*                                                                      00917000
         MEND                                                           00918000
./ ENDUP
/*
//*
//STEP02  EXEC PGM=IEBUPDTE,PARM='NEW'
//SYSPRINT DD  SYSOUT=*
//SYSUT2   DD  DSN=&&SOURCE,DISP=(NEW,PASS),
//             UNIT=SYSALLDA,SPACE=(CYL,(1,1,10)),
//             DCB=(DSORG=PO,RECFM=FB,LRECL=80,BLKSIZE=6160)
//SYSIN    DD  *
./ ADD NAME=IEAVMWTO
VMW      TITLE 'IEAVMWTO - SVC 35 - MLWTO SERVICE ROUTINE'              00001000
*                                                                       00002000
IEAVMWTO CSECT                                                          00003000
*                                                                       00004000
*        STATUS -                                                       00005000
*        LASTUPD         = JCLIN    TYPE=UPD                            00006000
*        LIBRARIES       = DISTLIB=AOSC5                                00007000
*        FMID            = FBB1221                                      00008000
*        RMID            = UZ62088                                      00009000
*        LMOD            = IGC0003E                                     00010000
*        SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS       00011000
*                          EBB1102  FUNCTION  00.000  MOD      ACC RGN  00012000
*                          FBB1221  FUNCTION  00.000  MOD      ACC RGN  00013000
*                          UZ62088  PTF       74.164  MOD  APP ACC      00014000
*                                                                       00015000
*        ORIGINAL SOURCE FROM MVSSRC.SYM101.F20 WAS UPDATED             00016000
*        BY DISASSEMBLY TO MATCH THE LOAD MODULE PROVIDED BY            00017000
*        UZ62088.                                                       00018000
*                                                                       00019000
*        CHANGE ACTIVITY -                                              00020000
*               ZP60039  - 1. SUPPORT FOR THE EXTENDED WPL              00021000
*                             PARAMETER LIST TO ENABLE THE USE OF       00022000
*                             THE TEXT OPERAND                          00023000
*                          2. NUMEROUS CHANGES TO IMPROVE SOURCE        00024000
*                             READABILITY                               00025000
*                          3. LOCALIZED CODE OPTIMZATION                00026000
*                          4. TRANSLATION OF UNPRINTABLE CHARACTERS     00027000
*                             IN WPL TEXT TO HEX A1 (TILDE CHARACTER)   00028000
*                                                                       00029000
*        DESCRIPTIVE NAME - MULTI-LINE WTO SERVICE ROUTINE              00030000
*                                                                       00031000
*        FUNCTION -                                                     00032000
*        THE MLWTO SERVICE ROUTINE IS PART OF IGC0003E OR SVC 35.       00033000
*        IT RECEIVES CONTROL WHEN A MLWTO IS ISSUED. A MULTIPLE         00034000
*        LINE WTO CAUSES A MAJOR WQE AND ONE OR MORE MINOR WQES         00035000
*        TO BE BUILT. THE WQES, MAJOR AND MINOR, CONTAIN MESSAGES       00036000
*        FOR THE CONSOLE OPERATOR AND ASSOCIATED CONTROL                00037000
*        INFORMATION                                                    00038000
*                                                                       00039000
*        THE MODULE CONSTRUCTS A MAJOR WQE AND MINOR WQES FOR           00040000
*        EACH MLWTO. IT WILL ALSO CONNECT ADDITIONAL DATA LINES         00041000
*        (OR MINOR WQES) TO AN EXISTING MLWTO. CONNECTING IS            00042000
*        RESERVED FOR KEY ZERO TO SEVEN OR SUPERVISOR MODE USERS        00043000
*        OF MLWTO ONLY.                                                 00044000
*                                                                       00045000
*        NON PP SVC 35 CALLERS (SUPERVISOR OR KEY 0-7 USERS)            00046000
*        ISSUING A STANDARD MULTI-LINE WTO MUST ZERO R0 UNLESS THEY     00047000
*        ARE PASSING A CONNECTING MESSAGE ID OR CONSOLE ID IN R0        00048000
*                                                                       00049000
*        THE ROUTINE PERFORMS THE FOLLOWING MAJOR FUNCTIONS IN          00050000
*        HANDLING AN MLWTO REQUEST                                      00051000
*                                                                       00052000
*     1. SET UP ADDRESSABILITY AND OBTAIN STORAGE FOR A WORKAREA        00053000
*                                                                       00054000
*     2. CHECK THAT THE LINE TYPES FOR EACH LINE OF THE MESSAGE         00055000
*        IS CORRECT. THE MESSAGE WILL BE TERMINATED AT THE LAST         00056000
*        CORRECT LINE IF AN INVALID LINE TYPE SITUATION IS FOUND        00057000
*                                                                       00058000
*     3. GET STORAGE FOR A MAJOR WQE AND ONE MINOR WQE IF THIS REQUEST  00059000
*        IS NOT ASKING TO ADD MORE LINES TO AN EXISTING MESSAGE         00060000
*                                                                       00061000
*     4. FILL IN THE MAJOR WQE WITH THE FIRST LINE OF THE MESSAGE.      00062000
*        IF THE MESSAGE HAS A DESCRIPTOR CODE OF 9 AND NO CONTROL       00063000
*        LINE AS THE LINE THEN A DEFAULT CONTROL MESSAGE IEE932I        00064000
*        IS SUPPLIED AS THE FIRST LINE OF THE MESSAGE                   00065000
*                                                                       00066000
*     5. PASS THE FIRST LINE TO THE SUBSYSTEM EXIT.                     00067000
*        THE TEXT IN WQETEXT IS TRANSLATED TO INSURE ONLY               00068000
*        PRINTABLE AND DISPLAYABLE CHARACTERS ARE PASSED FROM           00069000
*        THIS POINT                                                     00070000
*                                                                       00071000
*     6. XMPOST THE UCMOECB SO THAT THE COMMUNICATIONS TASK CAN START   00072000
*        PROCESSING THE MLWTO                                           00073000
*                                                                       00074000
*     7. CHECK IF THE MAJOR WQE EXISTS SO THAT THE NEXT LINE CAN BE     00075000
*        ADDED. IF THE SERVICE REQUEST WAS TO ADD EXTRA LINES THEN      00076000
*        THE PROCESSING WOULD SKIP STEPS 4 TO 7. THE MODULE IS          00077000
*        WRITTEN SO THAT EACH ADDITIONAL LINE IS HANDLED IN THE         00078000
*        SAME MANNER                                                    00079000
*                                                                       00080000
*     8. CHECK IF THERE IS SPACE IN THE MINOR WQE/WQES FOR THIS LINE.   00081000
*        GET A NEW MINOR WQE IF THERE IS NO SPACE. THERE IS ALWAYS      00082000
*        AT LEAST ONE MINOR POINTED TO BY THE MAJOR. THIS IS DONE TO    00083000
*        MINIMIZE GETMAIN/FREEMAIN USAGE.                               00084000
*                                                                       00085000
*     9. FILL IN THE NEXT LINE                                          00086000
*                                                                       00087000
*     10. PASS THE MAJOR WQE AND THE MINOR WQE WITH THE NEW LINE        00088000
*         TO THE SUBSYSTEM WTO EXIT.                                    00089000
*         ON RETURN THE TEXT IS TRANSLATED AS IN STEP 6                 00090000
*                                                                       00091000
*     11. POST THE UCMOECB                                              00092000
*                                                                       00093000
*     12. IF THERE ARE ANY MORE LINES IN THE WPL THEN GO BACK TO        00094000
*         STEP 8. IF NOT THEN RETURN TO IEAVVWTO                        00095000
*                                                                       00096000
*        OPERATION -                                                    00097000
*        THIS MODULE USES THE EXTENDED SAVEAREA IN THE SVRB.            00098000
*        SOME OF THE INFORMATION IN THIS AREA IS SET UP BY              00099000
*        IEAVVWTO PRIOR TO THE CALL TO IEAVMWTO                         00100000
*                                                                       00101000
*        NOTES -                                                        00102000
*        THE MODULE USES A NUMBER OF INTERNAL SUBROUTINES.              00103000
*        THE ROUTINES ARE ORGANIZED SO THAT THEY HAVE ONLY ONE          00104000
*        ENTRY POINT AND ONE EXIT POINT. MOST ROUTINES ARE ALSO         00105000
*        WELL STRUCTURED IN TERMS OF INSTRUCTION FLOW. THE              00106000
*        SEGMENTS USED IN THIS MODULE ARE LISTED.                       00107000
*                                                                       00108000
*                                                                       00109000
*     1. IEASGETL - DETERMINES THE NUMBER OF LINES IN THE WPL           00110000
*                                                                       00111000
*     2. IEASTLMX - LIMITS SERVICE REQUEST TO 10 LINES AT A TIME        00112000
*                                                                       00113000
*     3. CHKTYPE - CHECKS THAT LINES HAVE THE PROPER LINE TYPE          00114000
*        AND IN THE PROPER ORDER                                        00115000
*                                                                       00116000
*     4. INCRMNT - LOCATES THE BEGINNING OF THE NEXT LINE IN THE        00117000
*        WPL                                                            00118000
*                                                                       00119000
*     5. IEASTORE - SAVES THE NUMBER OF LINES FOUND IN THE WPL          00120000
*        SETS XVX0UDCL IF THE DEFAULT CONTROL LINE IS TO BE USED        00121000
*                                                                       00122000
*     6. BLDMAJ - GET SPACE FOR THE MAJOR AND MINOR WQE. BUILD MAJOR    00123000
*                                                                       00124000
*     7. GETMAJ - OBTAINS SPACE FOR THE WQE                             00125000
*                                                                       00126000
*     8. FREEMAJ - FREES THE MAJOR WQE IF A MINOR COULDN'T BE           00127000
*        OBTAINED                                                       00128000
*                                                                       00129000
*     9. BMAJINIT - INITIALIZE THE MAJOR WQE                            00130000
*                                                                       00131000
*     10.BMAJFSTL - SET UP TO MOVE TEXT INTO MAJOR                      00132000
*                                                                       00133000
*     11.BMAJMVMS - MOVE TEXT INTO MAJOR. TRUNCATE TRAILING BLANKS      00134000
*                                                                       00135000
*     12.BLDMIN - FILL IN MINOR LINES                                   00136000
*                                                                       00137000
*     13.MIN1INIT/MIN2INIT - INITIALIZE THE FIRST/SECOND LINE IN        00138000
*        THE MINOR WQE                                                  00139000
*                                                                       00140000
*     14.MIN1MOV/MIN2MOV - MOVE THE TEXT INTO THE FIRST/SECOND LINE     00141000
*        OF THE MINOR WQE                                               00142000
*                                                                       00143000
*     15.SUBSEXIT - PASS MAJOR/MINOR WQE TO SUBSYSTEM WTO EXIT.         00144000
*        ON RETURN FROM THE SUBSYSTEM EXIT THE USER IS A                00145000
*        PROBLEM PROGRAM THE WQE TEXT -MAJOR/MINOR- IS TRANSLATED       00146000
*        TO ALLOW ONLY PRINTABLE AND DISPLAYABLE CHARACTERS             00147000
*        FROM THIS POINT.                                               00148000
*                                                                       00149000
*     16.POSTOECB - XMPOST UCMOECB TO WAKE UP COMM TASK                 00150000
*                                                                       00151000
*     17.FREESAV - FREE THE MODULES DYNAMIC WORKAREA                    00152000
*                                                                       00153000
*        THE INTERNAL ROUTINES USED IN THE MODULE ARE DESCRIBED BELOW   00154000
*                                                                       00155000
*     1. GETMINOR - GETS SPACE FOR A MINOR WQE AND ADDS IT TO           00156000
*        QUEUE OF MINORS POINTED TO BY THE MAJOR.                       00157000
*                                                                       00158000
*     2. ENDUP - DECREMENTS THE NUMBER OF LINES TO BE DONE. SETS        00159000
*        LINE TYPE TO DATA-END IF NEEDED                                00160000
*                                                                       00161000
*     3. FINDID - LOCATES MAJOR TO WHICH THE MINOR LINE IS TO BE        00162000
*                 ADDED                                                 00163000
*                                                                       00164000
*     6. GETWQE - GETS A WQE FROM THE WQE CELLPOOL                      00165000
*                                                                       00166000
*     7. WAITWQE - WAIT FOR A WQE TO BE FREED                           00167000
*                                                                       00168000
*     8. TEXTLINE - INCREMENTS R4 TO THE NEXT LINE IN THE               00169000
*                   INPUT TEXT STRING                                   00170000
*                                                                       00171000
*     9. FRELCKS - FREES THE CMS AND LOCAL LOCK                         00172000
*                                                                       00173000
*     10.SETLCKS - OBTAINS THE LOCAL AND CMS LOCK                       00174000
*                                                                       00175000
*        DEPENDENCIES -                                                 00176000
*        THIS MODULE IS LINKED WITH IEAVVWTO, IGC0203E AND              00177000
*        IEECVXIT TO FORM ONE LOAD MODULE                               00178000
*        ENTRY POINT IS IEAVVWTO. THE LINK IS DONE AT SYSGEN            00179000
*                                                                       00180000
*        ATTRIBUTES -                                                   00181000
*        PAGED-LPA, ZERO PROTECT KEY, REENTERABLE, SUPERVISOR MODE      00182000
*                                                                       00183000
*        ENTRY-POINT - IEAVMWTO                                         00184000
*                                                                       00185000
*        PURPOSE -                                                      00186000
*        THIS IS THE ONLY ENTRY POINT TO THE ROUTINE. IT IS GIVEN       00187000
*        CONTROL BY IEAVVWTO TO PROCESS A MULTI-LINE WTO REQUEST        00188000
*                                                                       00189000
*        LINKAGE -                                                      00190000
*        IEAVMWTO IS CALLED BY IEAVVWTO USING STANDARD SYSTEM           00191000
*        LINKAGE CONVENTIONS                                            00192000
*                                                                       00193000
*        INPUT -                                                        00194000
*        THE FOLLOWING REGISTERS ARE INITIALIZED BY IEAVVWTO            00195000
*        R4   -> TCB                                                    00196000
*        R5   -> SVRB                                                   00197000
*        R7   -> ASCB                                                   00198000
*        R13  -> CALLER'S SAVEAREA                                      00199000
*        R14   = RETURN ADDRESS                                         00200000
*        R15   = ENTRY POINT ADDRESS                                    00201000
*                                                                       00202000
*        THE WPL HAS BEEN CHECKED FOR VALIDITY BY IEAVVWTO.             00203000
*        A MULT-LINE WTOR IS NOT PERMITTED. THIS IS CHECKED FOR         00204000
*        BY IEAVVWTO PRIOR TO IEAVMWTO BEING CALLED                     00205000
*                                                                       00206000
*        THE XVSAV AREA HAS BEEN INITIALIZED BY IEAVVWTO -              00207000
*        XVA8    =  TIME TAKEN BY IEAVVWTO                              00208000
*        XVD1PRIV = ON IF CALLER IS PRIVILEGED                          00209000
*        XVD1PP   = ON IF CALLER IS A PROBLEM PROGRAM                   00210000
*        XVD1AUTH = ON IF CALLER IS AUTHORIZED                          00211000
*        XVD2VALD = ON                                                  00212000
*        XVWQEID  = CONTENTS OF R0 PROVIDED BY SVC 35 ISSUER            00213000
*         XVWQEIDA = A NEW LINE IS TO BE CONNECTED TO THE MESSAGE       00214000
*                    WITH THIS MESSAGE ID.  MULTI-LINE WTO ONLY         00215000
*         XVCONID  = CONSOLE ID PASSED IN R0 TO SVC 35                  00216000
*                                                                       00217000
*        OUTPUT -                                                       00218000
*        THIS ROUTINE CREATES NO STREAM OR LIST OUTPUT                  00219000
*                                                                       00220000
*        REGISTERS SAVED -                                              00221000
*        THE CALLER'S REGISTERS ARE SAVED IN THE PROVIDED SAVEAREA      00222000
*                                                                       00223000
*        REGISTER USAGE -                                               00224000
*        THE REGISTER USAGE AND THE ASSOCIATED NAMES ARE GIVEN IN       00225000
*        THE FOLLOWING TABLE                                            00226000
*         REG      USAGE                                                00227000
*          0       WORK REG                                             00228000
*                                                                       00229000
*          1       WORK REG                                             00230000
*                                                                       00231000
*          2       WORK REG                                             00232000
*                                                                       00233000
*          3       -> CVT                                               00234000
*                  COUNTER FOR HANDLING TEXT LENGTH                     00235000
*                                                                       00236000
*          4       ADDR OF THE TCB                                      00237000
*                  ADDR OF TEXT LINE CURRENTLY BEING PROCESSED          00238000
*                                                                       00239000
*          6       -> WPL                                               00240000
*                                                                       00241000
*          7       ADDR OF THE ASCB                                     00242000
*                  ADDR OF MINOR WQE                                    00243000
*                                                                       00244000
*          8       ADDR OF THE MAJOR WQE                                00245000
*                  USED ONLY TO DEVELOP COUNT OF NUMBER OF LINES        00246000
*                  TO BE PROCESSED.                                     00247000
*                                                                       00248000
*          9       -> WORKAREA USED BY IEAVVWTO                         00249000
*                                                                       00250000
*          10      BASE FOR UCM                                         00251000
*                  COMPLETION CODE FOR XMPOST                           00252000
*          11      PROGRAM BASE                                         00253000
*                  ECB ADDR FOR XMPOST                                  00254000
*          12      BASE FOR XVSAV AREA                                  00255000
*                  ERRET ADDR FOR XMPOST                                00256000
*          13      SAVE AREA BASE AND WORK REG                          00257000
*                  ADDR ASCB FOR XMPOST                                 00258000
*          14      WORK REG                                             00259000
*          15      WORK REG                                             00260000
*                                                                       00261000
*                                                                       00262000
*        REGISTERS RESTORED -                                           00263000
*        ALL OF THE CALLER'S REGISTERS ARE RESTORED                     00264000
*                                                                       00265000
*        EXIT NORMAL -                                                  00266000
*        THIS MODULE HAS ONLY ONE EXIT POINT                            00267000
*                                                                       00268000
*        CONDITIONS -                                                   00269000
*        IEAVMWTO ALWAYS RETURNS TO ITS CALLER, IEAVVWTO.               00270000
*        IT RETURNS AFTER SERVICING THE MULTI-LINE REQUEST              00271000
*                                                                       00272000
*        OUTPUT -                                                       00273000
*        THE RETURN TO IEAVVWTO IS TAKEN FOR SUCCESSFUL AND             00274000
*        UNSUCCESSFUL SERVICING OF THE MULTI-LINE REQUEST.              00275000
*        THE OUTPUT FOR A SUCCESSFUL SERVICING IS -                     00276000
*         XVWQEID = 3 BYTE MESSAGE SEQUENCE NUMBER, RIGHT JUSTIFIED.    00277000
*         XVRETCOD = 0 THEN NOTHING FOUND IN ERROR.                     00278000
*                                                                       00279000
*                    4 AN ERROR WAS FOUND IN THE NUMBER OF LINES.       00280000
*                      MESSAGE WAS TRUNCATED TO TEN LINES AND LAST      00281000
*                      LINE SET TO DATA/END. - OR -                     00282000
*                      THE ACTUAL TEXT LENGTH FOR ONE LINE WAS ZERO.    00283000
*                      THE MESSAGE TRUNCATED AT THE PREVIOUS LINE.      00284000
*                                                                       00285000
*                   12 THE LINE TYPE FOR A LINE WAS INVALID. THE        00286000
*                      MESSAGE WAS TO THE LAST VALID LINE AND ITS       00287000
*                      LINE TYPE WAS SET TO DATA/END.                   00288000
*                                                                       00289000
*                   16 THE MLWTO HAD A WTP ROUTE CODE AND OTHER ROUTE   00290000
*                      CODES. THE WTP ROUTE CODE (ROUTE CODE 11)        00291000
*                      WAS IGNORED.                                     00292000
*                                                                       00293000
*        THE OUTPUT FOR AN UNSUCCESSFUL SERVICING IS:                   00294000
*        XVWQEID = 0. NO MESSAGE WAS PUT OUT, THEREFORE MSGID IS ZERO   00295000
*        XVRETCOD = 4 -THE NUMBER OF LINES IN THE WPL WAS ZERO.         00296000
*                                                                       00297000
*                     -MESSAGE TEXT LENGTH FOR A LINE WAS               00298000
*                      GREATER THAN 1; ALL LINES UP TO                  00299000
*                      ERROR LINE ARE PROCESSED                         00300000
*                                                                       00301000
*                   8 THE MESSAGE ID PASSED IN R0 DID NOT MATCH         00302000
*                     ANY ID FOR A WQE CURRENTLY IN THE SYSTEM.         00303000
*                     THIS OCCURS ONLY WHEN IEAVMWTO IS ATTEMPTING      00304000
*                     TO CONNECT NEW LINES TO AN EXISTING MESSAGE.      00305000
*                     THIS PROBLEM CAN ARISE IN THE FOLLOWING WAYS.     00306000
*                     1. REG 0 IS NOT ZERO FOR THE FIRST SERVICE        00307000
*                        REQUEST OF A MULTI-LINE WTO.                   00308000
*                                                                       00309000
*                     2. THE MULTI-LINE MSG WAS GOING TO A CONSOLE      00310000
*                        THAT ENCOUNTERED AN I/O ERROR. CONSOLE         00311000
*                        SWTICH DELETED THE MSG AS MULTI-LINE MSGS      00312000
*                        CANT BE SWITCHED.                              00313000
*                                                                       00314000
*                     3. THE USER LOST THE MESSAGE ID PASSED BACK       00315000
*                        IN R1 BY SVC 35.                               00316000
*                                                                       00317000
*                  12 THE NEW MULTI-LINE MSG CONSISTS OF ONLY AN        00318000
*                     END LINE.                                         00319000
*                                                                       00320000
*                  16 ROUTE CODE 11 (WTP) WAS THE ONLY ROUTE CODE       00321000
*                     SPECIFIED.                                        00322000
*                                                                       00323000
*                  20 THE MULTI-LINE MSG WAS TO BE SET TO HARD COPY     00324000
*                     ONLY.                                             00325000
*                                                                       00326000
*        RETURN CODES -                                                 00327000
*        THE RETURN CODES ARE SET IN XVRETCOD AND THEIR MEANINGS        00328000
*        ARE DESCRIBED ABOVE                                            00329000
*                                                                       00330000
*        EXIT ERROR -                                                   00331000
*        THERE IS NO ERROR EXIT FROM IEAVMWTO. WHEN AN ABEND            00332000
*        CONDITION IS FOUND THE MODULE SETS XVD1PERR AND RETURNS        00333000
*        NORMALLY TO IEAVVWTO. IEAVVWTO WILL THEN ABEND THE             00334000
*        CALLER WITH A D23 ABEND CODE                                   00335000
*                                                                       00336000
*        CONDITIONS -                                                   00337000
*        THE ERROR BIT, XVD1PERR, IS SET FOR THE FOLLOWING              00338000
*        REASONS -                                                      00339000
*         1. NO SPACE COULD BE OBTAINED IN SUBPOOL 229 FOR THE          00340000
*            WORKAREA FOR IEAVMWTO                                      00341000
*         2. THE ESTAE EXIT WAS ENTERED                                 00342000
*         3. SPACE COULD NOT BE OBTAINED FOR A WQE FROM THE WQE         00343000
*            CELL POOL                                                  00344000
*                                                                       00345000
*        RETURN CODES - NONE                                            00346000
*                                                                       00347000
*        EXTERNAL REFERENCES - SEE THE FOLLOWING                        00348000
*                                                                       00349000
*        ROUTINES -                                                     00350000
*        THIS MODULE CALLS SUBSYSTEM WTO EXIT VIA THE IEFSSREQ          00351000
*        MACRO                                                          00352000
*                                                                       00353000
*        DATA AREAS - THE FOLLOWING EXTERNAL DATA AREAS ARE USED        00354000
*        OR REFERENCED BY THIS MODULE                                   00355000
*        ASCBASID = MEMORY ID                                           00356000
*        CVTCRMN  = ADDR OF GETMAIN BRANCH ENTRY                        00357000
*        CVTBLDCP = ADDR OF BLD CPOOL ENTRY POINT                       00358000
*        CVTFRECL/CVTGETCL = ADDR OF GET/FREE CELL ROUTINE              00359000
*        CVTRMBR  = ADDR OF FREEMAIN ENTRY POINT                        00360000
*        CVTVWAIT = ADDR OF BRANCH ENTRY TO WAIT                        00361000
*        PSALITA  = ADDR OF LOCK INTERFACE TABLE                        00362000
*        TCBFLGS1 = BIT TCBFX IS SET TO PREVENT ASYNCHRONOUS EVENTS     00363000
*                   DURING A WAIT FOR A MINOR WQE                       00364000
*        UCMASCB  = ADDR OF ASCB FOR COMMTASK'S MEMORY                  00365000
*        UCMCMID  = MESSAGE SEQUENCE NUMBER                             00366000
*        UCMOECB  = OUTPUT ECB FOR COMM TASK                            00367000
*        UCMSYST  = THIS BIT IS SET IF MLWTO WAS DELETED BY THE         00368000
*                   SUBSYSTEM                                           00369000
*        UCMWQECP = WQE CELL POOL NUMBER                                00370000
*        UCMWQEND = ADDR OF LAST WQE ON THE CHAIN                       00371000
*        UCMWQLM  = MAX NUMBER OF WQES ALLOWED                          00372000
*        UCMWQNR  = CURRENT NUMBER OF WQES                              00373000
*        UCMWTOQ  = ADDR OF START OF WQE CHAIN                          00374000
*                                                                       00375000
*        TABLES -                                                       00376000
*        THE FOLLOWING TABLES ARE USED IN THIS ROUTINE -                00377000
*        TRTAB -  TABLE OF CHARACTERS USED TO INSURE PRINTABLE          00378000
*                 AND NON DISPLAY CONTROL CHARACTERS IN THE WQE         00379000
*                 THIS TABLE IS RESIDENT IN IEEVVWTO                    00380000
*                                                                       00381000
*        SERIALIZATION -                                                00382000
*        THE LOCAL AND CMS LOCKS ARE USED TO SERIALIZE THE              00383000
*        RESOURCES USED IN THIS MODULE                                  00384000
*                                                                       00385000
IEAVMLWO SAVE  (14,12),,'IEAVMWTO ZP60039 &SYSDATE &SYSTIME'            00386000
*                                                                       00387000
         LA    R10,0(,R15)             R15 HAS ENTRY POINT ADDR         00388000
         LA    R11,2048(,R10)                                           00389000
         LA    R11,2048(,R11)                                           00390000
         USING IEAVMLWO,R10,R11                                         00391000
         USING RBBASIC,R12                                              00392000
         LR    R12,R5                  R12 -> SVRB                      00393000
         XC    XVX,XVX                 ZERO OUT THE XVX FLAGS           00394000
         XC    XVWWB,XVWWB             ZERO OUT XVWWB FOR ADDR OF WWB   00395000
*                                                                       00396000
*                                                                       00397000
*        GETMAIN FOR SAVE AREA AND WORKAREA FROM SUBPOOL 229            00398000
*                                                                       00399000
         L     R0,WKSIZE               GET SIZE OF WORK AREA            00400000
         LR    R9,R0                   SAVE LENGTH FOR LATER AREA ZERO  00401000
         L     R1,WKSUBPL              GET SUBPOOL NUMBER OF WORKAREA   00402000
*                                                                       00403000
         GETMAIN  RC,LV=(0),SP=(1)                                      00404000
*                                                                       00405000
*        CHECK IF GETMAIN WAS SUCCESSFUL                                00406000
*        IF NOT SET ERROR AND STOP BITS                                 00407000
*                                                                       00408000
         LTR   R15,R15                 CHECK GETMAIN RETURN CODE        00409000
         BZ    IEAVSAVE                CONTINUE IF ZERO RETURN CODE     00410000
*                                                                       00411000
*        GETMAIN FAILED                                                 00412000
*                                                                       00413000
         MVI   XVAMOD,MWTOID                                            00414000
         MVI   XVFNCT,D23DYN           DYNAMIC AREA GETMAIN FAILURE     00415000
         STC   R15,XVREASON                                             00416000
         OI    XVD1,XVD1PERR           SEVERE ERROR                     00417000
         OI    XVX1,XVX1STOP           ERROR, IGNORE MLWTO              00418000
         B     IEAMGRET                BRANCH TO RETURN TO USER         00419000
*                                                                       00420000
IEAVSAVE LR    R8,R1                   R8 -> GETMAINED AREA             00421000
*                                      R9  = L'GETMAINED AREA           00422000
         SLR   R15,R15                 NO COPY, PAD OF ZERO             00423000
         MVCL  R8,R14                  ZERO WORKAREA                    00424000
         ST    R1,8(,R13)              CHAIN SAVE AREAS                 00425000
         ST    R13,4(,R1)                                               00426000
         LR    R9,R13                  R9 -> IEAVVWTO WORKAREA          00427000
         USING WORKVV,R9               ESTABLISH ADDRESSABILITY         00428000
*                                      TO IEAVVWTO WORKAREA             00429000
         LR    R13,R1                                                   00430000
         USING WORKAREA,R13            SET ADDRESSABILITY FOR WORKAREA  00431000
         L     R3,CVTPTR                                                00432000
         USING CVT,R3                                                   00433000
         MVC   ADDRUCM,CVTCUCB         SAVE -> UCM IN ADDRUCM           00434000
         DROP  R3                                                       00435000
*                                                                       00436000
*        SAVE USER'S ASCB ADDR (R7) IN OUR SAVEAREA                     00437000
*        SAVE THE ADDR TO THE CURRENT RB                                00438000
*                                                                       00439000
         ST    R7,ASCBSAVE             SAVE ASCB ADDR                   00440000
         ST    R4,TCBSAVE              SAVE TCB ADDR                    00441000
*                                                                       00442000
*        CALCULATE ADDR OF LAST BYTE OF TEXT IN PROTECTED STORAGE       00443000
*                                                                       00444000
         L     R1,WKAADTXT             R1 -> MAJOR WQE TEXT IN          00445000
*                                            PROTECTED STORAGE          00446000
         AH    R1,WKALGH               ADD L'MAJOR WQE TEXT             00447000
         A     R1,LENMWQE              ADD L'OF ALL MINOR WQES          00448000
         ST    R1,LASTWPLB             STORE ADDR OF BYTE AFTER END OF  00449000
*                                      MAJOR AND MINOR WQES             00450000
*                                                                       00451000
*        CHECK FOR PP USER ISSUING MLWTO                                00452000
*        PP USERS CAN'T CONNECT MINOR LINES TO THE MAJOR WQE            00453000
*        CHECK XVD1PP AND XVD1AUTH TO INSURE                            00454000
*        R0 ISN'T AN IMPLIED PARAMETER TO SVC 35                        00455000
*                                                                       00456000
IEAVMLWS TM    XVD1,XVD1PP             USER A PROBLEM PROGRAM ?         00457000
         BZ    IEAVTCON                NO, GO CHECK FOR MSG ID          00458000
         TM    XVD1,XVD1AUTH           KEY 0, SUPVR STATE OR APF AUTH ? 00459000
         BO    IEAVTCON                YES, BRANCH                      00460000
*                                                                       00461000
*        PROBLEM PROGRAM, NO CONNECTION ALLOWED                         00462000
*                                                                       00463000
         XC    XVWQEIDA,XVWQEIDA       ZERO MESSAGE ID                  00464000
         B     IEAVSETE                BYPASS MSG CONNECTING PROCESS    00465000
*                                                                       00466000
*        NOT PROBLEM PROGRAM                                            00467000
*        INDICATE PRIVILEGED TASK TO AVOID MLWTO HANGUP BECAUSE         00468000
*        OF UNAVAILABLE WQE'S                                           00469000
*        INDICATE CONNECTING IF REQUESTED                               00470000
*                                                                       00471000
IEAVTCON OI    XVD1,XVD1PRIV           INDICATE PRIVILEGED TASK         00472000
         ICM   R15,B'1110',XVWQEIDA    CALLER CONNECTING ?              00473000
         BZ    IEAVSETE                NO, THE MSG ID FIELD IS EMPTY    00474000
         OI    XVD2,XVD2CON            YES, INDICATE CONNECTING         00475000
*                                                                       00476000
*        SET UP THE ESTAE PROTECTION FOR THIS MODULE                    00477000
*                                                                       00478000
IEAVSETE XC    EPARM(L'EPARM),EPARM    CLEAR THE ESTAE PARM LIST        00479000
         L     R3,ADDRUCM              R3 -> UCM                        00480000
         USING UCM,R3                                                   00481000
         L     R2,UCMFRRAD             R2 -> COM TASKS RECOVERY         00482000
*                                            ROUTINE IEEFRRAD           00483000
         LA    R8,EPARM                R8 -> ESTAE PARM AREA            00484000
         MVC   SUBSLIST(ELISTL),ELIST  MOVE IN ESTAE PARM LIST          00485000
         LA    R1,SUBSLIST             R1 -> PARAMETER LIST             00486000
         DROP  R3                                                       00487000
*                                                                       00488000
         ESTAE (R2),CT,PARAM=(R8),RECORD=YES,MF=(E,(1))                 00489000
*                                                                       00490000
         LA    R2,EPARM                R2 -> PARMLIST AREA              00491000
         ST    R2,PARMPTR              PT TO PARM AREA                  00492000
         USING PARMLIST,R2                                              00493000
         LA    R1,IEAVRETY             MOVE IN RETRY ADDR               00494000
         ST    R1,PARMRTAD                                              00495000
         LA    R1,RECSAVE              R1 -> REG SAVE AREA              00496000
         ST    R1,PARMRGAD             SET ESTAE PARM LIST PTR TO SA    00497000
         MVC   PARMID,MODULEID         IDENTIFY FAILING MODULE          00498000
         MVC   RECSAVE,ALLREGS         RELOAD ALL REGS ON RETRY         00499000
         STM   R0,R15,RECREGS          SAVE REGS FOR A RETRY            00500000
         DROP  R2                                                       00501000
*                                                                       00502000
*        CHECK IF MLWTO IS QUEUED TO HARDCOPY ONLY                      00503000
*        THIS IS AN ERROR CONDITION WITH A RETURN CODE OF 20(DEC)       00504000
*                                                                       00505000
         TM    WKAMCSF,WPLMCSFG        QUEUE TO HARD COPY ONLY ?        00506000
         BZ    IEASRTDC                NO, CHECK FOR ROUT/DESC CODES    00507000
         MVI   XVRETCOD,HCONLY         YES, SET RETURN CODE 20          00508000
         BAL   R0,IEASTOPA             IGNORE REQUEST                   00509000
*                                                                       00510000
IEASRTDC TM    WKAROC+1,WPLROUTK       WTP SPECIFIED ?                  00511000
         BZ    IEASGETL                NOT WTP, SKIP ERROR CHECK        00512000
*                                                                       00513000
*        THIS MLWTO INCLUDES A WTP ROUTE CODE                           00514000
*        CHECK IF IT IS A WTP ONLY                                      00515000
*                                                                       00516000
         CLC   WKAROC,WTPONLY          ANY ROUTE CODES OTHER THAN       00517000
*                                      WPLROUTK ?                       00518000
         BNE   IEASWTPP                YES, WTP NOT THE ONLY ROUTE CODE 00519000
*                                      SPECIFIED                        00520000
*        ONLY WTP ROUTE CODE. SET STOP FLAG                             00521000
*                                                                       00522000
         OI    XVX1,XVX1STOP                                            00523000
         B     IEASRETC                                                 00524000
*                                                                       00525000
IEASWTPP NI    WKAROC+1,255-WPLROUTK   TURN OFF WTP ROUTING CODE        00526000
IEASRETC MVI   XVRETCOD,RCWTP          SET RETURN CODE 16               00527000
         TM    XVX1,XVX1STOP           STOP PROCESSING SET ?            00528000
         BZ    IEASGETL                NO, CONTINUE PROCESSING          00529000
         BAL   R0,IEASTOPA             YES, THEN SKIP TO STOP           00530000
*                                                                       00531000
*        GET THE NUMBER OF LINES TO BE PROCESSED                        00532000
*                                                                       00533000
*        INPUT -                                                        00534000
*        WKAADTXT -> TEXT FOR MAJOR WQE AND MINOR WQES                  00535000
*                                                                       00536000
*        OUTPUT -                                                       00537000
*        XVX3 = NUMBER OF LINES FROM WPLLINES FIELD                     00538000
*        R2 -> WPLLTF (MLWTO EXTENSION HDR) AND ADDRESSABILITY IS SET   00539000
*        ADDRMLHR IS SET TO ADDR OF WPLLTF                              00540000
*                                                                       00541000
IEASGETL L     R2,WKAADTXT             R2 -> MAJOR WQE AND MINOR WQES   00542000
         AH    R2,WKALGH               ADD L'MAJOR WQE                  00543000
         ST    R2,ADDRMLHR             SAVE ADDR TO MULTILINE EXTENSION 00544000
*                                      HEADER WPLLTF                    00545000
         USING WPLRF,R2                R2 -> MLWTO EXTENSION WPLLTF     00546000
*                                                                       00547000
         TM    XVX1,XVX1STOP           ERROR IN GETLINES ?              00548000
         BZ    IEASGETC                NO, CONTINUE  PROCESSING         00549000
         BAL   R0,IEASTOPA             YES, THEN SKIP PROCESSING        00550000
*                                                                       00551000
*        CHECK THE TEXT LENGTH OF THE MAJOR WQE FOR ZERO                00552000
*                                                                       00553000
IEASGETC CLC   WKALGH,KH4              LENGTH > 4 ?                     00554000
         BH    IEASTLMK                YES, GO CHECK NO OF LINES        00555000
         BL    IEA00212                < 4, ERROR, BRANCH               00556000
*                                      LENGTH = 4                       00557000
*                                                                       00558000
*        VALIDATE MLWTO EXTENSION HEADER FLAGS                          00559000
*                                                                       00560000
         TM    WPLLTF,WPLLTFD          END LINE ?                       00561000
         BZ    IEA00212                NO, BRANCH                       00562000
         TM    WPLLTF,WPLLTFC          YES, END PLUS DATA LINE ?        00563000
         BZ    IEASTLMK                NO, BRANCH                       00564000
IEA00212 MVI   XVRETCOD,LINERR         ZERO LINE LENGTH - ERROR 04      00565000
         BAL   R0,IEASTOPA             RETURN TO CALLER                 00566000
*                                                                       00567000
IEASTLMK CLI   WPLLINES,0              ANY LINES TO PROCESS ?           00568000
         BNE   IEASTLMX                YES, CONTINUE CHECKING WPL       00569000
         MVI   XVRETCOD,LINERR         NO, ZERO NO OF LINES, ERROR      00570000
         BAL   R0,IEASTOPA             RETURN TO CALLER                 00571000
*                                                                       00572000
*        VALIDATE THE NUMBER OF LINES                                   00573000
*        ALLOW NO MORE THAN 10 LINES TO BE PROCESSED                    00574000
*        UNLESS THE CALLER IS AUTHORIZED                                00575000
*                                                                       00576000
IEASTLMX MVC   XVX3,WPLLINES           SAVE THE NUMBER OF LINES         00577000
         CLI   XVX3,10                 NO LINES > 10 ?                  00578000
         BNH   IEASETC1                NO, VALID                        00579000
         TM    XVD1,XVD1AUTH           KEY 0, SUPVR STATE OR APF AUTH ? 00580000
         BO    IEASETC1                YES, BRANCH                      00581000
         TM    XVD1,XVD1PP             PROBLEM PROGRAM CALLER ?         00582000
         BZ    IEASETC1                NO, BRANCH                       00583000
         MVI   XVX3,10                 YES, TRUNCATE NO LINES TO 10 MAX 00584000
         MVI   XVRETCOD,LINERR         SET RETURN CODE = 4 BUT          00585000
*                                      CONTINUE PROCESSING              00586000
*                                                                       00587000
*        BEGIN PROCESSING THE MAJOR WQE LINE                            00588000
*                                                                       00589000
*        R2 -> WPLLTF                                                   00590000
*        R14 = LINE COUNT                                               00591000
*                                                                       00592000
IEASETC1 LA    R14,1                   SET COUNT=1                      00593000
         MVI   NUMLINES,1              SET LINE COUNT TO 1              00594000
         MVC   LINETYPE,WPLLTF         MOVE LINE CONTROL FLAGS FROM     00595000
*                                      MLWTO EXTENSION HEADER TO        00596000
*                                      LINETYPE                         00597000
         TM    LINETYPE,WPLLTFD        END LINE ?                       00598000
         BZ    IEASTCLN                NO, GO CHECK FOR CONTROL LINE    00599000
         TM    LINETYPE,WPLLTFC        YES, DATA LINE AS WELL ?         00600000
         BO    IEASTCLN                YES, START LINE TYPE CHECKING    00601000
*                                                                       00602000
*        THE FIRST LINE CAN JUST BE AN END LINE                         00603000
*        SET FLAG INDICATING END LINE                                   00604000
*        ONLY VALID IF CONNECTING                                       00605000
*                                                                       00606000
         OI    XVX0,XVX0FLJE           SET LINE 1 JUST END              00607000
         TM    XVD2,XVD2CON            CONNECTING                       00608000
         BO    IEASTORE                YES, SKIP TO STORE LINE COUNT    00609000
         MVI   XVRETCOD,INVLDLT        NO, SET INVALID LINE TYPE RC     00610000
         BAL   R0,IEASTOPA                                              00611000
*                                                                       00612000
*        CHKTYPE SEGMENT                                                00613000
*                                                                       00614000
*        ALL LINES ARE PROCESSED THROUGH THIS SECTION OF CODE           00615000
*                                                                       00616000
*        THE LINE CONTROL FLAGS ARE IN A DIFFERENT OFFSET FOR THE       00617000
*        MAJOR WQE COMPARED TO THE MINOR WQE LINES.                     00618000
*        FOR CODE SIMPLIFICATION THE LINE CONTROL FLAGS FROM THE TWO    00619000
*        DIFFERENT LOCATIONS ARE MOVED TO LINETYPE FOR COMMON TESTING   00620000
*                                                                       00621000
IEASTCLN TM    LINETYPE,WPLLTFA        CONTROL LINE ?                   00622000
         BO    IEASCNT0                YES, CHECK COUNT                 00623000
         TM    LINETYPE,WPLLTFB        LABEL LINE ?                     00624000
         BO    IEASTLAB                YES, BRANCH                      00625000
         TM    LINETYPE,WPLLTFC        DATA LINE ?                      00626000
         BO    IEASUPCT                YES, BRANCH                      00627000
         TM    LINETYPE,WPLLTFD        END LINE ONLY ?                  00628000
         BO    IEASFEND                YES, GOTO FORCE END              00629000
         B     IEASRC12                NO, ERROR                        00630000
*                                                                       00631000
*        PROCESS CONTROL LINE                                           00632000
*        CONTROL LINE MUST BE THE FIRST LINE                            00633000
*                                                                       00634000
IEASCNT0 CH    R14,KH1                 COUNT=1 (MAJOR WQE LINE) ?       00635000
         BNE   IEASRC12                NO, ERROR                        00636000
         TM    LINETYPE,WPLLTFB+WPLLTFC+WPLLTFD CONTROL LINE ONLY ?     00637000
         BNZ   IEASRC12                NO, ERROR AS OTHER LINE TYPES ON 00638000
         TM    XVD2,XVD2CON            CONNECTING ?                     00639000
         BO    IEASRC12                YES, ERROR                       00640000
         OI    XVX0,XVX0FLCL           SET FIRST LINE CONTROL LINE      00641000
         B     IEASTEST                                                 00642000
*                                                                       00643000
*        PROCESS LABEL LINE                                             00644000
*        LABEL FLAG MUST BE THE ONLY FLAG FOR THE LINE                  00645000
*                                                                       00646000
IEASTLAB TM    LINETYPE,WPLLTFA+WPLLTFC+WPLLTFD LABEL LINE ONLY ?       00647000
         BNZ   IEASRC12                NO, OTHER FLAGS ON, ERROR        00648000
         TM    XVX0,XVX0LL2F           LABEL LINE 2 BIT ON ?            00649000
         BO    IEASRC12                YES, DUPLICATE LABEL, ERROR      00650000
         TM    XVX0,XVX0LL1F           LABEL LINE 1 BIT ON ?            00651000
         BO    IEAS1LAB                YES, BRANCH                      00652000
         OI    XVX0,XVX0LL1F           SET LABEL LINE 1 BIT ON          00653000
         TM    XVX0,XVX0FLCL           CONTROL LINE PREVIOUSLY FOUND ?  00654000
         BO    IEASCLF1                YES, BRANCH                      00655000
         CH    R14,KH1                 NO, COUNT = 1 ?                  00656000
         BE    IEASTEST                YES, BRANCH                      00657000
         B     IEASRC12                LABEL LINE INCORRECTLY PLACED    00658000
*                                                                       00659000
IEASCLF1 CH    R14,KH2                 COUNT = 2 ?                      00660000
         BE    IEASTEST                                                 00661000
         B     IEASRC12                NO, ERROR                        00662000
*                                                                       00663000
*        PROCESS SECOND LABEL LINE                                      00664000
*                                                                       00665000
IEAS1LAB TM    XVX0,XVX0FLCL           FIRST LINE CONTROL LINE ?        00666000
         BZ    IEASTC2                 NO, BRANCH                       00667000
         CH    R14,KH3                 COUNT = 3 ?                      00668000
         BNE   IEASRC12                NO, ERROR                        00669000
         B     IEASETL2                                                 00670000
*                                                                       00671000
IEASTC2  CH    R14,KH2                 COUNT = 2 ?                      00672000
         BNE   IEASRC12                NO, ERROR                        00673000
IEASETL2 OI    XVX0,XVX0LL2F           SET LABEL LINE 2 BIT ON          00674000
         B     IEASTEST                                                 00675000
*                                                                       00676000
*        PROCESS DATA LINE                                              00677000
*                                                                       00678000
IEASUPCT TM    LINETYPE,WPLLTFA+WPLLTFB+WPLLTFD  JUST DATA LINE ?       00679000
         BZ    IEASTEST                YES, BRANCH                      00680000
         TM    LINETYPE,WPLLTFA+WPLLTFB  OTHER FLAGS ON ?               00681000
         BNZ   IEASRC12                YES, ERROR                       00682000
         OI    XVX0,XVX0FEDE           SET FORCED END FLAG              00683000
         B     IEASTEST                CHECK FOR END OF LOOP            00684000
*                                                                       00685000
*        INVALID LINE TYPE FLAGS DETECTED                               00686000
*                                                                       00687000
IEASRC12 MVI   XVRETCOD,INVLDLT        SET RETURN CODE TO INDICATE      00688000
*                                      BAD LINETYP                      00689000
*                                                                       00690000
*        PROCESS END LINE                                               00691000
*                                                                       00692000
IEASFEND OI    XVX0,XVX0FEDE           SET FORCE END FLAG               00693000
*                                                                       00694000
*        CHECK IF ALL DONE PROCESSING THIS MLWTO                        00695000
*        CHECK FOR AN END FOUND OR FORCED OR FOR THE LINE               00696000
*        COUNT MET. IF ALL DONE THEN STORE THE LINE COUNT               00697000
*                                                                       00698000
IEASTEST TM    XVX0,XVX0FLJE+XVX0FEDE  END FOUND OR FORCED ?            00699000
         BNZ   IEASTORE                YES, WRAP UP WPL PROCESSING      00700000
         CLM   R14,B'0001',XVX3        ALL MINOR WQE LINES PROCESSED ?  00701000
         BE    IEASTORE                YES                              00702000
*                                      NO, FALL THROUGH TO ADVANCE      00703000
*                                          TO NEXT LINE IN WPL          00704000
*                                                                       00705000
*        INCRMNT                                                        00706000
*                                                                       00707000
*        STEP TO THE NEXT MINOR WQE LINE IN THE WPL                     00708000
*        INSURE THAT THE MINOR WQE TEXT IS CONTAINED WITHIN             00709000
*        THE TEXT STORAGE AREA PASSED BY IEAVVWTO                       00710000
*                                                                       00711000
         LA    R15,4                   SET L'MLWTO EXTENSION HEADER     00712000
         CH    R14,KH1                 FIRST LINE ?                     00713000
         BE    INCRMNTA                YES, USE CURRENT VALUE IN R15    00714000
         LH    R15,WPLML0              GET CURRENT L'LINE               00715000
INCRMNTA LA    R14,1(,R14)             INCR LINE COUNT                  00716000
         AR    R2,R15                  INCR TO REFERENCE NEXT MINOR     00717000
*                                      CONTROL FIELD                    00718000
         LR    R1,R2                   R1 -> NEXT MINOR WQE             00719000
         AH    R1,WPLML0               ADD L'NEXT MINOR WQE             00720000
         C     R1,LASTWPLB             THIS NEXT MINOR WQE ENTIRELY     00721000
*                                      CONTAINED IN THE GETMAINED AREA? 00722000
         BNH   IEASINCC                WITHIN WPL, BRANCH               00723000
*                                      OUTSIDE WPL, ERROR               00724000
         MVI   XVAMOD,MWTOID           IEAVMWTO'S ID FOR D23            00725000
         MVI   XVFNCT,D23VALID         PARMLIST VALIDITY CHECK          00726000
         MVI   XVREASON,D23SIZE        CALLER MODIFIED WPL              00727000
         OI    XVD1,XVD1PERR           ABEND USER                       00728000
         BAL   R0,IEASTOPA             SKIP TO END OF TSTMLWTO          00729000
*                                                                       00730000
IEASINCC MVC   LINETYPE,WPLMLLTF       MOVE LINE TYPE FLAGS FROM        00731000
*                                      MLWTO LINE ENTRY TO LINETYPE     00732000
         TM    LINETYPE,WPLLTFD        END LINE ?                       00733000
         BZ    IEASCKLL                NO, CHECK LINE LENGTH            00734000
         TM    LINETYPE,WPLLTFC        DATA END LINE ?                  00735000
         BO    IEASCKLL                YES, CHECK LINE LENGTH           00736000
         B     IEASTORE                CHECK IF ALL DONE                00737000
*                                                                       00738000
IEASCKLL CLC   WPLML0(2),KH4           LINE LENGTH > 4 ?                00739000
         BH    IEASTCLN                YES, GO CHECK LINE TYPE FLAGS    00740000
         BCTR  R14,0                   DO NOT PUT OUT BAD LINE          00741000
         MVI   XVRETCOD,LINERR         SET RETURN CODE TO ERROR         00742000
*                                      IN THE NO OF LINES               00743000
         OI    XVX0,XVX0FEDE           FORCE END TO MLWTO               00744000
*                                                                       00745000
*        STORE THE COUNT AND SET UP FOR CREATING THE FIRST LINE         00746000
*                                                                       00747000
*        INPUT -                                                        00748000
*        R14 = NUMBER OF LINES TO PROCESS                               00749000
*                                                                       00750000
*        OUTPUT -                                                       00751000
*        COUNT IS STORED IN XVXD0 AND XVX2                              00752000
*        XVD3TXT1 IS SET TO INDICATE THE FIRST LINE IS BEING PROCESSED  00753000
*        XVX0UDCL IS SET IF THE DEFAULT CONTROL LINE IS TO BE USED      00754000
*                                                                       00755000
*                                                                       00756000
IEASTORE STC   R14,XVX3                UPDATE ACTUAL LINE COUNT         00757000
         STC   R14,XVX2                SET UP NO OF LINES TO DO         00758000
         OI    XVD3,XVD3TXT1           INDICATE FIRST LINE PROCESSING   00759000
         TM    XVD1,XVD1PP             PROBLEM PROGRAM ?                00760000
         BZ    IEASSSET                NO, BRANCH                       00761000
         TM    XVD1,XVD1AUTH           KEY 0, SUPVR STATE OR APF AUTH ? 00762000
         BO    IEASSSET                YES, BRANCH                      00763000
         OI    XVX0,XVX0FEDE           NO, SET FORCE END                00764000
*                                                                       00765000
*        DETERMINE IF THE DEFAULT LINE HAS TO BE USED                   00766000
*                                                                       00767000
IEASSSET TM    XVX0,XVX0FLCL           FIRST LINE CONTROL LINE          00768000
         BO    IEASEXIT                YES, NOT GOING TO USE DEFAULT    00769000
         TM    XVD2,XVD2CON            CONNECTING                       00770000
         BO    IEASEXIT                YES, SKIP                        00771000
         TM    WKADSC+1,WPLDESCI       DESC CODE 9 OPERATORS REQUEST ?  00772000
         BZ    IEASEXIT                NO, BRANCH                       00773000
         OI    XVX0,XVX0UDCL           YES, USE DEFAULT CONTROL LINE    00774000
*                                                                       00775000
         DROP  R2                      WPL ADDRESSABILITY DROPPED       00776000
*                                                                       00777000
*        END OF LINE VALIDATION CODE                                    00778000
*                                                                       00779000
*        SET THE LOCAL AND CMS LOCKS                                    00780000
*                                                                       00781000
IEASEXIT L     R1,PARMPTR              R1 -> ESTAE PARMAREA             00782000
         USING PARMLIST,R1                                              00783000
         XC    PARMRTAD,PARMRTAD       CLEAR RETRY ADDRESS              00784000
         DROP  R1                                                       00785000
         BAL   R15,SETLCKS             CALL THE SET LOCK ROUTINE        00786000
         STM   R0,R15,RECREGS          SAVE REGS FOR FRR RECOVERY       00787000
         XC    XVCMAJOR,XVCMAJOR       ZERO MAJOR WQE ADDR              00788000
         TM    XVD2,XVD2CON            CONNECTING MINOR LINES  ?        00789000
         BO    IEAMBMIN                YES, GO BUILD THE MINOR          00790000
*                                      NO, BUILDING THE MAJOR WQE       00791000
*                                                                       00792000
*        BLDMAJ                                                         00793000
*                                                                       00794000
*        THIS SEGMENT CREATES AND BUILDS THE MAJOR WQE OR FIRST         00795000
*        LINE OF THE MLWTO                                              00796000
*                                                                       00797000
*        INPUT -                                                        00798000
*        THE LOCAL AND CMS LOCKS ARE HELD                               00799000
*        THE WPL HAS BEEN CHECKED FOR PROPER LINE TYPES                 00800000
*                                                                       00801000
*        OUTPUT -                                                       00802000
*        A MAJOR WQE IS CONSTRUCTED AND PUT ON THE WQE CHAIN. THE       00803000
*        MAJOR HAS AN EMPTY MINOR CHAINED TO IT                         00804000
*                                                                       00805000
*        THIS SEGMENT GETS A MAJOR WQE                                  00806000
*        INPUT -                                                        00807000
*        UNCMWQNR, UCMWQLM, XVD1PRIV, XVD2CON                           00808000
*        OUTPUT -                                                       00809000
*        R1 PTS AT THE MAJOR WQE IF ONE WAS AVAILABLE                   00810000
*        R1 IS ZERO IF ONE WASN'T AVAILABLE                             00811000
*        THE WQE IS ZEROED OUT                                          00812000
*                                                                       00813000
*        CHECK IF TWO WQES ARE AVAILABLE                                00814000
*                                                                       00815000
IEAJGET0 L     R3,ADDRUCM              R3 -> UCM                        00816000
         USING UCM,R3                                                   00817000
         LH    R2,UCMWQNR              NUMBER OF WQES USED              00818000
         LA    R2,2(,R2)               TWO WQES NEEDED                  00819000
         CH    R2,UCMWQLM              COMPARE WITH LIMIT ON WQES       00820000
         BNH   IEAJGET1                WQES AVAIL, DON'T WAIT           00821000
         DROP  R3                                                       00822000
*                                                                       00823000
*        TWO WQES AREN'T AVAILABLE, CHECK IF USER IS PRIVILEGED         00824000
*                                                                       00825000
         TM    XVD1,XVD1PRIV           CALLER PRIVILEGED ?              00826000
         BO    IEAJGET1                YES, GET WQES                    00827000
*                                                                       00828000
*        USER ISN'T PRIVILEGED. WAIT FOR WQES TO BE FREED               00829000
*                                                                       00830000
         BAL   R14,WAITWQE             WAIT FOR A WQE                   00831000
         B     IEAJGET0                CHECK IF TWO WQES ARE AVAIL      00832000
*                                                                       00833000
IEAJGET1 BAL   R14,GETWQE              GET AND ZERO A WQE               00834000
*                                                                       00835000
*        CHECK IF WQE WAS AVAILABLE                                     00836000
*                                                                       00837000
         LTR   R1,R1                   ADDR RETURNED ?                  00838000
         BNZ   IEAJGET2                YES, STORE ADDR OF MAJOR         00839000
*                                                                       00840000
*        WQE WASN'T AVAILABLE. SET ERROR AND STOP FLAGS                 00841000
*                                                                       00842000
         OI    XVX1,XVX1STOP           STOP PROCESSING WPL              00843000
         OI    XVD1,XVD1PERR           ABEND USER                       00844000
         B     IEAJGET3                SKIP TO CHECK IF WWB ALLOCATED   00845000
*                                                                       00846000
*        SET UP MAJOR FOR PROCESSING                                    00847000
*                                                                       00848000
IEAJGET2 ST    R1,XVCMAJOR             SAVE ADDR OF MAJOR               00849000
         OI    XVD3,XVD3BLDJ           SET BUILD MAJOR FLAG             00850000
*                                                                       00851000
*        CHECK IF A WWB HAS BEEN OBTAINED, IF SO, THEN FREE IT          00852000
*                                                                       00853000
IEAJGET3 ICM   R2,B'1111',XVWWB        WWB ADDR ZERO ?                  00854000
         BZ    IEAJGET4                YES, SKIP FREEING WWB            00855000
*                                                                       00856000
*        FREE THE WWB POINTED AT BY XVWWB                               00857000
*                                                                       00858000
         USING WWB,R2                                                   00859000
         L     R1,WWBFWDPT             R1 -> NEXT WWB FORWARD ON CHAIN  00860000
*                                                                       00861000
*        CONNECT FORWARD WWB TO BACK WWB                                00862000
*                                                                       00863000
         MVC   WWBBCKPT-WWB(4,R1),WWBBCKPT                              00864000
         L     R1,WWBBCKPT                                              00865000
*                                                                       00866000
*        CONNECT BACK WWB TO FORWARD WWB                                00867000
*                                                                       00868000
         MVC   WWBFWDPT-WWB(4,R1),WWBFWDPT                              00869000
         DROP  R2                                                       00870000
*                                                                       00871000
*        OUR WWB IS NOW OUT OF THE CHAIN. FREE IT                       00872000
*                                                                       00873000
         L     R0,WKGETWWB             SET SUBPOOL NO AND SIZE          00874000
         LR    R1,R2                   ADDR OF WWB                      00875000
*                                                                       00876000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES  FREE THE WWB               00877000
*                                                                       00878000
         XC    XVWWB,XVWWB             ZERO WWB ADDR                    00879000
*                                                                       00880000
*        CHECK IF MAJOR WAS OBTAINED                                    00881000
*                                                                       00882000
IEAJGET4 TM    XVX1,XVX1STOP           STOP PROCESSING SET?             00883000
         BO    IEAJOUT                 YES, SKIP TO END AS NO WQE       00884000
*                                                                       00885000
*        A MAJOR WQE WAS OBTAINED. GET A MINOR                          00886000
*                                                                       00887000
         BAL   R14,GETMINOR                                             00888000
*                                                                       00889000
*        CHECK IF A MINOR WAS OBTAINED                                  00890000
*                                                                       00891000
         TM    XVX1,XVX1STOP           STOP PROC FLAG SET               00892000
         BZ    IEAJBINT                NO, GO INIT THE MAJOR            00893000
*                                                                       00894000
*        A MINOR WASN'T AVAILABLE                                       00895000
*        FREE THE MAJOR WQE                                             00896000
*        THIS SEGMENT FREES THE MAJOR WQE OBTAINED BY BLDMAJ            00897000
*        INPUT XVCMAJOR CONTAINS THE WQE ADDR                           00898000
*                                                                       00899000
         L     R3,ADDRUCM              R3 -> UCM                        00900000
         USING UCM,R3                                                   00901000
         L     R0,UCMWQECP             GET WQE CELL POOL ID             00902000
         L     R1,XVCMAJOR             ADDR OF WQE CELL                 00903000
*                                                                       00904000
         FREECELL  CPID=(0),CELL=(1),BRANCH=YES                         00905000
*                                                                       00906000
*        CHECK IF THIS WQE WAS THE LAST ONE IN AN EXTENSION             00907000
*        IF SO FREE THE EXTENSION                                       00908000
*                                                                       00909000
         CH    R15,KH20                EXTENSION EMPTY ?                00910000
         BNE   IEAJFRE2                NO, SKIP FREEING EXTENSION       00911000
*                                      YES, THE PARAMETERS TO FREE THE  00912000
*                                      EXTENSION WERE SETUP BY FREECELL 00913000
         FREEMAIN  R,LV=(0),A=(1),BRANCH=YES                            00914000
*                                                                       00915000
IEAJFRE2 LH    R1,UCMWQNR              DECREMENT COUNT OF WQES          00916000
         BCTR  R1,0                                                     00917000
         STH   R1,UCMWQNR                                               00918000
         XC    XVCMAJOR,XVCMAJOR       INSURE MAJOR ADDR IS ZERO FOR    00919000
*                                      RECOVERY REASONS                 00920000
         DROP  R3                                                       00921000
         B     IEAJOUT                 GET OUT OF THE SEGMENT           00922000
*                                                                       00923000
*        BMAJINIT                                                       00924000
*                                                                       00925000
*        INITIALIZE THE MAJOR WQE SEGMENT                               00926000
*                                                                       00927000
*        INPUT -                                                        00928000
*        XVCMAJOR HAS ADDR OF MAJOR WQE                                 00929000
*        R4       -> TCB                                                00930000
*        ASCBSAVE -> ASCB                                               00931000
*        XVA8 CONTAINS THE TIME OF DAY                                  00932000
*        XVSAV HAS VARIOUS FLAGS SET TO SHOW CONDITION OF WPL           00933000
*                                                                       00934000
*        OUTPUT -                                                       00935000
*        INITIAL PART OF MAJOR WQE IS CONSTRUCTED AND WQE IS ON         00936000
*        THE QUEUE                                                      00937000
*        THE SUSPEND BIT IS SET ON                                      00938000
*        FIRST CHAR OF TEXT IS BLANK                                    00939000
*        TIME AND ROUTE CODES ARE DECODED AND FILLED IN                 00940000
*                                                                       00941000
IEAJBINT L     R8,XVCMAJOR             R8 -> MAJOR WQE                  00942000
         USING WMJMEXT,R8                                               00943000
         OI    WMJMMLW,WMJMMLWB        SET MAJOR FLAG                   00944000
         OI    WMJMBUF,WMJMBUFB+WMJMBUFD  SET IN USE AND GETMAINED      00945000
         USING TCB,R4                                                   00946000
         ST    R4,WMJMTCB              STORE TCB ADDR                   00947000
         MVC   WMJMJTCB,TCBJSTCB       STORE ADDR OF JOB STEP'S TCB     00948000
*                                      INTO MAJOR WQE                   00949000
         L     R7,ASCBSAVE             RESTORE ASCB ADDR                00950000
         USING ASCB,R7                                                  00951000
         MVC   WMJMASID,ASCBASID       MOVE IN ASID OF CALLER           00952000
         DROP  R7                                                       00953000
         L     R3,ADDRUCM              R3 -> UCM                        00954000
         USING UCM,R3                                                   00955000
         ICM   R2,B'1111',UCMWQEND     END OF OUTPUT QUEUE, ZERO ?      00956000
         BNZ   IEAJLNK                 NO, CHAIN TO LAST WQE            00957000
         LA    R2,UCMWTOQ              R2 -> OUTPUT QUEUE               00958000
IEAJLNK  ST    R8,UCMWQEND             PUT NEW WQE AT END OF QUEUE      00959000
         DROP  R8                                                       00960000
         USING WMJMEXT,R2                                               00961000
         MVC   WMJMNXT(3),UCMWQEND+1   PUT NEW WQE ON QUEUE             00962000
         DROP  R2                                                       00963000
         DROP  R3                                                       00964000
         USING WMJMEXT,R8                                               00965000
         MVC   WMJMCS,WKAMCSF          MOVE MCS FLAGS TO WQE            00966000
         TM    XVD1,XVD1AUTH           USER AUTHORIZED ?                00967000
         BZ    IEAJQ0CK                NO, CHECK ON USE OF QREG0        00968000
         OI    WMJMDSP,WMJMDSPH        YES, SET USER AUTHORIZED FLAG    00969000
         B     IEAJTIME                SKIP TO UNPACK THE TIME          00970000
*                                                                       00971000
IEAJQ0CK TM    WMJMCS1,WMJMCS1H        QREG0 BIT ON ?                   00972000
         BZ    IEAJTIME                NO, SKIP TO UNPACK               00973000
*                                                                       00974000
*        QREG0 FLAG IS ON                                               00975000
*        AN UNAUTHORIZED USER CAN'T USE THE QREG0 MCS FUNCTION          00976000
*        TURN THE FLAG OFF                                              00977000
*                                                                       00978000
         OI    WMJMCS1,WMJMCS1B        TURN ON REG0 BIT INSTEAD         00979000
         NI    WMJMCS1,255-WMJMCS1H    TURN OFF QREG0 FLAG              00980000
IEAJTIME MVC   WQEPAD(9),PATTIME       MOVE IN THE TIME EDIT PATTERN    00981000
         ED    WQEPAD(9),XVA8          FORMAT TIME HH.MM.SS INTO WQETS  00982000
         MVI   WMJMPAD1,C' '           BLANK CHAR AFTER TIME            00983000
*                     WQEPAD2=' ';  /* INSERT BLANK AFTER THE JOBNAME*/ 00984000
         MVI   WQEPAD2,C' '                                             00985000
*                     WQEJOBNM=' '; /* BLANK OUT THE JOB NAME FIELD  */ 00986000
         MVI   WQEJOBNM,C' '                                            00987000
         MVC   WQEJOBNM+1(L'WQEJOBNM-1),WQEJOBNM                        00988000
         MVC   WMJMRR,KC0000           INIT ROUTE CODES TO CHAR ZERO    00989000
         TM    WKAMCSF,WPLMCSFA        ROUT/DESC CODES PROVIDED ?       00990000
         BZ    IEAJTID1                NO, CHECK MSG TYPE               00991000
         MVC   WMJMRTC(2),WKAROC       MOVE ROUTING CODES INTO WQE      00992000
         MVC   WMJMDEC(2),WKADSC       MOVE DESCRIPTOR CODES INTO WQE   00993000
*                                                                       00994000
*        LOOP TO CONVERT ROUTING CODES TO CHARACTER FORMAT              00995000
*                                                                       00996000
         LR    R0,R4                   SAVE TCB ADDR                    00997000
         LA    R1,4                    SET LOOP COUNTER                 00998000
         L     R5,WMJMRTC              ROUTING CODES                    00999000
IEAJRCLP SR    R4,R4                   SET UP FOR SHIFT                 01000000
         SLL   R15,8                   MOVE ROUTING CODES TO R15        01001000
         SLDL  R4,4                                                     01002000
         IC    R15,HEXCHAR(R4)         CONVERT ROUTING CODES            01003000
         BCT   R1,IEAJRCLP             TO PRINTABLE FORM                01004000
         STCM  R15,B'1111',WMJMRR      STORE IN MAJOR WQE               01005000
         LR    R4,R0                   RESTORE TCB ADR                  01006000
*                                                                       01007000
*        END OF ROUTING CODE CONVERSION LOOP                            01008000
*                                                                       01009000
         MVI   WMJMPAD,C' '            BLANK AFTER ROUT CODES           01010000
         MVC   WMJMMT1,WKAMSGTY        MOVE MESSAGE TYPE TO WQE         01011000
IEAJTID1 TM    WKAMCSF,WPLMCSFB+WPLMCSFH  CONSOLE ID PASSED ?           01012000
*                                         QREG0 OR REG0                 01013000
         BZ    IEAJAREA                NO, GO TO AREA ID                01014000
         MVC   WMJMUID,XVCONID         YES, MOVE CONSOLE ID             01015000
IEAJAREA L     R2,ADDRMLHR             R2 -> MLWTO EXTENSION HEADER     01016000
         USING WPLLTF,R2                                                01017000
         MVC   WMJMAREA,WPLAREA        MOVE AREA ID INTO MAJOR          01018000
         TM    XVD1,XVD1AUTH           CALLER AUTHORIZED ?              01019000
         BO    IEAJMBLK                YES. DONT INSERT DEFAULT FOR P/P 01020000
*                                                                       01021000
*        NON AUTHORIZED USERS OF MLWTO GET AN AREA ID OF 'Z' OR ONLINE  01022000
*                                                                       01023000
*        THIS IS TO PREVENT AN UNAUTHORIZED CALLER FROM MESSING         01024000
*        WITH AN AREA BEING USED BY A DYNAMIC STATUS DISPLAY MLWTO      01025000
*                                                                       01026000
         MVI   WMJMAREA,C'Z'           AREA GETS SET TO INLINE (Z)      01027000
IEAJMBLK MVI   WMJMTXT,C' '            BLANK FIRST CHARACTER            01028000
         MVC   WORKBYTE,WMJMAREA                                        01029000
         NI    WORKBYTE,X'0F'                                           01030000
         TM    WMJMAREA,X'F0'                                           01031000
         BO    IEA00690                                                 01032000
         TM    WMJMAREA,X'E0'                                           01033000
         BO    IEA00668                                                 01034000
         TM    WMJMAREA,X'D0'                                           01035000
         BO    IEA00678                                                 01036000
         TM    WMJMAREA,X'C0'                                           01037000
         BO    IEA00678                                                 01038000
         B     IEA00690                                                 01039000
*                                                                       01040000
IEA00668 CLI   WORKBYTE,X'02'                                           01041000
         BL    IEA00690                                                 01042000
         BE    IEA00694                                                 01043000
         B     IEA00684                                                 01044000
*                                                                       01045000
IEA00678 CLI   WORKBYTE,X'01'                                           01046000
         BL    IEA00690                                                 01047000
         BE    IEA00694                                                 01048000
IEA00684 CLI   WORKBYTE,X'09'                                           01049000
         BH    IEA00690                                                 01050000
         B     IEA00694                                                 01051000
*                                                                       01052000
IEA00690 MVI   WMJMAREA,C'Z'                                            01053000
IEA00694 TM    XVD2,XVD2QFHC           QUEUE MESSAGE TO HARD COPY ?     01054000
         BZ    IEA006A0                NO, BRANCH                       01055000
         OI    WMJMDSP,WMJMDSPB        YES, QUEUE WQE TO HARDCOPY       01056000
IEA006A0 TM    WMJMCS2,WMJMCS2F        BYPASS HARD COPY QUEUING ?       01057000
         BZ    IEAJEND                 NO, BRANCH                       01058000
         OI    WMJMBUF,WMJMTRCD                                         01059000
*                                                                       01060000
*        CHECK IF THIS MLWTO SHOULD BE QUEUED TO HC DUE TO CHANGE       01061000
*        IN THE ROUTE CODES BY THE INSTALLATION EXIT                    01062000
*                                                                       01063000
*        END OF BMAJINIT SEGMENT                                        01064000
*                                                                       01065000
IEAJEND  TM    XVX0,XVX0FLCL           FIRST LINE CONTROL LINE ?        01066000
         BO    IEAJLEN4                YES, SKIP TO SET UP FIRST LINE   01067000
         TM    XVX0,XVX0UDCL           USE DEFAULT CONTROL LINE         01068000
         BZ    IEAJLEN4                NO, SKIP TO SET UP FIRST LINE    01069000
*                                                                       01070000
*        SET UP TO MOVE IN THE DEFAULT CONTROL LINE                     01071000
*        THIS IN EFFECT ADDS AN EXTRA LINE TO THE WTO                   01072000
*        THE FIRST LINE IN THE WPL IS NOW PROCESSED AS A LABEL          01073000
*        OR DATA LINE                                                   01074000
*                                                                       01075000
         LA    R15,KIEE932I            USE DEFAULT CONTROL LINE         01076000
         LA    R3,L'KIEE932I           R3 = L' DEFAULT CONTROL LINE     01077000
         LA    R14,WMJMTXT+2           R14 -> TEXT POSITION IN MAJOR    01078000
         B     IEAJMOVM                                                 01079000
*                                                                       01080000
*        BMAJFSTL                                                       01081000
*                                                                       01082000
*        SET UP THE FIRST LINE FOR THE MOVE INTO THE MAJOR              01083000
*        INPUT -                                                        01084000
*        R8 -> MAJOR WQE                                                01085000
*        R2 -> WPLLTF FIELD (MLWTO EXTENSION )                          01086000
*                                                                       01087000
*        OUTPUT -                                                       01088000
*        R15 -> TEXT SOURCE                                             01089000
*        R14 -> TARGET                                                  01090000
*        R3   = L'TEXT TO BE MOVED                                      01091000
*                                                                       01092000
*        PROCESS CONTROL LINE                                           01093000
*                                                                       01094000
IEAJLEN4 LH    R3,WKALGH               R3 = L'MAJOR WQE TEXT + 4        01095000
         SH    R3,KH4                  R3 = L'MAJOR WQE TEXT            01096000
         LA    R14,WMJMTXT+2           R14 -> TEXT POSITION IN WQE      01097000
         L     R15,WKAADTXT            R15 -> LL + MCS + TEXT           01098000
         LA    R15,4(,R15)             R15 -> TEXT                      01099000
         TM    WPLLTF,WPLLTFA          CONTROL LINE ?                   01100000
         BZ    IEAJLNLD                NO                               01101000
         LA    R5,34                   YES, SET L'MAX FOR CONTROL LINE  01102000
         TM    XVD1,XVD1AUTH           USER AUTHORIZED ?                01103000
         BZ    IEAJCHK1                NO, USE LENGTH OF 34 CHAR        01104000
         LA    R5,35                   AUTH USERS CAN HAVE 35 CHARS     01105000
IEAJCHK1 CR    R3,R5                   LENGTH > ALLOWED FOR CNTL LINE ? 01106000
         BNH   IEAJMOVM                NO, MOVE TEXT                    01107000
         LR    R3,R5                   YES, TRUNCATE TO MAX LENGTH      01108000
         B     IEAJMOVM                MOVE TEXT INTO MAJOR             01109000
*                                                                       01110000
*        PROCESS LABEL OR DATA LINE                                     01111000
*                                                                       01112000
IEAJLNLD LA    R5,70                   SET L'MAX FOR LABELA AND DATA    01113000
         TM    XVD1,XVD1AUTH           USER AUTHORIZED ?                01114000
         BZ    IEAJCHK2                NO, USE LENGTH OF 70 CHAR        01115000
         LA    R5,71                   YES,AUTH USERS CAN HAVE 71 CHARS 01116000
IEAJCHK2 CR    R3,R5                   LENGTH > MAX DATA OR LABEL LINE? 01117000
         BNH   IEAJMOVM                NO, MOVE TEXT                    01118000
         LR    R3,R5                   YES, TRUNCATE TO MAX LENGTH      01119000
*                                                                       01120000
*        BMAJMVMS                                                       01121000
*                                                                       01122000
*        MOVE THE MESSAGE INTO THE MAJOR WQE                            01123000
*        INPUT -                                                        01124000
*        R3   = L'MESSAGE                                               01125000
*        R8  -> MAJOR WQE                                               01126000
*        R14 -> TEXT AREA IN WQE                                        01127000
*        R15 -> MESSAGE TEXT                                            01128000
*                                                                       01129000
*        OUTPUT -                                                       01130000
*        THE TEXT WITH AUTHORIZATION FLAGS IS MOVED INTO THE WQE        01131000
*        THE LENGTH AND SEQUENCE NUBMER ARE ALSO ADDED TO THE           01132000
*        WQE                                                            01133000
*                                                                       01134000
IEAJMOVM LR    R5,R3                   LENGTH FOR EXECUTE               01135000
         BCTR  R5,0                    DECR FOR EX                      01136000
         EX    R5,IEAMEXMV             MVC   0(0,R14),0(R15)            01137000
*                                                                       01138000
*        TRUNCATE MESSAGE TO REMOVE TRAILING BLANKS                     01139000
*                                                                       01140000
IEAJBLKL LTR   R5,R5                   R5 ZERO YET ?                    01141000
         BZ    IEAJBLKE                YES, THEN TEXT WAS ALL BLANK     01142000
         LA    R1,0(R5,R14)            R1 -> TEXT CHAR                  01143000
         CLI   R1,C' '                 CHARACTER BLANK ?                01144000
         BNE   IEAJBLKE                NO, GET OUT OF LOOP              01145000
         BCTR  R5,0                    YES DECR INDEX INTO TEXT         01146000
         B     IEAJBLKL                LOOP AND TEST FOR END            01147000
*                                                                       01148000
*        IF THE TEXT WAS ALL BLANK THEN ONLY ONE BLANK IS USED          01149000
*        THE FOLLOWING INSTRUCTION PUTS THE CORRECT LENGTH INTO         01150000
*        R3 WHEN THE TEXT IS ALL BLANK OR NOT ALL BLANKS                01151000
*                                                                       01152000
IEAJBLKE LA    R3,1(,R5)               SET R3 TO L'TEXT                 01153000
*                                      WITH TRAILING BLANKS TRUNCATED   01154000
         TM    WMJMDEC1,WMJMDECA+WMJMDECB  DESC CODE 1 OR 2 ?           01155000
         BNZ   IEA0076E                YES, GO CHECK AUTHORIZATION      01156000
         TM    WMJMDEC2,WMJMDECK       CRITICAL EVENTUAL ACTION MSG ?   01157000
         BNZ   IEAJAUT1                NO, BRANCH                       01158000
         TM    XVD1,XVD1AUTH           APF AUTHORIZED ?                 01159000
         BO    IEAJSTXT                YES, OMIT P/P FLAG               01160000
         MVI   WMJMTXT+1,PPWTOFLG      + FLAG, PROB PGM - NO ACTION MSG 01161000
         LA    R3,2(,R3)               UPDATE LENGTH                    01162000
         B     IEAJSTOR                                                 01163000
*                                                                       01164000
IEAJAUT1 TM    XVD1,XVD1AUTH           AUTHORIZED ?                     01165000
         BZ    IEAJMVAT                NO, BRANCH                       01166000
         B     IEA00776                                                 01167000
*                                                                       01168000
IEA0076E TM    XVD1,XVD1AUTH           AUTHORIZED ?                     01169000
         BZ    IEA0077E                NO, BRANCH                       01170000
IEA00776 MVI   WMJMTXT,SUPACFLG        * FLAG, SUPERVISOR ACTION MSG    01171000
         B     IEAJSTXT                                                 01172000
*                                                                       01173000
IEA0077E OI    WMJMDEC1,WMJMDECG       TURN ON DESC CODE 7              01174000
*                                      APPLICATION PROGRAM MESSAGE      01175000
*                                                                       01176000
*        ISSUER IS A NON-AUTHORIZED PROGRAM PROBLEM                     01177000
*        DESC CODE 1 OR 2 SPECIFIED                                     01178000
*        FORCE DESC CODE 7 ON SO MLWTO WILL BE DOMMED AT TASK           01179000
*        TERMINATION                                                    01180000
*                                                                       01181000
IEAJMVAT MVI   WMJMTXT,PPACTFLG        @ FLAG, PROB PGM ACTION MSG FLAG 01182000
*                                                                       01183000
*        SHUFFLE TEXT DOWN ONE BYTE                                     01184000
*                                                                       01185000
IEAJSTXT LA    R14,WMJMTXT+1           SHIFT TEXT TO CHAR POS 2         01186000
         LA    R15,WMJMTXT+2           SET REGS FOR TEXT SHIFT          01187000
         LR    R5,R3                   LENGTH FOR EXECUTE               01188000
         BCTR  R5,0                    DECR FOR EXECUTE                 01189000
         EX    R5,IEAMSHFT             SHIFT TEXT 1 CHAR TO THE LEFT    01190000
*                                      MVC   0(0,R14),0(R15)            01191000
         LA    R14,WMJMTXT+1           R14 -> TEXT+1                    01192000
         AR    R14,R3                  ADD L'TEXT                       01193000
         MVI   0(R14),0                ZERO FIRST CHAR AFTER TEXT       01194000
         LA    R3,1(,R3)               UPDATE LENGTH                    01195000
IEAJSTOR STH   R3,WMJMTXTL             STORE TEXT LENGTH                01196000
         L     R1,ADDRUCM              R1 -> UCM                        01197000
         SH    R1,KH4                  SUBTRACT TO REFERENCE PREFIX PTR 01198000
         L     R1,0(,R1)               LOAD UCM PREFIX ADDR             01199000
*                                                                       01200000
*        PLACE UCM SEQUENCE NUMBER INTO THE WQE                         01201000
*        SETUP TO PASS BACK THE UCM SEQUENCE NUMBER TO THE CALLER       01202000
*        INCREMENT THE UCM SEQUENCE NUMBER                              01203000
*                                                                       01204000
         USING UCMPRFX,R1                                               01205000
         MVC   WMJMSEQ(3),UCMCMID+1    MOVE SEQ NO TO MAJOR             01206000
         MVC   WMJMMSGN+1(3),UCMCMID+1  MLWTO ID                        01207000
         MVC   XVWQEIDA,UCMCMID+1      SAVE MSG ID FOR NEXT LINES       01208000
*                                      FOR PASS BACK TO THE CALLER      01209000
         L     R5,UCMCMID                                               01210000
         CVD   R5,WORK8                CONVERT ID TO DECIMAL            01211000
         LA    R5,1(,R5)               INCREMENT SEQ NUMBER             01212000
         ST    R5,UCMCMID              STORE UPDATED SEQ NO IN UCM      01213000
         MVC   WMJMHCID,PATUCMID       MOVE IN PATTERN FOR ED INST      01214000
         ED    WMJMHCID,WORK8+6        CONVERT TO PRINTABLE FORM        01215000
         DROP  R1                                                       01216000
         TM    WMJMDEC2,WMJMDECI       DESCRIPTOR CODE 9 ?              01217000
         BZ    IEAJONNN                NO, NO UCM SEQ ON CONTROL LINE   01218000
*                                                                       01219000
*        DESCRIPTOR CODE 9 PROCESSING                                   01220000
*        PLACE UCM SEQUENCE NUMBER AT END OF TEXT                       01221000
*                                                                       01222000
         LA    R15,WMJMTXT             R15 -> TEXT IN MAJOR             01223000
         AH    R15,WMJMTXTL            ADD LENGTH TO TEXT ADDR          01224000
         MVC   0(L'WMJMHCID,R15),WMJMHCID  MOVE ID TO END OF TEXT       01225000
         MVI   L'WMJMHCID(R15),C' '    PUT BLANK AFTER ID IN MSG        01226000
         LH    R3,WMJMTXTL             R3 = L'TEXT                      01227000
         LA    R3,L'WMJMHCID+1(,R3)    INCR LENGTH FOR ID               01228000
         STH   R3,WMJMTXTL             SAVE UPDATED L'TEXT              01229000
*                                                                       01230000
IEAJONNN OI    WMJMDSP,WMJMDSPG        SET MAJOR SUSPENDED              01231000
         TM    XVX0,XVX0UDCL           USE DEFAULT CONTROL LINE ?       01232000
         BZ    IEAJMVLT                NO, MOVE IN LINE TYPE FLAGS      01233000
*                                                                       01234000
*        THE DEFAULT CONTROL LINE IS BEING USED                         01235000
*                                                                       01236000
*        THE FIRST MESSAGE TEXT IN THE WPL WILL BE PROCESSED AS         01237000
*        A LABEL OR DATA MESSAGE                                        01238000
*                                                                       01239000
         OI    WMJMLTYP,WMJMLTYA       YES, SET LINE TYPE TO CONTROL    01240000
         B     IEAJOUT                 END OF SEGMENT                   01241000
*                                                                       01242000
IEAJMVLT MVC   WMJMLTYP,WPLLTF         MOVE LINE TYPE FLAGS TO MAJOR    01243000
         DROP  R2                                                       01244000
         BAL   R14,TEXTLINE            INCR TO NEXT LINE                01245000
         BAL   R14,ENDUP                                                01246000
IEAJOUT  OI    XVD2,XVD2CON            INSURE CONNECTING BIT IS SET     01247000
         B     IEAMSTTS                GO TEST IF STOP WAS SET          01248000
*                                                                       01249000
*        START OF BLDMIN SEGMENT                                        01250000
*        BUILD THE MINOR WQE                                            01251000
*                                                                       01252000
IEAMBMIN BAL   R14,FINDID              FIND ID FOR CONNECTING TO        01253000
         TM    XVX1,XVX1NOID           ID FOUND ?                       01254000
         BZ    IEA1YID                 YES, CHECK IF MINOR NEEDED       01255000
*                                                                       01256000
*        NO ID FOUND. STOP PROCESSING                                   01257000
*                                                                       01258000
         OI    XVX1,XVX1STOP           SET STOP PROCESSING FLAG         01259000
         B     IEAMSTTS                                                 01260000
*                                                                       01261000
IEA1YID  L     R8,XVCMAJOR             R8 -> MAJOR WQE                  01262000
         USING WMJMEXT,R8                                               01263000
         OI    WMJMMLW,WMJMMLWD        SET CHAIN ALTERED FLAG           01264000
*                                                                       01265000
*        THERE WILL ALWAYS BE A MINOR WQE QUEUED OFF THE MAJOR          01266000
*        FINDID WILL STORE THE ADDRESS OF THE MINOR TO USE IN           01267000
*        XVCMINOR FOR US                                                01268000
*                                                                       01269000
         L     R7,XVCMINOR             R7 ->MINOR WQE FOR CONNECTING TO 01270000
         TM    XVD3,XVD3BLD1+XVD3BLD2  BOTH LINES AVAILABLE ?           01271000
         BNZ   IEA1TLN1                BRANCH, EITHER LINE AVAILABLE    01272000
*                                                                       01273000
*        NO LINE AVAILABLE IN LAST MINOR. GET ANOTHER ONE               01274000
*                                                                       01275000
IEA1ALOC L     R3,ADDRUCM              R3 -> UCM                        01276000
         USING UCM,R3                                                   01277000
         CLC   UCMWQNR,UCMWQLM         WQE AVAILABLE ?                  01278000
         BL    IEA1GETN                YES, GET A MINOR                 01279000
         TM    XVD1,XVD1PRIV           PRIVILEGED USER ?                01280000
         BO    IEA1GETN                YES, WQES ALWAYS AVAILABLE       01281000
         DROP  R3                                                       01282000
*                                                                       01283000
*        BRANCH TO THE WAIT ROUTINE AND WAIT WITHOUT AN ECB             01284000
*        THIS TYPE OF WAIT IS DONE SO THAT CONTROL WILL RETURN          01285000
*        BACK AFTER OUT MAJOR HAS BEEN DELETED BY IEAVMDSV              01286000
*        THE BRANCH ENTRY IS USED SO THAT WE HOLD THE LOCAL             01287000
*        LOCK. THIS PREVENTS US FROM BEING POSTED BEFORE WE ISSUE       01288000
*        THE WAIT TURN ON THE WAITING BIT IN THE MAJOR WQE              01289000
*                                                                       01290000
         OI    WMJMECBF,WMJMWAIT                                        01291000
*                                                                       01292000
*        DONT ALLOW ASYNCHRONOUS EXITS TO BE DISPATCHED WHILE           01293000
*        WAITING FOR A WQE. THIS COULD CAUSE AN INTERLOCK IF THE        01294000
*        RB ISSUED A WTO THAT THEN WAITED                               01295000
*        SET ADDRESSABILITY TO TCB AND SAVE R4                          01296000
*                                                                       01297000
         ST    R4,REG4SAV              SAVE ADDR OF TEXT LINE           01298000
         L     R4,TCBSAVE              RESTORE TCB ADDR                 01299000
         USING TCB,R4                                                   01300000
         NI    XVD3,255-XVD3TFX        TURN OFF 'MWTO SET TFX' FLAG     01301000
         TM    TCBFLGS1,TCBFX          ASYNCH EXITS NOT ALLOWED ?       01302000
         BO    IEA1NSET                YES, DONT SET THE TCBFX FLAG     01303000
*                                                                       01304000
*        THE ASYNCHRONOUS EXITS ARENT ALLOWED BY SOME OTHER             01305000
*        ROUTINE SO WE SHOULD LEAVE THE TCBFX BIT ALONE                 01306000
*                                                                       01307000
         OI    TCBFLGS1,TCBFX          NO, FLAG NOT SET SO SET IT       01308000
         OI    XVD3,XVD3TFX            SET FLAG SHOWING THAT            01309000
*                                                                       01310000
*        SET THE TCBFX FLAG SO CAN TURN IT OFF FREE THE CMS LOCK        01311000
*                                                                       01312000
IEA1NSET ST    R11,REG11SAV            SAVE BASE REG                    01313000
         ST    R12,REG12SAV            SAVE XV BASE                     01314000
         ST    R9,REG9SAV                                               01315000
         LR    R0,R13                  SAVE ADDR OF MODULE WORKAREA     01316000
*                                                                       01317000
*        FREE THE FRR                                                   01318000
*                                                                       01319000
         SETFRR D,WRKREGS=(9,12)                                        01320000
         LA    R12,EPARM               R12 -> ESTAE PARM AREA           01321000
         ST    R12,PARMPTR             PT TO ESTAE PARM AREA            01322000
*                                                                       01323000
         SETLOCK RELEASE,TYPE=CMS,RELATED=(UCM,IEAVMWTO(SETLCKS))       01324000
*                                                                       01325000
         LR    R13,R0                  RESTORE WORKAREA BASE            01326000
         L     R9,REG9SAV              RESTORE R9, R11 AND R12          01327000
         L     R11,REG11SAV                                             01328000
         L     R12,REG12SAV                                             01329000
*                                                                       01330000
*        SET UP FOR BRANCH ENTRY TO WAIT                                01331000
*                                                                       01332000
*        SET UP RETURN ADDR FROM WAIT BY STORING THE RETURN POINT       01333000
*        ADDR IN THE OLD PSW IN OUR RB                                  01334000
*                                                                       01335000
         LA    R15,IEA1WTRT            LOAD ADDR OF RETURN POINT        01336000
         ST    R15,RBOPSW+4            SAVE IN RB                       01337000
         ST    R12,WMJMAECB            STORE RB ADDR IN MAJOR           01338000
*                                                                       01339000
*        IEAVMDSV USES ADDR IN WMJMAECB AS THE RB TO POST               01340000
*                                                                       01341000
         L     R1,CVTPTR               ADDR THE CVT                     01342000
         USING CVT,R1                                                   01343000
         L     R15,CVTVWAIT            BRANCH ENTRY TO WAIT             01344000
         DROP  R1                                                       01345000
         SR    R1,R1                   WAIT WITHOUT ECB                 01346000
         LA    R0,1                    WAIT COUNT OF ONE                01347000
         STM   R0,R15,TCBGRS           STORE ALL REGS IN TCB            01348000
         BR    R15                     BRANCH ENTRY TO WAIT             01349000
*                                                                       01350000
*        THE REGISTERS ARE RESTORED BY WAIT                             01351000
*        WAIT WILL FREE THE LOCAL LOCK                                  01352000
*        GET BOTH LOCKS BEFORE RESUMING PROCESSING                      01353000
*                                                                       01354000
IEA1WTRT BAL   R15,SETLCKS             SET LOCAL AND CMS LOCKS          01355000
*                                                                       01356000
*        CHECK IF NEED TO TURN OFF THE TCBFX FLAG                       01357000
*        R4 -> TCB                                                      01358000
*                                                                       01359000
         TM    XVD3,XVD3TFX            TCBFX FLAG SET ?                 01360000
         BZ    IEA1RSET                NO, LEAVE FLAG ALONE             01361000
         NI    TCBFLGS1,255-TCBFX      YES, TURN TCBFX FLAG OFF         01362000
         DROP  R4                                                       01363000
IEA1RSET L     R4,REG4SAV              RESTORE R4 -> CURRENT LINE       01364000
         B     IEAMBMIN                FIND ID AGAIN TO INSURE THAT IT  01365000
*                                      HAS NOT BEEN PURGED WHILE SYSTEM 01366000
*                                      WAS ENABLED                      01367000
IEA1GETN BAL   R14,GETMINOR            GET A MINOR WQE                  01368000
*                                                                       01369000
*        BUILD LINE 1 OF A MINOR WQE                                    01370000
*                                                                       01371000
IEA1TLN1 OI    WMJMDSP,WMJMDSPG        SET MAJOR SUSPENDED              01372000
         TM    XVD3,XVD3BLD1           BUILD LINE 1 OF MINOR ?          01373000
         BZ    IEA2BLN2                NO, CHECK IF LINE 2              01374000
*                                                                       01375000
*        INITIALIZE LINE 1 OF THE MINOR                                 01376000
*                                                                       01377000
         L     R7,XVCMINOR             R7 -> MINOR                      01378000
         NI    WMJMMLW,255-WMJMMLWH    TURN OFF DUMMY MINOR FLAG        01379000
         DROP  R8                                                       01380000
         USING WMNMEXT,R7                                               01381000
         MVC   WMNMUC1(1),0(R8)        MOVE USE COUNT TO MINOR LINE 1   01382000
         NI    XVD3,255-XVD3BLD1       RESET BUILD LINE 1 FLAG          01383000
         OI    WMNMML2,WMNMML2H        SET 2ND LINE AVAILABLE           01384000
         TM    XVD3,XVD3TXT1           TEXT LINE 1 BEING USED ?         01385000
         BZ    IEA1TXL2                NO, MOVE LINE TYPE TO WQE        01386000
*                                      YES, SETUP TO MOVE FIRST         01387000
*                                      LINE INTO WQE                    01388000
         L     R15,WKAADTXT            R15 -> FIRST TEXT LINE           01389000
         LA    R15,4(,R15)             R15 -> TEXT                      01390000
         LH    R3,WKALGH               R3 = L'TEXT + 4                  01391000
         L     R2,ADDRMLHR             R2 -> MLWTO EXTENSION HEADER     01392000
*                                            FOR ACCESS TO LINE TYPE    01393000
         B     IEA1VTYP                                                 01394000
*                                                                       01395000
*        SETUP TO USE SECOND OR SUBSEQUENT TEXT LINES                   01396000
*                                                                       01397000
         USING WPLML,R4                R4 -> SUBSEQUENT LINE TO USE     01398000
IEA1TXL2 LA    R15,WPLMLTXT            R15 -> TEXT                      01399000
         LH    R3,WPLML0               R3 =L'THIS LINE                  01400000
         LA    R2,WPLMLLTF             R2 -> LINE TYPE FLAGS            01401000
         DROP  R4                                                       01402000
IEA1VTYP MVC   WMNMLT1(1),0(R2)        MOVE LINE TYPE TO MINOR          01403000
*                                      FROM EITHER THE MLWTO            01404000
*                                      EXTENSION HEADER OR FROM THE     01405000
*                                      SECOND OR SUBSEQUENT LINE        01406000
         TM    XVX0,XVX0FLJE           FIRST LINE JUST AN END LINE ?    01407000
         BO    IEA1DECR                YES, SKIP MOVING THE MSG         01408000
         TM    WMNMLT1,WMNMLT1D        THIS LINE END LINE ?             01409000
         BZ    IEA1TXTL                NO, GET TEXT LENGTH              01410000
         TM    WMNMLT1,WMNMLT1C        DATA AND END LINE ?              01411000
         BZ    IEA1DECR                NO, JUST END LINE                01412000
*                                                                       01413000
*        MIN1MOV                                                        01414000
*                                                                       01415000
*        MOVE IN LINE 1 OF THE MINOR                                    01416000
*        SET UP FOR MESSAGE LENGTH TEST                                 01417000
*                                                                       01418000
IEA1TXTL SH    R3,KH4                  ADJUST TEXT LENGTH               01419000
*                                                                       01420000
*        CHECK IF USER IS AUTHORIZED. IF SO ALLOW 71 CHARS IN TEXT      01421000
*                                                                       01422000
         LA    R1,70                   R1 =L'MAX OF UNAUTHORIZED CALLER 01423000
         TM    XVD1,XVD1AUTH           CALLER AUTHORIZED ?              01424000
         BZ    IEA1TXT2                NO, THEN ONLY ALLOW 70 CHARS     01425000
         LA    R1,71                   YES, LET USER PUT OUT 71 CHARS   01426000
IEA1TXT2 CR    R3,R1                   EXCEED MAXIMUM ALLOWED L'LINE    01427000
         BNH   IEA1BLK1                NO, USE TEXT LENGTH              01428000
         LR    R3,R1                   OTHERWISE, TRUNCATE              01429000
IEA1BLK1 MVI   WMNMTXT1,C' '           MOVE BLANK AS FIRST CHAR         01430000
         TM    XVD1,XVD1AUTH           USER APF AUTHORIZED ?            01431000
         BZ    IEA1OVE3                NO, BRANCH                       01432000
         LA    R14,WMNMTXT1+1          R14 -> MINOR WQE TEXT AREA       01433000
         LR    R5,R3                   LENGTH FOR EXECUTE               01434000
         BCTR  R5,0                    DECR FOR EXECUTE                 01435000
         EX    R5,IEAMVTXT             MOVE TEXT TO MINOR WQE           01436000
*                                      MVC   0(0,R14),0(R15)            01437000
         LA    R3,1(,R3)               UPDATE TEXT LENGTH               01438000
         B     IEA1STL1                                                 01439000
*                                                                       01440000
*        PROCESS UNAUTHORIZED REQUEST                                   01441000
*                                                                       01442000
IEA1OVE3 MVI   WMNMTXT1+1,C' '         BLANK SECOND CHAR                01443000
         LA    R14,WMNMTXT1+2          R14 -> MINOR WQE TEXT AREA       01444000
         LR    R5,R3                   LENGTH FOR EXECUTE               01445000
         BCTR  R5,0                    DECR  FOR EX                     01446000
         EX    R5,IEAMVTXT             MOVE TEXT                        01447000
*                                      MVC   0(0,R14),0(R15)            01448000
         LA    R3,2(,R3)               UPDATE TEXT LENGTH               01449000
IEA1STL1 STC   R3,WMNMTL1              STORE TEXT LENGTH IN MINOR       01450000
         LA    R14,WMNMTXT1            R14 -> TEXT AREA 2               01451000
         L     R8,XVCMAJOR             R8 -> MAJOR WQE                  01452000
         MVC   WMNMHCT1,WMJMHCID-WMJMEXT(R8)  MOVE HARD COPY ID         01453000
*                                      FROM MAJOR T0 MINOR WQE          01454000
*                                                                       01455000
*        TRUNCATE ANY TRAILING BLANKS                                   01456000
*                                                                       01457000
IEA1LOOP BCT   R3,IEA1LOOA             DECR INDEX INTO TEXT             01458000
         B     IEA1DONE                ZERO, LOOP COMPLETED             01459000
IEA1LOOA LA    R15,0(R3,R14)           R15 -> NEXT CHAR                 01460000
         CLI   0(R15),C' '             BLANK ?                          01461000
         BE    IEA1LOOP                YES, RE-ENTER LOOP               01462000
*                                                                       01463000
IEA1DONE LA    R3,1(,R3)               R3 NOW HAS CORRECT LENGTH        01464000
         STC   R3,WMNMTL1                                               01465000
         BAL   R14,TEXTLINE            UPDATE TEXT POINTER              01466000
         B     IEA1DECR                SKIP TO ENDUP ROUTINE            01467000
*                                                                       01468000
*        MIN2INIT                                                       01469000
*                                                                       01470000
*        BUILD LINE 2 OF A MINOR WQE                                    01471000
*                                                                       01472000
IEA2BLN2 L     R7,XVCMINOR             R7 -> MINOR WQE                  01473000
         MVC   WMNMUC2(1),0(R8)        COPY USE COUNT FROM MAJOR        01474000
         LA    R2,WMNMUC2              R2 -> 2ND MINOR LINE             01475000
         O     R2,WMNMUC1              PRESERVE USE COUNT               01476000
         ST    R2,WMNMUC1              CHAIN TO FIRST LINE              01477000
         OI    WMNMML2,WMNMML2C        INDICATE MINOR                   01478000
         NI    XVD3,255-XVD3BLD2       TURN OFF BUILD 2ND LINE FLAG     01479000
         NI    WMNMML2,255-WMNMML2H    RESET 2ND LINE AVAILABLE         01480000
         TM    XVD3,XVD3TXT1           TEXT LINE 1 BEING USED ?         01481000
         BZ    IEA2TX2A                NO, BRANCH                       01482000
*                                                                       01483000
*        PROCESS TEXT LINE 1                                            01484000
*                                                                       01485000
         L     R15,WKAADTXT            R15 -> MCS HEADER + TEXT         01486000
         LA    R15,4(,R15)             R15 -> TEXT                      01487000
         LH    R3,WKALGH               R3 = L'TEXT +4                   01488000
         L     R2,ADDRMLHR             R2 -> MLWTO EXTENSION HEADER     01489000
         B     IEA2MVL2                                                 01490000
*                                                                       01491000
*        PROCESS SECOND AND SUBSEQUENT LINES                            01492000
*                                                                       01493000
         USING WPLML,R4                                                 01494000
IEA2TX2A LA    R15,WPLMLTXT            R15 -> TEXT                      01495000
         LH    R3,WPLML0               R3 = L'MESSAGE                   01496000
         LA    R2,WPLMLLTF             POINT TO LINE TYPE               01497000
         DROP  R4                                                       01498000
IEA2MVL2 MVC   WMNMLT2(1),0(R2)        MOVE LINE TYPE TO 2ND LINE       01499000
         TM    XVX0,XVX0FLJE           FIRST LINE JUST END              01500000
         BO    IEA1DECR                YES, POST WTO ECB                01501000
         TM    WMNMLT2,WMNMLT2D        END LINE ?                       01502000
         BZ    IEA2TXTL                NO, BRANCH                       01503000
         TM    WMNMLT2,WMNMLT2C        YES, DATA AND END LINE ?         01504000
         BZ    IEA1DECR                NO, JUST END LINE, POST ECB      01505000
*                                                                       01506000
*        MIN2MOV                                                        01507000
*                                                                       01508000
*        MOVE IN LINE 2 OF THE MINOR                                    01509000
*        CHECK WHETHER TO ALLOW 70 OR 71 CHARACTERS OF TEXT             01510000
*                                                                       01511000
IEA2TXTL LA    R1,70                   R1 = MAX NON-AUTHORIZED L'TEXT   01512000
         TM    XVD1,XVD1AUTH           USER AUTHORIZED ?                01513000
         BZ    IEA2GLEN                NO, BRANCH                       01514000
         LA    R1,71                   YES, ALLOW MAX 71 CHARS          01515000
IEA2GLEN SH    R3,KH4                  ADJUST FOR FLAGS                 01516000
         CR    R3,R1                   L'TEXT > MAXIMUM ALLOWED ?       01517000
         BNH   IEA2BTXT                NO, BRANCH                       01518000
         LR    R3,R1                   YES, TRUNCATE L'TEXT             01519000
IEA2BTXT MVI   WMNMTXT2,C' '           BLANK FIRST CHAR                 01520000
         TM    XVD1,XVD1AUTH           CALLER APF AUTHORIZED ?          01521000
         BZ    IEA2OVE4                NO, BRANCH                       01522000
         LA    R14,WMNMTXT2+1          R14 -> MINOR TEXT AREA           01523000
         LR    R5,R3                   LENGTH FOR EXECUTE               01524000
         BCTR  R5,0                    ADJUST FOR EXECUTE               01525000
         EX    R5,IEAMVTXT             MOVE TEXT TO MINOR               01526000
*                                      MVC   0(0,R14),0(R15)            01527000
         LA    R3,1(,R3)               INC MINOR LENGTH BY 1            01528000
         B     IEA2STL2                                                 01529000
*                                                                       01530000
IEA2OVE4 MVI   WMNMTXT2+1,C' '         BLANK SECOND CHAR                01531000
         LA    R14,WMNMTXT2+2          R14 -> MINOR TEXT AREA           01532000
         LR    R5,R3                   LENGTH FOR EXECUTE               01533000
         BCTR  R5,0                    ADJUST FOR EXECUTE               01534000
         EX    R5,IEAMVTXT             MVC   0(0,R14),0(R15)            01535000
*                                                                       01536000
         LA    R3,2(,R3)               UPDATE LENGTH                    01537000
IEA2STL2 STC   R3,WMNMTL2              STORE MINOR LENGTH               01538000
         LA    R14,WMNMTXT2            R14 -> TEXT AREA 2               01539000
         MVC   WMNMHCT2,WMNMHCT1       MOVE IN HARD COPY ID             01540000
*                                                                       01541000
*        TRUNCATE ANY TRAILING BLANKS                                   01542000
*                                                                       01543000
IEA2LOOP BCT   R3,IEA2LOOA             DECR INDEX INTO TEXT             01544000
         B     IEA2DONE                BRANCH, LOOP COMPLETED           01545000
IEA2LOOA LA    R15,0(R3,R14)           R15 -> NEXT CHAR                 01546000
         CLI   0(R15),C' '             BLANK ?                          01547000
         BE    IEA2LOOP                RE-ENTER LOOP                    01548000
*                                                                       01549000
IEA2DONE LA    R3,1(,R3)               R3 NOW HAS CORRECT LENGTH        01550000
         STC   R3,WMNMTL2                                               01551000
         BAL   R14,TEXTLINE            UPDATE TEXT POINTER              01552000
IEA1DECR BAL   R14,ENDUP                                                01553000
*                                                                       01554000
IEAMSTTS TM    XVX1,XVX1STOP           ERROR FOUND ?                    01555000
         BO    IEAMFREL                YES, DON'T TAKE EXIT OR POST     01556000
         TM    XVD2,XVD2DELW           MESSAGE TO BE DELETED ?          01557000
         BZ    IEAMNOST                NO, TAKE SUBSYSTEM EXIT          01558000
         DROP  R7                      RELEASE MINOR BASE               01559000
         USING WMJMEXT,R8              ADDRESSABILITY FOR MAJOR         01560000
*                                                                       01561000
*        SET UP THE FLAGS SO THAT THIS MLWTO IS DELETED AND SENT        01562000
*        TO HARDCOPY                                                    01563000
*                                                                       01564000
         OI    WMJMECBF,WMJMMAJD       INDICATE MAJOR IS DELETED        01565000
         L     R1,ADDRUCM              R1 -> UCM                        01566000
         SH    R1,KH4                  ADDR UCM PREFIX                  01567000
         L     R1,0(,R1)               R1 -> UCM PREFIX                 01568000
         USING UCMPRFX,R1              ADDRESSABILITY FOR PREFIX        01569000
         OI    UCMSFLG2,UCMSYSI        INDICATE CLEANUP NEEDED          01570000
         OI    WMJMBUF,WMJMBUFC+WMJMBUFE  INDICATE WQE SERVICED         01571000
*                                         AND READY FOR HARDCOPY        01572000
         OI    WMJMDSP,WMJMDSPB        INDICATE QUEUE TO H.C.           01573000
         DROP  R1                                                       01574000
*                                                                       01575000
*        SUBSYSTEM EXIT SEGMENT                                         01576000
*                                                                       01577000
*        THIS SEGMENT WILL PASS THE MAJOR AND MINOR LINES TO THE        01578000
*        SUBSYSTEM EXIT. THE SUBSYSTEM MAY CHANGE THE MSG AND/OR        01579000
*        ASK THAT THE MESSAGE BE DELETED                                01580000
*                                                                       01581000
*        INPUT -                                                        01582000
*        R8 -> MAJOR WQE                                                01583000
*        XVCMINOR -> THE MINOR WQE                                      01584000
*        XVC3BLD1 AND BLD2 WILL BOTH BE ON IF THE MAJOR WQE WAS         01585000
*        JUST BUILT                                                     01586000
*                                                                       01587000
*        OUTPUT -                                                       01588000
*        IF THE SUBSYSTEM ASKS TO DELETE THE MAJOR WQE THEN             01589000
*        XVD2DELW WILL BE TURNED ON AND WMJMMAJD WILL BE SET ON         01590000
*        IN THE MAJOR WQE                                               01591000
*                                                                       01592000
*        THE MINOR MAY ALSO BE ASKED TO BE DELETED, BUT THE             01593000
*        REQUEST WILL ONLY BE HONORED IF WMJMMAJD IS ON                 01594000
*                                                                       01595000
*        FREE THE LOCKS                                                 01596000
*                                                                       01597000
IEAMNOST BAL   R15,FRELCKS             CALL FRELCKS ROUTINE             01598000
*                                                                       01599000
*        SET UP RETRY ADDRESS IN CASE SUBSYSTEM EXIT HAS PROBLEMS       01600000
*                                                                       01601000
         L     R1,PARMPTR              R1 -> PARM LIST                  01602000
         USING PARMLIST,R1                                              01603000
         LA    R2,IEAHSSRT             R2 -> RETRY ADDR                 01604000
         ST    R2,PARMRTAD             SWITCH ADDR IN ESTAE PARMLIST    01605000
         MVI   PARMFTPT,FTSSOB         SET FOOTPRINT                    01606000
         LA    R2,SUBSLIST             BUILD BLOCKS IN OUR STORAGE      01607000
         STM   R0,R15,RECREGS          SAVE THE REGS AT THIS POINT      01608000
         DROP  R1                                                       01609000
*                                                                       01610000
*        SET UP SSOB AND SSWT                                           01611000
*                                                                       01612000
         ST    R2,SUBSPARM             BUILD PARM LIST PTR              01613000
         USING SSOB,R2                                                  01614000
         MVC   SSOBID,KCSSOB           IDENTIFY BLOCK AS AN SSOB        01615000
         LA    R1,SSOBHSIZ             LENGTH OF SSOB                   01616000
         STH   R1,SSOBLEN              STORE INTO SSOB LENGTH FIELD     01617000
         LA    R1,SSOBWTO              IDENTIFY THAT THIS CALL IS       01618000
         STH   R1,SSOBFUNC             FOR A WTO                        01619000
         SR    R5,R5                   CLEAR REG FOR ZEROING FIELDS     01620000
         ST    R5,SSOBSSIB             NO SSIB FOR THIS CALL            01621000
         ST    R5,SSOBRETN             INSURE RETN IS INITIALLY ZERO    01622000
         LA    R1,SSWTBGN              POINT SSOB AT SSWT               01623000
         ST    R1,SSOBINDV                                              01624000
         LA    R1,SSWTSIZE             PUT IN SIZE OF SSWT              01625000
         STH   R1,SSWTLEN                                               01626000
         ST    R8,SSWTWQE              PUT IN ADDR OF MAJOR             01627000
         ST    R5,SSWTORE              NO ORE THIS TRIP                 01628000
         TM    XVD3,XVD3BLD1+XVD3BLD2  MAJOR WQE ?                      01629000
         BNO   IEAHMINS                NO, BRANCH                       01630000
         ST    R5,SSWTMIN              NO MINOR YET                     01631000
         B     IEAHSSGO                                                 01632000
*                                                                       01633000
*        RETRY ROUTINE IF SUBSYSTEM EXIT ERROR REACHED ESTAE            01634000
*                                                                       01635000
IEAHSSRT XC    SSOBRETN,SSOBRETN       ZERO RETURN CODE FROM SUBSYSTEM  01636000
         L     R1,PARMPTR                                               01637000
         USING PARMLIST,R1                                              01638000
         XC    PARMRTAD,PARMRTAD       ZERO RETRY ADDR                  01639000
         DROP  R1                                                       01640000
         B     IEAHLOCK                                                 01641000
*                                                                       01642000
IEAHMINS MVC   SSWTMIN,XVCMINOR        MOVE IN ADDR OF MINOR            01643000
IEAHSSGO LA    R1,SUBSPARM             R1 -> PARM LIST POINTER          01644000
*                                                                       01645000
         IEFSSREQ  ,                   CALL THE SUBSYSTEM               01646000
         LR    R5,R15                  SAVE RETURN CODE FROM EXIT       01647000
*                                                                       01648000
*        SET THE LOCKS AGAIN                                            01649000
*                                                                       01650000
IEAHLOCK BAL   R15,SETLCKS                                              01651000
*                                                                       01652000
*        CHECK TO SEE IF THE SUBSYSTEM HAS SPECIFIED HARDCOPY BYPASS    01653000
*                                                                       01654000
         TM    WMJMCS2,WMJMCS2F        HARDCOPY BYPASS SET ?            01655000
         BZ    IEAHHCRD                NO, BRANCH                       01656000
         NI    WMJMDSP,255-WMJMDSPB    YES, INDICATE DO NOT HC          01657000
*                                                                       01658000
*        CHECK TO SEE IF THIS WQE IS FOR A MINOR                        01659000
*                                                                       01660000
IEAHHCRD TM    XVD3,XVD3BLD1+XVD3BLD2  BUILDING MAJOR ?                 01661000
         BNO   IEAHSUSP                NO, GO TURN OFF SUSPEND FLAG     01662000
*                                                                       01663000
*        CHECK IF SYBSYSTEM WANTS MESSAGE DELETED                       01664000
*        IF THE EXIT WAS SUCCESSFUL THEN R15 WAS ZERO ON RETURN         01665000
*        FROM THE SUBSYSTEM                                             01666000
*        CHECK R1 WHICH HAS RETURN INDICATION                           01667000
*                                                                       01668000
         LTR   R5,R5                   (R15) EXIT SUCCESSFUL ?          01669000
         BNZ   IEAHSUSP                NO, CHECK IF USER WANTS MSG OUT  01670000
*                                                                       01671000
*        CHECK FOR DELETION REQUEST                                     01672000
*                                                                       01673000
         LA    R5,SSWTNDSP             R5 = DON'T DISPLAY MESSAGE RC    01674000
         CL    R5,SSOBRETN             SUBSYSTEM REQ DON'T DISPLAY ?    01675000
         BNZ   IEAHSUSP                NO, CHECK USER                   01676000
         DROP  R2                                                       01677000
         USING WMJMEXT,R8              SET ADDRESSING TO MAJOR          01678000
*                                                                       01679000
*        SET UP THE FLAGS SO THAT THIS MLWTO IS DELETED AND SENT        01680000
*        TO HARDCOPY                                                    01681000
*                                                                       01682000
         OI    WMJMECBF,WMJMMAJD       MAJOR IS DELETED                 01683000
*                                                                       01684000
*        SET UP ADDRESSABILITY FOR UCMPREFIX                            01685000
*                                                                       01686000
         L     R1,ADDRUCM              R1 -> UCM                        01687000
         SH    R1,KH4                  ADDR UCM PREFIX                  01688000
         L     R1,0(,R1)               R1 -> UCM PREFIX                 01689000
         USING UCMPRFX,R1              SET ADDRESSABILITY               01690000
         OI    UCMSFLG2,UCMSYSI        SET WQE HOUSEKEEEPING REQUIRED   01691000
         OI    WMJMBUF,WMJMBUFE        MARK WQE AS SERVICED             01692000
*                                                                       01693000
*        CHECK TO SEE IF THE SUBSYSTEM HAS SPECIFIED HARDCOPY           01694000
*        BYPASS                                                         01695000
*                                                                       01696000
         TM    WMJMCS2,WMJMCS2F        BYPASS HARDCOPY QUEUEING ?       01697000
         BZ    IEA00C2A                NO, BRANCH                       01698000
         B     IEAHSUSP                TURN OFF SUSPEND MODE            01699000
*                                                                       01700000
IEA00C2A OI    WMJMBUF,WMJMBUFC        INDICATE READY FOR HC            01701000
         OI    WMJMDSP,WMJMDSPB        INDICATE SEND TO HC              01702000
         DROP  R1                                                       01703000
*                                                                       01704000
*        TRANSLATE UNPRINTABLE AND NON DISPLAY CHARACTERS IN THE WQE    01705000
*                                                                       01706000
IEAHSUSP TM    XVD3,XVD3BLD1+XVD3BLD2  A MAJOR WQE ?                    01707000
         BNO   IEAHTRMI                NO, GO DO MINOR                  01708000
         SR    R1,R1                   HANDLE MAJOR TEXT                01709000
         LH    R1,WMJMTXTL             LENGTH OF MAJOR TEXT             01710000
         BCTR  R1,0                    DECR FOR EX                      01711000
         LA    R15,WMJMTXT             R15 -> TEXT                      01712000
         L     R14,VTRTAB              R14 -> TRTAB IN IEEVVWTO         01713000
         EX    R1,TRINST               TRANSLATE UNPRINTABLES TO TILDE  01714000
*                                      TR    0(0,R15),0(R14)            01715000
         B     IEAHTRND                DONE WITH MAJOR WAIT FOR MINOR   01716000
*                                                                       01717000
IEAHTRMI SR    R1,R1                   DO MINOR WQE                     01718000
         DROP  R8                                                       01719000
         USING WMNMEXT,R7                                               01720000
         ICM   R1,B'0001',WMNMTL1      L'1ST MINOR TEXT                 01721000
         BZ    IEA00C64                LENGTH ZERO, BRANCH              01722000
         BCTR  R1,0                    DECR FOR EX                      01723000
         LA    R15,WMNMTXT1            R15 -> TEXT                      01724000
         L     R14,VTRTAB              R14 -> TRTAB IN IEEVVWTO         01725000
         EX    R1,TRINST               TRANSLATE UNPRINTABLES TO TILDE  01726000
*                                      TR    0(0,R15),0(R14)            01727000
IEA00C64 TM    WMNMML2,WMNMML2H        LINE 2 AVAILABLE ?               01728000
         BO    IEAHTRND                YES, BRANCH AS NOT USED          01729000
         ICM   R1,B'0001',WMNMTL2      R1 = L'TEXT                      01730000
         BZ    IEAHTRND                LENGTH ZERO, BRANCH              01731000
         BCTR  R1,0                    DECR FOR EX                      01732000
         LA    R15,WMNMTXT2            R15 -> TEXT                      01733000
         L     R14,VTRTAB              R14 -> TRTAB IN IEEVVWTO         01734000
         EX    R1,TRINST               TRANSLATE UNPRINTABLES TO TILDE  01735000
*                                      TR    0(0,R15),0(R14)            01736000
         DROP  R7                                                       01737000
         USING WMJMEXT,R8                                               01738000
IEAHTRND NI    WMJMDSP,255-WMJMDSPG    TURN OFF SUSPEND BIT             01739000
         DROP  R8                                                       01740000
*                                                                       01741000
*        FREE THE LOCKS                                                 01742000
*                                                                       01743000
         BAL   R15,FRELCKS                                              01744000
         CLI   NUMLINES,10             PROCESSED 10 LINES ?             01745000
         BNL   IEA00CAA                YES, BRANCH                      01746000
         CLI   XVX2,0                  MORE LINES TO PROCESS ?          01747000
         BNH   IEA00CAA                NO, BRANCH                       01748000
         SR    R1,R1                   INCREMENT LINE COUNTER           01749000
         IC    R1,NUMLINES                                              01750000
         LA    R1,1(,R1)                                                01751000
         STC   R1,NUMLINES                                              01752000
         B     IEAMMORE                BRANCH TO PROCESS NEXT LINE      01753000
*                                                                       01754000
*        THE LOCKS WILL BE FREE'D BY THE SUBSYSTEM EXIT SEGMENT         01755000
*        THIS SEGMENT POSTS THE UCMOECB USING A CROSS MEMORY POST       01756000
*                                                                       01757000
IEA00CAA STM   R14,R12,SAVEREGS+12     SAVE REGS AROUND XMPOST          01758000
         LR    R9,R13                  SAVE SAVEAREA ADDRESS IN R9      01759000
*                                      R9 AND R14 ARE THE ONLY          01760000
*                                      REGS PRESERVED BY XMPOST         01761000
         L     R3,ADDRUCM              R3 -> UCM                        01762000
         USING UCM,R3                                                   01763000
*                                      SETUP R1 AS BIT MASK SO          01764000
         L     R1,KX800000             THAT NO REFERENCES TO            01765000
*                                      STORAGE NEED BE MADE AFTER       01766000
*                                      BASE REG IS UPDATED              01767000
         L     R12,UCMWAKUP            R12 -> ROUTINE TO GET            01768000
*                                      CONTROL IF XMPOST FAILS          01769000
         OR    R12,R1                  INDICATE ERRET IS TO RUN         01770000
*                                      MASTER SCHEDULER MEMORY          01771000
         L     R13,UCMASCB             ASCB OF MEMORY CONTAINING        01772000
*                                      ECB TO POST                      01773000
         SLR   R10,R10                 R10 CONTAINS COMPLETION          01774000
*                                      CODE TO POST WITH                01775000
         LA    R11,UCMOECB             R11 -> ECB TO BE POSTED          01776000
         OR    R11,R1                  SET END OF LIST BIT ON           01777000
         L     R15,CVTPTR                                               01778000
         USING CVT,R15                                                  01779000
         L     R15,CVT0PT01            R15 -> XMPOST BRANCH ENTRY       01780000
         DROP  R15                                                      01781000
         BALR  R14,R15                 CALL XMPOST                      01782000
*                                                                       01783000
         LA    R15,8                   DISPATCHER CALL                  01784000
         SVC   116                     ESR SVC TYPE 1                   01785000
*                                                                       01786000
         LR    R13,R9                  RESTORE SAVEAREA ADDRESS         01787000
         LM    R14,R12,SAVEREGS+12     RESTORE REGS AFTER XMPOST        01788000
         MVI   NUMLINES,1              SET NUMLINES TO 1                01789000
         DROP  R3                                                       01790000
IEAMMORE TM    XVX1,XVX1STOP           NEED TO STOP ?                   01791000
         BO    IEAMSTOP                                                 01792000
         CLI   XVX2,0                  MORE LINES TO DO ?               01793000
         BH    IEASEXIT                YES, GO PROCESS                  01794000
         B     IEAMSTOP                GO CHECK IF WE SHOULD STOP       01795000
*                                                                       01796000
*        THIS CODE WILL GET CONTROL ONLY IF AN ERROR WAS                01797000
*        ENCOUNTERED WHILE RUNNING UNDER ESTAE                          01798000
*                                                                       01799000
*        IF THERE IS AN ERROR THEN WE ASSUME THAT THE WPL               01800000
*        CAUSED THE ERROR. THE USER WILL BE ABENDED WITH A D23          01801000
*        ABEND CODE.                                                    01802000
*                                                                       01803000
IEAVRETY OI    XVD1,XVD1PERR           SET ERROR BIT TO ABEND THE USER  01804000
         MVI   XVAMOD,MWTOID           IEAVMWTO'S ID FOR D23            01805000
         MVI   XVFNCT,D23VALID         PARMLIST VALIDITY CHECK          01806000
         MVI   XVREASON,D23PARM        PARMLIST NOT ADDRESSABLE BY USER 01807000
*                                                                       01808000
*        ERROR PROCESSING EXIT                                          01809000
*                                                                       01810000
IEASTOPA OI    XVX1,XVX1STOP           STOP PROCESSING                  01811000
         B     IEAMSTOP                                                 01812000
*                                                                       01813000
*        FREE THE LOCAL AND CMS LOCKS                                   01814000
*                                                                       01815000
IEAMFREL BAL   R15,FRELCKS             CALL THE FREE LOCK SUBROUTINE    01816000
*                                                                       01817000
*        FREE THE ESTAE RECOVERY                                        01818000
*                                                                       01819000
IEAMSTOP ESTAE 0                       FREE IEAVMWTO STAE               01820000
*                                                                       01821000
*        FREE THE WORKAREA FOR THIS MODULE                              01822000
*                                                                       01823000
         LR    R1,R13                  MOVE ADDR OF WORKAREA TO R1      01824000
         L     R0,WKFREECN             GET SUBPOOL AND SIZE PARM        01825000
         L     R13,4(,R13)             RESTORE PTR TO CALLER'S AREA     01826000
*                                                                       01827000
         FREEMAIN R,LV=(0),A=(1)       FREE WORKAREA FOR THIS MODULE    01828000
*                                                                       01829000
IEAMGRET ICM   R1,B'1111',XVCMAJOR     THERE A MAJOR WQE ?              01830000
         BZ    IEAMRETN                NO, BRANCH                       01831000
         L     R1,XVWQEID              YES, GET MSG ID NUM NO           01832000
*                                      FROM RB SAVE AREA                01833000
         SRL   R1,8                    SHIFT OUT CONSOLE ID             01834000
*                                                                       01835000
*        PUT MSG ID OR ZERO INTO XWQEID FIELD IN XVSAV                  01836000
*        THIS FIELD WILL BE RETURNED TO THE USER BY IEAVVWTO            01837000
*                                                                       01838000
IEAMRETN ST    R1,XVWQEID              PUT MSG ID BACK INTO XVSAV       01839000
*                                                                       01840000
         RETURN (14,12)                RETURN TO VWTO                   01841000
*                                                                       01842000
*        MLWTO CLEANUP ROUTINE                                          01843000
*                                                                       01844000
*        THIS ROUTINE GETS CONTROL IF THERE IS AN ERROR UNDER           01845000
*        THE FRR PROTECTION. IF SO, THEN WE WERE BUILDING A MAJOR       01846000
*        OR MINOR WQE AND NO ERROR WAS EXPECTED. THIS ROUTINE           01847000
*        WILL INSURE THAT THE SUSPENDED BIT IS TURNED OFF IN THE        01848000
*        MAJOR WQE AND WILL LET THE ERROR CONTINUE                      01849000
*                                                                       01850000
*        INPUT -                                                        01851000
*        R2  -> FRR PARM LIST                                           01852000
*        R13 -> CALLERS REG SAVE AREA                                   01853000
*        R14-R15 ARE THE RETURN AND ENTRY REGS                          01854000
*        PARMRGAD IN THE PARM AREA IS THE ADDR OF OUR REG               01855000
*        RESTORE AREA                                                   01856000
*        REGS 3,4,6,7,10,11,12,13 ARE VALID IN THE RESTORE AREA         01857000
*                                                                       01858000
MWTOCLNP SAVE  (14,12),,'IEAVMWTO CLEANUP'                              01859000
         USING PARMLIST,R2                                              01860000
         LR    R0,R13                  MOVE CALLERS SAVEAREA PTR        01861000
         L     R1,PARMRGAD                                              01862000
         LM    R3,R13,14(R1)           RELOAD R3 TO R13 FROM REG SAVE   01863000
         ICM   R1,B'1111',XVCMAJOR     R1 -> MAJOR WQE                  01864000
         BZ    IEAVCLOT                NO MAJOR WQE, RETURN             01865000
*                                                                       01866000
*        THERE IS A MAJOR WQE, IT SHOULD BE ON THE WQE QUEUE            01867000
*                                                                       01868000
*        INSURE THAT IT ISNT IN THE SUSPENDED STATE                     01869000
*                                                                       01870000
         USING WMJM,R1                                                  01871000
         NI    WMJMDSP,255-WMJMDSPG    TURN OFF SUSPEND FLAG            01872000
*                                                                       01873000
*        THE MAJOR WILL BE CLEANED UP BY IEAVMED2 AS LONG AS THE        01874000
*        SUSPEND FLAG IS OFF                                            01875000
*                                                                       01876000
IEAVCLOT LR    R13,R0                  RESTORE CALLERS SAVE AREA PTR    01877000
*                                                                       01878000
         RETURN (14,12)                RETURN TO CALLER                 01879000
*                                                                       01880000
         DROP  R1,R2                                                    01881000
*                                                                       01882000
*        CONSTANTS FOR IEAVMWTO                                         01883000
*                                                                       01884000
IEAMEXMV MVC   0(0,R14),0(R15)         MOVE TEXT TO MAJOR               01885000
IEAMSHFT MVC   0(0,R14),0(R15)         SHIFT TEXT 1 CHAR TO LEFT        01886000
IEAMVTXT MVC   0(0,R14),0(R15)         MOVE TEXT TO MINOR               01887000
TRINST   TR    0(0,R15),0(R14)         TRANSLATE UNPRINTABLES           01888000
*                                      USING TRTAB IN IEEVVWTO          01889000
*                                                                       01890000
KIEE932I DC    C'IEE932I'              DEFAULT CONTROL LINE TEXT        01891000
*                                                                       01892000
VTRTAB   DC    V(TRTAB)                -> TRTAB IN IEEVVWTO             01893000
WKSIZE   DC    A(WRKSIZE)              SIZE OF MWTO'S SAVE AND WORKAREA 01894000
WKSUBPL  DC    AL4(229)                STORAGE FROM SUBPOOL 229         01895000
WKFREECN DC    AL1(229),AL3(WRKSIZE)   FREEMAIN PARAMETER               01896000
WQEPLSZ  DC    F'4096'                 SIZE OF WQE CELL EXTENSION       01897000
SPLFRECN DC    AL1(231),XL3'1000'      FREE WQE EXTENSION PARM          01898000
WKGETWWB DC    AL1(231),AL3(WWBSIZE)   WWB GETMAIN/FREEMAIN PARM        01899000
*                                                                       01900000
KH1      DC    H'1'                                                     01901000
KH2      DC    H'2'                                                     01902000
KH3      DC    H'3'                                                     01903000
KH4      DC    H'4'                                                     01904000
KH20     DC    H'20'                   USED TO CHECK FOR EXTENSION      01905000
*                                      OF WQE CELL POOL                 01906000
         DC    0F'0'                                                    01907000
KX800000 DC    X'80000000'             END OF LIST INDICATOR            01908000
WTPONLY  DC    AL2(WPLROUTK)           CHECK FOR ONLY WTP ROUTE CODE    01909000
KCSSOB   DC    C'SSOB'                 SUBSYSTEM IDENTIFIER             01910000
MODULEID DC    C'MWTO'                 FRR/ESTAE MODULE ID              01911000
KC0000   DC    C'0000'                 CHAR ZEROS FOR ROUTE CODE INIT   01912000
KCZ      EQU   C'Z'                    INLINE AREA DESIGNATOR           01913000
PPWTOFLG EQU   C'+'                    PROB PGM - NO ACTION MSG         01914000
PPACTFLG EQU   C'@'                    PROB PGM - ACTION MSG FLAG       01915000
SUPACFLG EQU   C'*'                    SUPERVISOR - ACTION MSG          01916000
*                                                                       01917000
*        RETURN CODE EQUATES                                            01918000
*                                                                       01919000
LINERR   EQU   X'04'                   ERROR FOUND IN NUMBER OF LINES   01920000
NOIDMCH  EQU   X'08'                   NO MATCH FOR MSG ID IN R0        01921000
INVLDLT  EQU   X'0C'                   LINE TYPE WAS INVALID            01922000
RCWTP    EQU   X'10'                   WTP ROUTE CODE WAS USED          01923000
HCONLY   EQU   X'14'                   MLWTO WAS FOR HARDCOPY ONLY      01924000
*                                                                       01925000
HEXCHAR  DC    C'0123456789ABCDEF'     TABLE TO CONVERT ROUT CODES      01926000
PATTIME  DC    XL9'4021214B21214B2121'  ED PATTERN FOR TIME             01927000
PATUCMID DC    XL4'40212121'           ED PATTERN FOR UCM MSG NUMBER    01928000
*                                                                       01929000
ALLREGS  DC    X'FFFF'                 RESTORE ALL REGS MAP             01930000
*                                                                       01931000
         DC    0F'0'                                                    01932000
*                                                                       01933000
ELIST    ESTAE ,MF=L                   CREATE ESTAE PARM LIST           01934000
ELISTL   EQU   *-ELIST                 FOR LENTH CALULATION             01935000
*                                                                       01936000
FTLOCK   EQU   X'04'                   LOCK FOOT PRINT                  01937000
FTSSOB   EQU   X'03'                   SUSBYSTEM EXIT FOOT PRINT        01938000
*                                                                       01939000
*        GETMINOR                                                       01940000
*                                                                       01941000
*        INPUT -                                                        01942000
*        XVCMAJOR -> MAJOR WQE                                          01943000
*        XVCMINOR -> LAST MINOR ON THE CHAIN IF WE                      01944000
*                    ARE CREATING THE NEXT MINOR                        01945000
*        THIS ROUTINE ASSUMES THAT A WQE IS AVAILABLE UNDER THE         01946000
*        UCMWQLM COUNT                                                  01947000
*                                                                       01948000
*        OUTPUT -                                                       01949000
*        A NEW MINOR IS QUEUED OFF THE MAJOR WQE                        01950000
*        THE MINOR IS ZEROED                                            01951000
*                                                                       01952000
GETMINOR ST    R14,WORK8               SAVE THE CALLER'S ADDR           01953000
         USING WMJM,R8                                                  01954000
         BAL   R14,GETWQE              GET A MINOR WQE                  01955000
*                                                                       01956000
*        CHECK IF A MINOR WAS OBTAINED                                  01957000
*                                                                       01958000
         LTR   R1,R1                   WAS A WQE OBTAINED               01959000
         BNZ   IEANGET1                YES, ADD IT TO THE CHAIN         01960000
*                                                                       01961000
*        NO A WQE WASN'T OBTAINED. SET ERROR FLAGS                      01962000
*                                                                       01963000
         OI    XVX1,XVX1STOP           STOP PROCCESSING                 01964000
         OI    XVD1,XVD1PERR           SET ERROR FLAGS                  01965000
         B     IEANGET2                                                 01966000
*                                                                       01967000
IEANGET1 L     R8,XVCMAJOR             R8 -> MAJOR WQE                  01968000
         ICM   R7,B'1111',WMJMMIN      MINOR QUEUED TO MAJOR ?          01969000
         BNZ   IEAMINR2                YES, QUEUE TO LAST MINOR         01970000
         ST    R1,WMJMMIN              QUEUE NEW MINOR TO MAJOR         01971000
         OI    WMJMMLW,WMJMMLWH        SET DUMMY MINOR QUEUED           01972000
         B     IEAMBL12                SET MINOR FLAGS                  01973000
*                                                                       01974000
         DROP  R8                                                       01975000
         USING WMNMEXT,R7                                               01976000
IEAMINR2 L     R7,XVCMINOR             R7 -> LAST MINOR QUEUED          01977000
         O     R1,WMNMUC2              PRESERVE USE COUNT FOR 2ND LINE  01978000
         ST    R1,WMNMUC2              QUEUE MINOR                      01979000
IEAMBL12 LR    R7,R1                   R7 -> NEW MINOR                  01980000
         OI    XVD3,XVD3BLD1+XVD3BLD2     BUILD LINE 1 AND 2            01981000
         OI    WMNMML1,WMNMML1C+WMNMML1H  SET MINOR WQE AND GETMAINED   01982000
         DROP  R7                                                       01983000
         ST    R7,XVCMINOR             STORE ADDR OF CURRENT MINOR      01984000
IEANGET2 L     R14,WORK8               RESTORE RETURN ADDR              01985000
         BR    R14                     RETURN TO CALLER                 01986000
*                                                                       01987000
*        ENDUP                                                          01988000
*                                                                       01989000
ENDUP    L     R8,XVCMAJOR             R8 -> MAJOR WQE FOR FORCE END    01990000
         SR    R15,R15                 ZERO REG                         01991000
         IC    R15,XVX2                R15 = COUNT OF LINES REMAINING   01992000
         BCTR  R15,0                   DECREMENT                        01993000
         STC   R15,XVX2                UPDATE COUNT IN XVX2             01994000
         LTR   R15,R15                 ANY MORE LINES TO PROCESS ?      01995000
         BNZ   ENDUPRTN                YES, RETURN TO CALLER            01996000
         TM    XVX0,XVX0FEDE           FORCE END ?                      01997000
         BZ    ENDUPRTN                NO, RETURN TO CALLER             01998000
         USING WMJMEXT,R8                                               01999000
         TM    WMJMMLW,WMJMMLWH        DUMMY MINOR QUEUED ?             02000000
         BO    IEAEJEND                YES, FLAG MAJOR AS END           02001000
         ICM   R7,B'1111',XVCMINOR     R7 -> MINOR WQE                  02002000
*                                      THERE A MINOR WQE ?              02003000
         BZ    IEAEJEND                NO, FLAG MAJOR AS END            02004000
         DROP  R8                                                       02005000
         USING WMNMEXT,R7                                               02006000
IEAEP2ND ICM   R15,B'0111',WMNMNX1     NEXT LINE PTR = 0 ?              02007000
         BZ    IEAE1END                YES, FLAG LINE 1 AS END          02008000
         ICM   R15,B'0111',WMNMNX2     PTR TO NEXT MINOR WQE = 0 ?      02009000
         BZ    IEAE2END                YES, FLAG LINE 2 AS END          02010000
         L     R7,WMNMUC2              R7 -> NEXT MINOR WQE             02011000
         B     IEAEP2ND                FIND END OF CHARIN               02012000
*                                                                       02013000
IEAE1END CLI   WMNMTL1,0               MINOR CONTAIN TEXT ?             02014000
         BNE   IEAD1END                YES, THEN DATA END               02015000
         MVI   WMNMLT1,WMNMLT1D        NO, FLAG END LINE ONLY           02016000
         B     ENDUPRTN                RETURN TO CALLER                 02017000
*                                                                       02018000
IEAD1END MVI   WMNMLT1,WMNMLT1C+WMNMLT1D  SET DATA END FLAG             02019000
         B     ENDUPRTN                RETURN TO CALLER                 02020000
*                                                                       02021000
IEAE2END CLI   WMNMTL2,0               TEXT IN SECOND MINOR WQE ?       02022000
         BNE   IEAD2END                YES, THEN DATA END               02023000
         MVI   WMNMLT2,WMNMLT2D        NO, FLAG END LINE ONLY           02024000
         B     ENDUPRTN                RETURN TO CALLER                 02025000
*                                                                       02026000
IEAD2END MVI   WMNMLT2,WMNMLT2C+WMNMLT2D  SET DATA END FLAG             02027000
         B     ENDUPRTN                RETURN TO CALLER                 02028000
*                                                                       02029000
         DROP  R7                                                       02030000
         USING WMJMEXT,R8                                               02031000
IEAEJEND MVI   WMJMLTYP,WMJMLTYC+WMJMLTYD  FLAG MAJOR AS DATA END       02032000
ENDUPRTN BR    R14                     RETURN TO CALLER                 02033000
*                                                                       02034000
*        FINDID                                                         02035000
*                                                                       02036000
*        FIND AN EXISTING ID FOR A CONNECTING MLWTO                     02037000
*                                                                       02038000
*        PROTECT CONTENTS OF R4 AROUND CHECK FOR JOBSTEP AND MEMORY     02039000
*                                                                       02040000
FINDID   ST    R4,REG4SAV              SAVE IN R4 SAVEAREA              02041000
         L     R3,ADDRUCM              R3 -> UCM                        02042000
         USING UCM,R3                                                   02043000
         L     R1,UCMWTOQ              R1 -> FIRST WQE ON SYSTEM QUEUE  02044000
IEAISEAR LTR   R1,R1                   END OF QUEUE ?                   02045000
         BZ    IEAINOID                YES, NO ID FOUND                 02046000
         DROP  R8                                                       02047000
         DROP  R3                                                       02048000
         USING WMJMEXT,R1                                               02049000
         TM    WMJMMLW,WMJMMLWB        MAJOR WQE ?                      02050000
         BZ    IEAINXWQ                NO, GET NEXT WQE                 02051000
         CLC   XVWQEIDA,WMJMMSGN+1     YES, MSG IDS MATCH ?             02052000
         BNE   IEAINXWQ                NO, BRANCH                       02053000
         TM    WMJMLTYP,WMJMLTYD       END LINE ?                       02054000
         BO    IEAINOID                YES, ERROR                       02055000
*                                                                       02056000
*        CONFIRM THAT THE MSG WAS ISSUED BY A PROGRAM IN THE SAME       02057000
*        MEMORY AND JOB STEP AS THE CALLER                              02058000
*                                                                       02059000
         L     R4,TCBSAVE              R4 -> CALLER'S TCB               02060000
         L     R7,ASCBSAVE             R7 -> CALLER'S ASCB              02061000
         USING ASCB,R7                                                  02062000
         USING TCB,R4                                                   02063000
         CLC   WMJMASID,ASCBASID       ADDRESS SPACE ID MATCH ?         02064000
         BNE   IEAINOID                NO, THEN NO ID MATCH             02065000
         CLC   WMJMJTCB,TCBJSTCB       SAME JOB STEP ?                  02066000
         BNE   IEAINOID                NO, THEN NO ID MATCH             02067000
         DROP  R4,R7                                                    02068000
*                                                                       02069000
*        THE MESSAGE WAS ISSUED BY A USER IN THE SAME ADDRESS           02070000
*        SPACE AND JOB STEP                                             02071000
*                                                                       02072000
         ST    R1,XVCMAJOR             STORE MAJOR ADDR                 02073000
         L     R2,WMJMMIN              R2-> FIRST MINOR                 02074000
         ST    R2,XVCMINOR             STORE MINOR ADDR                 02075000
         TM    WMJMMLW,WMJMMLWH        MINOR HAVE TEXT ?                02076000
         BO    IEAIDUMM                NO, DUMMY                        02077000
         B     IEAITST1                CHECK IF MINOR LINE 2 AVAIL      02078000
*                                                                       02079000
IEAINXWQ LA    R1,0(,R1)               CLEAR HIORDER BYTE               02080000
         ICM   R1,B'0111',WMJMEXTA     R1 -> NEXT WQE                   02081000
         B     IEAISEAR                                                 02082000
*                                                                       02083000
         DROP  R1                                                       02084000
*                                                                       02085000
         USING WMNMEXT,R2                                               02086000
IEAITST1 TM    WMNMLT1,WMNMLT1D        FIRST LINE AN END ?              02087000
         BO    IEAINOID                YES, ERROR                       02088000
         TM    WMNMLT2,WMNMLT2D        SECOND LINE END ?                02089000
         BO    IEAINOID                YES, ERROR                       02090000
         LA    R2,0(,R2)               ENSURE HIORDER BYTE IS ZERO      02091000
         ICM   R2,B'0111',WMNMNX2      R2 -> NEXT MINOR WQE OR ZERO     02092000
*                                      THERE A MINOR ?                  02093000
         BNZ   IEAISADD                NO, CONTINUE SEARCH              02094000
         L     R2,XVCMINOR             R2 -> LAST MINOR WQE             02095000
         TM    WMNMML2,WMNMML2H        SECOND LINE AVAILABLE ?          02096000
         BZ    FINDIRET                NO, RETURN                       02097000
         OI    XVD3,XVD3BLD2           SET BUILD SECOND LINE FLAG       02098000
         B     FINDIRET                RETURN TO CALLER                 02099000
*                                                                       02100000
IEAISADD ST    R2,XVCMINOR             SAVE MINOR WQE ADDR              02101000
         B     IEAITST1                GO CHECK IF LINE 2 IS AVAILABLE  02102000
*                                                                       02103000
         DROP  R2                                                       02104000
         USING WMJMEXT,R1                                               02105000
IEAIDUMM OI    WMJMMLW,WMJMMLWF        SET CHAIN REUSABLE FLAG          02106000
         L     R2,XVCMINOR             R2 -> MINOR WQE                  02107000
         DROP  R1                                                       02108000
         USING WMNMEXT,R2                                               02109000
         XC    WMNM(WMNMSIZE),WMNM     ZERO MINOR                       02110000
         OI    WMNMML1,WMNMML1C+WMNMML1H   SET MINOR AND GETMAINED FLAG 02111000
         OI    WMNMML2,WMNMML2H            INDICATE LINE 2 AVAILABLE    02112000
         OI    XVD3,XVD3BLD1+XVD3BLD2      SET BUILD LINE 1 AND 2       02113000
         B     FINDIRET                RETURN TO CALLER                 02114000
*                                                                       02115000
         DROP  R2                                                       02116000
IEAINOID MVI   XVRETCOD,NOIDMCH        SET RETURN CODE                  02117000
         OI    XVX1,XVX1NOID           INDICATE NO ID FOUND             02118000
         XC    XVCMAJOR(8),XVCMAJOR    ZERO MAJOR AND MINOR PTRS        02119000
FINDIRET L     R4,REG4SAV              RESTORE R4                       02120000
         BR    R14                                                      02121000
*                                                                       02122000
*        GETWQE                                                         02123000
*                                                                       02124000
*        GET A WQE FROM THE WQE CELL POOL                               02125000
*        THE WQE WILL BE ZEROED                                         02126000
*        INPUT -                                                        02127000
*        UCMWQECP IS THE CELL POOL ID                                   02128000
*        UCMWQNR IS THE NUMBER OF WQES CURRENTLY IN USE                 02129000
*                                                                       02130000
*        OUTPUT -                                                       02131000
*        R1 -> THE ZEROED WQE IF ONE HAS BEEN OBTAINED                  02132000
*        R1 WILL BE ZERO IF A WQE WASN'T AVAILABLE                      02133000
*                                                                       02134000
*        PROCESS -                                                      02135000
*        REGS 14,15,0,1,2 ARE SAVED AND USED IN THIS ROUTINE IF A       02136000
*        CELL IS NOT AVAILABLE, THE ROUTINE CHECKS IF EXTENSION         02137000
*        IS NEEDED. IF ONE IS NEEDED IT IS OBTAIND AND WE ATTEMPT       02138000
*        TO GET A CELL AGAIN.                                           02139000
*                                                                       02140000
GETWQE   STM   R14,R2,GETSAVE                                           02141000
         L     R3,ADDRUCM              R3 -> UCM                        02142000
         USING UCM,R3                                                   02143000
         LA    R2,KH1                  SET NOT DONE INDICATOR IN R2     02144000
IEAGLOOP LTR   R2,R2                   TEST END OF GET LOOP             02145000
         BZ    IEAGRETN                YES, RETURN TO USER              02146000
*                                                                       02147000
*        NOT DONE                                                       02148000
*        GET A WQE FROM THE CELLPOOL                                    02149000
*                                                                       02150000
         L     R0,UCMWQECP             GET CELLPOOL ID FOR WQES         02151000
*                                                                       02152000
         GETCELL CPID=(0),BRANCH=YES   GET A WQE CELL                   02153000
*                                                                       02154000
*        CHECK IF CELL WAS OBTAINED                                     02155000
*        RETURN CODE IS IN R15                                          02156000
*                                                                       02157000
         LTR   R15,R15                 GET A CELL ?                     02158000
         BNZ   IEAGECHK                NO, CHECK TYPE OF RETURN CODE    02159000
*                                                                       02160000
*        YES, GOT A WQE                                                 02161000
*                                                                       02162000
         XC    0(WMJMSIZE,R1),0(R1)    ZERO OUT THE WQE                 02163000
         LH    R2,UCMWQNR              INCREMENT NO OF WQES             02164000
         LA    R2,1(,R2)                                                02165000
         STH   R2,UCMWQNR                                               02166000
         SR    R2,R2                   INDICATE ALL DONE                02167000
         B     IEAGLOOP                                                 02168000
*                                                                       02169000
*        CHECK IF CPOOL SHOULD BE EXTENDED                              02170000
*                                                                       02171000
IEAGECHK CH    R15,KH4                 EXTENSION NEEDED ?               02172000
         BE    IEA01220                YES, BRANCH                      02173000
         MVI   XVAMOD,MWTOID           IEAVMWTO'S ID FOR D23            02174000
         MVI   XVFNCT,D23WQEGC         WQE GETCELL FAILURE              02175000
         STC   R15,XVREASON                                             02176000
         B     IEAGNOWQ                                                 02177000
*                                                                       02178000
*        YES, EXTENDED THE WQE CELL POOL                                02179000
*        PROTECT THE CONTENTS OF R4 AROUND THE GETMAIN                  02180000
*                                                                       02181000
IEA01220 ST    R4,REG4SAV              STORE IN OUR SAVEAREA            02182000
         LA    R1,231                  USE SUBPOOL 231                  02183000
         L     R0,WQEPLSZ              GET SIZE OF EXTENSION            02184000
         L     R4,TCBSAVE              GET PTRS TO TCB AND ASCB         02185000
         L     R7,ASCBSAVE                                              02186000
*                                                                       02187000
         GETMAIN RC,LV=(0),SP=(1),BRANCH=YES                            02188000
*                                                                       02189000
         L     R4,REG4SAV              RESTORE THE CURRENT LINE PTR     02190000
*                                                                       02191000
*        CHECK IF GETMAIN WAS SUCCESSFUL                                02192000
*                                                                       02193000
         LTR   R15,R15                 EXTENSION SUCCESSFUL ?           02194000
         BZ    IEA01272                YES, BRANCH                      02195000
         MVI   XVAMOD,MWTOID           NO, IEAVMWTO'S ID FOR D23        02196000
         MVI   XVFNCT,D23WQEGM         WQE GETMAIN FAILURE, SP231       02197000
         STC   R15,XVREASON                                             02198000
         B     IEAGNOWQ                                                 02199000
*                                                                       02200000
*        GETMAIN OK, EXTEND CELLPOOL                                    02201000
*                                                                       02202000
IEA01272 ST    R1,SPLEXTAD             SAVE ADDR OF THE EXTENSION       02203000
         L     R3,ADDRUCM              RESTORE BASE FOR UCM             02204000
         L     R0,UCMWQECP             GET WQE CELL POOL ID             02205000
         LA    R15,WMJMSIZE            SIZE OF CELLS REQUIRED           02206000
*                                                                       02207000
*        ADDR OF EXTENSION IS IN R1                                     02208000
*                                                                       02209000
         BLDCPOOL  CPID=(0),SP=231,CSIZE=(15),CPADDR=(1),              X02210000
               AUTODEL=YES,POOLSIZ=4,BRANCH=YES,SERIAL=YES              02211000
*                                                                       02212000
*        CHECK IF EXTENSION IS OK                                       02213000
*                                                                       02214000
         LA    R2,KH1                  INSURE R2 SET TO LOOP            02215000
         LTR   R15,R15                 CELL POOL EXTENDED ?             02216000
         BZ    IEAGLOOP                YES, GO BACK AND GET A WQE       02217000
*                                                                       02218000
*        EXTENSION WASN'T SUCCESSFUL                                    02219000
*        FREE THE STORAGE FOR THE EXTENSION                             02220000
*                                                                       02221000
         MVI   XVAMOD,MWTOID           IEAVMWTO'S ID FOR D23            02222000
         MVI   XVFNCT,D23WQEBC         WQE BLDCPOOL FAILURE             02223000
         STC   R15,XVREASON                                             02224000
         L     R0,SPLFRECN             LOAD SUBPOOL AND SIZE            02225000
         L     R1,SPLEXTAD             GET ADDR OF EXTENSION            02226000
*                                                                       02227000
         FREEMAIN  R,LV=(0),A=(1),BRANCH=YES                            02228000
*                                                                       02229000
IEAGNOWQ SR    R1,R1                   SET R1 TO SHOW NO WQE            02230000
         LR    R2,R1                   GET OUT OF LOOP                  02231000
         B     IEAGLOOP                                                 02232000
*                                                                       02233000
IEAGRETN LM    R14,R0,GETSAVE          RESTORE R14 TO R0                02234000
         L     R2,GETSAVE+16           RESTORE R2                       02235000
         BR    R14                     RETURN TO CALLER                 02236000
*                                                                       02237000
         DROP  R3                                                       02238000
*                                                                       02239000
*        WAITWQE                                                        02240000
*                                                                       02241000
*        WAIT FOR A WQE TO BE FREED                                     02242000
*        INPUT -                                                        02243000
*        XVWWB IS SET TO ZERO BY INITIAL SEGMENT AND TO ADDR OF         02244000
*        WWB BY THIS ROUTINE                                            02245000
*        OUTPUT -                                                       02246000
*        XVWWB -> WWB. AT LEAST ONE WQE HAS BEEN FREED                  02247000
*                                                                       02248000
WAITWQE  STM   R14,R2,WAITSAVE         SAVE CALLER'S REGISTERS          02249000
*                                                                       02250000
*        CHECK IF A WWB EXISTS. IF NOT THEN GET ONE                     02251000
*                                                                       02252000
         ICM   R1,B'1111',XVWWB        HAS A WWB BEEN OBTAINED ?        02253000
         BNZ   IEABWAIT                YES, WAIT ON THE ECB             02254000
*                                                                       02255000
*        NO, GET A WWB AND CHAIN IT TO WQE WWB CHAIN                    02256000
*                                                                       02257000
         L     R0,WKGETWWB             GETMAIN PARM OF SUBPL & SIZE     02258000
*                                                                       02259000
         GETMAIN R,LV=(0),BRANCH=YES                                    02260000
*                                                                       02261000
         ST    R1,XVWWB                SAVE ADDR OF WWB                 02262000
         USING WWB,R1                  ADDRESSABILITY FOR WWB           02263000
*                                                                       02264000
*        SET UP THE WWB                                                 02265000
*                                                                       02266000
         MVC   WWBASCB,ASCBSAVE        PUT IN CALLER'S ASCB ADDR        02267000
         ST    R4,WWBTCBAD             CALLER'S TCB ADDR                02268000
         L     R3,ADDRUCM              R3 -> UCM                        02269000
         USING UCM,R3                                                   02270000
*                                                                       02271000
*        CONNECT THIS WWB IN TO END OF THE CHAIN                        02272000
*                                                                       02273000
         L     R2,UCMWECBT             R2 -> END OF CHAIN               02274000
*                                                                       02275000
*        R2 -> LAST WWB ON THE CHAIN                                    02276000
*        MOVE END OF CHAIN ENDICATOR FROM PREVIOUS END TO NEW WWB       02277000
*                                                                       02278000
         MVC   WWBFWDPT,WWBFWDPT-WWB(R2)                                02279000
*                                                                       02280000
*        POINT LAST WWB ON CHAIN TO NEW WWB                             02281000
*                                                                       02282000
         ST    R1,WWBFWDPT-WWB(,R2)                                     02283000
*                                                                       02284000
*        POINT NEW WWB BACK TO LAST CHAIN MEMBER                        02285000
*                                                                       02286000
         ST    R2,WWBBCKPT                                              02287000
*                                                                       02288000
*        POINT CHAIN TAIL AT NEW WWB                                    02289000
*                                                                       02290000
         ST    R1,UCMWECBT                                              02291000
*                                                                       02292000
*        THE NEW WWB IS NOW AT THE END OF THE CHAIN                     02293000
*                                                                       02294000
IEABWAIT L     R1,XVWWB                INSURE ADDRESSABILITY OF WWB     02295000
         NI    WWBFLAGS,255-WWBPOSTD   TURN OFF POSTED BIT              02296000
         XC    WWBECB,WWBECB           ZERO OUT THE ECB                 02297000
*                                                                       02298000
*        FREE THE LOCKS BEFORE ISSUING THE WAIT                         02299000
*                                                                       02300000
         BAL   R15,FRELCKS             CALL THE FREE LOCK SUBROUTINE    02301000
*                                                                       02302000
*        CLEAR RETRY ADDRESS IN PARM AREA                               02303000
*                                                                       02304000
         L     R1,PARMPTR              ADDR OF ESTAE PARM AREA          02305000
         USING PARMLIST,R1                                              02306000
         XC    PARMRTAD,PARMRTAD       CLEAR RETRY ADDR                 02307000
         DROP  R1                                                       02308000
         L     R1,XVWWB                                                 02309000
         USING WWB,R1                                                   02310000
*                                                                       02311000
*        CHECK IF WE ARE IN MEMORY ONE                                  02312000
*        IF NOT THEN TAKE A LONG WAIT                                   02313000
*                                                                       02314000
         L     R7,ASCBSAVE             LOAD ADDR OF OUR ASCB            02315000
         USING ASCB,R7                                                  02316000
         CLC   ASCBASID,KH1            IN MEMORY ONE WITH COMMTASK ?    02317000
         DROP  R7                                                       02318000
         BNE   IEABLONG                NO, GO TAKE A LONG WAIT          02319000
         LA    R1,WWBECB               GET ADDR OF ECB IN WAIT BLOCK    02320000
*                                                                       02321000
         WAIT  ,ECB=(1)                WAIT FOR A WQE TO BE FREED       02322000
*                                                                       02323000
         B     IEABRETN                                                 02324000
*                                                                       02325000
IEABLONG LA    R1,WWBECB               R1 -> ECB IN WAIT BLOCK          02326000
*                                                                       02327000
         WAIT ,ECB=(1),LONG=YES        TAKE A LONG WAIT                 02328000
*                                                                       02329000
*        SET THE LOCAK AND CMS LOCKS                                    02330000
*                                                                       02331000
IEABRETN BAL   R15,SETLCKS                                              02332000
         LM    R14,R2,WAITSAVE                                          02333000
         BR    R14                     RETURN TO USER                   02334000
*                                                                       02335000
         DROP  R1                                                       02336000
         DROP  R3                                                       02337000
*                                                                       02338000
*        TEXTLINE                                                       02339000
*                                                                       02340000
*        THIS ROUTINE SETS R4 -> THE NEXT LINE IN THE                   02341000
*        WPL TO BE PROCESSED                                            02342000
*                                                                       02343000
*        INPUT -                                                        02344000
*        ADDRMLHR -> WPLLTF                                             02345000
*        XVD3TXT1 IF ON INDICATES THAT THE FIRST LINE OF THE WPL        02346000
*        WAS JUST PROCESSED                                             02347000
*        R4 -> WPLML0 OF CURRENT LINE IF NOT THE FIRST LINE             02348000
*                                                                       02349000
*        OUTPUT -                                                       02350000
*        XVD3TXT1 IS SET OFF                                            02351000
*        XVX0UDCL IS SET OFF                                            02352000
*        R4 -> WPLML0 FOR THE NEXT LINE                                 02353000
*                                                                       02354000
         USING WPLML,R4                                                 02355000
*                                                                       02356000
TEXTLINE TM    XVD3,XVD3TXT1           FIRST LINE JUST PROCESSED        02357000
         BZ    IEAXNFST                NO, INCREMENT FOR ML EXTENSION   02358000
*                                      HEADER                           02359000
*                                                                       02360000
*        THE FIRST LINE HAS BEEN PROCESSED                              02361000
*        ADVANCE TO THE FIRST LINE IN THE MULTI LINE EXTENSION          02362000
*                                                                       02363000
         L     R4,ADDRMLHR             R4 -> WPLLTF                     02364000
         LA    R4,4(,R4)               INCR TO FIRST LINE IN WPLML0     02365000
         NI    XVD3,255-XVD3TXT1       TURN OFF LINE ONE FLAG           02366000
         NI    XVX0,255-XVX0UDCL       TURN OFF DEFAULT CNTL LINE FLAG  02367000
         B     IEAXRETN                RETURN TO CALLER                 02368000
*                                                                       02369000
*        R4 -> L'CURRENT LINE                                           02370000
*        INCREMENT R4 TO THE NEXT LINE                                  02371000
*                                                                       02372000
IEAXNFST AH    R4,WPLML0               ALL LENGTH OF CURRENT LINE       02373000
*                                      R4 -> WPLML0 FOR THE NEXT LINE   02374000
*        DROP  R4                                                       02375000
IEAXRETN BR    R14                     RETURN TO USER                   02376000
*                                                                       02377000
*        FRELCKS                                                        02378000
*                                                                       02379000
*        THE CMS AND LOCAL LOCKS ARE RELEASED                           02380000
*        R11, R12 AND R13 ARE SAVED                                     02381000
*        R11 AND R12 GO IN MLWTO'S WORKAREA                             02382000
*        R13 IS SAVED IN R0                                             02383000
*        R15 IS THE RETURN REGISTER                                     02384000
*                                                                       02385000
FRELCKS  ST    R11,REG11SAV            BASE REG SAVED IN WORKAREA       02386000
         ST    R12,REG12SAV            EXTENDED SAVE AREA BASE          02387000
         LR    R0,R13                  MOVE PTR TO SAVEAREA             02388000
*                                                                       02389000
*        FREE THE FRR AND RESET THE PARM AREA PTR                       02390000
*                                                                       02391000
         SETFRR D,WRKREGS=(11,12)                                       02392000
*                                                                       02393000
         LA    R12,EPARM               ADDR OF ESTAE PARM AREA          02394000
         ST    R12,PARMPTR             SAVE NEW ADDR                    02395000
*                                                                       02396000
         SETLOCK RELEASE,TYPE=CMS,                                     *02397000
               RELATED=(UCM,IEAVMWTO(SETLCKS))                          02398000
*                                                                       02399000
         SETLOCK RELEASE,TYPE=LOCAL,                                   *02400000
               RELATED=(UCM,IEAVMWTO(SETLCKS))                          02401000
*                                                                       02402000
         LR    R13,R0                  RESTORE PTR TO SAVEAREA          02403000
         L     R11,REG11SAV            RESTORE BASE REG                 02404000
         LA    R12,EPARM               GET ADDR OF ESTAE PARMLIST       02405000
         USING PARMLIST,R12            ESTABLISH BASE                   02406000
         NI    PARMFLAG,255-PARMFRID   TURN OFF FRR INDICATOR           02407000
         DROP  R12                     RELEASE BASE                     02408000
         L     R12,REG12SAV            RESTORE PTR TO EXTENDED AREA     02409000
         BR    R15                     RETURN TO CALLER                 02410000
*                                                                       02411000
*        SETLCKS                                                        02412000
*                                                                       02413000
*        THE LOCAL AND CMS LOCKS ARE OBTAINED                           02414000
*        R11, R12 AND R13 ARE SAVED                                     02415000
*        R11 AND R12 GO IN MLWTO'S WORKAREA                             02416000
*        R13 IS SAVED IN R0                                             02417000
*        R15 IS THE RETURN REGISTER                                     02418000
*                                                                       02419000
SETLCKS  ST    R11,REG11SAV            BASE REG SAVED IN WORKAREA       02420000
         ST    R12,REG12SAV            EXTENDED SAVE AREA BASE          02421000
         LR    R0,R13                  MOVE PTR TO SAVEAREA             02422000
*                                                                       02423000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        *02424000
               RELATED=(UCM,IEAVMWTO(FRELCKS))                          02425000
*                                                                       02426000
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          *02427000
               RELATED=(UCM,IEAVMWTO(FRELCKS))                          02428000
*                                                                       02429000
         LR    R13,R0                  RESTORE PTR TO SAVEAREA          02430000
         L     R11,REG11SAV            RESTORE BASE REG                 02431000
         L     R12,REG12SAV            RESTORE PTR TO EXTENDED AREA     02432000
*                                                                       02433000
*        SET UP THE FRR FOR THIS ROUTINE                                02434000
*        LET SETFRR USE R2 AND R3 AS WORK REGS                          02435000
*        SAVE THE CONTENTS OF R2 AND R3 IN SUBSLIST                     02436000
*                                                                       02437000
         STM   R2,R3,SUBSLIST          SAVE R2 AND R3                   02438000
         L     R3,ADDRUCM              R3 -> UCM                        02439000
         USING UCM,R3                                                   02440000
         L     R1,UCMFRRAD             R1 -> COMM TASK FRR IEAVMFRR     02441000
         DROP  R3                                                       02442000
*                                                                       02443000
         SETFRR A,FRRAD=(R1),PARMAD=PARMPTR,WRKREGS=(R2,R3)             02444000
*                                                                       02445000
         L     R1,PARMPTR              R1 -> FRR PARMAREA               02446000
         USING PARMLIST,R1                                              02447000
         LA    R2,RECSAVE              R2 -> REG SAVE AREA              02448000
         ST    R2,PARMRGAD             PT TO REG AREA FOR RETRY         02449000
         MVC   PARMID,MODULEID         IDENTIFY AS IEAVMWTO             02450000
         DROP  R1                      DROP PRESENT PARMLIST BASE       02451000
         LA    R2,EPARM                GET PTR TO ESTAE PARMLIST        02452000
         USING PARMLIST,R2             SET ADDRESS TO ESTAE PARM        02453000
*                                                                       02454000
*********************************************************************** 02455000
*                                                                       02456000
*        THE FOLLOWING PARMFRID FIELD IN THE ESTAE PARAMETER LIST       02457000
*        IS SET TO ZERO TO GUARANTEE THAT RECOVERY WILL BE DONE         02458000
*        ON BOTH THE ESTAE AND FRR LEVEL                                02459000
*                                                                       02460000
*********************************************************************** 02461000
         NI    PARMFLAG,255-PARMFRID   TURN OFF FRR INDICATOR           02462000
         DROP  R2                      DROP TEMPORARY BASE              02463000
         USING PARMLIST,R1             RESET BASE TO FRR PARMLIST       02464000
         MVI   PARMFTPT,FTLOCK         SET FOOTPRINT                    02465000
         LA    R2,MWTOCLNP             R2 -> MLWTO CLEANUP ROUTINE      02466000
         ST    R2,PARMCLAD                                              02467000
         LM    R2,R3,SUBSLIST          RESTORE R2 AND R3                02468000
         DROP  R1                                                       02469000
         BR    R15                     RETURN TO CALLER                 02470000
*                                                                       02471000
*********************************************************************** 02472000
*                                                                       02473000
*        WORKAREA FOR THIS MODULE IEAVMWTO                              02474000
*                                                                       02475000
*********************************************************************** 02476000
*                                                                       02477000
WORKAREA DSECT                                                          02478000
SAVEREGS DS    18F                     STANDARD SAVEAREA                02479000
REG4SAV  DS    F                       SAVEAREA FOR R4                  02480000
REG9SAV  DS    F                       USED TO SAVE R9                  02481000
REG11SAV DS    F                       USED TO SAVE R11                 02482000
REG12SAV DS    F                       USED TO SAVE R12                 02483000
WORK8    DS    D                                                        02484000
GETSAVE  DS    5F                      SAVEAREA FOR GETWQE ROUTINE      02485000
SPLEXTAD DS    F                       -> WQE EXTENSION                 02486000
WAITSAVE DS    6F                      SAVE AREA FOR WIITWQE ROUTINE    02487000
ASCBSAVE DS    F                       SAVE AREA FOR ASCB ADDR          02488000
ADDRMLHR DS    F                       -> MULTI LINE EXTENSION HEADER   02489000
*                                         PART OF WPL                   02490000
TCBSAVE  DS    F                       -> CALLER'S TCB                  02491000
SUBSPARM DS    F                       PTS AT THE SUBSLIST              02492000
SUBSLIST DS    9F                      CONTAINS THE SSOB & SSWT         02493000
*                                                                       02494000
*        ESTAE SVC PARAMETER AREA                                       02495000
*                                                                       02496000
EPARM    DS    CL24                    ESTAE PARM AREA                  02497000
*                                                                       02498000
ADDRUCM  DS    F                       -> UCM                           02499000
PARMPTR  DS    F                       -> RECOVERY PARM AREA            02500000
NUMLINES DS    XL1                     COUNT OF LINES PROCESSED         02501000
RECSAVE  DS    H                       RESTORE MAP                      02502000
RECREGS  DS    16F                     RESTORE AREA FOR RETRY           02503000
LASTWPLB DS    F                       -> LAST BYTE +1 OF WPL IN SP 229 02504000
WORKBYTE DS    XL1                                                      02505000
LINETYPE DS    XL1                     LINE TYPE FLAGS FROM WPLLTF      02506000
*                                      OR WPLMLLTF                      02507000
         DS    0D                      ROUND UP TO DOUBLE WORD          02508000
WRKSIZE  EQU   *-WORKAREA              CALC SIZE OF WORKAREA            02509000
*                                                                       02510000
*********************************************************************** 02511000
*                                                                       02512000
*        WORKAREA USED IN MODULE IEAVVWTO                               02513000
*                                                                       02514000
*********************************************************************** 02515000
*                                                                       02516000
WORKVV   DSECT                                                          02517000
@SA00001 DS    18F                                                      02518000
@SAGETB  DS    18F                                                      02519000
@PC00003 DS    F                                                        02520000
@SA00004 DS    F                                                        02521000
@PC00004 DS    F                                                        02522000
@SA00008 DS    15F                                                      02523000
@SA00002 DS    15F                                                      02524000
@PC00002 DS    F                                                        02525000
PARMPTRV DS    A                                                        02526000
@TF00001 DS    F                                                        02527000
REG1SAV  DS    F                                                        02528000
REG2SAV  DS    A                  SAVE AREA FOR R2 WHEN DEALING WITH    02529000
*                                 UCM                                   02530000
LONGTXT  DS    A                  -> AREA GETMAINED FOR LONG WPL        02531000
*                                    IF ZERO THEN NO STORAGE GETMAINED  02532000
LONGLEN  DS    F                  L'GETMAINED AREA FOR LONG TEXT        02533000
*                                                                       02534000
LENMWQE  DS    F                  L'OF ALL MINOR WQES                   02535000
*                                 VALID ONLY FOR MLWTO                  02536000
MLWTOXH  DS    A                  -> MLWTO EXTENT HEADER IN CALLERS WPL 02537000
*                                 VALID ONLY FOR MLWTO                  02538000
*                                                                       02539000
*        VERSION 2 XWPL TO STORE ALL USER PROVIDED WPL FIELDS           02540000
*                                                                       02541000
WKALGH   DS    AL2                MESSAGE LENGTH OF MAJOR WQE TEXT FROM 02542000
*                                 CALLER'S WPL                          02543000
WKAMCSF  DS    XL2                MCS FLAGS COPIED FROM CALLERS WPL     02544000
WKAADTXT DS    AL4                -> MESSAGE TEXT                       02545000
WKAVRSN  DS    AL1                XWPL VERSION NUMBER                   02546000
WKAFLAGS DS    XL1                MISC FLAGS                            02547000
WKARPYLN DS    AL1                L'REPLY FOR WTOR                      02548000
WKALNGTH DS    AL1                L'XWPL, ZERO FOR VERSION 1            02549000
WKAMCSF1 DS    XL2                EXTENDED MCS FLAGS                    02550000
WKACPFLF DS    XL2                MCS FLAGS FOR CNTL PROGRAM USE        02551000
WKARPBUF DS    AL4                -> REPLY BUFFER                       02552000
WKAECBP  DS    AL4                -> ECB                                02553000
WKASEQN  DS    AL4                DOM/CONNECT ID                        02554000
WKADSC   DS    XL2             *  DESCRIPTOR CODE TO BE USED IN WTO     02555000
WKAROC   DS    XL2             V  ROUTE CODES TO BE USED IN WTO         02556000
WKAROUT  DS    XL14               EXTENDED ROUTING CODES                02557000
WKAMSGTY DS    XL2                MSGTYPE FLAGS COPIED FROM CALLERS WPL 02558000
WKAPRTY  DS    XL2                MESSAGE PRIORITY                      02559000
WKAJOBID DS    CL8                JOB ID                                02560000
WKAJOBNM DS    CL8                JOB NAME                              02561000
WKAKEY   DS    CL8                RETRIEVAL KEY                         02562000
WKATOKN  DS    AL4                TOKEN FOR DOM                         02563000
WKACNID  DS    AL4                CONSOLE ID                            02564000
WKASYSNA DS    CL8                SYSTEM NAME                           02565000
WKACNNME DS    CL8                CONSOLE NAME                          02566000
WKARCNA  DS    AL4                -> REPLY CONSOLE NAME/ID              02567000
WKACART  DS    AL4                -> CART                               02568000
WKAWSPRM DS    AL4                -> WAIT STATE PARM LIST               02569000
WKAASCB  DS    AL4                -> ASCB                               02570000
WKARSV30 DS    XL16               RESERVED                              02571000
*                                                                       02572000
WKATEXT  DS    CL129              MESSAGE TEXT (MAXIMUM 125 CHARS) +4   02573000
*                                                                       02574000
ESTAEPRM DS    A                                                        02575000
@TS00001 DS    CL1                                                      02576000
STARTID  DS    CL1                                                      02577000
CVDAREA  DS    D                                                        02578000
*                                                                       02579000
PFLAG    DS    XL1                ADDITIONAL FLAGS                      02580000
REQCMSL  EQU   X'40'              REQUEST OR HOLD CMS LOCK              02581000
*                                                                       02582000
*        THE DSECT HAS BEEN TRUNCATED TO AVOID DUPLICATE NAME ISSUES    02583000
*                                                                       02584000
IEAVMWTO CSECT                                                          02585000
*                                                                       02586000
         IHAWQE DSECT=YES                                               02587000
*                                                                       02588000
         IHACTM WWB                                                     02589000
*                                                                       02590000
         IHACTM FTPT                                                    02591000
*                                                                       02592000
         IHAFRRS                                                        02593000
*                                                                       02594000
         IEZWPL DSECT=YES                                               02595000
*                                                                       02596000
         PRINT NOGEN                                                    02597000
*                                                                       02598000
         IHAASCB                                                        02599000
*                                                                       02600000
         IEFJSSOB  (WT),CONTIG=YES                                      02601000
*                                                                       02602000
         IEFJESCT                                                       02603000
*                                                                       02604000
         IHAPSA                                                         02605000
*                                                                       02606000
         IKJRB   DSECT=YES                                              02607000
*                                                                       02608000
         PRINT GEN                                                      02609000
*                                                                       02610000
*/********************************************************************/ 02611000
*/*                                                                  */ 02612000
*/*          EXTENDED SAVEAREA MAPPING FOR SVC 35                    */ 02613000
*/*                                                                  */ 02614000
*/********************************************************************/ 02615000
*                                                                       02616000
*        DEFINED IN THE RBEXSAVE AREA                                   02617000
*                                                                       02618000
         ORG   RBEXSAVE                                                 02619000
XVSAV    DS    0A                                                       02620000
XVA4     DS    0F                      ERROR PROCESSING FIELDS          02621000
XVFNCT   DS    C                       D23 PROCESS CODE                 02622000
D23VALID EQU   X'10'                   PARMLIST VALIDITY CHECK          02623000
D23OREGC EQU   X'20'                   ORE GETCELL FAILURE              02624000
D23OREBC EQU   X'21'                   ORE BLDCPOOL FAILURE             02625000
D23OREGM EQU   X'22'                   ORE GETMAIN FAILURE, SP231       02626000
D23WQEGC EQU   X'30'                   WQE GETCELL FAILURE              02627000
D23WQEBC EQU   X'31'                   WQE BLDCPOOL FAILURE             02628000
D23WQEGM EQU   X'32'                   WQE GETMAIN FAILURE, SP231       02629000
D23DYN   EQU   X'42'                   DYNAMIC AREA GETMAIN FAILURE     02630000
XVAMOD   DS    C                       D23 MODULE ID                    02631000
VWTOID   EQU   X'01'                   IEAVVWTO'S ID FOR D23            02632000
MWTOID   EQU   X'02'                   IEAVMWTO'S ID FOR D23            02633000
XVA41    DS    C                       RESERVED                         02634000
XVREASON DS    C                       D23 REASON CODE                  02635000
D23BNDY  EQU   X'01'                   WTOR PARMLIST NOT ON WORD BNDY   02636000
D23MLWTR EQU   X'02'                   MULTILINE WTOR SPECIFIED         02637000
D23PARM  EQU   X'03'                   WPL NOT ADDRESSABLE BY USER      02638000
D23ZERO  EQU   X'04'                   ZERO TEXT LENGTH WTOR            02639000
D23SIZE  EQU   X'05'                   CALLER MODIFIED WPL              02640000
*                                      DURING WTO PROCESSING            02641000
D23LTXT  EQU   X'06'                   WTO/WTOR TEXT= CODED AND         02642000
*                                      WPLLGH ^=8                       02643000
*                                                                       02644000
XVA8     DS    AL4                     STORE TIME                       02645000
XVWPLADR DS    AL4                     -> CALLERS WPL                   02646000
XVWQEAD  DS    AL4                                                      02647000
*                                                                       02648000
*        FLAGS                                                          02649000
*                                                                       02650000
XVDFLAGS DS    0XL4                                                     02651000
XVD0     DS    X                                                        02652000
XVD0RPFD EQU   BIT1                    HARD COPY ONLY                   02653000
XVD0NWQE EQU   BIT2                    GET WQE                          02654000
XVD0NORE EQU   BIT3                    GET THE ORE FIRST                02655000
XVD0QID  EQU   BIT4                    QID FIELD IS PRESENT IN THE WPL  02656000
XVD0WWB  EQU   BIT5                    WWB WTO WAIT BLOCK OBTAINED      02657000
XVD0USER EQU   BIT6                                                     02658000
XVD0HDCY EQU   BIT7                                                     02659000
*                                                                       02660000
*        XVDFLAGS+1                                                     02661000
*                                                                       02662000
XVD1     DS    X                                                        02663000
XVD1PRIV EQU   BIT0                    PRIVILEGED USER                  02664000
XVD1ENQW EQU   BIT1                    ENQ'D ON A WQE  (VMWTO)          02665000
XVD1ENQO EQU   BIT2                    ENQ'D ON AN ORE (VMWTO)          02666000
XVD1ALDN EQU   BIT2                    ALL NEEDED CONTROL BLKS OBTAINED 02667000
XVD1PP   EQU   BIT5                    PROBLEM PROGRAM CALLER           02668000
XVD1AUTH EQU   BIT6                    KEY 0, SUPVR STATE OR APF AUTH   02669000
XVD1PERR EQU   BIT7                    SEVERE ERROR FOUND. ABEND USER   02670000
*                                                                       02671000
*        XVDFLAGS+2                                                     02672000
*                                                                       02673000
XVD2     DS    X                                                        02674000
XVD2CON  EQU   BIT0                    CONNECTING                       02675000
XVD2VALD EQU   BIT3                    PARAMETER LIST IS VALID          02676000
XVD2DELW EQU   BIT4                    SEND MSG TO HARDCOPY ONLY        02677000
XVD2ZERO EQU   BIT5                    ZERO MSG ID TO USER              02678000
XVD2WTOR EQU   BIT6                    WTOR REQUEST                     02679000
XVD2QFHC EQU   BIT7                    QUEUE THIS MSG TO HARD COPY      02680000
*                                                                       02681000
*        XVDFLAGS+3                                                     02682000
*                                                                       02683000
XVD3     DS    X                                                        02684000
XVD3BLDJ EQU   BIT0                    BUILD MAJOR WQE                  02685000
XVD3BLD1 EQU   BIT1                    BUILD LINE 1                     02686000
XVD3BLD2 EQU   BIT2                    BUILD LINE 2                     02687000
XVD3TXT1 EQU   BIT3                    TEXT LINE 1 BEING PROCESSED      02688000
XVD3TFX  EQU   BIT4                    TCBTFX WAS SET ON,TURN IT OFF    02689000
*        END OF FLAGS                                                   02690000
XVOREAD  DS    AL4                                                      02691000
         ORG   XVOREAD                                                  02692000
XVX      DS    0F                      USED AS WORK AREA BY VMWTO       02693000
XVX0     DS    X                       LINE CONTROL FLAGS - MLWTO       02694000
XVX0FLCL EQU   BIT0                    FIRST LINE IS CONTROL LINE       02695000
XVX0LL1F EQU   BIT1                    LABEL LINE 1 FOUND               02696000
XVX0LL2F EQU   BIT2                    LABEL LINE 2 FOUND               02697000
XVX0UDCL EQU   BIT3                    USE DEFAULT CONTROL LINE         02698000
XVX0FLJE EQU   BIT4                    FIRST LINE JUST 'E'              02699000
XVX0FEDE EQU   BIT5                    FORCE END (LAST LINE TO BE DE)   02700000
XVX1     DS    X                       ERROR FLAGS - MLWTO              02701000
XVX1STOP EQU   BIT0                    ERROR IN PARM LIST; IGNORE MLWTO 02702000
XVX1NOID EQU   BIT1                    NO ID FOR CONNECTING MLWTO       02703000
XVX2     DS    AL1                     NO OF LINES STILL TO DO          02704000
XVX3     DS    AL1                     NO OF LINES FROM MLWTO EXT HDR   02705000
*                                                                       02706000
XVCMAJOR DS    AL4                  *                                   02707000
XVCMINOR DS    AL4                  V                                   02708000
*                                                                       02709000
XVWWB    DS    AL4                                                      02710000
*                                                                       02711000
XVWQEID  DS    0AL4           *        CALLERS R0                       02712000
XVWQEIDA DS    AL3            |        A NEW LINE IS TO BE              02713000
*                             |        CONNECTED TO THE MESSAGE         02714000
*                             |        WITH THIS 3 BYTE MESSAGE ID      02715000
*                             |        MLWTO ONLY                       02716000
XVCONID  DS    XL1            V        CONSOLE ID FOR THIS MESSAGE      02717000
*                                                                       02718000
XVRET    DS    0AL4                                                     02719000
XVRETCOD DS    AL4                                                      02720000
XVLEN    EQU   *-XVSAV                 MUST NOT EXCEED 48 BYTES AS      02721000
*                                      RB EXTENDED SAVE AREA USED       02722000
*                                                                       02723000
         PRINT NOGEN                                                    02724000
*                                                                       02725000
         IKJTCB  DSECT=YES                                              02726000
*                                                                       02727000
         CVT   DSECT=YES,LIST=YES                                       02728000
*                                                                       02729000
         IHASCVT LIST=YES                                               02730000
*                                                                       02731000
         IEZJSCB                                                        02732000
*                                                                       02733000
         PRINT GEN                                                      02734000
*                                                                       02735000
         IEECUCM FORMAT=NEW                                             02736000
*                                                                       02737000
*                                                                       02738000
R0       EQU   0                                                        02739000
R1       EQU   1                                                        02740000
R2       EQU   2                                                        02741000
R3       EQU   3                                                        02742000
R4       EQU   4                                                        02743000
R5       EQU   5                                                        02744000
R6       EQU   6                                                        02745000
R7       EQU   7                                                        02746000
R8       EQU   8                                                        02747000
R9       EQU   9                                                        02748000
R10      EQU   10                                                       02749000
R11      EQU   11                                                       02750000
R12      EQU   12                                                       02751000
R13      EQU   13                                                       02752000
R14      EQU   14                                                       02753000
R15      EQU   15                                                       02754000
*                                                                       02755000
         END                                                            02756000
./ ADD NAME=IEAVVWTO
VVW      TITLE 'IEAVVWTO - SVC 35 - WTO AND WTOR PROCESSOR'             00001000
*                                                                       00002000
IEAVVWTO CSECT                                                          00003000
*                                                                       00004000
         ENTRY  TRTAB                                                   00005000
*                                                                       00006000
*        STATUS -                                                       00007000
*        LASTUPD         = JCLIN    TYPE=UPD                            00008000
*        LIBRARIES       = DISTLIB=AOSC5                                00009000
*        FMID            = FBB1221                                      00010000
*        RMID            = UZ62088                                      00011000
*        LKED ATTRIBUTES = RENT      REFR                               00012000
*        LMOD            = IGC0003E                                     00013000
*        SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS       00014000
*                          EBB1102  FUNCTION  00.000  MOD      ACC RGN  00015000
*                          FBB1221  FUNCTION  00.000  MOD      ACC RGN  00016000
*                          UZ60302  PTF       00.000  MOD      ACC RGN  00017000
*                          UZ62088  PTF       74.164  MOD  APP ACC      00018000
*                                                                       00019000
*        ORIGINAL SOURCE FROM MVSSRC.SYM101.F20 WAS UPDATED             00020000
*        BY DISASSEMBLY TO MATCH THE LOAD MODULE AT THE UZ62088         00021000
*        LEVEL.                                                         00022000
*                                                                       00023000
*        MANY INSTALLATIONS HAVE APPLIED USERMOD TMVS805 CONTRIBUTED    00024000
*        BY KEVIN LEONARD AS THIS USERMOD SIGNIFICANTLY INCREASES       00025000
*        THE USEFULNESS OF THE IEECVXIT TO AUTOMATE OPERATIONS BY       00026000
*        ALLOWING IEECVXIT TO -                                         00027000
*                (1) SEE "INTERNAL" MESSAGES;                           00028000
*                (2) PREVENT HARDCOPY OF DELETED MESSAGES.              00029000
*        THIS USERMOD ZP60039 CHANGES THE OFFSET OF THE CODE BEING      00030000
*        ZAPPED BY TMVS805 SO TMVS805 WOULD REQUIRE REWORK TO BE        00031000
*        APPLIED TO ZP60039. HOWEVER AS TMVS805 (ALSO SHIPPED AS        00032000
*        ZUM0013) IS SO COMMONLY USED IT HAS BEEN INCLUDED IN ZP60039.  00033000
*        ZP60039 THEREFORE SUPERCEDES TMVS805 AND ZUM0013.              00034000
*        FOR THOSE USERS WHO DO NOT WISH TO INCLUDE THE FUNCTIONALITY   00035000
*        OF TMVS805 IN THIS USERMOD THEN SET THE VARIABLE &TMVS805      00036000
*        TO ZERO BEFORE RECEIVING AND APPLYING THIS USERMOD.            00037000
*                                                                       00038000
         LCLB  &TMVS805                                                 00039000
&TMVS805 SETB  1             <------- ENABLE TMVS805 FUNCTIONALITY      00040000
*                                                                       00041000
*        CHANGE ACTIVITY -                                              00042000
*               ZP60039  - 1. SUPPORT FOR THE EXTENDED WPL              00043000
*                             PARAMETER LIST TO ENABLE THE USE OF       00044000
*                             THE TEXT OPERAND                          00045000
*                          2. THE WPL OR XWPL IS NOW COPIED TO          00046000
*                             PROTECTED STORAGE AFTER VALIDATION        00047000
*                             FOR AUTHORIZED CALLERS WHEREAS            00048000
*                             PREVIOUSLY IT WAS ONLY COPIED FOR NON     00049000
*                             AUTHORIZED USERS                          00050000
*                          3. INCLUDE USERMOD TMVS805 (OPTIONAL)        00051000
*                          4. NUMEROUS CHANGES TO IMPROVE SOURCE        00052000
*                             READABILITY                               00053000
*                          5. LOCALIZED CODE OPTIMZATION                00054000
*                          6. THE IEAVVWTO CODE AT THE UZ62088 LEVEL    00055000
*                             FAILED TO HANDLE AN INVALID WPL PASSED    00056000
*                             BY THE CALLER RESULTING IN MULTIPLE       00057000
*                             IEAVMFRR DUMPS. THIS HAS BEEN RESOLVED.   00058000
*                             AN INVALID WPL NOW RESULTS IN A           00059000
*                             D23 ABEND WITH A REASON CODE IN R15       00060000
*                             AS PER THE DESCRIPTION PROVIDED IN        00061000
*                             GC38-1008 OS/VS ML: SYSTEM CODES          00062000
*                             ABEND D23                                 00063000
*                          7. TRANSLATION OF UNPRINTABLE CHARACTERS     00064000
*                             IN WPL TEXT TO HEX A1 (TILDE CHARACTER)   00065000
*                                                                       00066000
*        FUNCTION -                                                     00067000
*        SVC 35 WTO AND WTOR PROCESSOR                                  00068000
*        1. SETUP THE RECOVERY/TERMINATION ENVIRONMENT                  00069000
*        2. DETERMINE THE STATUS OF THE CALLER - PP/APF/SUP             00070000
*        3. DETERMINE THE FORMAT OF THE CALLER PROVIDED WPL.            00071000
*           THERE ARE A NUMBER OF WTO AND WTOR WPL PARAMETER FORMATS    00072000
*           FOR WTO THERE ARE -                                         00073000
*           1. STANDARD 370 WTO WPL                                     00074000
*           2. EXTENDED WPL VERSION 1                                   00075000
*           3. EXTENDED WPL VERSION 2 (SUPPORT FOR TEXT= PARAMETER)     00076000
*           FOR WTOR THERE ARE -                                        00077000
*           1. STANDARD 370 WTOR WPL                                    00078000
*           2. 31 BIT WTOR WPL                                          00079000
*           3. EXTENDED WPL VERSION 1                                   00080000
*           4. EXTENDED WPL VERSION 2 (SUPPORT FOR TEXT= PARAMETER)     00081000
*        4. VALIDATE CALLER ACCESS TO THE WPL FIELDS AND VALIDATE       00082000
*           WPL PARAMETERS FOR CONSISTENCY                              00083000
*        5. MOVE PARAMETERS FROM CALLER PROVIDED WPL TO PROTECTED       00084000
*           STORAGE                                                     00085000
*        6. VALIDATE KEY PARAMETERS MOVED TO PROTECTED STORAGE WERE     00086000
*           NOT CHANGED IN THE CALLERS WPL DURING THE MOVE.             00087000
*           THIS STEP IS REQUIRED TO PREVENT ANY INTEGRITY EXPOSURES    00088000
*                                                                       00089000
*        NOTES -                                                        00090000
*                                                                       00091000
*        DUE TO THE LIMITATIONS OF THE PARAMETER LIST PASSED            00092000
*        TO IEECVXIT BY IEAVVWTO SOME IEECVXIT EXITS MAKE               00093000
*        ASSUMPTIONS ABOUT THE CONTENTS OF THE REGISTERS INHERITED      00094000
*        BY IEECVXIT THAT ARE NOT DEFINED BY THE DOCUMENTED             00095000
*        IEECVXIT PARAMETER LIST.                                       00096000
*                                                                       00097000
*        THE IEECVXIT PROVIDED AS A COMPONENT OF THE BSPPILOT           00098000
*        USERMOD ZUM0003 CONTRIBUTED BY VOLKER BANDKE WILL              00099000
*        AUTOMATICALLY REPLY TO SOME WTOR MESSAGES.                     00100000
*                                                                       00101000
*        TO ENSURE THIS IEECVXIT CODE HAS LOCATED THE CORRECT ORE       00102000
*        FOR A REPLY THE CODE CAPTURES THE USER PROVIDED ECB            00103000
*        ADDRESS TO BE POSTED BY THE OPERATOR REPLY AND USES IT         00104000
*        AS A VALIDATION OF THE CORRECT ORE. THE CODE IN THE            00105000
*        BSPPILOT IEECVXIT ASSUMES THAT R5 WILL POINT TO THE SVRB       00106000
*        FOR SVC 35 AND THAT THE ADDRESS OF THE WPL PASSED TO           00107000
*        SVC 35 WILL BE LOCATED IN THE SVRB+X'74'. THE ADDRESS OF       00108000
*        THE ECB FOR A WTOR WILL BE LOCATED AT AN OFFSET 4 BYTES        00109000
*        INTO THE WPL. FOR AN XWPL THIS IS NOT CORRECT.                 00110000
*                                                                       00111000
*        THEREFORE TO ENSURE THE IEECVXIT PROVIDED BY USERMOD           00112000
*        ZUM0003 WILL CONTINUE TO FUNCTION CORRECTLY WHEN THIS          00113000
*        VERSION OF IEAVVWTO IS INSTALLED R5 IS INITIALIZED TO A        00114000
*        VALUE THAT WHEN PROCESSED BY THE IEECVXT CODE THE              00115000
*        IEECVXIT CODE WILL HAVE OBTAINED THE ECB ADDRESS.              00116000
*                                                                       00117000
*        THERE ARE OTHER IEECVXIT ROUTINES PROVIDED AS USERMODS.        00118000
*        THE CODE IN THEIR IEECVXIT ROUTINES WILL HAVE TO BE INSPECTED  00119000
*        TO ENSURE IT COMPLIES WITH THE DOCUMENTED IEECVXIT             00120000
*        PARAMETER LIST. IF DATA NOT PROVIDED IN THE DOCUMENTED         00121000
*        IEECVXIT PARAMETER IS REQUIRED THEN R9 HAS THE ADDRESS         00122000
*        OF THE IEAVVWTO WORKAREA WHICH CONTAINS ALL THE                00123000
*        REQUIRED DATA.                                                 00124000
*                                                                       00125000
*        KNOWN IEEVCXIT USERMODS -                                      00126000
*                                                                       00127000
*        USERMOD    COMPLIANT  ACTION                                   00128000
*        -------    ---------  -------------------------------------    00129000
*        ZP60001    YES        NO ACTION REQUIRED                       00130000
*        ZUM0003    NO         CODE PROVIDED IN IEAVVWTO TO SUPPORT     00131000
*                              THIS USERMOD SO NO CHANGE IS REQUIRED    00132000
*                              TO ZUM0003                               00133000
*                                                                       00134000
*        STANDARD SVC REGISTER CONVENTIONS -                            00135000
*        ON ENTRY -                                                     00136000
*        R0  USED WHEN THE CALLER ADDS ADDITIONAL MULTIPLE LINE         00137000
*            WTO MESSAGES TO A PREVIOUS STRING OF EXISTING MESSAGES,    00138000
*            IE THE LONG MLWTO ISSUED IN REPLY FOR A D U,DASD COMMAND.  00139000
*            IT CONTAINS THE MESSAGE IDENTIFICATION OF THE ORIGINAL     00140000
*            MESSAGE. R0 ALSO CONTAINS THE UCMID FOR ANY PROGRAM        00141000
*            SPECIFYING REG0 AND FOR PRIVILEGED PROGRAMS SPECIFYING     00142000
*            QREG0.                                                     00143000
*            HI-ORDER 3 BYTES, MESSAGE ID                               00144000
*            LOW ORDER BYTE, CONSOLE ID                                 00145000
*        R1  CALLER INPUT PARAMETER REGISTER (-> WPL OR XWPL)           00146000
*        R2     UNDEFINED                                               00147000
*        R3  -> CVT                                                     00148000
*        R4  -> TCB                                                     00149000
*        R5  -> SVRB                                                    00150000
*        R6  -> SVC ENTRY POINT                                         00151000
*        R7  -> ASCB                                                    00152000
*        R8-R12 UNDEFINED                                               00153000
*        R13    CALLERS VALUE                                           00154000
*        R14    RETURN ADDR TO SVC FLIH EXIT CODE                       00155000
*        R15    CALLERS VALUE                                           00156000
*                                                                       00157000
*        ON EXIT -                                                      00158000
*        R1     MESSAGE IDENTIFICATION NUMBER                           00159000
*        R15    RETURN CODE (ONLY FOR ML-WTO)                           00160000
*                                                                       00161000
         USING *,R6                                                     00162000
         USING CVT,R3                                                   00163000
         USING TCB,R4                                                   00164000
         USING RBBASIC,R5                                               00165000
         USING ASCB,R7                                                  00166000
         B     AROUND                                                   00167000
*                                                                       00168000
         DC    C'IEAVVWTO ZP60039 &SYSDATE &SYSTIME'                    00169000
*                                                                       00170000
AROUND   LA    R11,0(,R6)             CLEANUP R11                       00171000
         LA    R12,2048(,R11)                                           00172000
         LA    R12,2048(,R12)                                           00173000
         DROP  R6                                                       00174000
         USING IEAVVWTO,R11,R12                                         00175000
         XC    RBEXSAVE,RBEXSAVE      ENSURE ENTIRE RBEXSAVE IS ZERO    00176000
*                                                                       00177000
*        SAVE THE CONTENTS OF R0, R1 AND R14                            00178000
*                                                                       00179000
         ST    R0,XVWQEID             SAVE R0 IN EXTENDED SAVEAREA      00180000
*                                     IN CASE A MESSAGE NO/CONSOLE ID   00181000
*                                     HAS BEEN PROVIDED FOR A MLWTO     00182000
         STCM  R1,B'0111',XVWPLADR+1  SAVE R1 IN EXTENDED SAVEAREA      00183000
         STCM  R14,B'0111',XVRET+1    SAVE R14 IN EXTENDED SAVEAREA     00184000
*                                                                       00185000
*        GETMAIN WORKAREA FROM SUBPOOL 229                              00186000
*        INITIALIZE IT TO ZERO                                          00187000
*                                                                       00188000
         L     R0,@SIZDATD                                              00189000
         LR    R9,R0                                                    00190000
*                                                                       00191000
         GETMAIN  R,LV=(0)                                              00192000
*                                                                       00193000
         LR    R8,R1                                                    00194000
         SR    R15,R15                ZERO PAD CHAR AND SOURCE LENGTH   00195000
         MVCL  R8,R14                 ZERO WORKAREA                     00196000
         LR    R9,R1                                                    00197000
         USING @DATD,R9                                                 00198000
         ST    R13,@SA00001+4                                           00199000
         LR    R13,R9                                                   00200000
*                                                                       00201000
*/********************************************************************/ 00202000
*/*                                                                  */ 00203000
*/*  SET UP THE ESTAE ENVIRONMENT                                    */ 00204000
*/*                                                                  */ 00205000
*/*  SET THE FIRST FOOTPRINT FOR IEAVVWTO                            */ 00206000
*/*                                                                  */ 00207000
*/********************************************************************/ 00208000
*   R2=UCMFRRAD;                    /* ADDR OF IEAVMFRR, OUR RECOVERY   00209000
*                                      ROUTINE                       */ 00210000
         L     R2,CVTCUCB                                               00211000
         USING UCM,R2                                                   00212000
         L     R2,UCMFRRAD             R2 -> COMM TASK FRR IEAVMFRR     00213000
         DROP  R2                                                       00214000
*   REGRECOV=ESTAELST;              /* MOVE ESTAE PARM LIST TO WORK     00215000
*                                      AREA                          */ 00216000
         MVC   REGRECOV(ESTAELEN),ESTAELST                              00217000
*   R1=ADDR(REGRECOV);              /* GET ADDR OF ESTAE PARM LIST      00218000
*                                      AREA                          */ 00219000
         LA    R1,REGRECOV                                              00220000
*                                                                       00221000
*   R8=ADDR(EPARM);                 /* PROVIDE ADDR OF ESTAE PARM       00222000
*                                      AREA                          */ 00223000
         LA    R10,EPARM                                                00224000
*                                   /* SET UP ESTAE ENVIRONMENT USING*/ 00225000
*                                   /* COMM TASK FRR FOR RECOVERY    */ 00226000
         ESTAE (R2),CT,PARAM=(R10),RECORD=YES,MF=(E,(1))                00227000
*                                                                       00228000
         USING PARMLIST,R10         /* SET ADDR TO ESTAE PARM AREA   */ 00229000
*                                                                       00230000
*        INITIALIZE ESTAE PARM AREA                                     00231000
*                                                                       00232000
*   PARMRGAD=ADDR(REGSAVE);         /* R6 -> REG RESTORE FLAGS       */ 00233000
         LA    R6,REGSAVE           /*       AND SAVE AREA           */ 00234000
         ST    R6,PARMRGAD                                              00235000
*   PARMID=MODULEID;                /* IDENTIFY MODULE TO FRR        */ 00236000
         MVC   PARMID,KCVWTO                                            00237000
*   REGRGMAP=ALLREGS;               /* RESTORE ALL REGS AT RETRY     */ 00238000
         MVC   REGRGMAP,KXFFFF                                          00239000
*                                   /* SAVE REGS FOR RETRY IF NEEDED */ 00240000
         STM   R0,R15,REGRECOV                                          00241000
*   PARMFTPT=FTVALCHK;              /* SET FOOT PRINT TO SHOW           00242000
*                                      WORKING ON CHECKING THE          00243000
*                                      VALIDITY OF THE USER'S WPL    */ 00244000
         MVI   PARMFTPT,X'01'                                           00245000
*   PARMRTAD=0;                     /* ZERO RETRY ADDR               */ 00246000
         XC    PARMRTAD,PARMRTAD                                        00247000
*/*******************************************************************   00248000
*/*                                                                     00249000
*/*      SET UP THE EXTENDED SAVEAREA IN THE SVRB                       00250000
*/*                                                                     00251000
*/*******************************************************************   00252000
*        INPUT -                                                        00253000
*        XVWPLADR -> WPL, USERS PARM LIST (R1)                          00254000
*        XVWQEID   = THE CONTENTS OF R0 MESSAGE NUMBER/CONSOLE ID       00255000
*        XVRET     = RETURN ADDR                                        00256000
*        R3 -> CVT                                                      00257000
*        R4 -> TCB                                                      00258000
*        R5 -> SVRB WHICH CONTAINS THE EXTENDED SAVEAREA                00259000
*        R7 -> ASCB                                                     00260000
*                                                                       00261000
*        OUTPUT -                                                       00262000
*        THE EXTENDED SAVE AREA IS INITIALIZED                          00263000
*        VARIOUS BITS OR SETTINGS IN THE PARM LIST NOW APPEAR IN XSA    00264000
*        R6 -> MESSAGE PART OF THE WPL                                  00265000
*        XVA8 CONTAINS THE TIME IN DECIMAL FORMAT AS HHMMSSTH           00266000
*                                                                       00267000
*        THE MESSAGE LENGTH IS SAVED FOR INTEGRITY REASONS              00268000
*        THE LENGTH IS USED TO COMPUTE THE LENGTH OF THE PARM LIST      00269000
*        BY SAVING THE LENGTH, THE USER CANNOT CHANGE THE               00270000
*        LENGTH AFTER THE VALIDITY OF THE PARM LIST HAS BEEN CHECKED    00271000
*        LIST                                                           00272000
*                                                                       00273000
*/*******************************************************************   00274000
*                                                                       00275000
*/********************************************************************/ 00276000
*                                                                       00277000
*        DETERMINE IF THE CALLER IS AUTHORIZED                          00278000
*        DETERMINE IF THE CALLER IS A PROBLEM PROGRAM                   00279000
*        THIS INFO IS USED TO SELECT THE PROPER MESSAGE FLAGGING        00280000
*        AND ERROR RECOVERY PROCEDURES                                  00281000
*                                                                       00282000
*/********************************************************************/ 00283000
         TESTAUTH  STATE=YES,KEY=YES                                    00284000
*   IF R15^=0 THEN                  /* USER NOT STATE OR KEY            00285000
*                                      AUTHORIZED ?                  */ 00286000
         LTR   R15,R15                                                  00287000
         BZ    @RF00171                                                 00288000
*     DO;                           /* YES, THE USER IS A PROBLEM       00289000
*                                      PROGRAM                       */ 00290000
*       XVD1PP='1'B;                /* TURN ON PROBLEM PROGRAM BIT      00291000
*                                      IN XSA                        */ 00292000
         OI    XVD1,XVD1PP                                              00293000
*                                   /* CHECK IF APF AUTHORIZED       */ 00294000
         TESTAUTH FCTN=1                                                00295000
*       IF R15=0 THEN               /* USER APF AUTHORIZED ?         */ 00296000
         LTR   R15,R15                                                  00297000
         BNZ   @RC00174             /* NO, DO NOTHING                */ 00298000
*         XVD1AUTH='1'B;            /* YES, TURN ON AUTHORIZED BIT IN   00299000
*                                      XSA                           */ 00300000
@RF00171 OI    XVD1,XVD1AUTH                                            00301000
*                                                                       00302000
*/********************************************************************/ 00303000
*                                                                       00304000
*        CHECK IF USER IS A PRIVILEGED TASK                             00305000
*        A PRIVILEGED USER IS -                                         00306000
*        A. THE COMMUNICATIONS TASK                                     00307000
*        B. ANY TASK RUNNING UNDER AN SIRB                              00308000
*        C. A DAUGHTER TASK OF THE COMMUNICATIONS TASK                  00309000
*        D. AN AUTHORIZED SUBSYSTEM SUCH AS JES3                        00310000
*        A PRIVILEGED USER MAY PUT OUT A WTO ANY TIME                   00311000
*        IT DOES NOT HAVE TO WAIT FOR SPACE IF ALL THE WQES ARE         00312000
*        TAKEN. FIRST CHECK IF THE USER IS COMMTASK                     00313000
*                                                                       00314000
*        NOTE -                                                         00315000
*        THE SPECIAL CHECK FOR A DAUGHTER TASK IS ADDED TO PERMIT       00316000
*        TASK ATTACHED BY THE COMMUNICATIONS TASK TO EXCEED THE         00317000
*        WQE LIMITS IF NECESSARY                                        00318000
*                                                                       00319000
*/********************************************************************/ 00320000
*                                                                       00321000
*   IF ASCBASID=UCMCTID&            /* IN THE COMTASK'S MEMORY ?     */ 00322000
*       R4=UCMPXA                   /* AND COMTASK'S TCB             */ 00323000
*       UCMPXA=TCBOTC THEN          /* OR DAUGHTER TASK              */ 00324000
@RC00174 L     R15,CVTCUCB                                              00325000
         USING UCM,R15                                                  00326000
         CLC   ASCBASID,UCMCTID        COMPARE CURRENT ASID WITH        00327000
         BNE   @GL00001                COMTASK ASIB                     00328000
         C     R4,UCMPXA               COMPARE CURRENT TCB WITH         00329000
         BE    @RT00184                COMTASK TCB                      00330000
@GL00001 CLC   UCMPXA,TCBOTC           COMPARE COMTASK TCB WITH         00331000
         BNE   @RF00184                PARENT OF CURRENT TCB            00332000
         DROP  R15                                                      00333000
*     XVD1PRIV='1'B;                /* YES, THEN INDICATE A             00334000
*                                      PRIVILEGED TASK               */ 00335000
@RT00184 OI    XVD1,XVD1PRIV                                            00336000
         B     @RC00184                                                 00337000
*                                                                       00338000
*   ELSE                            /* NO, CHECK IF THIS RB IS AN       00339000
*                                      SIRB                          */ 00340000
*     DO;                           /* IS THE USER'S RB AN SIRB         00341000
*/********************************************************************/ 00342000
*                                                                       00343000
*        IF THE TASK IS NOT RUNNING IN SIRB MODE, THEN CHECK IF         00344000
*        SVC 35 WAS ENTERED TO ISSUE A LOG MESSAGE, OR SUBSYSTEM        00345000
*                                                                       00346000
*/********************************************************************/ 00347000
*       IF RBLINK->RBFTP='100'B TCBTID='F8'X THEN                       00348000
@RF00184 L     R15,RBLINK                                               00349000
         TM    RBSTAB1-RBBASIC(R15),RBFTSIRB                            00350000
         BNO   @GL00003                                                 00351000
         TM    RBSTAB1-RBBASIC(R15),RBFTTIRB                            00352000
         BZ    @RT00187                                                 00353000
@GL00003 CLI   TCBTID,TCBLOGID         LOG TASK ?                       00354000
         BNE   @RF00187                                                 00355000
*         XVD1PRIV='1'B;            /* YES, INDICATE A PRIVILEGED       00356000
*                                      TASK                          */ 00357000
@RT00187 OI    XVD1,XVD1PRIV                                            00358000
         B     @RC00184                                                 00359000
*                                                                       00360000
*       ELSE                                                            00361000
*         IF UCMJES3T=R7 THEN       /* IF SUBSYSTEM ISSUED WTO       */ 00362000
@RF00187 L     R15,CVTCUCB                                              00363000
         USING UCM,R15                                                  00364000
         C     R7,UCMJES3T                                              00365000
         BNE   IEA00152                                                 00366000
*           XVD1PRIV='1'B;          /* SET PRIVILEGED BIT            */ 00367000
         OI    XVD1,XVD1PRIV                                            00368000
         B     @RC00184                                                 00369000
*                                                                       00370000
*     END;                                                              00371000
*     END;                                                              00372000
IEA00152 LH    R8,UCMWQNR              R8 = CURRENT WQE COUNT           00373000
         CH    R8,UCMWQLM              COMPARE TO WQE BUFFER LIMIT      00374000
         BL    @RC00184                LESS THAN LIMIT, BRANCH          00375000
         L     R2,RBLINK               R2 -> PREVIOUS RB                00376000
         LA    R2,0(,R2)               CLEAR HI-ORDER BYTE              00377000
         B     IEA00178                                                 00378000
*                                                                       00379000
         DROP  R15                                                      00380000
IEA0016E L     R15,RBLINK-RBBASIC(,R2)                                  00381000
         LA    R2,0(,R15)              ZERO HI-ORDER BYTE               00382000
IEA00178 TM    RBSTAB1-RBBASIC(R2),RBFTIRB  IRB ?                       00383000
         BNO   IEA00188                                                 00384000
         TM    RBSTAB1-RBBASIC(R2),RBFTSIRB+RBFTTIRB-RBFTIRB            00385000
         BZ    IEA0018E                                                 00386000
IEA00188 CR    R2,R4                                                    00387000
         BNE   IEA0016E                                                 00388000
IEA0018E CR    R2,R4                                                    00389000
         BE    @RC00184                                                 00390000
*     XVD1PRIV='1'B;                /* THEN USER IS PRIVILEGED TASK  */ 00391000
         OI    XVD1,XVD1PRIV                                            00392000
*/********************************************************************/ 00393000
*/*                                                                  */ 00394000
*/*  RECORD THE TIME AND SAVE IT IN XVA8                             */ 00395000
*/*                                                                  */ 00396000
*/********************************************************************/ 00397000
*                                   /* SAVE THE REGS AT THIS POINT IN*/ 00398000
*                                   /* CASE THERE IS AN ERROR IN TIME*/ 00399000
*                                   /* SVC                           */ 00400000
@RC00184 STM   R0,R15,REGRECOV                                          00401000
*   PARMFTPT=FTTIME;                /* TIME WAS TAKEN                */ 00402000
         MVI   PARMFTPT,X'02'                                           00403000
*   PARMRTAD=ADDR(TIMERET);                                             00404000
         LA    R8,TIMERET                                               00405000
         ST    R8,PARMRTAD                                              00406000
*                                   /* TAKE THE TIME                 */ 00407000
         TIME  DEC,ERRET=TIMERET                                        00408000
*   XVA8=R0;                        /* SAVE THE TIME IN XVSAV AREA   */ 00409000
         ST    R0,XVA8                                                  00410000
*TIMERET:                           /* IF ERROR IN TIME THEN DONT       00411000
*                                      STORE R0                      */ 00412000
*   PARMFTPT=FTVALCHK;              /* RESUME CHECK OF WPL           */ 00413000
TIMERET  MVI   PARMFTPT,X'01'                                           00414000
*   PARMRTAD=0;                     /* ZERO RETRY ADDR               */ 00415000
         XC    PARMRTAD,PARMRTAD                                        00416000
         NI    PFLAG,255-NOCMSLOK      TURN OFF NO CMS LOCK REQUESTED   00417000
         OI    XVD2,XVD2VALD           SET ON THE DEFAULT OF THE        00418000
*                                      WPL BEING VALID                  00419000
*/********************************************************************/ 00420000
*/*                                                                  */ 00421000
*/*      SETUP ENVIRONMENT FOR PROCESSING THE WPL                    */ 00422000
*/*                                                                  */ 00423000
*/********************************************************************/ 00424000
*                                                                       00425000
*        OBTAIN THE LOCKS FOR BOTH AUTHORIZED AND                       00426000
*        NON AUTHORIZED CALLERS TO ALLOW FOR A BRANCH ENTRY             00427000
*        TO GETMAIN TO OBTAIN A STORAGE AREA FOR A LARGE                00428000
*        ML-WTO WPL OR XWPL                                             00429000
*                                                                       00430000
*               IF XVD1AUTH='0'B THEN/* CALLER AUTHORIZED ?          */ 00431000
*        TM    XVD1,XVD1AUTH                                            00432000
*        NOP   IEA001F4                YES, BRANCH                      00433000
         OI    PFLAG,NOCMSLOK          TURN ON NO CMS LOCK REQUESTED    00434000
*                                                                       00435000
*        OBTAIN THE LOCAL AND CMS LOCK                                  00436000
*        INSTALL AN FRR                                                 00437000
*        THE FRR HAS CREATED ITS OWN PARMLIST                           00438000
*        NOTE - NO RETRY ADDR IS PROVIDED IN THE FRR PARMLIST           00439000
*                                                                       00440000
         BAL   R14,SETLOCK                                              00441000
         NI    PFLAG,255-NOCMSLOK      TURN OFF NO CMS LOCK REQUESTED   00442000
*                                                                       00443000
*        PRIOR TO ACESSING THE CALLERS WPL/XWPL SETUP THE ESTAE         00444000
*        EXIT ROUTINE TO CATCH AND IDENTIFY ANY ERRORS IF THE           00445000
*        WPL/XWPL IS NOT ADDRESSABLE BY THE CALLER.                     00446000
*                                                                       00447000
*        ROUTINE VWTOVALR IS SET AS THE PARMLIST RETRY ADDR.            00448000
*        THE NO DUMP OPTION IS TURNED ON IN THE FRR PARMLIST            00449000
*        AS ANY ERROR IN ACCESSING OR PROCESSING THE WPL PROVIDED       00450000
*        BY THE CALLER IS NOT A SYSTEM ERROR BUT A USER ERROR           00451000
*        AND WILL BE REFLECTED TO THE CALLER WITH A D23 ABEND           00452000
*        WITH A REASON CODE IN R15                                      00453000
*                                                                       00454000
IEA001F4 STM   R0,R15,REGRECOV                                          00455000
         LA    R15,VWTOVALR            R15 -> WPL ERROR ROUTINE         00456000
         ST    R15,PARMRTAD            SAVE ADDR OF RTN IN FRR PARMLIST 00457000
         OI    PARMFLAG,PARMNDMP       SUPRESS DUMPS                    00458000
         MVI   PARMFTPT,X'01'       /* CHECKING OF WPL               */ 00459000
*                                                                       00460000
*                                   /* USE R6 TO POINT AT PARTS OF      00461000
*                                      PARM LIST                     */ 00462000
*                                   /* R6 IS BASE FOR WPL            */ 00463000
*   R6=XVWPLADR;                    /* PICK UP ADDR OF PARM LIST     */ 00464000
         L     R6,XVWPLADR             R6 = CALLERS R1 -> WPL/XWPL      00465000
         USING WPLRF,R6                                                 00466000
*                                                                       00467000
*        CHANGE TO USERS KEY PRIOR TO ACCESSING THE WPL/XWPL            00468000
*                                                                       00469000
         MODESET EXTKEY=RBT234,WORKREG=15                               00470000
*                                                                       00471000
*********************************************************************** 00472000
*                                                                       00473000
*        DETERMINE THE FORMAT OF THE PARAMETER LIST                     00474000
*        THERE ARE A NUMBER OF WTO AND WTOR WPL/XWPL PARAMETER LISTS    00475000
*        FOR WTO THERE ARE -                                            00476000
*        1. STANDARD 370 WTO WPL                                        00477000
*        2. EXTENDED WPL VERSION 1                                      00478000
*        3. EXTENDED WPL VERSION 2 (SUPPORT FOR TEXT= PARAMETER)        00479000
*        FOR WTOR THERE ARE -                                           00480000
*        1. STANDARD 370 WTOR WPL                                       00481000
*        2. 31 BIT WTOR WPL                                             00482000
*        3. EXTENDED WPL VERSION 1                                      00483000
*        4. EXTENDED WPL VERSION 2 (SUPPORT FOR TEXT= PARAMETER)        00484000
*                                                                       00485000
*        A CHECK IS MADE BY CHECKING THE WPLRLN (THE WTOR REPLY         00486000
*        LENGTH) FOR ZERO. IF THE WPL IS FOR A WTOR THEN WPLRLN         00487000
*        WILL BE THE FIRST BYTE IN THE PARM LIST. WPLRLN MUST           00488000
*        ALWAYS BE NON ZERO IF THE WPL IS FOR A WTOR A NON ZERO         00489000
*        VALUE DETERMINES THAT THE WPL IS A WTOR REQUEST. IF THE        00490000
*        HI-ORDER BIT IS ON THEN WPL IS A WTOR 31 BIT WPL. IF THE       00491000
*        WPL IS FOR A WTO THEN THERE WILL BE NO WTO PREFIX AND          00492000
*        WPLLGH WILL BE THE FIRST 2 BYTES. THE TEXT HAS A MAX           00493000
*        LENGTH OF 125 BYTES SO THE FIRST BYTE OF WPLLGH WILL BE        00494000
*        ZERO. AN EXTENDED WPL (XWPL) FOR EITHER A WTO OR A WTOR        00495000
*        IS INDICATED BY AN MCS FLAG. NO FLAGS CAN BE SET IN            00496000
*        IEAVVWTO STORAGE AT THIS STAGE BECAUSE THE KEY IS SET TO       00497000
*        THE CALLERS KEY TO ENSURE THE CALLER HAS VALID ACCESS TO       00498000
*        THE CALLER PROVIDED WPL/XWPL.                                  00499000
*                                                                       00500000
*********************************************************************** 00501000
*                                                                       00502000
         ICM   R15,B'0001',WPLLGH      REFERENCE FIRST CHAR IN WPL/XWPL 00503000
         BZ    VALWPL01                ZERO, WTO WPL/XWPL OR WTOR XWPL  00504000
*                                                                       00505000
*        WTOR 24/31 BIT WPL PROCESSING                                  00506000
*                                                                       00507000
         LM    R14,R0,WPLRPTR          VALIDATE CALLER ACCESS TO -      00508000
*                                      REPLY ADDRESS                    00509000
*                                      ECB ADDRESS                      00510000
*                                      L'TEXT AND MCS FLAGS             00511000
         LA    R6,8(,R6)               WTOR, SO INCR R6 PAST WTOR FLDS  00512000
         B     VALWPL03                                                 00513000
*                                                                       00514000
*        FIRST BYTE OF WPL/XWPL IS ZERO                                 00515000
*        DETERMINE IF THE PARAMETER LIST IS:-                           00516000
*        A. 24 BIT WTO  -OR-                                            00517000
*        B. XWPL (VERSION 1 OR VERSION 2) WTO OR WTOR                   00518000
*                                                                       00519000
VALWPL01 TM    WPLMCSF2,WPLMCSFL       XWPL PRESENT ?                   00520000
         BO    XWPL001                 YES, BRANCH, TEST FOR WTO/WTOR   00521000
*                                                                       00522000
*        PROCESS WPL FOR BOTH WTO AND WTOR                              00523000
*        R6 -> WPLLGH                                                   00524000
*                                                                       00525000
VALWPL03 ICM   R15,B'1111',0(R6)       VERIFY ACCESS TO WPL FIELDS      00526000
         LR    R8,R6                   TAKE A COPY OF -> WPL @ WPLLGH   00527000
*                                      IE AFTER THE WTOR FIELDS         00528000
         SLR   R15,R15                                                  00529000
         IC    R15,WPLLGH+1            PICK UP L'TEXT, IGNORE L'REPLY   00530000
*                                      WHICH MAY BE PRESENT IF WTOR 31  00531000
*                                                                       00532000
         AR    R8,R15                  ADD L'MSG TEXT + MCS FLAGS       00533000
*                                      R8 -> FIRST BYTE PAST MSG TEXT   00534000
         LR    R2,R8                   R2/R8-> FIRST BYTE PAST WPL TEXT 00535000
*                                                                       00536000
         TM    WPLMCSF,WPLMCSFA        DESCR/ROUTE CODES PRESENT ?      00537000
         BZ    IEA00244                NO, BRANCH                       00538000
         ICM   R15,B'1111',0(R8)       ATTEMPT TO ACCESS DESC/ROUTE FLD 00539000
         TM    WPLMCSF,WPLMCSFD        MSGTYP TYPE FIELD EXISTS ?       00540000
         BZ    IEA00244                NO, BRANCH                       00541000
*                                      MSGTYP CAUSES THE AUTOMATIC      00542000
*                                      GEN OF ROUTE AND DESC FIELDS     00543000
         ICM   R15,B'0011',4(R8)       VERIFY ACCESS TO MSGTYP FIELD    00544000
*                                                                       00545000
*        THE WPL FIELDS, TEXT LENGTH, MCS FLAGS, DESCRIPTOR AND         00546000
*        ROUTING CODES HAVE BEEN ACCESSED USING THE CALLERS KEY         00547000
*        FOR WTO/WTOR/WTOR31 FORMAT WPLS                                00548000
*                                                                       00549000
*        RETURN TO KEY ZERO TO COPY THESE FIELDS TO PROTECTED           00550000
*        STORAGE                                                        00551000
*                                                                       00552000
IEA00244 MODESET  EXTKEY=SUPR                                           00553000
*                                                                       00554000
         C     R6,XVWPLADR             WPL ADDR = CALLERS R1 VALUE ?    00555000
*                                      IE R6 NOT INCREMENTED OVER       00556000
*                                      WTOR FIELDS AT BEGINNING OF WPL  00557000
         BE    IEA00262                YES, PROCESS WTO                 00558000
*                                                                       00559000
*        PROCESS WTOR WPL                                               00560000
*                                                                       00561000
         OI    XVD2,XVD2WTOR           SET ON WTOR FLAG                 00562000
         LR    R0,R6                   SAVE CURRENT VALUE OF R6         00563000
         L     R6,XVWPLADR             R6 -> WTOR PREFIX                00564000
         MVC   WKARPBUF+1(3),WPLRPTRA  MOVE REPLY BUFFER ADDR           00565000
         MVC   WKAECBP,WPLRECB         MOVE ACROSS ECB ADDR             00566000
         MVC   WKARPYLN,WPLRLN         MOVE ACROSS L'REPLY              00567000
         TM    WPL31RRP,WPL31RFG       WTOR 31 BIT FORMAT ?             00568000
         LR    R6,R0                   YES, RESTORE R6                  00569000
         BZ    IEA00262                NO, BRANCH                       00570000
         MVC   WKARPYLN,WPL31RLN       MOVE ACROSS 31 BIT L'REPLY       00571000
*                                                                       00572000
*        COMMON WTO/WTOR PROCESSING                                     00573000
*                                                                       00574000
IEA00262 MVC   WKALGH+1(1),WPLLPTXT    SAVE L'MSG TEXT IN WKALGH        00575000
         MVC   WKAMCSF,WPLMCSF         COPY MCS FLAGS FROM WPL          00576000
*                                      THIS FIELD MAY BE ZERO FOR OLD   00577000
*                                      FORMAT (PRE MCS) WPL             00578000
*/********************************************************************/ 00579000
*                                                                       00580000
*        DETERMINE IF DESCRIPTOR AND ROUTE CODES WERE SPECIFIED         00581000
*        IN THE WPL                                                     00582000
*                                                                       00583000
*/********************************************************************/ 00584000
         TM    WKAMCSF,WPLMCSFA     /* DESC/ROUT SPECIFIED ?         */ 00585000
         BZ    IEA00288                NO, BRANCH, ALSO NO MSGTYPE      00586000
         MVC   WKADSC(4),0(R8)         YES,MOVE ACROSS DESC/ROUTE CODES 00587000
         LA    R2,4(,R2)               INCR FOR DESC/ROUTE FIELDS       00588000
*/********************************************************************/ 00589000
*                                                                       00590000
*        DETERMINE IF MSGTYP WAS SPECIFIED IN THE WPL                   00591000
*                                                                       00592000
*/********************************************************************/ 00593000
         TM    WKAMCSF,WPLMCSFD     /* MSGTYP FIELD SPECIFIED ?         00594000
         BZ    IEA00288                NO, BRANCH                       00595000
         MVC   WKAMSGTY,4(R8)          COPY THE MSGTYP FIELD FROM WPL   00596000
         LA    R2,2(,R2)               INCR PAST MSGTYP FIELD           00597000
IEA00288 TM    WKAMSGTY,WPLMSGTD       QID FIELD PROVIDED ?             00598000
         BNO   IEA002B8                NO, BRANCH                       00599000
         OI    XVD0,XVD0QID            YES, SET QID PROVIDED FLAG       00600000
*/********************************************************************/ 00601000
*                                                                       00602000
*        DETERMINE IF MULTI-LINE WTO/WTOR                               00603000
*                                                                       00604000
*/********************************************************************/ 00605000
IEA002B8 TM    WKAMCSF+1,WPLMCSFJ      MULTI-LINE WTO/WTOR ?            00606000
         BZ    IEA00348                NO, BRANCH TO COMMON PROCESSING  00607000
*                                          FOR WTO AND WTOR             00608000
         TM    XVD2,XVD2WTOR           YES, WTOR ?                      00609000
         BZ    IEA002E2                NO, BRANCH TO PROCESS MLWTO      00610000
         MVI   XVREASON,D23MLWTR       ERROR - MULTILINE WTOR SPECIFIED 00611000
         B     VWTOVALB                PROCESS ERROR                    00612000
*                                                                       00613000
*/********************************************************************/ 00614000
*                                                                       00615000
*        EXTENDED WPL VALIDATION                                        00616000
*                                                                       00617000
*/********************************************************************/ 00618000
*                                                                       00619000
*        DETERMINE THE FORMAT OF THE PARAMETER LIST FOR VALIDATION      00620000
*        THERE ARE 3 WTO/WTOR XWPL PARAMETER LISTS                      00621000
*        1. EXTENDED WPL VERSION 1                                      00622000
*        2. EXTENDED WPL VERSION 2 (SUPPORT FOR TEXT= PARAMETER)        00623000
*        3. EXTENDED WPL VERSION 4 ONWARDS(SUPPORT FOR TEXT= PARAMETER) 00624000
*                                                                       00625000
*        XWPL ACCESS VALIDATION USING THE CALLERS KEY                   00626000
*        ON ENTRY -                                                     00627000
*        R6 -> XWPL                                                     00628000
*                                                                       00629000
XWPL001  LR    R0,R6                   SAVE R6 -> XWPL                  00630000
         LH    R1,WPLLGH               R1 = L'MAJOR WQE TEXT + 4        00631000
         AR    R6,R1                   R6 -> FIRST BYTE PAST TEXT       00632000
*                                            (START OF XWPL FIELDS)     00633000
         LA    R15,92                  R15 = L'XWPL VERSION 1           00634000
         CLI   WPXVRSN,1               XWPL VERSION 1 ?                 00635000
         BE    XWPL002                 YES, BRANCH                      00636000
         IC    R15,WPXLNGTH            R15 = L'XWPL VER 2 AND ONWARDS   00637000
XWPL002  AR    R15,R1                  R15 = L'XWPL (TEXT + XWPL DATA)  00638000
         LR    R6,R0                   RESTORE R6 -> XWPL               00639000
         TM    WPLMCSF+1,WPLMCSFJ      MULTI-LINE WTO/WTOR ?            00640000
         BZ    XWPL002A                NO, BRANCH                       00641000
*                                                                       00642000
*        VALIDATE MULTI-LINE XWPL                                       00643000
*                                                                       00644000
         AR    R6,R15                  R6 -> MLWTO EXTENT HEADER        00645000
         LR    R2,R6                   R2 -> MLWTO EXTENT HEADER        00646000
         SLR   R1,R1                                                    00647000
         IC    R1,WPLLINES             R1 = TOTAL NUMBER OF LINES       00648000
         BCTR  R1,0                    R1 = NUMBER OF MINOR WQES        00649000
         LA    R6,4(,R6)               R6 -> WPLML MLWTO LINE ENTRY     00650000
         B     XWPL002B                                                 00651000
*                                                                       00652000
XWPL002C AH    R6,WPLML0               ADD L'LINE TO TOTAL IN R6        00653000
         BCTR  R1,0                    DECR MINOR WQE COUNT             00654000
XWPL002B LTR   R1,R1                   MORE MINOR WQES TO PROCESS ?     00655000
         BP    XWPL002C                LOOP TO PROCESS NEXT MINOR WQE   00656000
*                                                                       00657000
*        ALL MINOR WQES PROCESSED                                       00658000
*                                                                       00659000
         SR    R6,R2                   R6 = L'MLWTO MINOR WQE LINES     00660000
         LR    R3,R6                   R3 = L'MLWTO MINOR WQE LINES     00661000
         AR    R15,R6                  R15 = L'XWPL + ML WQE TEXT LINES 00662000
*                                      (TOTAL LENGTH OF XWPL)           00663000
*                                                                       00664000
*        VALIDATE CALLER ACCESS TO XWPL AND OPTIONAL MINOR WQES         00665000
*                                                                       00666000
XWPL002A LR    R14,R0                  R0 AND R14 -> XWPL               00667000
         LR    R1,R15                  R1 AND R15 = L'XWPL              00668000
         CLCL  R0,R14                  VALIDATE CALLER ACCESS TO XWPL   00669000
*                                      STAE EXIT WILL CATCH ANY         00670000
*                                      ATTEMPT TO ACCESS NON            00671000
*                                      ADDRESSABLE STORAGE              00672000
         L     R6,XVWPLADR             REFRESH R6 -> XWPL               00673000
         LR    R0,R6                   SAVE -> XWPL                     00674000
         AH    R6,WPLLGH               R6 -> XWPL FIELDS                00675000
         TM    WPXMCS2,WPXTXTAD        TEXT ADDR SPECIFIED ?            00676000
         LR    R6,R0                   RESTORE -> XWPL                  00677000
         BZ    XWPL003                 NO, BRANCH                       00678000
*                                                                       00679000
*        VALIDATE CALLER ACCESS TO THE STORAGE ADDRESSED BY TEXT= ADDR  00680000
*                                                                       00681000
         CLC   WPLLGH,KH8              L'TEXT = 8 ?                     00682000
         BNE   XWPLE06                 NO, ERROR                        00683000
         L     R14,WPLTXT              R14 -> L'MESSAGE TEXT            00684000
         LH    R15,0(,R14)             R15 = L'MESSAGE TEXT             00685000
         LA    R14,2(,R14)             R14 -> MESSAGE TEXT              00686000
         LR    R0,R14                  R0 -> MESSAGE TEXT               00687000
         LR    R1,R15                  R1 = L'MESSAGE TEXT              00688000
         CLCL  R0,R14                  VALIDATE CALLER ACCESS TO TEXT   00689000
*                                      STAE EXIT WILL CATCH ANY         00690000
*                                      ATTEMPT TO ACCESS NON            00691000
*                                      ACCESSABLE STORAGE               00692000
*        CHANGE TO KEY 0                                                00693000
*        COPY XWPL DATA TO PROTECTED STORAGE                            00694000
*                                                                       00695000
XWPL003  MODESET  EXTKEY=SUPR                                           00696000
*                                                                       00697000
*        COPY FIELDS FROM XWPL TO WORK AREA IN PROTECTED STORAGE        00698000
*                                                                       00699000
         MVC   WKAMCSF,WPLMCSF         MCS FLAGS                        00700000
         TM    WKAMCSF+1,WPLMCSFJ      MULTI-LINE WTO/WTOR ?            00701000
         BZ    XWPL003A                NO, BRANCH                       00702000
         ST    R2,MLWTOXH              R2 -> MLWTO EXTENT HEADER        00703000
         ST    R3,LENMWQE              R3 = L'OF ALL MINOR WQES         00704000
XWPL003A MVC   WKALGH,WPLLGH           L'MSG (8 IF XWPL V2 AND TEXT=)   00705000
         AH    R6,WKALGH               R6 -> FIRST BYTE PAST MSG TEXT   00706000
*                                      (XWPL FIELDS)                    00707000
         MVC   WKAVRSN,WPXVRSN         VERSION                          00708000
         MVC   WKARPYLN,WPXRPYLN       L'REPLY (WTOR ONLY)              00709000
         MVC   WKALNGTH,WPXLNGTH       L'XWPL (ZERO FOR V1)             00710000
         MVC   WKAMCSF1,WPXMCSF1       EXTENDED MCS FLAGS               00711000
         MVC   WKARPBUF,WPXRPBUF       REPLY BUFFER ADDR - WTOR ONLY    00712000
         MVC   WKAECBP,WPXECBP         REPLY ECB ADDRESS - WTOR ONLY    00713000
         MVC   WKADSC,WPXDESC          DESCRIPTOR CODES, 2 BYTES ONLY   00714000
         MVC   WKAROC,WPXROUT          ROUTING CODES, 2 BYTES ONLY      00715000
         MVC   WKAMSGTY,WPXMSGTY       MSGTYP FLAGS                     00716000
*                                                                       00717000
*        ADDITIONAL PROCESSING FOR XWPL WTOR                            00718000
*                                                                       00719000
         CLI   WKARPYLN,0              WTOR ?                           00720000
         BE    XWPL004A                NO, BRANCH                       00721000
         OI    XVD2,XVD2WTOR           YES, SET ON WTOR FLAG            00722000
         TM    WKAMCSF+1,WPLMCSFJ      MULTI-LINE WTOR ?                00723000
         BO    XWPLE02                 YES, ERROR                       00724000
         TM    XVWPLADR+3,X'03'        XWPL ON WORD BOUNDARY ?          00725000
         BNZ   XWPLE01                 NO, ERROR                        00726000
*                                                                       00727000
XWPL004A L     R6,XVWPLADR             R6 -> CALLERS PROVIDED WPL       00728000
         TM    WKAMCSF1+1,WPXTXTAD     TEXT ADDR SPECIFIED ?            00729000
         BZ    XWPL004                 NO, BRANCH                       00730000
*                                                                       00731000
*        PROCESS TEXT= PARAMETER                                        00732000
*                                                                       00733000
         L     R8,WPLTXT               R8 -> 2 BYTE L'TEXT FOLLOWED BY  00734000
*                                      THE TEXT                         00735000
         LH    R3,0(,R8)               R3 = L'MESSAGE TEXT              00736000
         LA    R3,4(,R3)               ADD 4 FOR COMPATIBILTY WITH      00737000
*                                      INLINE TEXT                      00738000
         STH   R3,WKALGH               SET THE CORRECT L'TEXT           00739000
         LA    R8,2(,R8)               R8 -> MESSAGE TEXT               00740000
         B     XWPL006                                                  00741000
*                                                                       00742000
*        PROCESS INLINE TEXT                                            00743000
*                                                                       00744000
XWPL004  LH    R3,WKALGH               R3 = L'TEXT +4                   00745000
         LA    R8,WPLTXT               R8 -> MESSAGE TEXT               00746000
*                                                                       00747000
*        COMMMON PROCESSING FOR INLINE AND TEXT= PARAMETERS             00748000
*                                                                       00749000
XWPL006  C     R3,LENMAXT              L'MAJOR WQE > MAX ALLOWED ?      00750000
         BNH   XWPL005                 NO, BRANCH                       00751000
         L     R3,LENMAXT              YES, SET LENGTH TO MAX ALLOWED   00752000
         STH   R3,WKALGH               STORE TRUNCATED VALUE            00753000
XWPL005  A     R3,LENMWQE              ADD L'MINOR WQES (IF ANY)        00754000
         C     R3,LENMAXT              EXCEED 129 ? MUST BE A ML-WTO    00755000
         BNH   XWPL007                 NO, BRANCH                       00756000
*                                                                       00757000
*        GETMAIN AREA FOR LONG TEXT FOR A MLWTO WPL FROM SUBPOOL 229    00758000
*                                                                       00759000
         ST    R3,LONGLEN              SAVE LENGTH OF LONG TEXT         00760000
         LR    R0,R3                                                    00761000
*                                                                       00762000
         GETMAIN RU,LV=(0),SP=229,BRANCH=YES                            00763000
*                                                                       00764000
         ST    R1,LONGTXT              STORE ADDR OF GETMAINED STORAGE  00765000
*                                      FOR LONG TXT                     00766000
         LR    R2,R1                   R2 -> LONG TEXT STORAGE          00767000
         B     XWPL008                                                  00768000
*                                                                       00769000
XWPL007  LA    R2,WKATEXT              R2 -> STANDARD TEXT AREA         00770000
*                                                                       00771000
*        R2 WILL EITHER POINT TO THE STANDARD TEXT AREA                 00772000
*        -OR-                                                           00773000
*        IF THAT IS NOT LONG ENOUGH THE GETMAINED STORAGE FOR AN        00774000
*        EXTENDED TEXT AREA                                             00775000
*                                                                       00776000
XWPL008  ST    R2,WKAADTXT             WKAADTXT -> TEXT FLD(S)          00777000
         MVC   0(R2,2),WKALGH          SET THE LENGTH                   00778000
         LA    R0,4(,R2)                                                00779000
         LH    R1,WKALGH                                                00780000
         S     R1,KF4                  R1 = ACTUAL L'TEXT               00781000
         LR    R15,R1                                                   00782000
         LR    R14,R8                                                   00783000
         MVCL  R0,R14                  MOVE MAJOR WQE TEXT FROM CALLER  00784000
*                                      WPL TO PROTECTED STORAGE         00785000
*                                      THIS MAY BE EITHER INLINE TEXT   00786000
*                                      OR TEXT POINTED TO BY THE        00787000
*                                      TEXT= PARAMETER                  00788000
         ICM   R1,B'1111',LENMWQE      R1 = L' MLWTO HDR + L'MINOR WQES 00789000
*                                      FROM ADDR OF LAST BYTE OF WPL    00790000
         BZ    XWPL009                 NO MINOR WQES, BRANCH            00791000
         L     R14,MLWTOXH             R14 -> MLWTO EXTENT HDR          00792000
         LR    R15,R1                                                   00793000
*                                                                       00794000
*        COPY CALLER PROVIDED MLWTO EXTENT HEADER AND MINOR WQES        00795000
*        TO PROTECTED STORAGE                                           00796000
*        THE MLWTO EXTENT HEADER AND MINOR WQES ARE NOW CONTIGOUS       00797000
*        TO MAJOR WQE MESSAGE TEXT                                      00798000
         MVCL  R0,R14                                                   00799000
*                                                                       00800000
*        COMPARE FIELDS IN USER PROVIDED WPL TO FIELDS PREVIOUSLY       00801000
*        BROUGHT INTO PROTECTED STORAGE TO DETERMINE IF THE             00802000
*        USER PROVIDED WPL HAS BEEN SUBSEQUENTLY MODIFIED               00803000
*                                                                       00804000
XWPL009  L     R3,CVTPTR               RESTORE R3 TO CVT ADDR           00805000
         L     R6,XVWPLADR             R6 -> CALLERS WPL                00806000
         TM    WKAMCSF1+1,WPXTXTAD     TEXT ADDR SPECIFIED ?            00807000
         BZ    XWPL009A                NO, BRANCH                       00808000
*                                                                       00809000
*        VALIDATE TEXT= TEXT                                            00810000
*                                                                       00811000
         CLC   WPLLGH,KH8              LENGTH CORRECT ?                 00812000
         BNE   XWPLE07                 NO, ERROR, LENGTH CHANGED        00813000
         L     R1,WPLTXT               R1 -> 2 BYTE L'TEXT FOLLOWED BY  00814000
*                                      THE TEXT                         00815000
         LH    R1,0(,R1)               R1 = L'TEXT                      00816000
         LA    R1,4(,R1)               ADD 4 FOR COMPATIBILTY WITH      00817000
*                                      INLINE TEXT                      00818000
         CH    R1,WKALGH               LENGTH REMAINS UNCHANGED ?       00819000
         BNE   XWPLE07                 NO, ERROR, XWPL CHANGED          00820000
         B     XWPL009B                                                 00821000
*                                                                       00822000
*        VALIDATE INLINE TEXT                                           00823000
*                                                                       00824000
XWPL009A CLC   WPLLGH,WKALGH           LENGTH REMAINS UNCHANGED ?       00825000
         BNE   XWPLE07                 NO, ERROR, XWPL CHANGED          00826000
XWPL009B CLC   WPLMCSF,WKAMCSF         MCS FLAGS MATCH ?                00827000
         BNE   XWPLE07                 NO, ERROR                        00828000
         AH    R6,WPLLGH               R6 -> XWPL FIELDS                00829000
         CLC   WKAMCSF1,WPXMCSF1       EXTENDED MCS FLAGS MATCH ?       00830000
         BNE   XWPLE07                 NO, ERROR                        00831000
         TM    XVD2,XVD2WTOR           ALREADY IDENTIFIED AS WTOR ?     00832000
         BO    XWPL010                 YES, BRANCH                      00833000
         CLI   WKARPYLN,0              WTO, WKARPYLN MUST BE ZERO       00834000
         BNE   XWPLE07                 NO, ERROR                        00835000
         B     XWPL011                 GO CHECK MSGTYP FIELD            00836000
*                                                                       00837000
XWPL010  CLI   WKARPYLN,0              WTOR, WKARPYLN NOT MUST BE ZERO  00838000
         BE    XWPLE07                 ZERO, ERROR                      00839000
         TM    WPXMCSF1,WPXWTOR        WTOR WITH XWPL PARAMETER LIST ?  00840000
         BZ    XWPLE07                 NO, ERROR                        00841000
XWPL011  CLC   WKAMSGTY,WPXMSGTY       MSGTYP FLAGS MATCH ?             00842000
         BNE   XWPLE07                 NO, ERROR                        00843000
         B     IEA004BE                YES, GOTO FINAL WPL ERROR CHECKS 00844000
*                                                                       00845000
*        ERROR EXIT OUT OF XWPL VALIDATION                              00846000
*        COMPLETE REASON CODE FIELD                                     00847000
*                                                                       00848000
XWPLE01  MVI   XVREASON,D23BNDY        WTOR PARMLIST NOT ON WORD BNDY   00849000
         B     XWPLEEE                                                  00850000
*                                                                       00851000
XWPLE02  MVI   XVREASON,D23MLWTR       ERROR - MULTILINE WTOR SPECIFIED 00852000
         B     XWPLEEE                                                  00853000
*                                                                       00854000
XWPLE06  MVI   XVREASON,D23LTXT        WTO/WTOR TEXT= AND WPLLGH ^=8    00855000
         B     XWPLEEE                                                  00856000
*                                                                       00857000
XWPLE07  MVI   XVREASON,D23CMOD        CALLER MODIFIED WPL              00858000
*                                                                       00859000
*        THE REASON CODE HAS BEEN COMPLETED FOR                         00860000
*        A VALIDITY CHECK FAILURE                                       00861000
*                                                                       00862000
XWPLEEE  B     VWTOVALB                BRANCH TO ERROR ROUTINE          00863000
*                                                                       00864000
*                                                                       00865000
*/********************************************************************/ 00866000
*                                                                       00867000
*        MULTI-LINE WTO PROCESSING                                      00868000
*                                                                       00869000
*/********************************************************************/ 00870000
*                                                                       00871000
*        R2 -> FIRST BYTE PAST DESC/ROUT/MSGTYP FIELDS                  00872000
*                                                                       00873000
IEA002E2 TM    XVD0,XVD0QID            QID PRESENT ?                    00874000
         BZ    IEA002EE                NO, BRANCH                       00875000
         LA    R2,2(,R2)               INCR OVER QID BYTES              00876000
*                                      R2 -> MLWTO EXTENSION HEADER     00877000
IEA002EE ST    R2,MLWTOXH              STORE ADDR OF MLWTO EXTENT HDR   00878000
*                                                                       00879000
*        CHANGE TO CALLERS KEY                                          00880000
*                                                                       00881000
         MODESET EXTKEY=RBT234,WORKREG=15                               00882000
*                                                                       00883000
*        PROCESS THE MLWTO EXTENSION HEADER                             00884000
*        LOOP THROUGH ALL THE MINOR WQES                                00885000
*        SUM THE LENGTH OF ALL THE MINOR WQES                           00886000
*        NOTE -                                                         00887000
*        THE NUMBER OF LINES IN THE WPL IS NOT CHECKED HERE             00888000
*        THIS IS DONE IN IEAVMWTO                                       00889000
*                                                                       00890000
         LR    R6,R2                   ADJUST WPLRF ADDR TO             00891000
*                                      -> MLWTO EXTENT HEADER           00892000
         SLR   R1,R1                                                    00893000
         IC    R1,WPLLINES             R1 = TOTAL NUMBER OF LINES       00894000
         BCTR  R1,0                    R1 = NUMBER OF MINOR WQES        00895000
         LA    R6,4(,R6)               R6 -> WPLML MLWTO LINE ENTRY     00896000
         B     IEA00330                                                 00897000
*                                                                       00898000
IEA00326 AH    R6,WPLML0               ADD L'LINE TO TOTAL IN R6        00899000
         BCTR  R1,0                    DECR MINOR WQE COUNT             00900000
IEA00330 LTR   R1,R1                   MORE MINOR WQES TO PROCESS ?     00901000
         BP    IEA00326                LOOP TO PROCESS NEXT MINOR WQE   00902000
         LR    R14,R6                  R14 -> LAST BYTE +1 OF WPL       00903000
         SR    R14,R2                  R14 = L'MLWTO EXTENSION          00904000
         LR    R2,R6                   R2 -> LAST BYTE +1 OF ENTIRE WPL 00905000
*                                                                       00906000
*        R2 -> END OF MLWTO WQE TEXT+1                                  00907000
*                                                                       00908000
*        CHANGE BACK TO SUPERVISOR KEY                                  00909000
*                                                                       00910000
         MODESET  EXTKEY=SUPR          CHANGE BACK TO SUPERVISOR KEY    00911000
*                                                                       00912000
         ST    R14,LENMWQE             SAVE L'MINOR WQES                00913000
*                                                                       00914000
*/********************************************************************/ 00915000
*                                                                       00916000
*        COMMON PROCESSING FOR WTO/WTOR AND MLWTO                       00917000
*        VALIDATE CALLER ACCESS TO WPL                                  00918000
*                                                                       00919000
*/********************************************************************/ 00920000
*                                                                       00921000
*        R2 -> LAST BYTE +1 OF ENTIRE WPL (WTO/WTOR/MLWTO)              00922000
*                                                                       00923000
IEA00348 L     R6,XVWPLADR             R6 -> WPL (WTO/WTOR/WTOR31)      00924000
         LR    R14,R6                  COPY WPL ADDR                    00925000
         LR    R3,R2                   R3 -> LAST BYTE +1 OF ENTIRE WPL 00926000
         SR    R3,R14                  SUBTRACT START OF WPL FROM END   00927000
*                                      R3 = L'WPL INCLUDING OPT FIELDS  00928000
*                                           AND MLWTO WQES IF PRESENT   00929000
         LR    R2,R14                  R2 AND R14 -> WPL                00930000
*                                                                       00931000
         MODESET EXTKEY=RBT234,WORKREG=15  CHANGE TO CALLERS KEY        00932000
*                                                                       00933000
         LR    R15,R3                  R3 = L'WPL INCLUDING OPT FIELDS  00934000
*                                           AND MLWTO WQES IF PRESENT   00935000
*                                      R2 = R14, SOURCE = TARGET        00936000
*                                                                       00937000
*        REFERENCE THE ENTIRE WPL TO ENSURE IT IS ADDRESSABLE BY        00938000
*        THE CALLER                                                     00939000
*                                                                       00940000
         CLCL  R2,R14                  VALIDATE CALLER ACCESS TO TEXT   00941000
*                                      STAE EXIT WILL CATCH ANY         00942000
*                                      ATTEMPT TO ACCESS NON            00943000
*                                      ADDRESSABLE STORAGE              00944000
*                                                                       00945000
*        TO PROCEED PAST THIS POINT THE ENTIRE WPL INCLUDING ANY        00946000
*        OPTIONAL MLWTO MINOR WQES ARE PROVEN TO BE ACCESSABLE BY       00947000
*        THE CALLER                                                     00948000
*VWTOCONT:                                                              00949000
VWTOCONT MODESET  EXTKEY=SUPR                                           00950000
*                                                                       00951000
         L     R3,CVTPTR               RESTORE CVT ADDR                 00952000
*       IF XVD2WTOR='1'B&           /* A VALID WTOR AND THE PARM        00953000
*                                      LIST ON A WORD BOUNDARY ?     */ 00954000
*           XVWPLADR//4^=0                                              00955000
*         THEN                                                          00956000
         TM    XVD2,XVD2WTOR           WTOR ?                           00957000
         BNO   @RF00231                NO, BRANCH                       00958000
         TM    XVWPLADR+3,X'03'        WORD BOUNDARY ?                  00959000
         BZ    @RF00231                YES, BRANCH                      00960000
*                                      NO, ERROR, NOT ON WORD BOUNDARY  00961000
         MVI   XVREASON,D23BNDY        WTOR WPL NOT ON WORD BOUNDARY    00962000
         B     VWTOVALB                                                 00963000
*                                                                       00964000
*     END;                          /* END OF CHECK OF PARM LIST     */ 00965000
*/******* END OF VALIDITY CHECK **************************************/ 00966000
*/********************************************************************/ 00967000
*/                                                                   */ 00968000
*/       THE WPL WAS CHECKED AND FOUND TO BE VALID                   */ 00969000
*/                                                                   */ 00970000
*/       COPY THE TEXT PROVIDED IN THE WPL, MAJOR WQE TEXT AND       */ 00971000
*/       MINOR WQE TEXT (IF A MLWTO) TO PROTECTED STORAGE.           */ 00972000
*/       IF THE STANDARD WKATEXT AREA IS NOT SUFFICIENTLY LONG       */ 00973000
*/       ENOUGH TO STORE THE COMBINED TEXT THEN GETMAIN AN AREA      */ 00974000
*/       SUFFICIENTLY LARGE ENOUGH TO STORE THE COMBINED TEXT IN     */ 00975000
*/       A CONTIGUOUS MANNER, MAJOR WQE TEXT FOLLOWED BY OPTIONAL    */ 00976000
*/       MULTIPLE MINOR WQE TEXT                                     */ 00977000
*/                                                                   */ 00978000
*/********************************************************************/ 00979000
*                                                                       00980000
*        ANY ERROR NOW DETECTED WILL RESULT IN AN FRR ABEND WITH DUMP   00981000
*                                                                       00982000
*       PARMRTAD=0;                 /* ZERO RETRY ADDR               */ 00983000
@RF00231 XC    PARMRTAD,PARMRTAD                                        00984000
*       PARMNDMP='0'B;              /* RESET DUMP INDICATOR          */ 00985000
         NI    PARMFLAG,255-PARMNDMP                                    00986000
         LH    R3,WKALGH               R3 = L'MAJOR WQE                 00987000
         C     R3,LENMAXT              L'MAJOR WQE > MAX ALLOWED ?      00988000
         BNH   @RFA0231                NO, BRANCH                       00989000
         L     R3,LENMAXT              YES, TRUNCATE LEN TO MAX ALLOWED 00990000
         STH   R3,WKALGH               SAVE THE L'TEXT                  00991000
@RFA0231 A     R3,LENMWQE              ADD L'MINOR WQES (IF ANY)        00992000
         C     R3,LENMAXT              EXCEED 129 ? MUST BE A ML-WTO    00993000
         BNH   IEA00412                NO, BRANCH                       00994000
*                                                                       00995000
*        GETMAIN AREA FOR LONG TEXT FOR A MLWTO WPL FROM SUBPOOL 229    00996000
*                                                                       00997000
         LR    R0,R3                                                    00998000
         ST    R3,LONGLEN              SAVE LENGTH OF LONG TEXT         00999000
*                                                                       01000000
         GETMAIN RU,LV=(0),SP=229,BRANCH=YES                            01001000
*                                                                       01002000
         ST    R1,LONGTXT              STORE ADDR OF GETMAINED STORAGE  01003000
*                                      FOR LONG TXT                     01004000
         LR    R2,R1                   R2 -> LONG TXT STORAGE           01005000
         B     IEA00416                                                 01006000
*                                                                       01007000
IEA00412 LA    R2,WKATEXT              R2 -> STANDARD TEXT AREA         01008000
*                                                                       01009000
*        R2 WILL EITHER POINT TO THE STANDARD TEXT AREA                 01010000
*        -OR-                                                           01011000
*        IF THAT IS NOT LONG ENOUGH THE GETMAINED STORAGE FOR AN        01012000
*        EXTENDED LENGTH TEXT AREA                                      01013000
*                                                                       01014000
IEA00416 ST    R2,WKAADTXT             WKAADTXT -> TEXT FLD(S)          01015000
         L     R14,XVWPLADR            R14 -> CALLERS PROVIDED WPL      01016000
         TM    XVD2,XVD2WTOR           WTOR WPL ?                       01017000
         BZ    IEAA0416                NO, BRANCH                       01018000
         LA    R14,8(,R14)             INCR PAST WTOR FIELDS            01019000
IEAA0416 LH    R15,WKALGH              R15 AND R3 = L'MAJOR WQE TEXT    01020000
         LR    R3,R15                                                   01021000
         MVCL  R2,R14                  MOVE MAJOR WQE TEXT FROM CALLER  01022000
*                                      WPL TO PROTECTED STORAGE         01023000
         ICM   R3,B'1111',LENMWQE      R3 = L' MLWTO HDR + L'MINOR WQES 01024000
*                                      FROM ADDR OF LAST BYTE OF WPL    01025000
         BZ    IEA00442                NO MINOR WQES, BRANCH            01026000
         L     R14,MLWTOXH             R14 -> MLWTO EXTENT HDR          01027000
         LR    R15,R3                                                   01028000
*                                                                       01029000
*        COPY CALLER PROVIDED MLWTO EXTENT HEADER AND MINOR WQES        01030000
*        TO PROTECTED STORAGE                                           01031000
*        THE MLWTO EXTENT HEADER AND MINOR WQES ARE NOW CONTIGUOUS      01032000
*        TO MAJOR WQE MESSAGE TEXT                                      01033000
         MVCL  R2,R14                                                   01034000
*                                                                       01035000
*        COMPARE FIELDS IN USER PROVIDED WPL TO FIELDS PREVIOUSLY       01036000
*        BROUGHT INTO PROTECTED STORAGE TO DETERMINE IF THE             01037000
*        USER PROVIDED WPL HAS BEEN SUBSEQUENTLY MODIFIED               01038000
*                                                                       01039000
IEA00442 L     R3,CVTPTR               RESTORE CVT ADDR                 01040000
         L     R6,XVWPLADR             R6 -> CALLERS WPL                01041000
         CLI   WPLRLN,0                FIRST BYTE OF WPL ZERO ?         01042000
         BE    IEA00462                YES, MUST BE WTO, BRANCH         01043000
         LA    R6,8(,R6)               WTOR, INCR PAST WTOR FIELDS      01044000
*                     IF XVD2WTOR='1'B THEN                             01045000
         TM    XVD2,XVD2WTOR           ALREADY IDENTIFIED AS WTOR ?     01046000
         BO    IEA0046E                YES, BRANCH                      01047000
         B     IEA00BAD                NO, BAD WPL                      01048000
*                                                                       01049000
*                     IF XVD2WTOR='1'B THEN                             01050000
IEA00462 TM    XVD2,XVD2WTOR           ALREADY IDENTIFIED AS WTOR ?     01051000
         BZ    IEA0046E                NO, BRANCH                       01052000
         B     IEA00BAD                YES, WPL BAD                     01053000
*                                                                       01054000
IEA0046E CLC   WPLLPTXT,WKALGH+1       L'MSG TEXT MATCH ?               01055000
         BNE   IEA00BAD                NO, BAD WPL                      01056000
         CLC   WPLMCSF,WKAMCSF         MCS FLAGS MATCH ?                01057000
         BNE   IEA00BAD                NO, BAD WPL                      01058000
*           IF WPLMCSFD='1'B THEN   /* MSGTYP SPECIFIED ?            */ 01059000
IEA0048A TM    WKAMCSF,WPLMCSFD     /* MSGTYP FIELD SPECIFIED ?         01060000
         BZ    IEA004BE                NO, BRANCH                       01061000
         CLC   4(2,R8),WKAMSGTY        YES, MSGTYPE FIELDS MATCH ?      01062000
         BE    IEA004BE                YES, WPL OK                      01063000
*                                                                       01064000
*        END OF WPL CHECKS                                              01065000
*                                                                       01066000
*        COMMON CODE FOR BAD WPL AND XWPL PROCESSING                    01067000
*                                                                       01068000
IEA00BAD MVI   XVREASON,D23CMOD        CALLER MODIFIED WPL              01069000
         B     VWTOVALB                                                 01070000
*                                                                       01071000
*        COMMON CODE FOR WPL AND XWPL PROCESSING                        01072000
*                                                                       01073000
*        FREE THE LOCKS OBTAINED FOR ALL CALLERS                        01074000
*                                                                       01075000
*               IF XVD1AUTH='0'B THEN/* CALLER AUTHORIZED ?             01076000
*        TM    XVD1,XVD1AUTH           AUTHORIZED ?                     01077000
*        BO    IEA004D2                YES, BRANCH                      01078000
IEA004BE OI    PFLAG,NOCMSLOK          TURN ON NO CMS LOCK REQUESTED    01079000
*                                                                       01080000
*        FREE THE LOCKS AND REMOVE THE FRR                              01081000
*        ORIGINAL ESTAE IS NOW IN PLACE                                 01082000
*                                                                       01083000
         BAL   R14,FREELOCK                                             01084000
         NI    PFLAG,255-NOCMSLOK      TURN OFF NO CMS LOCK REQUESTED   01085000
IEA004D2 EQU   *                                                        01086000
*                                                                       01087000
*   ELSE                            /* PARM LIST WAS VALID PROCESS IT*/ 01088000
*     DO;                                                               01089000
*/********************************************************************/ 01090000
*/*                                                                  */ 01091000
*/*  TAKE THE INSTALLATION EXIT                                      */ 01092000
*/*                                                                  */ 01093000
*/********************************************************************/ 01094000
*/*** START OF USEREXIT **********************************************/ 01095000
*/********************************************************************/ 01096000
*/*                                                                  */ 01097000
*/*   USEREXIT - SET UP AND TAKE INSTALLATION WTO EXIT               */ 01098000
*/*                                                                  */ 01099000
*/*  INPUT -                                                         */ 01100000
*/*    R2 -> LAST BYTE IN THE WQE                                    */ 01101000
*/*    R6 -> BEGINNING OF THE MESSAGE PART OF THE WPL                */ 01102000
*/*                                                                  */ 01103000
*/*  OUTPUT -                                                        */ 01104000
*/*    WKAROC AND WKADSC CONTAIN THE ROUTE AND DESCRIPTOR CODES      */ 01105000
*/*    BE USED IN THE WQE                                            */ 01106000
*/*    XVD2DELW IS ON IF THE MESSAGE IS NOT TO GO TO THE CONSOLE BUT */ 01107000
*/*    TO HARDCOPY ONLY.                                             */ 01108000
*/*                                                                  */ 01109000
*/********************************************************************/ 01110000
*/********************************************************************/ 01111000
*/*                                                                  */ 01112000
*/* CHECK THAT THIS IS NOT A CONNECTING MLWTO, CONNECTING MLWTOS DO  */ 01113000
*/* NOT GET SENT TO THE INSTALLATION EXIT UNLESS ISSUED              */ 01114000
*/* FROM A PROBLEM PROGRAM                                           */ 01115000
*/*                                                                  */ 01116000
*/* THE INSTALLATION USER EXIT WILL BE TAKEN FOR ANY OF              */ 01117000
*/* THESE THREE SITUATIONS:                                          */ 01118000
*/*                                                                  */ 01119000
*/*    1. THE WTO IS NOT A MULTI-LINE REQUEST                        */ 01120000
*/*         OR                                                       */ 01121000
*/*    2. THE MLWTO IS NOT A CONNECTING MLWTO REQUEST                */ 01122000
*/*         OR                                                       */ 01123000
*/*    3. THE CONNECTING MLWTO REQUEST IS ISSUED FROM A              */ 01124000
*/*           PROBLEM PROGRAM                                        */ 01125000
*/*                                                                  */ 01126000
*/* THE ONLY OTHER SITUATION IS IF A CONNECTING MLWTO IS             */ 01127000
*/* ISSUED FROM SUPERVISOR STATE                                     */ 01128000
*/*      FOR THIS CASE, DO NOT TAKE THE USER EXIT                    */ 01129000
*/*                                                                  */ 01130000
*/********************************************************************/ 01131000
*                                                                       01132000
*       IF WPLMCSFJ^='1'B           /* SITUATION 1. ABOVE            */ 01133000
*           XVWQEIDA=0              /* SITUATION 2. ABOVE            */ 01134000
*           XVD1PP='1'B THEN        /* SITUATION 3. ABOVE            */ 01135000
@RF00247 TM    WKAMCSF+1,WPLMCSFJ      MLWTO ?                          01136000
         BZ    @RT00250                NO, BRANCH                       01137000
         ICM   R15,B'0111',XVWQEIDA    YES, ANY MESSAGE ID PROVIDED ?   01138000
         BZ    @RT00250                NO, BRANCH                       01139000
         TM    XVD1,XVD1PP             PROBLEM PROGRAM ?                01140000
         BZ    @RF00250                NO, BRANCH                       01141000
*         DO;                       /* THIS IS NOT A CONNECTING         01142000
*                                      MLWTO UNLESS ISSUED FROM A       01143000
*                                      PROBLEM PROGRAM               */ 01144000
*/********************************************************************/ 01145000
*/*                                                                  */ 01146000
*/* CHECK IF WE SHOULD USE THE DEFAULTS FOR ROUTE & DESC CODES BY    */ 01147000
*/* CHECKING IF THIS IS AN OLD STYLE MESSAGE WHICH HAS NO MCS FLAGS  */ 01148000
*/*                                                                  */ 01149000
*/********************************************************************/ 01150000
*           IF WKAMCSF=0 THEN       /* ANY MCS FLAGS SET IN THE WPL ?*/ 01151000
@RT00250 ICM   R15,B'0011',WKAMCSF                                      01152000
         BNZ   @RF00264                YES, BRANCH                      01153000
*             DO;                   /* NO, USE DEFAULTS              */ 01154000
*               WKAROC=UCMOWTOR;    /* GET DEFAULT ROUTE CODES FROM     01155000
*                                      UCM                           */ 01156000
         L     R15,CVTCUCB                                              01157000
         S     R15,KF4                                                  01158000
         L     R15,0(,R15)              R10 -> UCM PREFIX               01159000
         USING UCMPRFX,R15                                              01160000
         MVC   WKAROC,UCMOWTOR          MOVE IN DEFAULT ROUTING CODES   01161000
         OI    WKAMCSF,WPLMCSFA      /* MARK R/D CODES PRESENT       */ 01162000
         DROP  R15                                                      01163000
*                                                                       01164000
*             END;                                                      01165000
*/********************************************************************/ 01166000
*/*                                                                  */ 01167000
*/* CHECK FOR AN INTERNAL MESSAGE (ONE THAT IS AUTHORIZED AND HAS ANY*/ 01168000
*/* MCSFLAGS(2-8) ON). IF IT IS AN INTERNAL MESSAGE THEN SKIP THE    */ 01169000
*/* INSTALLATION EXIT. CHECK ALSO THAT THE MSG LENGTH IS GREATER THAN*/ 01170000
*/* ZERO (THAT WKALGH > 4)                                           */ 01171000
*/*                                                                  */ 01172000
*/********************************************************************/ 01173000
*           IF^(XVD1AUTH='1'B&      /* DO WE NOT HAVE THE FOLLOWING:    01174000
*                                      (IS THE USER AUTHORIZED AND      01175000
*                                      ARE ANY SYSTEM RELATED           01176000
*                                      MCSFLAGS BITS TURNED ON (BITS    01177000
*                                      2 TO 8) ) AND THAT THE TEXT      01178000
*                                      LENGTH IS > FOUR              */ 01179000
*               WPLMCSF1(2:8)^='0000000'B)&WKALGH>4 THEN                01180000
*                                                                       01181000
@RF00264 TM    XVD1,XVD1AUTH           AUTHORIZED ?                     01182000
         AIF   (&TMVS805).U805A                                         01183000
         BZ    @GL00007                NO, BRANCH                       01184000
         AGO   .U805B                                                   01185000
.U805A   NOP   @GL00007                IGNORE AUTHORIZED STATUS         01186000
.U805B   ANOP                                                           01187000
         TM    WKAMCSF,255-WPLMCSFA    ANY SYSTEM RELATED MCS FLAGS ?   01188000
         AIF   (&TMVS805).U805C                                         01189000
         BNZ   @RF00250                YES, BRANCH                      01190000
         AGO   .U805D                                                   01191000
.U805C   NOP   @RF00250                IGNORE SYSTEM RELATED MCS FLAGS  01192000
.U805D   ANOP                                                           01193000
@GL00007 LH    R14,WKALGH              NO SYSTEM RELATED MCS FLAGS      01194000
         C     R14,KF4                 L'MCS + TEXT > 4                 01195000
         AIF   (&TMVS805).U805E                                         01196000
         BNH   @RF00250                NO, BRANCH                       01197000
         AGO   .U805F                                                   01198000
.U805E   NOP   @RF00250                IGNORE LENGTH CHECK              01199000
.U805F   ANOP                                                           01200000
*             DO;                   /* YES, THEN MESSAGE IS NOT A       01201000
*                                      SYSTEM INTERNALLY GENERATED      01202000
*                                      ONE. TAKE EXIT                */ 01203000
*               /*****************************************************/ 01204000
*               /*                                                   */ 01205000
*               /* FILL IN THS INSTALLATION EXIT'S PARAMETER LIST    */ 01206000
*               /* MOVE IN THE MESSAGE FROM THE WPL                  */ 01207000
*               /*                                                   */ 01208000
*               /*****************************************************/ 01209000
*               USERTEXT=WPLTXT(1:WKALGH-4);                            01210000
         MVI   USERTEXT,C' '                                            01211000
         MVC   USERTEXT+1(L'USERTEXT-1),USERTEXT                        01212000
         S     R14,KF5                 SUBTRACT 4 BYTES FOR L'TEXT      01213000
*                                      AND MCS FLAGS AND ONE FOR EX     01214000
         C     R14,KF127               EXCEED L'USERTEXT ? (128-1)      01215000
         BNH   @GL00008                                                 01216000
         L     R14,KF127               YES, TRUNCATE TEXT MOVE TO 128   01217000
@GL00008 L     R15,WKAADTXT                                             01218000
         EX    R14,@SM03493            MOVE WPL MAJOR WQE TEXT ONLY     01219000
*                                      TO USER EXIT TEXT                01220000
*                                      MVC   USERTEXT(0),4(R15)         01221000
*               USERDC=WKADSC;      /* PARM LIST FOR THE USER EXIT   */ 01222000
*               USERRC=WKAROC;      /* MOVE THE ROUTE/DESC CODES INTO*/ 01223000
         MVC   USERDC,WKADSC                                            01224000
         MVC   USERRC,WKAROC                                            01225000
*               /*****************************************************/ 01226000
*               /*                                                   */ 01227000
*               /* SET UP FOOT PRINT AROUND USER EXIT                */ 01228000
*               /*                                                   */ 01229000
*               /*****************************************************/ 01230000
*                                   /* SAVE CURRENT REGS         */     01231000
         STM   R0,R15,REGRECOV                                          01232000
*               PARMFTPT=FTUSERX;   /* INSTALLATION'S EXIT WAS CALLED*/ 01233000
         MVI   PARMFTPT,X'03'                                           01234000
*               PARMCLAD=0;         /* NO CLEAN UP ROUTINE           */ 01235000
         XC    PARMCLAD,PARMCLAD                                        01236000
*               PARMRTAD=0;         /* NO RETRY ADDR                 */ 01237000
         XC    PARMRTAD,PARMRTAD                                        01238000
*                                                                       01239000
*        /*****************************************************/        01240000
*        /*                                                   */        01241000
*        /* CALL INSTALLATION EXIT ROUTINE                    */        01242000
*        /*                                                   */        01243000
*        /*****************************************************/        01244000
*                                                                       01245000
*        CALL IEECVXIT(USERPARM);                                       01246000
*                                                                       01247000
*        THE IEECVXIT PROVIDED AS A COMPONENT OF THE BSPPILOT           01248000
*        USERMOD ZUM0003 CONTRIBUTED BY VOLKER BANDKE WILL              01249000
*        AUTOMATICALLY REPLY TO SELECTED WTOR MESSAGES. THE             01250000
*        CORRECT ORE FOR THE MESSAGE (AND HENCE THE REPLY NUMBER)       01251000
*        IS LOCATED BY THE IEECVXIT CODE BY COMPARING THE ECB           01252000
*        ADDRESS IN THE ORE WITH THAT PROVIDED IN THE CALLERS           01253000
*        WPL. THE CODE IN THE BSPPILOT IEECVXIT ASSUMES THAT R5         01254000
*        WILL POINT TO THE SVRB FOR SVC 35 AND THAT THE ADDRESS         01255000
*        OF THE WPL PASSED TO SVC 35 WILL BE LOCATED IN THE             01256000
*        SVRB+X'74'. THE ADDRESS OF THE ECB FOR A WTOR WILL BE          01257000
*        LOCATED AT AN OFFSET 4 BYTES INTO THE WPL. THIS IS NOT         01258000
*        CORRECT WITH THIS CODE. TO AVOID CHANGING THE IEECVXIT         01259000
*        USERMOD A DUMMY ECB WPL ADDRESS FIELD IS BUILT AND             01260000
*        PASSED VIA R5 TO THE USERMOD CODE                              01261000
*                                                                       01262000
         LR    R8,R5                   SAVE CORRECT SVRB ADDR           01263000
         LA    R15,WKAECBP-4           R15 -> FAKE WPL ADDR             01264000
         ST    R15,CVDAREA             SAVE FAKE WPL ADDR IN CVDAREA    01265000
         LA    R5,CVDAREA-X'74'        R5 -> WPL ADDR IN FAKE SVRB      01266000
*                                      PASS TO IEECVXIT CODE            01267000
         LA    R15,USERPARM                                             01268000
         ST    R15,PARMPTR                                              01269000
         L     R15,VIEECVXT                                             01270000
         LA    R1,PARMPTR                                               01271000
         BALR  R14,R15                                                  01272000
         LR    R5,R8                   RESTORE CORRECT SVRB ADDR        01273000
*               /*****************************************************/ 01274000
*               /*                                                   */ 01275000
*               /* RESTORE THE FOOTPRINTS AFTER THE EXIT ROUTINE     */ 01276000
*               /*                                                   */ 01277000
*               /*****************************************************/ 01278000
*               PARMFTPT=FTAFUX;                                        01279000
         MVI   PARMFTPT,X'04'                                           01280000
*/********************************************************************/ 01281000
*/*                                                                  */ 01282000
*/* CHECK IF THE ROUTE CODES WERE CHANGED                            */ 01283000
*/*                                                                  */ 01284000
*/********************************************************************/ 01285000
*               IF WKAROC^=         /* ROUTE CODES CHANGED ?         */ 01286000
*                   USERRC  THEN                                        01287000
         CLC   WKAROC,USERRC                                            01288000
         BE    @RF00282                NO, BRANCH                       01289000
*                 DO;               /* YES, PROCESS CHANGED ROUTE       01290000
*                                      CODES                         */ 01291000
*                   XVD2QFHC='1'B;  /* INDICATE MSG IS TO BE QUEUED     01292000
*                                      FOR HARD COPY                 */ 01293000
         OI    XVD2,XVD2QFHC                                            01294000
*/********************************************************************/ 01295000
*/*                                                                  */ 01296000
*/* CHECK IF ROUTE CODE WAS CHANGED TO ZERO, INDICATING THAT THIS    */ 01297000
*/*  MESSAGE SHOULDN'T GO TO THE CONSOLE                             */ 01298000
*/*                                                                  */ 01299000
*/********************************************************************/ 01300000
*                   IF USERRC=0 THEN                                    01301000
         ICM   R15,B'0011',USERRC                                       01302000
         BNZ   @RF00285                                                 01303000
*/********************************************************************/ 01304000
*/*                                                                  */ 01305000
*/* CHECK IF THIS IS A WTOR. IF SO THEN IGNORE REQUEST TO DELETE     */ 01306000
*/* MESSAGE (ZERO ROUTE CODE. IF WTO, DELETE MESSAGE. SEND JUST TO   */ 01307000
*/* HARDCOPY                                                         */ 01308000
*/*                                                                  */ 01309000
*/********************************************************************/ 01310000
*                     IF XVD2WTOR='1'B THEN                             01311000
         TM    XVD2,XVD2WTOR                                            01312000
         BZ    @RF00286                                                 01313000
*                       DO;         /* PUT IN WTOR ROUTE CODES       */ 01314000
*                         /*******************************************/ 01315000
*                         /*                                         */ 01316000
*                         /* ROUTE WTOR TO MASTER CONSOLE            */ 01317000
*                         /*                                         */ 01318000
*                         /*******************************************/ 01319000
*                         WKAROC='8000'X;                               01320000
         MVC   WKAROC,KX8000                                            01321000
*                       WPLMCSFA='1'B;/* TURN ON ROUTE CODES PRESENT    01322000
*                                      FLAGS                         */ 01323000
         OI    WKAMCSF,WPLMCSFA                                         01324000
         B     @RF00282                                                 01325000
*                                                                       01326000
*                       END;                                            01327000
*                     ELSE          /* NOT A WTOR. INDICATE SEND MSG    01328000
*                                      TO HARDCOPY ONLY              */ 01329000
*                       XVD2DELW='1'B;                                  01330000
@RF00286 OI    XVD2,XVD2DELW                                            01331000
         B     @RF00282                                                 01332000
*                                                                       01333000
*/********************************************************************/ 01334000
*/*                                                                  */ 01335000
*/* NO, THE ROUTE CODE WASNT SET TO ZERO, BUT IT IS CHANGED. PICK    */ 01336000
*/* UP THE NEW ROUTE CODES FOR USE LATER IN BUILDING THE WQE         */ 01337000
*/* ALSO PASS THE NEW ROUTE CODES TO WTP IF ROUTE CODE 11 IS SET     */ 01338000
*/*                                                                  */ 01339000
*/********************************************************************/ 01340000
*                   ELSE                                                01341000
*                     WKAROC=USERRC ;/* MOVE NEW ROUTE CODES TO         01342000
*                                      WKAROC                        */ 01343000
*                 END;              /* END OF PROCESSING OF CHANGED     01344000
*                                      ROUTE CODES                   */ 01345000
@RF00285 MVC   WKAROC,USERRC                                            01346000
*               IF WKADSC^=USERDC THEN/* DESC CODE CHANGED ?        */  01347000
@RF00282 CLC   WKADSC,USERDC                                            01348000
         BE    @RF00250                NO, BRANCH                       01349000
*                 DO;               /* YES, SAVE DESC CODES          */ 01350000
*                   WKADSC=USERDC ; /* SAVE USER CHANGES             */ 01351000
         MVC   WKADSC,USERDC                                            01352000
*                   XVD2QFHC='1'B;  /* INDICATE HARDCOPY MSG         */ 01353000
         OI    XVD2,XVD2QFHC                                            01354000
*                 END;                                                  01355000
*             END;                  /* OF PROCESSING NON-INTERNAL       01356000
*                                      MSGS                          */ 01357000
*         END;                      /* OF PROCESSING NON-CONNENCTING    01358000
*                                      MSGS                          */ 01359000
*/********************************************************************/ 01360000
*/*                                                                  */ 01361000
*/* WKAROC AND WKADSC CONTAIN THE POSSIBLY UPDATED ROUTE AND         */ 01362000
*/* DESCRIPTOR CODES AND MSGTYP FIELD TO BE USED BY THIS MESSAGE     */ 01363000
*/*                                                                  */ 01364000
*/********************************************************************/ 01365000
*                                                                       01366000
*/***** END OF USER EXIT SEGMENT *************************************/ 01367000
*                                                                       01368000
*/********************************************************************/ 01369000
*/*                                                                  */ 01370000
*/*  DETERMINE IF A MULTI-LINE WTO WAS ISSUED. IF SO CALL IEAVMWTO   */ 01371000
*/*                                                                  */ 01372000
*/********************************************************************/ 01373000
*                                                                       01374000
*       IF WPLMCSFJ='1'B THEN       /* MULTI-LINE FLAG SET IN WPL ?  */ 01375000
@RF00250 TM    WKAMCSF+1,WPLMCSFJ      NO, BRANCH                       01376000
         BZ    @RF00303                                                 01377000
*         DO;                       /* YES, GO TO PROCESS MULTI-LINE */ 01378000
*           PARMFTPT=FTMLWTO;       /* START OF MLWTO PROCESSING     */ 01379000
         MVI   PARMFTPT,X'05'                                           01380000
*           PARMRTAD=0;             /* DON'T RETRY. MLWTO DETECTS THE   01381000
*                                      ERROR                         */ 01382000
         XC    PARMRTAD,PARMRTAD                                        01383000
*           CALL IEAVMWTO;          /* PROCESS MULTI-LINE WTO        */ 01384000
         L     R15,VIEAVMWT                                             01385000
         BALR  R14,R15                                                  01386000
*           PARMFTPT=FTSWTO;        /* START OF WTO BLOCK PROCESSING */ 01387000
         MVI   PARMFTPT,X'06'                                           01388000
         B     VWTOERRT                GOTO EXIT PROCESSING             01389000
*                                                                       01390000
*         END;                                                          01391000
*       ELSE                        /* NO, SINGLE LINE SPECIFIED     */ 01392000
*/********************************************************************/ 01393000
*/*                                                                  */ 01394000
*/* DETERMINE IF PARM LIST LENGTH IS LESS THAN OR EQUAL TO FOUR      */ 01395000
*/* IF SO THEN THE MSGLENGTH IS ZERO. THIS IS AN ABEND               */ 01396000
*/* SITUATION FOR WTORS                                              */ 01397000
*/*                                                                  */ 01398000
*/********************************************************************/ 01399000
*         IF WKALGH<=4 THEN         /* DOES LENGTH SHOW ZERO MSG        01400000
*                                      LENGTH ?                      */ 01401000
@RF00303 CLC   WKALGH,KH4                                               01402000
         BH    @RF00314                                                 01403000
*/********************************************************************/ 01404000
*/*                                                                  */ 01405000
*/* CHECK FOR WTOR. IF WTOR, THEN SET ABEND BIT. IF WTO, THEN SET    */ 01406000
*/* THE NO MESSAGE BIT ON (XVD2ZERO)                                 */ 01407000
*/*                                                                  */ 01408000
*/********************************************************************/ 01409000
*           IF XVD2WTOR='1'B THEN   /* WTOR REQUEST ?                */ 01410000
         TM    XVD2,XVD2WTOR                                            01411000
         BZ    @RF00315                NO, BRANCH                       01412000
*                                      YES, WTOR                        01413000
         MVI   XVREASON,D23ZERO        ZERO TEXT LENGTH WTOR            01414000
         B     VWTOVALB                                                 01415000
*                                                                       01416000
*           ELSE                    /* NO, INDICATE RETURN ZERO MSG     01417000
*                                      ID TO                         */ 01418000
*             XVD2ZERO='1'B;        /* THE USER                      */ 01419000
@RF00315 OI    XVD2,XVD2ZERO                                            01420000
         B     VWTOERRT                                                 01421000
*                                                                       01422000
*/********************************************************************/ 01423000
*/*                                                                  */ 01424000
*/* MESSAGE LENGTH WAS NOT ZERO. PROCESS GOOD MESSAGE                */ 01425000
*/*                                                                  */ 01426000
*/********************************************************************/ 01427000
*         ELSE                                                          01428000
*           DO;                                                         01429000
*/********************************************************************/ 01430000
*/*                                                                  */ 01431000
*/*      CHECK FOR WRITE TO PROGRAMMER (ROUTE CODE 11).              */ 01432000
*/*      IF WTP WAS SPECIFIED THEN CALL WTP. WTP WILL RETURN         */ 01433000
*/*      CONTROL TO VWTO. ON RETURN FROM WTP THE XVD0USER BIT        */ 01434000
*/*      WILL BE ON IF THE MESSAGE WAS A WTP MESSAGE ONLY.           */ 01435000
*/*      THIS MEANS THAT THERE IS NOTHING FOR VWTO TO DO.            */ 01436000
*/*                                                                  */ 01437000
*/********************************************************************/ 01438000
*             XVD0USER='0'B;        /* INSURE THAT RETURN BIT FROM      01439000
*                                      WTP IS SET TO INDICATE           01440000
*                                      CONTINUE PROCESSING           */ 01441000
@RF00314 NI    XVD0,255-XVD0USER                                        01442000
*             IF WPLMCSFA = '1'B &     /* ROUTE CODES SPECIFIED ?    */ 01443000
*                 WPLROUTK='1'B THEN/* AND WTP SPECIFIED             */ 01444000
         TM    WKAMCSF,WPLMCSFA        ROUTING AND DESC PROVIDED ?      01445000
         BZ    @RF00320                NO, BRANCH                       01446000
         TM    WKAROC+1,WPLROUTK       WTP ROUTCDE=11 ?                 01447000
         BZ    @RF00320                NO, BRANCH                       01448000
*               DO;                 /* YES, CALL WTP. WTP WILL RETURN   01449000
*                                      CONTROL AFTER PROCESSING      */ 01450000
*                 CALL IGC0203E;    /* CALL WTP (IGC0203E)           */ 01451000
         L     R15,VIGC0203                                             01452000
         BALR  R14,R15                                                  01453000
*               END;                                                    01454000
*             /*******************************************************/ 01455000
*             /*                                                     */ 01456000
*             /* CHECK IF WTP FOUND THAT THERE WAS NO MORE PROCESSING*/ 01457000
*             /* FOR US TO DO WITH THIS MESSAGE. IF SO SET XVD2ZERO  */ 01458000
*             /* ON SO THAT A ZERO MESSAGE ID GETS PASSED TO THE     */ 01459000
*             /* USER.                                               */ 01460000
*             /*                                                     */ 01461000
*             /*******************************************************/ 01462000
*             IF XVD0USER='1'B THEN /* DID RETURN TO USER BIT GET SET   01463000
*                                      BY THE WTP ROUTINE            */ 01464000
@RF00320 TM    XVD0,XVD0USER                                            01465000
         BZ    @RF00327                NO, BRANCH                       01466000
*               XVD2ZERO='1'B;      /* YES. INDICATE ZERO MSG ID TO     01467000
*                                      BE RETURNED TO CALLER AND SKIP   01468000
*                                      THE REST OF THE PROCESSING    */ 01469000
         OI    XVD2,XVD2ZERO                                            01470000
         B     VWTOERRT                SETUP FOR RETURN TO CALLER       01471000
*                                                                       01472000
*             ELSE                  /* NO, PROCESS THE MESSAGE       */ 01473000
*               DO;                                                     01474000
*/********************************************************************/ 01475000
*/*                                                                  */ 01476000
*/* SET UP NEEDED LOCKS AND FRR                                      */ 01477000
*/*                                                                  */ 01478000
*/********************************************************************/ 01479000
*                 CALL SETLOCK;                                         01480000
@RF00327 BAL   R14,SETLOCK                                              01481000
*                 /***************************************************/ 01482000
*                 /*                                                 */ 01483000
*                 /* SET UP THE FOOTPRINT TO COVER THE BUILDING OF   */ 01484000
*                 /* THE ORE AND THE WQES. IF THERE IS A PROBLEM THEN*/ 01485000
*                 /* VWTOCLNP WILL ATTEMPT TO CLEAN UP THE CONTROL   */ 01486000
*                 /* BLOCKS                                          */ 01487000
*                 /*                                                 */ 01488000
*                 /***************************************************/ 01489000
*                 PARMFTPT=FTCTLBLK;/* START OF CONTROL BLOCK           01490000
*                                      PROCESSING                    */ 01491000
         MVI   PARMFTPT,X'07'                                           01492000
*                 PARMCLAD=ADDR(VWTOCLNP);/* ADDRESS OF CLEAN UP        01493000
*                                      ROUTINE                       */ 01494000
         LA    R8,VWTOCLNP                                              01495000
         ST    R8,PARMCLAD             SAVE ADDR IN FRR/ESTAE PARMLIST  01496000
*/********************************************************************/ 01497000
*/*                                                                  */ 01498000
*/*      GET THE NEEDED CONTROL BLOCKS                               */ 01499000
*/*                                                                  */ 01500000
*/********************************************************************/ 01501000
*/*                                                                  */ 01502000
*/*   GETBLKS - GET AN ORE AND/OR A WQE                              */ 01503000
*/*                                                                  */ 01504000
*/*   INPUT - XVD2WTOR IF ON INDICATES A WQE AND AN ORE ARE NEEDED   */ 01505000
*/*           IF OFF THEN JUST A WQE IS NEEDED.                      */ 01506000
*/*           XVD1PRIV INDICATES WHETHER THIS USER IS A PRIVILEGED   */ 01507000
*/*           TASK                                                   */ 01508000
*/*                                                                  */ 01509000
*/*   OUTPUT - XVOREAD POINTS AT THE ZEROED ORE                      */ 01510000
*/*            XVWQEAD POINTS AT THE ZEROED WQE                      */ 01511000
*/*            XVD1PERR IS ON IF CORE WAS NOT AVAILABLE              */ 01512000
*/*                                                                  */ 01513000
*/********************************************************************/ 01514000
*/*                                                                  */ 01515000
*/*  TURN OFF DO LOOP AND ECB INDICATORS                             */ 01516000
*/*                                                                  */ 01517000
*/********************************************************************/ 01518000
*                 XVD1ALDN='0'B;    /* INIT TO NOT ALL DONE          */ 01519000
         NI    XVD1,255-XVD1ALDN                                        01520000
*                 XVD0WWB='0'B;     /* INDICATE NO WTO WAIT BLOCK       01521000
*                                      OBTAINED                      */ 01522000
         NI    XVD0,255-XVD0WWB                                         01523000
*/********************************************************************/ 01524000
*/*                                                                  */ 01525000
*/*  CHECK FOR A WTOR. IF SO INDICATE THAT AN ORE IS NEEDED FIRST    */ 01526000
*/*                                                                  */ 01527000
*/********************************************************************/ 01528000
*                 IF XVD2WTOR='1'B THEN/* IS THIS REQUEST A WTOR     */ 01529000
         TM    XVD2,XVD2WTOR                                            01530000
         BZ    @RF00335                NO, BRANCH                       01531000
*                   DO;             /* YES                           */ 01532000
*                     XVD0NORE='1'B;/* GET THE ORE FIRST             */ 01533000
*                     XVD0NWQE='0'B;/* THEN GET THE WQE              */ 01534000
         OI    XVD0,XVD0NORE                                            01535000
         NI    XVD0,255-XVD0NWQE                                        01536000
         B     @RC00335                                                 01537000
*                                                                       01538000
*                   END;                                                01539000
*                 ELSE              /* NO, THIS IS A WTO             */ 01540000
*                   DO;                                                 01541000
*                     XVD0NORE='0'B;/* WE DONT NEED AN ORE           */ 01542000
*                     XVD0NWQE='1'B;/* BUT WE DO NEED A WQE          */ 01543000
@RF00335 OI    XVD0,XVD0NWQE                                            01544000
         NI    XVD0,255-XVD0NORE                                        01545000
@RC00335 B     @DE00344                                                 01546000
*                                                                       01547000
*                   END;                                                01548000
*/********************************************************************/ 01549000
*/*                                                                  */ 01550000
*/*  WE WILL ATTEMPT TO GET A WQE OR AN ORE, A REPLY ID AND A WQE,   */ 01551000
*/*  WE WILL LOOP UNTIL ALL NEEDED BLOCKS HAVE BEEN OBTAINED.        */ 01552000
*/*                                                                  */ 01553000
*/********************************************************************/ 01554000
*                 DO WHILE(XVD1ALDN='0'B);/* LOOP UNTIL WE ARE DONE  */ 01555000
*/********************************************************************/ 01556000
*/*                                                                  */ 01557000
*/*  CHECK IF WE STILL NEED TO GET AN ORE. IF SO GET ONE             */ 01558000
*/*                                                                  */ 01559000
*/********************************************************************/ 01560000
*                                                                       01561000
*                   IF XVD0NORE='1'B THEN                               01562000
*                                                                       01563000
@DL00344 TM    XVD0,XVD0NORE                                            01564000
         BZ    @RF00345                                                 01565000
*/********************************************************************/ 01566000
*/*                                                                  */ 01567000
*/*  CHECK IF AN ORE IS AVAILABLE                                    */ 01568000
*/*                                                                  */ 01569000
*/********************************************************************/ 01570000
*                     IF UCMRQNR<UCMRQLM /* IS THE NUMBER ORES LESS     01571000
*                                      THAN LIMIT                    */ 01572000
*                         XVD1PRIV='1'B THEN/* OR IS THE USER A         01573000
*                                      PRIVILEGED TASK               */ 01574000
         L     R15,CVTCUCB                                              01575000
         USING UCM,R15                                                  01576000
         LH    R8,UCMRQNR                                               01577000
         SLR   R2,R2                                                    01578000
         IC    R2,UCMRQLM                                               01579000
         CR    R8,R2                                                    01580000
         BL    @RT00346                                                 01581000
         TM    XVD1,XVD1PRIV           PRIVILIGED ?                     01582000
         BZ    @RF00346                NO, BRANCH                       01583000
*                       DO;         /* YES, GET AN ORE AND ID        */ 01584000
*                         CALL VWTOGETB(2);/* GET AN ORE AND ZERO IT */ 01585000
@RT00346 LA    R1,@AL00348                                              01586000
         BAL   R14,VWTOGETB                                             01587000
*/********************************************************************/ 01588000
*/*                                                                  */ 01589000
*/* CHECK TO SEE IF WE SUCCESSFULLY GOT AN ORE. IF NOT THEN SET      */ 01590000
*/* THE ERROR FLAG AND SET OTHER FLAGS SO THAT WE GET OUT OF         */ 01591000
*/* GET CONTROL BLOCKS LOOP.                                         */ 01592000
*/*                                                                  */ 01593000
*/********************************************************************/ 01594000
*                         IF XVOREAD=1 THEN/* WAS ERROR CONDITION SET   01595000
*                                      BY VWTOGETB                   */ 01596000
         CLC   XVOREAD,KF1                                              01597000
         BNE   @RF00349                                                 01598000
*                           DO;     /* YES. SET FLAGS TO GET OUT OF     01599000
*                                      LOOP                          */ 01600000
*                             XVD1ALDN='1'B;/* INDICATE THAT LOOP IS    01601000
*                                      OVER                          */ 01602000
*                             XVD1PERR='1'B;/* INDICATE AN ERROR        01603000
*                                      CONDITION FOUND               */ 01604000
         OI    XVD1,XVD1ALDN+XVD1PERR                                   01605000
*                             XVD0RPFD='1'B;/* SET SO THAT WE SKIP TO   01606000
*                                      THE WQE TEST AND THEN OUT     */ 01607000
         OI    XVD0,XVD0RPFD                                            01608000
         B     @RC00349                                                 01609000
*                                                                       01610000
*                           END;                                        01611000
*                         ELSE      /* AN ORE WAS OBTAINED. GET AN ID*/ 01612000
*                           DO;                                         01613000
*/********************************************************************/ 01614000
*/*  GETID - GET A REPLY ID SEGMENT                                  */ 01615000
*/*                                                                  */ 01616000
*/*  FUNCTION - TO OBTAIN ONE OF THE 100 REPLY IDS AND INSERT THE    */ 01617000
*/*     ID IN THE ORE.                                               */ 01618000
*/*                                                                  */ 01619000
*/*  INPUT - XVOREAD -> ORE                                          */ 01620000
*/*          UCMRPYL CONTAINS THE NEXT REPLY ID IN UCMRPYI TO TRY    */ 01621000
*/*          UCMRPYI IS THE BIT MAP OF AVAILABLE IDS                 */ 01622000
*/*                                                                  */ 01623000
*/*  OUTPUT - XVD0RPFD IS ON IF ID WAS STORED IN THE ORE             */ 01624000
*/*           XVD0RPFD IS OFF IF ID WAS NOT AVAILABLE                */ 01625000
*/*                                                                  */ 01626000
*/********************************************************************/ 01627000
*                             XVD0RPFD='0'B;/* DON'T TURN REPLY FOUND   01628000
*                                      ON UNTIL ID IS AVAILABLE      */ 01629000
@RF00349 NI    XVD0,255-XVD0RPFD                                        01630000
*                             STARTID=UCMRPYL;/* INIT THE STARTING ID*/ 01631000
         L     R15,CVTCUCB                                              01632000
         L     R15,UCMLSTP                                              01633000
         DROP  R15                                                      01634000
         USING UCMEIL,R15                                               01635000
         MVC   STARTID,UCMRPYL                                          01636000
         DROP  R15                                                      01637000
*                             DO UNTIL(XVD0RPFD='1'B /* DO UNTIL AN     01638000
*                                      ID IS FOUND                   */ 01639000
*                                   UCMRPYL=STARTID);/* OR ALL THE      01640000
*                                      ID'S HAVE BEEN SEARCHED       */ 01641000
*/********************************************************************/ 01642000
*/*                                                                  */ 01643000
*/* WE ADD ONE IN THE FOLLOWING TWO INSTRUCTIONS IN ORDER TO CONVERT */ 01644000
*/* THE UCMRPYL FROM ZERO ORIGIN INDEX TO A ONE ORIGIN INDEX VALUE   */ 01645000
*/* USED BY PL/S II                                                  */ 01646000
*/*                                                                  */ 01647000
*/********************************************************************/ 01648000
*                               R1=UCMRPYL/8+1;/* DEVELOP BYTE          01649000
*                                      OFFSET INTO UCMRPYI           */ 01650000
         DROP  R10                     USE R10 AS CODE TOO MESSY TO     01651000
*                                      CHANGE TO ANOTHER REG            01652000
@DL00358 LA    R10,1                                                    01653000
         L     R8,CVTCUCB                                               01654000
         USING UCM,R8                                                   01655000
         L     R15,UCMLSTP                                              01656000
         DROP  R8                                                       01657000
         SLR   R14,R14                                                  01658000
         USING UCMEIL,R15                                               01659000
         IC    R14,UCMRPYL                                              01660000
         DROP  R15                                                      01661000
         LR    R1,R14                                                   01662000
         SRL   R1,3                                                     01663000
         ALR   R1,R10                                                   01664000
*                               R2=UCMRPYL//8+1;/* DEVELOP BYTE         01665000
*                                      OFFSET INTO BIT MAP           */ 01666000
         ST    R15,@TF00001                                             01667000
         SRDA  R14,32                                                   01668000
         D     R14,KF8                                                  01669000
         ALR   R14,R10                                                  01670000
         LR    R2,R14                                                   01671000
*/********************************************************************/ 01672000
*/*                                                                  */ 01673000
*/* CHECK IF THE UCMRPYL-TH BIT IS OFF. IF SO TURN IT ON AND CONVERT */ 01674000
*/* THE ID                                                           */ 01675000
*/*                                                                  */ 01676000
*/********************************************************************/ 01677000
*                               IF(UCMRPYI(R1)&IDMAP(R2))^=IDMAP(R2)    01678000
*                                   THEN                                01679000
         LR    R10,R8                                                   01680000
         ALR   R10,R1                                                   01681000
         USING UCM,R10                                                  01682000
         MVC   @TS00001(1),UCMRPYI-1                                    01683000
         DROP  R10                                                      01684000
         LA    R10,IDMAP-1(R2)                                          01685000
         NC    @TS00001(1),0(R10)                                       01686000
         LA    R10,IDMAP-1(R2)                                          01687000
         CLC   @TS00001(1),0(R10)                                       01688000
         BE    @RF00362                                                 01689000
*                                 DO;/* YES, ID IS AVAILABLE         */ 01690000
*                                   CVD(UCMRPYL,CVDAREA);/* CONVERT     01691000
*                                      BIT ID INTO DECIMAL IN 8 BYTE    01692000
*                                      AREA -CVDAREA                 */ 01693000
*                                                                       01694000
         L     R10,@TF00001                                             01695000
         USING UCMEIL,R10                                               01696000
         SLR   R0,R0                                                    01697000
         IC    R0,UCMRPYL                                               01698000
         DROP  R10                                                      01699000
         CVD   R0,CVDAREA                                               01700000
*                                   /*********************************/ 01701000
*                                   /*                               */ 01702000
*                                   /* UNPACK ONLY THE LAST TWO BYTES*/ 01703000
*                                   /* OF CONVERTED NUMBER           */ 01704000
*                                   /*                               */ 01705000
*                                   /*********************************/ 01706000
*                                                                       01707000
*                                   UNPK(OREID,CVDAREA(7:8));           01708000
*                                                                       01709000
         L     R10,XVOREAD                                              01710000
         USING OREF,R10                                                 01711000
         UNPK  OREID,CVDAREA+6(2)                                       01712000
*                                   /*********************************/ 01713000
*                                   /*                               */ 01714000
*                                   /* REPLACE SIGN WITH 'F0' ZONE   */ 01715000
*                                   /* BITS                          */ 01716000
*                                   /*                               */ 01717000
*                                   /*********************************/ 01718000
*                                                                       01719000
*                                   OREID(2)=OREID(2) 'F0'X;            01720000
         OI    OREID+1,X'F0'                                            01721000
         DROP  R10                                                      01722000
*                                   XVD0RPFD='1'B;/* INDICATE AN ID     01723000
*                                      WAS FOUND                     */ 01724000
         OI    XVD0,XVD0RPFD                                            01725000
*                                   /*********************************/ 01726000
*                                   /*                               */ 01727000
*                                   /* TURN ON ID BIT IN BIT MAP     */ 01728000
*                                   /*                               */ 01729000
*                                   /*********************************/ 01730000
*                                   UCMRPYI(R1)=UCMRPYI(R1) IDMAP(R2);  01731000
         ALR   R8,R1                                                    01732000
         LA    R10,IDMAP-1(R2)                                          01733000
         USING UCM,R8                                                   01734000
         OC    UCMRPYI-1(1),0(R10)                                      01735000
         DROP  R8                                                       01736000
*                                   REG1SAV=R1;/* SAVE CONTENTS OF      01737000
*                                      R1 IN CASE WE HAVE TO GIVE       01738000
*                                      BACK THE ID                   */ 01739000
         ST    R1,REG1SAV                                               01740000
*                                   REG2SAV=R2;/* SAVE CONTENTS OF      01741000
*                                      R2 FOR SAME REASON            */ 01742000
         ST    R2,REG2SAV                                               01743000
*                                 END;                                  01744000
*                               IF UCMRPYL=NINTY9 THEN/* END OF ID'S    01745000
*                                      REACHED?                      */ 01746000
@RF00362 L     R10,CVTCUCB                                              01747000
         USING UCM,R10                                                  01748000
         L     R10,UCMLSTP                                              01749000
         DROP  R10                                                      01750000
         USING UCMEIL,R10                                               01751000
         CLI   UCMRPYL,99                                               01752000
         BNE   @RF00372                                                 01753000
*                                 UCMRPYL=0;/* YES, GO BACK TO 1ST ID   01754000
*                                                                    */ 01755000
         MVI   UCMRPYL,X'00'                                            01756000
         DROP  R10                                                      01757000
*                               ELSE/* NO, INCREMENT UCMRPYL. THIS IS   01758000
*                                      DONE EVEN THOUGH AN ID MAY BE    01759000
*                                      PICKED, SO THAT UCMRPYL IS       01760000
*                                      INITIALIZED FOR THE NEXT ID      01761000
*                                      SCAN                          */ 01762000
*                                 UCMRPYL=UCMRPYL+1;                    01763000
         B     @DE00358                                                 01764000
*                                                                       01765000
@RF00372 L     R10,CVTCUCB                                              01766000
         USING UCM,R10                                                  01767000
         L     R10,UCMLSTP                                              01768000
         DROP  R10                                                      01769000
         LA    R8,1                                                     01770000
         SLR   R0,R0                                                    01771000
         USING UCMEIL,R10                                               01772000
         IC    R0,UCMRPYL                                               01773000
         ALR   R8,R0                                                    01774000
         STC   R8,UCMRPYL                                               01775000
         DROP  R10                                                      01776000
*                             END;  /* OF DO UNTIL (FINDING A FREE      01777000
*                                      ID)                           */ 01778000
@DE00358 TM    XVD0,XVD0RPFD                                            01779000
         BO    @RC00349                                                 01780000
         L     R10,CVTCUCB                                              01781000
         USING UCM,R10                                                  01782000
         L     R10,UCMLSTP                                              01783000
         DROP  R10                                                      01784000
         USING UCMEIL,R10                                               01785000
         CLC   UCMRPYL,STARTID                                          01786000
         BNE   @DL00358                LOOP BACK                        01787000
         DROP  R10                                                      01788000
*/****** END OF GETID SEGMENT ****************************************/ 01789000
*                           END;                                        01790000
*/********************************************************************/ 01791000
*/*                                                                  */ 01792000
*/*  CHECK TO SEE IF AN ID WAS AVAILABLE                             */ 01793000
*/*                                                                  */ 01794000
*/********************************************************************/ 01795000
*                                                                       01796000
*        RESTORE PARMLIST ADDRESSABILITY                                01797000
@RC00349 L     R10,ESTAEPRM                                             01798000
         USING PARMLIST,R10                                             01799000
*                         IF XVD0RPFD='1'B THEN/* WAS A REPLY ID        01800000
*                                      FOUND                         */ 01801000
         TM    XVD0,XVD0RPFD                                            01802000
         BZ    @RF00378                NO, BRANCH                       01803000
*                           DO;     /* YES, INDICATE WE NOW NEED A      01804000
*                                      WQE                           */ 01805000
*                             XVD0NORE='0'B;/* PROCESSING DONE FOR AN   01806000
*                                      ORE                           */ 01807000
*                             XVD0NWQE='1'B;/* GET A WQE             */ 01808000
         OI    XVD0,XVD0NWQE                                            01809000
         NI    XVD0,255-XVD0NORE                                        01810000
         B     @RF00345                                                 01811000
*                                                                       01812000
*                           END;                                        01813000
*                         ELSE      /* NO, A REPLY WASNT AVAILABLE   */ 01814000
*                           DO;     /* FREE THE ORE JUST OBTAINED    */ 01815000
*                             CALL VWTOFORE;/* FREE THE ORE          */ 01816000
@RF00378 BAL   R14,VWTOFORE                                             01817000
*                             /***************************************/ 01818000
*                             /*                                     */ 01819000
*                             /* WAIT FOR AN ORE TO BE FREED         */ 01820000
*                             /*                                     */ 01821000
*                             /***************************************/ 01822000
*                             CALL VWTOWAIT(UCMOECBT);                  01823000
         L     R15,CVTCUCB                                              01824000
         USING UCM,R15                                                  01825000
         LA    R15,UCMOECBT                                             01826000
         ST    R15,PARMPTR                                              01827000
         LA    R1,PARMPTR                                               01828000
         BAL   R14,VWTOWAIT                                             01829000
         B     @RF00345                                                 01830000
*                                                                       01831000
*                           END;                                        01832000
*                       END;        /* OF GET ORE AND ID PART        */ 01833000
*/********************************************************************/ 01834000
*/*                                                                  */ 01835000
*/*  NO, AN ORE WASN'T AVAILABLE. WAIT FOR AN ORE TO BE FREE'D       */ 01836000
*/*                                                                  */ 01837000
*/********************************************************************/ 01838000
*                     ELSE                                              01839000
*                       CALL VWTOWAIT(UCMOECBT);                        01840000
@RF00346 L     R15,CVTCUCB                                              01841000
         LA    R15,UCMOECBT                                             01842000
         ST    R15,PARMPTR                                              01843000
         LA    R1,PARMPTR                                               01844000
         BAL   R14,VWTOWAIT                                             01845000
*/********************************************************************/ 01846000
*/*                                                                  */ 01847000
*/*  CHECK IF WE NEED A WQE                                          */ 01848000
*/*                                                                  */ 01849000
*/********************************************************************/ 01850000
*                   IF XVD0NWQE='1'B&/* IS A WQE NEEDED NOW          */ 01851000
*                       XVD1PERR='0'B THEN/* AND WAS THERE NO ERROR     01852000
*                                      IN GETTING AN ORE             */ 01853000
@RF00345 TM    XVD0,XVD0NWQE                                            01854000
         BZ    @DE00344                                                 01855000
         TM    XVD1,XVD1PERR                                            01856000
         BNZ   @DE00344                                                 01857000
*/********************************************************************/ 01858000
*/*                                                                  */ 01859000
*/*  YES, CHECK IF ONE IS AVAILABLE, IF SO, GET IT. IF NOT WAIT      */ 01860000
*/*  UNTIL ONE IS FREE'D,                                            */ 01861000
*/*                                                                  */ 01862000
*/********************************************************************/ 01863000
*                     IF UCMWQNR<UCMWQLM /* IS THE NUMBER OF WQES       01864000
*                                      LESS THAN THE LIMIT OR        */ 01865000
*                         XVD1PRIV='1'B THEN/* IS THE USER A            01866000
*                                      PRIVILEGED TASK               */ 01867000
         L     R15,CVTCUCB                                              01868000
         LH    R8,UCMWQNR                                               01869000
         CH    R8,UCMWQLM                                               01870000
         BL    @RT00390                                                 01871000
         DROP  R15                                                      01872000
         TM    XVD1,XVD1PRIV           PRIVILEGED CALLER ?              01873000
         BZ    @RF00390                NO, BRANCH                       01874000
*                       DO;         /* YES, GET THE WQE              */ 01875000
*                         CALL VWTOGETB(1);/* GET A WQE AND ZERO IT  */ 01876000
@RT00390 LA    R1,@AL00392                                              01877000
         BAL   R14,VWTOGETB                                             01878000
*/********************************************************************/ 01879000
*/*                                                                  */ 01880000
*/* CHECK IF A WQE WAS OBTAINED BY VWTOGETB.  IF NOT THEN CHECK IF   */ 01881000
*/* THIS IS A WTOR. IF SO THEN FREE THE ORE AND REPLY ID THAT WAS    */ 01882000
*/* OBTAINED.                                                        */ 01883000
*/*                                                                  */ 01884000
*/********************************************************************/ 01885000
*                         IF XVWQEAD=1 THEN/* WAS THERE AN ERROR IN     01886000
*                                      GETTING THE WQE?              */ 01887000
         CLC   XVWQEAD,KF1                                              01888000
         BNE   @RF00393                                                 01889000
*                           DO;     /* YES, CHECK IF THIS IS A WTOR     01890000
*                                      REQUEST                       */ 01891000
*                             IF XVD2WTOR='1'B THEN/* IS THIS A WTOR?*/ 01892000
         TM    XVD2,XVD2WTOR                                            01893000
         BZ    @RF00395                NO, BRANCH                       01894000
*                               DO; /* YES. FREE THE ORE AND REPLY ID*/ 01895000
*                                 CALL VWTOFORE;/* FREE THE ORE      */ 01896000
*                                                                       01897000
         BAL   R14,VWTOFORE                                             01898000
*                                 /***********************************/ 01899000
*                                 /*                                 */ 01900000
*                                 /* FREE THE REPLY ID JUST PICKED   */ 01901000
*                                 /* THE INDEXS TO UCMRPYI AND IDMAP */ 01902000
*                                 /* WERE SAVED BY GETID IN REG1SAV  */ 01903000
*                                 /* AND REG2SAV                     */ 01904000
*                                 /*                                 */ 01905000
*                                 /***********************************/ 01906000
*                             UCMRPYI(REG1SAV)=UCMRPYI(REG1SAV)&(-1&&   01907000
*                                     IDMAP(REF2SAV));                  01908000
         L     R14,REG1SAV                                              01909000
         L     R8,CVTCUCB                                               01910000
         USING UCM,R8                                                   01911000
         L     R2,REG2SAV             RESTORE R2                        01912000
         SLR   R15,R15                                                  01913000
         IC    R15,IDMAP-1(R2)                                          01914000
         X     R15,KFM1                                                 01915000
         SLR   R2,R2                                                    01916000
         IC    R2,UCMRPYI-1(R14)                                        01917000
         NR    R15,R2                                                   01918000
         STC   R15,UCMRPYI-1(R14)                                       01919000
         DROP  R8                                                       01920000
*                               END;/* OF FREEING ORE                */ 01921000
*                             XVD1PERR='1'B;/* INDICATE AN ERROR        01922000
*                                      CONDITION FOUND               */ 01923000
*                           END;    /* IN ERROR GETTING WQE          */ 01924000
@RF00395 OI    XVD1,XVD1PERR                                            01925000
*                         XVD1ALDN='1'B;/* INDICATE WE ARE ALL DONE  */ 01926000
@RF00393 OI    XVD1,XVD1ALDN                                            01927000
         B     @DE00344                                                 01928000
*                                                                       01929000
*                       END;                                            01930000
*                     ELSE          /* NO, A WQE IS NOT AVAILABLE    */ 01931000
*                       DO;                                             01932000
*                                                                       01933000
*/********************************************************************/ 01934000
*/*                                                                  */ 01935000
*/*  CHECK IF THIS IS A WTOR. IF SO FREE THE ORE AND REPLY ID. THIS  */ 01936000
*/*  IS DONE SO WE DON'T GET IN AN INTERLOCK SITUATION               */ 01937000
*/*                                                                  */ 01938000
*/********************************************************************/ 01939000
*                         IF XVD2WTOR='1'B THEN/* IS THIS A WTOR     */ 01940000
*                           DO;     /* YES                           */ 01941000
@RF00390 TM    XVD2,XVD2WTOR                                            01942000
         BZ    @RF00405                NO, BRANCH                       01943000
*                             CALL VWTOFORE;/* FREE THE ORE          */ 01944000
         BAL   R14,VWTOFORE                                             01945000
*                             /***************************************/ 01946000
*                             /*                                     */ 01947000
*                             /* FREE THE REPLY ID JUST PICKED. THE  */ 01948000
*                             /* INDEXS TO UCMRPYI AND IDMAP WERE    */ 01949000
*                             /* SAVED BY GETID IN REG1SAV           */ 01950000
*                             /* AND REG2SAV                         */ 01951000
*                             /***************************************/ 01952000
*                       UCMRPYI(REG1SAV)=UCMRPYI(REG1SAV)&(-1&&IDMAP(   01953000
*                             REG2SAV));                                01954000
         L     R14,REG1SAV                                              01955000
         L     R8,CVTCUCB                                               01956000
         L     R2,REG2SAV              RESTORE R2                       01957000
         SLR   R15,R15                                                  01958000
         IC    R15,IDMAP-1(R2)                                          01959000
         X     R15,KFM1                                                 01960000
         SLR   R2,R2                                                    01961000
         USING UCM,R8                                                   01962000
         IC    R2,UCMRPYI-1(R14)                                        01963000
         NR    R15,R2                                                   01964000
         STC   R15,UCMRPYI-1(R14)                                       01965000
*                             /***************************************/ 01966000
*                             /*                                     */ 01967000
*                             /* NOW BACK UP UCMRPYL SO WE WILL TRY  */ 01968000
*                             /* TO GET THE SAME REPLY               */ 01969000
*                             /*                                     */ 01970000
*                             /***************************************/ 01971000
*                             IF UCMRPYL=0 THEN/* ARE WE AT BEGINNING   01972000
*                                      OF IDS                        */ 01973000
         L     R15,UCMLSTP                                              01974000
         DROP  R8                                                       01975000
         USING UCMEIL,R15                                               01976000
         CLI   UCMRPYL,0                                                01977000
         BNE   @RF00409                                                 01978000
*                               UCMRPYL=NINTY9;/* YES. BACK UP TO       01979000
*                                      99TH ID                       */ 01980000
         MVI   UCMRPYL,99                                               01981000
         DROP  R15                                                      01982000
         B     @RC00409                                                 01983000
*                                                                       01984000
*                             ELSE  /* NO WE ARE NOT AT ID 0         */ 01985000
*                               UCMRPYL=UCMRPYL-1;/* BACK UP JUST ONE*/ 01986000
@RF00409 L     R15,CVTCUCB                                              01987000
         USING UCM,R15                                                  01988000
         L     R15,UCMLSTP                                              01989000
         DROP  R15                                                      01990000
         USING UCMEIL,R15                                               01991000
         SLR   R8,R8                                                    01992000
         IC    R8,UCMRPYL                                               01993000
         BCTR  R8,0                                                     01994000
         STC   R8,UCMRPYL                                               01995000
         DROP  R15                                                      01996000
*                             XVD0NORE='1'B;/* INDICATE START OVER IN   01997000
*                                      GETTING ORE                   */ 01998000
*                             XVD0NWQE='0'B;                            01999000
@RC00409 OI    XVD0,XVD0NORE                                            02000000
         NI    XVD0,255-XVD0NWQE                                        02001000
*                           END;                                        02002000
*/********************************************************************/ 02003000
*/*                                                                  */ 02004000
*/* NOW WAIT FOR A WQE TO BE FREE'D. THEN TRY AGAIN                  */ 02005000
*/*                                                                  */ 02006000
*/********************************************************************/ 02007000
*                         CALL VWTOWAIT(UCMWECBT);                      02008000
@RF00405 L     R15,CVTCUCB                                              02009000
         USING UCM,R15                                                  02010000
         LA    R15,UCMWECBT                                             02011000
         DROP  R15                                                      02012000
         ST    R15,PARMPTR                                              02013000
         LA    R1,PARMPTR                                               02014000
         BAL   R14,VWTOWAIT                                             02015000
*                       END;                                            02016000
*                 END;              /* OF DO WHILE LOOP              */ 02017000
@DE00344 TM    XVD1,XVD1ALDN                                            02018000
         BZ    @DL00344                                                 02019000
*/* **** END GETBLKS SEGMENT *****************************************/ 02020000
*                                                                       02021000
*/********************************************************************/ 02022000
*/*                                                                  */ 02023000
*/* NOW CHECK IF THE CONTROL BLOCKS WERE OBTAINED. IF SO THEN GO     */ 02024000
*/* AHEAD AND BUILD THEM. IF NOT THEN ABEND WITH A D23 ABEND CODE.   */ 02025000
*/*                                                                  */ 02026000
*/********************************************************************/ 02027000
*                 IF XVD1PERR='0'B THEN/* SUCCESSFUL IN GETTING THE     02028000
*                                         CONTROL BLOCKS (NO ERRORS)?*/ 02029000
         TM    XVD1,XVD1PERR                                            02030000
         BO    @RF00418                                                 02031000
*                   DO;             /* YES. BUILD THEM               */ 02032000
*/********************************************************************/ 02033000
*/*                                                                  */ 02034000
*/* CHECK FOR WTOR. IF THIS REQUEST IS A WTOR THEN BUILD AN ORE      */ 02035000
*/*                                                                  */ 02036000
*/********************************************************************/ 02037000
*                     IF XVD2WTOR='1'B THEN/* IS THIS REQUEST A WTOR */ 02038000
         TM    XVD2,XVD2WTOR                                            02039000
         BZ    @RF00420                       NO, BRANCH                02040000
*                       DO;                                             02041000
*/*** START OF BUILDORE **********************************************/ 02042000
*/********************************************************************/ 02043000
*/*                                                                  */ 02044000
*/*   BUILDORE - CONSTRUCT THE ORE AND PUT IT ON THE ORE CHAIN       */ 02045000
*/*                                                                  */ 02046000
*/*   INPUT - XVWPLADR POINTS AT THE USER'S PARM LIST                */ 02047000
*/*           XVOREAD  POINTS AT A ZEROED ORE                        */ 02048000
*/*                                                                  */ 02049000
*/*   OUTPUT - THE FILLED IN ORE IS ADDED TO THE ORE CHAIN           */ 02050000
*/*            AND IS MARKED SUSPENDED FOR THE DURATION OF THE       */ 02051000
*/*            SUBSYSTEM EXIT.                                       */ 02052000
*/*                                                                  */ 02053000
*/********************************************************************/ 02054000
*/********************************************************************/ 02055000
*/*                                                                  */ 02056000
*/*           THE OREID WILL HAVE ALREADY BEEN FILLED IN BY GETID    */ 02057000
*/*                                                                  */ 02058000
*/********************************************************************/ 02059000
*                                                                       02060000
*                         ORETCB=R4;/* INSERT TCB ADDR               */ 02061000
         L     R15,XVOREAD                                              02062000
         USING OREF,R15                                                 02063000
         ST    R4,ORETCB                                                02064000
*                                        /* MOVE IN REPLY LENGTH AND    02065000
*                                      BUFFER ADDR                   */ 02066000
         MVC   ORELNTH,WKARPYLN                                         02067000
         MVC   ORERPYA,WKARPBUF+1                                       02068000
*                                        /* MOVE IN THE REPLY ECB       02069000
*                                      ADDR                          */ 02070000
         MVC   OREECB,WKAECBP                                           02071000
*                         OREASID=ASCBASID;/* MOVE ASID OF THIS         02072000
*                                      MEMORY                        */ 02073000
         MVC   OREASID,ASCBASID                                         02074000
*                         OREWQE=XVWQEAD;/* MOVE IN ADDR OF             02075000
*                                      ASSOCIATED WQE                */ 02076000
         MVC   OREWQE,XVWQEAD                                           02077000
*                         OREBUFB='1'B;/* INDICATE THIS ORE IS IN USE*/ 02078000
*                         OREBUFD='1'B;/* INDICATE ORE OBTAINED VIA A   02079000
*                                      GETMAIN                       */ 02080000
         OI    OREXC,OREBUFB+OREBUFD                                    02081000
*/********************************************************************/ 02082000
*/*                                                                  */ 02083000
*/*  CHECK IF USER IS A PROBLEM PROGRAM. IF NOT THEN INDICATE THAT   */ 02084000
*/*  VALIDITY CHECKING OF REPLY BUFFER AND ECB CAN BE BYPASSED BY    */ 02085000
*/*  REPLY PROCESSING.                                               */ 02086000
*/*                                                                  */ 02087000
*/********************************************************************/ 02088000
*                         IF XVD1PP='0'B THEN/* IS USER NOT A PROBLEM   02089000
*                                      PROGRAM                       */ 02090000
         TM    XVD1,XVD1PP                                              02091000
         BNZ   @RF00429                                                 02092000
*                           OREKEY0='1'B;/* INDICATE BYPASS VALIDITY    02093000
*                                      CHECK                         */ 02094000
         OI    OREXA,OREKEY0                                            02095000
*                         ORESUSP='1'B;/* INDICATE ORE SUSPENDED FOR    02096000
*                                      SUBSYSTEM EXIT                */ 02097000
@RF00429 L     R15,XVOREAD                                              02098000
         OI    OREXA,ORESUSP           PROCESSING TEMPORARILY SUSPENDED 02099000
*/********************************************************************/ 02100000
*/*                                                                  */ 02101000
*/*  NOW PUT THE ORE ON THE FRONT OF THE QUEUE. THE ORDER OF         */ 02102000
*/*  APPEARANCE ON THE QUEUE IS IMMATERIAL. THE OPERATOR MAY RESPOND */ 02103000
*/*  IN ANY ORDER AND REPLY PROCESSING WILL SCAN THE QUEUE FOR MATCH-*/ 02104000
*/*  ING IDS.                                                        */ 02105000
*/*                                                                  */ 02106000
*/********************************************************************/ 02107000
*                         ORELKP=UCMRPYQ;/* POINT THIS ORE AT NEXT      02108000
*                                      ORE ON QUEUE                  */ 02109000
         L     R8,CVTCUCB                                               02110000
         USING UCM,R8                                                   02111000
         L     R2,UCMRPYQ                                               02112000
         ST    R2,ORELKP               LINKAGE POINTER                  02113000
         DROP  R15                                                      02114000
*                         UCMRPYQ=XVOREAD;/* POINT HEAD OF QUEUE AT     02115000
*                                      THIS ORE                      */ 02116000
         MVC   UCMRPYQ,XVOREAD                                          02117000
         DROP  R8                                                       02118000
*/********************************************************************/ 02119000
*/*                                                                  */ 02120000
*/*  WE ASSUME UCMRPYQ IS ZERO IF QUEUE IS EMPTY AT ENTRY TO VWTO    */ 02121000
*/*                                                                  */ 02122000
*/********************************************************************/ 02123000
*/****** END OF BUILD ORE SEGMENT ************************************/ 02124000
*                                                                       02125000
*                       END;                                            02126000
*/********************************************************************/ 02127000
*/*                                                                  */ 02128000
*/* NOW BUILD THE WQE                                                */ 02129000
*/*                                                                  */ 02130000
*/********************************************************************/ 02131000
*/*** START OF BUILDWQE **********************************************/ 02132000
*/********************************************************************/ 02133000
*/*                                                                  */ 02134000
*/*   BUILDWQE - CONSTRUCT THE WQE AND PUT IT ON THE WQE CHAIN       */ 02135000
*/*                                                                  */ 02136000
*/*   INPUT - WKAADTXT -> MSG TEXT + LEN +MCS FLAGS                  */ 02137000
*/*           WKALGH    = L'TEXT + 4                                 */ 02138000
*/*           XVWQEAD  POINTS AT A ZEROED WQE                        */ 02139000
*/*                                                                  */ 02140000
*/*   OUTPUT - THE FILLED IN WQE IS ADDED TO THE WQE CHAIN           */ 02141000
*/*                                                                  */ 02142000
*/*  START BY MOVING MESSAGE INTO THE WQE. THE FIRST CHARACTER OF    */ 02143000
*/*  TEXT IN THE WQE WILL BE THE AUTHORIZATION FLAG. THE MESSAGE IS  */ 02144000
*/*  SCANNED FOR 'NL' CHARACTER AND TO ELIMINATE TRAILING BLANKS.    */ 02145000
*/*  THE LENGTH OF THE MSG IS IN WKALGH AND IS NON-ZERO              */ 02146000
*/*  THE SECURITY MESSAGE FLAGGING IN THE MESSAGE TEXT IS:           */ 02147000
*/*   MSG TYPE           MSG FORMAT                                  */ 02148000
*/*   --------           ----------                                  */ 02149000
*/*   WTO,P/P,NONACTION  BLANK,+,TEXT                                */ 02150000
*/*   WTO,P/P,ACTION     @,TEXT                                      */ 02151000
*/*   WTO,SYS,NONACTION  BLANK,TEXT                                  */ 02152000
*/*   WTO,SYS,ACTION     *,TEXT                                      */ 02153000
*/*   WTOR,P/P           @,ID,BLANK,TEXT                             */ 02154000
*/*   WTOR,SYSTEM        *,ID,BLANK,TEXT                             */ 02155000
*/*                                                                  */ 02156000
*/*   AN ACTION MSG IS A WTOR OR A WTO WITH DESCRIPTOR CODE 1 OR 2.  */ 02157000
*/* NOTE: P/P IN THE ABOVE TABLE MEANS THAT THE USER IS NOT          */ 02158000
*/*       AUTHORIZED.                                                */ 02159000
*/*                                                                  */ 02160000
*/********************************************************************/ 02161000
*                     WQETXT='';    /* BLANK OUT TEXT PART OF THE WQE*/ 02162000
@RF00420 L     R15,XVWQEAD                                              02163000
         USING WQE,R15                                                  02164000
         MVI   WQETXT,C' '                                              02165000
         MVC   WQETXT+1(L'WQETXT-1),WQETXT                              02166000
*/********************************************************************/ 02167000
*/*                                                                  */ 02168000
*/*  CHECK FOR TYPE OF MESSAGE                                       */ 02169000
*/*                                                                  */ 02170000
*/********************************************************************/ 02171000
*                     IF XVD2WTOR='1'B THEN/*  WTOR ?                */ 02172000
         TM    XVD2,XVD2WTOR                                            02173000
         BZ    @RF00437                NO, BRANCH                       02174000
*                       DO;         /* YES, IS USER NOT AUTHORIZED?  */ 02175000
*                         IF XVD1AUTH='0'B THEN                         02176000
         TM    XVD1,XVD1AUTH                                            02177000
         BO    @RF00439                                                 02178000
*                           WQETXT='@';/* YES, MOVE IN P/P ACTION       02179000
*                                      FLAG                          */ 02180000
         MVI   WQETXT,C'@'                                              02181000
         B     @RC00439                                                 02182000
*                                                                       02183000
*                         ELSE      /* NO, MOVE IN SYSTEM ACTION FLAG*/ 02184000
*                           WQETXT='*';                                 02185000
@RF00439 MVI   WQETXT,C'*'                                              02186000
*                      WQETXT+1=OREID;/* MOVE IN REPLY ID FROM ORE   */ 02187000
@RC00439 L     R8,XVOREAD                                               02188000
         USING OREF,R8                                                  02189000
         MVC   WQETXT+1(2),OREID                                        02190000
         DROP  R8                                                       02191000
*                                                                       02192000
*                         MSGBLNK=' ';/* MOVE IN A BLANK AFTER REPLY    02193000
*                                      ID                            */ 02194000
         MVI   WQETXT+3,C' '                                            02195000
         DROP  R15                                                      02196000
*                         /*******************************************/ 02197000
*                         /*                                         */ 02198000
*                         /* POINT AT FIRST LOCATION OF MSG TEXT     */ 02199000
*                         /*                                         */ 02200000
*                         /*******************************************/ 02201000
         LA    R2,4                    4 BYTES OF WQETXT USED           02202000
         B     @RC00437                                                 02203000
*                                                                       02204000
*                       END;                                            02205000
*                     ELSE          /* NO, NOT A WTOR. CHECK FURTHER */ 02206000
*/********************************************************************/ 02207000
*/*                                                                  */ 02208000
*/* ACTION MSG BY REASON OF DESCRIPTOR CODES ?                       */ 02209000
*/* CHECK THE DESC CODES RETURNED BY THE INSTALLATION EXIT           */ 02210000
*/*                                                                  */ 02211000
*/********************************************************************/ 02212000
*                       DO;                                             02213000
*                         IF WPLDESCA='1'B /* DESC CODE 1 OR         */ 02214000
*                             WPLDESCB='1'B /* DESC CODE 2 OR           02215000
*                             WPLDESCK='1'B THEN/* DESC CODE 11?     */ 02216000
@RF00437 TM    WKADSC,WPLDESCA+WPLDESCB  DESC CODE 1 OR 2 ?             02217000
         BNZ   @RT00447                  YES, BRANCH                    02218000
         TM    WKADSC+1,WPLDESCK         DESC CODE 11 CRITICAL INFO ?   02219000
         BZ    @RF00447                  NO, BRANCH                     02220000
*                           IF XVD1AUTH='0'B THEN/* YES, CHECK FOR      02221000
*                                      NOT AUTHORIZED.               */ 02222000
@RT00447 TM    XVD1,XVD1AUTH                                            02223000
         BO    @RF00448                                                 02224000
*                             DO;   /* YES, USER IS NOT AUTHORIZED   */ 02225000
*                               WQETXT='@';/* MOVE IN P/P ACTION        02226000
*                                      FLAG                          */ 02227000
         L     R15,XVWQEAD                                              02228000
         USING WQE,R15                                                  02229000
         MVI   WQETXT,C'@'                                              02230000
         LA    R2,1                    1 BYTES OF WQETXT USED           02231000
         TM    WKADSC+1,WPLDESCK       CRITICAL EVENTUAL ACTION REQ ?   02232000
         BO    @RC00437                YES, BRANCH                      02233000
*                               WPLDESCG='1'B;/* TURN ON DESC 7 SO      02234000
*                                      THE P/P ACTION MSG WILL BE       02235000
*                                      DOMMED AT TASK TERMINATION    */ 02236000
         OI    WKADSC,WPLDESCG                                          02237000
         B     @RC00437                                                 02238000
*                                                                       02239000
*                             END;                                      02240000
*                           ELSE    /* NO, THIS IS A SYSTEM ACTION      02241000
*                                      MSG                           */ 02242000
*                             DO;                                       02243000
*                               WQETXT='*';/* MOVE IN SYSTEM ACTION     02244000
*                                      FLAG                          */ 02245000
@RF00448 MVI   WQETXT,C'*'                                              02246000
         LA    R2,1                    1 BYTES OF WQETXT USED           02247000
         B     @RC00437                                                 02248000
*                                                                       02249000
*                             END;                                      02250000
*                         ELSE      /* NO, THIS IS NOT AN ACTION        02251000
*                                      MESSAGE                       */ 02252000
*                           IF XVD1AUTH='0'B THEN/* IS THIS USER NOT    02253000
*                                      AUTHORIZED?                   */ 02254000
@RF00447 TM    XVD1,XVD1AUTH                                            02255000
         BNZ   @RF00458                                                 02256000
*                             DO;   /* YES                           */ 02257000
*                               PPMSGFLG=' +';/* MOVE IN P/P NO         02258000
*                                      ACTION MSG FLAG               */ 02259000
         MVC   WQETXT(L'KCPLUS),KCPLUS                                  02260000
         LA    R2,2                    2 BYTES OF WQETXT USED           02261000
         B     @RC00437                                                 02262000
*                                                                       02263000
*                             END;                                      02264000
*                           ELSE    /* NO, THIS IS A SYSTEM NO ACTION   02265000
*                                      MSG                           */ 02266000
*                             DO;                                       02267000
*                               MSGACTN=' ';/* MOVE IN SYSTEM NO        02268000
*                                      ACTION FLAG                   */ 02269000
@RF00458 MVI   WQETXT,C' '                                              02270000
         LA    R2,1                    1 BYTES OF WQETXT USED           02271000
*                             END;                                      02272000
*                       END;        /* OF WTO MSG FLAGGING SECTION   */ 02273000
*/********************************************************************/ 02274000
*/*                                                                  */ 02275000
*/*  R2 CONTAINS THE NUMBER OF BYTES OF THE WPLTXT THAT HAVE         */ 02276000
*/*  BEEN USED FOR THE MESSAGE FLAGS                                 */ 02277000
*/*                                                                  */ 02278000
*/********************************************************************/ 02279000
*                     IF XVD2WTOR='1'B THEN/* IF A WTOR, MAX TEXT       02280000
*                                      LENGTH IS 122                 */ 02281000
@RC00437 TM    XVD2,XVD2WTOR           WTOR ?                           02282000
         BZ    @RF00470                NO, BRANCH                       02283000
*                       TEXTLNGT=MIN((WKALGH-4),122);                   02284000
         LH    R8,WKALGH               R8 = L'MAJOR WQE TEXT +4         02285000
         S     R8,KF4                  R8 = L'MAJOR WQE TEXT            02286000
         LA    R1,122                  R1 = MAX L'WTOR TEXT             02287000
         CR    R8,R1                   L'WQE TEXT > MAXIMUM ?           02288000
         BNH   @RC00470                NO, LENGTH IS NOT > MAXIMUM      02289000
         LR    R8,R1                   YES, TRUNCATE WQE TEXT TO MAX    02290000
         B     @RC00470                                                 02291000
*                                                                       02292000
*                     ELSE          /* IF WTO, MAX TEXT LENGTH IS 125*/ 02293000
*                       TEXTLNGT=MIN((WKALGH-4),125);                   02294000
@RF00470 LH    R8,WKALGH               R8 = L'MAJOR WQE TEXT +4         02295000
         S     R8,KF4                  R8 = L'MAJOR WQE TEXT            02296000
         LA    R1,125                  R1 = MAX L'WTO TEXT              02297000
         CR    R8,R1                   L'WQE TEXT > MAXIMUM ?           02298000
         BNH   @RC00470                NO, LENGTH IS NOT > MAXIMUM      02299000
         LR    R8,R1                   YES, TRUNCATE WQE TEXT TO MAX    02300000
*/********************************************************************/ 02301000
*/*                                                                  */ 02302000
*/* MOVE MESSAGE TEXT INTO WQE                                       */ 02303000
*/*                                                                  */ 02304000
*/********************************************************************/ 02305000
*                     WQETXT(R2:TEXTLNGT+R2-1)=WPLTXT;                  02306000
@RC00470 LA    R1,WQETXT(R2)           R1 -> FIRST AVAIL BYTE IN WQETXT 02307000
         L     R14,WKAADTXT            R14 -> LEN FLD + MCS + TEXT      02308000
         LA    R14,4(,R14)             R14 -> TEXT                      02309000
         BCTR  R8,0                                                     02310000
         EX    R8,@SM03498             MOVE WPLTXT INTO WQETEXT         02311000
*                                      MVC 0(0,R1),0(R14)               02312000
*/********************************************************************/ 02313000
*/*                                                                  */ 02314000
*/*  SCAN BACKWARDS LOOKING FOR FIRST NON BLANK CHARACTER            */ 02315000
*/*                                                                  */ 02316000
*/********************************************************************/ 02317000
         LA    R1,WQETXT(R2)           R1 -> START OF MSG TEXT          02318000
         AR    R1,R8                   R1 -> LAST BYTE OF MESSAGE       02319000
         LA    R8,1(R2,R8)             INTERATION COUNTER               02320000
*                                                                       02321000
@DL00475 CLI   0(R1),C' '              BLANK CHAR ?                     02322000
         BNE   @RC00477                NO, EXIT LOOP TO STORE LENGTH    02323000
         BCTR  R1,0                    YES, DECR POINTER                02324000
         BCT   R8,@DL00475             CONTINUE LOOP                    02325000
*                                                                       02326000
*/********************************************************************/ 02327000
*/*                                                                  */ 02328000
*/*      MESSAGE WAS ALL BLANK                                       */ 02329000
*/*                                                                  */ 02330000
*/********************************************************************/ 02331000
         LA    R8,1                    TEXT LENGTH SET TO 1             02332000
*                     WQENBR=TEXTLNGT;/* STORE LENGTH OF MESSAGE     */ 02333000
*                     WQESEQN=UCMCMID;/* MOVE IN MSG SEQUENCE NUMBER */ 02334000
@RC00477 ST    R8,WQENBR               STORE LENGTH OF MESSAGE          02335000
         L     R1,CVTCUCB                                               02336000
         S     R1,KF4                                                   02337000
         L     R1,0(,R1)               R1 -> UCM PREFIX                 02338000
         USING UCMPRFX,R1                                               02339000
         MVC   WQESEQN(3),UCMCMID+1                                     02340000
         DROP  R1                                                       02341000
*/********************************************************************/ 02342000
*/* CHECK IF THIS IS AN OLD STYLE MESSAGE WHICH HAS NO MCS FLAGS     */ 02343000
*/*                                                                  */ 02344000
*/********************************************************************/ 02345000
*                     IF WKAMCSF=0 THEN/* MCS FLAGS IN THE WPL ?     */ 02346000
         ICM   R0,B'0011',WKAMCSF                                       02347000
         BNZ   @RF00482                YES, BRANCH                      02348000
*                       WQEMCSA='1'B;/* IND R/D CODES IN WQ          */ 02349000
         OI    WQEMCSF1,WQEMCSA                                         02350000
         B     @RC00482                                                 02351000
*                                                                       02352000
*                     /***********************************************/ 02353000
*                     /*                                             */ 02354000
*                     /* NOTE - THE MCS FIELD IN THE WPL IS SET TO   */ 02355000
*                     /* ALLOW TOTAL MESSAGE PROCESSING BY ALL       */ 02356000
*                     /* CONSOLES RECEIVING THE ORIGINAL MESSAGE     */ 02357000
*                     /*                                             */ 02358000
*                     /***********************************************/ 02359000
*                     ELSE                                              02360000
*                       WQEMCSF=WPLMCSF;/* MOVE IN THE MCS FLAGS     */ 02361000
@RF00482 MVC   WQEMCSF,WKAMCSF                                          02362000
*                     /***********************************************/ 02363000
*                     /*                                             */ 02364000
*                     /* CHECK IF THIS IS A WTP THAT IS TO GO TO     */ 02365000
*                     /* HARDCOPY ONLY. IGC0203E WOULD HAVE SET      */ 02366000
*                     /* XVD0HDCY ON IF THIS SITUATION EXISTS        */ 02367000
*                     /*                                             */ 02368000
*                     /***********************************************/ 02369000
*                     IF XVD0HDCY='1'B THEN/* DO WE SEND THIS MSG TO    02370000
*                                      HC ONLY                       */ 02371000
@RC00482 TM    XVD0,XVD0HDCY                  NO, BRANCH                02372000
         BZ    @RF00485                                                 02373000
*                       WQEMCSG='1'B;/* YES, TURN ON HC ONLY MCS FLAG*/ 02374000
         OI    WQEMCSF1,WQEMCSG                                         02375000
*                     IF WQEMCSB='1'B /* IS R0 OR QREG0 MCS FLAG ON*/   02376000
*                         WQEMCSH='1'B THEN                             02377000
@RF00485 TM    WQEMCSF1,WQEMCSB+WQEMCSH                                 02378000
         BZ    @RF00487                                                 02379000
*                       WQEUCMID=XVCONID;/* YES. MOVE IN CONSOLE ID  */ 02380000
         MVC   WQEUCMID,XVCONID                                         02381000
*                     XVWQEID=UCMCMID;/* SAVE ID FOR RETURN TO THE      02382000
*                                        USER                        */ 02383000
@RF00487 L     R8,CVTCUCB                                               02384000
         S     R8,KF4                                                   02385000
         L     R8,0(,R8)                 R8 -> UCM PREFIX               02386000
         USING UCMPRFX,R8                                               02387000
         L     R14,UCMCMID               R15 = UCM MESSAGE ID NUMBER    02388000
         ST    R14,XVWQEID                                              02389000
*                     UCMCMID=UCMCMID+1;/* INCREMENT MESSAGE ID NUM */  02390000
         LA    R14,1(,R14)                                              02391000
         ST    R14,UCMCMID                                              02392000
         DROP  R8                                                       02393000
*                     WQEROUT=WKAROC;/* MOVE IN ROUTE CODES          */ 02394000
         MVC   WQEROUT,WKAROC                                           02395000
*                     WQEDESCD=WKADSC;/* MOVE IN DESC CODES          */ 02396000
         MVC   WQEDESCD,WKADSC                                          02397000
*                       WQEMSGTP=WKAMSGTY;/* MOVE IN MSGTYP FLAGS    */ 02398000
         MVC   WQEMSGTP,WKAMSGTY                                        02399000
*                     WQEBUFB='1'B; /* INDICATE THE WQE IS IN USE    */ 02400000
*                     WQEBUFD='1'B; /* INDICATE THE QWE                 02401000
*                                      DYNAMICALLY GOTTEN            */ 02402000
         OI    WQEAVAIL,WQEBUFB+WQEBUFD                                 02403000
*/********************************************************************/ 02404000
*/*                                                                  */ 02405000
*/* IF WTOR FILL IN REPLY ID AND SET DESC CODES                      */ 02406000
*/*                                                                  */ 02407000
*/********************************************************************/ 02408000
*                     IF XVD2WTOR='1'B THEN                             02409000
         TM    XVD2,XVD2WTOR                                            02410000
         BZ    @RF00497                NO, BRANCH                       02411000
*                       DO;                                             02412000
*                         WQERPYID=OREID;/* MOVE IN REPLY ID         */ 02413000
         L     R1,XVOREAD                                               02414000
         USING OREF,R1                                                  02415000
         MVC   WQERPYID,OREID                                           02416000
         DROP  R1                                                       02417000
*                         WQEORE='1'B;/* TURN ON ORE EXISTS BIT      */ 02418000
*                         WQEWTOR='1'B;/* INDICATE THAT THIS WQE IS     02419000
*                                      FOR A WTOR                    */ 02420000
         OI    WQEXA,WQEORE+WQEWTOR                                     02421000
*                         WQEDESCD='0200'X;/* MOVE IN DESC CODE OF 7    02422000
*                                      ONLY FOR WTOR                 */ 02423000
         MVC   WQEDESCD,KX0200                                          02424000
*                       END;        /* OF WTOR HANDLING              */ 02425000
*/********************************************************************/ 02426000
*/*                                                                  */ 02427000
*/* CHECK IF USER IS P/P. IF SO DON'T ALLOW BYPASS OF HARD COPY      */ 02428000
*/*                                                                  */ 02429000
*/********************************************************************/ 02430000
*                     IF XVD1PP='1'B THEN/* CALLER A P/P             */ 02431000
@RF00497 TM    XVD1,XVD1PP                                              02432000
         BZ    @RF00504                 NO, BRANCH                      02433000
*                       WQEMCSN='0'B;/* YES, USER CAN'T BY PASS HC   */ 02434000
         NI    WQEMCSF2,255-WQEMCSN                                     02435000
*                     IF WQEMCSH='1'B&/* DID NOT AUTH USER SPECIFY      02436000
*                                      QREG0                         */ 02437000
*                         XVD1AUTH='0'B THEN                            02438000
@RF00504 TM    WQEMCSF1,WQEMCSH                                         02439000
         BZ    @RF00506                                                 02440000
         TM    XVD1,XVD1AUTH                                            02441000
         BO    @RF00506                                                 02442000
*                       DO;         /* YES. SWITCH USER TO R0           02443000
*                                      CONDITIONAL QUEUE TO THAT        02444000
*                                      CONSOLE                       */ 02445000
*                         WQEMCSH='0'B;/* TURN OFF QREG0 MCS FLAG    */ 02446000
*                         WQEMCSB='1'B;/* TURN ON R0 MCS FLAG        */ 02447000
         OI    WQEMCSF1,WQEMCSB                                         02448000
         NI    WQEMCSF1,255-WQEMCSH                                     02449000
*                       END;                                            02450000
*                     WQEASID=ASCBASID;/* MOVE IN ASID OF THIS MEMORY*/ 02451000
@RF00506 MVC   WQEASID,ASCBASID                                         02452000
*                     WQETCB=R4;    /* MOVE IN ADDR OF CURRENT TCB   */ 02453000
         ST    R4,WQETCB                                                02454000
*                     WQEJSTCB=TCBJSTCB;/* MOVE IN ADDR OF JOB STEPS    02455000
*                                      TCB                           */ 02456000
         MVC   WQEJSTCB,TCBJSTCB                                        02457000
*/********************************************************************/ 02458000
*/*                                                                  */ 02459000
*/* PUT IN USER AUTHORIZATION                                        */ 02460000
*/*                                                                  */ 02461000
*/********************************************************************/ 02462000
*                                                                       02463000
*                     IF XVD1AUTH='1'B THEN/* USER AUTHORIZED ?      */ 02464000
         TM    XVD1,XVD1AUTH                                            02465000
         BZ    @RF00514                                                 02466000
*                       WQEAUTH='1'B;/* YES, INDICATE SO             */ 02467000
         OI    WQEXA,WQEAUTH                                            02468000
         B     @RC00514                                                 02469000
*                                                                       02470000
*                     ELSE                                              02471000
*                       WQEAUTH='0'B;/* NO, MAKE SURE BIT IS OFF     */ 02472000
@RF00514 NI    WQEXA,255-WQEAUTH                                        02473000
*/********************************************************************/ 02474000
*/*                                                                  */ 02475000
*/*  NOW SET QUEUE FOR HC IF ALREADY INDICATED                       */ 02476000
*/*                                                                  */ 02477000
*/********************************************************************/ 02478000
*                     IF XVD2QFHC='1'B THEN/* IS QUEUE FOR HC           02479000
*                                      INDICATED                     */ 02480000
@RC00514 TM    XVD2,XVD2QFHC                                            02481000
         BZ    @RF00517                                                 02482000
*                       WQEQFHC='1'B;/* YES, SET SAVE BIT ON IN WQE  */ 02483000
         OI    WQEXA,WQEQFHC                                            02484000
         B     @RC00517                                                 02485000
*                                                                       02486000
*                     ELSE                                              02487000
*                       WQEQFHC='0'B;/* NO, INSURE BIT IS OFF        */ 02488000
@RF00517 NI    WQEXA,255-WQEQFHC                                        02489000
*/********************************************************************/ 02490000
*/*                                                                  */ 02491000
*/* CHECK IF TIME IS TO BE TAKEN                                     */ 02492000
*/*                                                                  */ 02493000
*/********************************************************************/ 02494000
*                     IF WPLMCSFI='1'B THEN/* DO NOT TIME STAMP ON ? */ 02495000
@RC00517 TM    WKAMCSF+1,WPLMCSFI                                       02496000
         BZ    @RF00520                                                 02497000
*                       WQETS='';   /* YES, FILL TIME STAMP WITH        02498000
*                                      BLANKS                        */ 02499000
         MVI   WQETS,C' '                                               02500000
         MVC   WQETS+1(L'WQETS-1),WQETS                                 02501000
         B     @RC00520                                                 02502000
*                                                                       02503000
*                     ELSE          /* NO, UNPACK THE TIME STAMP     */ 02504000
*                       DO;         /* FILL IN THE TIME FIELD        */ 02505000
@RF00520 MVC   WQEPAD(9),PATTIME       MOVE IN THE TIME EDIT PATTERN    02506000
         ED    WQEPAD(9),XVA8          FORMAT TIME HH.MM.SS INTO WQETS  02507000
*                       END;                                            02508000
*                     WQEPAD1=' ';  /* INSERT BLANK BETWEEN TS AND      02509000
*                                      JOBNAME                       */ 02510000
@RC00520 MVI   WQEPAD1,C' '                                             02511000
*                     WQEPAD2=' ';  /* INSERT BLANK AFTER THE JOBNAME*/ 02512000
         MVI   WQEPAD2,C' '                                             02513000
*                     WQEJOBNM=' '; /* BLANK OUT THE JOB NAME FIELD  */ 02514000
         MVI   WQEJOBNM,C' '                                            02515000
         MVC   WQEJOBNM+1(L'WQEJOBNM-1),WQEJOBNM                        02516000
*/********************************************************************/ 02517000
*/*                                                                  */ 02518000
*/* NOW DECODE THE ROUTE CODES                                       */ 02519000
*/*                                                                  */ 02520000
*/********************************************************************/ 02521000
*                     R3=WQEROUT; /* PICK UP UNDECODED ROUTE CODES */   02522000
         L     R3,WQEROUT                                               02523000
*                     DO R10=1 TO 4;/* CONVERT FOUR ROUTE               02524000
*                                      CHARACTERS                    */ 02525000
         LA    R8,1                                                     02526000
*                       R2=0;       /* PREPARE FOR SHIFT             */ 02527000
@DL00535 SLR   R2,R2                                                    02528000
*                                   /* MOVE IN FOUR BITS OF ROUTE       02529000
*                                      CODE                          */ 02530000
         SLDL  R2,4                                                     02531000
*                       R2=R2+1;/* MAKE INDEX TO EBCIDIC TABLE A        02532000
*                                      ONE ORIGIN INDEX              */ 02533000
         LA    R2,1(,R2)                                                02534000
*/********************************************************************/ 02535000
*/*                                                                  */ 02536000
*/* NOW USE THE FOUR BITS IN R2 TO PICK UP THE PROPER CHARACTER      */ 02537000
*/* FROM THE CHARACTER TABLE                                         */ 02538000
*/*                                                                  */ 02539000
*/********************************************************************/ 02540000
*                                                                       02541000
*                       WQERR(R10)=HEXCHAR(R2);                         02542000
         L     R1,XVWQEAD                                               02543000
         ALR   R1,R8                                                    02544000
         LA    R14,HEXCHAR-1(R2)                                        02545000
         MVC   WQERR-1-WQE(1,R1),0(R14)                                 02546000
*                     END;                                              02547000
         LA    R8,1(,R8)                                                02548000
         C     R8,KF4                                                   02549000
         BNH   @DL00535                                                 02550000
*                     WQEPAD=' ';   /* INSERT BLANK AFTER ROUTE      */ 02551000
         MVI   WQEPAD,C' '                                              02552000
*                     R3=CVTPTR;    /* RESET R3 TO POINT AT CVTMAP */   02553000
         L     R3,CVTPTR                                                02554000
*                     WQESUSP='1'B; /* SUSPEND OPERATION OF WQE FOR     02555000
*                                      SUBSYSTEM EXIT                */ 02556000
         OI    WQEXA,WQESUSP                                            02557000
*/********************************************************************/ 02558000
*/*                                                                  */ 02559000
*/*  THIS SECTION OF CODE TEST FOR BYPASS HARDCOPY REQUESTED BY      */ 02560000
*/*  THE ISSUER AND IF ON, SETS MASTER TRACED BIT ON IN ORDER TO     */ 02561000
*/*  PREVENT PROCESSING FOR MASTER TRACING BY IEAVMWSV               */ 02562000
*/*                                                                  */ 02563000
*/********************************************************************/ 02564000
*                     IF WQEMCSN='1'B THEN/* BYPASS HARDCOPY            02565000
*                                      REQUESTED                     */ 02566000
         TM    WQEMCSF2,WQEMCSN                                         02567000
         BZ    @RF00545                NO, BRANCH                       02568000
*                       WQEMTRCD='1'B;/* YES, SET MASTER TRACED BIT  */ 02569000
         OI    WQEAVAIL,WQEMTRCD                                        02570000
*/********************************************************************/ 02571000
*/*                                                                  */ 02572000
*/*  PUT WQE ON THE QUEUE. CHECK IF QUEUE IS EMPTY                   */ 02573000
*/*                                                                  */ 02574000
*/********************************************************************/ 02575000
*                     IF UCMWQEND=0 THEN/* IF QUEUE IS EMPTY SET UP     02576000
*                                      FOR INSERT                    */ 02577000
@RF00545 L     R8,CVTCUCB                                               02578000
         USING UCM,R8                                                   02579000
         ICM   R2,B'1111',UCMWQEND                                      02580000
         BNZ   @RF00547                                                 02581000
*                       UCMWQEND=ADDR(UCMWTOQ);/* PT AT HEAD OF CHAIN*/ 02582000
         LA    R2,UCMWTOQ                                               02583000
         ST    R2,UCMWQEND                                              02584000
*                     UCMWQEND->WQELKPA=XVWQEAD;/* PT LAST WQE AT NEW   02585000
*                                      WQE                           */ 02586000
@RF00547 L     R2,UCMWQEND                                              02587000
         STCM  R15,B'0111',WQELKPA-WQE(R2)                              02588000
*                     UCMWQEND=XVWQEAD;/* PT END OF CHAIN AT NEW WQE */ 02589000
         ST    R15,UCMWQEND                                             02590000
*                     WQELKP=0;     /* INDICATE LAST ON THE CHAIN    */ 02591000
         XC    WQELKP,WQELKP                                            02592000
*/*   CHECK IF WTO HAS BEEN MARKED FOR DELETION. IF SO MARK          */ 02593000
*/*   IT AS SERVICED AND SEND IT TO HARDCOPY                         */ 02594000
*                     IF XVD2DELW='1'B THEN/* IS WQE TO BE DELETED?  */ 02595000
         TM    XVD2,XVD2DELW                                            02596000
         BZ    @RF00552                NO, BRANCH                       02597000
*                       DO;         /* YES, DELETE THIS MESSAGE      */ 02598000
*                         WQEBUFE='1'B;/* MARK WQE AS SERVICED       */ 02599000
         OI    WQEAVAIL,WQEBUFE                                         02600000
*                         UCMSYSI='1'B;/* IND. CLEAN UP IS NEEDED    */ 02601000
         S     R8,KF4                                                   02602000
         L     R8,0(,R8)               R8 -> UCM PREFIX                 02603000
         DROP  R8                                                       02604000
         USING UCMPRFX,R8                                               02605000
         OI    UCMSFLG2,UCMSYSI                                         02606000
         AIF   (&TMVS805).U805G                                         02607000
*                         WQEQFHC='1'B;/* SEND MESSAGE TO HARDCOPY   */ 02608000
         OI    WQEXA,WQEQFHC                                            02609000
*                         WQEBUFC='1'B;/* IND. READY FOR HARDCOPY    */ 02610000
         OI    WQEAVAIL,WQEBUFC                                         02611000
         AGO   .U805H                                                   02612000
.U805G   NI    WQEXA,255-WQEQFHC       NO HARDCOPY                      02613000
         NOP   0                       WAS OI WQEAVAIL,WQEBUFC          02614000
.U805H   ANOP                                                           02615000
*                       END;        /* END IF DELETE IS SPECIFIED    */ 02616000
         DROP  R8,R15                                                   02617000
*/*** END OF BUILDWQE ************************************************/ 02618000
*/********************************************************************/ 02619000
*/*                                                                  */ 02620000
*/* FREE THE HELD LOCKS AND FRR PRIOR TO TAKING THE SUBSYSTEM EXIT   */ 02621000
*/*                                                                  */ 02622000
*/********************************************************************/ 02623000
*                     CALL FREELOCK;                                    02624000
@RF00552 BAL   R14,FREELOCK                                             02625000
*/********************************************************************/ 02626000
*/*                                                                  */ 02627000
*/* TAKE THE SUBSYSTEM EXIT                                          */ 02628000
*/*                                                                  */ 02629000
*/********************************************************************/ 02630000
*                     PARMFTPT=FTSSEXIT;/* START OF SUBSYSTEM EXIT      02631000
*                                      CODE                          */ 02632000
         MVI   PARMFTPT,X'08'                                           02633000
*                     PARMRTAD=ADDR(VWTOSSRT);/* IF ERROR TURN OFF      02634000
*                                      DELETE BIT                    */ 02635000
         LA    R2,VWTOSSRT                                              02636000
         ST    R2,PARMRTAD                                              02637000
*/********************************************************************/ 02638000
*/*                                                                  */ 02639000
*/*   HASPEXIT - EXIT TO THE JOB ENTRY SUBSYSTEM                     */ 02640000
*/*                                                                  */ 02641000
*/*  THE SPACE FOR THE SSOB AND SSOBWT IS OBTAINED FROM SUBPOOL 231  */ 02642000
*/*  WITH THE AUTOMATIC VARIABLES.                                   */ 02643000
*/*                                                                  */ 02644000
*/********************************************************************/ 02645000
*                                                                       02646000
*/********************************************************************/ 02647000
*/*                                                                  */ 02648000
*/*   SET UP THE SSOB                                                */ 02649000
*/*                                                                  */ 02650000
*/********************************************************************/ 02651000
*                                                                       02652000
*                     SSOBID='SSOB';/* FILL IN THE ID FIELD          */ 02653000
         MVC   SSOBID(L'KCSSOB),KCSSOB                                  02654000
*                     SSOBLEN=LENGTH(SSOB);/* AND THE LENGTH FIELD   */ 02655000
         MVC   SSOBLEN(2),KH20                                          02656000
*                     SSOBFUNC=SSOBWTO;/* SPECIFY WTO EXIT TO THE       02657000
*                                      SUBSYSTEM                     */ 02658000
         MVC   SSOBFUNC(2),KH9                                          02659000
*                     SSOBSSIB=0;   /* INDICATE SUBSYSTEM WHICH         02660000
*                                      INITIATED THE USER            */ 02661000
         SLR   R14,R14                                                  02662000
         ST    R14,SSOBSSIB                                             02663000
*                     SSOBINDV=ADDR(SSWT);/* POINT AT WTO INTERFACE     02664000
*                                      BLOCK                         */ 02665000
         LA    R14,SSWT                                                 02666000
         ST    R14,SSOBINDV                                             02667000
*/********************************************************************/ 02668000
*/*                                                                  */ 02669000
*/*   NOW FILL IN THE SSWT BLOCK                                     */ 02670000
*/*                                                                  */ 02671000
*/********************************************************************/ 02672000
*                     SSWTLEN=LENGTH(SSWT);/* PUT LENGTH OF SSWT INTO   02673000
*                                      THE SSWT                      */ 02674000
         MVC   SSWTLEN,KH16                                             02675000
*                     SSWTWQE=XVWQEAD;/* PUT IN THE ADDR OF THE WQE  */ 02676000
         MVC   SSWTWQE,XVWQEAD        /* INTO THE SSOB               */ 02677000
*/********************************************************************/ 02678000
*/*                                                                  */ 02679000
*/*   CHECK FOR A WTOR. IF SO THEN FILL IN ADDR OF THE ORE. IF NOT   */ 02680000
*/*   THEN SET THE SSWTORE FIELD TO ZERO.                            */ 02681000
*/*                                                                  */ 02682000
*/********************************************************************/ 02683000
*                     IF XVD2WTOR='1'B THEN/* WTOR REQUEST ?         */ 02684000
         TM    XVD2,XVD2WTOR                                            02685000
         BZ    @RF00570                    NO, BRANCH                   02686000
*                       SSWTORE=XVOREAD;/* YES, PUT IN THE ADDR OF      02687000
*                                      THE ORE                       */ 02688000
         MVC   SSWTORE,XVOREAD                                          02689000
         B     @RC00570                                                 02690000
*                                                                       02691000
*                     ELSE                                              02692000
*                       SSWTORE=0;  /* NO, SET FIELD TO ZERO         */ 02693000
@RF00570 XC    SSWTORE,SSWTORE                                          02694000
*                     SSWTMIN=0;    /* THERE IS NO MINOR FOR A SINGLE   02695000
*                                      WTO                           */ 02696000
@RC00570 XC    SSWTMIN,SSWTMIN                                          02697000
*/*                                                                  */ 02698000
*/*      IEFSSREQ  (SSOB);                                           */ 02699000
*/*                                                                  */ 02700000
*/*      PASS CONTROL TO JOB ENTRY SUBSYSTEM TO                      */ 02701000
*/*      PROCESS REQUEST -                                           */ 02702000
*/*                                                                  */ 02703000
*/*      INPUT - R1 -> ONE WORD PARAMETER LIST WHICH                 */ 02704000
*/*                    POINTS TO THE SSOB                            */ 02705000
*/*      CALL SSREQ(SSOB);              /* CALL ON THE SUBSYSTEM     */ 02706000
*/*                                                                  */ 02707000
         LA    R14,SSOB                                                 02708000
         ST    R14,PARMPTR                                              02709000
         MVI   PARMPTR,X'80'           SET END OF PARAMETER LIST        02710000
         L     R8,CVTJESCT                                              02711000
         USING JESCT,R8                                                 02712000
         L     R15,JESSSREQ            R15 -> IEFSSREQ RTN              02713000
         DROP  R8                                                       02714000
         LA    R1,PARMPTR                                               02715000
         BALR  R14,R15                 CALL IEFSSERQ                    02716000
         L     R8,XVWQEAD                                               02717000
         USING WQE,R8                                                   02718000
         TM    WQEMCSF2,WQEMCSN        BYPASS QUEUE TO HARD COPY ?      02719000
         BZ    IEA00D94                NO, BRANCH                       02720000
         NI    WQEXA,255-WQEQFHC       YES,TURN OFF QUEUE FOR HARD COPY 02721000
*/********************************************************************/ 02722000
*/*                                                                  */ 02723000
*/*   CHECK FOR A REQUEST TO DELETE MESSAGE BY SUBSYSTEM. CHECK FOR  */ 02724000
*/*   GOOD EXIT AND DELETION REQUEST                                 */ 02725000
*/*                                                                  */ 02726000
*/********************************************************************/ 02727000
*                     IF R15=SSRTOK&/* WAS EXIT SUCCESSFUL           */ 02728000
*                         SSOBRETN=SSWTNDSP/* AND IS DON'T DISPLAY      02729000
*                                      REQUESTED                     */ 02730000
*                       THEN        /* YES                           */ 02731000
IEA00D94 LTR   R15,R15                                                  02732000
         BNZ   @RF00575                                                 02733000
         LA    R14,4                                                    02734000
         C     R14,SSOBRETN                                             02735000
         BNE   @RF00575                                                 02736000
*                       DO;         /* DELETE MESSAGE                */ 02737000
*                         WQEBUFE='1'B;/* MARK WQE AS SERVICED       */ 02738000
         OI    WQEAVAIL,WQEBUFE                                         02739000
*                         UCMSYSI='1'B;/* IND. CLEAN UP IS NEEDED    */ 02740000
         L     R14,CVTCUCB                                              02741000
         S     R14,KF4                                                  02742000
         L     R14,0(,R14)             R14 -> UCM PREFIX                02743000
         USING UCMPRFX,R14                                              02744000
         OI    UCMSFLG2,UCMSYSI                                         02745000
         DROP  R14                                                      02746000
*                         /*******************************************/ 02747000
*                         /*                                         */ 02748000
*                         /* CHECK IF HARDCOPY IS TO BE BYPASSED     */ 02749000
*                         /*                                         */ 02750000
*                         /*******************************************/ 02751000
*                         IF WQEMCSN='0'B THEN/* BYPASS HARDCOPY SET?*/ 02752000
         TM    WQEMCSF2,WQEMCSN                                         02753000
         BO    @RF00579                                                 02754000
*                           DO;     /* NO,SEND MESSAGE TO HARDCOPY   */ 02755000
*                             WQEBUFC='1'B;/* IND. READY FOR HARDCOPY*/ 02756000
         OI    WQEAVAIL,WQEBUFC                                         02757000
*                             WQEQFHC='1'B;/* SEND MESSAGE TO           02758000
*                                      HARDCOPY                      */ 02759000
         OI    WQEXA,WQEQFHC                                            02760000
         B     @RF00575                                                 02761000
*                                                                       02762000
*                           END;    /* END IF BYPASS NOT SET         */ 02763000
*                         ELSE      /* IF BYPASS IS SET              */ 02764000
*                           DO;     /* DO NOT HARDCOPY MESSAGE       */ 02765000
*                             IF XVD2WTOR='1'B THEN/* THIS A WTOR?   */ 02766000
@RF00579 TM    XVD2,XVD2WTOR           NO, BRANCH                       02767000
         BZ    @RF00585                                                 02768000
*                               WQEBUFC='1'B;/* YES, SET READY FOR      02769000
*                                      HDCPY                         */ 02770000
         OI    WQEAVAIL,WQEBUFC                                         02771000
*                             WQEQFHC='0'B;/* TURN OFF HARDCOPY FLAG */ 02772000
@RF00585 NI    WQEXA,255-WQEQFHC                                        02773000
*                           END;    /* END IF BYPASS IS SET          */ 02774000
*                       END;        /* END IF DON'T DISPLAY SPEC     */ 02775000
*/********************************************************************/ 02776000
*/*                                                                  */ 02777000
*/* REMOVE ALL UNPRINTABLE AND NONDISPLAY CHARACTERS IN WQE          */ 02778000
*/*                                                                  */ 02779000
*/********************************************************************/ 02780000
*                                   /* TRANSLATE TEXT TO PRINTABLE   */ 02781000
*                                   /* AND DISPLAYABLE ONLY          */ 02782000
@RF00575 L     R1,WQENBR               R1 = L'WQETXT                    02783000
         BCTR  R1,0                                                     02784000
         EX    R1,TRINST               TR WQETXT(0),TRTAB               02785000
*                       END;                                            02786000
*                     /***********************************************/ 02787000
*                     /*                                             */ 02788000
*                     /* WE ARE DONE WITH THE SUBSYSTEM EXIT. REGAIN */ 02789000
*                     /* THE LOCKS AND TAKE THE BLOCKS OUT OF THE    */ 02790000
*                     /* SUSPENDED STATE                             */ 02791000
*                     /*                                             */ 02792000
*                     /***********************************************/ 02793000
*VWTOSSLB:                                                              02794000
*                     CALL SETLOCK;                                     02795000
VWTOSSLB BAL   R14,SETLOCK                                              02796000
*/********************************************************************/ 02797000
*/*                                                                  */ 02798000
*/* TAKE THE WQE AND ORE OUT OF THE SUSPENDED STATE                  */ 02799000
*/*                                                                  */ 02800000
*/********************************************************************/ 02801000
*                     PARMFTPT=FTEND;/* END OF THE MODULE            */ 02802000
         MVI   PARMFTPT,X'09'                                           02803000
*                     PARMRTAD=0;   /* NO RETRY NEEDED               */ 02804000
         XC    PARMRTAD,PARMRTAD                                        02805000
*                                                                       02806000
*                     WQESUSP='0'B; /* TURN OFF SUSPENDED BIT        */ 02807000
         NI    WQEXA,255-WQESUSP                                        02808000
         DROP  R8                                                       02809000
*                     IF XVD2WTOR='1'B THEN/* IS THERE AN ORE?       */ 02810000
         TM    XVD2,XVD2WTOR                                            02811000
         BZ    @RF00605                 NO, BRANCH                      02812000
*                       ORESUSP='0'B;/* YES, TURN OFF THE SUSPENDED     02813000
*                                      BIT                           */ 02814000
         L     R8,XVOREAD                                               02815000
         USING OREF,R8                                                  02816000
         NI    OREXA,255-ORESUSP                                        02817000
         DROP  R8                                                       02818000
*                     CALL FREELOCK;/* FREE ALL LOCKS                */ 02819000
@RF00605 BAL   R14,FREELOCK                                             02820000
*/********************************************************************/ 02821000
*/*                                                                  */ 02822000
*/*     POST THE COMMUNICATIONS TASK TO INDICATE THAT IT HAS WORK    */ 02823000
*/*     TO DO. NAMELY A WQE, AND POSSIBLY AN ORE, TO PROCESS         */ 02824000
*/*                                                                  */ 02825000
*/********************************************************************/ 02826000
*                     CALL POSTOECB;/* XMPOST UCMOECB                */ 02827000
         BAL   R14,POSTOECB                                             02828000
         B     VWTOERRT                                                 02829000
*                                                                       02830000
*                   END;            /* OF TEST FOR VALID CONTROL        02831000
*                                      BLOCKS                        */ 02832000
*                 ELSE              /* NO THE CONTROL BLOCKS WERE NOT   02833000
*                                      OBTAINED. FREE THE LOCKS.     */ 02834000
*                   CALL FREELOCK;                                      02835000
@RF00418 BAL   R14,FREELOCK                                             02836000
*               END;                /* OF RETURN TO USER FROM WTP       02837000
*                                      TEST                          */ 02838000
*           END;                    /* END OF ELSE CLAUSE OF ZERO MSG   02839000
*                                      LENGTH TEST                   */ 02840000
*     END;                          /* END OF VALID PARM LIST ELSE      02841000
*                                      CLAUSE                        */ 02842000
*/********************************************************************/ 02843000
*/*                                                                  */ 02844000
*/*      EXIT FROM IEAVVWTO                                          */ 02845000
*/*                                                                  */ 02846000
*/********************************************************************/ 02847000
*                                                                       02848000
*        ON ENTRY TO VWTOERRT NO LOCKS MUST BE HELD AS                  02849000
*        THE FREEMAIN SVC IS ISSUED TO FREE UP STORAGE                  02850000
*                                                                       02851000
*VWTOERRT:                                                              02852000
VWTOERRT ICM   R1,B'1111',LONGTXT      STORAGE GETMAINED FOR LONG WPL ? 02853000
         BZ    VWTOERRA                NO, BRANCH AROUND FREEMAIN       02854000
         L     R0,LONGLEN                                               02855000
*                                                                       02856000
         FREEMAIN RU,LV=(0),A=(1),SP=229                                02857000
*                                                                       02858000
VWTOERRA L     R0,@SIZDATD             GET SIZE OF DYNAMIC AREA         02859000
         LR    R1,R9                   R1 -> DYNAMIC AREA               02860000
*                                                                       02861000
         FREEMAIN R,LV=(0),A=(1)       FREE THE AREA                    02862000
*                                                                       02863000
*/********************************************************************/ 02864000
*/*                                                                  */ 02865000
*/*     FREE THE ESTAE SO THAT ABENDS WILL BE SEEN BY THE USER       */ 02866000
*/*                                                                  */ 02867000
*/********************************************************************/ 02868000
*                                                                       02869000
         ESTAE 0                                                        02870000
*                                                                       02871000
*/********************************************************************/ 02872000
*/*                                                                  */ 02873000
*/* CHECK FOR ABEND ERROR SITUATION                                  */ 02874000
*/*                                                                  */ 02875000
*/********************************************************************/ 02876000
*   IF XVD1PERR='1'B THEN           /* WAS ERROR BIT TURNED ON FOR      02877000
*                                      ABEND                         */ 02878000
         TM    XVD1,XVD1PERR                                            02879000
         BZ    @RF00618                NO, BRANCH                       02880000
*     /***************************************************************/ 02881000
*     /*                                                             */ 02882000
*     /* YES, ABEND THE USER WITH CODE D23 WITH REASON CODE IN R15   */ 02883000
*     /* THAT IDENTIFIES THE REASON FOR THE ABEND                    */ 02884000
*     /*                                                             */ 02885000
*     /***************************************************************/ 02886000
*     DO;                                                               02887000
*       R1=ABNDCODE;                                                    02888000
         L     R15,XVA4                LOAD REASON CODE INTO R15        02889000
         L     R1,ABNDCODE          /* LOAD R1 WITH D23 CODE         */ 02890000
*       /*************************************************************/ 02891000
*       /*                                                           */ 02892000
*       /* ISSUE SYSTEM ABEND WITH DUMP                              */ 02893000
*       /*                                                           */ 02894000
*       /*************************************************************/ 02895000
*                                                                       02896000
         ABEND (1),DUMP,,SYSTEM                                         02897000
*                                                                       02898000
*     END;                                                              02899000
*   ELSE                            /* NO, CHECK FOR VALID MESSAGE ID*/ 02900000
*     IF XVD2ZERO='1'B THEN         /* WAS MESSAGE NOT PROCESSED        02901000
*                                      BECAUSE OF ZERO LENGTH           02902000
*                                      MESSAGE?                      */ 02903000
@RF00618 TM    XVD2,XVD2ZERO                                            02904000
         BZ    @RC00618                                                 02905000
*       XVWQEID=0;                  /* YES, PASS BACK A ZERO MSG ID  */ 02906000
         XC    XVWQEID,XVWQEID                                          02907000
*/********************************************************************/ 02908000
*/*                                                                  */ 02909000
*/*      EPILOG CODE                                                 */ 02910000
*/*                                                                  */ 02911000
*/****************************************************************** */ 02912000
*                                                                       02913000
@RC00618 SLR   R15,R15                 CLEAR REGISTER FOR IC            02914000
         IC    R15,XVRETCOD            PICK UP RETURN CODE              02915000
         L     R1,XVWQEID              GET MSG ID TO RETURN             02916000
*   R14=XVRET;                      /* GET RETURN ADDRESS OF CALLER  */ 02917000
         L     R14,XVRET                                                02918000
         BR    R14                     EXIT FROM IEEVVWTO TO SVC RETURN 02919000
*                                                                       02920000
         DROP  R10                                                      02921000
*                                                                       02922000
*/********************************************************************/ 02923000
*/*                                                                  */ 02924000
*/*   VWTOLREC - LOG RECOVERY ROUTINE                                */ 02925000
*/*                                                                  */ 02926000
*/*   FUNCTION - THIS ROUTINE IS ENTERED WHEN WE CAN NOT GET A CELL  */ 02927000
*/*   POOL EXTENSION FROM CSA, SUBPOOL 231. CHECK TO SEE IF THE      */ 02928000
*/*   REASON FOR THE GETMAIN FAILURE IS DUE TO THE SYSTEM LOG NOT    */ 02929000
*/*   BEING INITIALIZED YET AND CSA HAS BEEN FILLED WITH MESSAGES    */ 02930000
*/*   WAITING TO GO OUT TO THE LOG.  IF THAT IS THE CASE THEN WE     */ 02931000
*/*   RECOVER FROM THE SITUATION BY SWITCHING HARDCOPY TO A CONSOLE  */ 02932000
*/*   AND COMMTASK WILL FLUSH THE MESSAGES. WE WAIT UNTIL THE WQE    */ 02933000
*/*   LIMIT IS DOWN AND THEN PROCEED.  IF THE CAUSE ISN'T DUE TO     */ 02934000
*/*   LOG PROBLEMS THEN WE CAUSE THE CALLER TO BE ABENDED.           */ 02935000
*/*                                                                  */ 02936000
*/*   INPUT - THE INPUT PARM IS THE PTR IN XVSAV THAT WILL HOLD THE  */ 02937000
*/*            CONTROL BLOCKS ADDR. EITHER XVOREAD OR XVWQEAD. THIS  */ 02938000
*/*            FIELD IS ZERO ON INPUT.                               */ 02939000
*/*            UCMWQLM AND UCMRQLM ARE THE LIMITS ON THE NUMBER OF   */ 02940000
*/*            WQES AND ORES THAT WERE SET BY SYSGEN                 */ 02941000
*/*            UCMWQLM1 AND UCMRQLM1 WERE THE LIMITS SET AT IPL      */ 02942000
*/*            UCMFMSGN IS A FLAG WHICH WHEN ON TELLS                */ 02943000
*/*            IEAVMQWR NOT TO ISSUE ANY WQE THRESHOLD MSGS.         */ 02944000
*/*                                                                  */ 02945000
*/*   OUTPUT - BLKADDR IS RETURNED AS ZERO OR ONE. ZERO MEANS THAT   */ 02946000
*/*            THE ERROR WAS RECOVERED, TRY TO GET ANOTHER CELL.     */ 02947000
*/*            ONE MEANS THAT THE ERROR COULD NOT BE RECOVERED,      */ 02948000
*/*            SO ABEND THE CALLER.                                  */ 02949000
*/*            FLAG UCMFMSGN WILL BE ON                              */ 02950000
*/*                                                                  */ 02951000
*/********************************************************************/ 02952000
*VWTOLREC:                                                              02953000
VWTOLREC STM   R14,R12,@SA00002                                         02954000
         MVC   @PC00002(4),0(R1)                                        02955000
*                                      VWTOGETB WHEN PROBLEM OCCURED */ 02956000
*   /*****************************************************************/ 02957000
*   /*                                                               */ 02958000
*   /* SET FLAG TO INFORM IEAVMQWR NOT TO ISSUE ANY MESSAGES ABOUT   */ 02959000
*   /* WQE USE                                                       */ 02960000
*   /*                                                               */ 02961000
*   /*****************************************************************/ 02962000
*   UCMFMSGN='1'B;                  /* FLAG IS IN UCM FIXED EXTENSION*/ 02963000
         L     R10,CVTCUCB                                              02964000
         USING UCM,R10                                                  02965000
         L     R8,UCMBFEXT             R8 -> UCM FIXED EXTENSION BASE   02966000
         USING UCMFEXTA,R8                                              02967000
         OI    UCMFFLG1,UCMFMSGN       NO WQE THRESHOLD MSG             02968000
         DROP  R8                                                       02969000
*   /*****************************************************************/ 02970000
*   /*                                                               */ 02971000
*   /* CHECK IF ERROR DUE TO HC GOING TO UNINITIALIZED SYSLOG        */ 02972000
*   /*                                                               */ 02973000
*   /*****************************************************************/ 02974000
*   IF UCMSYSG='1'B &               /* SYSLOG THE HARDCOPY DEVICE    */ 02975000
*       BALOGINT='0'B THEN          /* AND LOG NOT INITIALIZED YET ? */ 02976000
         LR    R8,R10                                                   02977000
         S     R8,KF4                                                   02978000
         L     R8,0(,R8)               R8 -> UCM PREFIX                 02979000
         USING UCMPRFX,R8                                               02980000
         TM    UCMSFLG1,UCMSYSG        HARD COPY DEVICE IS SYSLOG ?     02981000
         BZ    @RF00634                NO, BRANCH                       02982000
         L     R2,CVTMSER                                               02983000
         USING BASE,R2                 MASTER SCHED RESIDENT DATA AREA  02984000
         TM    BALOG,BALOGINT          LOG AREA INITIALIZED ?           02985000
         BNZ   @RF00634                                                 02986000
         DROP  R2                                                       02987000
*     DO;                                                               02988000
*       /*************************************************************/ 02989000
*       /*                                                           */ 02990000
*       /* SWITCH THE LIMITS FOR NUMBER OF ORES AND WQES ALLOWED IN  */ 02991000
*       /* THE SYSTEM AT ONE TIME                                    */ 02992000
*       /*                                                           */ 02993000
*       /*************************************************************/ 02994000
*       UCMWQLM=UCMWQLM1;           /* SET SYSGENED LIMIT TO IPL        02995000
*                                      LIMIT                         */ 02996000
         LH    R2,UCMWQLM1                                              02997000
         STH   R2,UCMWQLM                                               02998000
*       UCMRQLM=UCMRQLM1;           /* FOR WQES AND ORES             */ 02999000
         IC    R2,UCMRQLM1                                              03000000
         STC   R2,UCMRQLM                                               03001000
*       /*************************************************************/ 03002000
*       /*                                                           */ 03003000
*       /* POST COMMTASK TO SWITCH HARDCOPY                          */ 03004000
*       /*                                                           */ 03005000
*       /*************************************************************/ 03006000
*       UCMSYSO='1'B;               /* THIS IS A DUMMY ATTN INTERUPT    03007000
*                                      BY SVC 35                     */ 03008000
         OI    UCMSFLG2,UCMSYSO                                         03009000
*       CALL FREELOCK;              /* FREE THE FRR AND LOCKS        */ 03010000
         BAL   R14,FREELOCK                                             03011000
*       REG1SAV=ADDR(UCMAECB);      /* POST ATTN ECB                 */ 03012000
         L     R10,CVTCUCB                                              03013000
         LA    R8,UCMAECB                                               03014000
         ST    R8,REG1SAV                                               03015000
*       XVA4=UCMASCB;               /* COMMTASK'S ASCB ADDR          */ 03016000
         L     R8,UCMASCB                                               03017000
         ST    R8,XVA4                                                  03018000
*       XVA8=POSTRECY;              /* ADDR OF IEAVMEST              */ 03019000
         L     R10,UCMWAKUP                                             03020000
         DROP  R10                                                      03021000
         L     R10,0(,R10)                                              03022000
         ST    R10,XVA8                                                 03023000
*       R1=ADDR(REG1SAV);           /* LOAD PTR TO 3 WORD PARM LIST  */ 03024000
         LA    R1,REG1SAV                                               03025000
*                                   /* POST WITH CODE OF 35 FOR WTO  */ 03026000
         POST  ,35,MF=(E,(1))                                           03027000
*                                                                       03028000
*       CALL SETLOCK;               /* REGAIN THE LOCKS              */ 03029000
         BAL   R14,SETLOCK                                              03030000
*       IF XVD1PRIV='0'B THEN       /* MSG WASN'T ISSUED BY THE         03031000
*                                      COMMTASK OR AN SIRB. THIS        03032000
*                                      CHECK IS SO WE DON'T CAUSE AN    03033000
*                                      SIRB OR COMMTASK TO WAIT         03034000
*                                      INSTEAD THEY ARE ABENDED WITH    03035000
*                                      A D23 ABEND CODE              */ 03036000
         TM    XVD1,XVD1PRIV                                            03037000
         BNZ   @RF00648                                                 03038000
*         CALL VWTOWAIT(UCMWECBT);  /* WAIT FOR THE WQE LIMIT TO BE     03039000
*                                      REDUCED BELOW THE NEW LIMITS  */ 03040000
         L     R10,CVTCUCB                                              03041000
         USING UCM,R10                                                  03042000
         LA    R10,UCMWECBT                                             03043000
         DROP  R10                                                      03044000
         ST    R10,PARMPTR                                              03045000
         LA    R1,PARMPTR                                               03046000
         BAL   R14,VWTOWAIT                                             03047000
         B     @ER00002                                                 03048000
*                                                                       03049000
*       ELSE                        /* MSG ISSUER WAS COMMTASK OR       03050000
*                                      SIRB                          */ 03051000
*         BLKADDR=1;                /* SET PARAMETER ADDR TO ERROR      03052000
*                                      COND SO ISSUER WILL BE ABENDED*/ 03053000
@RF00648 L     R10,@PC00002                                             03054000
         MVC   0(4,R10),KF1                                             03055000
         B     @ER00002                                                 03056000
*                                                                       03057000
*     END;                                                              03058000
*   ELSE                            /* ERROR NOT DUE TO SYSLOG. SET     03059000
*                                      ERROR RETURN INDICATOR.       */ 03060000
*     BLKADDR=1;                    /* SET PARAMETER ADDR TO ERROR      03061000
*                                      COND                          */ 03062000
@RF00634 L     R10,@PC00002                                             03063000
         MVC   0(4,R10),KF1                                             03064000
*   RETURN;                         /* GO BACK TO CALLER             */ 03065000
@ER00002 LM    R14,R12,@SA00002                                         03066000
         BR    R14                                                      03067000
*   END;                                                                03068000
         B     @ER00002                                                 03069000
*                                                                       03070000
*/********************************************************************/ 03071000
*/*                                                                  */ 03072000
*/*  VWTOCLNP - VWTO'S CLEAN UP ROUTINE                              */ 03073000
*/*                                                                  */ 03074000
*/*   FUNCTION - THIS ROUTINE WILL BE CALLED IF THERE IS AN ERROR    */ 03075000
*/*   IN VWTO WHILE IT WAS LOCKED AND BUILDING THE ORE OR WQE. THIS  */ 03076000
*/*   ROUTINE WILL ATTEMP TO FREE THE ORE AND WQE. IT WILL THEN      */ 03077000
*/*   RETURN TO IEAVMFRR WHICH WILL LET THE ERROR CONTINUE.          */ 03078000
*/*                                                                  */ 03079000
*/*  INPUT - R2 -> THE USERS FRR PARMLIST                            */ 03080000
*/*          PARMRGAD WILL POINT TO THIS MODULES REG FRR SAVEAREA    */ 03081000
*/*          R13 -> IEAVMFRR'S SAVEAREA                              */ 03082000
*/*          R14 AND R15 WILL BE THE RETURN AND ENTRY REGS           */ 03083000
*/*          XVSAV WILL CONTAIN INFORMATION ON LOCATION OF ORE/WQE   */ 03084000
*/*                                                                  */ 03085000
*/*    OUTPUT - IEAVMFRR'S REGS WILL BE RESTORED                     */ 03086000
*/*             THE ORE/WQE, IF ANY WILL BE FREED                    */ 03087000
*/*                                                                  */ 03088000
*/********************************************************************/ 03089000
*VWTOCLNP:                                                              03090000
         DROP  R11,R12                                                  03091000
*                           /* SET UP THIS ENTRY POINT AND ALL REGS */  03092000
         USING *,R15           TEMPORARY BASE REGISTER                  03093000
VWTOCLNP SAVE  (14,12),,'IEAVVWTO CLEANUP'                              03094000
         USING PARMLIST,R2                                              03095000
         L     R1,PARMRGAD             PICK UP ADDR OF OUR SAVE AREA    03096000
         DROP  R2                                                       03097000
         LM    R3,R12,14(R1)           RESTORE OUR REGISTERS            03098000
         DROP  R15                     MODULE BASE REGS NOW AVAILABLE   03099000
         USING IEAVVWTO,R11,R12        RESTORE ADDRESSABILITY           03100000
*   /*****************************************************************/ 03101000
*   /*                                                               */ 03102000
*   /* NOW SAVE THE CALLER'S SAVE AREA ADDRESS                       */ 03103000
*   /*                                                               */ 03104000
*   /*****************************************************************/ 03105000
*   XVA8=R13;                       /* USE THE XVSAV WORK AREA       */ 03106000
         ST    R13,XVA8                OVERLAY SAVED TIME               03107000
*   R13=R9;                         /* LOAD OUR OWN SAVEAREA ADDRESS */ 03108000
         LR    R13,R9                                                   03109000
*   /*****************************************************************/ 03110000
*   /*                                                               */ 03111000
*   /* NOW CHECK IF ORE WAS OBTAINED. IF SO THEN CHECK IF IS WAS ON  */ 03112000
*   /* THE ORE QUEUE                                                 */ 03113000
*   /*                                                               */ 03114000
*   /*****************************************************************/ 03115000
*   IF XVD1ALDN='1'B&               /* WERE WE THRU GETTING BLOCKS   */ 03116000
*       XVOREAD>1 THEN              /* AND VALID ADDRESS IN THE         03117000
*                                      OREADDR FLD                   */ 03118000
         TM    XVD1,XVD1ALDN                                            03119000
         BZ    @RF00659                                                 03120000
         CLC   XVOREAD,KF1                                              03121000
         BNH   @RF00659                                                 03122000
*     DO;                           /* YES. CHECK IF ORE WAS ON THE     03123000
*                                      CHAIN                         */ 03124000
*       DO R1=ADDR(UCMRPYQ) BY 0 WHILE(R1^=0);                          03125000
         L     R1,CVTCUCB                                               03126000
         USING UCM,R1                                                   03127000
         LA    R1,UCMRPYQ                                               03128000
         DROP  R1                                                       03129000
         B     @DE00661                                                 03130000
*                                                                       03131000
*         IF R1->ORELKP=XVOREAD THEN/* DOES THIS LINK POINTER POINT     03132000
*                                      TO OUR ORE                    */ 03133000
@DL00661 L     R10,XVOREAD                                              03134000
         C     R10,ORELKP-OREF(,R1)                                     03135000
         BNE   @RF00662                                                 03136000
*           DO;                     /* YES. DECHAIN OUR ORE          */ 03137000
*             R1->ORELKP=XVOREAD->ORELKP;/* PUT PTR TO NEXT ORE IN      03138000
*                                      PREVIOUS ORE LINK FIELD       */ 03139000
         L     R10,ORELKP-OREF(,R10)                                    03140000
         ST    R10,ORELKP-OREF(,R1)                                     03141000
*             R1=0;                 /* GET OUT OF LOOP               */ 03142000
         SLR   R1,R1                                                    03143000
         B     @DE00661                                                 03144000
*                                                                       03145000
*           END;                                                        03146000
*         ELSE                      /* NO, NOT OURS. PT TO NEXT ORE  */ 03147000
*           R1=R1->ORELKP;                                              03148000
@RF00662 L     R1,ORELKP-OREF(,R1)                                      03149000
*       END;                        /* THE ORE IS NOW OFF THE ORE       03150000
*                                      CHAIN                         */ 03151000
@DE00661 LTR   R1,R1                                                    03152000
         BNZ   @DL00661                                                 03153000
*       /*************************************************************/ 03154000
*       /*                                                           */ 03155000
*       /* FREE THE ORE                                              */ 03156000
*       /*                                                           */ 03157000
*       /*************************************************************/ 03158000
*       R0=UCMORECP;                /* CELL POOL ID FOR IRES         */ 03159000
         L     R10,CVTCUCB                                              03160000
         USING UCM,R10                                                  03161000
         L     R0,UCMORECP                                              03162000
         DROP  R10                                                      03163000
*       R1=XVOREAD;                 /* ADDR OF THE ORE               */ 03164000
         L     R1,XVOREAD                                               03165000
*                                                  /* FREE ORE CELL  */ 03166000
         FREECELL CPID=(0),CELL=(1),BRANCH=YES                          03167000
*                                                                       03168000
*/********************************************************************/ 03169000
*/*                                                                  */ 03170000
*/* THIS ORE CELL MAY HAVE BEEN THE LAST ONE IN AN EXTENSION.        */ 03171000
*/* IF SO THEN R15 IS SET TO 20 BY FREECELL. IF THIS CONDITION       */ 03172000
*/* IS FOUND THEN FREE THE EXTENSION. R0 AND R1 ARE                  */ 03173000
*/* ARE SET BY FREECELL.                                             */ 03174000
*/*                                                                  */ 03175000
*/********************************************************************/ 03176000
*       IF R15=20 THEN              /* WAS CELL THE LAST IN AN          03177000
*                                      EXTENSION                     */ 03178000
         C     R15,KF20                                                 03179000
         BNE   @RF00659                                                 03180000
*         /***********************************************************/ 03181000
*         /*                                                         */ 03182000
*         /* YES, FREE THE EXTENSION                                 */ 03183000
*         /*                                                         */ 03184000
*         /***********************************************************/ 03185000
*                                                                       03186000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03187000
*                                                                       03188000
*     END;                                                              03189000
*   /*****************************************************************/ 03190000
*   /*                                                               */ 03191000
*   /* NOW CHECK IF WQE WAS OBTAINED                                 */ 03192000
*   /*                                                               */ 03193000
*   /*****************************************************************/ 03194000
*   IF XVD1ALDN='1'B&               /* WERE WE THRU GETTING BLOCKS   */ 03195000
*       XVWQEAD>1 THEN              /* AND VALID ADDRESS IN THE         03196000
*                                      WQEADDR FLD                   */ 03197000
@RF00659 TM    XVD1,XVD1ALDN                                            03198000
         BZ    @RF00677                                                 03199000
         CLC   XVWQEAD,KF1                                              03200000
         BNH   @RF00677                                                 03201000
*     DO;                           /* YES. CHECK IF WQE WAS ON THE     03202000
*                                      CHAIN                         */ 03203000
*       DO R1=ADDR(UCMWTOQ) BY 0 WHILE(R1^=0);                          03204000
         L     R1,CVTCUCB                                               03205000
         USING UCM,R1                                                   03206000
         LA    R1,UCMWTOQ                                               03207000
         DROP  R1                                                       03208000
         B     @DE00679                                                 03209000
*                                                                       03210000
*         IF R1->WQELKPA=XVWQEAD THEN/* DOES THIS LINK POINTER          03211000
*                                      POINT TO OUR WQE              */ 03212000
@DL00679 L     R10,XVWQEAD                                              03213000
         L     R8,WQELKPA-1-WQE(,R1)                                    03214000
         LA    R8,0(,R8)                                                03215000
         CR    R10,R8                                                   03216000
         BNE   @RF00680                                                 03217000
*           DO;                     /* YES. DECHAIN OUR WQE          */ 03218000
*             R1->WQELKPA=XVWQEAD->WQELKPA;/* PUT PTR TO NEXT WQE       03219000
*                                      IN PREVIOUS WQE LINK FIELD    */ 03220000
         MVC   WQELKPA-WQE(3,R1),WQELKPA-WQE(R10)                       03221000
*             IF UCMWQEND=XVWQEAD THEN/* WAS THIS WQE THE LAST ON THE   03222000
*                                      CHAIN?                        */ 03223000
         L     R8,CVTCUCB                                               03224000
         USING UCM,R8                                                   03225000
         C     R10,UCMWQEND                                             03226000
         BNE   @RF00683                                                 03227000
*               UCMWQEND=R1;        /* YES. UPDATE PTR IN UCM TO        03228000
*                                      POINT TO NEW END OF WQE CHAIN */ 03229000
         ST    R1,UCMWQEND                                              03230000
         DROP  R8                                                       03231000
*             R1=0;                 /* GET OUT OF LOOP               */ 03232000
@RF00683 SLR   R1,R1                                                    03233000
         B     @DE00679                                                 03234000
*                                                                       03235000
*           END;                                                        03236000
*         ELSE                      /* NO, NOT OURS. PT TO NEXT WQE  */ 03237000
*           R1=R1->WQELKPA;                                             03238000
@RF00680 L     R10,WQELKPA-1-WQE(,R1)                                   03239000
         LA    R10,0(,R10)                                              03240000
         LR    R1,R10                                                   03241000
*       END;                        /* THE WQE IS NOW OFF THE WQE       03242000
*                                      CHAIN                         */ 03243000
@DE00679 LTR   R1,R1                                                    03244000
         BNZ   @DL00679                                                 03245000
*       /*************************************************************/ 03246000
*       /*                                                           */ 03247000
*       /* FREE THE WQE                                              */ 03248000
*       /*                                                           */ 03249000
*       /*************************************************************/ 03250000
*       R0=UCMWQECP;                /* CELL POOL ID FOR WQES         */ 03251000
         L     R10,CVTCUCB                                              03252000
         USING UCM,R10                                                  03253000
         L     R0,UCMWQECP                                              03254000
         DROP  R10                                                      03255000
*       R1=XVWQEAD;                 /* ADDR OF THE WQE               */ 03256000
         L     R1,XVWQEAD                                               03257000
*                                                  /* FREE WQE CELL  */ 03258000
         FREECELL CPID=(0),CELL=(1),BRANCH=YES                          03259000
*                                                                       03260000
*/********************************************************************/ 03261000
*/*                                                                  */ 03262000
*/* THIS WQE CELL MAY HAVE BEEN THE LAST ONE IN AN EXTENSION.        */ 03263000
*/* IF SO THEN R15 IS SET TO 20 BY FREECELL. IF THIS CONDITION       */ 03264000
*/* IS FOUND THEN FREE THE EXTENSION. R0 AND R1 ARE                  */ 03265000
*/* SET BY FREECELL                                                  */ 03266000
*/*                                                                  */ 03267000
*/********************************************************************/ 03268000
*       IF R15=20 THEN              /* WAS CELL THE LAST IN AN          03269000
*                                      EXTENSION                     */ 03270000
         C     R15,KF20                                                 03271000
         BNE   @RF00677                                                 03272000
*         /***********************************************************/ 03273000
*         /*                                                         */ 03274000
*         /* YES, FREE THE EXTENSION                                 */ 03275000
*         /*                                                         */ 03276000
*         /***********************************************************/ 03277000
*                                                                       03278000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03279000
*                                                                       03280000
*     END;                                                              03281000
*   R13=XVA8;                       /* RESTORE CALLER'S SAVE AREA       03282000
*                                      ADDR                          */ 03283000
@RF00677 L     R13,XVA8                                                 03284000
         RETURN (14,12)             /* GO BACK TO IEAVMFRR ROUTINE*/    03285000
*                                                                       03286000
*/********************************************************************/ 03287000
*/*                                                                  */ 03288000
*/*      VWTOVALR                                                    */ 03289000
*/*                                                                  */ 03290000
*/*      THIS ROUTINE GETS CONTROL VIA THE FRR OR ESTAE PARMLIST     */ 03291000
*/*      ENTRY PARMRTAD IF AN ERROR IS DETECTED WHILE VALIDATING     */ 03292000
*/*      THE WPL.                                                    */ 03293000
*/*      REGISTERS ARE RESTORED BY SETRP REQUEST IN IEAVMFRR         */ 03294000
*/*                                                                  */ 03295000
*/********************************************************************/ 03296000
*VWTOVALR:                                                              03297000
         USING PARMLIST,R10                                             03298000
VWTOVALR MVI   XVREASON,D23PARM        PARMLIST NOT ADDRESSABLE BY USER 03299000
*                                                                       03300000
*        ENTRY POINT FOR VALIDATION ERROR DETECTED BY THE CODE          03301000
*        REASON CODE ALREADY SET                                        03302000
*                                                                       03303000
VWTOVALB MVI   XVFNCT,D23VALID         PARMLIST VALIDITY CHECK          03304000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03305000
*   XVD2VALD='0'B;                  /* WPL IS NOT VALID              */ 03306000
         NI    XVD2,255-XVD2VALD                                        03307000
         OI    XVD1,XVD1PERR           SET ERROR FLAG                   03308000
*   PARMRTAD=0;                     /* CLEAR RETRY ADDR TO AVOID        03309000
*                                      LOOPING                       */ 03310000
         XC    PARMRTAD,PARMRTAD                                        03311000
*                                                                       03312000
*        FREE THE LOCKS AND REMOVE THE FRR                              03313000
*        ORIGINAL ESTAE IS NOW IN PLACE                                 03314000
*                                                                       03315000
         OI    PFLAG,NOCMSLOK          TURN ON NO CMS LOCK REQUESTED    03316000
         BAL   R14,FREELOCK                                             03317000
         NI    PFLAG,255-NOCMSLOK      TURN OFF NO CMS LOCK REQUESTED   03318000
*                                   /* GOTO EXIT CODE                */ 03319000
         B     VWTOERRT                                                 03320000
*                                                                       03321000
*/********************************************************************/ 03322000
*/*                                                                  */ 03323000
*/*  VWTOSSRT - RETRY ROUTINE FOR SUBSYTEM EXIT                      */ 03324000
*/*                                                                  */ 03325000
*/*  FUNCTION - THIS ROUTINE WILL GET CONTROL IF THERE WAS AN ERROR  */ 03326000
*/*   IN THE SUBSYSTEM WTO EXIT ROUTINE. WE WILL TURN OFF XVD2DELW   */ 03327000
*/*  SO THAT THE MESSAGE WILL BE SURE TO GO OUT.  THEN BRANCH TO     */ 03328000
*/*  VWTOSSLB TO CONTINUE THE PROCESSING                             */ 03329000
*/*                                                                  */ 03330000
*/********************************************************************/ 03331000
*VWTOSSRT:                                                              03332000
*   XVD2DELW='0'B;                  /* DONT DELETE THE MESSAGE       */ 03333000
VWTOSSRT NI    XVD2,255-XVD2DELW                                        03334000
*   GO TO VWTOSSLB;                 /* CONTINUE WITH PROCESSING      */ 03335000
         B     VWTOSSLB                                                 03336000
*                                                                       03337000
*/********************************************************************/ 03338000
*/*  GETBLOCK                                                        */ 03339000
*/*                                                                  */ 03340000
*/*  FUNCTION: THIS ROUTINE WILL GET STORAGE FOR EITHER A WQE OR ORE */ 03341000
*/*     THE OBTAINED STORAGE WILL BE ZEROED OUT                      */ 03342000
*/*                                                                  */ 03343000
*/*  INPUT: TYPE INDICATES THE TYPE OF BLOCK TO GET. WQE OR ORE      */ 03344000
*/*          XVD0WWB MAY BE ON INDICATING THAT A WWB HAS BEEN        */ 03345000
*/*     OBTAINED.                                                    */ 03346000
*/*         XVWWB POINTS AT THE WWB                                  */ 03347000
*/*                                                                  */ 03348000
*/*  OUTPUT: A BLOCK OF THE PROPER SIZE AND ZEROED IS RETURNED TO THE*/ 03349000
*/*     CALLER. IF THE USER WAS ON THE WAIT CHAIN, THE WAIT ECB IS   */ 03350000
*/*     REMOVED.                                                     */ 03351000
*/*     IF THE GETCELL WAS UNSUCCESSFUL THEN THE ADDR PTR IS SET TO  */ 03352000
*/*     ONE INSTEAD OF BEING THE ADDR OF THE NEW CELL.               */ 03353000
*/*                                                                  */ 03354000
*/********************************************************************/ 03355000
*VWTOGETB:                                                              03356000
*                                                                       03357000
VWTOGETB ST    R14,12(,R13)           SAVE RETURN ADDR                  03358000
         ST    R13,@SAGETB+4          BACKCHAIN SAVE AREA               03359000
         LA    R14,@SAGETB                                              03360000
         LR    R13,R14                                                  03361000
         MVC   @PC00003(4),0(R1)                                        03362000
*/********************************************************************/ 03363000
*/*                                                                  */ 03364000
*/* CHECK IF REQUEST IS FOR AN ORE OR FOR A WQE                      */ 03365000
*/*                                                                  */ 03366000
*/********************************************************************/ 03367000
*                                                                       03368000
*   IF TYPE=2 THEN                  /* THIS REQUEST FOR AN ORE   ?   */ 03369000
         L     R14,@PC00003                                             03370000
         CLC   0(4,R14),KF2                                             03371000
         BNE   @RF00709                                                 03372000
*     DO;                           /* YES. GET AN ORE CELL          */ 03373000
*       XVOREAD=0;                  /* SET ADDR TO ZERO SO IT CAN BE    03374000
*                                      USED TO INDICATE SUCCESS OF      03375000
*                                      GETCELL                       */ 03376000
         SLR   R14,R14                                                  03377000
         ST    R14,XVOREAD                                              03378000
*       DO WHILE(XVOREAD=0);        /* LOOP UNTILL XVOREAD GETS         03379000
*                                      FILLED IN                     */ 03380000
         B     @DE00712                                                 03381000
*                                                                       03382000
*         R0=UCMORECP;              /* PICK UP ORE CELL POOL ID      */ 03383000
@DL00712 L     R14,CVTCUCB                                              03384000
         USING UCM,R14                                                  03385000
         L     R0,UCMORECP                                              03386000
*                                                                       03387000
         GETCELL CPID=(0),BRANCH=YES,SAVE=YES                           03388000
*                                                                       03389000
*/********************************************************************/ 03390000
*/*                                                                  */ 03391000
*/*      SEE IF GETCELL WAS SUCCESSFUL                               */ 03392000
*/*                                                                  */ 03393000
*/********************************************************************/ 03394000
*                                                                       03395000
*         IF R15=0 THEN             /* DID WE GET A CELL             */ 03396000
         LTR   R15,R15                                                  03397000
         BNZ   @RF00715                NO, BRANCH                       03398000
*           DO;                                                         03399000
*             XVOREAD=R1;           /* YES, SAVE ADDRESS TO ORE      */ 03400000
         ST    R1,XVOREAD                                               03401000
*             /*******************************************************/ 03402000
*             /*                                                     */ 03403000
*             /* ZERO OUT THE CONTROL BLOCK                          */ 03404000
*             /*                                                     */ 03405000
*             /*******************************************************/ 03406000
*             R1->0(1:LENGTH(OREF)*8)=''B;                              03407000
         XC    0(32,R1),0(R1)                                           03408000
*             UCMRQNR=UCMRQNR+1;    /* INCREMENT ORE COUNT BY ONE    */ 03409000
         L     R14,CVTCUCB                                              03410000
         LA    R10,1                                                    03411000
         AH    R10,UCMRQNR                                              03412000
         STH   R10,UCMRQNR                                              03413000
         DROP  R14                                                      03414000
         B     @DE00712                                                 03415000
*                                                                       03416000
*           END;                                                        03417000
*         ELSE                      /* NO THE GETCELL WAS NOT           03418000
*                                      SUCCESSFUL                    */ 03419000
*/********************************************************************/ 03420000
*/*                                                                  */ 03421000
*/* WE DID NOT GET A CELL. CHECK IF WE ARE OUT OF CELLS. IF SO       */ 03422000
*/* THEN GET AN EXTENSION.                                           */ 03423000
*/*                                                                  */ 03424000
*/********************************************************************/ 03425000
*           IF R15=4 THEN           /* DO WE NEED TO EXTEND THE CELL    03426000
*                                      POOL                          */ 03427000
@RF00715 C     R15,KF4                                                  03428000
         BNE   @RF00721                                                 03429000
*             DO;                   /* YES                           */ 03430000
*               R1=SUBPL231;        /* SET UP FOR GETMAIN FROM          03431000
*                                      SUBPOOL 231                   */ 03432000
         LA    R1,231                                                   03433000
*               R0=OREPLSZ;         /* PICK UP SIZE OF ORE POOL         03434000
*                                      EXTENSION                     */ 03435000
         LA    R0,1024                                                  03436000
*                                                                       03437000
         GETMAIN  RC,LV=(0),SP=(1),BRANCH=YES                           03438000
*                                                                       03439000
*               R3=CVTPTR;          /* RELOAD R3 WHICH WAS              03440000
*                                      DESTROYED BY THE GETMAIN         03441000
*                                      BRANCH ENTRY                  */ 03442000
         L     R3,CVTPTR                                                03443000
         LR    R2,R15                                                   03444000
*               /*****************************************************/ 03445000
*               /*                                                   */ 03446000
*               /* SEE IF GETMAIN WAS SUCCESSFUL. IF SO BUILD EXTEN  */ 03447000
*               /*                                                   */ 03448000
*               /*****************************************************/ 03449000
*               IF R15=0 THEN       /* STORAGE OBTAINED ?            */ 03450000
         LTR   R15,R15                                                  03451000
         BNZ   @RF00727                                                 03452000
*                 DO;               /* YES, EXTEND THE ORE POOL      */ 03453000
*                   R2=R1;          /* SAVE ADDR OF POOL EXTENSION   */ 03454000
         LR    R2,R1                                                    03455000
*                   R15=LENGTH(OREF);/* GET SIZE OF CELL REQUIRED       03456000
*                                      FOR BLD                       */ 03457000
         LA    R15,ORESIZE                                              03458000
*                   R0=UCMORECP;    /* PICK UP ORE CELL POOL ID      */ 03459000
         L     R14,CVTCUCB                                              03460000
         USING UCM,R14                                                  03461000
         L     R0,UCMORECP                                              03462000
         DROP  R14                                                      03463000
*                                                                       03464000
         BLDCPOOL  CPID=(0),CSIZE=(15),SP=231,CPADDR=(1),              C03465000
               BRANCH=YES,POOLSIZ=1,AUTODEL=YES,SERIAL=YES              03466000
*                                                                       03467000
*/********************************************************************/ 03468000
*/*                                                                  */ 03469000
*/* CHECK IF EXTENSION WAS SUCCESSFUL. IF NOT SET ERROR FLAG ON      */ 03470000
*/*                                                                  */ 03471000
*/********************************************************************/ 03472000
*                   IF R15^=0 THEN/* WAS EXTENSION UNSUCCESSFUL      */ 03473000
         LTR   R15,R14                                                  03474000
         BZ    @DE00712                                                 03475000
         MVI   XVFNCT,D23OREBC         ORE BLDCPOOL FAILURE             03476000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03477000
         STC   R15,XVREASON            STORE RETURN CODE IN REASON CODE 03478000
*                     DO;           /* YES. INDICATE SO IN XVOREAD   */ 03479000
*                       /*********************************************/ 03480000
*                       /*                                           */ 03481000
*                       /* FREE THE CORE FOR THE EXTENSION           */ 03482000
*                       /*                                           */ 03483000
*                       /*********************************************/ 03484000
*                       R0=FROREXT;/* GET SUBPOOL AND LENGTH PARM    */ 03485000
         L     R0,FROREXT                                               03486000
*                       R1=R2 ;/* GET ADDR OF EXTENSION              */ 03487000
         LR    R1,R2                                                    03488000
*                                                                       03489000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03490000
*                       XVOREAD=1;  /* INDICATE NO ORE OBTAINED      */ 03491000
         MVC   XVOREAD,KF1                                              03492000
         B     @DE00712                                                 03493000
*                                                                       03494000
*                     END;                                              03495000
*                 END;                                                  03496000
*               ELSE                                                    03497000
*                 /***************************************************/ 03498000
*                 /*                                                 */ 03499000
*                 /* GETMAIN WAS NOT SUCCESSFUL. CALL ROUTINE TO     */ 03500000
*                 /* CHECK IF ERROR IS DUE TO SYSLOG NOT YET         */ 03501000
*                 /* INITIALIZED                                     */ 03502000
*                 /*                                                 */ 03503000
*                 /***************************************************/ 03504000
*                 DO;                                                   03505000
*                   CALL VWTOLREC(XVOREAD);                             03506000
@RF00727 LA    R14,XVOREAD                                              03507000
         ST    R14,PARMPTR                                              03508000
         LA    R1,PARMPTR                                               03509000
         BAL   R14,VWTOLREC                                             03510000
         CLC   XVOREAD,KF1                                              03511000
         BNE   @DE00712                                                 03512000
         MVI   XVFNCT,D23OREGM         ORE GETMAIN FAILURE, SP231       03513000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03514000
         STC   R2,XVREASON                                              03515000
         B     @DE00712                                                 03516000
*                                                                       03517000
*                 END;                                                  03518000
*             END;                  /* OF TEST FOR EXTENSION NEEDED  */ 03519000
*           ELSE                                                        03520000
*/********************************************************************/ 03521000
*/*                                                                  */ 03522000
*/* THE ERROR WAS NOT DUE TO END OF EXTENSION. THE ERROR CAN NOT     */ 03523000
*/* BE CORRECTED SO SET ERROR INDICATOR FOR CALLER                   */ 03524000
*/*                                                                  */ 03525000
*/********************************************************************/ 03526000
*             XVOREAD=1;            /* INDICATE GET ORE UNSUCCESSFUL */ 03527000
@RF00721 MVI   XVFNCT,D23OREGC         ORE GETCELL FAILURE              03528000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03529000
         STC   R15,XVREASON            STORE RETURN CODE IN REASON CODE 03530000
         MVC   XVOREAD,KF1                                              03531000
*       END;                        /* OF DO WHILE LOOP              */ 03532000
@DE00712 ICM   R14,B'1111',XVOREAD                                      03533000
         BZ    @DL00712                                                 03534000
         B     @RC00709                                                 03535000
*                                                                       03536000
*     END;                                                              03537000
*   /*****************************************************************/ 03538000
*   /*                                                               */ 03539000
*   /* WQE GET CELL PART OF THIS SEGMENT                             */ 03540000
*   /*                                                               */ 03541000
*   /*****************************************************************/ 03542000
*   ELSE                            /* NO THIS REQUEST IS FOR A WQE  */ 03543000
*     DO;                                                               03544000
*       XVWQEAD=0;                  /* ZERO OUT ADDR SO IT CAN BE       03545000
*                                      USED TO INDICATE SUCCESS OR      03546000
*                                      FAILURE OF GETCELL            */ 03547000
@RF00709 SLR   R14,R14                                                  03548000
         ST    R14,XVWQEAD                                              03549000
*       DO WHILE(XVWQEAD=0);        /* LOOP UNTIL ADDR GETS FILLED      03550000
*                                      IN                            */ 03551000
         B     @DE00752                                                 03552000
*                                                                       03553000
*         R0=UCMWQECP;              /* PICK UP WQE CELL POOL ID      */ 03554000
@DL00752 L     R14,CVTCUCB                                              03555000
         USING UCM,R14                                                  03556000
         L     R0,UCMWQECP                                              03557000
*                                                                       03558000
         GETCELL CPID=(0),BRANCH=YES                                    03559000
*                                                                       03560000
*/********************************************************************/ 03561000
*/*                                                                  */ 03562000
*/* SEE IF GETCELL WAS SUCCESSFUL                                    */ 03563000
*/*                                                                  */ 03564000
*/********************************************************************/ 03565000
*         IF R15=0 THEN             /* DID WE GET A CELL ?           */ 03566000
         LTR   R15,R15                                                  03567000
         BNZ   @RF00755                                                 03568000
*           DO;                                                         03569000
*             XVWQEAD=R1;           /* SAVE ADDRESS TO WQE           */ 03570000
         ST    R1,XVWQEAD                                               03571000
*             /*******************************************************/ 03572000
*             /*                                                     */ 03573000
*             /* ZERO OUT THE CONTROL BLOCK                          */ 03574000
*             /*                                                     */ 03575000
*             /*******************************************************/ 03576000
*             R1->0(1:LENGTH(WQE)*8)=''B;                               03577000
         XC    0(WQESIZE,R1),0(R1)                                      03578000
*             UCMWQNR=UCMWQNR+1;    /* INCREMENT WQE COUNT           */ 03579000
         L     R14,CVTCUCB                                              03580000
         LA    R10,1                                                    03581000
         AH    R10,UCMWQNR                                              03582000
         STH   R10,UCMWQNR                                              03583000
         DROP  R14                                                      03584000
         B     @DE00752                                                 03585000
*                                                                       03586000
*           END;                                                        03587000
*/********************************************************************/ 03588000
*/*                                                                  */ 03589000
*/* WE DID NOT GET A CELL. CHECK IF WE ARE OUT OF CELLS. IF SO       */ 03590000
*/* THEN GET AN EXTENSION.                                           */ 03591000
*/*                                                                  */ 03592000
*/********************************************************************/ 03593000
*         ELSE                                                          03594000
*           IF R15=4 THEN           /* DO WE NEED TO EXTEND THE CELL    03595000
*                                      POOL                          */ 03596000
@RF00755 C     R15,KF4                                                  03597000
         BNE   @RF00761                                                 03598000
*             DO;                   /* YES                           */ 03599000
*               R1=SUBPL231;        /* SET UP FOR GETMAIN FROM 231   */ 03600000
         LA    R1,231                                                   03601000
*               R0=WQEPLSZ;         /* PICK UP SIZE OF WQE EXTENSION */ 03602000
         L     R0,KF4096                                                03603000
*                                                                       03604000
         GETMAIN  RC,LV=(0),SP=(1),BRANCH=YES                           03605000
*                                                                       03606000
*               R3=CVTPTR;          /* RELOAD R3 WHICH WAS              03607000
*                                      DESTROYED BY THE GETMAIN         03608000
*                                      CALLING SEQUENCE              */ 03609000
         L     R3,CVTPTR                                                03610000
         LR    R2,R15                                                   03611000
*               /*****************************************************/ 03612000
*               /*                                                   */ 03613000
*               /* SEE IF GETMAIN WAS SUCCESSFUL. IF SO BUILD        */ 03614000
*               /* EXTENSION.                                        */ 03615000
*               /*                                                   */ 03616000
*               /*****************************************************/ 03617000
*               IF R15=0 THEN       /* GET SPACE FOR THE EXTENSION ? */ 03618000
         LTR   R15,R15                                                  03619000
         BNZ   @RF00767                                                 03620000
*                 DO;               /* YES, BUILD THE WQE EXTENSION  */ 03621000
*                   R10=R1;         /* SAVE ADDRES OF WQE EXTENSION  */ 03622000
         LR    R2,R1                                                    03623000
*                   R0=UCMWQECP;    /* PICK UP THE WQE CELL POOL ID  */ 03624000
         L     R14,CVTCUCB                                              03625000
         USING UCM,R14                                                  03626000
         L     R0,UCMWQECP                                              03627000
         DROP  R14                                                      03628000
*                   R15=LENGTH(WQE);/* GET SIZE OF CELL REQUIRED     */ 03629000
         LA    R15,192                                                  03630000
*                                                                       03631000
         BLDCPOOL CPID=(0),SP=231,CSIZE=(15),CPADDR=(1),BRANCH=YES,    C03632000
               AUTODEL=YES,POOLSIZ=4,SERIAL=YES                         03633000
*                                                                       03634000
*/********************************************************************/ 03635000
*/*                                                                  */ 03636000
*/* CHECK IF EXTENSION WAS SUCCESSFUL. IF NOT SET ERROR FLAG ON      */ 03637000
*/*                                                                  */ 03638000
*/********************************************************************/ 03639000
*                   IF R15^=0 THEN/* WAS EXTENSION UNSUCCESSFUL      */ 03640000
         LTR   R15,R15                                                  03641000
         BZ    @DE00752                                                 03642000
         MVI   XVFNCT,D23WQEBC         WQE BLDCPOOL FAILURE             03643000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03644000
         STC   R15,XVREASON            STORE RETURN CODE IN REASON CODE 03645000
*                     DO;           /* YES, INDICATE SO IN XVWQEAD   */ 03646000
*                       /*********************************************/ 03647000
*                       /*                                           */ 03648000
*                       /* FREE THE WQE POOL EXTENSION               */ 03649000
*                       /*                                           */ 03650000
*                       /*********************************************/ 03651000
*                       R0=FRWQEXT;/* GET SUBPOOL AND LENGTH         */ 03652000
         L     R0,FRWQEXT                                               03653000
*                       R1=R2 ;/* GET ADDRESS OF WQE EXTENSION       */ 03654000
         LR    R1,R2                                                    03655000
*                                                                       03656000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03657000
*                                                                       03658000
*                       XVWQEAD=1;  /* INDICATE NO WQE OBTAINED      */ 03659000
         MVC   XVWQEAD,KF1                                              03660000
         B     @DE00752                                                 03661000
*                                                                       03662000
*                     END;                                              03663000
*                 END;                                                  03664000
*               /*****************************************************/ 03665000
*               /*                                                   */ 03666000
*               /* THE GETMAIN WAS NOT SUCCESSFUL. CALL THE LOG      */ 03667000
*               /* RECOVERY ROUTINE TO SEE IF ERROR DUE TO SYSLOG    */ 03668000
*               /* INIT                                              */ 03669000
*               /*                                                   */ 03670000
*               /*****************************************************/ 03671000
*               ELSE                                                    03672000
*                 DO;                                                   03673000
*                   CALL VWTOLREC(XVWQEAD);/* LOG RECOVERY ROUTINE   */ 03674000
@RF00767 LA    R14,XVWQEAD                                              03675000
         ST    R14,PARMPTR                                              03676000
         LA    R1,PARMPTR                                               03677000
         BAL   R14,VWTOLREC                                             03678000
         CLC   XVWQEAD,KF1                                              03679000
         BNE   @DE00752                                                 03680000
         MVI   XVFNCT,D23WQEGM         WQE GETMAIN FAILURE, SP231       03681000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03682000
         STC   R2,XVREASON             STORE RETURN CODE IN REASON CODE 03683000
         B     @DE00752                                                 03684000
*                                                                       03685000
*                 END;                                                  03686000
*             END;                                                      03687000
*/********************************************************************/ 03688000
*/*                                                                  */ 03689000
*/* THE ERROR WAS NOT DUE TO END OF EXTENSION. THE ERROR CAN NOT     */ 03690000
*/* BE CORRECTED SO SET ERROR INDICATOR FOR CALLER                   */ 03691000
*/*                                                                  */ 03692000
*/********************************************************************/ 03693000
*           ELSE                                                        03694000
*             XVWQEAD=1;            /* INDICATE GET WQE UNSUCCESSFUL */ 03695000
@RF00761 MVI   XVFNCT,D23WQEGC         WQE GETCELL FAILURE              03696000
         MVI   XVAMOD,VWTOID           IEAVVWTO'S ID FOR D23            03697000
         STC   R15,XVREASON            STORE RET CODE INTO REASON CODE  03698000
         MVC   XVWQEAD,KF1                                              03699000
*       END;                        /* OF DO WHILE LOOP              */ 03700000
@DE00752 ICM   R14,B'1111',XVWQEAD                                      03701000
         BZ    @DL00752                                                 03702000
*     END;                                                              03703000
*/********************************************************************/ 03704000
*/*                                                                  */ 03705000
*/* CHECK IF WE HAVE TO FREE THE ECB                                 */ 03706000
*/*                                                                  */ 03707000
*/********************************************************************/ 03708000
*   IF XVD0WWB='1'B THEN            /* A WWB ON THE CHAIN ?          */ 03709000
@RC00709 TM    XVD0,XVD0WWB                                             03710000
         BZ    @ER00003                                                 03711000
*     DO;                           /* YES, FREE IT AND TURN OFF        03712000
*                                      XVD0WWB                       */ 03713000
*       /*************************************************************/ 03714000
*       /*                                                           */ 03715000
*       /* POINT NEXT WWB AT BACK WWB                                */ 03716000
*       /*                                                           */ 03717000
*       /*************************************************************/ 03718000
*       WWBFWDPT->WWBBCKPT=WWBBCKPT;                                    03719000
         L     R14,XVWWB                                                03720000
         USING WWB,R14                                                  03721000
         L     R10,WWBFWDPT                                             03722000
         L     R8,WWBBCKPT                                              03723000
         ST    R8,WWBBCKPT-WWB(R10)                                     03724000
         DROP  R14                                                      03725000
*       /*************************************************************/ 03726000
*       /*                                                           */ 03727000
*       /* POINT BACK WWB AT NEXT WWB                                */ 03728000
*       /*                                                           */ 03729000
*       /*************************************************************/ 03730000
*       WWBBCKPT->WWBFWDPT=WWBFWDPT;                                    03731000
         ST    R10,WWBFWDPT-WWB(,R8)                                    03732000
*/********************************************************************/ 03733000
*/*                                                                  */ 03734000
*/* WWB IS NOW OFF THE QUEUE. FREE IT                                */ 03735000
*/*                                                                  */ 03736000
*/********************************************************************/ 03737000
*       R0=GETWWB;                  /* PICK PARMS FOR FREEMAIN       */ 03738000
         L     R0,GETWWB                                                03739000
*       R1=XVWWB;                   /* GET ADDRESS OF WWB            */ 03740000
         LR    R1,R14                                                   03741000
*                                                                       03742000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03743000
*                                                                       03744000
*       XVWWB=0;                    /* ZERO OUT ADDRESS OF WWB IN XSA*/ 03745000
         SLR   R10,R10                                                  03746000
         ST    R10,XVWWB                                                03747000
*       XVD0WWB='0'B;               /* INDICATE NO WWB ON CHAIN      */ 03748000
         NI    XVD0,255-XVD0WWB                                         03749000
*     END;                                                              03750000
*   RETURN;                                                             03751000
@ER00003 L     R13,4(,R13)                                              03752000
         L     R14,12(,R13)                                             03753000
         BR    R14                                                      03754000
*                                                                       03755000
*   END VWTOGETB;                                                       03756000
         B     @ER00003                                                 03757000
*                                                                       03758000
*/*** START OF WAITCHN  **********************************************/ 03759000
*/********************************************************************/ 03760000
*/*                                                                  */ 03761000
*/*   WAITCHN - WAIT ON THE ECB IN THE WWB                           */ 03762000
*/*                                                                  */ 03763000
*/*   FUNCTION - THIS ROUTINE WILL CREATE A WWB AND PUT IT ON THE    */ 03764000
*/*     CHAIN POINTED AT BY THE INPUT PARAMETER. IF A WWB ALREADY    */ 03765000
*/*     EXISTS THE ECB PART IS ZEROED. THE ROUTINE FREES THE LOCKS   */ 03766000
*/*     AND THEN WAITS FOR THE ECB TO BE POSTED. THE LOCKS ARE       */ 03767000
*/*     THEN OBTAINED.                                               */ 03768000
*/*                                                                  */ 03769000
*/********************************************************************/ 03770000
*VWTOWAIT:                                                              03771000
*                                                                       03772000
VWTOWAIT ST    R14,@SA00004                                             03773000
         MVC   @PC00004(4),0(R1)                                        03774000
*/********************************************************************/ 03775000
*/*                                                                  */ 03776000
*/*  CHECK IF A WWB ALREADY EXISTS. IF ONE DOES THEN IT IS ON THE    */ 03777000
*/*  PROPER CHAIN.                                                   */ 03778000
*/*                                                                  */ 03779000
*/********************************************************************/ 03780000
*   IF XVD0WWB='0'B THEN            /* DO WE NEED TO GET A WWB       */ 03781000
         TM    XVD0,XVD0WWB                                             03782000
         BNZ   @RF00805                                                 03783000
*     DO;                           /* YES, GET IT AND PUT IT ON THE    03784000
*                                      CHAIN                         */ 03785000
*                                   /* BOTH R0 AND R1 WILL BE USED      03786000
*                                      FOR THE GETMAIN               */ 03787000
*       R0=GETWWB;                  /* PICK UP GETMAIN PARMS FOR WWB */ 03788000
         L     R0,GETWWB                                                03789000
*                                                                       03790000
         GETMAIN R,LV=(0),BRANCH=YES                                    03791000
*                                                                       03792000
*       XVWWB=R1;                   /* SAVE ADDR OF WWB              */ 03793000
         ST    R1,XVWWB                                                 03794000
*       XVD0WWB='1'B;               /* INDICATE WWB AVAILABLE        */ 03795000
         OI    XVD0,XVD0WWB                                             03796000
*                                   /* R1 DOES PT AT WWB. USE R1 */     03797000
*       WWBASCB=R7;                 /* STORE ADDR OF ASCB            */ 03798000
         USING WWB,R1                                                   03799000
         ST    R7,WWBASCB                                               03800000
*       WWBTCBAD=R4;                /* STORE ADDR OF TCB             */ 03801000
         ST    R4,WWBTCBAD                                              03802000
         DROP  R1                                                       03803000
*/********************************************************************/ 03804000
*/*                                                                  */ 03805000
*/* PUT WWB ON THE CHAIN                                             */ 03806000
*/*                                                                  */ 03807000
*/********************************************************************/ 03808000
*       /*************************************************************/ 03809000
*       /*                                                           */ 03810000
*       /* POINT THIS WWB AT WHATEVER OLD LAST WWB WAS POINTING AT   */ 03811000
*       /*                                                           */ 03812000
*       /*************************************************************/ 03813000
*       WWBFWDPT=CHNTAIL->WWBFWDPT;                                     03814000
         L     R10,@PC00004                                             03815000
         L     R8,0(,R10)                                               03816000
         L     R2,WWBFWDPT-WWB(,R8)                                     03817000
         ST    R2,WWBFWDPT-WWB(,R1)                                     03818000
*       CHNTAIL->WWBFWDPT=R1;       /* LINK LAST CHN MEMBER TO THIS     03819000
*                                      WWB                           */ 03820000
         ST    R1,WWBFWDPT-WWB(,R8)                                     03821000
*       WWBBCKPT=CHNTAIL;           /* PT OUR WWB BACK AT OLD LAST      03822000
*                                      WWB                           */ 03823000
         ST    R8,WWBBCKPT-WWB(,R1)                                     03824000
*       CHNTAIL=R1;                 /* PT END OF CHAIN AT OUR WWB    */ 03825000
         ST    R1,0(,R10)                                               03826000
*     END;                                                              03827000
*/********************************************************************/ 03828000
*/*                                                                  */ 03829000
*/*  NOW INDICATE ECB IS WAITING                                     */ 03830000
*/*                                                                  */ 03831000
*/********************************************************************/ 03832000
*   WWBPOSTD='0'B;                  /* INDICATE NOT POSTED           */ 03833000
@RF00805 L     R10,XVWWB                                                03834000
         USING WWB,R10                                                  03835000
         NI    WWBFLAGS,255-WWBPOSTD                                    03836000
*   WWBECB=0;                       /* READY TO BE POSTED            */ 03837000
         SLR   R8,R8                                                    03838000
         ST    R8,WWBECB                                                03839000
         DROP  R10                                                      03840000
*   CALL FREELOCK;                                                      03841000
         BAL   R14,FREELOCK                                             03842000
*   R1=ADDR(WWBECB);                /* LOAD ADDRESS OF ECB FOR WAIT  */ 03843000
         L     R1,XVWWB                                                 03844000
         LA    R1,WWBECB-WWB(,R1)                                       03845000
*   /*****************************************************************/ 03846000
*   /*                                                               */ 03847000
*   /* NOW CHECK WHICH MEMORY WE ARE IN AND ISSUE APPROPRIATE WAIT,  */ 03848000
*   /* LONG OR SHORT                                                 */ 03849000
*   /*                                                               */ 03850000
*   /*****************************************************************/ 03851000
*   IF ASCBASID=1 THEN              /* IF IN MEMORY ONE THEN ISSUE      03852000
*                                      SHORT WAIT AS WE ARE IN          03853000
*                                      COMMTASKS MEMORY              */ 03854000
         CLC   ASCBASID,KH1                                             03855000
         BNE   @RF00825                                                 03856000
*                                                                       03857000
         WAIT  ,ECB=(R1)                                                03858000
         B     @RC00825                                                 03859000
*                                                                       03860000
*   ELSE                            /* WE ARE NOT IN MEMORY ONE SO      03861000
*                                      ISSUE A LONG WAIT TO LET         03862000
*                                      COMMTASK PUT OUT SOME MESSAGES   03863000
*                                      AND FREE UP SOME WQES.        */ 03864000
@RF00825 DS    0H                                                       03865000
         WAIT  ,ECB=(R1),LONG=YES                                       03866000
*   CALL SETLOCK;                                                       03867000
@RC00825 BAL   R14,SETLOCK                                              03868000
*   RETURN;                                                             03869000
@ER00004 L     R14,@SA00004                                             03870000
         BR    R14                                                      03871000
*                                                                       03872000
*   END VWTOWAIT;                                                       03873000
*/*** END OF WAITCHN *************************************************/ 03874000
*                                                                       03875000
*/********************************************************************/ 03876000
*/*                                                                  */ 03877000
*/* THIS ROUTINE WILL FREE THE ORE POINTED AT BY XVOREAD. IT WILL    */ 03878000
*/* ALSO DECREASE THE COUNT OF ORES BY ONE TO ACCOUNT FOR THE ORE    */ 03879000
*/* JUST FREED.                                                      */ 03880000
*/*                                                                  */ 03881000
*/********************************************************************/ 03882000
*VWTOFORE:                                                              03883000
*                                                                       03884000
VWTOFORE ST    R14,12(,R13)                                             03885000
*   R0=UCMORECP;                    /* GET ORE CELL POOL ID          */ 03886000
         L     R14,CVTCUCB                                              03887000
         USING UCM,R14                                                  03888000
         L     R0,UCMORECP                                              03889000
         DROP  R14                                                      03890000
*   R1=XVOREAD;                     /* GET ADDRESS OF ORE            */ 03891000
         L     R1,XVOREAD                                               03892000
*   /*****************************************************************/ 03893000
*   /*                                                               */ 03894000
*   /* FREE THE ORE                                                  */ 03895000
*   /*                                                               */ 03896000
*   /*****************************************************************/ 03897000
*                                                                       03898000
         FREECELL CPID=(0),CELL=(1),BRANCH=YES                          03899000
*                                                                       03900000
*/********************************************************************/ 03901000
*/*                                                                  */ 03902000
*/* THIS ORE CELL MAY HAVE BEEN THE LAST ONE IN AN EXTENSION         */ 03903000
*/* IF SO THEN R15 IS SET TO 20 BY FREECELL. IF THIS CONDITON IS     */ 03904000
*/* FOUND THEN FREE THE EXTENSION. R0 AND R1 ARE SET BY FREECELL     */ 03905000
*/*                                                                  */ 03906000
*/********************************************************************/ 03907000
*   IF R15=20 THEN                  /* WAS CELL THE LAST IN AN          03908000
*                                      EXTENSION                     */ 03909000
         C     R15,KF20                                                 03910000
         BNE   @RF00837                                                 03911000
*     /***************************************************************/ 03912000
*     /*                                                             */ 03913000
*     /* YES, FREE THE EXTENSION                                     */ 03914000
*     /*                                                             */ 03915000
*     /***************************************************************/ 03916000
*                                                                       03917000
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                             03918000
*                                                                       03919000
*   UCMRQNR=UCMRQNR-1;              /* DECREASE COUNT OF ORES        */ 03920000
@RF00837 L     R10,CVTCUCB                                              03921000
         USING UCM,R10                                                  03922000
         LH    R8,UCMRQNR                                               03923000
         BCTR  R8,0                                                     03924000
         STH   R8,UCMRQNR                                               03925000
         DROP  R10                                                      03926000
*   END VWTOFORE;                                                       03927000
@ER00005 L     R14,12(,R13)                                             03928000
         BR    R14                                                      03929000
*                                                                       03930000
*/*** START OF SETLOCK  **********************************************/ 03931000
*/*                                                                  */ 03932000
*/*   SETLOCK - OBTAIN THE LOCAL AND CMS LOCK AND INSTALL AN FRR     */ 03933000
*/*                                                                  */ 03934000
*/********************************************************************/ 03935000
*/*                                                                  */ 03936000
*/*  SAVE R13 ACROSS SETLOCK                                         */ 03937000
*/*                                                                  */ 03938000
*/********************************************************************/ 03939000
*                                                                       03940000
*SETLOCK:                                                               03941000
*                                                                       03942000
SETLOCK  ST    R14,12(,R13)                                             03943000
         STM   R0,R1,20(R13)                                            03944000
         LR    R0,R11              SAVE BASE REGS                       03945000
         LR    R1,R12                                                   03946000
         LR    R2,R13              SAVE R13                             03947000
*                                                                       03948000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        X03949000
               RELATED=(UCM,IEAVVWTO(FREELOCK))                         03950000
*                                                                       03951000
         LR    R11,R0              RESTORE BASE REGS                    03952000
         LR    R12,R1                                                   03953000
         TM    PFLAG,NOCMSLOK      CMS LOCK NOT REQUESTED ?             03954000
         BNZ   SETLOCKA            YES, BRANCH                          03955000
*                                                                       03956000
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          X03957000
               RELATED=(UCM,IEAVVWTO(FREELOCK))                         03958000
*                                                                       03959000
         LR    R11,R0              RESTORE BASE REGS                    03960000
         LR    R12,R1                                                   03961000
*   /*****************************************************************/ 03962000
*   /*                                                               */ 03963000
*   /* FRR USES R11 AND R12 AS WORK REGS. THE PARM LIST POINTED TO   */ 03964000
*   /* BY ESTAEPRM IS ZEROED BY SETFRR                               */ 03965000
*   /*                                                               */ 03966000
*   /*****************************************************************/ 03967000
*   R13=UCMFRRAD;                   /* GET ADDR OF IEAVMFRR FROM UCM */ 03968000
SETLOCKA L     R13,CVTCUCB                                              03969000
         USING UCM,R13                                                  03970000
         L     R13,UCMFRRAD                                             03971000
         DROP  R13                                                      03972000
*                                                                       03973000
*   /*****************************************************************/ 03974000
*   /*                                                               */ 03975000
*   /* SET UP THE FRR PROTECTION FOR THIS MODULE                     */ 03976000
*   /*                                                               */ 03977000
*   /*****************************************************************/ 03978000
*                                                                       03979000
         SETFRR A,FRRAD=(R13),PARMAD=ESTAEPRM,WRKREGS=(R11,R12)         03980000
*                                                                       03981000
         LR    R11,R0                  RESTORE BASE REGS                03982000
         LR    R12,R1                                                   03983000
*                                                                       03984000
*        A NEW PARMLIST HAS BEEN CREATED BY THE SETFRR THAT             03985000
*        REPLACES THE ONE CREATED BY ESTAE                              03986000
*        INITIALIZE THE NEW PARMLIST                                    03987000
*                                                                       03988000
         L     R10,ESTAEPRM            R10 -> NEW PARMLIST IN FRR       03989000
         USING PARMLIST,R10                                             03990000
*   PARMRGAD=ADDR(REGSAVE);         /* STORE ADDR OF REGISTER SAVE      03991000
*                                      AREA INTO PARM LIST           */ 03992000
         LA    R1,REGSAVE                                               03993000
         ST    R1,PARMRGAD                                              03994000
*   PARMID=MODULEID;                /* INSERT LAST FOUR LETTERS OF      03995000
*                                      MODULE NAME                   */ 03996000
         MVC   PARMID,KCVWTO                                            03997000
         OI    PARMFLAG,PARMFRID       PROTECTED BY FRR                 03998000
*                                   /* SET BASE BACK TO ESTAE           03999000
*                                      PARMLIST                      */ 04000000
*   /*****************************************************************/ 04001000
*   /*                                                               */ 04002000
*   /* THE FOLLOWING PARMFRID FIELD IN THE ESTAE PARAMETER           */ 04003000
*   /* LIST IS SET TO ZERO TO GUARANTEE THAT RECOVERY WILL BE        */ 04004000
*   /* DONE ON BOTH THE ESTAE AND FRR LEVEL                          */ 04005000
*   /*                                                               */ 04006000
*   /*****************************************************************/ 04007000
*   PARMFRID='0'B;                  /* MODULE PROTECTED BY FRR AND      04008000
*                                      ESTAE                         */ 04009000
         LA    R1,EPARM                                                 04010000
         NI    PARMFLAG-PARMLIST(R1),255-PARMFRID                       04011000
*                                   /* RESTORE BASE TO FRR PARMLIST  */ 04012000
*   /*****************************************************************/ 04013000
*   /*                                                               */ 04014000
*   /* RESTORE THE REGISTERS FROM THE SETLOCK                        */ 04015000
*   /*                                                               */ 04016000
*   /*****************************************************************/ 04017000
*   R13=R2                          /* RESTORE SAVEAREA PTR          */ 04018000
         LR    R13,R2                                                   04019000
         L     R14,12(,R13)                                             04020000
         LM    R0,R1,20(R13)                                            04021000
         STM   R0,R15,REGRECOV         REFRESH STORED RECOVERY REGS     04022000
         BR    R14                     RETURN TO CALLER                 04023000
*                                                                       04024000
*/*** START OF FREELOCK **********************************************/ 04025000
*/*                                                                  */ 04026000
*/*   FREELOCK - FREE THE LOCAL AND CMS LOCKS AND REMOVE THE FRR     */ 04027000
*/*                                                                  */ 04028000
*/********************************************************************/ 04029000
*/********************************************************************/ 04030000
*/*                                                                  */ 04031000
*/*  SAVE R13 ACROSS FREEING OF LOCKS                                */ 04032000
*/*                                                                  */ 04033000
*/********************************************************************/ 04034000
*FREELOCK:                                                              04035000
FREELOCK STM   R14,R15,12(R13)                                          04036000
         ST    R1,24(,R13)                                              04037000
         STM   R11,R12,64(R13)                                          04038000
         LR    R2,R13                  SAVE R13 IN R2                   04039000
*                                   /* FREE THE FRR, USE R1 & R15 AS    04040000
*                                      WORK REGS                     */ 04041000
         SETFRR D,WRKREGS=(R1,R15)                                      04042000
*                                                                       04043000
         TM    PFLAG,NOCMSLOK          CMS LOCK HELD ?                  04044000
         BNZ   FREELOKA                NO, BRANCH                       04045000
*                                                                       04046000
         SETLOCK RELEASE,TYPE=CMS,RELATED=(UCM,IEAVVWTO(SETLOCK))       04047000
*                                                                       04048000
FREELOKA SETLOCK RELEASE,TYPE=LOCAL,RELATED=(UCM,IEAVVWTO(SETLOCK))     04049000
*                                                                       04050000
*        NOW RELYING ON ESTAE PROTECTION AS FRR DELETED                 04051000
*                                                                       04052000
*   ESTAEPRM=ADDR(EPARM);           /* RESTORE PARMLIST ADDR TO      */ 04053000
         LA    R10,EPARM            /* ORIGINAL ESTAE PARAMETER LIST */ 04054000
         ST    R10,ESTAEPRM                                             04055000
*   PARMFRID='0'B;                  /* SIGNAL FRR NO LONGER IN PLACE    04056000
*                                      TO ESTAE                      */ 04057000
         NI    PARMFLAG,255-PARMFRID                                    04058000
         LR    R13,R2                  RESTORE R13                      04059000
*   END FREELOCK;                                                       04060000
         LM    R14,R15,12(R13)                                          04061000
         L     R1,24(,R13)                                              04062000
         LM    R11,R12,64(R13)                                          04063000
         STM   R0,R15,REGRECOV         REFRESH STORED RECOVERY REGS     04064000
         BR    R14                                                      04065000
*                                                                       04066000
*/********************************************************************/ 04067000
*/* POSTOECB - THIS ROUTINE SETS UP THE INTERFACE NECESSARY          */ 04068000
*/*            TO BRANCH ENTER XMPOST WITH AN INDICATOR SET          */ 04069000
*/*            TO RUN THE ERRET ROUTINE IN THE MASTER                */ 04070000
*/*            SCHEDULER ADDRESS SPACE                               */ 04071000
*/********************************************************************/ 04072000
*POSTOECB:                                                              04073000
POSTOECB STM   R14,R12,@SA00008                                         04074000
*   R15=CVT0PT01;                   /* GET ENTRY POINT ADDRESS FOR      04075000
*                                      BRANCH ENTRY TO XMPOST        */ 04076000
         L     R15,CVT0PT01                                             04077000
*   R1=0;                           /* CLEAR R1                      */ 04078000
         SLR   R1,R1                                                    04079000
*   R1=R1 '80000000'X;              /* SET UP R1 FOR USE AS BIT         04080000
*                                      MASK TO PREVENT THE NEED FOR A   04081000
*                                      REFERENCE TO STORAGE ONCE THE    04082000
*                                      BASEREG HAS BEEN UPDATED      */ 04083000
         O     R1,KX800000                                              04084000
*   R10=0;                          /* COMPLETION CODE WITH WHICH TO    04085000
*                                      POST UCMOECB                  */ 04086000
         SLR   R10,R10                                                  04087000
*   R13=UCMASCB;                    /* ASCB OF MEMORY CONTAINING ECB    04088000
*                                      TO BE POSTED                  */ 04089000
         L     R14,CVTCUCB                                              04090000
         USING UCM,R14                                                  04091000
         L     R13,UCMASCB                                              04092000
*   R11=ADDR(UCMOECB);              /* POST THE WTO ECB IN COMTASK   */ 04093000
         LA    R11,UCMOECB                                              04094000
*   R11=R11 R1;                     /* SET END OF LIST               */ 04095000
         OR    R11,R1                                                   04096000
*   R12=UCMWAKUP;                   /* IF XMPOST ERROR LET IEAVMEST     04097000
*                                      GET CONTROL                   */ 04098000
         L     R12,UCMWAKUP                                             04099000
         DROP  R14                                                      04100000
*   R12=R12 R1;                     /* SET BIT TO SHOW ERRET IS TO      04101000
*                                      RUN IN MASTER SCHEDULER MEMORY*/ 04102000
         OR    R12,R1                                                   04103000
*                                   /* POST COMTASK                  */ 04104000
         BALR  R14,R15                                                  04105000
*   RETURN;                         /* RETURN TO MAINLINE            */ 04106000
         LM    R14,R12,@SA00008                                         04107000
         BR    R14                                                      04108000
*                                                                       04109000
*   END POSTOECB;                                                       04110000
*   END                                                                 04111000
*                                                                       04112000
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM      */ 04113000
*/*%INCLUDE SYSLIB  (IHACTM  )                                       */ 04114000
*/*%INCLUDE SYSLIB  (IEFJSSOB)                                       */ 04115000
*/*%INCLUDE SYSLIB  (IEFSSOBH)                                       */ 04116000
*/*%INCLUDE SYSLIB  (IEFSSWT )                                       */ 04117000
*/*%INCLUDE SYSLIB  (IEFJESCT)                                       */ 04118000
*/*%INCLUDE SYSLIB  (IHAORE  )                                       */ 04119000
*/*%INCLUDE SYSLIB  (IHAWQE  )                                       */ 04120000
*/*%INCLUDE SYSLIB  (IEZWPL  )                                       */ 04121000
*/*%INCLUDE SYSLIB  (IEECUCM )                                       */ 04122000
*/*%INCLUDE SYSLIB  (IHAFRRS )                                       */ 04123000
*/*%INCLUDE SYSLIB  (IEEBASEA)                                       */ 04124000
*/*%INCLUDE SYSLIB  (IHAESTA )                                       */ 04125000
*/*%INCLUDE SYSLIB  (IHARB   )                                       */ 04126000
*/*%INCLUDE SYSLIB  (IKJRB   )                                       */ 04127000
*/*%INCLUDE SYSLIB  (IKJTCB  )                                       */ 04128000
*/*%INCLUDE SYSLIB  (IHAASVT )                                       */ 04129000
*/*%INCLUDE SYSLIB  (IHAASCB )                                       */ 04130000
*/*%INCLUDE SYSLIB  (IHAPSA  )                                       */ 04131000
*/*%INCLUDE SYSLIB  (CVT     )                                       */ 04132000
*/*%INCLUDE SYSLIB  (IHASCVT )                                       */ 04133000
*                                                                       04134000
@SM03493 MVC   USERTEXT(0),4(R15)      MOVE MESSAGE TEXT TO EXIT PARM   04135000
*                                                                       04136000
@SM03498 MVC   0(0,R1),0(R14)          MOVE TEXT INTO WQETXT            04137000
         DROP  R6                                                       04138000
*                                                                       04139000
@AL00348 DC    A(KF2)                  LIST WITH   1 ARGUMENT(S)        04140000
@AL00392 DC    A(KF1)                  LIST WITH   1 ARGUMENT(S)        04141000
*                                                                       04142000
KF1      DC    F'1'                                                     04143000
KH1      EQU   KF1+2                                                    04144000
KF2      DC    F'2'                                                     04145000
KF4      DC    F'4'                                                     04146000
KH4      EQU   KF4+2                                                    04147000
KF5      DC    F'5'                                                     04148000
KF6      DC    F'6'                                                     04149000
KF8      DC    F'8'                                                     04150000
KH8      EQU   KF8+2                                                    04151000
KH9      DC    H'9'                                                     04152000
KH16     DC    H'16'                                                    04153000
KF20     DC    F'20'                                                    04154000
KH20     EQU   KF20+2                                                   04155000
KF127    DC    F'127'                                                   04156000
KF4096   DC    F'4096'                                                  04157000
KFM1     DC    F'-1'                                                    04158000
KX800000 DC    XL4'80000000'                                            04159000
         DC    0F'0'                                                    04160000
@SIZDATD DC    AL1(229)                SUBPOOL 229 PRIVATE AREA         04161000
         DC    AL3(@ENDDATD-@DATD)     WORK AREA SIZE FOR GETMAIN       04162000
*                                                                       04163000
*        ROUTINES CALLED BY IEAVVWTO                                    04164000
*                                                                       04165000
VIEAVMWT DC    V(IEAVMWTO)             MULTI-LINE WTO                   04166000
VIEECVXT DC    V(IEECVXIT)             USER EXIT                        04167000
VIGC0203 DC    V(IGC0203E)             WTP                              04168000
*                                                                       04169000
LENMAXT  DC    F'129'                  L'MAXIMUM TEXT PERMITTED + 4     04170000
ABNDCODE DC    XL4'00000D23'                                            04171000
KCVWTO   DC    C'VWTO'                                                  04172000
KCSSOB   DC    C'SSOB'                                                  04173000
KCPLUS   DC    C' +'                                                    04174000
KXFFFF   DC    X'FFFF'                                                  04175000
KX8000   DC    X'8000'                                                  04176000
KX0200   DC    X'0200'                                                  04177000
HEXCHAR  DC    CL16'0123456789ABCDEF'                                   04178000
PATTIME  DC    XL9'4021214B21214B2121'  ED PATTERN FOR TIME             04179000
*                                                                       04180000
*        GETMAIN PARAMETER LIST FOR WWB                                 04181000
*                                                                       04182000
GETWWB   DC    0F'0'                   GETMAIN/FREEMAIN FOR WWB EXTENT  04183000
         DC    AL1(231)                SUBPOOL                          04184000
         DC    AL3(WWBSIZE)            SIZE                             04185000
*                                                                       04186000
*        GETMAIN/FREEMAIN FOR ORE EXTENT                                04187000
*                                                                       04188000
FROREXT  DC    0F'0'                   GETMAIN/FREEMAIN FOR ORE EXTENT  04189000
         DC    AL1(231)                                                 04190000
         DC    AL3(1024)                                                04191000
*                                                                       04192000
*        GETMAIN/FREEMAIN FOR WQE EXTENT                                04193000
*                                                                       04194000
FRWQEXT  DC    0F'0'                   GETMAIN/FREEMAIN FOR WQE EXTENT  04195000
         DC    AL1(231)                                                 04196000
         DC    AL3(4096)                                                04197000
*                                                                       04198000
GETSP231 DC    0F'0'                                                    04199000
         DC    AL1(231)                                                 04200000
         DC    AL3(20+16)                                               04201000
*                                                                       04202000
IDMAP    DC    X'80'                                                    04203000
         DC    X'40'                                                    04204000
         DC    X'20'                                                    04205000
         DC    X'10'                                                    04206000
         DC    X'08'                                                    04207000
         DC    X'04'                                                    04208000
         DC    X'02'                                                    04209000
         DC    X'01'                                                    04210000
*                                                                       04211000
*        TRANSLATE ALL UNPRINTABLE CHARS TO HEX A1                      04212000
*                                                                       04213000
TRTAB    DC    X'40A1A1A1A1A1A1A1'      ~~~~~~~   00 -> 07              04214000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   08 -> 0F              04215000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   10 -> 17              04216000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   18 -> 1F              04217000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   20 -> 27              04218000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   28 -> 2F              04219000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   30 -> 37              04220000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   38 -> 3F              04221000
         DC    X'40A1A1A1A1A1A1A1'      ~~~~~~~   40 -> 47              04222000
         DC    X'A1A14A4B4C4D4E4F'     ~~>.<(+|   48 -> 4F              04223000
         DC    X'50A1A1A1A1A1A1A1'     &~~~~~~~   50 -> 57              04224000
         DC    X'A1A15A5B5C5D5E5F'     ~~!$*);^   58 -> 5F              04225000
         DC    X'6061A1A1A1A1A1A1'     -/~~~~~~   60 -> 67              04226000
         DC    X'A1A16A6B6C6D6E6F'     ~~|,%_>?   68 -> 6F              04227000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   70 -> 77              04228000
         DC    X'A1797A7B7C7D7E7F'     ~`:#@'="   78 -> 7F              04229000
         DC    X'A181828384858687'     ~ABCDEFG   80 -> 87              04230000
         DC    X'8889A1A1A1A1A1A1'     HI~~~~~~   88 -> 8F              04231000
         DC    X'A191929394959697'     ~JKLMNOP   90 -> 97              04232000
         DC    X'9899A1A1A1A1A1A1'     QR~~~~~~   98 -> 9F              04233000
         DC    X'A1A1A2A3A4A5A6A7'     ~~STUVWX   A0 -> A7              04234000
         DC    X'A8A9A1A1A1ADA1A1'     YZ~~~[~~   A8 -> AF              04235000
         DC    X'A1A1A1A1A1A1A1A1'     ~~~~~~~~   B0 -> B7              04236000
         DC    X'A1A1A1A1A1BDA1A1'     ~~~~~]~~   B8 -> BF              04237000
         DC    X'C0C1C2C3C4C5C6C7'     {ABCDEFG   C0 -> C7              04238000
         DC    X'C8C9A1A1A1A1A1A1'     HI~~~~~~   C8 -> CF              04239000
         DC    X'D0D1D2D3D4D5D6D7'     }JKLMNOP   D0 -> D7              04240000
         DC    X'D8D9A1A1A1A1A1A1'     QR~~~~~~   D8 -> DF              04241000
         DC    X'E0A1E2E3E4E5E6E7'     \~STUVWX   E0 -> E7              04242000
         DC    X'E8E9A1A1A1A1A1A1'     YZ~~~~~~   E8 -> EF              04243000
         DC    X'F0F1F2F3F4F5F6F7'     01234567   F0 -> F7              04244000
         DC    X'F8F9A1A1A1A1A1A1'     89~~~~~~   F8 -> FF              04245000
*                                                                       04246000
*        ESTAE SVC PARAMETER LIST                                       04247000
*                                                                       04248000
ESTAELST ESTAE  ,MF=L                                                   04249000
ESTAELEN EQU   *-ESTAELST              L'ESTAE PARAMETER LIST           04250000
*                                                                       04251000
MVCTEXT  MVC   WKATEXT+4(0),0(R8)                                       04252000
*                                                                       04253000
         USING WQE,R8                                                   04254000
TRINST   TR    WQETXT(0),TRTAB         TRANSLATE ALL UNPRINTABLES       04255000
         DROP  R8                                                       04256000
*                                                                       04257000
*        WORK AREA IN GETMAINED PRIVATE AREA STORAGE SUBPOOL 229        04258000
*                                                                       04259000
@DATD    DSECT                                                          04260000
@SA00001 DS    18F                                                      04261000
@SAGETB  DS    18F                                                      04262000
@PC00003 DS    F                                                        04263000
@SA00004 DS    F                                                        04264000
@PC00004 DS    F                                                        04265000
@SA00008 DS    15F                                                      04266000
@SA00002 DS    15F                                                      04267000
@PC00002 DS    F                                                        04268000
PARMPTR  DS    A                                                        04269000
@TF00001 DS    F                                                        04270000
REG1SAV  DS    F                                                        04271000
REG2SAV  DS    F                  SAVE AREA FOR R2 WHEN DEALING WITH    04272000
*                                 UCM (PREVIOUSLY USED XVA4)            04273000
LONGTXT  DS    A                  -> AREA GETMAINED FOR LONG WPL        04274000
*                                    IF ZERO THEN NO STORAGE GETMAINED  04275000
LONGLEN  DS    F                  L'GETMAINED AREA FOR LONG TEXT        04276000
*                                                                       04277000
LENMWQE  DS    F                  L'OF ALL MINOR WQES                   04278000
*                                 VALID ONLY FOR MLWTO                  04279000
MLWTOXH  DS    A                  -> MLWTO EXTENT HEADER IN CALLERS WPL 04280000
*                                 VALID ONLY FOR MLWTO                  04281000
*                                                                       04282000
*        VERSION 2 XWPL TO STORE ALL USER PROVIDED WPL FIELDS           04283000
*                                                                       04284000
WKALGH   DS    AL2                MESSAGE LENGTH OF MAJOR WQE TEXT FROM 04285000
*                                 CALLER'S WPL                          04286000
WKAMCSF  DS    XL2                MCS FLAGS COPIED FROM CALLERS WPL     04287000
WKAADTXT DS    AL4                -> MESSAGE TEXT                       04288000
WKAVRSN  DS    AL1                XWPL VERSION NUMBER                   04289000
WKAFLAGS DS    XL1                MISC FLAGS                            04290000
WKARPYLN DS    AL1                L'REPLY FOR WTOR                      04291000
WKALNGTH DS    AL1                L'XWPL, ZERO FOR VERSION 1            04292000
WKAMCSF1 DS    XL2                EXTENDED MCS FLAGS                    04293000
WKACPFLF DS    XL2                MCS FLAGS FOR CNTL PROGRAM USE        04294000
WKARPBUF DS    AL4                -> REPLY BUFFER                       04295000
WKAECBP  DS    AL4                -> ECB                                04296000
WKASEQN  DS    AL4                DOM/CONNECT ID                        04297000
WKADSC   DS    XL2             *  DESCRIPTOR CODE TO BE USED IN WTO     04298000
WKAROC   DS    XL2             V  ROUTE CODES TO BE USED IN WTO         04299000
WKAROUT  DS    XL14               EXTENDED ROUTING CODES                04300000
WKAMSGTY DS    XL2                MSGTYPE FLAGS COPIED FROM CALLERS WPL 04301000
WKAPRTY  DS    XL2                MESSAGE PRIORITY                      04302000
WKAJOBID DS    CL8                JOB ID                                04303000
WKAJOBNM DS    CL8                JOB NAME                              04304000
WKAKEY   DS    CL8                RETRIEVAL KEY                         04305000
WKATOKN  DS    AL4                TOKEN FOR DOM                         04306000
WKACNID  DS    AL4                CONSOLE ID                            04307000
WKASYSNA DS    CL8                SYSTEM NAME                           04308000
WKACNNME DS    CL8                CONSOLE NAME                          04309000
WKARCNA  DS    AL4                -> REPLY CONSOLE NAME/ID              04310000
WKACART  DS    AL4                -> CART                               04311000
WKAWSPRM DS    AL4                -> WAIT STATE PARM LIST               04312000
WKAASCB  DS    AL4                -> ASCB                               04313000
WKARSV30 DS    XL16               RESERVED                              04314000
*                                                                       04315000
WKATEXT  DS    CL129              MESSAGE TEXT (MAXIMUM 125 CHARS) +4   04316000
*                                                                       04317000
ESTAEPRM DS    A                  -> USER PARAMETER LIST PASSED TO      04318000
*                                    IEAVMFRR ESTAE/FRR EXIT            04319000
@TS00001 DS    CL1                                                      04320000
STARTID  DS    CL1                                                      04321000
CVDAREA  DS    D                                                        04322000
*                                                                       04323000
PFLAG    DS    XL1                ADDITIONAL FLAGS                      04324000
NOCMSLOK EQU   X'40'              DO NOT REQUEST OR FREE CMS LOCK       04325000
*                                                                       04326000
*        PARAMETER LIST FOR WTO USER EXIT IEECVXIT                      04327000
*                                                                       04328000
         DS    0F                                                       04329000
USERPARM DS    0CL136                                                   04330000
USERTEXT DS    CL128                                                    04331000
USERROUT DS    0CL4                                                     04332000
USERRC   DS    XL2                                                      04333000
         DS    XL2                      RESERVED                        04334000
USERDESC DS    0CL4                                                     04335000
USERDC   DS    XL2                                                      04336000
         DS    XL2                      RESERVED                        04337000
*                                                                       04338000
*        MAPPED BY IEFSSOBH                                             04339000
*                                                                       04340000
SSOB     DS    0CL20                                                    04341000
SSOBID   DS    CL4                                                      04342000
SSOBLEN  DS    FL2                                                      04343000
SSOBFUNC DS    FL2                                                      04344000
SSOBSSIB DS    AL4                                                      04345000
SSOBRETN DS    AL4                                                      04346000
SSOBINDV DS    AL4                                                      04347000
*                                                                       04348000
SSWT     DS    0CL16                                                    04349000
SSWTLEN  DS    FL2                                                      04350000
@NM00012 DS    FL2                                                      04351000
SSWTWQE  DS    AL4                                                      04352000
SSWTMIN  DS    AL4                                                      04353000
SSWTORE  DS    AL4                                                      04354000
*                                                                       04355000
*        ESTAE ROUTINE PARAMETER AREA                                   04356000
*                                                                       04357000
*        MAPPED BY PARMLIST DSECT                                       04358000
*                                                                       04359000
*        PASSED TO ESTAE/FRR EXIT IN SDWAPARM                           04360000
*                                                                       04361000
EPARM    DS    6F                                                       04362000
*                                                                       04363000
*        REGISTER RESTORE FLAGS AND REGISTER SAVE AREA                  04364000
*        USED BY COMM TASK FRR IEAVMFRR                                 04365000
*                                                                       04366000
         CNOP  2,4                *    FORCE HALFWORD ALIGNMENT         04367000
REGSAVE  DS    0CL66              |                                     04368000
REGRGMAP DS    H                  |                                     04369000
REGRECOV DS    16F                V                                     04370000
*                                                                       04371000
@ENDDATD EQU   *                                                        04372000
*                                                                       04373000
*        CVT                                                            04374000
*                                                                       04375000
         CVT   DSECT=YES                                                04376000
*                                                                       04377000
*        TCB                                                            04378000
*                                                                       04379000
         IKJTCB LIST=YES                                                04380000
*                                                                       04381000
*        RB                                                             04382000
*                                                                       04383000
         IKJRB   DSECT=YES                                              04384000
*/********************************************************************/ 04385000
*/*                                                                  */ 04386000
*/*          EXTENDED SAVEAREA MAPPING FOR SVC 35                    */ 04387000
*/*                                                                  */ 04388000
*/********************************************************************/ 04389000
*                                                                       04390000
*        DEFINED IN THE RBEXSAVE AREA                                   04391000
*                                                                       04392000
         ORG   RBEXSAVE                                                 04393000
XVSAV    DS    0A                                                       04394000
XVA4     DS    0F                      ERROR PROCESSING FIELDS          04395000
XVFNCT   DS    C                       D23 PROCESS CODE                 04396000
D23VALID EQU   X'10'                   PARMLIST VALIDITY CHECK          04397000
D23OREGC EQU   X'20'                   ORE GETCELL FAILURE              04398000
D23OREBC EQU   X'21'                   ORE BLDCPOOL FAILURE             04399000
D23OREGM EQU   X'22'                   ORE GETMAIN FAILURE, SP231       04400000
D23WQEGC EQU   X'30'                   WQE GETCELL FAILURE              04401000
D23WQEBC EQU   X'31'                   WQE BLDCPOOL FAILURE             04402000
D23WQEGM EQU   X'32'                   WQE GETMAIN FAILURE, SP231       04403000
D23DYN   EQU   X'42'                   DYNAMIC AREA GETMAIN FAILURE     04404000
XVAMOD   DS    C                       D23 MODULE ID                    04405000
VWTOID   EQU   X'01'                   IEAVVWTO'S ID FOR D23            04406000
MWTOID   EQU   X'02'                   IEAVMWTO'S ID FOR D23            04407000
XVA41    DS    C                       RESERVED                         04408000
XVREASON DS    C                       D23 REASON CODE                  04409000
D23BNDY  EQU   X'01'                   WTOR PARMLIST NOT ON WORD BNDY   04410000
D23MLWTR EQU   X'02'                   MULTILINE WTOR SPECIFIED         04411000
D23PARM  EQU   X'03'                   WPL NOT ADDRESSABLE BY USER      04412000
D23ZERO  EQU   X'04'                   ZERO TEXT LENGTH WTOR            04413000
D23CMOD  EQU   X'05'                   CALLER MODIFIED WPL              04414000
*                                      DURING WTO PROCESSING            04415000
D23LTXT  EQU   X'06'                   WTO/WTOR TEXT= CODED AND         04416000
*                                      WPLLGH ^=8                       04417000
*                                                                       04418000
XVA8     DS    AL4                     STORE TIME                       04419000
XVWPLADR DS    AL4                     -> CALLERS WPL                   04420000
XVWQEAD  DS    AL4                                                      04421000
*                                                                       04422000
*        FLAGS                                                          04423000
*                                                                       04424000
XVDFLAGS DS    0XL4                                                     04425000
XVD0     DS    X                                                        04426000
XVD0RPFD EQU   BIT1                    HARD COPY ONLY                   04427000
XVD0NWQE EQU   BIT2                    GET WQE                          04428000
XVD0NORE EQU   BIT3                    GET THE ORE FIRST                04429000
XVD0QID  EQU   BIT4                    QID FIELD IS PRESENT IN THE WPL  04430000
XVD0WWB  EQU   BIT5                    WWB WTO WAIT BLOCK OBTAINED      04431000
XVD0USER EQU   BIT6                                                     04432000
XVD0HDCY EQU   BIT7                                                     04433000
*                                                                       04434000
*        XVDFLAGS+1                                                     04435000
*                                                                       04436000
XVD1     DS    X                                                        04437000
XVD1PRIV EQU   BIT0                    PRIVILEGED USER                  04438000
XVD1ENQW EQU   BIT1                    ENQ'D ON A WQE  (VMWTO)          04439000
XVD1ENQO EQU   BIT2                    ENQ'D ON AN ORE (VMWTO)          04440000
XVD1ALDN EQU   BIT2                    ALL NEEDED CONTROL BLKS OBTAINED 04441000
XVD1PP   EQU   BIT5                    PROBLEM PROGRAM CALLER           04442000
XVD1AUTH EQU   BIT6                    KEY 0, SUPVR STATE OR APF AUTH   04443000
XVD1PERR EQU   BIT7                    SEVERE ERROR FOUND. ABEND USER   04444000
*                                                                       04445000
*        XVDFLAGS+2                                                     04446000
*                                                                       04447000
XVD2     DS    X                                                        04448000
XVD2CON  EQU   BIT0                    CONNECTING                       04449000
XVD2VALD EQU   BIT3                    PARAMETER LIST IS VALID          04450000
XVD2DELW EQU   BIT4                    SEND MSG TO HARDCOPY ONLY        04451000
XVD2ZERO EQU   BIT5                    ZERO MSG ID TO USER              04452000
XVD2WTOR EQU   BIT6                    WTOR REQUEST                     04453000
XVD2QFHC EQU   BIT7                    QUEUE THIS MSG TO HARD COPY      04454000
*                                                                       04455000
*        XVDFLAGS+3                                                     04456000
*                                                                       04457000
XVD3     DS    X                                                        04458000
XVD3BLDJ EQU   BIT0                    BUILD MAJOR WQE                  04459000
XVD3BLD1 EQU   BIT1                    BUILD LINE 1                     04460000
XVD3BLD2 EQU   BIT2                    BUILD LINE 2                     04461000
XVD3TXT1 EQU   BIT3                    TEXT LINE 1 BEING USED           04462000
XVD3TFX  EQU   BIT4                    TCBTFX WAS SET ON,TURN IT OFF    04463000
*        END OF FLAGS                                                   04464000
XVOREAD  DS    AL4                                                      04465000
         ORG   XVOREAD                                                  04466000
XVX      DS    0F                      USED AS WORK AREA BY VMWTO       04467000
XVX0     DS    X                       LINE CONTROL FLAGS - MLWTO       04468000
XVX0FLCL EQU   BIT0                    FIRST LINE IS CONTROL LINE       04469000
XVX0LL1F EQU   BIT1                    LABEL LINE 1 FOUND               04470000
XVX0LL2F EQU   BIT2                    LABEL LINE 2 FOUND               04471000
XVX0UDCL EQU   BIT3                    USE DEFAULT CONTROL LINE         04472000
XVX0FLJE EQU   BIT4                    FIRST LINE JUST 'E'              04473000
XVX0FEDE EQU   BIT5                    FORCE END (LAST LINE TO BE DE)   04474000
XVX1     DS    X                       ERROR FLAGS - MLWTO              04475000
XVX1STOP EQU   BIT0                    ERROR IN PARM LIST; IGNORE MLWTO 04476000
XVX1NOID EQU   BIT1                    NO ID FOR CONNECTING MLWTO       04477000
XVX2     DS    AL1                     NO OF LINES STILL TO DO          04478000
XVX3     DS    AL1                     NO OF LINES FROM MLWTO EXT HDR   04479000
*                                                                       04480000
XVCMAJOR DS    AL4                                                      04481000
XVCMINOR DS    AL4                                                      04482000
*                                                                       04483000
XVWWB    DS    AL4                                                      04484000
*                                                                       04485000
XVWQEID  DS    0AL4       *                                             04486000
XVWQEIDA DS    AL3        |            A NEW LINE IS TO BE              04487000
*                         |            CONNECTED TO THE MESSAGE         04488000
*                         |            WITH THIS 3 BYTE MESSAGE ID      04489000
*                         |            MLWTO ONLY                       04490000
XVCONID  DS    XL1        V            CONSOLE ID FOR THIS MESSAGE      04491000
*                                                                       04492000
XVRET    DS    0AL4                                                     04493000
XVRETCOD DS    AL4                                                      04494000
XVLEN    EQU   *-XVSAV                 MUST NOT EXCEED 48 BYTES AS      04495000
*                                      RB EXTENDED SAVE AREA USED       04496000
*                                                                       04497000
*        CONSOLE UNIT CONTROL MODULE                                    04498000
*                                                                       04499000
         IEECUCM DSECT=YES,FORMAT=NEW                                   04500000
*                                                                       04501000
*        IEAVMFRR USER'S PARM LIST                                      04502000
*                                                                       04503000
         IHACTM FTPT                                                    04504000
*                                                                       04505000
*        WRITE TO OPERATOR WAIT BLOCK MAPPING                           04506000
*                                                                       04507000
         IHACTM WWB                                                     04508000
*                                                                       04509000
*        FUNCTIONAL RECOVERY ROUTINE STACK                              04510000
*                                                                       04511000
         IHAFRRS                                                        04512000
*                                                                       04513000
*        OPERATOR REPLY ELEMENT                                         04514000
*                                                                       04515000
         IHAORE                                                         04516000
*                                                                       04517000
*        WRITE-TO-OPERATOR QUEUE ELEMENT                                04518000
*                                                                       04519000
         IHAWQE FORMAT=NEW                                              04520000
*                                                                       04521000
*        WTO/WTOR/MLWTO/WTP PARAMETER LIST                              04522000
*                                                                       04523000
         IEZWPL                                                         04524000
*                                                                       04525000
         PRINT NOGEN                                                    04526000
*                                                                       04527000
*        MASTER SCHEDULER RESIDENT DATA AREA                            04528000
*                                                                       04529000
         IEEBASEA                                                       04530000
*                                                                       04531000
*        PREFIXED SAVE AREA                                             04532000
*                                                                       04533000
         IHAPSA                                                         04534000
*                                                                       04535000
*        ADDRESS SPACE CONTROL BLOCK                                    04536000
*                                                                       04537000
         IHAASCB                                                        04538000
*                                                                       04539000
*        JOB ENTRY SUBSYSTEM COMMUNICATION TABLE                        04540000
*                                                                       04541000
         IEFJESCT                                                       04542000
*                                                                       04543000
         PRINT GEN                                                      04544000
*                                                                       04545000
IEAVVWTO CSECT                                                          04546000
R0       EQU   0                                                        04547000
R1       EQU   1                                                        04548000
R2       EQU   2                                                        04549000
R3       EQU   3                                                        04550000
R4       EQU   4                                                        04551000
R5       EQU   5                                                        04552000
R6       EQU   6                                                        04553000
R7       EQU   7                                                        04554000
R8       EQU   8                                                        04555000
R9       EQU   9                                                        04556000
R10      EQU   10                                                       04557000
R11      EQU   11                                                       04558000
R12      EQU   12                                                       04559000
R13      EQU   13                                                       04560000
R14      EQU   14                                                       04561000
R15      EQU   15                                                       04562000
*                                                                       04563000
         END   IEAVVWTO                                                 04564000
./ ADD NAME=IGC0203E
IGC      TITLE 'IGC0203E/IEEJB840 - WRITE TO PROGRAMMER'                00001000
*                                                                       00002000
IGC0203E CSECT                                                          00003000
*                                                                       00004000
*        STATUS -                                                       00005000
*        LASTUPD         = JCLIN    TYPE=UPD                            00006000
*        LIBRARIES       = DISTLIB=AOSB3                                00007000
*        FMID            = EBB1102                                      00008000
*        RMID            = UY13810                                      00009000
*        CSECT           = IGC0203E                                     00010000
*        LMOD            = IGC0003E                                     00011000
*        SYSMOD HISTORY  = SYSMOD   TYPE       DATE   MCS  STATUS       00012000
*                          EBB1102  FUNCTION  00.000  MOD      ACC RGN  00013000
*                          UY13810  PTF       74.164  MOD  APP ACC      00014000
*                                                                       00015000
*        ORIGINAL SOURCE FROM MVSSRC.SYM101.F13 WAS UPDATED             00016000
*        BY DISASSEMBLY TO MATCH THE LOAD MODULE AT THE UY13810         00017000
*        LEVEL                                                          00018000
*                                                                       00019000
*        CHANGE ACTIVITY -                                              00020000
*               ZP60040  - 1. SUPPORT FOR THE EXTENDED WPL              00021000
*                             PARAMETER LIST TO ENABLE THE USE OF       00022000
*                             THE TEXT OPERAND                          00023000
*                          2. LOCALIZED CODE OPTIMZATION                00024000
*                                                                       00025000
*        FUNCTION -                                                     00026000
*        CALLED BY IEAVVWTO (SVC 35) TO PROCESS WRITE TO PROGRAMMER     00027000
*        ROUTE CODE 11 MESSAGES BY WRITING THE MESSAGE TO THE           00028000
*        SYSTEM MESSAGE DATA SET. IT THE CALLER IS A TSO USER AND       00029000
*        HAS REQUESTED WTP MESSAGES IN THE USERS PROFILE TABLE THEN     00030000
*        THE MESSAGE IS ISSUED AS A TPUT TO THE USER                    00031000
*                                                                       00032000
*        REGISTERS ON ENTRY -                                           00033000
*        R4  -> TCB                                                     00034000
*        R5  -> SVRB WITH EXTENDED SAVE AREA USED                       00035000
*        R7  -> ASCB                                                    00036000
*        R14    RETURN ADDR TO IEAVVWTO                                 00037000
*        R15  = ENTRY                                                   00038000
*                                                                       00039000
         SAVE  (14,12),,'IGC0203E ZP60040 &SYSDATE &SYSTIME'            00040000
*                                                                       00041000
         LA    R11,0(,R15)                                              00042000
         USING IGC0203E,R11                                             00043000
         L     R0,WORKIGCG             R0 = L'WORKIGC                   00044000
         LR    R9,R0                   SAVE LENGTH FOR LATER AREA ZERO  00045000
*                                                                       00046000
*        GETMAIN WORKAREA IN SUBPOOL 231                                00047000
*                                                                       00048000
         GETMAIN R,LV=(0)                                               00049000
*                                                                       00050000
         LR    R8,R1                   R8 -> GETMAINED AREA             00051000
*                                      R9  = L'GETMAINED AREA           00052000
         SLR   R15,R15                 NO COPY, PAD OF ZERO             00053000
         MVCL  R8,R14                  ZERO WORKAREA                    00054000
         ST    R1,8(,R13)              CHAIN SAVE AREAS                 00055000
         ST    R13,4(,R1)                                               00056000
         LR    R10,R13                 R10 -> IEAVVWTO WORKAREA         00057000
         USING WORKVV,R10                                               00058000
         LR    R13,R1                                                   00059000
         USING WORKIGC,R13                                              00060000
*                                                                       00061000
         LR    R12,R5                                                   00062000
         USING RBBASIC,R12                                              00063000
         L     R3,CVTPTR                                                00064000
         USING CVT,R3                                                   00065000
         MVC   ADDRUCM,CVTCUCB         SAVE -> UCM IN ADDRUCM           00066000
         DROP  R3                                                       00067000
         ST    R4,TCBADDR                                               00068000
         L     R1,ADDRUCM                                               00069000
         USING UCM,R1                                                   00070000
         CLC   UCMCTID,ASCBASID-ASCB(R7)  CALLER WAS COMM TASK ?        00071000
         BE    @RF00148                YES, BRANCH                      00072000
         DROP  R1                                                       00073000
*   CALL GETESTAE;                  /* NO, CREATE STAE ENVIRONMENT   */ 00074000
         BAL   R14,GETESTAE                                             00075000
*   IF R15=0 THEN                   /* IF STAE ENVIRONMENT CREATED      00076000
*                                      THEN CONTINUE PROCESSING         00077000
*                                      OTHERWISE RETURN TO CALLER    */ 00078000
         LTR   R15,R15                 ESTAE ENVIRONMENT ESTABLISHED ?  00079000
         BNE   @RF00148                NO, ERROR RETURN                 00080000
*     DO;                                                               00081000
*       IF TCBJSCBB^=0 THEN         /* IF NO JSCB PTR RETURN TO         00082000
*                                      CALLER                        */ 00083000
         L     R4,TCBADDR              R1 -> TCB                        00084000
         USING TCB,R4                                                   00085000
         SLR   R2,R2                                                    00086000
         ICM   R2,B'0111',TCBJSCBB     R2 -> JSCB                       00087000
         BZ    @RF00151                NO JSCB, BRANCH                  00088000
         DROP  R4                                                       00089000
*         DO;                                                           00090000
*                                                                       00091000
*           /*********************************************************/ 00092000
*           /*                                                       */ 00093000
*           /* GET ACTIVE JSCB ADDRESS FROM JSCBACT. CHECK IF TSO    */ 00094000
*           /* USER(FIELD ASCBTSB IN THE ASCB HAS AN ADDRESS IF A TSO*/ 00095000
*           /* USER). IF SO THE MESSAGE IS PUT TO HIS TERMINAL VIA   */ 00096000
*           /* TPUT MACRO. IF THE TPUT IS SUCCESSFUL BYPASS ALL      */ 00097000
*           /* PROCESSING UP TO THE SCAN OF THE UCM TABLE FOR MORE   */ 00098000
*           /* CONSOLES THAT RECEIVE ROUTE CODE 11 MESSAGES. IF NOT  */ 00099000
*           /* SUCCESSFUL TRY TO PUT THE MESSAGE TO HIS MESSAGE DATA */ 00100000
*           /* SET.                                                  */ 00101000
*           /*                                                       */ 00102000
*           /*********************************************************/ 00103000
*                                                                       00104000
*           JSCBADDR=JSCBACT;       /* PUT ACTIVE JSCB ADDR IN ACTJSCB  00105000
         USING IEZJSCB,R2                                               00106000
         MVC   ACTJSCB,JSCBACT         ACTJSCB -> ACTIVE JSCB           00107000
         DROP  R2                                                       00108000
*           R15=4;                  /* INITIALIZE R15                */ 00109000
         LA    R15,4                                                    00110000
*           IF ASCBTSB^=0 THEN      /* CHECK FOR TSO USER            */ 00111000
         ICM   R1,B'1111',ASCBTSB-ASCB(R7)   TSB PRESENT ?              00112000
         BZ    @RF00156                NO, BRANCH                       00113000
*             CALL ISSUTPUT;        /* YES, PUT MSG TO TSO TERMINAL  */ 00114000
         BAL   R14,ISSUTPUT                                             00115000
*           IF R15^=0 THEN          /* IF PUT WASNT SUCCESSFUL THEN  */ 00116000
@RF00156 LTR   R15,R15                                                  00117000
         BZ    @RF00151                                                 00118000
*             DO;                   /* PUT MSG TO SYSTEM MSG DATASET */ 00119000
*                                                                       00120000
*               /*****************************************************/ 00121000
*               /*                                                   */ 00122000
*               /* CHECK IF THIS JOBSTEP HAS ISSUED PREVIOUS WTP     */ 00123000
*               /* MSGS. IF NOT THEN INITIALIZE THE JSCB. ENQUEUE TO */ 00124000
*               /* SERIALIZE PROCESSING OF THE PUT TO HASP. ALSO     */ 00125000
*               /* CHECK FOR THE PRESENCE OF AN RPL POINTER.         */ 00126000
*               /*                                                   */ 00127000
*               /*****************************************************/ 00128000
*                                                                       00129000
*               CALL CHECKJOB;      /* CHECK IF JOB HAS ISSUED          00130000
*                                      PREVIOUS WTP MSGS             */ 00131000
         BAL   R14,CHECKJOB                                             00132000
*               CALL ISSUEENQ;      /* ENQ TO SERIALIZE PROCESSING      00133000
*                                      AND CHECK RPL POINTER         */ 00134000
         BAL   R14,ISSUEENQ                                             00135000
*               IF R15=0 THEN       /* IF ENQ SUCCESSFUL CONTINUE       00136000
*                                      PROCESSING                    */ 00137000
         LTR   R15,R15                                                  00138000
         BNZ   @RF00151                                                 00139000
*                 DO;                                                   00140000
*                                                                       00141000
*                   /*************************************************/ 00142000
*                   /*                                               */ 00143000
*                   /* IF ENQUEUE IS SUCCESSFUL THEN R3 IS           */ 00144000
*                   /* INITIALIZED WITH THE ADDRESS OF THE MESSAGE   */ 00145000
*                   /* AND R8 WITH THE LENGTH OF THE MESSAGE. THE    */ 00146000
*                   /* MESSAGE IS CHECKED TO SEE IF IT EXCEEDS 126   */ 00147000
*                   /* BYTES (MAX LENGTH). IF IT DOES IT IS BROKEN UP*/ 00148000
*                   /* INTO 126 BYTE SEGMENTS OR LESS DEPENDING WHERE*/ 00149000
*                   /* THE LAST FULL WORD ENDS. EACH SEGMENT WILL BE */ 00150000
*                   /* PUT TO THE SYSTEM MSG DATA SET UNTIL ALL      */ 00151000
*                   /* SEGMENTS HAVE BEEN EXHAUSTED. THE RPL IS      */ 00152000
*                   /* INITIALIZED AND THE PUT TO THE SYSTEM MSG DATA*/ 00153000
*                   /* SET ISSUED. RETURN CODES FROM JES2 ARE CHECKED*/ 00154000
*                   /* FOR SUCCESSFUL COMPLETION OF THE PUT          */ 00155000
*                   /*                                               */ 00156000
*                   /*************************************************/ 00157000
*                                                                       00158000
*                                   /* R3 -> MCS + MESSAGE TEXT      */ 00159000
         L     R3,WKAADTXT                                              00160000
         LA    R3,4(,R3)               R3 -> MESSAGE TEXT               00161000
*                                   /* GET MSG TEXT LENGTH INTO R8   */ 00162000
         LH    R8,WKALGH                                                00163000
         SH    R8,KH4                  SUBTRACT FOR MCS HEADER          00164000
*                   DO WHILE(R8^=0);/* AS LONG AS A MSG SEGMENT         00165000
*                                      EXIST CONTINUE PROCESSING     */ 00166000
         B     @DE00167                                                 00167000
*                                                                       00168000
*                     CALL CHECKMSG;/* CHECK IF MSG > 126 BYTES      */ 00169000
@DL00167 BAL   R14,CHECKMSG                                             00170000
*                     CALL BUILDRPL;/* INITIALZE RPL FOR PUT         */ 00171000
         BAL   R14,BUILDRPL            RPL ADDR RETURNED IN R1          00172000
*                                   /* ISSUE PUT TO SYSTEM MSG DATASET  00173000
         LTR   R1,R1                   RPL ADDR ZERO ?                  00174000
         BZ    IGC000F6                YES, BRANCH                      00175000
         USING IFGRPL,R1                                                00176000
         ICM   R5,B'1111',RPLDACB      R5 -> DATA ACB                   00177000
         BZ    IGC000F6                ACB ADDRESS ZERO ? YES, BRANCH   00178000
         USING IFGACB,R5                                                00179000
         TM    ACBOFLGS,ACBOPEN        ACB OPEN ?                       00180000
         BZ    IGC000F6                NO, BRANCH                       00181000
         ICM   R15,B'1111',ACBINRTN    INTERFACE ROUTINE ADDR ZERO ?    00182000
         BZ    IGC000F6                YES, BRANCH                      00183000
*                                                                       00184000
         PUT   RPL=(1)                 WRITE MESSAGE TO SYSTEM MSG DS   00185000
*                                                                       00186000
         DROP  R1,R5                                                    00187000
*                                                                       00188000
         B     IGC000FA                                                 00189000
*                                                                       00190000
IGC000F6 LA    R15,4                   SET ERROR RETURN CODE            00191000
IGC000FA BAL   R14,CKRETURN                                             00192000
*                     CALL CKRETURN;/* CHECK IF PUT SUCCESSFUL       */ 00193000
*                   END;                                                00194000
@DE00167 LTR   R8,R8                   ANY MORE MESSAGE TEXT TO PROC ?  00195000
         BP    @DL00167                YES, LOOP BACK                   00196000
*                   R8=R15;         /* SAVE RETURN CODE              */ 00197000
         LR    R8,R15                                                   00198000
*                   CALL ISSUEDEQ;  /* RELEASE RESOURCE              */ 00199000
         BAL   R14,ISSUEDEQ                                             00200000
*                   R15=R8;         /* RESTORE RETURN CODE           */ 00201000
         LR    R15,R8                                                   00202000
*                 END;                                                  00203000
*             END;                                                      00204000
*         END;                                                          00205000
*                                                                       00206000
*       /*************************************************************/ 00207000
*       /*                                                           */ 00208000
*       /* IF AN ERROR OCCURRED DURING THE PUT TO JES2 OR THE RPL    */ 00209000
*       /* POINTER WAS ZERO AN ERROR MSG WILL BE ISSUED VIA WTO TO   */ 00210000
*       /* HARD COPY                                                 */ 00211000
*       /*                                                           */ 00212000
*       /*************************************************************/ 00213000
*                                                                       00214000
*       IF R15^=0 THEN              /* CK IF I/O ERROR OCCURRED      */ 00215000
@RF00151 LTR   R15,R15                                                  00216000
         BZ    @RF00180                                                 00217000
*         DO;                                                           00218000
*           CALL BUILDMSG;          /* CREATE WTO MSG FOR HARDCOPY   */ 00219000
         BAL   R14,BUILDMSG                                             00220000
*           CALL ISSUEMSG;          /* ISSUE WTO TO HARD COPY        */ 00221000
         BAL   R14,ISSUEMSG                                             00222000
*         END;                                                          00223000
*                                                                       00224000
*/********************************************************************* 00225000
*                                                                       00226000
*        TO DETERMINE WHETHER TO TURN ON XVD0USER BIT (RETURN TO        00227000
*        USER BIT) CHECKS ARE MADE FOR ADDITIONAL ROUTE CODES ON        00228000
*        THE MESSAGE AND IF ANY CONSOLES RECEIVE ROUTE CODE 11          00229000
*        MESSAGES.                                                      00230000
*        FLAG BITS IN THE WPL ARE ALSO CHECKED                          00231000
*        IF ANY OF THE ABOVE CONDITIONS ARE POSITIVE RETURN TO          00232000
*        WTO WITHOUT TURNING ON XVD0USER BIT.                           00233000
*                                                                       00234000
*/********************************************************************* 00235000
*                                                                       00236000
*       R1=0;                                                           00237000
@RF00180 SLR   R1,R1                                                    00238000
*STAERETY:                                                              00239000
*       IF R1^=0 THEN               /* STAE RETRY WILL ENTER HERE    */ 00240000
STAERETY LTR   R1,R1                                                    00241000
         BZ    @RF00189                                                 00242000
*         DO;                       /* R1 WILL POINT TO MY REGS      */ 00243000
*                                                                       00244000
*        RESTORE NEEDED REGISTER FROM STAEPARM AREA                     00245000
*                                                                       00246000
         LM    R9,R13,0(R1)                                             00247000
*         END;                                                          00248000
*       CALL FINALCK;               /* CK FOR ADDITIONAL WTO WORK    */ 00249000
@RF00189 BAL   R14,FINALCK                                              00250000
*                                   /* CLEAN UP ESTAE ENVIRONMENT    */ 00251000
         ESTAE 0                                                        00252000
*                                                                       00253000
         B     @EL00001                                                 00254000
*                                                                       00255000
*     END;                                                              00256000
*   ELSE                                                                00257000
*     CALL FINALCK;                 /* NO ESTAE, CK IF MORE WTO WK   */ 00258000
@RF00148 BAL   R14,FINALCK                                              00259000
*   RETURN;                         /* RETURN WTO                    */ 00260000
@EL00001 LR    R1,R13                                                   00261000
         L     R13,4(,R13)                                              00262000
         L     R0,WORKIGCG                                              00263000
*                                                                       00264000
         FREEMAIN R,LV=(0),A=(1)                                        00265000
*                                                                       00266000
         RETURN (14,12)                                                 00267000
*                                                                       00268000
*   /*****************************************************************/ 00269000
*   /*                                                               */ 00270000
*   /* GETESTAE                                                      */ 00271000
*   /*                                                               */ 00272000
*   /* BUILD A PARAMETER LIST FOR ESTAE AND ISSUE THE ESTAE MACRO    */ 00273000
*   /*                                                               */ 00274000
*   /*****************************************************************/ 00275000
*                                                                       00276000
*GETESTAE:                                                              00277000
*   MSGID='4';                      /* INITIALIZE MSG ISSUER ID TO AN   00278000
*                                      UNPREDICATABLE ERROR          */ 00279000
GETESTAE MVI   MSGID,C'4'                                               00280000
*                                   /* SAVE REGISTERS REQUIRED       */ 00281000
*                                   /* IN STAE EXIT                  */ 00282000
         STM   R9,R13,REGSTAE                                           00283000
*          0(1:ESTAELEN)=ELIST(1:ESTAELEN);/* MOVE ESTAE LIST FORM      00284000
*                                      INTO WORKAREA                 */ 00285000
         MVC   STAELIST(ESTAELEN),ELIST                                 00286000
*   R3=ADDR(STAE000);               /* GET STAE EXIT ROUTINE ADDR    */ 00287000
         LA    R3,STAE000                                               00288000
*   R2=ADDR(STAEPARM);              /* GET PARM LIST ADDR            */ 00289000
         LA    R2,STAEPARM                                              00290000
*                                                                       00291000
         ESTAE 0                                                        00292000
*                                                                       00293000
         SLR   R15,R15                                                  00294000
         B     @ER00002                                                 00295000
*                                                                       00296000
         ESTAE (3),CT,RECORD=YES,PARAM=(2),MF=(E,STAELIST)              00297000
*                                                                       00298000
*   END;                                                                00299000
@ER00002 BR    R14                     RETURN TO CALLER WITH RC IN R15  00300000
*                                                                       00301000
*   /*****************************************************************/ 00302000
*   /*                                                               */ 00303000
*   /* CHECKMSG                                                      */ 00304000
*   /*                                                               */ 00305000
*   /* CHECK IF THE MESSAGE EXCEEDS 126 CHARACTERS                   */ 00306000
*   /* IF IT DOES THE MESSAGE WILL BE BROKEN UP INTO 126 OR LESS     */ 00307000
*   /* SEGMENTS DEPENDING ON WHERE THE LAST FULL WORD ENDS. THE      */ 00308000
*   /* MESSAGE WILL BE ISSUED SEGMENT BY SEGMENT UNTIL THE ENTIRE    */ 00309000
*   /* MESSAGE HAS BE PUT TO THE SYSTEM MESSAGE DATA SET             */ 00310000
*   /*                                                               */ 00311000
*   /* ON ENTRY -                                                    */ 00312000
*   /* R3 -> MESSAGE TEXT                                            */ 00313000
*   /* R8  = L'MESSAGE TEXT                                          */ 00314000
*   /*                                                               */ 00315000
*   /* ON EXIT                                                       */ 00316000
*   /* R7 -> MESSAGE TEXT                                            */ 00317000
*   /* R8  = L'MESSAGE TEXT                                          */ 00318000
*   /*                                                               */ 00319000
*   /*****************************************************************/ 00320000
*                                                                       00321000
*CHECKMSG:                                                              00322000
*   R7=R3;                          /* R7 -> MSG                     */ 00323000
CHECKMSG LR    R7,R3                                                    00324000
*   IF R8>126 THEN                  /* L'MSG > 126 THEN DO           */ 00325000
         CH    R8,KH126                                                 00326000
         BNH   @RF00218                                                 00327000
*     DO;                                                               00328000
         LA    R2,125(,R7)             R2 -> 126TH BYTE OF MESSAGE TEXT 00329000
*       DO WHILE(R2->MESSAGE(1)^=' '&R2^=R7);/* SCAN FOR BLANK          00330000
*                                      CHAR OR BEGINNING ADDR OF MSG */ 00331000
         B     @DE00221                                                 00332000
*                                                                       00333000
*         R2=R2-1;                  /* DECREMENT R2 FOR BACKWARD SCAN*/ 00334000
@DL00221 BCTR  R2,0                                                     00335000
*       END;                                                            00336000
@DE00221 CLI   0(R2),C' '              FOUND A BLANK ?                  00337000
         BE    @DC00221                YES, BRANCH                      00338000
         CR    R2,R7                   NO, R2 -> FIRST BYTE ?           00339000
         BNE   @DL00221                NO, CONTINUE TO SCAN BACKWARDS   00340000
*       IF R2=R7 THEN               /* CK IF SCAN WAS TERMINATED        00341000
*                                      BECAUSE BLANK WASNT FOUND     */ 00342000
@DC00221 CR    R2,R7                   R2 -> FIRST BYTE ?               00343000
         BNE   @RF00224                NO, BRANCH                       00344000
*         R2=R7+125;                /* YES, THEN POINT R2 AT THE        00345000
*                                      126TH BYTE OF MSG             */ 00346000
         LA    R2,125(,R7)                                              00347000
*       R3=R2+1;                    /* ELSE R3 POINTS TO CHAR           00348000
@RF00224 LA    R3,1(,R2)               R3 -> NEXT CHAR TO BE PROCESSED  00349000
         LR    R5,R2                                                    00350000
         SLR   R5,R7                   SUBTRACT START ADDR FROM LAST    00351000
*                                      CHAR + 1                         00352000
         LA    R2,1(,R5)               CALC PROCESSED LENGTH            00353000
         SLR   R8,R2                   SUBTRACT PROCESSED LENGTH        00354000
*                                      FROM TOTAL LENGTH OF MESSAGE     00355000
*       R2=R2-R7+1;                 /* COMPUTE LENGTH TO PUT OUT     */ 00356000
         B     @ER00003                                                 00357000
*                                                                       00358000
*     END;                                                              00359000
*   ELSE                                                                00360000
*     DO;                                                               00361000
*       R2=R8;                      /* IF LENGTH <126 THEN PUT LENGTH   00362000
*                                      INTO R2                       */ 00363000
@RF00218 LR    R2,R8                                                    00364000
*       R8=0;                       /* NO MORE MSG SEGMENTS LEFT PUT    00365000
*                                      ZERO LENGTH INTO R8           */ 00366000
         SLR   R8,R8                                                    00367000
*     END;                                                              00368000
*   END;                                                                00369000
@ER00003 BR    R14                                                      00370000
*                                                                       00371000
*   /*****************************************************************/ 00372000
*   /*                                                               */ 00373000
*   /* CKROUTCD                                                      */ 00374000
*   /*                                                               */ 00375000
*   /* THE MESSAGE IS CHECKED FOR ROUTE CODES OTHER THAN 11. IF THEY */ 00376000
*   /* EXIST THIS MODULE RETURNS TO WTO WITHOUT TURNING ON XVD0USER  */ 00377000
*   /* (RETURN TO USER BIT IN XSA). IF NO OTHER ROUTE CODES EXIST    */ 00378000
*   /* THEN THE UCM TABLE IS SCANNED TO DETERMINE IF ANY CONSOLES ARE*/ 00379000
*   /* TO RECEIVE ROUTE CODE 11 MESSAGES IF SO THEN THIS MODULE      */ 00380000
*   /* RETURNS TO WTO WITHOUT TURNING ON XVD0USER BIT                */ 00381000
*   /*                                                               */ 00382000
*   /*****************************************************************/ 00383000
*                                                                       00384000
*CKROUTCD:                                                              00385000
*   IF XVRCSAVE='0020'X THEN        /* OTHER ROUTE CODES WITH MSG ?  */ 00386000
CKROUTCD CLC   WKAROC,WTPONLY          YES, BRANCH                      00387000
         BNE   @RF00237                                                 00388000
*     DO;                           /* NO, CHECK CONSOLES FOR ANY       00389000
*                                      THAT RECEIVE ROUTE CODE 11 MSG*/ 00390000
         L     R15,ADDRUCM                                              00391000
         USING UCM,R15                                                  00392000
*       R7=UCMVEA;                  /* -> FIRST UCM                  */ 00393000
         L     R7,UCMVEA                                                00394000
*       R8=UCMVEZ;                  /* L'EACH UCM                    */ 00395000
         L     R8,UCMVEZ                                                00396000
*       R3=UCMVEL;                  /* -> LAST UCM                   */ 00397000
         L     R3,UCMVEL                                                00398000
         DROP  R15                                                      00399000
*       DO WHILE(WTPROUTE^='1'B&R7<R3);/* SCAN ALL UCMS FOR ANY         00400000
*                                      THAT RECEIVE ROUTE CODE 11       00401000
*                                      MSGS                          */ 00402000
         B     @DE00242                                                 00403000
*                                                                       00404000
*         R7=R7+R8;                 /* INCREMENT R7 TO NEXT UCM      */ 00405000
@DL00242 LA    R7,0(R7,R8)                                              00406000
*       END;                                                            00407000
         USING UCMLIST,R7              ADDRESSABILITY FOR UCM DEVICE    00408000
@DE00242 TM    UCMRTCD+1,WPLROUTK      WTP ROUTE CODE 11 FOR THIS CON ? 00409000
         BO    @DC00242                                                 00410000
         CR    R7,R3                                                    00411000
         BL    @DL00242                                                 00412000
*       IF WTPROUTE='1'B THEN       /* ANY CONSOLES RECEIVE CODE 11  */ 00413000
@DC00242 TM    UCMRTCD+1,WPLROUTK                                       00414000
         BNO   @RF00245                                                 00415000
         DROP  R7                                                       00416000
*         R15=0;                    /* YES, THEN RC = RETURN TO WTO  */ 00417000
         SLR   R15,R15                                                  00418000
         B     @ER00004                                                 00419000
*                                                                       00420000
*       ELSE                                                            00421000
*         R15=4;                    /* NO, RC = RETURN TO USER       */ 00422000
@RF00245 LA    R15,4                                                    00423000
         B     @ER00004                                                 00424000
*                                                                       00425000
*     END;                                                              00426000
*   ELSE                                                                00427000
*     R15=0;                        /* OTHER ROUTE CODES RC = RETURN    00428000
*                                      TO WTO                        */ 00429000
@RF00237 SLR   R15,R15                                                  00430000
*   END;                                                                00431000
@ER00004 BR    R14                                                      00432000
*                                                                       00433000
*   /*****************************************************************/ 00434000
*   /*                                                               */ 00435000
*   /* ISSUTPUT                                                      */ 00436000
*   /*                                                               */ 00437000
*   /* A CHECK IS MADE TO SEE IF THE TSO USER WANTS WTP MESSAGES     */ 00438000
*   /* SENT TO THE TERMINAL. IF YES THEN THE TPUT MACRO IS ISSUED TO */ 00439000
*   /* THE TERMINAL. THE RC FROM TPUT IS PASSED BACK TO MAINLINE     */ 00440000
*   /* CODE. IF THE USER DOES NOT WANT WTP MESSAGES,     RETURN TO   */ 00441000
*   /* MAINLINE WITH A RC OF 4 IN R15                                */ 00442000
*   /*                                                               */ 00443000
*   /* ON RENTRY -                                                   */ 00444000
*   /* R2 -> ACTIVE JSCB                                             */ 00445000
*   /*                                                               */ 00446000
*   /*****************************************************************/ 00447000
*                                                                       00448000
*ISSUTPUT:                                                              00449000
*   IF JSCBPSCB^=0&UPTWTP='1'B THEN /* TSO USER WANT WTP MSGS ?      */ 00450000
         USING IEZJSCB,R2                                               00451000
ISSUTPUT ICM   R1,B'1111',JSCBPSCB     R1 -> TSO PROTECTED STEP CNTL    00452000
         BZ    @RF00252                PRESENT ? ,NO, NOT TSO CALLER    00453000
         DROP  R2                                                       00454000
         USING PSCB,R1                 YES                              00455000
         L     R1,PSCBUPT              R1 -> USER PROFILE TABLE         00456000
         DROP  R1                                                       00457000
         USING UPT,R1                                                   00458000
         TM    UPTSWS,UPTWTP           WTP MSGS DESIRED ?               00459000
         DROP  R1                                                       00460000
         BNO   @RF00252                NO, BRANCH                       00461000
*     DO;                           /* YES, ISSUE TPUT               */ 00462000
*       R1=ADDR(WPLTXT);            /* R1 -> MCS + MESSAGE TEXT      */ 00463000
         LA    R1,WKAADTXT                                              00464000
         LA    R1,4(,R4)               R1 -> MESSAGE TEXT               00465000
*       R0=XVMSGLGH-4;              /* R0 = L'MCS + MESSAGE          */ 00466000
         LH    R0,WKALGH               R0 = L'MESSAGE                   00467000
         SH    R0,KH4                                                   00468000
*                                   /* ISSUE TPUT TO TERMINAL        */ 00469000
         TPUT  (1),(0),R                                                00470000
*                                                                       00471000
         B     @ER00005                                                 00472000
*                                                                       00473000
*     END;                                                              00474000
*   ELSE                                                                00475000
*     R15=4;                        /* PUT TO JOB'S MSG DATA SET     */ 00476000
@RF00252 LA    R15,4                                                    00477000
*   END;                                                                00478000
@ER00005 BR    R14                     RETURN TO CALLER WITH RC IN R15  00479000
*                                                                       00480000
*   /*****************************************************************/ 00481000
*   /*                                                               */ 00482000
*   /* CHECKJOB                                                      */ 00483000
*   /*                                                               */ 00484000
*   /* IF THIS IS THE FIRST TIME A WTP IS ISSUED BY THIS JOB STEP    */ 00485000
*   /* THEN THE JSCB MUST BE INITIALIZED. IF AN OLD STEP THAT HAS    */ 00486000
*   /* ISSUED PREVIOUS WTPS THEN RETURN TO MAINLINE CODE             */ 00487000
*   /*                                                               */ 00488000
*   /*****************************************************************/ 00489000
*                                                                       00490000
*CHECKJOB:                                                              00491000
*   IF JSCBWTSP^=JSCBSTEP THEN      /* JOB BEEN HERE BEFORE ?        */ 00492000
CHECKJOB L     R15,ACTJSCB                                              00493000
         USING IEZJSCB,R15                                              00494000
         CLC   JSCBWTSP,JSCBSTEP                                        00495000
         BE    @ER00006                YES, BRANCH                      00496000
*     DO;                           /* NO, THEN INITIALIZE JSCB      */ 00497000
*       JSCBWTP=0;                  /* ZERO OUT SWITCHES             */ 00498000
         XC    JSCBWTP,JSCBWTP                                          00499000
*       JSCBWTSP=JSCBSTEP;          /* MOVE STEP NUM INTO JSCB       */ 00500000
         MVC   JSCBWTSP,JSCBSTEP                                        00501000
         DROP  R15                                                      00502000
*     END;                                                              00503000
*   END;                                                                00504000
@ER00006 BR    R14                     RETURN TO CALLER                 00505000
*                                                                       00506000
*   /*****************************************************************/ 00507000
*   /*                                                               */ 00508000
*   /* BUILDRPL                                                      */ 00509000
*   /*                                                               */ 00510000
*   /* THIS ROUTINE OBTAINS THE RPL ADDRESS FROM THE JSCB. THE       */ 00511000
*   /* REQUIRED FIELDS WITHIN THE RPL ARE INITIALIZED                */ 00512000
*   /*                                                               */ 00513000
*   /* ON ENTRY -                                                    */ 00514000
*   /* R7 -> MESSAGE TEXT                                            */ 00515000
*   /* R2  = L'MESSAGE TEXT                                          */ 00516000
*   /*                                                               */ 00517000
*   /* ON EXIT                                                       */ 00518000
*   /* R1 -> RPL                                                     */ 00519000
*   /*                                                               */ 00520000
*   /*****************************************************************/ 00521000
*                                                                       00522000
*BUILDRPL:                                                              00523000
BUILDRPL L     R15,ACTJSCB                                              00524000
         USING IEZJSCB,R15                                              00525000
*   R1=JSCBSMLR;                    /* GET PTR TO RPL                */ 00526000
         ICM   R1,B'1111',JSCBSMLR     R1 -> SYSTEM MESSAGE DATA SET    00527000
         BZ    @ER00007                SYSTEM MESSAGE DATA SET AVAIL ?  00528000
         DROP  R15                                                      00529000
         USING IFGRPL,R1                                                00530000
*   RPLAREA=R7;                     /* MSG LOCATION INTO RPL         */ 00531000
         ST    R7,RPLAREA                                               00532000
*   RPLRLEN=R2;                     /* MSG LENGTH INTO RPL           */ 00533000
         ST    R2,RPLRLEN                                               00534000
*   RPLREQ=RPLPUT;                  /* INDICATE PUT REQUEST          */ 00535000
         MVI   RPLREQ,RPLPUT                                            00536000
*   RPLSEQ='1'B;                    /* PUT AFTER LAST MSG IN SYSTEM     00537000
*                                      MSG DATA SET                  */ 00538000
         OI    RPLOPTCD,RPLSEQ                                          00539000
         DROP  R1                                                       00540000
*   RETURN;                                                             00541000
@ER00007 BR    R14                                                      00542000
*   END;                                                                00543000
*                                                                       00544000
*   /*****************************************************************/ 00545000
*   /*                                                               */ 00546000
*   /* THIS ROUTINE CHECKS THE RETURN CODES FROM HASP. IF REG 15 IS  */ 00547000
*   /* NOT 0 THEN AN ERROR OCCURRED. REG 8 IS ZEROED TO TERMINATE ANY*/ 00548000
*   /* FURTHER PROCESSING OF MESSAGES AND THE ERROR MSG ID FIELD IS  */ 00549000
*   /* CHANGED TO 3 TO INDICATE A PUT ERROR IN THE WTO MSG.          */ 00550000
*   /*                                                               */ 00551000
*   /*****************************************************************/ 00552000
*                                                                       00553000
*CKRETURN:                                                              00554000
*   IF R15^=0 THEN                  /* IF PROBLEMS OCCURRED          */ 00555000
CKRETURN LTR   R15,R15                                                  00556000
         BZ    @ER00008                                                 00557000
*     DO;                                                               00558000
*       R8=0;                       /* ZERO OUT R8 TO TERMINATE DO      00559000
*                                      LOOP                          */ 00560000
         SLR   R8,R8                                                    00561000
*       MSGID='3';                  /* SET MSG ID TO INDICATE A PUT     00562000
*                                      FAILURE                       */ 00563000
         MVI   MSGID,C'3'                                               00564000
*     END;                                                              00565000
*   RETURN;                                                             00566000
@ER00008 BR    R14                                                      00567000
*   END;                                                                00568000
*                                                                       00569000
*   /*****************************************************************/ 00570000
*   /*                                                               */ 00571000
*   /* ISSUEENQ                                                      */ 00572000
*   /*                                                               */ 00573000
*   /* THIS ROUTINE CHECKS FOR A ZERO RPL POINTER. IF ZERO THE ENQ IS*/ 00574000
*   /* NOT ISSUED AND THE ERROR MSG ID IS SET TO 1 TO INDICATE A ZERO*/ 00575000
*   /* RPL POINTER ERROR IN THE WTO MESSAGE TO HARD COPY. IF AN RPL  */ 00576000
*   /* POINTER IS PRESENT THIS ROUTINE MOVES THE ENQUEUE PARM LIST   */ 00577000
*   /* INTO THIS MODULES WORKAREA. IT THEN BUILDS AN RNAME CONSISTING*/ 00578000
*   /* OF THE RPL POINTER (JSCBSMLR) AND THE AND THE ASCBASID.IT THEN*/ 00579000
*   /* ISSUES A UNCONDITIONAL ENQUEUE                                */ 00580000
*   /*                                                               */ 00581000
*   /*****************************************************************/ 00582000
*                                                                       00583000
*ISSUEENQ:                                                              00584000
*   R1=ADDR(WORKAREA);              /* WORKAREA ADDR INTO R1         */ 00585000
ISSUEENQ LA    R1,WORKAREA                                              00586000
*   ENQAREA(1:LENENQ)=ENQLIST(1:LENENQ);/* MOVE ENQ LIST INTO WORK   */ 00587000
         MVC   WORKAREA(LENENQ),ENQLIST                                 00588000
         L     R15,ACTJSCB             R15 -> ACTIVE JSCB               00589000
         USING IEZJSCB,R15                                              00590000
*   IF JSCBSMLR^=0 THEN             /* RPL AVAILABLE FOR SYSTEM MSG ?*/ 00591000
         ICM   R15,B'1111',JSCBSMLR                                     00592000
         BZ    @RF00293                NO, BRANCH                       00593000
         DROP  R15                                                      00594000
*     DO;                                                               00595000
*       ENQRNAME(1:4)=JSCBSMLR;     /* YES,BUILD RNAME WITH RPL PTR  */ 00596000
         ST    R15,ENQRNAME                                             00597000
*       ENQRNAME(5:6)=ASCBASID;     /* AND ASID FROM ASCB            */ 00598000
         MVC   ENQRNAME+4(2),ASCBASID-ASCB(R7)                          00599000
*       RNAMEFLD=ADDR(ENQRNAME);    /* PUT RNAME ADDR INTO LIST      */ 00600000
         LA    R15,ENQRNAME                                             00601000
         ST    R15,8(,R1)                                               00602000
*                                   /* ISSUE UNCONDITIONAL ENQ       */ 00603000
         ENQ   ,MF=(E,(1))                                              00604000
*                                                                       00605000
         LTR   R15,R15                 TEST RETURN CODE FROM ENQ        00606000
         BZ    @ER00009                ZERO, ALL OK                     00607000
         CLI   3(R15),8                RETURN CODE 8 ?                  00608000
         BE    IGC0032A                                                 00609000
         CLI   3(R15),20               RETURN CODE 20 ?                 00610000
         BNE   @ER00009                                                 00611000
IGC0032A MVI   XVRETCOD,48                                              00612000
         MVI   MSGID,C'2'                                               00613000
         B     @ER00009                                                 00614000
*                                                                       00615000
*     END;                                                              00616000
*   ELSE                                                                00617000
*     DO;                           /* NO RPL PTR MEANS NO ENQ       */ 00618000
*       R15=4;                      /* RC INDICATES ENQ WOULD FAIL   */ 00619000
@RF00293 LA    R15,4                                                    00620000
*       MSGID='1';                  /* INDICATES WHY ENQ FAILED      */ 00621000
         MVI   MSGID,C'1'                                               00622000
*     END;                                                              00623000
*   END;                                                                00624000
@ER00009 BR    R14                                                      00625000
*                                                                       00626000
*   /*****************************************************************/ 00627000
*   /*                                                               */ 00628000
*   /* BUILDMSG                                                      */ 00629000
*   /*                                                               */ 00630000
*   /* GETS 53 BYTES OF THE MESSAGE THAT WAS PASSED TO WTP           */ 00631000
*   /* THE LENGTH WILL BE ADJUSTED TO A MAXIMUM OF 53 BYTES          */ 00632000
*   /*                                                               */ 00633000
*   /* ON EXIT -                                                     */ 00634000
*   /* R3 -> MESSAGE TEXT                                            */ 00635000
*   /* R6  = L'MESSAGE TEXT                                          */ 00636000
*   /*                                                               */ 00637000
*   /*****************************************************************/ 00638000
*                                                                       00639000
*BUILDMSG:                                                              00640000
*   R3=ADDR(WPLTXT);                /* R3 -> MCS + MESSAGE TEXT      */ 00641000
BUILDMSG L     R3,WKAADTXT             R3 -> MESSAGE TEXT               00642000
         LA    R3,4(,R3)                                                00643000
*   R6=XVMSGLGH-4;                  /* GET MSG LENGTH                */ 00644000
         LH    R6,WKALGH                                                00645000
         SH    R6,KH4                  SUBTRACT FOR MCS OVERHEAD        00646000
*   IF R6>53 THEN                   /* MSG EXCEED MAX LENGTH            00647000
*                                      THAT WE CAN PUT OUT           */ 00648000
         LA    R15,53                                                   00649000
         CR    R6,R15                  L'TEXT > 53 ?                    00650000
         BNH   @ER00011                NO, BRANCH TO EXIT               00651000
*     DO;                                                               00652000
         LR    R6,R15                  TRUNCATE TO 53 BYTES             00653000
*   END;                                                                00654000
@ER00011 BR    R14                                                      00655000
*                                                                       00656000
*   /*****************************************************************/ 00657000
*   /*                                                               */ 00658000
*   /* ISSUEMSG                                                      */ 00659000
*   /*                                                               */ 00660000
*   /* THIS ROUTINE MOVES THE LIST FORM OF THE MSG TO WTP WORKAREA   */ 00661000
*   /* AND THEN MOVES IN THE 55 BYTES FROM THE MSG SENT TO WTP BEFORE*/ 00662000
*   /* THE ABEND OCCURRED. IT THEN ISSUES THE WTO                    */ 00663000
*   /*                                                               */ 00664000
*   /* ON ENTRY -                                                    */ 00665000
*   /* R3 -> MESSAGE TEXT                                            */ 00666000
*   /* R6  = L'MESSAGE TEXT (MAX 53 BYTES)                           */ 00667000
*   /*                                                               */ 00668000
*   /*                                                               */ 00669000
*   /*****************************************************************/ 00670000
*                                                                       00671000
*ISSUEMSG:                                                              00672000
ISSUEMSG MVC   WORKAREA(IEF170IL),IEF170I                               00673000
*   LENGTH=R6+L'IEF170I;            /* UPDATE LENGTH                 */ 00674000
         LR    R15,R6                                                   00675000
         AH    R15,WORKAREA            ADD L'IEF170I MESSAGE            00676000
         STH   R15,WORKAREA            UPDATE L'WTO MESSAGE             00677000
*   MSGID2(1:R6)=R3->MESSAGE(1:R6);/* MOVE MSG TO WORKAREA           */ 00678000
         LR    R15,R6                                                   00679000
         BCTR  R15,0                                                    00680000
         EX    R15,@SM02290            MVC   WORKAREA+23(0),0(R3)       00681000
*   R7=ADDR(MSGID2)+R6;             /* R7 -> END OF MESSAGE          */ 00682000
         LA    R7,WORKAREA+23(R6)                                       00683000
*   R7->MESSAGE=IEF170I+23;         /* MOVE IN DESC AND ROUTE CODES  */ 00684000
         MVC   0(4,R7),IEF170I+23                                       00685000
*   IF TCBTIO^=0 THEN               /* TIOT EXIST ?                  */ 00686000
         L     R15,TCBADDR                                              00687000
         USING TCB,R15                                                  00688000
         ICM   R15,B'1111',TCBTIO      HAVE TIOT ADDR ?                 00689000
         BZ    @RF00337                NO, BRANCH                       00690000
         DROP  R15                                                      00691000
*     JOBNAME=TIOCNJOB;             /* YES, MOVE JOBNAME TO MSG      */ 00692000
         USING TIOT,R15                                                 00693000
         MVC   WORKAREA+14(L'TIOCNJOB),TIOCNJOB                         00694000
         DROP  R15                                                      00695000
*   IDENT=MSGID;                    /* INDICATE WHY MSG OCCURRED     */ 00696000
@RF00337 MVC   WORKAREA+12(L'MSGID),MSGID                               00697000
*                                   /* ISSUE WTO                     */ 00698000
         WTO   MF=(E,WORKAREA)                                          00699000
*   END;                                                                00700000
@ER00012 BR    R14                                                      00701000
*                                                                       00702000
*   /*****************************************************************/ 00703000
*   /*                                                               */ 00704000
*   /* THIS ROUTINE IS CALLED BY THE STAE EXIT ROUTINE TO DEQUEUE ANY*/ 00705000
*   /* RESOURCES THAT MAY HAVE BEEN ENQUEUED ON                      */ 00706000
*   /*                                                               */ 00707000
*   /*****************************************************************/ 00708000
*                                                                       00709000
*ISSUEDEQ:                                                              00710000
*   R1=ADDR(WORKAREA);                                                  00711000
ISSUEDEQ LA    R1,WORKAREA             R1 -> WORKAREA                   00712000
*   WORKAREA(1:LENDEQ)=DEQLIST(1:LENDEQ);/* MOVE IN LIST FORM OF DEQ */ 00713000
         MVC   WORKAREA(LENDEQ),DEQLIST                                 00714000
*   RNAMEFLD=ADDR(ENQRNAME);        /* GET ADDR OF RNAME INTO LIST   */ 00715000
         LA    R15,ENQRNAME                                             00716000
         ST    R15,8(,R1)                                               00717000
*                                   /* ISSUE CONDITIONAL DEQ         */ 00718000
         DEQ   ,MF=(E,(1))                                              00719000
*   END;                                                                00720000
@ER00013 BR    R14                                                      00721000
*                                                                       00722000
*   /*****************************************************************/ 00723000
*   /*                                                               */ 00724000
*   /* CKMCSFLG                                                      */ 00725000
*   /*                                                               */ 00726000
*   /* CHECK THE MCS FLAGS IN THE WPL. FLAGS                         */ 00727000
*   /* WPLMCSFB,WPLMCSFD, AND WPLMCSFH ARE CHECKED. ADDITIONALLY THE */ 00728000
*   /* WTOR BIT IN CXSA (XVD2WTOR) IS                                */ 00729000
*   /* CHECKED TO SEE IF THIS WPL IS FOR A WTOR                      */ 00730000
*   /*                                                               */ 00731000
*   /* IF ANY OF THESE ARE ON MORE PROCESSING IS TO BE DONE BY WTO.  */ 00732000
*   /* IF THESE FLAGS ARE NOT ON, A CHECK IS MADE TO SEE IF THIS WTP */ 00733000
*   /* SHOULD BE HARD COPIED. IF YES THEN WTO IS THUSLY INFORMED.    */ 00734000
*   /*                                                               */ 00735000
*   /*****************************************************************/ 00736000
*                                                                       00737000
*CKMCSFLG:                                                              00738000
*   IF WPLMCSFB^='1'B&WPLMCSFD^='1'B&WPLMCSFH^='1'B&XVD2WTOR^='1'B      00739000
CKMCSFLG TM    WKAMCSF,WPLMCSFB+WPLMCSFD+WPLMCSFH                       00740000
         BNZ   @ER00014                                                 00741000
         TM    XVD2,XVD2WTOR                                            00742000
         BO    @ER00014                                                 00743000
*     DO;                           /* IF ALL FLAGS ARE OFF THEN        00744000
*                                      CHECK IF WTP ARE GOING TO HARD   00745000
*                                      COPY                          */ 00746000
*       IF UCMSYSG='1'B|UCMHCUCM^=0 THEN/* CHECK IF HARD COPY EXIST  */ 00747000
         L     R15,ADDRUCM                                              00748000
         SH    R15,KH4                                                  00749000
         L     R15,UCMPRFXP-UCMPRFXP(,R15)    -> UCM PREFIX             00750000
         USING UCMPRFX,R15                                              00751000
         TM    UCMSFLG1,UCMSYSG        HARD COPY DEVICE IS SYSLOG ?     00752000
         BO    @RT00352                YES, BRANCH                      00753000
         ICM   R0,B'1111',UCMHCUCM     -> HARD COPY UCM ENTRY           00754000
*                                      HARD COPY UCM ENTRY PRESENT ?    00755000
         BZ    @RF00352                NO, BRANCH                       00756000
*         DO;                                                           00757000
*           IF RTCODE11='1'B THEN   /* ARE WTP MSGS BEING HARD COPIED*/ 00758000
@RT00352 TM    UCMHRDRT+1,WPLROUTK     ROUTE CODE 11 ?                  00759000
         BZ    @RF00354                NO, BRANCH                       00760000
         DROP  R15                                                      00761000
*             XVD0HDCY='1'B;        /* YES, THEN TELL WTO            */ 00762000
         OI    XVD0,XVD0HDCY                                            00763000
         B     @ER00014                                                 00764000
*                                                                       00765000
*           ELSE                                                        00766000
*             XVD0USER='1'B;        /* NO FLAGS OR NO HARD TELL WTO     00767000
*                                      TO RETURN TO RETURN TO USER   */ 00768000
@RF00354 OI    XVD0,XVD0USER                                            00769000
         B     @ER00014                                                 00770000
*                                                                       00771000
*         END;                                                          00772000
*       ELSE                                                            00773000
*         XVD0USER='1'B;            /* OTHERWISE TELL WTO TO            00774000
*                                      RETURN TO USER                */ 00775000
@RF00352 OI    XVD0,XVD0USER                                            00776000
*     END;                                                              00777000
*   END;                                                                00778000
@ER00014 BR    R14                                                      00779000
*                                                                       00780000
*   /*****************************************************************/ 00781000
*   /*                                                               */ 00782000
*   /* FINALCK                                                       */ 00783000
*   /*                                                               */ 00784000
*   /* CHECK IF ANY CONSOLES RECEIVE ROUTE CODE 11 MESSAGES          */ 00785000
*   /* IF MCS FLAGS B,D,H, ARE ON OR IF ROUTE CODE 11                */ 00786000
*   /* MESSAGES ARE HARDCOPIED. IF ANY OF THE ABOVE CHECKS ARE       */ 00787000
*   /* POSITIVE WTO IS FLAGGED FOR ADDITIONAL PROCESSING. OTHERWISE  */ 00788000
*   /* WTO RETURNS TO CALLER                                         */ 00789000
*   /*                                                               */ 00790000
*   /*****************************************************************/ 00791000
*                                                                       00792000
*FINALCK:                                                               00793000
*   REG14SAV=R14;                   /* SAVE MAINLINE RETURN ADDR     */ 00794000
FINALCK  ST    R14,REG14SAV                                             00795000
*   CALL CKROUTCD;                  /* CK FOR OTHER ROUTE CODES ON      00796000
*                                      MSG OR FOR CONSOLES THAT         00797000
*                                      RECEIVE ROUTE CODE 11 MSGS    */ 00798000
         BAL   R14,CKROUTCD                                             00799000
*   IF R15=4 THEN                   /* IF NONE THEN CK WPL FLAGS     */ 00800000
         CH    R15,KH4                                                  00801000
         BNE   @RF00364                                                 00802000
*     CALL CKMCSFLG;                /* GO CK MCS FLAGS AND HARDCOPY  */ 00803000
         BAL   R14,CKMCSFLG                                             00804000
*   R14=REG14SAV;                   /* RESTORE RETURN ADDR           */ 00805000
@RF00364 L     R14,REG14SAV                                             00806000
*   END;                                                                00807000
@ER00015 BR    R14                                                      00808000
*                                                                       00809000
*********************************************************************** 00810000
*                                                                       00811000
*        STAE EXIT ROUTINE                                              00812000
*                                                                       00813000
*        RECEIVES CONTROL ONLY IF AN ABEND SITUATION OCCURS.            00814000
*        WHEN ENTERED IT RESTORES THIS MODULES BASE REGISTER, XSA       00815000
*        POINTER AND DATA REG                                           00816000
*        53 BYTES OF THE MESSAGE PASSED TO WTP ARE MOVED INTO A         00817000
*        WTO AND ISSUED TO THE HARD COPY                                00818000
*        IF R0 = 0 THEN THE SETRP MACRO IS ISSUED WITH                  00819000
*        RETURN ADDR OF STAERETY                                        00820000
*        IF R0 IS NOT 0 THEN A RC OF 4 IS PLACED INTO R15, THE          00821000
*        RETRY ADDR INTO R0 AND A BR 14 TO STAE ISSUED                  00822000
*                                                                       00823000
*********************************************************************** 00824000
*                                                                       00825000
*STAE000:                                                               00826000
         USING SDWA,R1                                                  00827000
         DROP  R11                     REMOVE R11 AS BASE REG           00828000
         USING STAE000,R15             MAKE R15 BASE REG                00829000
*   R8=R14;                         /* SAVE RETURN ADDRESS IN R8     */ 00830000
STAE000  LR    R8,R14                                                   00831000
*   R11=12;                         /* NEED A 12 FOR COMPARE         */ 00832000
         LA    R11,12                                                   00833000
         CR    R0,R11                  CHECK R0 FOR A 12 RETURN CODE    00834000
         BE    NOSDWA                  IF 12 THEN                       00835000
*                                      R2 -> USER PARAMETER LIST        00836000
         L     R2,SDWAPARM             ELSE OBTAIN USER                 00837000
*                                      PARAMETER LIST FROM THE SWDA     00838000
         LR    R5,R1                   R5 -> SDWA                       00839000
         L     R1,SDWAABCC             GET ABEND COMPLETION CODE        00840000
         DROP  R1                                                       00841000
NOSDWA   SLL   R1,8                    REMOVE HIGH ORDER GARBAGE        00842000
         SRL   R1,20                   SHIFT SYSTEM ABEND CODE          00843000
*                                      INTO LOW ORDER 12 BITS           00844000
*                                                                       00845000
*        RESTORE NEEDED REGISTERS FROM SDWAPARM AREA                    00846000
*                                                                       00847000
         LM    R9,R13,0(R2)                                             00848000
         DROP  R15                     REMOVE R15 AS BASE REG           00849000
         USING IGC0203E,R11            RESTORE R11 AS BASE REG          00850000
         ST    R0,STAEIND                                               00851000
*   CALL ISSUEDEQ;                  /* REMOVE POSSIBLE ENQ           */ 00852000
@RF00378 BAL   R14,ISSUEDEQ                                             00853000
*   CALL BUILDMSG;                  /* SET UP TO ISSUE 53 BYTE ERROR    00854000
*                                      MSG                           */ 00855000
         BAL   R14,BUILDMSG                                             00856000
*   CALL ISSUEMSG;                  /* ISSUE WTO FOR ERROR MSG       */ 00857000
         BAL   R14,ISSUEMSG                                             00858000
*   R1=R5;                          /* RESTORE SDWA POINTER          */ 00859000
         LR    R1,R5                                                    00860000
         USING SDWA,R1                                                  00861000
*   R5=ADDR(STAERETY);              /* GET RETRY ADDRESS             */ 00862000
         LA    R5,STAERETY                                              00863000
*   R14=R8;                         /* RESTORE RETURN ADDR           */ 00864000
         LR    R14,R8                                                   00865000
*   IF STAEIND = 12 THEN            /* CHECK IF SDWA EXIST           */ 00866000
         CLC   STAEIND,KF12                                             00867000
         BNE   @RF00386                                                 00868000
*     DO;                           /* NO, THEN DO THE FOLLOWING     */ 00869000
*       R15=4;                      /* TELL STAE TO RETRY            */ 00870000
         LA    R15,4                                                    00871000
*       R0=R5;                      /* PUT RETRY ADDR INTO R0        */ 00872000
         LR    R0,R5                                                    00873000
         B     @ER00016                                                 00874000
*                                                                       00875000
*     END;                                                              00876000
*   ELSE                                                                00877000
*     DO;                           /* SDWA EXIST CONTINUE HERE      */ 00878000
*       SDWASR01=R2;                /* SAVE MY PARM ADDR IN SDWA     */ 00879000
@RF00386 ST    R2,SDWASR01                                              00880000
*       DO;                         /* SETRP RECORD(YES)RETADDR(STAER   00881000
*                                      ETY)RECPARM(LRECINF)RC(4)RETRE   00882000
*                                      GS(YES)FRESDWA(YES)           */ 00883000
         SETRP RECORD=YES,RETADDR=STAERETY,RECPARM=LRECINF,            X00884000
               RC=4,RETREGS=YES,FRESDWA=YES                             00885000
*                                                                       00886000
*       END;                                                            00887000
*     END;                                                              00888000
*   RETURN;                                                             00889000
@ER00016 BR    R14                                                      00890000
*   END;                                                                00891000
*                                                                       00892000
         DC    0F'0'                                                    00893000
ENQLIST  ENQ   (QN,RN,E,6,SYSTEM),RET=HAVE,MF=L                         00894000
LENENQ   EQU   *-ENQLIST                                                00895000
*                                                                       00896000
ELIST    ESTAE MF=L                                                     00897000
ESTAELEN EQU   *-ELIST                                                  00898000
*                                                                       00899000
DEQLIST  DEQ   (QN,RN,6,SYSTEM),RET=HAVE,MF=L                           00900000
LENDEQ   EQU   *-DEQLIST               L'DEQ LIST                       00901000
*                                                                       00902000
LRECINF  DC    C'IGC0203E'                                              00903000
         DC    C'IGC0203E'                                              00904000
         DC    C'        '                                              00905000
*                                                                       00906000
*   /*****************************************************************/ 00907000
*   /*                                                               */ 00908000
*   /* THIS IS THE MESSAGE SECTION OF THIS MODULE. THE MESSAGE PUT   */ 00909000
*   /* OUT BY THIS MODULE IS CONTAINED HERE AND NOT IN A SEPARATE    */ 00910000
*   /* CSECT. THE MESSAGE IS AN ERROR MESSAGE ISSUED WHEN THERE IS NO*/ 00911000
*   /* RPL POINTER, WHEN A RETURN CODE OF NON ZERO IS RETURNED FROM  */ 00912000
*   /* THE PUT, WHEN THE UNCONDITIONAL ENQUEUE FAILS OR WHEN AN      */ 00913000
*   /* UNPREDICATABLE ABEND OCCURS.                                  */ 00914000
*   /*                                                               */ 00915000
*   /*****************************************************************/ 00916000
*                                                                       00917000
*      THE FIRST BYTE OF THE MESSSAGE IS A REASON CODE FOR WHY THE      00918000
*      MESSAGE WAS ISSUED.                                              00919000
*      1 NO RPL POINTER EXISTED THEREFORE CANNOT ACCESS ACB             00920000
*      2 ENQUEUE TO SERIALIZE EXECUTION OF PUT FAILED                   00921000
*      3 PUT TO SYSTEM MESSAGE DATA SET FAILED                          00922000
*      4 UNPREDICTABLE ABEND                                            00923000
*      THIS IS FOLLOWED BY THE JOBNAME                                  00924000
*                                                                       00925000
IEF170I  WTO   'IEF170I            ',MF=L,ROUTCDE=2,DESC=5,            X00926000
               MCSFLAG=(HRDCPY)                                         00927000
IEF170IL EQU   *-IEF170I           L'WTO                                00928000
*   END                                                                 00929000
*                                                                       00930000
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM      */ 00931000
*/*%INCLUDE SYSLIB  (IHACTM  )                                       */ 00932000
*/*%INCLUDE SYSLIB  (IFGRPL  )                                       */ 00933000
*/*%INCLUDE SYSLIB  (IEECUCM )                                       */ 00934000
*/*%INCLUDE SYSLIB  (IEZWPL  )                                       */ 00935000
*/*%INCLUDE SYSLIB  (IEZJSCB )                                       */ 00936000
*/*%INCLUDE SYSLIB  (IKJTCB  )                                       */ 00937000
*/*%INCLUDE SYSLIB  (IHAASCB )                                       */ 00938000
*/*%INCLUDE SYSLIB  (IEFTIOT1)                                       */ 00939000
*/*%INCLUDE SYSLIB  (IHASDWA )                                       */ 00940000
*/*%INCLUDE SYSLIB  (IHARB   )                                       */ 00941000
*/*%INCLUDE SYSLIB  (IKJRB   )                                       */ 00942000
*/*%INCLUDE SYSLIB  (IKJUPT  )                                       */ 00943000
*/*%INCLUDE SYSLIB  (IKJPSCB )                                       */ 00944000
*                                                                       00945000
KH4      DC    H'4'                                                     00946000
KH10     DC    H'10'                                                    00947000
KH126    DC    H'126'                                                   00948000
KF12     DC    F'12'                                                    00949000
*                                                                       00950000
@SM02286 MVC   WORKAREA(0),ENQLIST                                      00951000
@SM02290 MVC   WORKAREA+23(0),0(R3)                                     00952000
*                                                                       00953000
         DC    0F'0'                                                    00954000
WORKIGCG DC    AL1(231)                SUBPOOL 231                      00955000
         DC    AL3(WORKIGCL)                                            00956000
*                                                                       00957000
WTPONLY  DC    AL2(WPLROUTK)           CHECK FOR ONLY WTP ROUTE CODE    00958000
QN       DC    CL8'SYSZJWTP'                                            00959000
RN       DC    AL1(20)                                                  00960000
*                                                                       00961000
*        WORKAREA GETMAINED BY IGC0203E IN SUBPOOL 231                  00962000
*                                                                       00963000
WORKIGC  DSECT                                                          00964000
SAVEAREA DS    18F                                                      00965000
ADDRUCM  DS    A                                                        00966000
ACTJSCB  DS    A                                                        00967000
STAEIND  DS    A                                                        00968000
TCBADDR  DS    A                                                        00969000
REG6SAVE DS    A                                                        00970000
REG14SAV DS    A                                                        00971000
         DS    0D                                                       00972000
WORKAREA DS    CL132                                                    00973000
*                                                                       00974000
         DS    0F                                                       00975000
STAEPARM DS    CL60                                                     00976000
         ORG   STAEPARM                                                 00977000
REGSTAE  DS    5F                                                       00978000
*                                                                       00979000
         DS    0F                                                       00980000
STAELIST DS    CL16                                                     00981000
ENQRNAME DS    CL8                                                      00982000
MSGID    DS    CL1                                                      00983000
         DS    0D                      ROUND TO DOUBLE WORD             00984000
WORKIGCL EQU   *-WORKIGC                                                00985000
*                                                                       00986000
*        END OF WORKAREA                                                00987000
*                                                                       00988000
         IEZBITS                                                        00989000
*                                                                       00990000
*********************************************************************** 00991000
*                                                                       00992000
*        WORKAREA USED IN MODULE IEAVVWTO                               00993000
*                                                                       00994000
*********************************************************************** 00995000
*                                                                       00996000
WORKVV   DSECT                                                          00997000
@SA00001 DS    18F                                                      00998000
@SAGETB  DS    18F                                                      00999000
@PC00003 DS    F                                                        01000000
@SA00004 DS    F                                                        01001000
@PC00004 DS    F                                                        01002000
@SA00008 DS    15F                                                      01003000
@SA00002 DS    15F                                                      01004000
@PC00002 DS    F                                                        01005000
@AL00001 DS    A                                                        01006000
@TF00001 DS    F                                                        01007000
REG1SAV  DS    F                                                        01008000
REG2SAV  DS    A                  SAVE AREA FOR R2 WHEN DEALING WITH    01009000
*                                 UCM                                   01010000
LONGTXT  DS    A                  -> AREA GETMAINED FOR LONG WPL        01011000
*                                    IF ZERO THEN NO STORAGE GETMAINED  01012000
LONGLEN  DS    F                  L'GETMAINED AREA FOR LONG TEXT        01013000
*                                                                       01014000
LENMWQE  DS    F                  L'OF ALL MINOR WQES                   01015000
*                                 VALID ONLY FOR MLWTO                  01016000
MLWTOXH  DS    A                  -> MLWTO EXTENT HEADER IN CALLERS WPL 01017000
*                                 VALID ONLY FOR MLWTO                  01018000
*                                                                       01019000
*        VERSION 2 XWPL TO STORE ALL USER PROVIDED WPL FIELDS           01020000
*                                                                       01021000
WKALGH   DS    AL2                MESSAGE LENGTH OF MAJOR WQE TEXT FROM 01022000
*                                 CALLER'S WPL                          01023000
WKAMCSF  DS    XL2                MCS FLAGS COPIED FROM CALLERS WPL     01024000
WKAADTXT DS    AL4                -> MESSAGE TEXT                       01025000
WKAVRSN  DS    AL1                XWPL VERSION NUMBER                   01026000
WKAFLAGS DS    XL1                MISC FLAGS                            01027000
WKARPYLN DS    AL1                L'REPLY FOR WTOR                      01028000
WKALNGTH DS    AL1                L'XWPL, ZERO FOR VERSION 1            01029000
WKAMCSF1 DS    XL2                EXTENDED MCS FLAGS                    01030000
WKACPFLF DS    XL2                MCS FLAGS FOR CNTL PROGRAM USE        01031000
WKARPBUF DS    AL4                -> REPLY BUFFER                       01032000
WKAECBP  DS    AL4                -> ECB                                01033000
WKASEQN  DS    AL4                DOM/CONNECT ID                        01034000
WKADSC   DS    XL2             *  DESCRIPTOR CODE TO BE USED IN WTO     01035000
WKAROC   DS    XL2             V  ROUTE CODES TO BE USED IN WTO         01036000
WKAROUT  DS    XL14               EXTENDED ROUTING CODES                01037000
WKAMSGTY DS    XL2                MSGTYPE FLAGS COPIED FROM CALLERS WPL 01038000
WKAPRTY  DS    XL2                MESSAGE PRIORITY                      01039000
WKAJOBID DS    CL8                JOB ID                                01040000
WKAJOBNM DS    CL8                JOB NAME                              01041000
WKAKEY   DS    CL8                RETRIEVAL KEY                         01042000
WKATOKN  DS    AL4                TOKEN FOR DOM                         01043000
WKACNID  DS    AL4                CONSOLE ID                            01044000
WKASYSNA DS    CL8                SYSTEM NAME                           01045000
WKACNNME DS    CL8                CONSOLE NAME                          01046000
WKARCNA  DS    AL4                -> REPLY CONSOLE NAME/ID              01047000
WKACART  DS    AL4                -> CART                               01048000
WKAWSPRM DS    AL4                -> WAIT STATE PARM LIST               01049000
WKAASCB  DS    AL4                -> ASCB                               01050000
WKARSV30 DS    XL16               RESERVED                              01051000
*                                                                       01052000
WKATEXT  DS    CL129              MESSAGE TEXT (MAXIMUM 125 CHARS) +4   01053000
*                                                                       01054000
ESTAEPRM DS    A                                                        01055000
@TS00001 DS    CL1                                                      01056000
STARTID  DS    CL1                                                      01057000
CVDAREA  DS    D                                                        01058000
*                                                                       01059000
PFLAG    DS    XL1                ADDITIONAL FLAGS                      01060000
REQCMSL  EQU   X'40'              REQUEST OR HOLD CMS LOCK              01061000
*                                                                       01062000
*        THE DSECT HAS BEEN TRUNCATED TO AVOID DUPLICATE NAME ISSUES    01063000
*                                                                       01064000
         PRINT NOGEN                                                    01065000
*                                                                       01066000
*        ACB                                                            01067000
*                                                                       01068000
         IFGACB                                                         01069000
*                                                                       01070000
*        RPL                                                            01071000
*                                                                       01072000
         IFGRPL                                                         01073000
*                                                                       01074000
*        TIOT                                                           01075000
*                                                                       01076000
TIOT     DSECT                                                          01077000
*                                                                       01078000
         IEFTIOT1                                                       01079000
*                                                                       01080000
*        JSCB                                                           01081000
*                                                                       01082000
         IEZJSCB                                                        01083000
*                                                                       01084000
*        PSCB                                                           01085000
*                                                                       01086000
         IKJPSCB                                                        01087000
*                                                                       01088000
*        TSO USER PROFILE TABLE                                         01089000
*                                                                       01090000
         IKJUPT                                                         01091000
*                                                                       01092000
*        SYSTEM DIAGNOSTIC WORK AREA                                    01093000
*                                                                       01094000
         IHASDWA DSECT=YES                                              01095000
*                                                                       01096000
*        TCB                                                            01097000
*                                                                       01098000
         IKJTCB LIST=YES                                                01099000
*                                                                       01100000
*        RB                                                             01101000
*                                                                       01102000
         IKJRB   DSECT=YES                                              01103000
*                                                                       01104000
         PRINT GEN                                                      01105000
*                                                                       01106000
*        VARIABLES DEFINED IN THE RBEXSAVE AREA                         01107000
*                                                                       01108000
*/********************************************************************/ 01109000
*/*                                                                  */ 01110000
*/*          EXTENDED SAVEAREA MAPPING FOR SVC 35                    */ 01111000
*/*                                                                  */ 01112000
*/********************************************************************/ 01113000
*                                                                       01114000
*        DEFINED IN THE RBEXSAVE AREA                                   01115000
*                                                                       01116000
         ORG   RBEXSAVE                                                 01117000
XVSAV    DS    0A                                                       01118000
XVA4     DS    0F                      ERROR PROCESSING FIELDS          01119000
XVFNCT   DS    C                       D23 PROCESS CODE                 01120000
D23VALID EQU   X'10'                   PARMLIST VALIDITY CHECK          01121000
D23OREGC EQU   X'20'                   ORE GETCELL FAILURE              01122000
D23OREBC EQU   X'21'                   ORE BLDCPOOL FAILURE             01123000
D23OREGM EQU   X'22'                   ORE GETMAIN FAILURE, SP231       01124000
D23WQEGC EQU   X'30'                   WQE GETCELL FAILURE              01125000
D23WQEBC EQU   X'31'                   WQE BLDCPOOL FAILURE             01126000
D23WQEGM EQU   X'32'                   WQE GETMAIN FAILURE, SP231       01127000
D23DYN   EQU   X'42'                   DYNAMIC AREA GETMAIN FAILURE     01128000
XVAMOD   DS    C                       D23 MODULE ID                    01129000
VWTOID   EQU   X'01'                   IEAVVWTO'S ID FOR D23            01130000
MWTOID   EQU   X'02'                   IEAVMWTO'S ID FOR D23            01131000
XVA41    DS    C                       RESERVED                         01132000
XVREASON DS    C                       D23 REASON CODE                  01133000
D23BNDY  EQU   X'01'                   WTOR PARMLIST NOT ON WORD BNDY   01134000
D23MLWTR EQU   X'02'                   MULTILINE WTOR SPECIFIED         01135000
D23PARM  EQU   X'03'                   WPL NOT ADDRESSABLE BY USER      01136000
D23ZERO  EQU   X'04'                   ZERO TEXT LENGTH WTOR            01137000
D23SIZE  EQU   X'05'                   CALLER MODIFIED WPL              01138000
*                                      DURING WTO PROCESSING            01139000
D23LTXT  EQU   X'06'                   WTO/WTOR TEXT= CODED AND         01140000
*                                      WPLLGH ^=8                       01141000
*                                                                       01142000
XVA8     DS    AL4                     STORE TIME                       01143000
XVWPLADR DS    AL4                     -> CALLERS WPL                   01144000
XVWQEAD  DS    AL4                                                      01145000
*                                                                       01146000
*        FLAGS                                                          01147000
*                                                                       01148000
XVDFLAGS DS    0XL4                                                     01149000
XVD0     DS    X                                                        01150000
XVD0RPFD EQU   BIT1                    HARD COPY ONLY                   01151000
XVD0NWQE EQU   BIT2                    GET WQE                          01152000
XVD0NORE EQU   BIT3                    GET THE ORE FIRST                01153000
XVD0QID  EQU   BIT4                    QID FIELD IS PRESENT IN THE WPL  01154000
XVD0WWB  EQU   BIT5                    WWB WTO WAIT BLOCK OBTAINED      01155000
XVD0USER EQU   BIT6                                                     01156000
XVD0HDCY EQU   BIT7                                                     01157000
*                                                                       01158000
*        XVDFLAGS+1                                                     01159000
*                                                                       01160000
XVD1     DS    X                                                        01161000
XVD1PRIV EQU   BIT0                    PRIVILEGED USER                  01162000
XVD1ENQW EQU   BIT1                    ENQ'D ON A WQE  (VMWTO)          01163000
XVD1ENQO EQU   BIT2                    ENQ'D ON AN ORE (VMWTO)          01164000
XVD1ALDN EQU   BIT2                    ALL NEEDED CONTROL BLKS OBTAINED 01165000
XVD1PP   EQU   BIT5                    PROBLEM PROGRAM CALLER           01166000
XVD1AUTH EQU   BIT6                    KEY 0, SUPVR STATE OR APF AUTH   01167000
XVD1PERR EQU   BIT7                    SEVERE ERROR FOUND. ABEND USER   01168000
*                                                                       01169000
*        XVDFLAGS+2                                                     01170000
*                                                                       01171000
XVD2     DS    X                                                        01172000
XVD2CON  EQU   BIT0                    CONNECTING                       01173000
XVD2VALD EQU   BIT3                    PARAMETER LIST IS VALID          01174000
XVD2DELW EQU   BIT4                    SEND MSG TO HARDCOPY ONLY        01175000
XVD2ZERO EQU   BIT5                    ZERO MSG ID TO USER              01176000
XVD2WTOR EQU   BIT6                    WTOR REQUEST                     01177000
XVD2QFHC EQU   BIT7                    QUEUE THIS MSG TO HARD COPY      01178000
*                                                                       01179000
*        XVDFLAGS+3                                                     01180000
*                                                                       01181000
XVD3     DS    X                                                        01182000
XVD3BLDJ EQU   BIT0                    BUILD MAJOR WQE                  01183000
XVD3BLD1 EQU   BIT1                    BUILD LINE 1                     01184000
XVD3BLD2 EQU   BIT2                    BUILD LINE 2                     01185000
XVD3TXT1 EQU   BIT3                    TEXT LINE 1 BEING USED           01186000
XVD3TFX  EQU   BIT4                    TCBTFX WAS SET ON,TURN IT OFF    01187000
*        END OF FLAGS                                                   01188000
XVOREAD  DS    AL4                                                      01189000
         ORG   XVOREAD                                                  01190000
XVX      DS    0F                      USED AS WORK AREA BY VMWTO       01191000
XVX0     DS    X                       LINE CONTROL FLAGS - MLWTO       01192000
XVX0FLCL EQU   BIT0                    FIRST LINE IS CONTROL LINE       01193000
XVX0LL1F EQU   BIT1                    LABEL LINE 1 FOUND               01194000
XVX0LL2F EQU   BIT2                    LABEL LINE 2 FOUND               01195000
XVX0UDCL EQU   BIT3                    USE DEFAULT CONTROL LINE         01196000
XVX0FLJE EQU   BIT4                    FIRST LINE JUST 'E'              01197000
XVX0FEDE EQU   BIT5                    FORCE END (LAST LINE TO BE DE)   01198000
XVX1     DS    X                       ERROR FLAGS - MLWTO              01199000
XVX1STOP EQU   BIT0                    ERROR IN PARM LIST; IGNORE MLWTO 01200000
XVX1NOID EQU   BIT1                    NO ID FOR CONNECTING MLWTO       01201000
XVX2     DS    AL1                     NO OF LINES STILL TO DO          01202000
XVX3     DS    AL1                     NO OF LINES FROM MLWTO EXT HDR   01203000
*                                                                       01204000
XVCMAJOR DS    AL4                  *                                   01205000
XVCMINOR DS    AL4                  V                                   01206000
*                                                                       01207000
XVWWB    DS    AL4                                                      01208000
*                                                                       01209000
XVWQEID  DS    0AL4       *            CALLERS R0                       01210000
XVWQEIDA DS    AL3        |            A NEW LINE IS TO BE              01211000
*                         |            CONNECTED TO THE MESSAGE         01212000
*                         |            WITH THIS 3 BYTE MESSAGE ID      01213000
*                         |            MLWTO ONLY                       01214000
XVCONID  DS    XL1        V            CONSOLE ID FOR THIS MESSAGE      01215000
*                                                                       01216000
XVRET    DS    0AL4                                                     01217000
XVRETCOD DS    AL4                                                      01218000
XVLEN    EQU   *-XVSAV                 MUST NOT EXCEED 48 BYTES AS      01219000
*                                      RB EXTENDED SAVE AREA USED       01220000
*                                                                       01221000
*        WTO/WTOR/MLWTO/WTP PARAMETER LIST                              01222000
*                                                                       01223000
         IEZWPL                                                         01224000
*                                                                       01225000
         PRINT NOGEN                                                    01226000
*                                                                       01227000
*        ADDRESS SPACE CONTROL BLOCK                                    01228000
*                                                                       01229000
         IHAASCB                                                        01230000
*                                                                       01231000
*        CONSOLE UNIT CONTROL MODULE                                    01232000
*                                                                       01233000
         IEECUCM DSECT=YES,FORMAT=NEW                                   01234000
*                                                                       01235000
*        CVT                                                            01236000
*                                                                       01237000
         CVT   DSECT=YES                                                01238000
*                                                                       01239000
         PRINT GEN                                                      01240000
*                                                                       01241000
R0       EQU   0                                                        01242000
R1       EQU   1                                                        01243000
R2       EQU   2                                                        01244000
R3       EQU   3                                                        01245000
R4       EQU   4                                                        01246000
R5       EQU   5                                                        01247000
R6       EQU   6                                                        01248000
R7       EQU   7                                                        01249000
R8       EQU   8                                                        01250000
R9       EQU   9                                                        01251000
R10      EQU   10                                                       01252000
R11      EQU   11                                                       01253000
R12      EQU   12                                                       01254000
R13      EQU   13                                                       01255000
R14      EQU   14                                                       01256000
R15      EQU   15                                                       01257000
*                                                                       01258000
         END   IGC0203E                                                 01259000
./ ENDUP
/*
//*
//STEP03  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DATA
++USERMOD(ZP60039)            /* ADD TEXT= TO WTO AND WTOR */  .
++VER(Z038) FMID(FBB1221)
  PRE(UZ62088,UZ31484)
  REQ(ZP60040)
  SUP(ZUM0013,TMVS805)
 /*
   PROBLEM DESCRIPTION:
     MESSAGE TEXT SUPPLIED TO THE WTO AND WTOR MACROS MUST BE INLINE.
       APPLICATIONS ISSUING WTO MESSAGES CANNOT SPECIFY DISPLAY
       TEXT WHICH IS REMOTE, THAT IS, NOT PHYSICALLY LOCATED
       WITHIN THE WTO OR WTOR PARAMETER LIST.

       CHANGES MADE BY THIS SYSMOD INCLUDE:
         - ENHANCE THE IEZWPL MACRO TO DESCRIBE THE EXTENDED WTO
           PARAMETER LIST (XWPL).
         - ENHANCE THE WTO MACRO TO ACCEPT THE TEXT= OPERAND AND
           CONSTRUCT A WPL OR XWPL AS REQUIRED.
         - ADD SUPPORT FOR THE XWPL INTO IEAVVWTO (SVC 35) AND
           IEAVMWTO (SVC 35 MULTI-LINE WTO SERVICE ROUTINE).
         - ALWAYS COPY THE WPL OR XWPL TO PROTECTED STORAGE,
           INSTEAD OF ONLY FOR UNAUTHORIZED CALLERS.
         - IMPROVED WPL VALIDATION TO AVOID INTERNAL ERRORS AND
           ISSUE SD23 ABENDS IN ACCORDANCE WITH DOCUMENTATION.
         - IMPROVE WTO MESSAGE CHARACTER RENDERING BY DISPLAYING
           MOST STANDARD KEYBOARD CHARACTERS UNTRANSLATED, AND
           SHOWING OTHER CODE POINTS AS A TILDE INSTEAD OF A BLANK.
         - SUBSUME THE FUNCTION OF USERMOD TMVS805 - ALSO WIDELY
           SHIPPED AS USERMOD ZUM0013 - BY KEVIN LEONARD, MAINLY
           BECAUSE THAT USERMOD WOULD NEED TO BE ADAPTED TO FIT THE
           UPDATES SHIPPED HERE.  THE TMVS805/ZUM0013 FUNCTION IS:
             - ALLOW IEECVXIT TO ACCESS "INTERNAL" MESSAGES, THEREBY
               FACILIATING MORE POWERFUL AUTOMATED OPERATIONS.
             - PREVENT HARDCOPY OF DELETED MESSAGES.
           NOTE THAT THE TMVS805/ZUM0013 CHANGES CAN BE DEACTIVATED
           BY ALTERING A SWITCH IN THE IEAVVWTO SOURCE CODE AND
           RECOMPILING.

   SPECIAL CONDITIONS:
     ACTION:
       A "CLPA" MUST BE PERFORMED AT IPL TIME FOR THIS SYSMOD TO
       BECOME ACTIVE.

   COMMENTS:
     PRYCROFT SIX P/L PUBLIC DOMAIN USERMOD FOR MVS 3.8 NUMBER 39.

     REWORK HISTORY:
       2018-08-20: INITIAL AVAILABILITY.

     THIS IS SYSMOD NUMBER 1 OF 2 IN A PACKAGE TO SUPPORT TEXT= ON
     WTO AND WTOR MACROS DEVELOPED BY TOM ARMSTRONG.  BOTH SYSMODS
     SHOULD BE ACTIVATED IN THE SAME IPL.  THE SYSMOD DETAILS ARE:
      +---------+---------+------+----------+-----------------------+
      | USERMOD | FMID    | COMP | PART     | DESCRIPTION           |
      +---------+---------+------+----------+-----------------------+
      | ZP60039 | FBB1221 | SU64 | IEAVMWTO | MLWTO SERVICE ROUTINE |
      |         |         |      | IEAVVWTO | WTO/WTOR PROCESSOR    |
      |         |         |      | IEZWPL   | WTO PARAMETER LIST    |
      |         |         |      | WTO      | INVOKE WTO SERVICE    |
      +---------+---------+------+----------+-----------------------+
      | ZP60040 | EBB1102 | BCP  | IGC0203E | WRITE TO PROGRAMMER   |
      |         |         |      | WTOR     | INVOKE WTOR SERVICE   |
      +---------+---------+------+----------+-----------------------+

     THE FOLLOWING MODULES AND/OR MACROS ARE AFFECTED BY THIS USERMOD:
     MODULES:
       IEAVMWTO
       IEAVVWTO
     MACROS:
       IEZWPL
       WTO
 */.
++MAC(IEZWPL) DISTLIB(AMODGEN).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(NEW,PASS),UNIT=SYSALLDA,
//             SPACE=(CYL,3),
//             DCB=(DSORG=PS,RECFM=FB,LRECL=80,BLKSIZE=4080)
//SYSIN    DD  DUMMY
//*
//STEP04  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DSN=&&MACLIB(IEZWPL),DISP=(OLD,PASS)
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP05  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
++MAC(WTO) DISTLIB(AMACLIB).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP06  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DSN=&&MACLIB(WTO),DISP=(OLD,PASS)
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP07  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
++MOD(IEAVMWTO) DISTLIB(AOSC5).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP08  EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT)'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=&&MACLIB,DISP=(OLD,PASS),DCB=BLKSIZE=32720
//         DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DSN=&&SOURCE(IEAVMWTO),DISP=(OLD,PASS)
//*
//STEP09  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
  IDENTIFY IEAVMWTO('ZP60039')
++MOD(IEAVVWTO) DISTLIB(AOSC5).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP10  EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT)'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=&&MACLIB,DISP=(OLD,PASS),DCB=BLKSIZE=32720
//         DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DSN=&&SOURCE(IEAVVWTO),DISP=(OLD,PASS)
//*
//STEP11  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DATA
  IDENTIFY IEAVVWTO('ZP60039')
++USERMOD(ZP60040)            /* ADD TEXT= TO WTO AND WTOR */  .
++VER(Z038) FMID(EBB1102)
  PRE(UY13810) .
++IF FMID(FBB1221) REQ(ZP60039)
 /*
   PROBLEM DESCRIPTION:
     MESSAGE TEXT SUPPLIED TO THE WTO AND WTOR MACROS MUST BE INLINE.
       APPLICATIONS ISSUING WTO MESSAGES CANNOT SPECIFY DISPLAY
       TEXT WHICH IS REMOTE, THAT IS, NOT PHYSICALLY LOCATED
       WITHIN THE WTO OR WTOR PARAMETER LIST.

       THIS SYSMOD ENHANCES WTP (WRITE TO PROGRAMMER) TO SUPPORT
       THE EXTENDED WTO PARAMETER LIST (XWPL), AND CHANGES THE
       WTOR MACRO TO ACCEPT THE TEXT= OPERAND AND BUILD A WPL
       OR XWPL AS REQUIRED.

   SPECIAL CONDITIONS:
     ACTION:
       A "CLPA" MUST BE PERFORMED AT IPL TIME FOR THIS SYSMOD TO
       BECOME ACTIVE.

   COMMENTS:
     PRYCROFT SIX P/L PUBLIC DOMAIN USERMOD FOR MVS 3.8 NUMBER 40.

     REWORK HISTORY:
       2018-08-20: INITIAL AVAILABILITY.

     THIS IS SYSMOD NUMBER 2 OF 2 IN A PACKAGE TO SUPPORT TEXT= ON
     WTO AND WTOR MACROS DEVELOPED BY TOM ARMSTRONG.  BOTH SYSMODS
     SHOULD BE ACTIVATED IN THE SAME IPL.  THE SYSMOD DETAILS ARE:
      +---------+---------+------+----------+-----------------------+
      | USERMOD | FMID    | COMP | PART     | DESCRIPTION           |
      +---------+---------+------+----------+-----------------------+
      | ZP60039 | FBB1221 | SU64 | IEAVMWTO | MLWTO SERVICE ROUTINE |
      |         |         |      | IEAVVWTO | WTO/WTOR PROCESSOR    |
      |         |         |      | IEZWPL   | WTO PARAMETER LIST    |
      |         |         |      | WTO      | INVOKE WTO SERVICE    |
      +---------+---------+------+----------+-----------------------+
      | ZP60040 | EBB1102 | BCP  | IGC0203E | WRITE TO PROGRAMMER   |
      |         |         |      | WTOR     | INVOKE WTOR SERVICE   |
      +---------+---------+------+----------+-----------------------+

     THE FOLLOWING MODULES AND/OR MACROS ARE AFFECTED BY THIS USERMOD:
     MODULES:
       IGC0203E
     MACROS:
       WTOR
 */.
++MAC(WTOR) DISTLIB(AMACLIB).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP12  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DSN=&&MACLIB(WTOR),DISP=(OLD,PASS)
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP13  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  *
++MOD(IGC0203E) DISTLIB(AOSB3).
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DUMMY
//*
//STEP14  EXEC PGM=IFOX00,PARM='OBJECT,NODECK,NOTERM,XREF(SHORT)'
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT2   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSUT3   DD  UNIT=SYSALLDA,SPACE=(CYL,10)
//SYSLIB   DD  DSN=&&MACLIB,DISP=(OLD,PASS),DCB=BLKSIZE=32720
//         DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.SMPMTS,DISP=SHR
//         DD  DSN=SYS1.AMODGEN,DISP=SHR
//SYSGO    DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//SYSIN    DD  DSN=&&SOURCE(IGC0203E),DISP=(OLD,PASS)
//*
//STEP15  EXEC PGM=IEBGENER
//SYSPRINT DD  SYSOUT=*
//SYSUT1   DD  DATA
  IDENTIFY IGC0203E('ZP60040')
/*
//SYSUT2   DD  DSN=&&SMPMCS,DISP=(MOD,PASS)
//MACLIB   DD  DSN=&&MACLIB,DISP=(OLD,DELETE)
//SOURCE   DD  DSN=&&SOURCE,DISP=(OLD,DELETE)
//SYSIN    DD  DUMMY
//*
//STEP16  EXEC SMPREC
//SMPPTFIN DD  DSN=&&SMPMCS,DISP=(OLD,DELETE)
//SMPCNTL  DD  *
  RECEIVE
          SELECT(ZP60039,ZP60040)
          .
/*
//STEP17  EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60039,ZP60040)
        CHECK
        .
/*
//*
/STEP18   EXEC SMPAPP,WORK='SYSALLDA',COND=(0,NE)
//SMPCNTL  DD  *
  APPLY
        SELECT(ZP60039,ZP60040)
        DIS(WRITE)
        .
/*
//
//ZUM0007  JOB (SYSGEN),'J05 M52: ZUM0007',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*********************************************************************
//* Install USERMOD ZUM0007 (source: Michael Koehne) to update TSO to *
//* display dates correctly post Y2k                                  *
//*********************************************************************
//*
//RECEIVE  EXEC SMPREC,WORK='SYSALLDA'
//SMPPTFIN  DD *
++USERMOD (ZUM0007) .
++VER (Z038) FMID(EBB1102)
  PRE(UY17588 UZ27405)
  /*
   Update date offsets for post Y2k
  */ .
++ ZAP (IKJEFLA) .
 NAME IKJEFLPB
 VER 0000 197A6B40    from 19
 REP 0000 207A6B40    to   20
 IDRDATA ZUM0007
++ ZAP (IKJEFT25) .
 NAME IKJEFT25
 VER 06C4 4040F1F9    from '  19'
 REP 06C4 4040F2F0    to   '  20'
 IDRDATA ZUM0007
/*
//SMPCNTL  DD  *
  RECEIVE
          SELECT(ZUM0007)
          .
/*
//*
//APPLYCK  EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD *
  APPLY
        SELECT(ZUM0007)
        CHECK
        .
/*
//*
//APPLY    EXEC SMPAPP,COND=(0,NE),WORK='SYSALLDA'
//SMPCNTL  DD *
  APPLY
        SELECT(ZUM0007)
        DIS(WRITE)
        .
/*
//
//ZUM0008  JOB (SYSGEN),'J06 M53: ZUM0008',
//             CLASS=A,
//             MSGCLASS=A,
//             MSGLEVEL=(1,1),
//             REGION=4096K
/*JOBPARM LINES=100
//JOBCAT   DD  DSN=SYS1.VSAM.MASTER.CATALOG,DISP=SHR
//*
//*********************************************************************
//* Install USERMOD ZUM0008 (source: Juergin Winkelmann) to complete  *
//* TSO date display post Y2k during logon and logoff.                *
//*********************************************************************
//*
//RECEIVE EXEC SMPREC,WORK='SYSALLDA'
//SMPPTFIN DD  *
++USERMOD (ZUM0008) .
++VER (Z038) FMID(EBB1102)
  PRE(UY17588 UZ27405 ZUM0007)
  /*
   completion of Michael Koehne's Y2K patch ZUM0007
  */ .
++ ZAP (IKJEFLA) .
 NAME IKJEFLPA
 VER 0318 6B40F1F9   from 19
 REP 0318 6B40F2F0   to   20
 IDRDATA ZUM0008
/*
//SMPCNTL  DD  *
  RECEIVE SELECT(ZUM0008).
/*
//*
//APPLYCK EXEC SMPAPP,WORK='SYSALLDA'
//SMPCNTL  DD  *
  APPLY
        SELECT(ZUM0008)
        CHECK
        .
/*
//*
//APPLY    EXEC SMPAPP,COND=(0,NE),WORK='SYSALLDA'
//SMPCNTL  DD *
  APPLY
        SELECT(ZUM0008)
        DIS(WRITE)
        COMPRESS(ALL)
        .
/*
//
